define("modules/clean/account/change_email_modals",["jquery","external/react","modules/core/notify","modules/core/i18n","modules/clean/form","modules/clean/account/email_verify","modules/clean/react/bubble_dropdown","modules/clean/react/input","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/viewer","modules/clean/ajax"],function(e,t,n,i,o,r,s,a,l,u,c,_){var d,p,h,f,m,g,v,y,b,w;return w=i._,y=i.render_sentences,b=i.ungettext,g=l.Modal,v=t.DOM,m=t.createClass({propTypes:{user:t.PropTypes.object,inboxCount:t.PropTypes.number,onContinue:t.PropTypes.func},render:function(){return g({title:w("Warning!"),acceptButtonText:w("Continue anyway"),dismissButtonText:w("Cancel"),onAccept:this.showChange,ref:"modal"},this.getSSOWarning(),this.getInboxWarning())},getSSOWarning:function(){var e,t,n;return e=c.get_viewer().is_paired,n=e&&this.props.user.role===Constants.ROLE_WORK,t=this.props.user.sso_required,n&&t?v.div({},w("Your %(team)s Dropbox uses single sign-on. If you change your email address you may not be able to sign in.").format({team:c.get_viewer().team_name})):null},getInboxWarning:function(){var e;return e=c.get_viewer().is_paired,0===this.props.inboxCount?null:e&&this.props.user.role===Constants.ROLE_PERSONAL?b("Your %(num)d existing shared folder invitation in your personal Dropbox will be removed if you change your email address.","Your %(num)d existing shared folder invitations in your personal Dropbox will be removed if you change your email address.",this.props.inboxCount).format({num:this.props.inboxCount}):e&&this.props.user.role===Constants.ROLE_WORK?b("Your %(num)d existing shared folder invitation in your %(team)s Dropbox will be removed if you change your email address.","Your %(num)d existing shared folder invitations in your %(team)s Dropbox will be removed if you change your email address.",this.props.inboxCount).format({num:this.props.inboxCount,team:c.get_viewer().team_name}):b("Your %(num)d existing shared folder invitation will be removed if you change your email address.","Your %(num)d existing shared folder invitations will be removed if you change your email address.",this.props.inboxCount).format({num:this.props.inboxCount})},showChange:function(e){var t,n;return e.preventDefault(),t=this.refs.modal,t.close(),"function"==typeof(n=this.props).onContinue?n.onContinue():void 0}}),p=t.createClass({propTypes:{user:t.PropTypes.object,onChange:t.PropTypes.func,onVerificationCheck:t.PropTypes.func},getInitialState:function(){return{submitting:!1,errors:{}}},render:function(){return g({title:w("Update '%(email)s'").format({email:this.props.user.email}),className:"change-email-modal",acceptButtonText:w("Update email"),dismissButtonText:w("Cancel"),onAccept:this.handleSubmit,submitting:this.state.submitting,ref:"modal"},v.form({action:"/account/change_email",className:"change-email-form",onSubmit:this.handleSubmit,onKeyDown:this.handleKey,ref:"form"},v.div({},this.getPrompt()),v.div({className:"change-email-inputs"},a.text({name:"email",label:w("New email"),error:this.state.errors.email,autoComplete:"off"}),a.text({name:"confirm_email",label:w("Confirm email"),error:this.state.errors.confirm_email,autoComplete:"off"}),a.password({name:"password",label:w("Dropbox password"),error:this.state.errors.password,autoComplete:"off"}),v.input({type:"hidden",name:Constants.UID_PARAM_NAME,value:this.props.user.id}))))},handleKey:function(e){var t;return 13===e.keyCode&&"INPUT"===(null!=(t=e.target)?t.tagName:void 0)?this.handleSubmit(e):void 0},handleSubmit:function(e){return e.preventDefault(),this.state.submitting?void 0:this.submit()},submit:function(){var t;return this.setState({submitting:!0,errors:{}}),t=e(this.refs.form.getDOMNode()),o.submit(t,this._success,this._error,this._complete)},_success:function(t){var n,i,o,r,s,a;return o=this.refs.modal,i=this.refs.form,n=e(i.getDOMNode()).find('input[name="email"]').val(),r="NEEDS_VERIFICATION"===t,o.close(),r?"function"==typeof(s=this.props).onVerificationCheck?s.onVerificationCheck(n):void 0:"function"==typeof(a=this.props).onChange?a.onChange(n):void 0},_error:function(e){return"string"==typeof e?n.error(e):e?this.setState({errors:e}):n.error()},_complete:function(){return this.isMounted()?this.setState({submitting:!1}):void 0},getPrompt:function(){var e,t,n;return e=c.get_viewer().is_paired,n=this.props.user.email_verified,t=[],e&&this.props.user.role===Constants.ROLE_PERSONAL?(t.push(w("Enter a new email address for your personal Dropbox.")),n&&t.push(w("Youâll need to verify your new email address in order to finish updating your personal email."))):e&&this.props.user.role===Constants.ROLE_WORK?(t.push(w("Enter a new email address for your %(team)s Dropbox.").format({team:c.get_viewer().team_name})),n&&t.push(w("Youâll need to verify your new email address in order to finish updating your %(team)s email.").format({team:c.get_viewer().team_name}))):n&&t.push(w("Youâll need to verify your new email address in order to finish updating your email.")),t.length?y(t):""}}),h=t.createClass({propTypes:{name:t.PropTypes.string.isRequired,type:t.PropTypes.string.isRequired,address:t.PropTypes.string,verified:t.PropTypes.bool,doChangeAddress:t.PropTypes.func,doMakePrimary:t.PropTypes.func,doCreateAlias:t.PropTypes.func,doDeleteAlias:t.PropTypes.func},render:function(){var e;return e=this.props.verified?"address verified":"address pending",v.div({className:"email-row bs-row clearfix clear","data-type":this.props.type},v.span({className:"type"},this.props.name),null!=this.props.address?v.span({className:e},this.props.address):void 0,null!=this.props.address?s({target:u({group:"web",name:"gear"}),arrow_position:"top-right",ref:"dropdown"},v.div({className:"list-menu list-menu-hover"},this.props.verified?void 0:v.div({className:"list-item",onClick:function(e){return function(){return e.refs.dropdown.hide(),n.info(w("Sending verification email...")),r.send_verification_email(e.props.user,e.props.email,"generic",function(){return n.success(w("Verification email sent to %(email)s").format({email:e.props.address}))})}}(this)},w("Resend verification")),"primary"===this.props.type?v.div({className:"list-item",onClick:this.props.doChangeAddress},w("Change email address")):(v.div({className:"list-item",onClick:this.props.doMakePrimary},w("Make primary")),v.div({className:"list-item",onClick:function(e){return function(){return e.props.doDeleteAlias(e.props.address)}}(this)},w("Delete email"))))):v.a({className:"address prompt",onClick:this.props.doCreateAlias},"Add "+this.props.name.toLowerCase()+" email"))}}),d=t.createClass({propTypes:{user:t.PropTypes.object,onSuccess:t.PropTypes.func},getInitialState:function(){return{submitting:!1,errors:{}}},render:function(){return g({title:w("Add recovery email"),className:"change-email-modal",acceptButtonText:w("Add recovery email"),onAccept:this.handleSubmit,submitting:this.state.submitting,ref:"modal"},v.form({action:"/account/alias/add/recovery_email",className:"change-email-form",onSubmit:this.handleSubmit,onKeyDown:this.handleKey,ref:"form"},v.div({},w("If you request a password reset, weâll send a link to both your primary and recovery emails.")),v.div({className:"change-email-inputs"},a.text({name:"email_alias",label:w("New email"),error:this.state.errors.email_alias,autoComplete:"off",onChange:function(e){return function(t){return e.newAddress=t.target.value}}(this)}),a.password({name:"password",label:w("Dropbox password"),error:this.state.errors.password,autoComplete:"off"}),v.input({type:"hidden",name:Constants.UID_PARAM_NAME,value:this.props.user.id}))))},handleKey:function(e){var t;return 13===e.keyCode&&"INPUT"===(null!=(t=e.target)?t.tagName:void 0)?this.handleSubmit(e):void 0},handleSubmit:function(e){return e.preventDefault(),this.state.submitting?void 0:this.submit()},submit:function(){var t;return this.setState({submitting:!0,errors:{}}),t=e(this.refs.form.getDOMNode()),o.submit(t,this._success,this._error,this._complete)},_success:function(e){var t,i,o,r;return o=this.refs.modal,i=this.refs.form,t=this.newAddress,r="ok:NEEDS_VERIFICATION"===e,r&&n.success(w("Please check your email to verify your recovery email.")),o.close(),this.props.onSuccess(t,!r)},_error:function(e){return"string"==typeof e?n.error(e):e?this.setState({errors:e}):n.error()},_complete:function(){return this.isMounted()?this.setState({submitting:!1}):void 0},getPrompt:function(){var e,t,n;return e=c.get_viewer().is_paired,n=this.props.user.email_verified,t=[],e&&this.props.user.role===Constants.ROLE_PERSONAL?(t.push(w("Enter a new email address for your personal Dropbox.")),n&&t.push(w("You'll need to verify your new email address in order to finish updating your personal email."))):e&&this.props.user.role===Constants.ROLE_WORK?(t.push(w("Enter a new email address for your %(team)s Dropbox.").format({team:c.get_viewer().team_name})),n&&t.push(w("You'll need to verify your new email address in order to finish updating your %(team)s email.").format({team:c.get_viewer().team_name}))):n&&t.push(w("You'll need to verify your new email address in order to finish updating your email.")),t.length?y(t):""}}),f=t.createClass({propTypes:{initialAliases:t.PropTypes.array,user:t.PropTypes.object,onAliasChange:t.PropTypes.func,startChangePrimaryFlow:t.PropTypes.func},getInitialState:function(){return{aliases:this.props.initialAliases}},deleteAlias:function(e){return new _.WebRequest({url:"/account/alias/remove",type:"POST",subject_user:this.props.user,data:{alias_type:"recovery_email",alias:e},success:function(t){return function(){var n,i,o;o=t.state.aliases.slice();for(i in o)if(n=o[i],n.alias===e){o.splice(i,1);break}return t.setState({aliases:o}),t.props.onAliasChange(o)}}(this)})},createAlias:function(){return g.showInstance(new d({user:this.props.user,onSuccess:function(e){return function(t,n){var i;return i=e.state.aliases.slice(),i.push({alias:t,type:"recovery_email",verified:n}),e.props.onAliasChange(i)}}(this)}))},render:function(){var e;return g({title:w("Change %(role)s emails").format({role:"personal"}),className:"change-email-options-modal",acceptButtonText:w("Close"),ref:"modal"},v.div({className:"email-list-container"},h({user:this.props.user,name:w("Primary",{comment:"Primary email address"}),type:"primary",address:this.props.user.email,verified:this.props.user.is_email_verified,doChangeAddress:function(e){return function(){return e.props.startChangePrimaryFlow()}}(this)}),function(){var t,n,i,o;for(i=this.state.aliases,o=[],t=0,n=i.length;n>t;t++)e=i[t],"recovery_email"===e.type&&o.push(h({user:this.props.user,name:w("Recovery",{comment:"Recovery email address; 'backup'"}),type:"recovery",address:e.alias,verified:e.verified,doDeleteAlias:this.deleteAlias}));return o}.call(this),0===this.state.aliases.length?h({user:this.props.user,name:w("Recovery",{comment:"Recovery email address; 'backup'"}),type:"recovery",doCreateAlias:this.createAlias}):void 0))}}),{ChangeEmailWarningModal:m,ChangeEmailModal:p,ChangeEmailOptionsModal:f,AddRecoveryEmailModal:d}}),define("modules/clean/account/email",["jquery","external/react","modules/core/browser","modules/core/notify","modules/core/i18n","modules/core/uri","modules/clean/account/change_email_modals","modules/clean/account/email_verify","modules/clean/account/verify_email_modals","modules/clean/react/modal","modules/clean/react/react_i18n","modules/clean/viewer"],function(e,t,n,i,o,r,s,a,l,u,c,_){var d,p,h,f,m,g,v,y,b,w,C,S,E,T,k;return k=o._,f=s.ChangeEmailModal,m=s.ChangeEmailOptionsModal,g=s.ChangeEmailWarningModal,p=s.AddRecoveryEmailModal,S=l.VerifyEmailModal,C=l.ResendVerifyEmailModal,E=l.VerifyEmailSentModal,b=l.EmailVerifiedModal,v=l.ChangedEmailVerifiedModal,w=u.Modal,y=function(){function e(e){var t;this.role=e,this.user=this.role?_.get_viewer().get_user_by_role(this.role,!0):_.get_viewer().deprecated_first_user_in_the_cookie,this.email_to_verify=null!=(t=this.user)?t.email:void 0,this.verify_for_change=!1}return e.prototype.polling=!1,e.prototype.show_resend=!1,e.shouldUseSimpleUI=!1,e.getForRole=function(t){return this.initalized||(this.legacy=new e(null),this.personal=new e("personal"),this.work=new e("work"),this.initalized=!0),"personal"===t?this.personal:"work"===t?this.work:this.legacy},e.get_for_user=function(e){return this.getForRole(e.role)},e.set_should_use_simple_ui=function(e){return this.shouldUseSimpleUI=e},e.reset=function(){return this.shouldUseSimpleUI=!1,this.initalized=!1},e.prototype.set_email_to_verify=function(e){return this.email_to_verify=e,this.verify_for_change=this.email_to_verify!==this.user.email},e.prototype.send_email=function(e,t){return a.send_verification_email(this.user,this.email_to_verify,e,t)},e.prototype.flash_email_sent_notification=function(){return i.success(k("Verification email sent to %(email)s").format({email:this.email_to_verify}))},e.prototype.ensure_polling=function(e){return a.listen_for_verification(this.user,this.email_to_verify,function(t){return function(){return null!=e?(t.user.is_email_verified=!0,e()):n.reload()}}(this))},e.prototype.email_sent=function(e){return this.show_resend=!0,this.show(),this.flash_email_sent_notification(),this.ensure_polling(e)},e.prototype.show=function(e,t){return this.show_resend?this.show_resend_verify_modal(t):this.show_verify_modal(e,t)},e.prototype.show_verify_modal=function(t,n){return null==n&&(n=this.verify_for_change?"change_email":e.REASON),w.showInstance(new S({user:this.user,reason:n,email:this.email_to_verify,onShowChange:function(e){return function(){return h.show(e.user)}}(this),onEmailSent:function(n){return function(){var i;return i=e.get_for_user(n.user),i.email_sent(t)}}(this),shouldUseSimpleUI:e.shouldUseSimpleUI}))},e.prototype.show_resend_verify_modal=function(t){return null==t&&(t=this.verify_for_change?"change_email":e.REASON),w.showInstance(new C({user:this.user,email:this.email_to_verify,reason:t,onShowChange:function(e){return function(){return h.show(e.user)}}(this),onEmailSent:function(t){return function(){var n;return n=e.get_for_user(t.user),n.email_sent()}}(this),shouldUseSimpleUI:e.shouldUseSimpleUI}))},e.prototype.verified_or_show=function(e){return this.user.is_email_verified?!0:(this.show(null,e),!1)},e.prototype.show_sent_modal=function(){return w.showInstance(new E({email:this.email_to_verify,shouldUseSimpleUI:e.shouldUseSimpleUI}))},e.prototype.show_verified_modal=function(){return w.showInstance(new b({reason:e.REASON,email:this.email_to_verify,shouldUseSimpleUI:e.shouldUseSimpleUI}))},e.prototype.show_verified_and_changed_modal=function(){return w.showInstance(new v({user:this.user,email:this.email_to_verify}))},e}(),h={inbox_counts:{},set_inbox_counts:function(t){return e.extend(this.inbox_counts,t)},show_options:function(e){var t,n,i,o;return o=e.user_id,t=e.aliases,n=e.on_alias_change,i=_.get_viewer().get_user_by_id(o),i.role===Constants.ROLE_WORK?h.show(o):w.showInstance(new m({user:i,initialAliases:t,onAliasChange:n,startChangePrimaryFlow:function(){return function(){return h.show(o)}}(this)}))},show:function(e){var t;return t=_.get_viewer().get_user_by_id(e),this._should_show_warning(t)?this._show_warning_modal(t):this._show_change_modal(t)},_should_show_warning:function(e){var t,n,i,o;return n=_.get_viewer().is_paired,o=n&&e.role===Constants.ROLE_WORK,i=o&&e.sso_required,t=this.inbox_counts[e.id]>0,i||t},_show_change_modal:function(){return function(e){return w.showInstance(new f({user:e,onChange:function(t){return h.trigger_change(e,t),"/account"!==r.parse(n.get_href()).path?n.redirect("/home?send_verification_email=1"):t!==e.email?n.reload():void 0},onVerificationCheck:function(t){var n;return h.trigger_change(e,t,!0),n=y.get_for_user(e),n.set_email_to_verify(t),n.email_sent()}}))}}(this),_show_warning_modal:function(e){return w.showInstance(new g({user:e,inboxCount:this.inbox_counts[e.id],onContinue:function(t){return function(){return t._show_change_modal(e)}}(this)}))},listen_for_change:function(t,n){var i;return i=this._email_change_event_for_user(t),e(document).on(i,n)},trigger_change:function(t,n,i){var o;return o=this._email_change_event_for_user(t),e(document).trigger(o,[n,i])},_email_change_event_for_user:function(e){return"db:email_changed:"+e.id}},INLINE_JS.ChangeEmail=h,T=t.DOM,d=t.createClass({propTypes:{userId:t.PropTypes.number,emailName:t.PropTypes.string,initialPendingEmail:t.PropTypes.string,initialAliases:t.PropTypes.array,showRecoveryEmailsGui:t.PropTypes.bool,showAliasGui:t.PropTypes.bool,showChangeEmail:t.PropTypes.bool},getInitialState:function(){return{pendingEmail:this.props.initialPendingEmail,aliases:void 0!==this.props.initialAliases?this.props.initialAliases:[]}},pendingVerifyLinkClick:function(e){return e.preventDefault(),y.get_for_user(this.user).show(),!1},pendingVerifyCancelClick:function(t){return t.preventDefault(),e.ajax("/cancelpendingemailchange",{type:"POST",success:function(e){return function(){return e.setState({pendingEmail:void 0})}}(this),subject_user:this.user.id}),!1},onAliasChange:function(e){return this.setState({aliases:e})},onUserAddressChange:function(e,t,n){return n?this.setState({pendingEmail:t}):this.forceUpdate()},componentDidMount:function(){return h.listen_for_change(this.user,this.onUserAddressChange)},render:function(){var e;return this.user=_.get_viewer().get_user_by_id(this.props.userId),T.div({className:"fieldset user-info"},T.div({},T.h3({},this.props.emailName,this.props.showRecoveryEmailsGui&&this.props.showChangeEmail&&this.user.is_email_verified?T.a({href:"#",className:"inline-change",onClick:function(e){return function(t){return t.preventDefault(),h.show_options({user_id:e.props.userId,aliases:e.state.aliases,on_alias_change:e.onAliasChange}),!1}}(this)},k("Change",{comment:"Change the user's contact methods (primary email, recovery email, maybe phone?)"})):void 0),this.props.showRecoveryEmailsGui?T.h4({className:"email-type-header"},k("Primary",{comment:"Primary email address"})):void 0,T.div({},this.user.email),this.user.is_email_verified?this.props.showChangeEmail?this.props.showRecoveryEmailsGui?void 0:T.a({href:"#",onClick:function(e){return function(t){return t.preventDefault(),h.show(e.props.userId,e.state.aliases),!1}}(this)},k("Change email")):T.a({href:"/account#work"},k("Contact your team admin to change email")):T.div({},T.a({href:"#",onClick:function(e){return function(t){return t.preventDefault(),"work"===e.user.role?y.getForRole(Constants.ROLE_WORK).verified_or_show():y.getForRole(Constants.ROLE_PERSONAL).verified_or_show(),!1}}(this)},k("Verify email"))),this.props.showAliasGui&&"work"!==this.user.role?T.div({},T.a({href:"#",onClick:function(e){return e.preventDefault(),!1}},k("Other ways to contact you"))):void 0),this.state.pendingEmail?T.div({className:"pending-unverified-email-container"},T.br({}),T.div({}),"work"===this.user.role?T.h3({},k("Pending %(team_name)s email change").format({team_name:_.get_viewer().team_name})):"personal"===this.user.role?T.h3({},k("Pending personal email change")):T.h3({},k("Pending email change")),T.div({className:"pending-unverified-email"},this.state.pendingEmail),T.div({},T.a({href:"#",onClick:this.pendingVerifyLinkClick},k("Verify email"))),T.div({}),T.a({href:"#",onClick:this.pendingVerifyCancelClick},k("Cancel"))):void 0,this.props.showRecoveryEmailsGui&&"work"!==this.user.role&&this.user.is_email_verified?T.div({},T.br({}),T.h4({className:"email-type-header"},k("Recovery",{comment:"Recovery email address; 'backup email'"})),function(){var t,n,i,o;if(0!==this.state.aliases.length){for(i=this.state.aliases,o=[],t=0,n=i.length;n>t;t++)e=i[t],"recovery_email"===e.type&&o.push(T.div({},T.span({},e.alias),e.verified?void 0:T.span({},k(" (pending)"))));return o}return T.a({href:"#",onClick:function(e){return function(t){return t.preventDefault(),w.showInstance(new p({user:e.user,onSuccess:function(t,n){var i;return i=e.state.aliases.slice(),i.push({alias:t,type:"recovery_email",verified:n}),e.setState({aliases:i})}})),!1}}(this)},k("Add a recovery email"))}.call(this)):void 0)}}),{EmailVerification:y,ChangeEmail:h,AccountPageEmailBlock:d}}),define("modules/clean/account/email_verify",["jquery","modules/clean/ajax"],function(e,t){var n;return n={_POLLING:{},send_verification_email:function(e,n,i,o){return t.WebRequest({url:"/sendverifyemail",data:{email:n,reason:i},success:function(){return o()},subject_user:e})},check_verification:function(e,n,i,o){return t.AuthenticatedRequest({url:"/isemailverified",data:{email:n},success:function(e){return"ok"===e?i():o()},subject_user:e})},listen_for_verification:function(e,t,n){var i;return i=""+e.id+":"+t,this._POLLING[i]?void 0:(this._POLLING[i]=!0,this._poll_for_verification(e,t,n))},_poll_for_verification:function(e,t,n){var i;return i=4e3,this.check_verification(e,t,n,function(o){return function(){return setTimeout(function(){return o._poll_for_verification(e,t,n)},i)}}(this))}}}),define("modules/clean/account/email_verify_reasons",[],function(){var e;return e={SHARE_FOLDER:"share_folder",CREATE_API_APP:"create_api_app",PUBLIC_FOLDER:"public_folder",GENERIC:"generic",SHMODAL:"shmodal",MOBILE_SHARE_FOLDER:"mobile_share_folder",EMAIL_ALIAS:"email_alias",CAROUSEL:"carousel",CHANGE_EMAIL:"change_email",CAROUSEL_EMAIL_ALIAS:"carousel_email_alias",PROMPT_CAMPAIGN:"prompt_campaign",ADD_COMMENT:"add_comment",SUBSCRIBE_TO_COMMENTS:"subscribe_to_comments",CREATE_FILE_COLLECTOR:"create_file_collector",JOIN_DISCOVERED_TEAM:"join_discovery"}}),define("modules/clean/account/verify_email_modals",["external/react","modules/core/i18n","modules/clean/account/email_verify","modules/clean/account/email_verify_reasons","modules/clean/analytics","modules/clean/react/button","modules/clean/react/modal","modules/clean/viewer","modules/clean/react/react_i18n"],function(e,t,n,i,o,r,s,a,l){var u,c,_,d,p,h,f,m,g,v,y;return y=t._,h=o.UserActivityLogger,_=s.Modal,v=e.DOM,d=l.R_,m={getStyle:function(){return this.props.shouldUseSimpleUI?"simple":"default"},renderChangeEmail:function(){return this.props.shouldUseSimpleUI?void 0:v.a({href:"#",className:"change-email-before-verify",onClick:this.showChangeEmail},y("Update email address"))}},f=e.createClass({mixins:[m],propTypes:{user:e.PropTypes.object,reason:e.PropTypes.string,email:e.PropTypes.string,onEmailSent:e.PropTypes.func,onShowChange:e.PropTypes.func,shouldUseSimpleUI:e.PropTypes.bool},render:function(){var e;return e={reason:this.props.reason},h.log("web","email_verify_shown",e),_({title:y("Verify your email address"),className:"verify-email",acceptButtonText:y("Send email"),dismissButtonText:y("Cancel"),onAccept:this.sendEmail,ref:"modal",style:this.getStyle()},v.div({},v.div({},this.getPrompt()),this.renderChangeEmail()))},sendEmail:function(e){return e.preventDefault(),n.send_verification_email(this.props.user,this.props.email,this.props.reason,this.emailSent)},close:function(){return this.refs.modal.close()},emailSent:function(){var e;return this.close(),"function"==typeof(e=this.props).onEmailSent?e.onEmailSent():void 0},showChangeEmail:function(e){var t,n;return t={reason:this.props.reason},h.log("web","email_verify_change_first",t),e.preventDefault(),this.close(),"function"==typeof(n=this.props).onShowChange?n.onShowChange():void 0},getPrompt:function(){var e;switch(this.props.reason){case i.ADD_COMMENT:return d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can add comments. It's as simple as clicking the link in the verification email we send to you.");case i.SUBSCRIBE_TO_COMMENTS:return d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can subscribe. It's as simple as clicking the link in the verification email we send to you.");case i.SHARE_FOLDER:return d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to share folders. It's as simple as clicking the link in the verification email we send to you.");case i.SHMODAL:return d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to share links. It's as simple as clicking the link in the verification email we send to you.");case i.CREATE_API_APP:return d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can register an API app. It's as simple as clicking the link in the verification email we send to you.");case i.PUBLIC_FOLDER:return d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to enable your Public folder. It's as simple as clicking the link in the verification email we send to you.");case i.CHANGE_EMAIL:return e=a.get_viewer().is_paired,e&&this.props.user.role===Constants.ROLE_PERSONAL?d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to finish updating your personal email. It's as simple as clicking the link in the verification email we send to you."):e&&this.props.user.role===Constants.ROLE_WORK?d({email:this.props.email,team:a.get_viewer().team_name},"Dropbox needs to verify your email address <strong>%(email)s</strong> to finish updating your %(team)s email. It's as simple as clicking the link in the verification email we send to you."):d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to finish updating your email. It's as simple as clicking the link in the verification email we send to you.");case i.CREATE_FILE_COLLECTOR:return d({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to create file requests. Itâs as simple as clicking the link in the verification email we send to you.");default:return d({email:this.props.email},"Verify your email address at <strong>%(email)s</strong> to share folders and ensure your account can be recovered.")}}}),p=e.createClass({mixins:[m],propTypes:{user:e.PropTypes.object,email:e.PropTypes.string,reason:e.PropTypes.string,onEmailSent:e.PropTypes.func,onShowChange:e.PropTypes.func,shouldUseSimpleUI:e.PropTypes.bool},render:function(){var e;return e={reason:this.props.reason},h.log("web","email_verify_resend_shown",e),_({title:y("Verify your email address"),buttonComponent:this.renderButtons(),ref:"modal",style:this.getStyle()},v.div({},v.div({},this.getPrompt()),this.renderChangeEmail()))},renderButtons:function(){return v.div({className:"db-modal-buttons"},r.link_button({className:"dbmodal-button",importance:"primary",onClick:this.close},y("Done")),r.link_button({className:"dbmodal-button",importance:"tertiary",onClick:this.sendEmail},y("Resend email")))},close:function(){return this.refs.modal.close()},showChangeEmail:function(e){var t,n;return t={reason:this.props.reason},h.log("web","email_verify_resend_change_first",t),e.preventDefault(),this.close(),"function"==typeof(n=this.props).onShowChange?n.onShowChange():void 0},sendEmail:function(e){return e.preventDefault(),n.send_verification_email(this.props.user,this.props.email,this.props.reason,this.emailSent)},emailSent:function(){var e;return this.close(),"function"==typeof(e=this.props).onEmailSent?e.onEmailSent():void 0},getPrompt:function(){var e;return e=a.get_viewer().is_paired,this.props.reason!==i.CHANGE_EMAIL?d({email:this.props.email},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to verify your address. If you can't find it, check your spam folder or click the button to resend the email."):e&&this.props.user.role===Constants.ROLE_PERSONAL?d({email:this.props.email},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to finish updating your personal email. If you can't find it, check your spam folder or click the button to resend the email."):e&&this.props.user.role===Constants.ROLE_WORK?d({email:this.props.email,team:a.get_viewer().team_name},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to finish updating your %(team)s email. If you can't find it, check your spam folder or click the button to resend the email."):d({email:this.props.email},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to finish updating your email. If you can't find it, check your spam folder or click the button to resend the email.")}}),g=e.createClass({propTypes:{email:e.PropTypes.string},render:function(){var e;return e=d({email:this.props.email},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to verify your address. If you can't find it, check your spam folder or click the button to resend the email."),_({title:y("Verification email sent!"),acceptButtonText:y("Done")},v.div({},e))}}),c=e.createClass({propTypes:{reason:e.PropTypes.string,email:e.PropTypes.string},render:function(){return _({title:y("Your email address has been verified"),acceptButtonText:y("Done")},v.div({},this.getPrompt()))},getPrompt:function(){switch(this.props.reason){case i.SHARE_FOLDER:return d({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. Now you can share folders with friends, family, or coworkers.");case i.CREATE_API_APP:return d({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. You can now register API apps.");case i.PUBLIC_FOLDER:return d({email:this.props.email},"Thanks for verifying your email address. You can now enable the Public folder for your <strong>%(email)s</strong> Dropbox.")}return""}}),u=e.createClass({propTypes:{email:e.PropTypes.string,user:e.PropTypes.object},render:function(){return _({title:y("Your email address has been verified"),acceptButtonText:y("Done")},v.div({},this.getPrompt()))},getPrompt:function(){var e;return e=a.get_viewer().is_paired,e&&this.props.user.role===Constants.ROLE_PERSONAL?d({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. Your personal account has successfully been changed."):e&&this.props.user.role===Constants.ROLE_WORK?d({email:this.props.email,team:a.get_viewer().team_name},"Thanks for verifying your email address <strong>%(email)s</strong>. Your %(team)s account has successfully been changed."):d({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. Your account has successfully been changed.")}}),{VerifyEmailModal:f,ResendVerifyEmailModal:p,VerifyEmailSentModal:g,EmailVerifiedModal:c,ChangedEmailVerifiedModal:u}}),define("modules/clean/account_photo_modal/account_header",["jquery","modules/clean/account_photo_modal/controller","modules/core/uri"],function(e,t){var n;return n=function(){function n(){}return n.init=function(n,i,o){return e(n).on("click",function(e){return e.preventDefault(),t.show()}),e(i).on("click",function(e){return e.preventDefault(),t.show()}),e(document).on("db:account_photo:photo_set",function(){return e(i).addClass(o)}),e(document).on("db:account_photo:photo_deleted",function(){return e(i).removeClass(o)})},n}()});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/account_photo_modal/controller",["jquery","dropins","external/flash_detect","external/plupload_dev","modules/clean/account_photo_modal/mode_enum","modules/clean/account_photo_modal/ui","modules/clean/photo_upload/controller","modules/clean/analytics","modules/clean/react/modal","modules/clean/static_urls","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u,c,_){var d,p,h,f,m,g;return m=a.UserActivityLogger,h=l.Modal,f=u.UrlConstants,g=c._,d=function(){function e(){}return e.prototype.on_show=function(){
return m.log("web","account_photo_modal_shown")},e.prototype.on_start_over=function(){return m.log("web","account_photo_modal_start_over")},e.prototype.on_save=function(){return m.log("web","account_photo_modal_save")},e.prototype.on_error=function(e){return m.log("web","account_photo_modal_error",e)},e.prototype.on_photo_selected=function(e){return m.log("web","account_photo_modal_photo_selected",e)},e}(),p=function(e){function t(){t.__super__.constructor.call(this,new d,"account_photo","/account/set_account_photo","/account/delete_account_photo")}return __extends(t,e),t.show=function(){var e;return e=new t,e.show(r)},t.prototype._update_photo_url=function(e){return _.parse(e).updateQuery({size:"256x256"}).toString()},t}(s)}),define("modules/clean/account_photo_modal/mode_enum",[],function(){var e;return e={SELECT:"select",ERROR:"error",UPLOADING:"uploading",CONFIRM:"confirm"}}),define("modules/clean/account_photo_modal/ui",["jquery","external/react","modules/clean/account_photo_modal/mode_enum","modules/clean/react/image","modules/clean/react/button","modules/clean/react/modal","modules/clean/static_urls","modules/core/i18n","modules/clean/photo_upload/ui"],function(e,t,n,i,o,r,s,a,l){var u,c,_,d,p,h;return _=o.button,c=r.Modal,p=s.static_url,h=a._,d=t.DOM,u=t.createClass({propTypes:{can_upload:t.PropTypes.bool,can_dragdrop:t.PropTypes.bool,upload_button_id:t.PropTypes.string,upload_container_id:t.PropTypes.string,chooser_button_click_handler:t.PropTypes.func,start_over_button_click_handler:t.PropTypes.func,save_button_click_handler:t.PropTypes.func,dismiss_handler:t.PropTypes.func},getInitialState:function(){return{mode:n.SELECT,error_message:null,percent_uploaded:null,large_photo_url:null,dragover:!1}},render:function(){return c({acceptButtonText:null,onDismiss:this.props.dismiss_handler,ref:"modal",style:"clean",width:700},d.div({className:"add-account-photo-modal"},l({mode:this.state.mode,reason_to_upload:h("Select an account photo so your friends and coworkers can recognize you around Dropbox."),on_confirm_text:d.span({},d.strong({},h("Looking good!"))," ",h("Your account photo has been set.")),can_upload:this.props.can_upload,can_dragdrop:this.props.can_dragdrop,upload_button_id:this.props.upload_button_id,upload_container_id:this.props.upload_container_id,chooser_button_click_handler:this.props.chooser_button_click_handler,start_over_button_click_handler:this.props.start_over_button_click_handler,save_button_click_handler:this.props.save_button_click_handler,on_finish:this.closeModal,large_photo_url:this.state.large_photo_url,dragover:this.state.dragover,error_message:this.state.error_message,percent_uploaded:this.state.percent_uploaded,can_choose_from_dropbox:!0,display_photo_on_select:!1,class_name:""})))},closeModal:function(){return this.refs.modal.close()}})});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/activity/activity",["external/underscore","modules/clean/activity/activity_user","modules/clean/activity/comment","modules/clean/activity/like","modules/clean/datetime","modules/core/exception"],function(e,t,n,i,o,r){var s,a,l,u,c,_;return l={ADD:0,EDIT:1,POST:2,FILE:3,COMMENT:4,NS_RELATED_EVENT:5},a={SHARED_LINK_VIEW:1,SHARED_LINK_LIGHTBOX:2,BROWSE_FILE_VIEWER:3,BROWSE_LIGHTBOX:4,SONOMA:5,EMAIL_REPLY:6,MEMBER_LINK_VIEW:7},_=function(e){return e===l.FILE?c:e===l.COMMENT?u:r.assert(!1,"Invalid activity type")},s=function(){function n(e){var n,o,r,s,a;this.activity_key=e.activity_key,this.activity_type=e.activity_type,this.activity_data=e.activity_data,this.when=e.when,this.feedback_off=e.feedback_off,this.can_edit_feedback=e.can_edit_feedback,this.seen_comment_count=e.seen_comment_count,o=e.comment_activity_dicts,s=e.like_dicts,a=e.owner,this.owner=new t(a),this.when_mses=1e3*this.when,this.comment_activities=function(){var e,t,i;for(i=[],e=0,t=o.length;t>e;e++)n=o[e],i.push(new u(n));return i}(),this.likes=function(){var e,t,n;for(n=[],e=0,t=s.length;t>e;e++)r=s[e],n.push(new i(r));return n}()}return n.prototype.when_pretty=function(){return o.ago(new Date(this.when_mses))},n.prototype.commentCount=function(){return this.comment_activities.length},n.prototype.resolvedCommentCount=function(){return e.filter(this.comment_activities,function(e){return e.comment.resolved}).length},n.prototype.unresolvedCommentCount=function(){return this.commentCount()-this.resolvedCommentCount()},n.prototype.unseenCommentCount=function(){return this.commentCount()-this.seen_comment_count},n.prototype._remove_comment_activity=function(e){return this.comment_activities=this.comment_activities.filter(function(t){return t.activity_key!==e.activity_key})},n.prototype._add_comment_activity=function(e){return this.comment_activities.push(e)},n.prototype._update_like=function(e,t){var n;return n=new i({liker_dict:e,when_mses:Date.now()}),t?this._add_like(n):this._remove_like(n)},n.prototype._remove_like=function(e){return this.likes=this.likes.filter(function(t){return t.liker.id!==e.liker.id})},n.prototype._add_like=function(e){return this.likes.push(e)},n.prototype._markCommentsSeen=function(t){var n;return n=e.findWhere(this.comment_activities,{activity_key:t}),this.seen_comment_count=1+n},n}(),u=function(e){function t(e){t.__super__.constructor.call(this,e),this.comment=new n(e.comment),this.permissions={user_ids_who_can_delete:e.permissions.user_ids_who_can_delete}}return __extends(t,e),t}(s),c=function(e){function n(e){var i;n.__super__.constructor.call(this,e),this.ns_path=e.ns_path,this.latestRevision=e.latest_revision,this.file_icon=e.file_icon,this.users_to_notify=function(){var n,o,r,s;for(r=e.users_to_notify,s=[],n=0,o=r.length;o>n;n++)i=r[n],s.push(new t(i));return s}()}return __extends(n,e),n}(s),{ActivityType:l,ActivityContext:a,get_activity_class_by_type:_,Activity:s,CommentActivity:u,FileActivity:c}}),define("modules/clean/activity/activity_local_storage",["modules/clean/storage"],function(e){var t,n;return n="tmp-file-comments-",new(t=function(){function t(){}return t.prototype.get_store=function(t,i){var o;return o=e.SessionStorage.get(""+n+t),o&&o.activity_key===i&&(new Date).getTime()-o.time<3e5?o:null},t.prototype.clear_store=function(t){return e.SessionStorage.set(""+n+t,null)},t.prototype.set_store=function(t,i,o){return e.SessionStorage.set(""+n+t,{activity_key:i,comment_activity_key:o,time:(new Date).getTime()})},t}())});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/activity/activity_store",["external/rsvp","modules/clean/ajax","modules/clean/activity/activity","modules/clean/activity/like","modules/core/exception","modules/core/uri"],function(e,t,n,i,o){var r,s,a;return a=e.Promise,r=function(){function e(e,t){this.activity_context=e,this.activity_context_data=t}return e.prototype._activity_type=function(){return o.assert(!1,"Not implemented")},e.prototype._fetch_activity_url=function(){return o.assert(!1,"Not implemented")},e.prototype._comment_url=function(){return o.assert(!1,"Not implemented")},e.prototype._update_like_url=function(){return o.assert(!1,"Not implemented")},e.prototype._update_resolved_url=function(){return o.assert(!1,"Not implemented")},e.prototype._update_subscribe_url=function(){return o.assert(!1,"Not implemented")},e.prototype._update_feedback_setting_url=function(){return o.assert(!1,"Not implemented")},e.prototype._submit_product_feedback_url=function(){return o.assert(!1,"Not implemented")},e.prototype.gen_activities=function(e){var t,i,o,r,s;for(t=[],r=0,s=e.length;s>r;r++)o=e[r],i=n.get_activity_class_by_type(this._activity_type()),t.push(new i(o));return t},e.prototype.genActivitiesFromMap=function(e){var t,i,o,r;r={};for(o in e)i=e[o],t=n.get_activity_class_by_type(this._activity_type()),r[o]=new t(i);return r},e.prototype._parse_activity_and_callback=function(e,t){var n,i;return e=JSON.parse(e),i=e.payload,n=this.gen_activities([i]),1===(null!=n?n.length:void 0)&&"function"==typeof t?t(n[0]):void 0},e.prototype.fetch_activity=function(e,n,i,o){var r;return r=function(e){return function(t){return e._parse_activity_and_callback(t,n)}}(this),t.WebRequestOref({url:this._fetch_activity_url(),type:"GET",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,activity_type:this._activity_type(),oref:o},success:r,error:i,subject_user:e.id})},e.prototype.fetchActivities=function(e,n,i,o){var r;return r=t.WebRequestOref({url:this._fetch_activities_url(),type:"GET",data:{activity_context:n,activity_context_data_batch:JSON.stringify(i),activity_type:this._activity_type(),oref:o},subject_user:e}),a.resolve(r)},e.prototype._parse_activity_and_callback_with_bolt_data=function(e,t){var n,i,o;return e=JSON.parse(e),i=e.payload,n=this.gen_activities([i]),o=e.bolt_data,1===(null!=n?n.length:void 0)&&"function"==typeof t?t(n[0],o):void 0},e.prototype.fetch_activity_and_bolt_data=function(e,n,i){var o;return o=function(e){return function(t){return e._parse_activity_and_callback_with_bolt_data(t,n)}}(this),t.WebRequestOref({url:this._fetch_activity_url(),type:"GET",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,activity_type:this._activity_type()},success:o,error:i,subject_user:e.id})},e.prototype.add_comment=function(e,i,o,r,s,a,l){var u,c;return null==r&&(r=null),null==s&&(s=null),c=function(t){var i,o,r,u;if(t=JSON.parse(t),"error"===t.status)return l(t.payload);if(null!=s)for(u=e.comment_activities,o=0,r=u.length;r>o;o++)i=u[o],i.activity_key===s.activity_key&&i._add_comment_activity(new n.CommentActivity(t.payload));else e._add_comment_activity(new n.CommentActivity(t.payload));return"function"==typeof a?a(e):void 0},u={activity_context:this.activity_context,activity_context_data:this.activity_context_data,comment_text:o,comment_metadata_json:null!=r?JSON.stringify(r):null},null!=s&&(u.target_comment_activity_key=s.activity_key),t.WebRequestOref({url:this._comment_url(),type:"POST",data:u,success:c,error:l,subject_user:i.id})},e.prototype.delete_comment=function(e,i,o,r,s){var a;return a=function(t){t=JSON.parse(t),e._remove_comment_activity(new n.CommentActivity(t.payload)),"function"==typeof r&&r(t.payload)},t.WebRequestOref({url:"/file_activity/comment/delete",type:"POST",data:{comment_key:o,activity_context:this.activity_context,activity_context_data:this.activity_context_data},success:a,error:s,subject_user:i.id})},e.prototype.add_like=function(e,t,n,i,o){return this._update_like(e,t,!0,this._update_like_url(),n,i,o)},e.prototype.remove_like=function(e,t,n,i,o){return this._update_like(e,t,!1,this._update_like_url(),n,i,o)},e.prototype.add_comment_like=function(e,t,n,i,o){return this._update_like(e,t,!0,this._update_comment_like_url(),n,i,o)},e.prototype.remove_comment_like=function(e,t,n,i,o){return this._update_like(e,t,!1,this._update_comment_like_url(),n,i,o)},e.prototype._update_like=function(e,n,i,o,r,s,a){var l;return e._update_like(n,i),"function"==typeof r&&r(e),l=function(){return function(t){return e._update_like(n,!i),"function"==typeof r&&r(e),"function"==typeof a?a(t):void 0}}(this),t.WebRequestOref({url:o,type:"POST",data:{activity_key:e.activity_key,activity_context:this.activity_context,activity_context_data:this.activity_context_data,liked:i},success:s,error:l,subject_user:n.id})},e.prototype.update_subscribe=function(e,n,i,o,r,s,a){var l,u,c,_,d,p;return p=o||n,l=function(){return e.users_to_notify.push(p)},c=function(){return e.users_to_notify=e.users_to_notify.filter(function(e){return e.email!==p.email})},i?l():c(),_=function(e){return function(t){return e._parse_activity_and_callback(t,s)}}(this),u=function(e){return function(t){return i?c():l(),e._parse_activity_and_callback(t,a)}}(this),d=null!=o?o.email:void 0,t.WebRequestOref({url:this._update_subscribe_url(),type:"POST",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,subscribed:i,target_user_identifier:d},success:_,error:u,subject_user:n.id}),"function"==typeof r?r(e):void 0},e.prototype.update_feedback_setting=function(e,n,i,o,r,s){var a;return e.feedback_off=i,"function"==typeof o&&o(e),a=function(){return function(t){return e.feedback_off=!i,"function"==typeof o&&o(e),"function"==typeof s?s(t):void 0}}(this),t.WebRequestOref({url:this._update_feedback_setting_url(),type:"POST",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,feedback_off:i},success:r,error:a,subject_user:n.id})},e.prototype.update_resolved=function(e,n,i,o,r){var s;return e.comment.resolved=i,s=function(){return function(t){return e.comment.resolved=!i,"function"==typeof r?r(t):void 0}}(this),t.WebRequestOref({url:this._update_resolved_url(),type:"POST",data:{activity_key:e.activity_key,activity_context:this.activity_context,activity_context_data:this.activity_context_data,resolved:i},success:o,error:s,subject_user:n.id})},e.prototype.mark_comments_seen=function(e,n,i,o,r){return t.WebRequestOref({url:this._mark_comments_seen_url(),type:"POST",data:{last_seen_comment_key:i,activity_context:this.activity_context,activity_context_data:this.activity_context_data},success:function(t){return e._markCommentsSeen(i),"function"==typeof o?o(t):void 0},error:r,subject_user:n.id})},e.prototype.submit_product_feedback=function(e,n,i,o){return t.WebRequestOref({url:this._submit_product_feedback_url(),type:"POST",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,feedback_text:n},success:i,error:o,subject_user:e.id})},e}(),s=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype._activity_type=function(){return n.ActivityType.FILE},t.prototype._fetch_activity_url=function(){return"/file_activity/file_activity"},t.prototype._fetch_activities_url=function(){return"/file_activity/file_activity_batch"},t.prototype._comment_url=function(){return"/file_activity/comment"},t.prototype._update_like_url=function(){return"/file_activity/like"},t.prototype._update_comment_like_url=function(){return"/file_activity/comment/like"},t.prototype._update_resolved_url=function(){return"/file_activity/comment/resolve"},t.prototype._update_subscribe_url=function(){return"/file_activity/subscribe"},t.prototype._update_feedback_setting_url=function(){return"/file_activity/feedback_setting"},t.prototype._mark_comments_seen_url=function(){return"/file_activity/mark_comments_seen"},t.prototype._submit_product_feedback_url=function(){return"/file_activity/product_feedback"},t}(r),{ActivityStore:r,FileActivityStore:s}}),define("modules/clean/activity/activity_user",["modules/core/user_i18n"],function(e){var t;return t=function(){function t(t){t?(this.id=t.id,this.fname=t.fname,this.lname=t.lname,this.display_name=t.display_name,this.email=t.email,this.photo_url=t.photo_url,this.photo_circle_url=t.photo_circle_url,this.initials=e.getInitials(this.display_name),this.unique_id=t.unique_id,this.is_email_verified=t.is_email_verified,this.is_signed_in=!0):this.is_signed_in=!1}return t.prototype.get_display_identity=function(){return this.display_name?this.display_name:this.email},t}()}),define("modules/clean/activity/comment",["modules/clean/activity/activity_user","modules/clean/datetime"],function(e,t){var n;return n=function(){function n(t){var n,o;this.comment_gid=t.comment_gid,o=t.commenter_dict,this.comment_text=t.comment_text,this.raw_comment_text=t.raw_comment_text,this.when_mses=t.when_mses,this.resolved=t.resolved,this.revision=t.revision,n=t.comment_meta_json,this.commenter=new e(o),this.comment_metadata=null!=n?new i(n):null}var i;return i=function(){function e(e){var t;null!=e.revision&&(this.revision=e.revision),null!=e.annotation&&(this.annotation=e.annotation),null!=e.stickers&&(this.stickerId=e.stickers.id),null!=e.index&&(this.type=e.type,this.index=e.index,this.state=null!=(t=e.state)?t:"present")}return e.prototype.has_revision_data=function(){return null!=this.revision},e.prototype.has_annotation_data=function(){return null!=this.annotation},e.prototype.has_pptx_data=function(){return null!=this.index},e.prototype.has_sticker_data=function(){return null!=this.stickerId},e.prototype.get_sticker_id=function(){return null!=this.stickerId?this.stickerId:void 0},e.prototype.as_string=function(){return this._type_as_string(this.type)+" "+this.index},e.prototype._type_as_string=function(e){switch(e){case"slide":return"Slide";default:return console.warn("Unrecognised type: "+e),e}},e.prototype.is_deleted=function(){return"deleted"===this.state?!0:!1},e}(),n.prototype.when_pretty=function(){return t.ago(new Date(this.when_mses))},n.prototype.has_metadata=function(){return null!=this.comment_metadata},n.prototype.get_metadata_as_string=function(){return this.has_metadata()?this.comment_metadata.as_string():""},n.prototype.is_metadata_deleted=function(){return this.has_metadata()&&this.comment_metadata.is_deleted()},n}()});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/activity/file_viewer_state",["modules/clean/filepath"],function(e){var t;return t=function(){function t(e){this._file=null,this._latestRevision=null,this._currentRevision=null,e&&this.setFile(e)}var n;return n=["pdf","docx"],t.prototype.setFile=function(e){return this._file=e,this._latestRevision=this._currentRevision=this._file.latestRevision},t.prototype.getFileExtension=function(){return this._file?e.file_extension(this._file.filename):""},t.prototype.isAnnotationReadyFile=function(){var e;return e=this.getFileExtension(),__indexOf.call(n,e)>=0?!0:!1},t.prototype.isCurrentlyAtLatestRevision=function(){return null!=this._latestRevision&&null!=this._currentRevision?this._latestRevision.when===this._currentRevision.when:!1},t.prototype.isCurrentlyAtRevision=function(e){return null!=e&&null!=this._currentRevision?e.when===this._currentRevision.when:!1},t.prototype.isLatestRevision=function(e){return null!=e&&null!=this._latestRevision?e.when===this._latestRevision.when:!1},t.prototype.isOldRevision=function(e){return!this.isLatestRevision(e)},t.prototype.getLatestRevision=function(){return this._latestRevision},t.prototype.getCurrentRevision=function(){return this._currentRevision},t.prototype.setCurrentRevision=function(e){return this._currentRevision=e},t}()}),define("modules/clean/activity/like",["modules/clean/activity/activity_user","modules/clean/datetime"],function(e,t){var n;return n=function(){function n(t){var n;n=t.liker_dict,this.when_mses=t.when_mses,this.liker=new e(n)}return n.prototype.when_pretty=function(){return t.ago(new Date(this.when_mses))},n}()});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},__bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/ajax",["jquery","external/underscore","modules/core/cookies","modules/core/exception","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/job_progress","modules/clean/storage","modules/clean/undo"],function(e,t,n,i,o,r,s,a,l,u,c){var _,d,p,h,f,m,g,v,y,b,w,C,S,E,T,k,x,I,A,P,N,O,R,L,M,D,U,F,B,q,H,j,V,W,$,G,K,z,Y;return Y=r._,O="err:",N="async_task_started:",P="async_task_err:",A="done:",x="oref",R=function(t,n){var i,o,r,s;return null==t&&(t={}),null==n&&(n=[]),null==t.type&&(null!=t.method?(("undefined"!=typeof Constants&&null!==Constants?Constants.IS_PROD:void 0)||console.log('Expected "type" attribute; received "method"'),r=t.method):r="POST",t.type=r),i=new f(t),o=K(i,n),s=e.ajax({url:o.url(),type:t.type,noDropboxDefaults:!0,data:o.data(),dataType:t.dataType||"text",traditional:!0,xhrFields:o.xhrFields(),success:function(e,t,n){return o.success(e,t,n)},error:function(e,t,n){return o.error(e,t,n)},complete:function(e,t){return o.complete(e,t)},async:t.async||!0}),o.request(s)},K=function(e,n){var i,o,r,s,a,l,u,c;for(o=[e],c=t(n.slice(0)).reverse(),s=0,l=c.length;l>s;s++)i=c[s],o.push(new i);for(r=null,a=0,u=o.length;u>a;a++)i=o[a],r&&(i.next=r),r=i;return r},f=function(){function e(e){null==e&&(e={}),this.options=function(){return e},this.url=function(){return String(e.url||"")},this.data=function(){return e.data||{}},this.xhrFields=function(){return e.xhrFields||{}},this.success=e.success||this.identity,this.error=e.error||this.identity,this.complete=e.complete||this.identity,this.request=this.identity}return e.prototype.identity=function(e){return e},e}(),v=function(){function e(){}return e.prototype.options=function(){return this.next.options()},e.prototype.url=function(){return this.next.url()},e.prototype.data=function(){return this.next.data()},e.prototype.xhrFields=function(){return this.next.xhrFields()},e.prototype.success=function(e,t,n){return this.next.success(e,t,n)},e.prototype.error=function(e,t,n){return this.next.error(e,t,n)},e.prototype.complete=function(e,t){return this.next.complete(e,t)},e.prototype.request=function(e){return this.next.request(e)},e}(),g=function(o){function r(){return r.__super__.constructor.apply(this,arguments)}return __extends(r,o),r.prototype.SUPPORTED_TLDS=["dropbox.com"],r.prototype.data=function(){var t;return i.assert(this._is_db_domain(),"injecting CSRF token into request to non-dropbox domain"),t={is_xhr:!0,t:n.read(Constants.JS_CSRF_COOKIE)||""},e.extend(t,this.next.data())},r.prototype._is_db_domain=function(){var e,n;return(e=a.parse(String(this.url())).authority)?(n=e.split("."),t.reduce(this.SUPPORTED_TLDS,function(e,t){var i,o;return o=t.split("."),i=n.slice(-1*o.length).join("."),e||t===i},!1)):!0},r}(v),F=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.data=function(){var e,t;return e=this.next.data(),t=this.options(),t.subject_user&&!e[Constants.UID_PARAM_NAME]&&(e[Constants.UID_PARAM_NAME]=String(t.subject_user)),e},t}(v),m=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.error=function(e,t,n){var i,o;return 403===e.status&&(i=u.SessionStorage.get("reload-timestamp"),o=(new Date).getTime(),(!i||o-i>3e4)&&(u.SessionStorage.set("reload-timestamp",o),window.location.reload(!0))),this.next.error(e,t,n)},t}(v),M=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.data=function(){var t;return t=this.next.data(),null!=e.ajaxSettings.restrict&&(t.restrict=e.ajaxSettings.restrict),t},n}(v),L=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.data=function(){var t,n;return t=this.next.data(),Constants.REQUEST_TRACING_ENABLED&&"post"===this.options().type.toLowerCase()?(n={parent_request_id:Constants.REQUEST_ID},e.extend(n,t)):t},n}(v),w=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.data=function(){var t,n;return t=this.next.data(),Constants.CPROFILE_ENABLED?(n={parent_request_id:Constants.REQUEST_ID,cProfile:Constants.CPROFILE_PARAMETER},e.extend(n,t)):t},n.prototype.success=function(e,t,n){return this._report_cprofile(e,t,n),this.next.success(e,t,n)},n.prototype._report_cprofile=function(t,n,i){var o,r,s;return o=e("#cprofile"),o.length?(r=this._build_cprofile_link(i),s=o.find(".ajax"),s.length>=10&&s.last().remove(),o.prepend(r)):void 0},n.prototype._build_cprofile_link=function(t){var n,i,o,r,s,l,u,c,_,d,p;if(o=t.getResponseHeader("X-Dropbox-Request-Id"),u=t.getResponseHeader("X-Server-Response-Time")||"-1",r={request_id:""+Constants.REQUEST_ID+"-"+o},c=this.url(),-1!==c.indexOf(Constants.BLOCK_CLUSTER))r.block=1;else for(p=Constants.BATCH_THUMB_ENDPOINTS,_=0,d=p.length;d>_;_++)if(i=p[_],-1!==c.indexOf(i)){r.block=1;break}return c=c.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,""),s=e('<a target="_new" />').attr("href",String(a({authority:Constants.WEBSERVER,path:"/profile/cprofile",query:r}))).text("CG "),l=e('<a target="_new" />').attr("href",String(a({authority:Constants.WEBSERVER,path:"/profile/ioprofile",query:r}))).text("IO "),n=e('<div class="ajax">').text("Ajax: "+c+" ("+u+"ms)").prepend(s,l)},n}(v),C=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.data=function(){var t;return t=this.next.data(),Constants.GANDALF_PANEL?e.extend({gandalf_panel:1},t):t},n.prototype.success=function(e,t,n){return this._report_gandalf(e,t,n),this.next.success(e,t,n)},n.prototype._report_gandalf=function(t,n,i){var o;return e("#gandalf_panel").length&&"/gandalf_panel"!==this.url().substring(0,14)&&null!=(o=window.gandalf_panel)?o.add(this.url(),i.getResponseHeader("X-Dropbox-Request-Id")):void 0},n}(v),b=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.error=function(e,t,n){return this._notify_dev(e,t,n),this.next.error(e,t,n)},n.prototype._notify_dev=function(t){var n,i,r;return!("undefined"!=typeof Constants&&null!==Constants?Constants.IS_PROD:void 0)&&500===t.status&&t.getResponseHeader("X-Debug-Url")?(r=t.getResponseHeader("X-Debug-Url"),n=e("<span />"),n.text(s.DEFAULT_ERROR),i=e("<a/>",{href:r,target:"_blank"}).text(Y("View debug")),n.append("&nbsp;").append(i),s.error(new o(n.html()))):void 0},n}(v),B=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.success=function(e,t,n){var i,o,r;return n.responseText.length?0===n.responseText.indexOf(O)?(i=n.responseText.substr(O.length),o=this.next.error(n,t,i),"{"!==(r=i[0])&&"["!==r&&s.error(i),o):this.next.success(e,t,n):this.next.error(n,t,"")},t.prototype.error=function(e,t,n){return"abort"!==n&&s.error(),this.next.error(e,t,n)},t}(v),q=function(e){function t(){return this._clear_working_msg=__bind(this._clear_working_msg,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.request=function(e){return this.xhr=e,setTimeout(function(e){return function(){return e._request_finished()?void 0:e._should_show_working_msg()?(e._show_working_msg(),e.xhr.done(e._clear_working_msg)):void 0}}(this),4e3),this.next.request(this.xhr)},t.prototype._request_finished=function(){return 4===this.xhr.readyState},t.prototype._should_show_working_msg=function(){return s.isShown()&&s.current()!==c.undo_notification},t.prototype._show_working_msg=function(){return this.notification=s.success(Y("Still working..."))},t.prototype._clear_working_msg=function(){return s.isShown()&&this.notification===s.current()?s.clear():void 0},t}(v),I=function(t){function n(){return this._watch=__bind(this._watch,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.data=function(){var t,i;return this.job_id=n.generate_job_id(),t=this.next.data(),this.uid=t[Constants.UID_PARAM_NAME],i=this.options().subject_user,!this.uid&&i&&(this.uid=String(i)),e.extend({job_id:this.job_id},t)},n.prototype.request=function(e){return this._interval=1e3,this._failures=0,this._watch_count=0,this._watch_id=setInterval(this._watch,this._interval),this.next.request(e)},n.prototype.success=function(e,t,n){return this.next.success(e,t,n)},n.prototype.error=function(e,t,n){return this.next.error(e,t,n)},n.prototype.complete=function(e,t){return this._stop(),l.Job.handled(this.job_id),this.next.complete(e,t)},n.prototype._watch=function(){return l.Job.peek(this.job_id)?this._stop():(this._watch_count++,this._watch_count%10===0&&(clearInterval(this._watch_id),this._interval=Math.min(Math.floor(1.5*this._interval),3e4),this._watch_id=setInterval(this._watch,this._interval)),this._show_progress_modal(),this._fetch_progress())},n.prototype._stop=function(){return clearInterval(this._watch_id),l.ModalProgress.hide()},n.prototype._show_progress_modal=function(){return this._modal_shown?void 0:(this._modal_shown=!0,l.ModalProgress.show(this.options().progress_text))},n.prototype._fetch_progress=function(){var e;return e={},this.uid&&(e[Constants.UID_PARAM_NAME]=this.uid),h({url:"/job_status/"+this.job_id,data:e,success:function(){return function(e,t,n){var i;return i=0===n.responseText.indexOf("done")?"1/1":n.responseText,l.ModalProgress.update(i)}}(this),error:function(e){return function(t,n,i){return e._failures++,e._failures<3?void 0:(e._stop(),e.next.error(t,n,i))}}(this)})},n.generate_job_id=function(){var e,t,n;return e=new Date,n=e.getTime().toString(),t=Math.floor(1e6*Math.random()).toString().lpad(6),n+t},n}(v),d=function(e){function t(){return this._watch=__bind(this._watch,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.data=function(){var e,t;return e=this.next.data(),this.uid=e[Constants.UID_PARAM_NAME],t=this.options().subject_user,!this.uid&&t&&(this.uid=String(t)),e},t.prototype.success=function(e,t,n){return this._is_async_job_response(n)?(this.job_id=n.responseText.split(":")[1],this._interval=1e3,this._failures=0,this._watch_count=0,this._watch_id=setInterval(this._watch,this._interval)):this.next.success(e,t,n)},t.prototype.complete=function(e,t){return this._is_async_job_response(e)?void 0:this.next.complete(e,t)},t.prototype._is_async_job_response=function(e){var t,n;return 0!==(null!=(n=e.responseText)?n.indexOf(N):void 0)?!1:(t=e.responseText.split(":")[1],t.match(/^[A-Za-z0-9_\-=]*$/))},t.prototype._watch=function(){return l.Job.peek(this.job_id)?this._stop():(this._watch_count++,this._watch_count%10===0&&(clearInterval(this._watch_id),this._interval=Math.min(Math.floor(1.5*this._interval),3e4),this._watch_id=setInterval(this._watch,this._interval)),this._show_progress_modal(),this._fetch_progress())},t.prototype._stop=function(){return clearInterval(this._watch_id),l.ModalProgress.hide()},t.prototype._show_progress_modal=function(){return this._modal_shown?void 0:(this._modal_shown=!0,l.ModalProgress.show(this.options().progress_text))},t.prototype._fetch_progress=function(){var e;return e={},this.uid&&(e[Constants.UID_PARAM_NAME]=this.uid),h({url:"/async_task_status/"+this.job_id,data:e,success:function(e){return function(t,n,i){var r,a,u;return u=i.responseText,0===u.indexOf(A)?(l.Job.handled(e.job_id),e._stop(),u=u.substr(A.length),i.responseText=u,e.next.success(u,n,i),e.next.complete(i,n)):0===u.indexOf(O)?(l.Job.handled(e.job_id),e._stop(),r=u.substr(O.length),s.error(r),e.next.error(i,n,r),e.next.complete(i,n)):0===u.indexOf(P)?(l.Job.handled(e.job_id),e._stop(),a=u.substr(P.length),s.error(new o(a)),e.next.complete(i,n)):l.ModalProgress.update(u)}}(this),error:function(e){return function(t,n,i){return e._failures++,e._failures<3?void 0:(e._stop(),e.next.error(t,n,i),e.next.complete(t,n))}}(this)})},t}(v),_=[F,g,m,M],p=function(e){return null==e&&(e={}),R(e,_)},k=[q],y=[b,C,w,L],T=[d],j=[].concat(k,[B],y,_,T),$=function(e){return null==e&&(e={}),R(e,j)},G=function(e){var t;return null==e&&(e={}),t=a.parse(document.URL).getQuery()[x],t?(e.data||(e.data={}),e.data[x]=t):e.data.oref&&(e.data[x]=e.data.oref),R(e,j)},S=[].concat(k,y,_,T),E=function(e){return null==e&&(e={}),R(e,S)},V=[].concat(k,[B],y,_,[I],T),W=function(e){return null==e&&(e={}),R(e,V)},h=function(e){return null==e&&(e={}),R(e,[].concat(y,_))},D=[F,g,M],U=function(e){return null==e&&(e={}),R(e,[].concat(y,D))},H=function(t){var n,i,o;return null==t&&(t={}),n=new f(t),i=K(n,_),o=e.ajax({url:i.url(),type:"OPTIONS",noDropboxDefaults:!0,data:i.data(),success:function(e,t,n){return i.success(e,t,n)},error:function(e,t,n){return i.error(e,t,n)},complete:function(e,t){return i.complete(e,t)}}),i.request(o)},z={Request:R,AuthenticatedRequest:p,
BackgroundRequest:h,SilentBackgroundRequest:U,WebRequest:$,WebRequestOref:G,FormWebRequest:E,WebProgressRequest:W,ValidationSchemaRequest:H}}),define("modules/clean/analytics",["jquery","external/underscore","modules/clean/viewer","modules/clean/ajax","modules/clean/gandalf_util"],function(e,t,n,i,o){var r,s,a,l,u,c,_,d,p,h,f,m,g,v,y,b,w,C,S,E,T;return T=function(e){var t,i,o;return o=new n(Constants._viewer_properties),t=e?[e]:function(){var e,t,n,r;for(n=o.get_users(),r=[],e=0,t=n.length;t>e;e++)i=n[e],r.push(i.id);return r}()},r={log:function(e,t){var n,o,r,s,a;for(r=0,s=0,a=e.length;a>s;s++)n=e[s],n.dir&&r++;return o=e.length-r,i.AuthenticatedRequest({url:"/browse_actions_context_menu_logger",data:{file_count:o,folder_count:r,action:t}})}},a={log:function(e){return i.AuthenticatedRequest({url:"/log/file_view",data:{viewing_user_ids:JSON.stringify(T(e.user_id)),context:e.context,platform:e.platform,ns_id:e.ns_id,sjid:e.sjid,ns_path:e.ns_path,shared_link_url:e.shared_link_url||null,extra:JSON.stringify(e.extra)}})}},l={log:function(e,t,n,o,r,s){return null==s&&(s={}),i.AuthenticatedRequest({url:"/linkfile_activity_log",data:{event_name:e,file_ext:t,link_domain:n,success:o,source:r,extra:JSON.stringify(s)}})}},c={log:function(e,t){return null==t&&(t={}),i.AuthenticatedRequest({url:"/preview_activity_log",data:{event_name:e,input_method:t.input_method,file_ext:t.file_ext,extra:t.extra}})}},_={log:function(e,t,n,o,r,s,a){return i.AuthenticatedRequest({url:"/preview_quality_popup_logger",subject_user:t,data:{event_name:e,file_nsid:n,file_sjid:o,extension:r,doc_preview_status:s,feedback_text:a}})}},d={log:function(e,t,n){return null==n&&(n={}),i.AuthenticatedRequest({url:"/searchclientlogger",subject_user:t,data:{event_name:e,action_type:n.action_type,displayed:n.displayed,failure_type:n.failure_type,file_nsid:n.file_nsid,file_sjid:n.file_sjid,firefly:n.firefly,infinite_scroll:n.infinite_scroll,latency:n.latency,match_type:n.match_type,path_scoped:n.path_scoped,position:n.position,query_string:n.query_string,request_id:n.request_id,result_count:n.result_count,search_type:n.search_type,viewport:n.viewport}})}},p={flow_id:null,log:function(e,t,n,o,r){var s;return null==n&&(n=null),null==o&&(o={}),null==r&&(r=!1),(r||null===this.flow_id)&&(s=new Date,this.flow_id=s.getTime().toString()+Math.random().toString(),this.flow_id=this.flow_id.replace(".","")),i.AuthenticatedRequest({url:"/sflogger",data:{platform:e,event_name:t,extra:JSON.stringify(o),active_uid:null!=n?n.id:null,flow_id:this.flow_id}})}},h={log:function(e,t,n){return new i.AuthenticatedRequest({url:"/shmuilog",data:{evt:e,origin:t,target_item:n}})},log_with_target_file:function(e,t,n){return this.log(e,t,this.get_target_item(n))},get_target_item:function(e){return e.dir?e.is_shared_folder()?"folder-is-sf":e.could_be_shared_folder()?"folder-can-sf":"folder-no-sf":"file"}},g={log:function(e,t,n){return i.AuthenticatedRequest({url:"/studentpromologger",data:{event_name:e,extra:JSON.stringify(t)},success:n?n:void 0,error:n?n:void 0})}},y={log:function(e,t,n,o){var r;return null==o&&(o=null),r=T(o),i.AuthenticatedRequest({url:"/teamswalogger",data:{event_name:e,extra:JSON.stringify(t),for_uids:JSON.stringify(r)},success:n?n:void 0,error:n?n:void 0})}},b={log:function(e,t,n,o){var r;return null==o&&(o=null),n=n||{},r=T(o),i.AuthenticatedRequest({url:"/ualogger",data:{platform:e,event_name:t,extra:JSON.stringify(n),for_uids:JSON.stringify(r)}})}},w={log:function(e,t,n,o){return i.AuthenticatedRequest({url:"/virallogger",data:{user_ids:JSON.stringify(e),viral_type:t,action:n,extra:JSON.stringify(o||{})}})}},f={log:function(e,t){return i.AuthenticatedRequest({url:"/simplesharinglogger",data:{active_uid:e,simple_sharing_action:t}})}},S={log:function(e,t,n){var o;return null==n&&(n=null),o=T(n),i.AuthenticatedRequest({url:"/misclogger",data:{event_name:e,extra:JSON.stringify(t),for_uids:JSON.stringify(o)}})}},v={_log:function(e,t){return null==t&&(t={}),i.AuthenticatedRequest({url:"/support_experiments_log",data:{event_name:e,extra:JSON.stringify(t)}})},log_file_restore:function(e){return this._log("file_restore",{ref:e})}},s=s=function(){function e(){this.buffer=[]}return e.prototype.add_record=function(e){return e.deleted=!1,this.buffer.push(e)},e.prototype.flag_record_as_removed=function(e){var t,n,i,o;for(o=this.buffer,n=0,i=o.length;i>n;n++)if(t=o[n],t.contact_id===e&&!t.deleted)return void(t.deleted=!0)},e.prototype.log_records=function(e,t){return i.AuthenticatedRequest({url:"/contact_search_log",subject_user:e,data:{events:JSON.stringify(this.buffer),canceled:t}}),this.buffer=[]},e}(),C={VIEW:"view",SOCIAL_SHARE_VIEW:"social_share_view",SOCIAL_SHARE_FACEBOOK:"social_share_facebook",SOCIAL_SHARE_TWITTER:"social_share_twitter",SOCIAL_SHARE_GET_LINK:"social_share_get_link",SOCIAL_SHARE_SELECT_INLINE_LINK:"social_share_select_inline_link",LIKES_EXPERIMENT_VIEW:"likes_experiment_view",LIKES_EXPERIMENT_LOADED:"likes_experiment_loaded",LIKES_EXPERIMENT_MOUSED_OVER_LIKE:"likes_experiment_moused_over_like",LIKES_EXPERIMENT_CLICKED_LIKE:"likes_experiment_clicked_like",LIKES_EXPERIMENT_COMPLETED_LIKE:"likes_experiment_completed_like",LIKES_EXPERIMENT_CLICKED_UNLIKE:"likes_experiment_clicked_unlike",LIKES_EXPERIMENT_MOUSED_OVER_OTHERS:"likes_experiment_moused_over_others",log:function(e,t,n){var o;return null==n&&(n=null),o=T(n),i.AuthenticatedRequest({url:"/web_lightbox_log",data:{event_name:e,extra:JSON.stringify(t),for_uids:JSON.stringify(o)}})}},u={DEFAULT_SHOW_IMPORT_CLICK:"default_show_import_click",DEFAULT_SHOW_IMPORT_SHOW:"default_show_import_show",DEFAULT_SHOW_IMPORT_LINK_DISMISS:"default_show_import_dismiss",LINK_PROFILE_MODAL_SHOW:"link_profile_modal_show",LINK_PROFILE_MODAL_DISMISS:"link_profile_modal_dismiss",LINK_PROFILE_MODAL_LINK_ERROR:"link_profile_modal_link_error",LINK_PROFILE_MODAL_LINK_PROFILE:"link_profile_modal_link_profile",LINK_PROFILE_MODAL_LINK_SUCCESS:"link_profile_modal_link_success",LINK_PROFILE_MODAL_NOT_NOW:"link_profile_modal_not_now",log:function(e,t,n){return null==n&&(n={}),i.AuthenticatedRequest({url:"/people_experiments/log_event",subject_user:t,data:{event_name:e,extra:JSON.stringify(n)}})}},m=o.getGandalfRule("sprite-usage-log")?{buffer:[],_maybe_send_log:t.throttle(function(){return i.AuthenticatedRequest({url:"/sprite_usage_log",type:"POST",data:{data:JSON.stringify(m.buffer)}}),m.buffer=[]},3e3,{leading:!1}),log:function(e,t){return this.buffer.push([e,t]),this._maybe_send_log()}}:{log:function(){}},E={BrowseActionsContextMenuLogger:r,ContactSearchLogger:s,FileViewLogger:a,LinkfileActivityLogger:l,PeopleExperimentsLogger:u,PreviewQualityPopupLogger:_,PreviewActivityLogger:c,SearchClientActivityLogger:d,SharedFolderActivityLogger:p,ShmodelUILogger:h,SupportExperimentsWebLogger:v,StudentPromoWebActionsLogger:g,TeamsWebActionsLogger:y,UserActivityLogger:b,ViralLogger:w,SimpleSharingLogger:f,SpriteLogger:m,WebLightboxLogger:C,WebMiscActivityLogger:S},INLINE_JS.TeamsWebActionsLogger=y,INLINE_JS.ShmodelUILogger=h,E}),define("modules/clean/annotations/annotation",["external/underscore"],function(){var e,t,n;return n={MARKER:0,HIGHLIGHT:1,REGION:2},t={MARKER:{CIRCLE:0},REGION:{RECTANGLE:0},HIGHLIGHT:{HIGHLIGHT:0}},e=function(){function e(e,t,n){null==e&&(e=null),null==t&&(t=null),null==n&&(n=null),this.type=e,this.subtype=t,this.pdf_coordinates=[],this.text_highlight=null,this.viewportCoordinates=[],this.BUBBLE_WIDTH=320,this.annotationSize=n}return e.createAnnotationFromDict=function(t){var n,i,o;return n=new e,n.revision=t.revision,n.zoom=t.zoom,n.type=t.type,n.subtype=t.subtype,n.pdf_coordinates=null!=(i=t.pdf_coordinates)?i:[],n.text_highlight=t.text_highlight,n.viewportCoordinates=null!=(o=t.viewportCoordinates)?o:[],n.annotationSize=28,n},e.prototype.toMetadataDict=function(){var e;return e={type:this.type,subtype:this.subtype,pdf_coordinates:this.pdf_coordinates},this.type===n.HIGHLIGHT&&(e.text_highlight=this.text_highlight),e},e.getCenterPosition=function(e){return{x:(e.left+e.right)/2,y:(e.top+e.bottom)/2}},e.prototype.getBoundingBox=function(){var e;switch(this.type){case n.MARKER:return e=this.getFirstViewportCoordinates(),{top:e.y-this.annotationSize/2,right:e.x+this.annotationSize/2,bottom:e.y+this.annotationSize/2,left:e.x-this.annotationSize/2};case n.HIGHLIGHT:return this._getViewportBoundingRectangle();case n.REGION:return this._getViewportBoundingRectangle()}},e.prototype.getClampedBoundingBox=function(e,t){var n;return n=this.getBoundingBox(),n.top=Math.min(Math.max(n.top,0),t),n.right=Math.min(Math.max(n.right,0),e),n.bottom=Math.min(Math.max(n.bottom,0),t),n.left=Math.min(Math.max(n.left,0),e),n},e.prototype._getViewportBoundingRectangle=function(){var e,t,n,i,o,r,s,a,l,u,c;for(o=n=this.getFirstViewportCoordinates().x,r=i=this.getFirstViewportCoordinates().y,c=this.viewportCoordinates,s=0,l=c.length;l>s;s++)for(e=c[s],a=0,u=e.length;u>a;a++)t=e[a],o=Math.min(o,t.x),n=Math.max(n,t.x),r=Math.min(r,t.y),i=Math.max(i,t.y);return{top:r,right:n,bottom:i,left:o}},e.prototype.getFirstViewportCoordinates=function(){return this.viewportCoordinates[0][0]},e.prototype.getFirstPdfCoordinates=function(){var e;return this.isOldCoordinatesFormat()?this.pdf_coordinates:null!=(e=this.pdf_coordinates[0].coordinates)?e[0]:void 0},e.prototype.getFirstPdfPage=function(){return this.isOldCoordinatesFormat()?this.pdf_coordinates.page:this.pdf_coordinates[0].page},e.prototype.isOldCoordinatesFormat=function(){return!(null!=this.pdf_coordinates&&null!=this.pdf_coordinates[0])},e.prototype.getSize=function(){return this.type===n.MARKER?this.annotationSize:null},e}(),{Annotation:e,AnnotationTypes:n,AnnotationSubtypes:t}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/avatar/components",["jquery","external/react","modules/clean/avatar/size","modules/clean/avatar/style","modules/clean/react/image","modules/clean/static_urls","modules/core/exception","modules/core/uri"],function(e,t,n,i,o,r,s,a){var l,u,c,_,d,p,h,f,m,g,v,y,b,w;return f=n.VALID_AVATAR_DIMENSIONS,b=i.hsl_color_value_for_avatar_name,w=r.static_url,g=t.DOM,v=function(e,t){var n;return null==t&&(t="CIRCLE"),s.assert(__indexOf.call(f,e)>=0,"`dimension` must be one of: ["+f+"]"),s.assert("CIRCLE"===t||"SQUARE"===t,"`shape` must be one of ['CIRCLE', 'SQUARE']"),n="SQUARE"===t?function(){switch(!1){case!(32>e):return"2px";case 32!==e:return"3px";default:return"4px"}}():"50%",{width:e,height:e,fontSize:""+Math.ceil(.4*e)+"px",fontWeight:function(){switch(!1){case!(32>e):return 700;case!(48>e):return 600;default:return 400}}(),borderRadius:n}},y=function(e){return null==e&&(e=[]),e.push("avatar-component"),t.addons.classSet.apply(this,e)},d=t.createClass({displayName:"OverflowCountPill",propTypes:{dimension:t.PropTypes.oneOf(f).isRequired,count:t.PropTypes.number.isRequired,onClick:t.PropTypes.func},render:function(){return g.div({className:y(["overflow-pill"]),onClick:this.props.onClick,style:this.getStyle()},"+"+this.props.count)},getStyle:function(){var e,t,n;return n=v(this.props.dimension),delete n.width,delete n.borderRadius,t=""+this.props.dimension+"px",n.minWidth=n.lineHeight=t,e=""+this.props.dimension/2+"px",n.borderRadius=n.WebkitBorderRadius=n.MozBorderRadius=e,n.padding="0 "+Math.ceil(.15*this.props.dimension)+"px",n}}),u=t.createClass({displayName:"Faceholder",propTypes:{dimension:t.PropTypes.oneOf(f).isRequired,onClick:t.PropTypes.func},statics:{SRC_MAP:{16:w("/static/images/avatar/faceholder-16-vflzvFMED.png"),24:w("/static/images/avatar/faceholder-24-vflpqFBTK.png"),32:w("/static/images/avatar/faceholder-32-vflKWtuU5.png"),48:w("/static/images/avatar/faceholder-48-vfll8Voom.png"),64:w("/static/images/avatar/faceholder-64-vflHTEplh.png")},SRC_HI_RES_MAP:{16:w("/static/images/avatar/faceholder-16@2x-vflBZ7FgU.png"),24:w("/static/images/avatar/faceholder-24@2x-vflVegRLu.png"),32:w("/static/images/avatar/faceholder-32@2x-vflYmh947.png"),48:w("/static/images/avatar/faceholder-48@2x-vflUglZDR.png"),64:w("/static/images/avatar/faceholder-64@2x-vfl8eFSM8.png")}},render:function(){return g.div({className:y(["circle"]),onClick:this.props.onClick,style:v(this.props.dimension,"CIRCLE")},o({src:u.SRC_MAP[this.props.dimension],srcHiRes:u.SRC_HI_RES_MAP[this.props.dimension]}))}}),h=t.createClass({displayName:"SharedLinkAvatar",propTypes:{dimension:t.PropTypes.oneOf(f).isRequired,onClick:t.PropTypes.func},render:function(){return g.div({className:y(["circle","shared-link"]),onClick:this.props.onClick,style:v(this.props.dimension)})}}),c=t.createClass({displayName:"InitialsAvatar",propTypes:{dimension:t.PropTypes.oneOf(f).isRequired,initials:t.PropTypes.string.isRequired,shape:t.PropTypes.oneOf(["CIRCLE","SQUARE"]).isRequired,color:t.PropTypes.string,onClick:t.PropTypes.func,optionalClass:t.PropTypes.string},render:function(){var e;return e=["initials",this.props.shape.toLowerCase()],null!=this.props.optionalClass&&e.push(this.props.optionalClass),g.div({className:y(e),onClick:this.props.onClick,style:this.getContainerStyle()},this.props.initials)},getContainerStyle:function(){var e;return e=v(this.props.dimension,this.props.shape),e.lineHeight=""+(this.props.dimension-4)+"px",this.props.color&&(e.color=this.props.color,e.borderColor=this.props.color),e}}),_=t.createClass({displayName:"InitialsAvatarWithColorDerivedFromName",propTypes:{name:t.PropTypes.string.isRequired},render:function(){var t;return t=e.extend({color:b(this.props.name)},this.props),delete t.name,new c(t)}}),p=t.createClass({displayName:"PhotoAvatar",propTypes:{dimension:t.PropTypes.oneOf(f).isRequired,photoUrl:t.PropTypes.string.isRequired,onClick:t.PropTypes.func,optionalClass:t.PropTypes.string},render:function(){var e;return e=["photo","circle"],null!=this.props.optionalClass&&e.push(this.props.optionalClass),g.div({className:y(e),onClick:this.props.onClick,style:v(this.props.dimension,"CIRCLE")},g.img({src:this.props.photoUrl,width:this.props.dimension,height:this.props.dimension}))}}),l=t.createClass({displayName:"AvatarWithDefault",propTypes:{dimension:t.PropTypes.oneOf(f).isRequired,defaultAvatar:t.PropTypes.element.isRequired,onPhotoClick:t.PropTypes.func,photoUrl:t.PropTypes.string,optionalClass:t.PropTypes.string},render:function(){return null!=this.props.photoUrl?new p({dimension:this.props.dimension,onClick:this.props.onPhotoClick,photoUrl:this.props.photoUrl,optionalClass:this.props.optionalClass}):this.props.defaultAvatar}}),m=t.createClass({displayName:"ViewerAvatar",propTypes:{dimension:t.PropTypes.oneOf(f).isRequired,defaultAvatar:t.PropTypes.element.isRequired,onPhotoClick:t.PropTypes.func,photoUrl:t.PropTypes.string,optionalClass:t.PropTypes.string},getInitialState:function(){return{photoUrl:this.props.photoUrl}},componentDidMount:function(){return e(document).on("db:account_photo:photo_set",function(e){return function(t,n){var i,o,r;return i=2*e.props.dimension,r=""+i+"x"+i,o=a.parse(n.saved_photo_url).updateQuery({size:r}).toString(),e.setState({photoUrl:o})}}(this)),e(document).on("db:account_photo:photo_deleted",function(e){return function(){return e.setState({photoUrl:null})}}(this))},render:function(){return null!=this.state.photoUrl?new p({dimension:this.props.dimension,onClick:this.props.onPhotoClick,photoUrl:this.state.photoUrl,optionalClass:this.props.optionalClass}):this.props.defaultAvatar}}),{AvatarWithDefault:l,InitialsAvatar:c,InitialsAvatarWithColorDerivedFromName:_,OverflowCountPill:d,PhotoAvatar:p,ViewerAvatar:m,Faceholder:u,SharedLinkAvatar:h}}),define("modules/clean/avatar/list",["external/react","modules/clean/avatar/components","modules/clean/avatar/size","modules/core/i18n"],function(e,t,n,i){var o,r,s,a,l;return r=t.OverflowCountPill,s=n.VALID_AVATAR_DIMENSIONS,l=i._,a=e.DOM,o=e.createClass({propTypes:{avatars:e.PropTypes.array.isRequired,avatarDimension:e.PropTypes.oneOf(s).isRequired,maxVisible:e.PropTypes.number.isRequired,undisplayableCount:e.PropTypes.number.isRequired,onOverflowCountClick:e.PropTypes.func,animation:e.PropTypes.bool},render:function(){var e,t,n;return e=this.props.avatars,t=this.props.maxVisible,n=0,this.props.undisplayableCount&&(n+=this.props.undisplayableCount),(this.props.undisplayableCount||e.length>t)&&(t--,n+=e.length-t,e=e.slice(0,t)),n&&e.push(new r({count:n,dimension:this.props.avatarDimension,key:"overflow_pill:"+n,onClick:this.props.onOverflowCountClick})),a.div({className:this.getClassName()},e)},getClassName:function(){return e.addons.classSet({"horizontal-avatar-list":!0,animation:this.props.animation})}})}),define("modules/clean/avatar/size",[],function(){var e,t,n;return e={XSMALL:16,SMALL:24,MEDIUM:32,LARGE:48,XLARGE:64},t=function(){var t;t=[];for(n in e)t.push(e[n]);return t}(),{AVATAR_DIMENSION_BY_SIZE:e,VALID_AVATAR_DIMENSIONS:t}}),define("modules/clean/avatar/style",[],function(){var e;return e=function(e){var t,n;for(t=5381*e.length,n=0;n<e.length;)t=e.charCodeAt(n)+((t<<6)+(t<<16)-t),n++;return t=Math.abs(t),"hsl("+t%360+", 60%, 53%)"},{hsl_color_value_for_avatar_name:e}}),define("modules/clean/base64",[],function(){var e,t,n,i,o;return o=function(e){var t,n,i,o,r,s,a,l,u;if(null===e||"undefined"==typeof e)return"";for(a=e+"",u="",s=void 0,o=void 0,l=0,s=o=0,l=a.length,r=0;l>r;){if(t=a.charCodeAt(r),i=null,128>t)o++;else if(t>127&&2048>t)i=String.fromCharCode(t>>6|192,63&t|128);else if(t&!0)i=String.fromCharCode(t>>12|224,t>>6&63|128,63&t|128);else{if(t&!0)throw new RangeError("Unmatched trail surrogate at "+r);if(n=a.charCodeAt(++r),n&!0)throw new RangeError("Unmatched lead surrogate at "+(r-1));t=((1023&t)<<10)+(1023&n)+65536,i=String.fromCharCode(t>>18|240,t>>12&63|128,t>>6&63|128,63&t|128)}null!==i&&(o>s&&(u+=a.slice(s,o)),u+=i,s=o=r+1),r++}return o>s&&(u+=a.slice(s,l)),u},i=function(e){var t,n,i,o,r,s;for(s=[],r=0,t=0,n=0,i=0,o=0,e+="";r<e.length;)n=e.charCodeAt(r),128>n?(s[t++]=String.fromCharCode(n),r++):n>191&&224>n?(i=e.charCodeAt(r+1),s[t++]=String.fromCharCode((31&n)<<6|63&i),r+=2):(i=e.charCodeAt(r+1),o=e.charCodeAt(r+2),s[t++]=String.fromCharCode((15&n)<<12|(63&i)<<6|63&o),r+=3);return s.join("")},t=function(e){var t,n,i,o,r,s,a,l,u,c,_,d,p,h;if(n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=void 0,_=void 0,d=void 0,r=void 0,s=void 0,a=void 0,l=void 0,i=void 0,u=0,t=0,o="",h=[],!e)return e;for(;;)if(c=e.charCodeAt(u++),_=e.charCodeAt(u++),d=e.charCodeAt(u++),i=c<<16|_<<8|d,r=i>>18&63,s=i>>12&63,a=i>>6&63,l=63&i,h[t++]=n.charAt(r)+n.charAt(s)+n.charAt(a)+n.charAt(l),!(u<e.length))break;return o=h.join(""),p=e.length%3,(p?o.slice(0,p-3):o)+"===".slice(p||3)},e=function(e,t){var n,o,r,s,a,l,u,c,_,d,p,h,f,m,g;if(p=function(e){return e},a=t?p:i,"function"==typeof window.atob)return a(window.atob(e));if(o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=0,n=0,g=[],!e)return e;for(e+="";;)if(l=o.indexOf(e.charAt(d++)),u=o.indexOf(e.charAt(d++)),c=o.indexOf(e.charAt(d++)),_=o.indexOf(e.charAt(d++)),r=l<<18|u<<12|c<<6|_,h=r>>16&255,f=r>>8&255,m=255&r,g[n++]=64===c?String.fromCharCode(h):64===_?String.fromCharCode(h,f):String.fromCharCode(h,f,m),!(d<e.length))break;return s=g.join(""),s=a(s)},n={encode:t,decode:e}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/bolt",["jquery","external/underscore","modules/clean/base64","modules/core/exception","modules/core/uri"],function(e,t,n,i){var o,r,s,a,l;return o=1e3,r=3e5,a=function(){function e(e,t){this.app_id=e,this.unique_id=t}return e}(),l=function(){function e(e,t,n,i){this.app_id=e,this.unique_id=t,this.revision=n,this.token=i}return e}(),s=function(){function s(e,t,n){this._update_callback=t,this._refresh_callback=n,this._handle_poll_error=__bind(this._handle_poll_error,this),this._handle_poll_success=__bind(this._handle_poll_success,this),this._long_poll=__bind(this._long_poll,this),this._signed_channel_states=[],this._started=!1,this._backoff_window=o,this.update_states(e)}return s.prototype._encode_channel_state=function(e){return{channel_id:{app_id:n.encode(e.app_id),unique_id:n.encode(e.unique_id)},revision:e.revision,token:e.token}},s.prototype._decode_channel_state=function(e){return new l(n.decode(e.channel_id.app_id),n.decode(e.channel_id.unique_id),e.revision,e.token)},s.prototype._decode_channel_id=function(e){return new a(n.decode(e.app_id),n.decode(e.unique_id))},s.prototype._compare_revisions=function(e,t){var n,i,o;return n=Math.max(e.length,t.length),i=Array(n-e.length+1).join("0")+e,o=Array(n-t.length+1).join("0")+t,o>i?-1:i>o?1:0},s.prototype.update_states=function(e){var n,i,o,r,s;for(s=[],o=0,r=e.length;r>o;o++)i=e[o],i=this._encode_channel_state(i),n=t.find(this._signed_channel_states,function(e){return t.isEqual(i.channel_id,e.channel_id)}),null==n?s.push(this._signed_channel_states.push(i)):this._compare_revisions(i.revision,n.revision)>0?(n.revision=i.revision,s.push(n.token=i.token)):s.push(void 0);return s},s.prototype.start=function(){return this._started?void 0:(this._started=!0,this._long_poll())},s.prototype.unsubscribe=function(){return this._started=!1,null!=this._long_poll_xhr?this._long_poll_xhr.abort():void 0},s.prototype._long_poll=function(){return this._long_poll_xhr=e.ajax({url:"/notify/subscribe",type:"POST",noDropboxDefaults:!0,data:JSON.stringify({channel_states:this._signed_channel_states}),contentType:"application/json; charset=utf-8",dataType:"json",timeout:12e4,success:this._handle_poll_success,error:this._handle_poll_error})},s.prototype._handle_poll_success=function(e){var n,r,s,a,l,u,c,_,d,p,h;if(this._long_poll_xhr=null,this._started){if((null!=(d=e.channel_states)?d.length:void 0)>0){for(u=[],p=e.channel_states,c=0,_=p.length;_>c;c++)a=p[c],s=t.find(this._signed_channel_states,function(e){return t.isEqual(a.channel_id,e.channel_id)}),null==s?(n="Bolt returned unknown channel id "+a.channel_id,i.assert(!1,n,null,null,!1)):this._compare_revisions(a.revision,s.revision)>0&&(s.revision=a.revision,s.token=a.token,u.push(a));u.length>0&&t.defer(this._update_callback,function(){var e,t,n;for(n=[],e=0,t=u.length;t>e;e++)l=u[e],n.push(this._decode_channel_state(l));return n}.call(this))}return(null!=(h=e.invalid_channels)?h.length:void 0)>0?void t.defer(this._refresh_callback,function(){var t,n,i,o;for(i=e.invalid_channels,o=[],t=0,n=i.length;n>t;t++)r=i[t],o.push(this._decode_channel_id(r));return o}.call(this)):(this._backoff_window=o,t.defer(this._long_poll))}},s.prototype._handle_poll_error=function(){var e;return this._long_poll_xhr=null,this._started?(e=Math.random()*this._backoff_window,this._backoff_window=Math.min(2*this._backoff_window,r),window.setTimeout(this._long_poll,e)):void 0},s}(),{BoltClient:s,ChannelId:a,SignedChannelState:l}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/browse/browse_drag_utils",["jquery"],function(e){var t;return t={_dragEnabledChecks:[],getDraggedLink:function(t){var n,i,o,r,s,a;if(null==t)return null;if(o=__indexOf.call(t.types,"Files")>=0,n=__indexOf.call(t.types,"text/html")>=0&&e(t.getData("text/html")).attr("draggable")||__indexOf.call(t.types,"text/uri-list")>=0&&"about:blank"===t.getData("text/uri-list")||__indexOf.call(t.types,"Url")>=0&&"about:blank"===t.getData("Url"),o||n)return null;a=null;try{r=t.getData("text/x-moz-url")}catch(l){i=l}if(null!=r&&(s=r.split("\n"),s.length>=1&&(a=s[0])),!a)try{a=t.getData("text/uri-list")}catch(l){i=l}if(!a)try{a=t.getData("Url")}catch(l){}return a||(a=null),a},buildUrlLinkfileContents:function(e){return"[InternetShortcut]\r\nURL="+e+"\r\n"},isFileDragEnabled:function(){var e,t,n,i;for(i=this._dragEnabledChecks,t=0,n=i.length;n>t;t++)if(e=i[t],!e())return!1;return!0},addFileDragEnabledCheck:function(e){return this._dragEnabledChecks.push(e)},removeFileDragEnabledCheck:function(e){var t;return t=this._dragEnabledChecks.indexOf(e),t>=0?this._dragEnabledChecks.splice(t,1):void 0},removeAllFileDragEnabledChecks:function(){return this._dragEnabledChecks=[]}}}),define("modules/clean/browse_interface",["modules/clean/viewer","modules/constants/env","modules/constants/viewer","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o){var r,s,a,l,u,c,_;return u=t.WEBSERVER,l=n.ROLE_PERSONAL,_=i._,s="/home",c="/work",a="/personal",r={HOME_ROOT:s,WORK_ROOT:c,PERSONAL_ROOT:a,get_browse_root:function(t){return e.get_viewer().is_paired?t.role===l?a:c:s},get_browse_root_name:function(t){return e.get_viewer().is_paired?e.get_root_name(t):_("Files")},get_all_browse_roots:function(){return e.get_viewer().get_users().map(function(e){return{name:r.get_browse_root_name(e),path:r.get_browse_root(e)}})},browse_uri_for_fq_path:function(e,t){return o({scheme:"https",authority:u,path:""+r.get_browse_root(e)+t})}}}),define("modules/clean/business/modal_helper",["jquery"],function(e){var t;return t=function(){function t(){}return t.centerModal=function(t){var n,i,o;return o=t.width(),n=t.height(),i=n<e(window).height()?{position:"fixed",top:"50%","margin-top":-n/2,left:"50%","margin-left":-o/2}:{position:"absolute",top:e(document).scrollTop()+20,left:"50%","margin-left":-o/2},t.css(i)},t}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/captcha",["jquery","external/react","modules/clean/ajax","modules/clean/react/recaptcha_challenge","modules/core/notify"],function(e,t,n,i,o){var r;return r=function(){function r(e,t,n,i,o,r){var s;this.parent_form=e,this.captcha_div=t,this.other_recaptcha_div=n,this.endpoint=i,this.email_name=o,this.variant=r,this.captcha_display_handler=__bind(this.captcha_display_handler,this),this._hide_other_captcha=__bind(this._hide_other_captcha,this),this._hide_captcha=__bind(this._hide_captcha,this),this._show_captcha=__bind(this._show_captcha,this),this.$recaptcha_container=null!=(s=this.parent_form.find(this.captcha_div))?s[0]:void 0,this.$recaptcha_react_component=null}return r.prototype._show_captcha=function(e,n){var o,r;return null==(null!=(r=this.$recaptcha_container)?r.children:void 0)&&(this.$recaptcha_react_component=null),null==this.$recaptcha_react_component?(o=i({public_key:e,variant:this.variant}),this.$recaptcha_react_component=t.render(o,this.$recaptcha_container)):this.$recaptcha_react_component.reload(n)},r.prototype._hide_captcha=function(){var e;return null==(null!=(e=this.$recaptcha_container)?e.children:void 0)&&(this.$recaptcha_react_component=null),null!=this.$recaptcha_react_component?(t.unmountComponentAtNode(this.$recaptcha_container),this.$recaptcha_react_component=null):void 0},r.prototype._hide_other_captcha=function(){var n;return n=e(this.other_recaptcha_div)[0],null!=(null!=n?n.children:void 0)?t.unmountComponentAtNode(n):void 0},r.prototype.captcha_display_handler=function(e,t){return n.WebRequest({url:this.endpoint,data:{email:this.parent_form.find("input[name='"+this.email_name+"']").val()},success:function(n){return function(i){var r;try{return r=JSON.parse(i),r.needs_captcha?(n._hide_other_captcha(),n._show_captcha(r.recaptcha_public_key,null!=t?t.recaptcha_response:void 0)):n._hide_captcha()}catch(s){return e=s,o.error(o.DEFAULT_ERROR)}}}(this)})},r}()}),define("modules/clean/clipboard",["jquery","modules/clean/static_urls","modules/core/dom","external/swfobject"],function(e,t,n){var i,o,r,s,a,l;return l=t.static_url,r=function(){var e,t;return e=(new Date).getTime(),t=Math.floor(1e6*Math.random()).toString().lpad(6),"swf_"+e+"_"+t},s=function(e,t){return e.on("mouseover",function(){return t.addClass("hovered")}),e.on("mousedown",function(){return t.addClass("pressed")}),e.on("mouseout",function(){return t.removeClass("hovered pressed")}),e.on("mouseup",function(){return t.removeClass("pressed")})},a=function(e,t){return window.ClipboardSWFRegister=window.ClipboardSWFRegister||{},window.ClipboardSWFRegister[e]=function(){return t()},"ClipboardSWFRegister."+e},i=function(t,i,o,u){var c,_,d;return null==o&&(o=null),null==u&&(u=null),u=u||e(document.body),d=r(),c=e("<div />",{id:"flash_copy_container"}).append(e("<div />",{id:d})).css({position:"absolute",zIndex:1}),s(c,i),u.append(c),n.clone_position(c,i,{}),_=a(d,o),window.copyLoaded=function(){return function(){var n;return n=e("#"+d)[0],n.setCopyText(t),n.setCallbackFunction(_)}}(this),window.swfobject.embedSWF(l("/static/swf/copy_clipboard-vflvMcZTC.swf"),d,"100%","100%","6.0.65",!1,!1,{wmode:"transparent",scale:"exactfit",allowScriptAccess:"always"}),c},o={clipboard_overlay:i}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/components/ajax_form",["jquery","modules/core/dom","modules/core/exception","modules/core/html","modules/core/notify","modules/clean/ajax","modules/clean/validators/validators"],function(e,t,n,i,o,r,s){var a,l;return l=n.assert,a=function(){function n(e,n,i){this.$container=e,this.do_before_submitting=n,this._clear_pending=__bind(this._clear_pending,this),this._clear_errors=__bind(this._clear_errors,this),this._handle_errors=__bind(this._handle_errors,this),this._on_error=__bind(this._on_error,this),this._on_success=__bind(this._on_success,this),this._submit_form=__bind(this._submit_form,this),this._install_schema=__bind(this._install_schema,this),i=i||{},this.$form="FORM"===this.$container.prop("tagName")?this.$container:this.$container.find("form"),this.$form.submit(this._submit_form),this.$submit_button=this.$form.find("[type='submit']"),t.set_controller(this.$form,this),this.schema={},this.should_validate=i.client_side_validation,this.should_submit_once=i.should_submit_once,this.should_validate&&this._fetch_schema()}return n.SUCCESS_EVENT="db:ajaxform:success",n.ERROR_EVENT="db:ajaxform:error",n.extract_errors=function(e){var t,n;if(0!==e.indexOf("err:"))return!1;e=e.substr(4);try{return t=JSON.parse(e)}catch(i){return n=i,"string"==typeof e?e:o.DEFAULT_ERROR}},n.clear_errors=function(e){return e.find(".input-error").removeClass("input-error"),e.find(".error-message").remove()},n.fill_errors=function(t,n){var i,o,r,s;t.find(".c-card").removeClass("show"),s=[];for(o in n)r=n[o],i=e("<span>",{"class":"error-message"}),r.message_html?i.html(r.message_html):i.text(r.message_text),i.insertBefore(t.find("[data-error-field-name='"+o+"']")),t.find("input[name='"+o+"'], input[data-encrypted-name='"+o+"']").addClass("input-error"),s.push("exp-failed-login-invalid-email-password"===o?t.find(".c-card").addClass("show"):void 0);return s},n.prototype._install_schema=function(t){var n,i;try{n=JSON.parse(t)}catch(o){i=o}return e.each(n,function(e){return function(t,n){return n?e.schema[t]=s.create(n):void 0}}(this))},n.prototype._fetch_schema=function(){return r.ValidationSchemaRequest({url:this.$form.attr("action"),success:function(e){return function(t){return e._install_schema(t)}}(this)})},n.prototype.reset=function(){var t,n,i,o,r;for(o=this.$form.find("input"),r=[],n=0,i=o.length;i>n;n++)t=o[n],r.push(e(t).closest(".text-input").val(t.defaultValue));return r},n.prototype.set_input_value=function(e,t){return this.$form.find("input[name='"+e+"']").closest(".text-input").val(t)},n.prototype._get_form_data=function(){var t,n,i,o,r,s,a,u;for(t={},u=this.$form.find("input, select, textarea").not(":disabled"),s=0,a=u.length;a>s;s++)n=u[s],o=e(n).attr("name"),o&&(i=e(n).attr("type"),r="checkbox"===i?e(n).prop("checked")?"True":"":e(n).val(),"radio"!==i&&l(!(o in t),"found multiple inputs with the same name"),t[o]=r);return t},n.prototype._validate=function(t){var n,i;return this.should_validate?(n={},i=!0,e.each(t,function(e){return function(o,r){var s;if(e.schema[o])try{return e.schema[o].validate(r,{field:o,data:t,errors:n})}catch(a){return s=a,i=!1,n[o]={message_text:s.message}}}}(this)),i?null:n):null},n.prototype._submit_form=function(e){var t;return e.preventDefault(),"function"==typeof this.do_before_submitting&&this.do_before_submitting(),this._clear_errors(),this.$form.prop("disabled",!0),this.$form.addClass("ajax-loading"),this.$submit_button.prop("disabled",!0),t=this._validate(this._get_form_data()),t?this._handle_errors(t):this.send_request()},n.prototype.send_request=function(){
return r.FormWebRequest({url:this.$form.attr("action"),data:this._get_form_data(),success:this._on_success,error:this._on_error,complete:this._on_complete})},n.prototype._on_success=function(e,t,i){var r,s,a,l;if(a=i.responseText,r=n.extract_errors(a),r!==!1)return void this._handle_errors(r);try{s=JSON.parse(a)}catch(u){return l=u,this.$form.trigger(n.ERROR_EVENT),o.error(),void this._clear_pending(!0)}return this.$form.trigger(n.SUCCESS_EVENT,s),this._clear_pending(!this.should_submit_once)},n.prototype._on_error=function(){return o.error(),this._clear_pending(!0)},n.prototype._handle_errors=function(e){return"string"==typeof e?(o.error(new i(e)),void this._clear_pending(!0)):(n.fill_errors(this.$form,e),this._clear_pending(!0),this.$form.trigger(n.ERROR_EVENT,e))},n.prototype._clear_errors=function(){return this.$form.find(".error-message").remove(),this.$form.find("input").removeClass("input-error")},n.prototype._clear_pending=function(e){return this.$form.removeClass("ajax-loading"),e?(this.$form.prop("disabled",!1),this.$submit_button.prop("disabled",!1)):void 0},n}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/components/bubble_dropdown",["jquery","external/jquery_ui"],function(e){var t;return t=function(){function t(n,i,o,r){this.$root=n,this.arrow_direction=i,this.top_adjustment=null!=r?r:0,this._hide_bubble=__bind(this._hide_bubble,this),this._show_bubble=__bind(this._show_bubble,this),this._toggle_bubble=__bind(this._toggle_bubble,this),this._on_global_hover=__bind(this._on_global_hover,this),this._on_mouseout=__bind(this._on_mouseout,this),this._on_mouseover=__bind(this._on_mouseover,this),this.repositionDropdown=__bind(this.repositionDropdown,this),this.openDropdown=__bind(this.openDropdown,this),this.closeDropdown=__bind(this.closeDropdown,this),this.$target=this.$root.find(".bubble-dropdown-target"),this.$dropdown=this.$root.find(".bubble-dropdown"),this.$arrow_anchor=this.$root.find(".bubble-dropdown-arrow-anchor"),this.$arrow=this.$dropdown.find(".bubble-arrow"),this.target_position={top:"bottom",left:"right",bottom:"top",right:"left"}[this.arrow_direction],o?(this.$target.on("mouseover",this._on_mouseover),this.$dropdown.on("mouseover",this._on_mouseover),this.$target.on("mouseout",this._on_mouseout),this.$dropdown.on("mouseout",this._on_mouseout),e(document).on(t.HOVER_SHOWN,this._on_global_hover)):(this.$target.click(this._toggle_bubble),e("body").on("click",function(t){return function(n){var i;return e(n.target).is("select")?!0:(i=e(n.target).closest(t.$target).length||e(n.target).closest(t.$dropdown).length,i||t._hide_bubble(),!0)}}(this)))}return t.HOVER_SHOWN="bubble:hover:shown",t.prototype._dropdown_shown=!1,t.prototype.closeDropdown=function(){return this._dropdown_shown?this._hide_bubble():void 0},t.prototype.openDropdown=function(){return this._dropdown_shown?void 0:this._show_bubble()},t.prototype.repositionDropdown=function(){return this._dropdown_shown?this._show_bubble():void 0},t.prototype._on_mouseover=function(){return e(document).trigger(t.HOVER_SHOWN,this.$target),this._show_bubble(),clearTimeout(this.$dropdown.data("timeout_id"))},t.prototype._on_mouseout=function(){var e;return e=setTimeout(this._hide_bubble,200),this.$dropdown.data("timeout_id",e)},t.prototype._on_global_hover=function(e,t){return this._dropdown_shown&&t!==this.$target?(this._hide_bubble(),clearTimeout(this.$dropdown.data("timeout_id"))):void 0},t.prototype._toggle_bubble=function(){return this._dropdown_shown?this._hide_bubble():this._show_bubble(),!0},t.prototype._show_bubble=function(){var e,t,n,i,o,r;if(!this.$target.hasClass("disabled")){switch("right"===this.arrow_direction?this.$dropdown.css("display","block"):this.$dropdown.css("display","inline-block"),r=this.$arrow.outerWidth(),t=this.$arrow.outerHeight()-this.top_adjustment,o=this.$arrow.position().top,n=this.$arrow.position().left,this.arrow_direction){case"left":e="left+"+r+"px top-"+o+"px";break;case"right":e="right-"+r+"px top-"+o+"px";break;case"top":e="left-"+n+"px top+"+t+"px";break;case"bottom":e="left-"+n+"px bottom-"+t+"px"}return i={my:e,at:this.target_position,of:this.$arrow_anchor.length?this.$arrow_anchor:this.$target,collision:"none"},this.$dropdown.position(i),this.$dropdown.position(i),this._dropdown_shown=!0}},t.prototype._hide_bubble=function(){return this.$dropdown.hide(),this._dropdown_shown=!1},t}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/components/bubble_picker",["jquery"],function(e){var t;return t=function(){function t(e){this.$bubble_picker=e,this.enable_option=__bind(this.enable_option,this),this.disable_option=__bind(this.disable_option,this),this.show_dropdown=__bind(this.show_dropdown,this),this.hide_dropdown=__bind(this.hide_dropdown,this),this.set_value=__bind(this.set_value,this),this._listen=__bind(this._listen,this),this.$label_wrapper=this.$bubble_picker.find(".bubble-picker-label-wrapper"),this.$label=this.$bubble_picker.find(".bubble-picker-label"),this.$dropdown=this.$bubble_picker.find(".bubble-picker-dropdown"),this._dropdown_shown=!1,this._listen()}return t.CHANGED="db:bubblepicker:changed",t.prototype._listen=function(){return e(document).click(function(t){return function(n){var i,o;return o=e(n.target).closest(t.$label_wrapper).length>0,i=e(n.target).closest(t.$dropdown).length>0,t._dropdown_shown&&!i?t.hide_dropdown():o?t.show_dropdown():void 0}}(this)),this.$dropdown.find(".bubble-picker-option:not('.disabled')").click(function(n){return function(i){var o,r;return o=e(i.currentTarget),o.hasClass("disabled")?void 0:(r=n.get_value(),n.set_value(o.data("value")),n.$bubble_picker.trigger(t.CHANGED,{clicked_val:o.data("value"),old_val:r}),n.hide_dropdown())}}(this))},t.prototype.get_value=function(){return this.$bubble_picker.attr("data-selected-value")},t.prototype.set_value=function(e){var t;return this.$bubble_picker.attr("data-selected-value",e),this.$label.empty(),t=this.$bubble_picker.find("[data-value='"+e+"']"),this.$label.html(t.clone().html())},t.prototype.hide_dropdown=function(){return this.$dropdown.hide(),this._dropdown_shown=!1},t.prototype.show_dropdown=function(){return this.$dropdown.show(),this._dropdown_shown=!0},t.prototype.disable_option=function(t,n){var i,o;return o=this.$bubble_picker.find(".bubble-picker-option[data-value="+t+"]:not('.disabled')"),o.length>0&&(i=e(o.find(".role-option")),i.attr("saved-title",i.attr("title")),i.attr("title",n)),o.addClass("disabled")},t.prototype.enable_option=function(t){var n,i;return i=this.$bubble_picker.find(".bubble-picker-option.disabled[data-value="+t+"]"),n=e(i.find(".role-option")),n.attr("saved-title")&&(n.attr("title",n.attr("saved-title")),n.removeAttr("saved-title")),i.removeClass("disabled")},t}()}),define("modules/clean/components/expanding_section",["jquery","modules/clean/analytics"],function(e,t){var n;return n=function(){function n(t,n,i,o,r){this.$parent=e("#"+t),n&&(this.$scrollElement=e(""+n)),this.scrollElementOffset=i||0,this.expandingSectionAnalyticsId=o,this.defaultOffset=95,this.toggledState=!1,this.$toggleButton=r?e(r):this.$parent.find(".expanding-section__button"),this.closeButton=this.$parent.find(".expanding-section__button-close"),this._setupClickHandlers()}return n.prototype._setupClickHandlers=function(){var e,t;return e=function(e){return function(t){return t.preventDefault(),e._scrollToSection(),e._expandSection(),e.expandingSectionAnalyticsId&&e._logAnalyticsTracking(),!0}}(this),t=function(e){return function(t){return t.preventDefault(),e._expandSection(),!0}}(this),this.$toggleButton.on("click",e),this.closeButton.length>0&&this.closeButton.on("click",t),!0},n.prototype._scrollToSection=function(){var t;return t=this.$parent.offset().top-this.scrollElementOffset-this.defaultOffset,this.$scrollElement&&(t=this.$parent.find(this.$scrollElement).offset().top-this.scrollElementOffset+"px"),this.toggledState||e("html, body").animate({scrollTop:t}),t},n.prototype._expandSection=function(){var e;return e=0,this.toggledState?(e=0,this.toggledState=!1):(e=this.$parent.find(".expanding-section__content-container").outerHeight(!0),this.toggledState=!0),this.$parent.find(".expanding-section__content").css("max-height",e),this.$toggleButton.blur().toggleClass("button-toggled"),this},n.prototype._logAnalyticsTracking=function(){t.TeamsWebActionsLogger.log(this.expandingSectionAnalyticsId)},n}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/components/input",["jquery","modules/clean/components/tabbable","modules/core/i18n","modules/core/exception"],function(e,t,n,i){var o,r,s,a,l,u;return l=n._,a=i.assert,u=function(t){var n;return n=e.data(t,"input-element"),a(n.length,"TextInput element has no related input element please ensure it was setup correctly"),n},e.valHooks.textinput={get:function(e){return u(e).val()},set:function(e,t){return u(e).val(t).trigger("input")}},s=function(t){function n(t){var i,o;this.$text_input=t,this._on_change=__bind(this._on_change,this),this.persistent_label=this.$text_input.is(".label-above"),this.$input=this.$text_input.find(".text-input-input"),this.$text_input.data("input-element",this.$input),this.$label=this.$text_input.find("label"),this.$text_input.find(".error-message").length&&this.$input.addClass("input-error"),this.$text_input.each(function(e,t){return t.type="textinput"}),this.$text_input.focus(function(e){return function(){return setTimeout(function(){return e.$input.focus()},0)}}(this)),i="BODY"===(null!=(o=document.activeElement)?o.tagName:void 0),i&&e(".autofocus:visible").first().focus(),this._listen(),this._on_change(),n.__super__.constructor.call(this)}return __extends(n,t),n.prototype._listen=function(){return this.$input.on("keydown keyup paste input blur",function(e){return function(){return e._on_change()}}(this)),this.$input.on("blur",function(e){return function(t){return e.$text_input.trigger(t)}}(this)),this.$input.on("focus",function(e){return function(){return e.$input.removeClass("input-error")}}(this))},n.prototype._on_change=function(){return this.persistent_label?void 0:this.$label.toggle(!this.$input.val())},n}(t),o=function(e){function t(e){this.$text_input=e,this.$caps=this.$text_input.find(".password-caps-indicator"),this.$caps_lock=!1,this.$text_input.on("keypress",function(e){return function(t){var n,i,o,r,s;return r=/Mac/.test(navigator.platform),i=null!=(s=t.charCode)?s:t.keyCode,n=String.fromCharCode(i),n.toLowerCase()===n.toUpperCase()?o=void 0:n===n.toLowerCase()?o=t.shiftKey:n!==n.toUpperCase()||t.shiftKey&&r||(o=!t.shiftKey),null!=o&&(e.$caps_lock=o),e.$caps_lock?e.$caps.addClass("password-caps-indicator-activated"):e.$caps.removeClass("password-caps-indicator-activated")}}(this)),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t}(s),r=function(t){function n(e){this.$text_input=e,this._on_change=__bind(this._on_change,this),this.$bubble_title=this.$text_input.find(".password-bubble-title"),this.$bubble_desc=this.$text_input.find(".password-bubble-desc"),this.$meter=this.$text_input.find(".password-input-meter"),this.$default_bubble_text=this.$bubble_desc.text(),this.$last_pwd="",require(["external/zxcvbn"]),n.__super__.constructor.call(this,this.$text_input)}return __extends(n,t),n.prototype._on_change=function(){var e,t,i,o,r;return t=this.$input.val(),this.$last_pwd!==t?(this.$last_pwd=t,"correcthorsebatterystaple"===t||"Tr0ub4dour&3"===t||"Tr0ub4dor&3"===t?(i=0,o=l("lol",{comment:"'lol'='laugh out loud'"}),this.$bubble_title.text(o),"correcthorsebatterystaple"===t?(e=l("Whoa there, don't take advice from a webcomic too literally ;)",{comment:"This text is displayed rarely, whenever a user selects a password that is from this comic: http://imgs.xkcd.com/comics/password_strength.png"}),this.$bubble_desc.text(e)):(e=l("Guess again",{comment:"this text is displayed rarely, whenever a user selects a password that is from this comic: http://imgs.xkcd.com/comics/password_strength.png"}),this.$bubble_desc.text(e))):(r=["",l("Weak"),l("So-so"),l("Good"),l("Great!")],i=this._score(t),o=r[i],this.$bubble_title.text(o),this.$bubble_desc.text(this.$default_bubble_text)),this.$meter.find(".password-input-dot").removeClass("password-input-dot-selected"),this.$meter.find(".password-input-dot").slice(4-i,4).addClass("password-input-dot-selected"),n.__super__._on_change.apply(this,arguments)):void 0},n.prototype._get_user_inputs=function(){var t,n,i,o,r;for(n=["dropbox"],r=this.$text_input.closest("form").find("input[type=text], input[type=email]"),i=0,o=r.length;o>i;i++)t=r[i],n.push(e(t).val());return n},n.prototype._score=function(e){return window.zxcvbn&&e?Math.max(1,zxcvbn(e,this._get_user_inputs()).score):0},n}(o),{TextInput:s,PasswordInput:o,PasswordWatchInput:r}}),define("modules/clean/components/loading_indicator",["external/underscore","external/react","modules/core/i18n"],function(e,t,n){var i,o,r,s,a;return a=n._,s=t.DOM,r=t.addons.classSet,o={DOTS:"dots",SPINNER:"spinner",BLUE_SPINNER:"blue_spinner"},i=t.createClass({displayName:"LoadingIndicator",statics:{LoadingIndicatorStyle:o},propTypes:{style:t.PropTypes.oneOf(e.values(o))},getDefaultProps:function(){return{style:o.DOTS}},render:function(){var e;return e={"c-loader":!0,"c-loader--spinner":this.props.style===o.SPINNER,"c-loader--spinner--blue":this.props.style===o.BLUE_SPINNER},s.div({className:r(e)},a("Loadingâ¦"))}})});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/components/locale_selector",["jquery","modules/core/cookies","modules/clean/business/modal_helper"],function(e,t,n){var i;return i=function(){function i(t,n){var i;null==n&&(n=!1),this._localeSelected=__bind(this._localeSelected,this),this._keydownHandler=__bind(this._keydownHandler,this),this._hideModal=__bind(this._hideModal,this),this._showModal=__bind(this._showModal,this),this._showInline=__bind(this._showInline,this),this.$document=e(document),this.$container=e(t),i=this.$container.find("#locale-link"),this.is_inline=n,this.is_inline?(this.$locale_table=this.$container.find(".locale-selector__table"),i.on("click",this._showInline),this.$locale_links=this.$locale_table.find(".locale-option"),this.$locale_links.one("click",this._localeSelected)):(this.$modal_holder=this.$container.find("#db-modal-locale-selector-modal"),this.$db_modal_x=this.$modal_holder.find(".db-modal-x"),this.$db_modal_overlay=this.$modal_holder.find(".db-modal-overlay"),this.$modal=this.$modal_holder.find(".db-modal"),i.on("click",this._showModal),this.$locale_links=this.$modal.find(".locale-option"))}return i.prototype._showInline=function(e){return e.preventDefault(),this.$locale_table.show(),this.$container.find(".locale-link__link").addClass("active")},i.prototype._showModal=function(e){return e.preventDefault(),this.$db_modal_x.one("click",this._hideModal),this.$db_modal_overlay.one("click",this._hideModal),this.$document.one("keydown",this._keydownHandler),this.$modal_holder.show(),n.centerModal(this.$modal),this.$locale_links.one("click",this._localeSelected)},i.prototype._hideModal=function(e){return e.preventDefault(),this.$modal_holder.hide()},i.prototype._keydownHandler=function(e){return 27===e.keyCode?this._hideModal(e):void 0},i.prototype._localeSelected=function(n){return this.is_inline||this._hideModal(n),e("<form/>",{action:"/set_locale",method:"POST"}).append(this._hiddenField("locale",e(n.target).data("locale"))).append(this._hiddenField("locale_cont",window.location.pathname)).append(this._hiddenField("t",t.read(Constants.JS_CSRF_COOKIE))).appendTo("body").submit(),!1},i.prototype._hiddenField=function(t,n){return e("<input/>",{type:"hidden",name:t,value:n})},i}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/components/login_form",["jquery","modules/constants/env","modules/core/browser","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/ajax","modules/clean/captcha","modules/clean/components/ajax_form","modules/clean/cyberfend","modules/clean/gandalf_util","modules/clean/profile_services/profile_services_constants","modules/clean/sso_login_checks","modules/clean/unity/features/web_destiny_ui"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h){var f,m;return m=o._,f=function(){function o(t,i,o){var r;this.multi_login=i,this.variant=o,this._finish_login=__bind(this._finish_login,this),this._fill_two_factor_error=__bind(this._fill_two_factor_error,this),this._fill_login_error=__bind(this._fill_login_error,this),this._sign_u2f_challenge=__bind(this._sign_u2f_challenge,this),this._retry_u2f_challenge=__bind(this._retry_u2f_challenge,this),this._use_phone_instead=__bind(this._use_phone_instead,this),this._resend_code=__bind(this._resend_code,this),this._resend_code_success=__bind(this._resend_code_success,this),this._switch_from_twofactor_to_login_error=__bind(this._switch_from_twofactor_to_login_error,this),this._two_factor_success=__bind(this._two_factor_success,this),this._login_success=__bind(this._login_success,this),this._show_two_factor=__bind(this._show_two_factor,this),this._setup_two_factor=__bind(this._setup_two_factor,this),this._show_login=__bind(this._show_login,this),this._hide_sso=__bind(this._hide_sso,this),this._show_sso=__bind(this._show_sso,this),this._set_focus_to_twofactor=__bind(this._set_focus_to_twofactor,this),this._set_focus_to_password=__bind(this._set_focus_to_password,this),this.$login_form=t.find(".login-form"),this.$all_two_factor_forms=t.find(".two-factor-form"),this.$two_factor_phone_form=t.find(".two-factor-form.2fa-phone-form"),this.$two_factor_seckey_form=t.find(".two-factor-form.2fa-seckey-form"),this.$two_factor_form=this.$two_factor_phone_form,this.web_destiny_interface=new h(t),this.web_destiny_interface.maybe_show_web_destiny(),this.login_controller=new u(this.$login_form,this._cyberfend_submit,{should_submit_once:!0}),this.$captcha_component=new l(this.$login_form,"#react-login-recaptcha-challenge-div","#react-signup-recaptcha-challenge-div","/needs_captcha","login_email",this.variant),this.$login_form.on(u.SUCCESS_EVENT,this._login_success),this.$login_form.on(u.ERROR_EVENT,this.$captcha_component.captcha_display_handler),this.$login_form.is(":visible")&&this.$captcha_component.captcha_display_handler(),this.cont=this.$login_form.find("input[name='cont']").val(),this.two_factor_phone_controller=new u(this.$two_factor_phone_form,function(){return null},{should_submit_once:!0}),this.two_factor_seckey_controller=new u(this.$two_factor_seckey_form,function(){return null},{should_submit_once:!0}),this.two_factor_controller=this.two_factor_phone_controller,this.$two_factor_phone_form.on(u.SUCCESS_EVENT,this._two_factor_success),this.$two_factor_seckey_form.on(u.SUCCESS_EVENT,this._two_factor_success),this.$two_factor_seckey_form.on(u.ERROR_EVENT,function(e){return function(t,n){return e.$two_factor_seckey_form.find(".two-factor-seckey-instructions .error-msg").text(n.u2f.message_text),e.$two_factor_seckey_form.find(".two-factor-seckey-instructions").toggle()}}(this)),this.$two_factor_phone_form.find(".resend-two-factor-code").click(this._resend_code),this.$two_factor_seckey_form.find(".two-factor-use-phone-instead").click(this._use_phone_instead),this.$two_factor_seckey_form.find(".two-factor-seckey-retry").click(this._retry_u2f_challenge),r=this.$two_factor_seckey_form.find("input[name='u2f_challenge']").val(),r&&this._sign_u2f_challenge(r),this.$login_form.find(".sso-optout a").click(function(e){return function(){return e._hide_sso(!0)}}(this)),this.$login_form.find(".login-button").attr("disabled",!1),this.$forgot_link=t.find(".login-need-help a").click(function(t){return function(i){var o,r;return i.preventDefault(),r=e(i.target).attr("href"),o=encodeURIComponent(t.$login_form.find("input[name='login_email']").val()),n.redirect(""+r+"?email_from_login="+o)}}(this)),this._set_focus_to_password(),new p(this.$login_form.find("input[name='login_email']"),this._show_sso,this._hide_sso)}return o.LOGIN_SUCCESS="db:login:success",o.MULTI_LOGIN_SUCCESS="db:multilogin:success",o.prototype._set_focus_to_password=function(){if(this.$login_form.find("input[name='login_email']")[0].value)try{return this.$login_form.find("input[name='login_password']")[0].focus()}catch(e){}},o.prototype._set_focus_to_twofactor=function(){try{return this.$two_factor_form.find("input[name='code']").val("").focus()}catch(e){}},o.prototype._cyberfend_submit=function(){return c.submit(".login-form","login_sd")},o.prototype._show_sso=function(e){return this.$login_form.find("input[name='login_password']").val(""),this.$login_form.addClass("sso-required"),e?this.$login_form.addClass("sso-optional"):void 0},o.prototype._hide_sso=function(e){if(null==e&&(e=!1),this.$login_form.removeClass("sso-required sso-optional"),e)try{return this.$login_form.find("input[name='login_password']").focus()}catch(t){}},o.prototype._browser_supports_u2f=function(){return"undefined"!=typeof MessageChannel},o.prototype._show_login=function(){return this.$two_factor_form.hide(),e(".login-register-header, .login-register-switch").show(),this.$login_form.show(),this.$login_form.find("input[name='login_password']").val("")},o.prototype._setup_two_factor=function(e){return e.u2f_challenge&&this._browser_supports_u2f()&&(this.$two_factor_form=this.$two_factor_seckey_form,this.two_factor_controller=this.two_factor_seckey_controller,this._sign_u2f_challenge(e.u2f_challenge)),e.last_four_digits?(this.$all_two_factor_forms.addClass("hide-authenticator"),this.$two_factor_phone_form.find(".last-four-digits").text(e.last_four_digits)):this.$all_two_factor_forms.addClass("hide-sms"),this.$two_factor_form.find("input[name='remember_me']").val(e.remember_me),this._show_two_factor()},o.prototype._show_two_factor=function(){return e(".login-register-header, .login-register-switch").hide(),this.$login_form.hide(),this.$two_factor_form.show(),this._set_focus_to_twofactor()},o.prototype._login_success=function(e,t){var o;switch(t.status){case"OK":return this._finish_login(t);case"TWOFACTOR":return this._setup_two_factor(t);case"TWOFACTOR_REQUIRED":return n.redirect(t.cont);case"SSO":return n.unsafeRedirect(t.sso_url);case"RATELIMIT":return this._fill_login_error(m("You've tried to log in too many times. Please try again in a few minutes."));case"ERROR":return o=t.html_response?new i(t.message):t.message,r.error(o),this.login_controller._clear_pending(!0);case"EXPIRED":return n.redirect(t.cont);default:return r.error()}},o.prototype._two_factor_success=function(e,t){switch(t.status){case"OK":return this.$two_factor_seckey_form.find(".seckey-loading-status").toggle(),this._finish_login(t);case"EXPIRED":return this._switch_from_twofactor_to_login_error(t.message);case"REQUIRES_ROLE":return this._switch_from_twofactor_to_login_error(t.message);case"ERROR":return r.error(t.message);default:return r.error()}},o.prototype._switch_from_twofactor_to_login_error=function(e){return this.two_factor_controller._clear_pending(!0),this.login_controller._clear_pending(!0),this._show_login(),this._fill_login_error(e),this._set_focus_to_password()},o.prototype._resend_code_success=function(e){switch(e){case"OK":return r.success(m("We sent you a code. It may take a few minutes to arrive."));case"RATELIMIT":return this._fill_two_factor_error(m("You've tried to log in too many times. Please try again in a few minutes."));case"UNREACHABLE":return this._fill_two_factor_error(m("We couldn't reach your phone number. Are you sure it's correct?"));case"EXPIRED":return this._fill_two_factor_error(m("Sorry, your phone code has expired. Please log in again."));case"BADCARRIER":return this._fill_two_factor_error(m("Unfortunately, your carrier is not supported at this time."));case"INVALIDNUMBER":return this._fill_two_factor_error(m("That is not a valid phone number."));case"NOTAMOBILE":return this._fill_two_factor_error(m("That phone number does not appear to be a valid mobile number."));default:return r.error()}},o.prototype._resend_code=function(){return a.WebRequest({url:"/twofactor_resend",success:this._resend_code_success,error:function(){return r.error()}}),!1},o.prototype._use_phone_instead=function(){return this.$two_factor_seckey_form.hide(),this.$two_factor_phone_form.show(),this.$two_factor_form=this.$two_factor_phone_form,this.$two_factor_phone_form.hasClass("hide-authenticator")&&this._resend_code(),this._set_focus_to_twofactor(),!1},o.prototype._retry_u2f_challenge=function(){return a.WebRequest({url:"/account/twofactor/u2f_start_authentication",success:function(e){return function(t){return e.$two_factor_seckey_form.find(".two-factor-seckey-instructions").toggle(),e._sign_u2f_challenge(t)}}(this),error:function(){return r.error()}}),!1},o.prototype._sign_u2f_challenge=function(e){var t;if(this._browser_supports_u2f())return t=JSON.parse(e),u2f.sign(t.authenticateRequests,function(e){return function(t){return e.$two_factor_seckey_form.find(".text-input-input").val(JSON.stringify(t)),e.$two_factor_seckey_form.submit()}}(this))},o.prototype._fill_login_error=function(e){return u.fill_errors(this.$login_form,{login_email:{message_text:e}})},o.prototype._fill_two_factor_error=function(e){return u.fill_errors(this.$two_factor_form,{code:{message_text:e}})},o.prototype._finish_login=function(e){var i,r,l,u;return l=this.$login_form.find("input[type='hidden'][name=refresh_token]").val(),i=this.$login_form.find("input[type='hidden'][name=email_sig]").val(),l&&i&&a.WebRequest({url:"/profile_services/link_google_service_with_user",subject_user:e.id,data:{service:d.GOOGLE,refresh_token:l,email_sig:i}}),r=this.multi_login?o.MULTI_LOGIN_SUCCESS:o.LOGIN_SUCCESS,this.$login_form.trigger(r,e),this.cont?(u=s.parse(this.cont),u.getAuthority()===t.NOTES_WEBSERVER?(u.setQuery({success:!0}),n.unsafeRedirect(u)):n.redirect(this.cont)):void 0},o}(),__CONDITIONAL_JS__.LoginForm=f,f}),define("modules/clean/components/login_or_register",["jquery","modules/clean/register_form"],function(e,t){var n;return n=function(){function n(n){this.$login_form=n.find(".login-register-login-part"),this.$register_form=n.find(".login-register-register-part"),n.click(function(t){return function(n){return e(n.target).hasClass("login-register-switch-link")?(n.preventDefault(),t._toggle_forms(),t.$login_form.find(".text-input input:visible").first().focus(),t.$register_form.find(".text-input input:visible").first().focus()):void 0}}(this)),this.$register_form.on(t.USER_EXISTS,function(e){return function(t){var n,i,o;e._toggle_forms(),o=t.prefill;for(n in o)i=o[n],e.$login_form.find(n).val(i);return e.$login_form.find(t.focus).focus()}}(this))}return n.prototype._toggle_forms=function(){return this.$login_form.toggle(),this.$register_form.toggle()},n}()}),define("modules/clean/components/tabbable",["jquery"],function(e){var t;return t=function(){function t(){t.initialized||this.listen()}return t.initialized=!1,t.prototype.listen=function(){return t.initialized=!0,e(document).on("keydown",function(){return function(t){return 9===t.keyCode?e(document.body).addClass("tabbing"):void 0}}(this)),e(document).on("mousedown",function(){return function(){return e(document.body).removeClass("tabbing")}}(this))},t}()}),define("modules/clean/components/title_bubble",["external/react"],function(e){var t,n;return n=e.DOM,t=e.createClass({propTypes:{text:e.PropTypes.string.isRequired,direction:e.PropTypes.oneOf(["north","south","east","west"]).isRequired},render:function(){return n.div({className:e.addons.classSet("title-bubble-component",this.props.direction),"data-title":this.props.text},e.Children.only(this.props.children))}})});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/components/tooltip",["jquery","modules/core/dom"],function(e,t){var n,i,o;return o=[],n=function(){function e(e,n){var i;this.$wrapper=e,this.prompt=this.$wrapper.find(".tooltip-prompt"),this.tooltip=this.$wrapper.find(".tooltip-tooltip"),this.hover_target=this.find_hover_target(),this.position_global=n,this.listen(),i=t.clone(this.tooltip).appendTo("body"),i.css({position:"static",display:"inline-block"}),this.tooltip.css({width:i.width(),position:"absolute",display:"none"}),i.remove(),this.position_global&&this.tooltip.remove().appendTo("body")}return e.prototype.tooltip_shown=!1,e.prototype.position_global=!1,e.prototype.listen=function(){var e,t,n,i,o;for(i=[this.hover_target,this.tooltip],o=[],t=0,n=i.length;n>t;t++)e=i[t],e.mouseenter(function(e){return function(){return clearTimeout(e.tooltip.data("timeout_id")),e.show_tooltip()}}(this)),o.push(e.mouseleave(function(e){return function(){var t;return t=setTimeout(function(){return e.hide_tooltip()},200),e.tooltip.data("timeout_id",t)}}(this)));return o},e.prototype.find_hover_target=function(){return this.prompt},e.prototype.show_tooltip=function(){var e,t,n,i;if(!this.tooltip_shown){for(e=this.position_global?this.hover_target.offset():this.hover_target.position(),n=0,i=o.length;i>n;n++)t=o[n],t.hide_tooltip();return o.push(this),this.tooltip.css("top",e.top-this.tooltip.outerHeight()/2+this.hover_target.outerHeight()/2),this.tooltip.css("left",e.left+this.hover_target.width()+2),this.tooltip.show(),this.tooltip.animate({left:"+=7"},50),this.tooltip_shown=!0}},e.prototype.hide_tooltip=function(){var e;if(this.tooltip_shown)return clearTimeout(this.tooltip.data("timeout_id")),this.tooltip.hide(),this.tooltip_shown=!1,e=o.indexOf(this),-1!==e?o.splice(e,1):void 0},e}(),i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.find_hover_target=function(){return this.prompt.find(".sprite")},t}(n),{DBTooltip:n,InfoTooltip:i}}),define("modules/clean/contacts/bloodhound_contacts",["jquery","external/typeahead.bundle","modules/clean/contacts/cache","modules/clean/viewer"],function(e,t,n,i){var o,r;return r=n.DefaultContactsCache,o=function(){function t(t){null==t&&(t=10),this.limit=t,this.contacts=new Bloodhound({datumTokenizer:function(e){return[e.name,e.email,e.fname,e.lname].concat(e.name_tokens)},queryTokenizer:function(t){return[e.trim(t)]},limit:this.limit,sorter:this._contacts_sorter,local:[]}),this.contacts.initialize(),this.sortedContacts=[],this.extraContacts=[],i.get_viewer().is_signed_in&&r.load_contacts(!1,!1,function(e){return function(t){return e._init_contacts(t)}}(this))}return t.prototype._contacts_sorter=function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0},t.prototype._init_contacts=function(e){return this._update_contacts(e),r.register_for_updates("bloodhound_contacts",function(e){return function(t){return e._update_contacts(t)}}(this))},t.prototype._update_contacts=function(e){var t,n,i;return this.contacts.clear(),n=e.excludePairedUserDuplicates(),this.contacts.add(n.contacts),i=this._dedupe_extra_contacts(),this.contacts.add(i),t=n.contacts.concat(i),t.sort(function(e){return function(t,n){return e._contacts_sorter(t,n)}}(this)),this.sortedContacts=t.slice(0,this.limit)},t.prototype.setExtraContacts=function(e){return this.extraContacts=e},t.prototype._dedupe_extra_contacts=function(){var e,t,n,i,o,r;for(t=this.contacts.index.datums,i={},n={},o=0,r=t.length;r>o;o++)e=t[o],i[e.email]=!0,n[e.dbx_account_id]=!0;return this.extraContacts.filter(function(e){return!n[e.dbx_account_id]&&!i[e.email]})},t.prototype.get=function(e,t){var n;return n=function(n){return function(){return 0===e.trim().length?t(n.sortedContacts):n.contacts.get(e,function(e){return t(e)})}}(this),r.is_loaded()?n():r.load_contacts(!1,!1,n)},t.prototype.getSortVariant=function(){
return r.sort_variant},t}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/contacts/cache",["jquery","modules/core/exception","modules/clean/ajax","modules/clean/contacts/list","modules/clean/profile_services/profile_services_constants","modules/clean/viewer"],function(e,t,n,i,o,r){var s,a,l;return l=t.assert,s=function(){function t(){this._update_loading_state=__bind(this._update_loading_state,this),this._invoke_callbacks=__bind(this._invoke_callbacks,this),this._invoke_all_callbacks=__bind(this._invoke_all_callbacks,this),this.unregister_for_updates=__bind(this.unregister_for_updates,this),this.register_for_updates=__bind(this.register_for_updates,this),this.loading_state=t.HAVENT_LOADED,this.callbacks={},this.one_time_callbacks=[],this.sort_variant=null,e(document).on("db:profile_service:auth_complete",function(e){return function(){return e.load_contacts(!0)}}(this)),e(document).on("db:profile_service:deauth_complete",function(e){return function(){return e.load_contacts(!0)}}(this))}return t.HAVENT_LOADED=0,t.LOADING_NONE_AVAILABLE=1,t.LOADING_STALE_AVAILABLE=2,t.LOADED=3,t.prototype.is_loaded=function(){return this.loading_state===t.LOADED||this.loading_state===t.LOADING_STALE_AVAILABLE},t.prototype.load_contacts=function(e,o,s){var a;if(r.get_viewer().is_signed_in){if(null!=s&&__indexOf.call(this.one_time_callbacks,s)<0&&this.one_time_callbacks.push(s),e){if(this.loading_state===t.LOADING_STALE_AVAILABLE)return}else{if(this.loading_state===t.LOADING_NONE_AVAILABLE)return;if(this.loading_state!==t.HAVENT_LOADED)return void this._invoke_all_callbacks()}return this._update_loading_state(this.loading_state===t.LOADED?t.LOADING_STALE_AVAILABLE:t.LOADING_NONE_AVAILABLE),a=function(e){return function(t,n){var o;return e._update_loading_state(n),e.sort_variant=t.sort_variant,o=i.create_contacts_list(t.contacts),e.precached_contacts=o.contacts,e.cached_contacts=o,e._invoke_all_callbacks()}}(this),this.loading_state===t.LOADING_NONE_AVAILABLE&&n.BackgroundRequest({url:"/get_cached_contacts",data:{include_rooms:o,version:1},success:function(e){return function(n){var i,o;return e.loading_state===t.LOADING_NONE_AVAILABLE&&(i=JSON.parse(n),null!=(o=i.contacts)?o.length:void 0)?a(i,t.LOADING_STALE_AVAILABLE):void 0}}(this)}),n.BackgroundRequest({url:"/get_refreshed_contacts?long_running=1",data:{include_rooms:o,version:1},success:function(){return function(e){var n;return n=JSON.parse(e),a(n,t.LOADED)}}(this)})}},t.prototype.register_for_updates=function(e,t){return this.callbacks[e]=t},t.prototype.unregister_for_updates=function(e){return __indexOf.call(Object.keys(this.callbacks),e)>=0?delete this.callbacks[e]:void 0},t.prototype._invoke_all_callbacks=function(){return this._invoke_callbacks(this.one_time_callbacks,!0),this._invoke_callbacks(this.callbacks,!1)},t.prototype._invoke_callbacks=function(e,t){var n,i,o,r,s;for(r=Object.keys(e),s=[],i=0,o=r.length;o>i;i++)n=r[i],e[n](this.cached_contacts),s.push(t?delete e[n]:void 0);return s},t.prototype._update_loading_state=function(e){return l(e===t.LOADING_NONE_AVAILABLE||e===t.LOADING_STALE_AVAILABLE||e===t.LOADED),this.loading_state=e},t}(),a=new s,{ContactsCache:s,DefaultContactsCache:a}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/contacts/data",["external/underscore","modules/core/exception","modules/clean/contacts/cache","modules/clean/contacts/types","modules/clean/fuzzy","modules/clean/viewer"],function(e,t,n,i,o,r){var s,a,l,u;return u=t.assert,l=n.DefaultContactsCache,s=function(){function e(e){this.dbx_account_id=e.dbx_account_id,this.type=e.type,this.name=e.name,this.email=e.email,this.fb_id=e.fb_id,this.group_id=e.group_id,this.members=e.members,this.group_avatar=e.group_avatar,this.avatar_url=e.avatar_url,this.invalid=e.invalid,this.on_team=e.on_team,this.nameMatch=e.nameMatch,this.emailMatch=e.emailMatch}return e.prototype.getKey=function(){var e;return this.type===i.FB?"contact-fb-"+this.fb_id:(e=this.type)===i.USER_GROUP||e===i.NEW_STYLE_GROUP?"contact-group-"+this.group_id:this.type===i.CAROUSEL_ROOM?"contact-room-"+this.members:"contact-email-"+this.email},e.prototype.getContactID=function(){switch(this.type){case i.FB:return this.fb_id;case i.USER_GROUP:return this.group_id;case i.NEW_STYLE_GROUP:return this.group_id;case i.CAROUSEL_ROOM:return this.members;default:return this.email}},e}(),a=function(){function t(e){var n;this.user=e.user,this.filterFunc=e.filterFunc,this._setContacts=__bind(this._setContacts,this),u(this.user,"must include user"),null==this.filterFunc&&(this.filterFunc=function(){return!0}),this._filteredContacts=[],this.user.is_team&&(this._teamContacts={}),this.instance=t.INSTANCE++,n="contacts-data-source:"+this.instance,l.register_for_updates(n,this._setContacts),l.load_contacts()}return t.INSTANCE=0,t.prototype.is_loaded=function(){return l.is_loaded()},t.prototype.getSortVariant=function(){return l.sort_variant},t.prototype._setContacts=function(t){var n,i,o,s,a,l;if(this.user.is_team)for(this._teamContacts={},this._teamContacts[r.get_viewer().work_email]=1,i=t.sortByTeamFirst(),l=i.contacts,s=0,a=l.length;a>s;s++)n=l[s],n.team&&(this._teamContacts[n.email]=1);return o=t.includeForUser(this.user.id).contacts,this._filteredContacts=e.filter(o,this.filterFunc)},t.prototype.isTeamEmail=function(e){return this.user.is_team&&null!=this._teamContacts[e]},t.prototype.query=function(t,n){var r,a,l,u,c,_,d,p,h,f;for(l=[],f=this._filteredContacts,u=p=0,h=f.length;h>p;u=++p)d=f[u],a=o.match(t,d.email||""),c=o.match(t,d.name||""),(a||c)&&(_=d.type!==i.FB&&(d.type!==i.EMAIL||this.isTeamEmail(d.email)),l.push({contact:d,emailMatch:a,nameMatch:c,on_team:_,score:Math.max((null!=a?a.score:void 0)||0,(null!=c?c.score:void 0)||0),index:u}));return l.sort(function(e,t){var n;return n=t.score-e.score,n?n:e.index-t.index}),r=e.map(l,function(e){return d=e.contact,d.nameMatch=e.nameMatch,d.emailMatch=e.emailMatch,d.on_team=e.on_team,new s(d)}),n(r)},t}(),{Contact:s,ContactTypes:i,ContactsDataSource:a}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/contacts/facebook_modal",["modules/clean/dbmodal"],function(e){var t,n;return t=e.DBUserModal,n=function(e){function t(e,n,i){this.show_hidden_modal=n,this.link_with_facebook=i,this.on_confirm_button_click=__bind(this.on_confirm_button_click,this),this.on_hide=__bind(this.on_hide,this),t.__super__.constructor.call(this,e,{element_id:"facebook-confirm-modal-user-"+e.id})}return __extends(t,e),t.prototype.on_hide=function(){return"function"==typeof this.show_hidden_modal?this.show_hidden_modal():void 0},t.prototype.on_confirm_button_click=function(){return this.hide(),this.link_with_facebook()},t}(t)}),define("modules/clean/contacts/facebook_oauth",["jquery","modules/core/exception","modules/core/uri","modules/clean/ajax","modules/clean/viewer"],function(e,t,n,i,o){var r,s;return s=t.assert,r={do_auth:function(e,t){var i;return s(null!=t,"user_id must be specified"),i=window.open(n({path:"/fb/access_token"}).updateQuery(Constants.UID_PARAM_NAME,t).toString(),"fb_auth","width=600,height=450"),e?r.onLoginSuccessCallback=e:void 0},post:function(e,t,a,l,u,c,_){return s(null!=_,"user_id must be specified!"),o.get_viewer().is_signed_in?("function"==typeof r.custom_show_posting&&r.custom_show_posting(),new i.WebRequest({url:"/fb/post",data:{message:e,link:t,link_name:a,description:l,from_referrals:r.from_referrals,from_getspace:r.from_getspace,picture:u?u:""},success:function(n,i,o){var s;return s=o.responseText,0===s.indexOf("ok")?"function"==typeof r.custom_show_complete?r.custom_show_complete():void 0:0===s.indexOf("auth")?r.do_auth(function(){return r.post(e,t,a,l,u,c,_)},_):void 0},error:function(){return"function"==typeof c?c():void 0},subject_user:_})):void window.open(n.parse("http://www.facebook.com/sharer.php").setQuery({u:t,t:a}).toString())}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/contacts/list",["jquery","modules/clean/em_string","modules/clean/contacts/types"],function(e,t,n){var i;return i=function(){function e(e){var t;this.contacts=e,this._lowercaseContact=__bind(this._lowercaseContact,this),this._excludeType=__bind(this._excludeType,this),this.sortByTeamFirst=__bind(this.sortByTeamFirst,this),this.excludeSuspended=__bind(this.excludeSuspended,this),this.excludeNonTeamActive=__bind(this.excludeNonTeamActive,this),this.excludeNonTeam=__bind(this.excludeNonTeam,this),this.excludePairedUserDuplicates=__bind(this.excludePairedUserDuplicates,this),this.excludeTeamMembers=__bind(this.excludeTeamMembers,this),this.excludeRooms=__bind(this.excludeRooms,this),this.excludeFacebook=__bind(this.excludeFacebook,this),this.excludeNewStyleGroups=__bind(this.excludeNewStyleGroups,this),this.excludeGroups=__bind(this.excludeGroups,this),this.excludeMe=__bind(this.excludeMe,this),this.excludeByEmail=__bind(this.excludeByEmail,this),this.includeForViewer=__bind(this.includeForViewer,this),this.includeForUser=__bind(this.includeForUser,this),this.slice=__bind(this.slice,this),this.length=__bind(this.length,this),this.filterContacts=__bind(this.filterContacts,this),this.lcontacts=function(){var e,n,i,o;for(i=this.contacts,o=[],e=0,n=i.length;n>e;e++)t=i[e],o.push(this._lowercaseContact(t));return o}.call(this)}return e._format_contact_array=function(e){var n,i,o,r;for(n=22,o=0,r=e.length;r>o;o++)i=e[o],null!=i.email&&(i.email_snippet=t.em_snippet(i.email,n)),null!=i.name&&(i.name=t.em_snippet(i.name,n));return e},e.create_contacts_list=function(t){return t=e._format_contact_array(t),new e(t)},e.prototype.filterContacts=function(t){var n;return n=this.contacts.filter(t),new e(n)},e.prototype.length=function(){return this.contacts.length},e.prototype.slice=function(t,n){return new e(this.contacts.slice(t,n))},e.prototype.includeForUser=function(e){return this.filterContacts(function(t){return t.owning_user_id===e})},e.prototype.includeForViewer=function(e){var t;return t=e.get_user_ids(),this.filterContacts(function(e){var n;return n=e.owning_user_id,__indexOf.call(t,n)>=0})},e.prototype.excludeByEmail=function(e){var t,n;return n=[function(){var n,i,o;for(o=[],n=0,i=e.length;i>n;n++)t=e[n],o.push(t.toLowerCase());return o}()],this.filterContacts(function(){return function(e){var t;return t=e.email.toLowerCase(),!(__indexOf.call(n,t)>=0)}}(this))},e.prototype.excludeMe=function(){return this.filterContacts(function(e){return!e.is_owner})},e.prototype.excludeGroups=function(){return this._excludeType(n.USER_GROUP)},e.prototype.excludeNewStyleGroups=function(){return this._excludeType(n.NEW_STYLE_GROUP)},e.prototype.excludeFacebook=function(){return this._excludeType(n.FB)},e.prototype.excludeRooms=function(){return this._excludeType(n.CAROUSEL_ROOM)},e.prototype.excludeTeamMembers=function(){return this.filterContacts(function(e){return!e.team})},e.prototype.excludePairedUserDuplicates=function(){return this.filterContacts(function(e){return!e.paired_user_duplicate})},e.prototype.excludeNonTeam=function(){return this.filterContacts(function(e){return e.team})},e.prototype.excludeNonTeamActive=function(){return this.filterContacts(function(e){return e.team&&"active"===e.join_state})},e.prototype.excludeSuspended=function(){return this.filterContacts(function(e){return"suspended"!==e.join_state})},e.prototype.sortByTeamFirst=function(){return new e(e.sortContactsByTeamFirst(this.contacts))},e.sortContactsByTeamFirst=function(e){var t,i,o,r,s;for(o=[],i=[],r=0,s=e.length;s>r;r++)t=e[r],t.team||t.type===n.USER_GROUP?o.push(t):i.push(t);return o.concat(i)},e.prototype._excludeType=function(e){return this.filterContacts(function(t){return t.type!==e})},e.prototype._lowercaseContact=function(e){var t,n,i;n={};for(t in e)i=e[t],("string"==typeof i||i instanceof String)&&(i=i.toLowerCase()),n[t]=i;return n},e}()}),define("modules/clean/contacts/tokenizer",["external/react","modules/core/i18n","modules/clean/analytics","modules/clean/contacts/data","modules/clean/contacts/typeahead","modules/clean/contacts/types","modules/clean/react/sprite","modules/clean/tokenizer"],function(e,t,n,i,o,r,s,a){var l,u,c,_,d,p,h,f,m,g,v,y,b;return b=t._,u=n.ContactSearchLogger,l=i.Contact,d=i.ContactsDataSource,f=o.ContactsTypeaheadSelector,m=a.Tokenizer,g=e.DOM,c={invalid:"invalid",warn:"warn",pending:"pending",ok:"ok"},p=e.createClass({propTypes:{customClass:e.PropTypes.string,contact:e.PropTypes.object.isRequired,hoverMsg:e.PropTypes.string,onRemove:e.PropTypes.func,tokenState:e.PropTypes.oneOf(function(){var e;e=[];for(v in c)y=c[v],e.push(y);return e}()).isRequired},render:function(){var t,n;return n={"tokenizer-token":!0,"contact-token":!0,invalid:this.props.tokenState===c.invalid,warned:this.props.tokenState===c.warn,pending:this.props.tokenState===c.pending},n[this.props.customClass]=null!=this.props.customClass,t=e.addons.classSet(n),this.transferPropsTo(g.a({className:t,"data-title":this.props.hoverMsg,tabIndex:-1},this._renderInput(),this._renderIcon(),this._renderText(),this._makeCloseButton()))},_getTokenName:function(){switch(this.props.contact.type){case r.FB:return"fb_ids";case r.EMAIL:return"emails";case r.USER_GROUP:return"group_ids";case r.NEW_STYLE_GROUP:return"new_style_group_ids";case r.CAROUSEL_ROOM:return"carousel_rooms";default:return"invalids"}},_getTokenValue:function(){switch(this.props.contact.type){case r.FB:return this.props.contact.fb_id;case r.USER_GROUP:return this.props.contact.group_id;case r.NEW_STYLE_GROUP:return this.props.contact.group_id;case r.CAROUSEL_ROOM:return this.props.contact.members;default:return this.props.contact.email}},_renderIcon:function(){switch(this.props.contact.type){case r.FB:return g.img({src:"/static/images/icons/fb_16-vflbiYTkC.png"});case r.EMAIL:return g.img({src:"/static/images/icons/email_16-vflcFyDTl.png"});case r.USER_GROUP:return s({group:"groups",name:"group"});case r.NEW_STYLE_GROUP:return s({group:"groups",name:"group"});case r.CAROUSEL_ROOM:return g.img({src:"/static/images/carousel/icon-57px-vfluuaZ5j.png"});default:return""}},_renderInput:function(){return g.input({type:"hidden",name:this._getTokenName(),value:this._getTokenValue()})},_renderText:function(){return this.props.contact.name||this.props.contact.email},_makeCloseButton:function(){return this.props.onRemove?g.span({className:"tokenizer-token-close",onClick:function(e){return function(){return e.props.onRemove(e.props.contact),!1}}(this),dangerouslySetInnerHTML:{__html:"&nbsp;"}}):""}}),_={basic:function(e){var t;return t=!1,{state:e.invalid?c.invalid:c.ok,msg:t?e.email:null}},warn:function(e){return{state:e.on_team?c.ok:e.invalid?c.invalid:c.warn,msg:null}},forbid:function(e){return{state:e.on_team?c.ok:c.invalid,msg:null}}},h=e.createClass({displayName:"ContactsTokenizer",propTypes:{user:e.PropTypes.object.isRequired,context:e.PropTypes.string,customClass:e.PropTypes.string,customContactFilter:e.PropTypes.func,customContactValidator:e.PropTypes.func,onContentsChange:e.PropTypes.func,placeholder:e.PropTypes.string,populatedInputData:e.PropTypes.shape({tokens:e.PropTypes.array,value:e.PropTypes.string}),tabIndex:e.PropTypes.number,showContactImport:e.PropTypes.bool,shouldLogContactSearch:e.PropTypes.bool,tokenSpacing:e.PropTypes.number},getDefaultProps:function(){return{customContactFilter:function(){return!0},customContactValidator:_.basic,placeholder:b("Invite more people"),populatedInputData:{tokens:[],value:""},tokenSpacing:3,showContactImport:!1,shouldLogContactSearch:!1}},componentWillReceiveProps:function(e){(e.user!==this.props.user||e.customContactFilter!==this.props.customContactFilter)&&(this.contactsDataSource=new d({user:e.user,filterFunc:e.customContactFilter}))},componentWillMount:function(){this.contactsDataSource=new d({user:this.props.user,filterFunc:this.props.customContactFilter})},componentDidMount:function(){return this.props.shouldLogContactSearch?this.contact_search_logger=new u:void 0},finishLogging:function(e){return this.props.shouldLogContactSearch?this.contact_search_logger.log_records(this.props.user.id,e):void 0},_logTokenChangeEvent:function(e,t,n){var i,o;if(null==t&&(t=!1),null==n&&(n={}),this.props.shouldLogContactSearch){if(t)return this.contact_search_logger.flag_record_as_removed(e.getContactID());i="react_tokenizer",null!=this.props.context&&(i+="_"+this.props.context),o={context:i,contact_type:e.type,contact_id:e.getContactID(),contact_name:e.name,sort_variant:this.refs.tokenizer.props.dataSource.getSortVariant()};for(v in n)y=n[v],o[v]=y;return this.contact_search_logger.add_record(o)}},addExternalContacts:function(e){return this.refs.tokenizer.addExternalTokens(e)},render:function(){return new m({ref:"tokenizer",dataSource:this.contactsDataSource,customClass:this.props.customClass,initialInputText:this.props.populatedInputData.value,placeholderText:this.props.placeholder,renderSelector:function(e){return function(){return f({showContactImport:e.props.showContactImport,user:e.props.user})}}(this),renderInput:function(){return g.textarea({className:"contacts-tokenizer-input",rows:1})},renderToken:this._renderToken,onContentsChange:this.props.onContentsChange,stringTokenizer:this.tokenizeEmails,populatedTokenData:this.props.populatedInputData.tokens,tabIndex:this.props.tabIndex,tokenSpacing:this.props.tokenSpacing,logTokenChangeEvent:this._logTokenChangeEvent},this.props.children)},_renderToken:function(e){var t;return t=this.props.customContactValidator(e),new p({contact:e,tokenState:t.state,hoverMsg:t.msg})},tokenizeEmails:function(e,t){var n,i,o,s,a,u,c,_,d,p,h;for(null==t&&(t=!1),n=/[,|;\n]+/,i=/[,|;\n ]+/,o=/^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,15}$/i,a=e.split(i),c=2===a.length&&o.test(a[0])&&""===a[1]?a:e.split(n),d="",t||(d=c.pop()),_=[],p=0,h=c.length;h>p;p++)u=c[p],s=u.trim(),""!==s&&_.push(new l({name:s,email:s,type:r.EMAIL,invalid:!o.test(s),on_team:this.refs.tokenizer.props.dataSource.isTeamEmail(s)}));return{tokens:_,value:d}},serializeInputData:function(){return this.refs.tokenizer.serializeInputData()},getContacts:function(){var e,t,n,i;return i=this.serializeInputData(),t=i.tokens,n=i.value,e=this.tokenizeEmails(n,!0),t.concat(e.tokens)},tokenizeAll:function(){return this.refs.tokenizer.tokenizeAll()}}),{ContactsTokenizer:h,ContactTokenValidator:_,ContactTokenState:c}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/contacts/typeahead",["jquery","external/react","external/underscore","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/analytics","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/contacts/types","modules/clean/react/sprite","modules/clean/typeahead"],function(e,t,n,i,o,r,s,a,l,u,c,_){var d,p,h,f,m,g,v,y,b,w,C,S,E,T,k,x;return E=i.assert,x=o._,b=s.SharedFolderActivityLogger,v=l.LinkedProfileServices,y=l.ProfileServicesLinkingHandler,S=_.TypeaheadSelectorMixin,T=t.DOM,k=function(t,n){return e.extend({},t,n)},p=k(S,{getOptions:function(){var e,t,n,i;return null==this.props.queryOptions?[]:this.state.importsExpanded?function(){var e,t,i,o;for(i=a.contact_services(),o=[],e=0,t=i.length;t>e;e++)n=i[e],o.push(new w({provider:n,connected:this.profile_services.service_is_connected(n)}));return o}.call(this):(e=this.props.maxVisible||this.props.queryOptions.length,t=this.props.queryOptions.slice(0,e),(null!=(i=this.profile_services)?i.has_unconnected_services(!0):void 0)&&t.push(new f),t)},renderOption:function(e){return e instanceof f?m():e instanceof w?C({"import":e}):this.props.renderQueryOption(e)},onSelect:function(e){var t,n;return e instanceof f?this.setState({importsExpanded:!0,selectionIndex:0}):e instanceof w?(E((n=e.provider,__indexOf.call(a.contact_services(),n)>=0),"invalid party contact provider "+e.provider),this.profile_services.service_is_connected(e.provider)?(t=x("You're already connected to %(service_name)s").format({service_name:a.to_name(e.provider)}),void r.success(t)):(this.reset(),this.link_handler.auth_service_with_user(e.provider,this.props.user.id,function(){return function(e){return y.show_import_notifications(e)}}(this)))):this.props.onSelect(e)},reset:function(){return this.setState({importsExpanded:!1,selectionIndex:0})}}),d=t.createClass({mixins:[p],propTypes:{customClass:t.PropTypes.string,maxVisible:t.PropTypes.number,onClose:t.PropTypes.func.isRequired,onSelect:t.PropTypes.func.isRequired,queryOptions:t.PropTypes.array,renderQueryOption:t.PropTypes.func.isRequired,showContactImport:t.PropTypes.bool,user:t.PropTypes.object.isRequired},componentWillMount:function(){return this.link_handler=new y,this.profile_services=null,this.props.showContactImport&&null!=this.props.user?this.profile_services=v.get_linked_profile_services_for_user(this.props.user.id):void 0},getDefaultProps:function(){return{maxVisible:7,showContactImport:!1,onSelect:function(){},renderQueryOption:function(e){return h({contact:e})}}},render:function(){var e;return this.getOptions().length?(e={"typeahead-selector":!0,"contacts-selector":!0},e[this.props.customClass]=null!=this.props.customClass,T.ul({className:t.addons.classSet(e)},this.renderOptions())):T.div({})}}),h=t.createClass({propTypes:{contact:t.PropTypes.object.isRequired,customClass:t.PropTypes.string},render:function(){var e;return e={"contacts-typeahead-option":!0},e[this.props.customClass]=null!=this.props.customClass,this.transferPropsTo(T.li({className:t.addons.classSet(e)},T.div({className:"option-left"},this._renderIcon()),T.div({className:"option-right"},T.div({className:"option-primary"},this._renderPrimary()),T.div({className:"option-secondary"},this._renderSecondary()))))},_renderPrimary:function(){return this._renderMatch(this.props.contact.name,this.props.contact.nameMatch)},_renderSecondary:function(){switch(this.props.contact.type){case u.EMAIL:return this.props.contact.email===this.props.contact.name?"":this._renderMatch(this.props.contact.email,this.props.contact.emailMatch);case u.FB:return x("Facebook message");case u.USER_GROUP:return this.props.contact.members;case u.NEW_STYLE_GROUP:return this.props.contact.members;default:return""}},_renderMatch:function(e,t){var n,i,o,r,s,a,l,u,c;if(!t)return e;for(o=0,s=[],u=t.highlighted,a=0,l=u.length;l>a;a++)c=u[a],i=c[0],r=c[1],i>o&&s.push(e.slice(o,i)),n=e.slice(i,i+r),s.push(T.strong({key:"highlight-"+n+"-"+i},n)),o=i+r;return o<e.length&&s.push(e.slice(o)),s},_renderIcon:function(){var e,t,n;switch(e=this.props.contact,t="contact-icon",e.type){case u.EMAIL:return T.img({src:"/static/images/icons/mail28-vflHfHPJ0.png",className:t});case u.FB:return T.img({src:"https://graph.facebook.com/"+e.fb_id+"/picture",className:t});case u.USER_GROUP:return e.group_avatar;case u.NEW_STYLE_GROUP:return g({text:e.name});case u.CAROUSEL_ROOM:return n=e.avatar_url||"/static/images/carousel/icon-57px-vfluuaZ5j.png",T.img({src:n,className:t});default:return""}}}),g=t.createClass({propTypes:{text:t.PropTypes.string},INITIAL_HASH:5381,render:function(){var e;return e={},e["background-color"]="hsl("+this._calculateHue()+", 70%, 30%)",T.span({className:"avatar-icon",style:e},this._getInitials())},_getInitials:function(){return n.map(this.props.text.split(" "),function(e){return e.charAt(0).toUpperCase()}).splice(0,2).join("")},_calculateHue:function(){var e,t,n;for(n=0,t=this.INITIAL_HASH,e=this.props.text;n<e.length;)t=e.charCodeAt(n)+((t<<6)+(t<<16)-t),n++;return Math.abs(t)%360}}),f=function(){function e(){}return e.prototype.getKey=function(){return"expand-importer"},e}(),m=t.createClass({render:function(){return this.transferPropsTo(T.li({className:"expand-imports-option"},T.div({className:"option-left"},c({group:"web",name:"user_add"})),T.div({className:"option-right"},T.div({className:"option-primary"},x("Import contacts")))))}}),w=function(){function e(e){this.provider=e.provider,this.connected=e.connected}return e.prototype.getKey=function(){return"third-party-import"+this.provider},e}(),C=t.createClass({propTypes:{"import":t.PropTypes.object.isRequired},render:function(){var e,t,n,i;return i=this.props["import"],n=i.provider,e=i.connected,t=e?x("Connected"):"",this.transferPropsTo(T.li({className:"third-party-option"},T.div({className:"option-left"},T.img({src:a.to_img(n)})),T.div({className:"option-right"},T.div({className:"option-primary"},a.to_name(n)),T.div({className:"option-secondary"},t))))}}),{ContactsTypeaheadSelector:d,ContactsTypeaheadSelectorOption:h,ExpandImportOption:m,ThirdPartyImportOption:C}}),define("modules/clean/contacts/types",[],function(){var e;return e={EMAIL:0,FB:1,INVALID:2,USER_GROUP:3,NEW_STYLE_GROUP:4,CAROUSEL_ROOM:5,DBX_ID:6}}),define("modules/clean/contacts/util",["modules/clean/contacts/types"],function(e){var t;return t=function(){function t(){}return t.activityUserToContact=function(t,n){return null==n&&(n=0),{dbx_account_id:t.unique_id,fname:t.fname,lname:t.lname,name:t.display_name,name_tokens:[t.fname,t.lname],email:t.email,type:e.DBX_ID,priority:n,photo_url:t.photo_circle_url}},t}()}),define("modules/clean/cyberfend",["jquery","external/cyfd"],function(e,t){var n;return n={submit:function(n,i){var o,r,s,a,l,u,c,_,d;for(c=e.find(n),r=l=0,u=c.length;u>l;r=++l)o=c[r],s=0===r?i:""+i+"_"+r,0===(null!=(_=e("#"+s))?_.length:void 0)&&0===(null!=(d=e(o).find("[name='"+i+"']"))?d.length:void 0)&&(a=e("<input>",{type:"hidden",id:s,name:i}),o.appendChild(a[0]));return null!=t&&"function"==typeof t.cfsubmit?t.cfsubmit():void 0}}}),define("modules/clean/datetime",["modules/core/exception","modules/core/i18n"],function(e,t){var n,i,o,r,s,a,l,u,c,_,d,p,h,f;return o=e.assert,f=t._,h=t.ungettext,_=[f("January"),f("February"),f("March"),f("April"),f("May"),f("June"),f("July"),f("August"),f("September"),f("October"),f("November"),f("December")],n=[f("Jan"),f("Feb"),f("Mar"),f("Apr"),f("May"),f("Jun"),f("Jul"),f("Aug"),f("Sep"),f("Oct"),f("Nov"),f("Dec")],c=function(e,t){return t?n[e]:_[e]},s=function(e,t){var n;return n=[f("AM"),f("PM")],t.replace(/'[^']*'|y+|M+|d+|h+|k+|K+|H+|m+|s+|S+|a+/g,function(t){var i;switch(t[0]){case"'":return 2===t.length?"'":t.slice(1,-1);case"y":if("yy"===t)return e.getYear()%100;i=e.getFullYear();break;case"M":if(t.length>=3)return c(e.getMonth(),3===t.length);i=e.getMonth()+1;break;case"d":i=e.getDate();break;case"h":i=e.getHours()%12||12;break;case"k":i=e.getHours()%12+1;break;case"K":i=e.getHours()%12;break;case"H":i=e.getHours();break;case"m":i=e.getMinutes();break;case"s":i=e.getSeconds();break;case"S":i=e.getMilliseconds();break;case"a":return n[1*(e.getHours()>=12)]}return i=""+i,i.length<t.length&&(i=("00000000"+i).slice(-1*t.length)),i})},a=function(e){var t,n,i,r,s,a,l;for(r=[86400,3600,60,1],e=isNaN(e)?0:e,t=a=0,l=r.length;l>a;t=++a)if(i=r[t],e>=i){s=parseInt(e/i,10)||0;break}return 1>e&&(s=0),t>=3?n=h("%d sec","%d secs",s).format(s):2===t?n=h("%d min","%d mins",s).format(s):1===t?n=h("%d hour","%d hours",s).format(s):0===t?n=h("%d day","%d days",s).format(s):o(!1,"Invalid time"),n},u=function(e,t){return f("%(month)s %(year)s",{comment:"Like Jun 2012"}).format({month:c(e,!0),year:t})},d=function(e,t,n,i){var o,r,s,a;return null==n&&(n=!1),null==i&&(i=!1),n?(o=e.getUTCDate(),r=e.getUTCMonth(),a=e.getUTCFullYear()):(o=e.getDate(),r=e.getMonth(),a=e.getFullYear()),s=c(r,!i),t?f("%(month)s %(date)s, %(year)s",{comment:"Like Jan 15, 2014"}).format({month:s,date:o,year:a}):f("%(month)s %(date)s",{comment:"Like Jan 15"}).format({month:s,date:o})},i=function(e,t){var n,i,o,r,s,a,l,u;return null==t&&(t=!1),s=new Date(Date.now()),a=(s.getTime()-e.getTime())/1e3,60>a?f("Just now"):3600>a?(o=parseInt(a/60,10),h("%d min ago","%d mins ago",o).format(o)):86400>a?(i=parseInt(a/3600,10),h("%d hour ago","%d hours ago",i).format(i)):2592e3>a?(n=parseInt(a/86400,10),h("%d day ago","%d days ago",n).format(n)):4838400>a?(l=parseInt(a/604800,10),h("%d week ago","%d weeks ago",l).format(l)):31536e3>a?(r=parseInt(a/2592e3,10),h("%d month ago","%d months ago",r).format(r)):(u=parseInt(a/31536e3,10),h("%d year ago","%d years ago",u).format(u))},l=function(e,t,n,i,o,r){return null==t&&(t=0),null==n&&(n=0),null==i&&(i=0),null==o&&(o=0),null==r&&(r=0),e.setFullYear(e.getFullYear()+t),e.setMonth(e.getMonth()+n),e.setDate(e.getDate()+i),e.setHours(e.getHours()+o),e.setMinutes(e.getMinutes()+r),e},p=function(){return(new Date).getTime()},r={abbr_month_names:n,ago:i,format_date:s,format_time:a,increment_date:l,month_abbr_with_year:u,month_name:c,month_names:_,nice_date_with_month_name:d,time:p}}),define("modules/clean/db_bubble",["jquery","modules/core/exception"],function(e,t){var n,i;return i=t.assert,n={position:function(t,n,o){var r,s,a,l,u,c,_;for(t=e(t).css({bottom:"auto",left:"auto",position:"absolute",right:"auto",top:"auto"}),i(t.find(".db-arrow").length,"db-arrow not found"),r=t.find(".db-arrow-border"),i(r.length,"db-arrow-border not found"),l=null,_=["top","right","bottom","left"],u=0,c=_.length;c>u;u++)if(a=_[u],t.hasClass("db-"+a+"-arrow")){l=a;break}return i(l,"No db-#{direction}-arrow class set"),"left"===l?s="left+"+r.outerWidth()+"px top-"+r.position().top+"px":"right"===l?s="right-"+r.outerWidth()+"px top-"+r.position().top+"px":"top"===l?s="left-"+r.position().left+"px top+"+r.outerHeight()+"px":"bottom"===l&&(s="left-"+r.position().left+"px bottom-"+r.outerHeight()+"px"),o||(o={top:"bottom",left:"right",bottom:"top",right:"left"}[l]),t.position({my:s,at:o,of:n,collision:"none"})}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/dbmodal",["jquery","external/jquery_ui","external/keymaster","modules/core/browser","modules/core/dom","modules/core/exception","modules/clean/viewer"],function(e,t,n,i,o,r){var s,a,l,u;return u=r.assert,a=function(){function t(){}return t.__stack=[],t.CLEAR="dbmodal:clear",t.pop=function(n){var i;return null==n&&(n=null),null!=n?t.remove(n):n=t.__stack.pop(),null!=n&&n._hide(),i=t.top(),null!=i?i._show():e(document).trigger(t.CLEAR)},t.push=function(e){var n;return u(e instanceof s,"must pass in valid DBModal"),t.remove(e),n=t.top(),(null!=n?n.visible:void 0)&&n._hide(),t.__stack.push(e),e._show()},t.top=function(){var e;return e=t.__stack.length,e?t.__stack[e-1]:null},t.remove=function(e){var n,i,o,r,s;for(i=[],s=t.__stack,o=0,r=s.length;r>o;o++)n=s[o],n!==e&&i.push(n);t.__stack=i},t.clear=function(){var n,i,o,r;for(n=o=r=t.__stack.length-1;o>=0;n=o+=-1)i=t.__stack[n],i.visible&&i._hide();return e(document).trigger(t.CLEAR),t.__stack=[]},t.register=function(n,i){return e(document).on(n,i),e(document).on(t.CLEAR,function(){return e(document).off(n,i)})},t.unregister=function(t,n){return e(document).off(t,n)},t.trigger=function(t,n){return e(document).trigger(t,n)},t}(),s=function(){function t(e){var n;this.options=e,this.set_title=__bind(this.set_title,this),this._hide=__bind(this._hide,this),this.resize=__bind(this.resize,this),this._show=__bind(this._show,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this.__prefill=__bind(this.__prefill,this),this.__focus=__bind(this.__focus,this),this.__unlisten=__bind(this.__unlisten,this),this.__listen_buttons=__bind(this.__listen_buttons,this),this.__listen=__bind(this.__listen,this),this.__overlay_click_handler=__bind(this.__overlay_click_handler,this),
this.__fix_position=__bind(this.__fix_position,this),this.__keydown_handler=__bind(this.__keydown_handler,this),this.__tabbable_elements=__bind(this.__tabbable_elements,this),this.__x_click_handler=__bind(this.__x_click_handler,this),this.__show_modal=__bind(this.__show_modal,this),this.__clone_modal=__bind(this.__clone_modal,this),this.format=__bind(this.format,this),this.on_cancel_button_click=__bind(this.on_cancel_button_click,this),this.on_confirm_button_click=__bind(this.on_confirm_button_click,this),this.before_show=__bind(this.before_show,this),this.element_id=t.add_role_to_id(this.options.element_id,this.options.role),this.$template=t.get_template(this.options.element_id),n=this.$template.find(".db-modal"),u(this.$template.length,"Missing DBModal pyxl element for '"+this.element_id+"'"),this.options.focus&&("confirm"===this.options.focus?u(n.find(".confirm-button").length,"DBModal pyxl element is missing a confirm button to focus"):"cancel"===this.options.focus?u(n.find(".cancel-button").length,"DBModal pyxl element is missing a cancel button to focus"):u(n.find(this.options.focus).length,"DBModal pyxl element is missing focus element with selector '"+this.options.focus+"'")),null!=this.on_show&&u("function"==typeof this.on_show,"'on_show' must be a function"),null!=this.before_show&&u("function"==typeof this.before_show,"'before_show' must be a function"),null!=this.on_hide&&u("function"==typeof this.on_hide,"'on_hide' must be a function"),null!=this.on_confirm_button_click&&u("function"==typeof this.on_confirm_button_click,"'on_confirm_button_click' must be a function"),null!=this.on_cancel_button_click&&u("function"==typeof this.on_cancel_button_click,"'on_cancel_button_click' must be a function"),this.options.vars&&(this.vars=this.options.vars),this.click_out_to_close=!0,this.options.click_out_to_close===!1&&(this.click_out_to_close=!1),this.prev_key_scope=null,this.vertical_offset=90}return t.KEY_SCOPE="dbmodal",t.__stack=[],t.get_containing_modal=function(e){var n,i;return i=e.closest(".db-modal-wrapper"),n=o.controller(i),n&&u(n instanceof t,"controller of .db-modal-wrapper must be a DBModal object"),n},t.prototype.before_show=function(){return null!=this.options.title?this.set_title(this.options.title):void 0},t.prototype.on_confirm_button_click=function(e){return e.preventDefault(),a.pop()},t.prototype.on_cancel_button_click=function(e){return e.preventDefault(),a.pop()},t.prototype.on_show=null,t.prototype.on_hide=null,t.prototype.format=function(e){var t,n;for(t in e)__hasProp.call(e,t)&&(n=e[t],this.$modal_window.find(t).text(n));return this},t.prototype.__clone_modal=function(){return this.$modal_window||(this.options.preloaded?(this.$modal_window=e("#"+this.element_id),this.$modal_window.removeClass("db-modal-wrapper--preloaded")):this.$modal_window=o.clone(this.$template).attr("id",this.element_id),this.$overlay=this.$modal_window.find(".db-modal-overlay")),o.set_controller(this.$modal_window,this),o.bind_controllers(this.$modal_window),this.options.preloaded?void 0:e("body").prepend(this.$modal_window)},t.prototype.__show_modal=function(){return this.$modal_window.show(),this.__fix_position()},t.prototype.__x_click_handler=function(e){return e.preventDefault(),a.clear()},t.prototype.__tabbable_elements=function(){var t,n,i,o,r,s,a,l,c,_;if(a=this.$modal_window.find(".db-modal").find(":tabbable"),u(a.length,'"dbmodal-x" should be in tabbable_elms'),l=function(){var t,n,o;for(o=[],t=0,n=a.length;n>t;t++)i=a[t],parseInt(e(i).attr("tabindex"))>-1&&o.push(i);return o}(),l.length){for(s=function(t,n){var i,o;return i=parseInt(e(t).attr("tabindex"),10),o=parseInt(e(n).attr("tabindex"),10),o>i?-1:i>o?1:0},l.sort(s),o=-1,c=0,_=l.length;_>c;c++)i=l[c],r=a.index(i),-1===o&&(o=r),a.splice(r,1);u(o>-1,"First index should be set"),n=a.slice(0,o),t=a.slice(o),a=e.merge(n,l),a=e.merge(a,t)}return a},t.prototype.__keydown_handler=function(t){var n,i,r,s;if((27===t.keyCode||8===t.keyCode&&!o.focus_in_input())&&(t.preventDefault(),"function"==typeof this.logger_keydown_close_handler&&this.logger_keydown_close_handler(),a.clear()),9===t.keyCode){if(t.preventDefault(),n=this.__tabbable_elements(),i=n.index(e(t.target)),0>i)return this.focus_element?e(this.focus_element).focus():(s=t.shiftKey?n.last():n.first(),s.focus());if(i>-1)return r=t.shiftKey?-1:1,s=(i+r)%n.length,n.get(s).focus()}},t.prototype.__fix_position=function(){var e,t;return e=this.$modal_window.find(".db-modal"),t=e.width(),e.css({margin:"0 0 0 "+Math.floor(-t/2).toString()+"px",position:"fixed",top:this.vertical_offset})},t.prototype.__overlay_click_handler=function(e){return e.preventDefault(),a.clear()},t.prototype.__listen=function(){return this.click_out_to_close!==!1&&this.$overlay.on("click",this.__overlay_click_handler),this.$db_modal_x=this.$modal_window.find(".db-modal-x"),this.$db_modal_x.on("click",this.__x_click_handler),e(document).on("keydown",this.__keydown_handler),this.__listen_buttons()},t.prototype.__listen_buttons=function(){return null!=this.on_confirm_button_click&&(this.$confirm_button=this.$modal_window.find(".confirm-button"),this.$confirm_button.on("click",this.on_confirm_button_click)),null!=this.on_cancel_button_click?(this.$cancel_button=this.$modal_window.find(".cancel-button"),this.$cancel_button.on("click",this.on_cancel_button_click)):void 0},t.prototype.__unlisten=function(){return this.click_out_to_close!==!1&&this.$overlay.off("click"),this.$db_modal_x.off("click"),e(document).off("keydown",this.__keydown_handler),null!=this.on_confirm_button_click&&this.$confirm_button.off("click"),null!=this.on_cancel_button_click?this.$cancel_button.off("click"):void 0},t.prototype.__focus=function(){var e,t,n,o;return t=this.$modal_window.find(".db-modal"),"confirm"===this.options.focus?this.focus_element=t.find(".confirm-button").first():"cancel"===this.options.focus?this.focus_element=t.find(".cancel-button").first():this.options.focus?this.focus_element=t.find(this.options.focus).first():(this.focus_element=t,e=t.find("input[type=text], input[type=email]").first(),e.length?this.focus_element=e:i.msie||(n=t.find("input[type=button]").first(),n.length&&(this.focus_element=n),o=t.find("input[type=submit]").first(),o.length&&(this.focus_element=o))),this.focus_element.focus()},t.prototype.__prefill=function(){var e,t,n,i,o;if(null!=this.options.prefill){t=this.$modal_window.find(".db-modal"),o=this.options.prefill;for(n in o)i=o[n],e=t.find(n).val(i),u(e,"Element with name '"+n+"' not found")}},t.add_role_to_id=function(e,t){return t?""+e+"-"+t:e},t.get_template=function(n,i){var o;return o=t.add_role_to_id(n,i),e("#db-modal-"+o)},t.prototype.show=function(e,t){return null==e&&(e=null),null==t&&(t=null),null!=e&&(this.options.focus=e),null!=t&&(this.options.prefill=t),a.push(this)},t.prototype.hide=function(){return this!==a.top()?(a.remove(this),this._hide()):a.pop()},t.prototype._show=function(){return this.visible?void 0:(this.__clone_modal(),"function"==typeof this.before_show&&this.before_show(this.$modal_window),this.__show_modal(),this.resize(),this.__listen(),this.visible=!0,window.key.getScope()!==this.constructor.KEY_SCOPE&&(this.prev_key_scope=window.key.getScope()),window.key.setScope(this.constructor.KEY_SCOPE),e(document).trigger("modalOpened",[1]),o.scroll_lock_document(),"function"==typeof this.on_show&&this.on_show(),this.__prefill(),this.__focus(),this)},t.prototype.resize=function(){var t,n;return t=e(window).height()-130-this.vertical_offset,this.$modal_window.find(".db-modal-content").css(this.$modal_window.find(".db-modal").height()>t?{"max-height":t+"px","overflow-y":"auto"}:{"max-height":"","overflow-y":""}),this.options.restrict_width?(n=e(window).width()-60,this.$modal_window.find(".db-modal-content").css(this.$modal_window.find(".db-modal").width()>n?{"max-width":n+"px","overflow-x":"auto"}:{"max-width":"","overflow-x":""})):void 0},t.prototype._hide=function(){return this.visible?(this.__unlisten(),window.key.setScope(this.prev_key_scope),this.$modal_window.remove(),this.visible=!1,this.prev_key_scope=null,e(document).trigger("modalClosed",[1]),o.scroll_unlock_document(),"function"==typeof this.on_hide&&this.on_hide(),this):void 0},t.prototype.set_title=function(e){return this.$modal_window.find(".db-modal-title-text").text(e),this},t}(),l=function(t){function n(e,t){this.user=e,this.__inject_basic_user_properties=__bind(this.__inject_basic_user_properties,this),this.before_show=__bind(this.before_show,this),n.__super__.constructor.call(this,t)}return __extends(n,t),n.prototype.before_show=function(e){return n.__super__.before_show.call(this,e),this.__inject_basic_user_properties(e)},n.prototype.__inject_basic_user_properties=function(t){var n,i;return n=t.find("form"),n.find("input[name='"+Constants.UID_PARAM_NAME+"']").remove(),i=e('<input type="hidden">').attr({name:Constants.UID_PARAM_NAME,value:this.user.id}),n.append(i),t.find(".dbmodal-email-placeholder").text(this.user.email)},n}(s),__CONDITIONAL_JS__.DBModalStack=INLINE_JS.DBModalStack=a,INLINE_JS.DBModal=s,{DBModalStack:a,DBModal:s,DBUserModal:l}});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/dbmodal_loading",["modules/clean/dbmodal","modules/clean/uirequest"],function(e,t){var n;return n=function(e){function n(e){n.__super__.constructor.call(this,e)}return __extends(n,e),n.prototype.on_show=function(){return this.fetch()},n.prototype.fetch=function(){return new t(this.$modal_window,this.options.endpoint_url,{data:this.options.parameters||{},subject_user:this.options.subject_user,html_in_error_msg:this.options.html_in_error_msg,success:function(e){return function(){return e.resize()}}(this),error:function(e){return function(){return e.hide()}}(this)})},n.prototype.on_confirm_button_click=null,n.prototype.on_cancel_button_click=null,n}(e.DBModal)}),define("modules/clean/display_format",["modules/core/i18n"],function(e){var t,n,i;return i=e._,n=function(t,n){var o,r,s;return null==n&&(n=2),t=parseFloat(t),o=Math.abs(t),1024>o?(n=0,r=t,s=e.ungettext("byte","bytes",t)):921600>o?(r=t/1024,s=i("KB")):943718400>o?(r=t/1048576,s=i("MB")):966367641600>o||0===n&&1099511627776>t?(r=t/1073741824,s=i("GB")):(r=t/1099511627776,s=i("TB")),r=Math.round(r*Math.pow(10,n))/parseFloat(Math.pow(10,n)),r=r.toFixed(n),""+r+" "+s},t={format_bytes:n}}),define("modules/clean/dropbox_nav",["jquery","modules/clean/analytics","modules/clean/photos/photos_engagement_logger"],function(e,t,n){var i;return i=function(){function i(){e(".carousel-nav-item").click(function(e){return function(){return e.log_click("carousel_nav_link_click")}}(this)),e(".composer-nav-item").click(function(e){return function(){return e.log_click("composer_nav_link_click")}}(this)),e(".mailbox-nav-item").click(function(e){return function(){return e.log_click("mailbox_nav_link_click")}}(this)),e(".carousel-nav-item").click(function(){return n.log_and_send(n.CAROUSEL_NAV_LINK_CLICK)}),e(".photos-nav-item").click(function(){return n.log_and_send(n.PHOTOS_NAV_LINK_CLICK)})}return i.prototype.log_click=function(e){return t.WebMiscActivityLogger.log(e)},i}()}),define("modules/clean/em_string",[],function(){var e;return e=function(){function e(t){return this instanceof e?(this.s=t,this.info=this.widthInfo(),void(this.length=t.length?this.info[this.s.length-1]:0)):new e(t)}return e.em_snippet=function(t,n,i){return null==n&&(n=50),null==i&&(i=.75),new e(t.toString()).snippet(n,i).toString()},e.prototype.widthInfo=function(){var e,t,n,i;for(t={},t[-1]=0,e=n=0,i=this.s.length;i>=0?i>n:n>i;e=i>=0?++n:--n)t[e]=t[e-1]+this.ems(this.s.charAt(e));return t},e.prototype.findSpot=function(e){var t,n,i,o;if(!e)return 0;for(o=0,n=this.s.length;n>=o;)if(i=Math.floor(o/2+n/2),t=this.info[i-1],t>e)n=i-1;else{if(!(e>t))return i;o=i+1}return o>i?o:i},e.prototype.ems=function(t){var n,i,o,r,s;return i=.65,n=1.08,o=.58,r=t.charCodeAt(0),s=e.CODEPOINT_TO_WIDTH[r],s?s/Math.pow(10,e.ACCURACY):r>=768&&879>=r?0:r>=65377&&65500>=r?o:r>=11904&&40911>=r||r>=44032&&55215>=r||r>=4352&&4607>=r||r>=63744&&64255>=r||r>=65280&&65535>=r||r>=131072&&196607>=r?n:i},e.prototype.substr=function(t,n){var i,o;return o=this.findSpot(t),null!=n?(i=this.findSpot(t+n),new e(this.s.substr(o,i-o))):new e(this.s.substr(o))},e.prototype.toString=function(){return this.s},e.prototype.snippet=function(t,n){var i,o,r,s,a;return null==t&&(t=50),null==n&&(n=.75),this.length<=t?this:(t-=e._ELLIPSIS_LENGTH,i=t*n,s=t-i,a=this.length-s,r=this.substr(0,i),o=this.substr(a),new e(r.toString()+"â¦"+o.toString()))},e.ACCURACY=2,e.CODEPOINT_TO_WIDTH={32:38,33:25,34:42,35:67,36:58,37:92,38:75,39:25,40:33,41:33,42:58,43:58,44:25,45:33,46:25,47:42,48:58,49:58,50:58,51:58,52:58,53:58,54:58,55:58,56:58,57:58,58:25,59:25,60:58,61:58,62:58,63:50,64:100,65:67,66:67,67:67,68:75,69:58,70:58,71:75,72:83,73:33,74:25,75:67,76:58,77:100,78:83,79:83,80:67,81:83,82:67,83:58,84:58,85:75,86:67,87:100,88:67,89:58,90:58,91:33,92:42,93:33,94:58,95:50,96:67,97:58,98:67,99:50,100:67,101:58,102:33,103:58,104:67,105:25,106:25,107:58,108:25,109:100,110:67,111:67,112:67,113:67,114:42,115:50,116:42,117:67,118:58,119:83,120:58,121:58,122:50,123:42,124:58,125:42,126:58,161:25,162:58,163:58,164:58,165:58,166:58,167:58,168:67,169:92,170:42,171:50,172:58,174:92,175:58,176:50,177:58,178:42,179:42,180:67,181:67,182:75,183:25,184:25,185:42,186:42,187:50,188:83,189:83,190:83,191:50,192:67,193:67,194:67,195:67,196:67,197:67,198:92,199:67,200:58,201:58,202:58,203:58,204:33,205:33,206:33,207:33,208:75,209:83,210:83,211:83,212:83,213:83,214:83,215:58,216:83,217:75,218:75,219:75,220:75,221:58,222:67,223:67,224:58,225:58,226:58,227:58,228:58,229:58,230:92,231:50,232:58,233:58,234:58,235:58,236:25,237:25,238:25,239:25,240:67,241:67,242:67,243:67,244:67,245:67,246:67,247:58,248:67,249:67,250:67,251:67,252:67,253:58,254:67,255:58,256:75,257:67,258:75,259:67,260:75,261:67,262:75,263:58,264:75,265:58,266:75,267:58,268:75,269:58,270:83,271:83,272:83,273:75,274:67,275:67,276:67,277:67,278:67,279:67,280:67,281:67,282:67,283:67,284:83,285:75,286:83,287:75,288:83,289:75,290:83,291:75,292:83,293:75,294:92,295:75,296:33,297:33,298:33,299:33,300:33,301:33,302:33,303:33,304:33,305:25,306:67,307:67,308:42,309:33,310:75,311:67,312:67,313:58,314:33,315:58,316:33,317:58,318:42,319:58,320:50,321:67,322:42,323:83,324:75,325:83,326:75,327:83,328:75,329:83,330:83,331:75,332:92,333:67,334:92,335:67,336:92,337:67,338:100,339:100,340:75,341:50,342:75,343:50,344:75,345:50,346:67,347:58,348:67,349:58,350:67,351:58,352:67,353:58,354:75,355:42,356:75,357:42,358:75,359:42,360:83,361:75,362:83,363:75,364:83,365:75,366:83,367:75,368:83,369:75,370:83,371:75,372:100,373:92,374:75,375:58,376:75,377:67,378:67,379:67,380:67,381:67,382:67,383:42,384:75,385:83,386:67,387:75,388:75,389:67,390:75,391:83,392:58,393:83,394:100,395:67,396:75,397:67,398:67,399:75,400:58,401:58,402:75,403:83,404:75,405:100,406:50,407:50,408:75,409:67,410:50,411:67,412:117,413:83,414:75,415:92,416:92,417:75,418:117,419:100,420:75,421:75,422:75,423:67,424:58,425:67,426:58,427:42,428:75,429:42,430:75,431:83,432:75,433:92,434:83,435:75,436:75,437:67,438:67,439:67,440:67,441:58,442:58,443:75,444:75,445:58,446:50,447:67,448:33,449:50,450:50,451:33,452:142,453:142,454:133,455:100,456:92,457:67,458:117,459:117,460:100,461:75,462:67,463:33,464:33,465:92,466:67,467:83,468:75,469:83,470:75,471:83,472:75,473:83,474:75,475:83,476:75,477:67,478:75,479:67,480:75,481:67,482:100,483:100,484:92,485:75,486:83,487:75,488:75,489:67,490:92,491:67,492:92,493:67,494:67,495:58,496:33,497:142,498:142,499:133,500:83,501:75,502:117,503:67,504:83,505:75,506:75,507:67,508:100,509:100,510:92,511:67,512:75,513:67,514:75,515:67,516:67,517:67,518:67,519:67,520:33,521:33,522:33,523:33,524:92,525:67,526:92,527:67,528:75,529:50,530:75,531:50,532:83,533:75,534:83,535:75,536:67,537:58,538:75,539:42,540:58,541:58,542:83,543:75,544:83,545:100,546:92,547:67,548:67,549:67,550:75,551:67,552:67,553:67,554:92,555:67,556:92,557:67,558:92,559:67,560:92,561:67,562:75,563:58,564:67,565:100,566:67,567:33,568:100,569:100,570:75,571:75,572:58,573:58,574:67,575:58,576:58,577:67,578:50,579:75,580:75,581:75,582:75,583:58,584:58,585:25,586:83,587:58,588:75,589:33,590:75,591:58,880:67,881:50,882:67,883:50,884:33,885:33,886:75,887:67,888:108,889:108,890:67,891:58,892:58,893:58,894:42,895:108,896:108,897:108,898:108,899:108,900:67,901:67,902:75,903:42,904:83,905:100,906:58,907:108,908:100,909:108,910:100,911:100,912:42,913:75,914:67,915:58,916:83,917:67,918:67,919:83,920:92,921:33,922:75,923:75,924:100,925:83,926:75,927:92,928:83,929:67,930:108,931:67,932:75,933:75,934:83,935:75,936:83,937:92,938:33,939:75,940:83,941:58,942:75,943:42,944:67,945:83,946:67,947:67,948:67,949:58,950:75,951:75,952:67,953:42,954:67,955:67,956:75,957:67,958:67,959:67,960:92,961:67,962:67,963:75,964:67,965:67,966:92,967:67,968:92,969:100,970:42,971:67,972:67,973:67,974:100,975:108,976:58,977:75,978:75,979:100,980:75,981:92,982:100,983:67,984:92,985:67,986:75,987:58,988:58,989:58,990:67,991:58,992:75,993:92,994:100,995:92,996:75,997:58,998:75,999:58,1e3:75,1001:75,1002:67,1003:67,1004:83,1005:58,1006:50,1007:42,1008:67,1009:67,1010:58,1011:33,1012:92,1013:58,1014:58,1015:67,1016:67,1017:75,1018:100,1019:83,1020:58,1021:75,1022:75,1023:75,1024:67,1025:67,1026:92,1027:58,1028:75,1029:67,1030:33,1031:33,1032:42,1033:108,1034:108,1035:83,1036:75,1037:83,1038:75,1039:83,1040:75,1041:67,1042:67,1043:58,1044:83,1045:67,1046:92,1047:67,1048:83,1049:83,1050:75,1051:83,1052:100,1053:83,1054:92,1055:83,1056:67,1057:75,1058:75,1059:75,1060:83,1061:75,1062:83,1063:75,1064:108,1065:108,1066:75,1067:92,1068:67,1069:75,1070:108,1071:75,1072:67,1073:67,1074:58,1075:58,1076:75,1077:67,1078:83,1079:58,1080:75,1081:75,1082:67,1083:67,1084:83,1085:75,1086:67,1087:75,1088:75,1089:58,1090:58,1091:58,1092:92,1093:67,1094:75,1095:58,1096:92,1097:100,1098:67,1099:83,1100:58,1101:58,1102:92,1103:58,1104:67,1105:67,1106:75,1107:58,1108:58,1109:58,1110:33,1111:33,1112:42,1113:92,1114:92,1115:75,1116:67,1117:75,1118:58,1119:75,1120:100,1121:75,1122:75,1123:67,1124:83,1125:83,1126:75,1127:67,1128:100,1129:92,1130:92,1131:83,1132:117,1133:108,1134:67,1135:67,1136:83,1137:83,1138:92,1139:67,1140:83,1141:67,1142:83,1143:67,1144:133,1145:125,1146:92,1147:67,1148:100,1149:75,1150:100,1151:75,1152:75,1153:58,1154:75,1155:0,1156:0,1157:0,1158:0,1159:108,1160:0,1161:0,1162:83,1163:75,1164:67,1165:58,1166:67,1167:75,1168:58,1169:58,1170:67,1171:58,1172:75,1173:67,1174:100,1175:92,1176:67,1177:58,1178:75,1179:67,1180:83,1181:75,1182:75,1183:67,1184:83,1185:75,1186:83,1187:75,1188:100,1189:83,1190:117,1191:100,1192:92,1193:75,1194:75,1195:58,1196:75,1197:58,1198:75,1199:58,1200:75,1201:58,1202:75,1203:75,1204:100,1205:83,1206:75,1207:67,1208:75,1209:67,1210:75,1211:58,1212:92,1213:75,1214:92,1215:75,1216:33,1217:92,1218:83,1219:75,1220:67,1221:83,1222:67,1223:83,1224:75,1225:83,1226:75,1227:75,1228:58,1229:100,1230:83,1231:25,1232:75,1233:67,1234:75,1235:67,1236:100,1237:100,1238:67,1239:67,1240:75,1241:67,1242:75,1243:67,1244:92,1245:83,1246:67,1247:58,1248:67,1249:58,1250:83,1251:75,1252:83,1253:75,1254:92,1255:67,1256:92,1257:67,1258:92,1259:67,1260:75,1261:58,1262:75,1263:58,1264:75,1265:58,1266:75,1267:58,1268:75,1269:58,1270:58,1271:42,1272:92,1273:83,1274:58,1275:42,1276:75,1277:58,1278:75,1279:58,2026:67,19977:108,65403:58},e._ELLIPSIS_LENGTH=new e("â¦").length,e}()}),define("modules/clean/event_load",["jquery"],function(){var e,t,n;return e=function(e){return window.setTimeout(function(){return e.apply(e)},0)},n=function(t){return"complete"===document.readyState?e(t):null!=window.attachEvent?window.attachEvent("onload",t):null!=window.addEventListener?window.addEventListener("load",t,!1):void 0},t={window_load:n}}),define("modules/clean/events/rollback",["jquery","modules/core/browser","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/analytics","modules/clean/react/modal","modules/clean/ajax"],function(e,t,n,i,o,r,s,a,l){var u,c,_;return _=i._,c=s.SupportExperimentsWebLogger,u={configureAllLinks:function(t,n,i,o){return null==i&&(i=null),null==o&&(o=void 0),e(t).on("click",n,function(t){var n,r,s,l,d;return null!=i&&c.log_file_restore(i),n=e(t.target),d=n.data("user-id"),s=n.data("ns-id"),r=n.data("cs-id"),l=n.data("redirect"),null==l&&(l=!0),a.SimpleModal.show({title_text:_("Undo this deletion"),body_html:_("Are you sure you want to undo this deletion?"),confirm_text:_("Undo deletion"),confirm_callback:function(){return u.rollback(d,s,r,l,o)},cancel_text:_("Cancel")}),!1})},configureLink:function(t,i,o,r,s,l){return e(t).on("click",function(e){return e.stopPropagation(),a.SimpleModal.show({title_text:i,body_html:n.escape(o).toHTML(),confirm_text:_("Restore"),confirm_callback:function(){return u.rollback(r,s,l)},cancel_text:_("Cancel")}),!1})},rollback:function(e,n,i,s,a){var u;return null==a&&(a=void 0),u={},u[n]=i,l.WebProgressRequest({url:"/cmd/restore_changesets",data:{ns_to_cs:JSON.stringify(u)},subject_user:e,html_in_error_msg:!0,progress_text:_("Restoring files..."),success:function(){return o.success(_("Finished restoring files.")),"function"==typeof a&&a(),s?t.redirect(r({path:"/browse_cs/"+e+"/"+n+"/"+i})):void 0}})}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/file_viewer_interface_controller",["jquery","modules/clean/frame_messenger","modules/clean/activity/activity"],function(e,t,n){var i,o,r;return i=n.ActivityContext,r={PDFJS:0,IMAGE:1},o=function(){function n(e){switch(this._handleMessageFromChild=__bind(this._handleMessageFromChild,this),this._getIframeQuery=__bind(this._getIframeQuery,this),this._preparePdfJsInterface=__bind(this._preparePdfJsInterface,this),this.dispatchEvent=__bind(this.dispatchEvent,this),this._notifyEventsTriggered=__bind(this._notifyEventsTriggered,this),this.registerEventsCallbacks=__bind(this.registerEventsCallbacks,this),this._eventsHandler=null,this._type=this._setViewerType(e),this._type){case r.PDFJS:this._preparePdfJsInterface(e)}}return n.prototype._setViewerType=function(e){switch(e){case i.BROWSE_FILE_VIEWER:case i.SHARED_LINK_VIEW:return r.PDFJS;default:return null}},n.prototype.registerEventsCallbacks=function(e){return this._eventsHandler=e},n.prototype._notifyEventsTriggered=function(e,t){return"function"==typeof this._eventsHandler?this._eventsHandler(e,t):void 0},n.prototype.dispatchEvent=function(e,t){switch(this._type){case r.PDFJS:return this._frameMessenger.postMessageToChildren(e,t)}},n.prototype.destroy=function(){var e;return null!=(e=this._frameMessenger)?e.stopListening():void 0},n.prototype._preparePdfJsInterface=function(n){return this._frameMessenger=new t,this._frameMessenger.configureChildMessaging(this._getIframeQuery(n),e.proxy(this._handleMessageFromChild,this),["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","annotation-ui-enter","annotation-ui-over","annotation-ui-leave","annotation-ui-click","page-rendered","scroll","scale-change"]),this._frameMessenger.startListening()},n.prototype._getIframeQuery=function(e){switch(e){case i.BROWSE_FILE_VIEWER:return".preview-content-container > iframe";case i.SHARED_LINK_VIEW:return".preview-box iframe";default:return null}},n.prototype._handleMessageFromChild=function(e){return"function"==typeof this._notifyEventsTriggered?this._notifyEventsTriggered(e.action,e.parameters):void 0},n}()}),define("modules/clean/filepath",["modules/core/i18n"],function(e){var t,n,i,o,r,s,a,l,u,c,_;return _=e._,u=function(e){return e?("/"!==e.charAt(0)&&(e="/"+e),"/"===e.charAt(e.length-1)?e.substr(0,e.length-1):e):""},a=function(e,t){return e=u(e),e=e.split("/"),a=e.pop(),""===a?t||_("Dropbox"):a},l=function(e){return-1===e.indexOf(".")?e:e.split(".").slice(0,-1).join(".")},o=function(e,t){var n;return null==t&&(t=!1),n=e.split(".").pop(),t&&n===e?"":n},r=function(e){return-1===e.indexOf(".")?"":o(e).toLowerCase()},t={_other:"page_white",log:"page_white",msg:"page_white",sln:"page_white",vcproj:"page_white",txt:"page_white_text",wps:"page_white_text",doc:"page_white_word",docx:"page_white_word",docm:"page_white_word",rtf:"page_white_word",pages:"page_white_word",wpd:"page_white_word",odt:"page_white_word",pdf:"page_white_acrobat",xls:"page_white_excel",xlsm:"page_white_excel",xlsx:"page_white_excel",xlsb:"page_white_excel",ods:"page_white_excel",ppt:"page_white_powerpoint",pptx:"page_white_powerpoint",pptm:"page_white_powerpoint",pps:"page_white_powerpoint",ppsx:"page_white_powerpoint",ppsm:"page_white_powerpoint",odp:"page_white_powerpoint",key:"page_white_keynote",css:"page_white_code",html:"page_white_code",htm:"page_white_code",xml:"page_white_code",php:"page_white_code",c:"page_white_code",h:"page_white_code",rb:"page_white_code",cpp:"page_white_code",java:"page_white_code",js:"page_white_code",json:"page_white_code",cs:"page_white_code",py:"page_white_code",exe:"page_white_gear",dll:"page_white_gear",app:"page_white_gear",mp3:"page_white_sound",m3u:"page_white_sound",wav:"page_white_sound",m4a:"page_white_sound",wma:"page_white_sound",aif:"page_white_sound",iff:"page_white_sound",mid:"page_white_sound",mpa:"page_white_sound",ra:"page_white_sound",aiff:"page_white_sound",amr:"page_white_sound",ogg:"page_white_sound",gif:"page_white_picture",png:"page_white_picture",jpg:"page_white_picture",jpeg:"page_white_picture",tiff:"page_white_picture",tif:"page_white_picture",bmp:"page_white_picture",odg:"page_white_picture",ari:"page_white_picture",arw:"page_white_picture",srf:"page_white_picture",sr2:"page_white_picture",bay:"page_white_picture",crw:"page_white_picture",cr2:"page_white_picture",cap:"page_white_picture",eip:"page_white_picture",dcs:"page_white_picture",dcr:"page_white_picture",drf:"page_white_picture",k25:"page_white_picture",kdc:"page_white_picture",dng:"page_white_picture",erf:"page_white_picture",fff:"page_white_picture",iiq:"page_white_picture",mef:"page_white_picture",mos:"page_white_picture",mrw:"page_white_picture",nef:"page_white_picture",nrw:"page_white_picture",orf:"page_white_picture",pef:"page_white_picture",ptx:"page_white_picture",pxn:"page_white_picture",r3d:"page_white_picture",raf:"page_white_picture",rw2:"page_white_picture",raw:"page_white_picture",rwl:"page_white_picture",rwz:"page_white_picture",obm:"page_white_picture",srw:"page_white_picture",x3f:"page_white_picture",avi:"page_white_film",mov:"page_white_film",mp4:"page_white_film",mkv:"page_white_film",wmv:"page_white_film",mpg:"page_white_film",m4v:"page_white_film",vob:"page_white_film",ogv:"page_white_film",gz:"page_white_compressed",tar:"page_white_compressed",rar:"page_white_compressed",zip:"page_white_compressed",tgz:"page_white_compressed",bz2:"page_white_compressed",iso:"page_white_dvd",dmg:"page_white_dvd",ai:"ai",psd:"page_white_paint",au:"page_white_sound",fla:"fla",swf:"fla",url:"page_white_linkfile",webloc:"page_white_linkfile",website:"page_white_linkfile"},i=function(e){return t[e]||"page_white"},s=function(e){var t;return t=o(e).toLowerCase(),i(t)},c=function(e){var t;return t=e.split("/").slice(0,-1).join("/"),t||"/"},n={filename:a,file_extension:o,filename_without_extension:l,file_extension_for_logging:r,file_icon:s,extension_icon:i,normalize:u,parent_dir:c}});var __hasProp={}.hasOwnProperty;define("modules/clean/form",["jquery","external/purify","modules/core/exception","modules/core/notify","modules/clean/ajax","modules/core/cookies","modules/constants/request"],function(e,t,n,i,o,r,s){var a,l;return l=n.assert,a={submit:function(e,t,n,r){return o.FormWebRequest({url:e.attr("action"),data:this.collect_data(e),success:function(e,i,o){var r,s,l;return l=a.parse_response(o.responseText),s=l[0],r=l[1],s?t(r):n(r)},error:function(){return n(i.DEFAULT_ERROR)},complete:r})},collect_data:function(t){var n,i,o,r,s,a,l;for(n={},l=t.find("input, select, textarea"),s=0,a=l.length;a>s;s++)if(i=l[s],o=e(i).attr("name")){if("checkbox"===e(i).attr("type"))r=e(i).prop("checked")?"True":"";else if("radio"===e(i).attr("type")){if(!e(i).prop("checked"))continue;r=e(i).val()}else r=e(i).val();o in n?("string"==typeof n[o]&&(n[o]=[n[o]]),n[o].push(r)):n[o]=r}return n},parse_response:function(e){var t,n,o;if(0!==e.indexOf("err:"))return[!0,e];t=e.substr(4);try{return n=JSON.parse(t),[!1,n]}catch(r){return o=r,[!1,t||i.DEFAULT_ERROR]}},parse_error:function(e){var t,n;if("string"==typeof e)return[!0,e];if("object"==typeof e)for(n in e)if(t=e[n],"message_text"in t)return[!0,t.message_text];return[!1,i.DEFAULT_ERROR]},add_vars:function(n,i){var o,r,s,a;a=[];for(r in i)__hasProp.call(i,r)&&(o=e("<input>",{type:"hidden",name:r}),o.val(i[r]),s=t.sanitize(o.prop("outerHTML")),a.push(n.append(s)));return a},post_request:function(n,i,o){var a,u;return null==i&&(i={}),null==o&&(o={}),l(null!=n,"post_request missing action"),a=e("<form>",{action:n,method:"POST",target:o.target?o.target:void 0}),i.t=r.read(s.JS_CSRF_COOKIE),this.add_vars(a,i),u=e(t.sanitize(a.prop("outerHTML"))),e("body").append(u),u.submit()}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/frame_messenger",["jquery"],function(e){var t;return t=function(){function t(){this.handleUntrustedMessage=__bind(this.handleUntrustedMessage,this),Object.defineProperty(this,"trustedParentOriginForPosting",{get:function(){return this._trustedParentOriginForPosting}}),Object.defineProperty(this,"trustedChildOriginForPosting",{get:function(){var t,n,i,o;if(null!=this._trustedChildOriginForPosting)return this._trustedChildOriginForPosting;for(t=e(this._childIframeQuery),i=0,o=t.length;o>i&&(n=t[i],!this._validateChildOriginForPosting(n.src));i++);return this._trustedChildOriginForPosting}})}return t._ALLOWED_CHILD_ORIGINS=["https://www.dropboxstatic.com","https://cf.dropboxstatic.com","https://www.dropbox.com","https://dl-doc.dropbox.com","https://dl-web.dropbox.com","https://dl.dropboxusercontent.com"],t._ALLOWED_PARENT_ORIGINS=["https://www.dropbox.com"],t._REQUEST_PARENT_ORIGIN_POLL_DELAY=100,t.prototype._childIframeQuery=null,t.prototype._trustedChildOriginForPosting=null,t.prototype._trustedParentOriginForPosting=null,t.prototype._validActionsFromChild=[],t.prototype._validActionsFromParent=[],t.prototype._trustedMessageFromChildHandler=null,t.prototype._trustedMessageFromParentHandler=null,t.prototype._parentMessageQueue=[],t.prototype._requestParentOriginPollRetry=null,t.prototype._onParentReady=null,t.prototype.resetOriginsForPosting=function(){return this._trustedChildOriginForPosting=null,this._trustedParentOriginForPosting=null},t.prototype.configureChildMessaging=function(e,t,n){return this._childIframeQuery=e,this._trustedChildOriginForPosting=null,this._validActionsFromChild=n,this._trustedMessageFromChildHandler=t},t.prototype.configureParentMessaging=function(e,t,n){return null==n&&(n=null),this._trustedParentOriginForPosting=null,this._validActionsFromParent=t,this._trustedMessageFromParentHandler=e,this._onParentReady=n},t.prototype.startListening=function(){return window.addEventListener("message",this.handleUntrustedMessage),null!=this._validActionsFromParent&&this._validActionsFromParent.length>0&&null!=this._trustedMessageFromParentHandler&&this._requestParentOrigin(),null!=this._validActionsFromChild&&this._validActionsFromChild.length>0&&null!=this._trustedMessageFromChildHandler?this.postMessageToChildren("parent-ready"):void 0},t.prototype.stopListening=function(){return window.removeEventListener("message",this.handleUntrustedMessage)},t.prototype._getOriginFromUrl=function(e){var t;return t=document.createElement("a"),t.href=e,"https://"+t.hostname},t.prototype._isChildOriginAllowed=function(e){return __indexOf.call(this.constructor._ALLOWED_CHILD_ORIGINS,e)>=0||this._isDevVmOrigin(e);

},t.prototype._isParentOriginAllowed=function(e){return __indexOf.call(this.constructor._ALLOWED_PARENT_ORIGINS,e)>=0||this._isDevVmOrigin(e)},t.prototype._isDevVmOrigin=function(e){var t;return t=e.match(/\.dev\.corp\.dropbox(static|usercontent)?\.com$/),(null!=t?t.length:void 0)>=1},t.prototype._validateChildOriginForPosting=function(e){var t;return t=this._getOriginFromUrl(e),this._isChildOriginAllowed(t)?(this._trustedChildOriginForPosting=t,!0):(console.warn("Untrusted message from child blocked: "+e),!1)},t.prototype.childIsValidated=function(){return null!=this._trustedChildOriginForPosting},t.prototype._validateParentOriginForPosting=function(e){var t,n,i,o,r,s,a;if(o=this._trustedParentOriginForPosting,i=this._getOriginFromUrl(e),!this._isParentOriginAllowed(i))return console.warn("Untrusted message from parent blocked: "+e),!1;if(this._trustedParentOriginForPosting=i,this._parentMessageQueue.length>0){for(a=this._parentMessageQueue,r=0,s=a.length;s>r;r++)t=a[r],n=JSON.parse(t),this.postMessageToParent(n.action,n.parameters);this._parentMessageQueue=[]}return null!=this._trustedParentOriginForPosting&&null==o&&null!=this._onParentReady&&this._onParentReady(),!0},t.prototype.handleUntrustedMessage=function(e){var t,n,i,o;if(!this._isChildOriginAllowed(e.origin)&&!this._isParentOriginAllowed(e.origin))return void console.warn("Message received not in parent or child origin whitelist: "+e.origin);try{n=JSON.parse(e.data)}catch(r){return void(t=r)}if(null!=n.action)return"child-requesting-parent-origin"===n.action?void(this._validateChildOriginForPosting(e.origin)&&this.postMessageToChildren("parent-ready")):"parent-ready"===n.action?void this._validateParentOriginForPosting(e.origin):(i=n.action,__indexOf.call(this._validActionsFromChild,i)>=0&&this._validateChildOriginForPosting(e.origin)&&null!=this._trustedMessageFromChildHandler?void this._trustedMessageFromChildHandler(n):(o=n.action,void(__indexOf.call(this._validActionsFromParent,o)>=0&&this._validateParentOriginForPosting(e.origin)&&null!=this._trustedMessageFromParentHandler&&this._trustedMessageFromParentHandler(n))))},t.prototype._packagePostMessage=function(e,t){var n,i;return i=this.trustedChildOriginForPosting,n={action:e,parameters:t},JSON.stringify(n)},t.prototype.postMessageToChildElements=function(e,t,n){var i,o,r,s,a;if(null==n&&(n={}),null!=this.trustedChildOriginForPosting){for(o=this._packagePostMessage(t,n),a=[],r=0,s=e.length;s>r;r++)i=e[r],a.push(i.contentWindow.postMessage(o,this.trustedChildOriginForPosting));return a}},t.prototype.postMessageToChildren=function(t,n,i){var o;return null==n&&(n={}),null==i&&(i=null),null==i&&(i=this._childIframeQuery),o=e(i),this.postMessageToChildElements(o,t,n)},t.prototype.postMessageToParent=function(e,t){var n;return null==t&&(t={}),n=this._packagePostMessage(e,t),null==this.trustedParentOriginForPosting?void this._parentMessageQueue.push(n):window.parent.postMessage(n,this.trustedParentOriginForPosting)},t.prototype._requestParentOrigin=function(){var t;return window.parent.postMessage('{"action": "child-requesting-parent-origin"}',"*"),t=function(){return this._requestParentOriginPollRetry=null,null==this._trustedParentOriginForPosting?this._requestParentOrigin():void 0},setTimeout(e.proxy(t,this),this._REQUEST_PARENT_ORIGIN_POLL_DELAY)},t}()}),define("modules/clean/fuzzy",["external/underscore"],function(e){var t;return t={simpleFilter:function(e,n){return n.filter(function(n){return t.test(e,n)})},test:function(e,n){return null!==t.match(e,n)},match:function(e,t,n){var i,o,r,s,a,l,u,c,_,d,p,h,f,m;for(n=n||{},_=0,f=[],c=t.length,m=0,l=0,p=n.pre||"",d=n.post||"",r=n.caseSensitive&&t||t.toLowerCase(),i=void 0,o=void 0,e=n.caseSensitive&&e||e.toLowerCase(),u=0,h=[],s=0,a=0;c>u;)i=t[u],r[u]===e[_]?(i=p+i+d,a?a+=1:(s=u,a=1),_+=1,l+=1+l):(l=0,a&&(h.push([s,a]),a=0)),m+=l,f[f.length]=i,u++;return a&&h.push([s,a]),_===e.length?{highlighted:h,rendered:f.join(""),score:m}:null},filter:function(t,n,i){var o,r;return null==i&&(i={}),r=[],o=this._reduce.bind(this,t,i),e.reduce(n,o,r).sort(this._sort)},_reduce:function(e,n,i,o,r){var s,a;return a=o,n.extract&&(a=n.extract(o)),s=t.match(e,a,n),null!=s&&i.push({string:s.rendered,score:s.score,index:r,original:o}),i},_sort:function(e,t){var n;return n=t.score-e.score,n?n:e.index-t.index}}}),define("modules/clean/gandalf_util",[],function(){var e;return new(e=function(){function e(){}return e.prototype.getGandalfRule=function(e){return Constants.gandalf[e]},e.prototype.isGandalfInVariant=function(e,t){return null==t&&(t="CONTROL"),this.getGandalfRule(e)===t},e.prototype.canSeeDedup=function(){return this.getGandalfRule("recents-web-photos-dedup")},e}())}),define("modules/clean/growth/experiments/logger",["modules/clean/ajax"],function(e){var t;return t=function(){function t(){}var n,i;return t.start_times={},t.DEFAULT_TIMER_NAME="view_time",t.get_timer_name=function(e){return null==e||"boolean"==typeof e?t.DEFAULT_TIMER_NAME:e},t.set_start_time=function(e){var n;return n=t.get_timer_name(e),t.start_times[n]=Date.now()},t.do_log_view_time=function(e,n){var i;return i=t.get_timer_name(n),e[i]=Math.round((Date.now()-t.start_times[i])/1e3)},i={},n=[5,15,60,120,300],t.start_counter=function(e,t){var o,r,s,a;for(a=[],r=0,s=n.length;s>r;r++)o=n[r],a.push(function(n){return i[e+n]=setTimeout(function(){return t(e,{time_since_first_view:n})},1e3*n)}(o));return a},t.stop_counter=function(e){var t,o,r,s;for(s=[],o=0,r=n.length;r>o;o++)t=n[o],s.push(clearTimeout(i[e+t]));return s},t.log=function(n,i,o,r){switch(null==r&&(r=!1),o=o||{},n){case"onboarding":return r&&t.do_log_view_time(o,r),e.WebRequest({url:"/growth_onboarding_log",data:{evt:i,extra:JSON.stringify(o)}});case"sharing":return t.do_log_view_time(o),e.WebRequest({url:"/growth_sharing_log",data:{evt:i,extra:JSON.stringify(o)}});default:throw new Error("Invalid series name")}},t}()}),define("modules/clean/hi_res",["jquery"],function(e){var t;return t=function(){function t(e){var t;this.constructor._show_hi_res()&&(t=e.attr("data-hi-res-no-resize"),this.constructor.set_src(e,e.attr("data-hi-res"),t),this.constructor.set_bg(e,e.attr("data-hi-res-background"),t))}return t.set_src=function(e,t,n){return this._show_hi_res()&&t&&t!==e.attr("src")?this._replace(e,t,!n,this._replace_img):void 0},t.set_bg=function(e,t,n){return this._show_hi_res()?this._replace(e,t,!n,this._replace_background):void 0},t._show_hi_res=function(){return"devicePixelRatio"in window&&window.devicePixelRatio>1},t._replace=function(t,n,i,o){var r;if(n)return r=new Image,r.src=n,e(r).on("load",function(){return o(t,n,i,r.width,r.height)})},t._replace_img=function(e,t,n,i,o){return e.attr("src",t),n?(e.width(i/2),e.height(o/2)):void 0},t._replace_background=function(e,t,n,i,o){var r;return r="url('%(src)s')".format({src:t}),e.css("backgroundImage",r),n?e.css("backgroundSize",""+i/2+"px "+o/2+"px"):void 0},t}()}),define("modules/clean/history",["external/modernizr","external/underscore","modules/core/browser","modules/core/exception","modules/core/uri"],function(e,t,n,i,o){var r,s;return s=i.assert,r=function(){var i,r,a,l,u,c,_,d,p,h,f,m,g;return i=new RegExp("#|;|\\?|:|@|&|=|\\+|\\$"),f=function(){var t,r,s;return s=void 0,e.history||-1===n.get_href().indexOf("#!")?(t=window.location.pathname,r=window.location.search,-1!==t.search(i)&&(t=String(o({path:t}))),s=t+r):s=n.get_href().split("#!").pop(),s},u=function(e,t){return String(o.parse(e).setQuery(t))},c=function(e){var t;return null==e&&(e=f()),t=e.split("?"),{url:e,path:t[0],qargs:o.parse(e).getQuery()}},r={},_={},m=f(),g=null,h=function(e){return"/"+e.split("/")[1]},d=function(){var e,t,n;return n=m,t=c(n),e=h(t.path),e in r?(r[e](t.path.substr(e.length+1),t.qargs),!0):!1},p=function(){var e,t,n;return n=m,t=c(n),e=h(t.path),e in _?_[e](t.path.substr(e.length+1),t.qargs):void 0},a=function(e,t){var n,i;return i=h(e),n=h(t),i!==n?p():void 0},l=function(){var e;return e=f(),e!==m?(a(m,e),m=e,d()):void 0},{init:function(){return g?void 0:(m=f(),g=setInterval(l,50))},add_callback:function(e,t,n){return this.init(),s("string"==typeof e,"DBHistory prefix is not a string"),s(0===e.indexOf("/"),"DBHistory prefix must be absolute"),s(1===e.count("/"),"multi-component prefixes arent supported"),r[e]=t,n?void 0:d()},add_exit_callback:function(e,t){return this.init(),s("string"==typeof e,"DBHistory prefix is not a string"),s(0===e.indexOf("/"),"DBHistory prefix must be absolute"),s(1===e.count("/"),"multi-component prefixes arent supported"),_[e]=t},fire_callbacks:function(){return d()},_build_url_for_state_change:function(e,t){var n;return s("string"==typeof e,"DBHistory path is not a string"),s(0===e.indexOf("/"),"DBHistory path must be absolute"),s(-1===e.indexOf("//"),"DBHistory path contains //"),n=u(e,t)},_pre_state_change:function(e){return e===m?!1:(a(m,e),!0)},_post_state_change:function(e){return null==e&&(e=!0),m=f(),e?d():void 0},replace_state:function(t,n){var i;return i=this._build_url_for_state_change(t,n),this._pre_state_change(i)?(s(e.history,"replace_state is only available on modern browsers"),window.history.replaceState(null,null,i),this._post_state_change()):void 0},push_state:function(n,i,o){var r;return null==o&&(o={}),o=t.defaults(o,{immediatelyRestoreState:!0}),s(-1===n.indexOf("?"),"DBHistory path contains ?"),s(-1===n.indexOf("#"),"DBHistory path contains #"),r=this._build_url_for_state_change(n,i),this._pre_state_change(r)?(e.history?window.history.pushState(null,null,r):window.location.href="#!"+r,this._post_state_change(o.immediatelyRestoreState)):void 0},remove_query_param:function(t){var n;if(e.history)return n=this.deconstruct_url(),delete n.qargs[t],this.replace_state(n.path,n.qargs)},get_url:f,construct_url:u,deconstruct_url:c,URL_ESCAPE_REGEX:i}}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/image_cache",[],function(){var e;return e=function(){function e(t){this._evict_lru=__bind(this._evict_lru,this),this._add_newest_node=__bind(this._add_newest_node,this),this._remove_node=__bind(this._remove_node,this),this._insert=__bind(this._insert,this),this.get_image=__bind(this.get_image,this),this.preload_image=__bind(this.preload_image,this),t&&(e.MAX_SIZE=t)}return e.MAX_SIZE=100,e.image_nodes_by_url={},e.oldest=null,e.newest=null,e.size=0,e.prototype.preload_image=function(e){return this._insert(e)},e.prototype.get_image=function(e){var t;return t=this._insert(e),this._remove_node(t),this._add_newest_node(t),t.image},e.prototype._insert=function(t){var n,i;return e.image_nodes_by_url[t]?e.image_nodes_by_url[t]:(i=new Image,i.src=t,n={url:t,image:i},e.image_nodes_by_url[t]=n,this._add_newest_node(n),n)},e.prototype._remove_node=function(t){var n,i;return e.oldest===t&&(e.oldest=t.newer),e.newest===t&&(e.newest=t.older),n=t.newer,i=t.older,null!=n&&(n.older=i),null!=i&&(i.newer=n),t.newer=null,t.older=null,e.size--},e.prototype._add_newest_node=function(t){return 0===e.size?(e.oldest=t,e.newest=t):(t.older=e.newest,e.newest.newer=t,e.newest=t),e.size++,this._evict_lru()},e.prototype._evict_lru=function(){var t;return e.size>e.MAX_SIZE?(t=e.oldest,this._remove_node(t),delete e.image_nodes_by_url[t.url]):void 0},e}()}),define("modules/clean/image_size",[],function(){var e;return e=function(e,t){var n,i,o,r,s,a,l;for(o=[["480x320",480,320],["640x480",640,480],["800x600",800,600],["1024x768",1024,768],["1280x960",1280,960],["1600x1200",1600,1200],["2048x1536",2048,1536]],a=0,l=o.length;l>a;a++)if(r=o[a],i=r[0],s=r[1],n=r[2],s>=e||n>=t)return i;return o[o.length-1][0]},{image_best_fit_size:e}}),define("modules/clean/index_2015",["jquery","external/underscore","modules/clean/dbmodal","modules/clean/analytics","modules/clean/register_form"],function(e,t,n,i,o){var r,s;return s=i.UserActivityLogger,r=function(){function i(){var i,r;this._onScrollHandler(),e(window).scroll(t.throttle(this._onScrollHandler,33,{leading:!0,trailing:!0})),r=new n.DBModal({element_id:"sign-up-modal"}),e("#sign-up, .sign-up").on("click",function(e){return e.preventDefault(),s.log("","web_register"),r.show()}),i=new n.DBModal({element_id:"index-sign-in-modal"}),e("#sign-in").on("click",function(e){return e.preventDefault(),i.show(),s.log("","web_login")}),e(document).on(o.USER_EXISTS,function(e){return i.show(e.focus,e.prefill)})}return i.prototype._onScrollHandler=function(){return e(window).scrollTop()>350?(e("#dropbox-logo").addClass("fade-out"),e(".button-toggler").addClass("show-sign-up")):(e("#dropbox-logo").removeClass("fade-out"),e(".button-toggler").removeClass("show-sign-up"))},i}()}),define("modules/clean/job_progress",["jquery"],function(e){var t,n,i;return i={make:function(t,n){var i,o,r,s,a,l,u;return null==n&&(n=300),u=n.toString()+"px",r=e("<div />",{"class":"outer-progress-bar"}).css({width:u}),i=e("<div />",{"class":"inner-progress-bar",id:"pb_"+t}).css({width:u}),a=e("<div />",{"class":"under-pb progress-bar"}).css({width:u}),s=e("<div />",{"class":"over-pb progress-bar",id:"pb_"+t+"_over"}).css({display:"none"}),l=e("<div />",{"class":"pb-percentage",id:"pb_"+t+"_upct"}).css({width:u}),o=e("<div />",{"class":"pb-percentage",id:"pb_"+t+"_opct"}).css({width:u}),a.append(l),s.append(o),i.append(a),i.append(s),r.append(i),s.data("progress-width",n),r},set:function(t,n){var i,o,r;return(i=e("#pb_"+t+"_over"))?(n=Math.min(n,1),o=i.data("progress-width"),r=String(o*n)+"px",i.show(),i.css({backgroundColor:"#348DD3",overflow:"hidden",width:r})):void 0}},t={complete:{},handled:function(e){var n;return e?(n=!!t.complete[e],t.complete[e]=!0,n):!1},peek:function(e){return e?!!t.complete[e]:!1}},n={show:function(t){var n,o,r,s,a,l,u,c;if(t&&(null!=(u=__CONDITIONAL_JS__.DBModalStack)&&null!=(c=u.top())&&c.hide(),n=e("body"),o=e("<div />",{id:"modal-progress-overlay"}),o.hide(),o.appendTo(n),e("#browse-box").length?o.clonePosition(e("#browse-box")):e("#gallery-view-media").length?o.clonePosition(e("#gallery-view-media")):o.css({position:"fixed",width:"100%",height:"100%"}),o.width()))return a=e("<div />",{id:"modal-progress-content"}),s=e("<div />",{id:"modal-progress-container"}),r=e("<div />",{id:"modal-progress-bar",opacity:1,html:i.make("modal-progress",150,"")}),l=e("<div />",{id:"modal-progress-text",text:t}),a.hide(),s.append(r,l),a.append(s),n.append(a),o.fadeTo(250,.7),a.fadeIn(250)},update:function(e){var t;if(!(e.indexOf("/")>0&&(t=e.split("/"),e=Number(t[0])/Number(t[1]),isNaN(e))))return i.set("modal-progress",e)},hide:function(){return e("#modal-progress-overlay").fadeOut(250,function(){return e("#modal-progress-overlay").remove()}),e("#modal-progress-content").fadeOut(250,function(){return e("#modal-progress-content").remove()})}},{ModalProgress:n,Job:t}}),define("modules/clean/keycode",[],function(){var e;return e=function(){function e(){}return e.BACKSPACE=8,e.TAB=9,e.ENTER=13,e.SHIFT=16,e.CONTROL=17,e.ALT=18,e.ESC=27,e.SPACE=32,e.PAGE_UP=33,e.PAGE_DOWN=34,e.END=35,e.HOME=36,e.LEFT=37,e.UP=38,e.RIGHT=39,e.DOWN=40,e.INSERT=45,e.DELETE=46,e.TWO_KEY=50,e.EQUALS=61,e.COMMAND=91,e.PLUS_EQUALS_FF=107,e.MINUS_FF=109,e.PLUS_EQUALS_FF_GERMAN=171,e.MINUS_FF_MAC=173,e.PLUS_CHROME=187,e.MINUS_CHROME=189,e.FORWORD_SLASH=191,e.AT_SIGN=64,e.PROCESSING=229,e}()}),define("modules/clean/mailcheck",["jquery","modules/core/html","modules/core/i18n"],function(e,t,n){var i,o;return o=n._,i=function(){function e(e,t,n){var i;this.$input=e,this.$suggestion_container=t,null==n&&(n={}),this.checkInput(),i=n.livecheck===!0?"keyup blur":"blur",this.$input.on(i,this.checkInput.bind(this))}return e.DOMAINS=["gmail.com","hotmail.com","yahoo.com","aol.com","web.de","gmx.de","googlemail.com","me.com","live.com","msn.com","mail.ru","comcast.net","google.com","mac.com"],e.WHITELIST_REGEXS=[/ymail.com/,/yahoo\.co\./,/yahoo\.com\./,/hotmail\.co\./,/hotmail\.com\./,/gmx\.net/,/gmx\.at/,/gmx\.ch/,/gmx\.com/,/mail\.com/,/web\.com/],e.THRESHOLD=2,e.prototype.checkInput=function(){var e;e=this.suggest(this.$input.val()),e?this.populate(e):this.clear()},e.prototype.populate=function(e){var n,i,r;return r=t.escape(e.local).toHTML(),n=t.escape(e.domain).toHTML(),i=""+r+"@<span class='email_warning_area'>"+n+"</span>",this.$suggestion_container.html(new t(o("Did you mean <a>%(suggested_email)s</a>?").format({suggested_email:i})).toHTML()),this.$suggestion_container.show(),this.$suggestion_container.on("click",function(t){return function(){return t.$input.val(e.full),t.clear()}}(this))},e.prototype.clear=function(){return this.$suggestion_container.empty(),this.$suggestion_container.hide()},e.prototype.suggest=function(e){var t,n,i,o;return null==e&&(e=""),e.length?(e=e.toLowerCase(),(o=this.splitEmail(e))?(i=o.local,n=o.domain,this.whitelistedDomain(n)?!1:(t=this.findClosestDomain(n),t?{local:i,domain:t,full:""+i+"@"+t}:!1)):!1):void 0},e.prototype.whitelistedDomain=function(t){var n,i,o,r;for(r=e.WHITELIST_REGEXS,i=0,o=r.length;o>i;i++)if(n=r[i],n.test(t))return!0;return!1},e.prototype.splitEmail=function(e){var t;return t=e.split("@"),2!==t.length?!1:{local:t[0],domain:t[1]}},e.prototype.findClosestDomain=function(t){var n,i,o,r,s,a,l;for(r=99,i=null,l=e.DOMAINS,s=0,a=l.length;a>s;s++)n=l[s],o=this.stringDistance(t,n),r>o&&(r=o,i=n);return i&&i!==t&&r<=e.THRESHOLD?i:!1},e.prototype.stringDistance=function(e,t){var n,i,o,r,s,a;if(null==e||0===e.length)return null==t||0===t.length?0:t.length;if(null==t||0===t.length)return e.length;for(n=0,s=0,a=0,o=0,r=5;n+s<e.length&&n+a<t.length;){if(e.charAt(n+s)===t.charAt(n+a))o++;else for(s=0,a=0,i=0;r>i;){if(n+i<e.length&&e.charAt(n+i)===t.charAt(n)){s=i;break}if(n+i<t.length&&e.charAt(n)===t.charAt(n+i)){a=i;break}i++}n++}return(e.length+t.length)/2-o},e}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/marketing_tracker",["modules/core/exception"],function(e){var t,n;return t="https://marketing.dropbox.com",new(n=function(){function n(){this._load=__bind(this._load,this),this.push=__bind(this.push,this)}return n.prototype.el=!1,n.prototype.ready=!1,n.prototype.push=function(n){var i;return this.src=n.src,i=n.dataLayer,e.assert(this.src,"MarketingTracker.push requires src"),this.el||(this.el=this._load(this.src)),this.ready?this.el.contentWindow.postMessage(i,t):this.el.addEventListener("load",function(e){return function(){return e.ready=!0,e.el.contentWindow.postMessage(i,t)}}(this)),this},n.prototype._load=function(e){var t;return t=document.createElement("iframe"),t.style.display="none",t.hidden=!0,t.src=e,t.setAttribute("sandbox","allow-scripts allow-same-origin"),document.body.appendChild(t),t},n}())}),define("modules/clean/multiaccount_login",["jquery","modules/core/browser","modules/core/dom","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/viewer","modules/clean/components/login_form","modules/clean/dbmodal"],function(e,t,n,i,o,r,s,a,l){var u,c,_,d;return _=i.assert,d=o._,u=l.DBModal,c=function(){function i(){}return i.$element=function(){return e("#db-modal-multiaccount-login-modal")},i.set_during_login_callback=function(e){return _(!this._during_login_callback,"already have a during_login_callback"),this._during_login_callback=e},i.show_modal=function(i){var o,l,c,p,h;return null==i&&(i={}),this.$element=e.isFunction(this.$element)?this.$element():this.$element,_(null!=(h=this.$element)?h.length:void 0,"MultiaccountLogin needs its @$element to be set"),_(!(null!=i.on_success&&null!=i.success_href),"on_success and success_href are mutually exclusive"),null!=i.user?p=s.get_viewer().get_user_by_id(String(i.user),!0):null!=i.user_id?p=s.get_viewer().get_user_by_id(i.user_id,!0):null!=i.role&&(p=s.get_viewer().get_user_by_role(i.role,!0)),_(null!=p,"invalid user"),l=p.role,_(!s.get_viewer().is_user_signed_in(p),"called MultiaccountLogin for a user that's already signed in"),c="personal"===l?d("Sign in to your personal Dropbox"):d("Sign in to your %(team_name)s Dropbox").format({team_name:s.get_viewer().team_name}),o=this.$element.find("form"),n.controller(o).reset(),n.controller(o).set_input_value("login_email",p.email),this.auth_success_callback=function(e){return function(){var n;return s.get_viewer()._sign_in_all_users(),e.set_logged_out_role(null),n=function(n){return null!=n?(r.error(n),s.get_viewer()._sign_out_user_by_id(p.id),e.set_logged_out_role(p.role),void e.modal.hide()):null!=i.success_href?t.get_uri().toString()!==i.success_href?t.redirect(i.success_href):t.reload():(e.modal.hide(),"function"==typeof i.on_success?i.on_success():void 0)},null!=e._during_login_callback&&null==i.success_href?e._during_login_callback(p,n):n(),!1}}(this),e(document).off(a.MULTI_LOGIN_SUCCESS),e(document).on(a.MULTI_LOGIN_SUCCESS,this.auth_success_callback),this.modal=new u({element_id:"multiaccount-login-modal"}),this.modal.show(),this.modal.set_title(c),this.$element.find('input[name="login_password"]').focus()},i.set_logged_out_role=function(e){return this.logged_out_role=e},i.set_team_name=function(e){return this.team_name=e},i.show_page_login_modal=function(e){var t;if(this.logged_out_role)return t={role:this.logged_out_role},"string"==typeof e?t.success_href=e:"function"==typeof e&&(t.on_success=e),this.show_modal(t),!1},i}(),INLINE_JS.MultiaccountLogin=c,c});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},__slice=[].slice;define("modules/clean/notserver",["jquery","external/underscore","modules/core/exception","modules/core/uri","modules/clean/viewer"],function(e,t,n,i,o){var r,s,a,l,u,c,_,d,p;u=n.assert,r={},s=!1,l="/subscribe",a=function(){function n(){}return n.prototype.add_notclient=function(e,t,n){return this.new_notclient(e),setTimeout(function(){return r[e].init(t,n)},2e3)},n.prototype.new_notclient=function(n){var o,a,c,_,d,p,h,f,m,g,v,y,b,w,C,S,E,T,k,x,I,A,P,N,O,R,L,M,D,U,F,B,q,H,j,V,W,$,G;return u(__indexOf.call(r,n)<0,"cannot create more than one notclient per user"),k=function(e){return t.isNumber(e)&&e%1===0&&e>0},T=function(e){return t.isNumber(e)&&e%1===0&&e>=0},u(k(n),"user_id must be a positive integer"),x=function(){var e;return e=1<=arguments.length?__slice.call(arguments,0):[],s?console.log.apply(console,e):void 0},o=9e4,_=8096,p="user",d="list",C=!1,a=1e3,c=3e5,R=0,H=function(){var e;return e=0===y?0:Math.min(a*Math.pow(2,y-1),c),Math.max(e,R)},N=null,L={},w={},P=1,S=!1,E=!1,$=null,f=!1,V=[],q=null,v=null,I=null,A={},M=!1,y=0,j=0,W=function(e,t){var n,i,o;o=[];for(n in t)i=t[n],n=parseInt(n,10),u(k(n),"ns_ids must be positive integers: "+n),u(T(i),"sjids must be nonnegative integers: "+i),o.push(null!=e[n]?e[n]=Math.min(e[n],i):e[n]=i);return o},m=function(){var e,o,r,s;return u(null!=N&&!t.isEmpty(L),"expected nid and ns_map"),r={host_int:0,trace:window.location.pathname,rev:Constants.SVN_REV},e=t.pluck(t.values(w),"type"),__indexOf.call(e,p)>=0&&(r.user_id=n,r.nid=null!=N?N.replace(/^0+(.)/,"$1"):void 0),__indexOf.call(e,d)>=0&&(r.ns_map=function(){var e;e=[];for(o in L)s=L[o],e.push(""+o+"_"+s);return e}().join(",")),i.parse(l).updateQuery(r).toString().length>_&&delete r.ns_map,r},g=function(){var e;if(C)return e=H(),e>0?v=window.setTimeout(G,e):G()},G=function(){var n;return u(!S&&!E,"connect: invalid state"),u(N>=0||!t.isEmpty(L),"notclient: called connect with nothing to subscribe to"),x("###########################"),n=m(),null!=n.nid||n.ns_map?(x("connecting to notserver..."),S=!0,j+=1,$=e.ajax(l,{data:n,dataType:"json",noDropboxDefaults:!0,error:function(){return f?void(f=!1):(y+=1,x("error connecting to notserver. bad rounds="+y+"."),S=!1,g())},success:function(e){return x("notserver connection closed. response:",e),S=!1,null!=e.chillout?(R=1e3*parseInt(e.chillout,10),x("notserver told us to chill for "+R+"ms")):R>0&&(x("setting notserver chillout back to 0ms"),R=0),"punt"===e.ret?g():(u("new"===e.ret,"unknown notserver ret: "+e.ret),u("refresh"in e,"expected notserver ret:new to have refresh keyword"),B(e.refresh))}})):void x("nothing to subscribe to. skipping notserver connection.")},h=function(){return null!=$?(f=!0,$.abort(),$=null):void 0},D=function(){return R=0,S=!1,E=!1,h(),V=[],window.clearTimeout(q),window.clearTimeout(v),q=null,v=null,I=null,A={},M=!1,y=0,g()},F=function(){var e;return C=!1,R=0,N=null,L={},w={},e=0,P=1,S=!1,E=!1,$=null,f=!1,V=[],window.clearTimeout(q),window.clearTimeout(v),q=null,v=null,I=null,A={},M=!1,y=0,j=0},B=function(e){var n,i,r,s,a,l,c,_;for(u(!E&&!S,"run_handlers: invalid state"),u(null===I,"run_handlers: new_nid must start at null"),u(t.isEqual(A,{}),"run_handlers: new_ns_map must start at {}"),u(!M,"expected one_or_more_handler_failures=false"),E=!0,x("running handlers..."),s=t.filter(t.values(w),function(t){var n;return n=t.type,__indexOf.call(e,n)>=0}),u(!t.isEmpty(s),"notserver sent a ping for unsubscribed activity"),V=t.pluck(s,"handler_id"),l=0,c=s.length;c>l;l++)_=s[l],n=_.handler,i=_.handler_id,r=_.name,a=_.type,x("running id="+i+", name="+r+", type="+a),n();return t.isEmpty(V)?x("all handlers already finished running. no need for a slacker timeout."):(x("all handlers running. slacker timeout set."),q=window.setTimeout(U,o))},U=function(){var e,n,i,o;for(u(E&&!S,"called report_slackers in an invalid state."),u(!t.isEmpty(V,"report_slackers called w/ nothing slackin'")),x("found some slackers"),M=!0,o=[],n=0,i=V.length;i>n;n++)e=V[n],o.push(b(e));return o},b=function(e){return __indexOf.call(V,e)<0?void 0:(x("done handling: "+e),V=t.without(V,e),t.isEmpty(V)?(x("all handlers are done running."),E=!1,window.clearTimeout(q),null!=I&&(x("new nid: "+I),N=I),t.isEmpty(A)||(x("new ns_map:",A),L=A),M?(y+=1,x("one or more handler errors. bad_rounds="+y)):y=0,I=null,A={},M=!1,g()):void 0)},O={get_user_id:function(){return n},get_nid:function(){return N},get_ns_map:function(){return t.clone(L)},get_consecutive_bad_rounds:function(){return y},get_total_rounds:function(){return j},get_notserver_chillout_ms:function(){return R},get_sleep_ms:H,subscribe_user:function(e){var n,i,o,r,s,a,l;for(u(!E,"adding new handlers from inside handlers is not currently supported"),l=["name","handler"],s=0,a=l.length;a>s;s++)r=l[s],u(e[r],"subscribe_user requires this param be non-falsey: "+r);return u(t.isFunction(e.handler),"handler must be a function"),x("adding user handler "+e.name),i=t.pluck(t.values(w),"type"),o=__indexOf.call(i,p)<0,n=P++,w[n]={handler_id:n,handler:e.handler,name:e.name,type:p},o&&(x("first user handler added, reconnecting"),D()),n},subscribe_sfj:function(e){var n,i,o,r,s,a,l;for(u(!E,"adding new handlers from inside handlers is not currently supported"),l=["name","handler"],s=0,a=l.length;a>s;s++)r=l[s],u(e[r],"subscribe_sfj requires this param be non-falsey: "+r);return u(t.isFunction(e.handler),"handler must be a function"),x("adding sfj handler "+e.name),i=t.pluck(t.values(w),"type"),o=__indexOf.call(i,d)<0,n=P++,w[n]={handler_id:n,handler:e.handler,name:e.name,type:d},o&&(x("first sfj handler added, reconnecting"),D()),n},handler_success:function(e,t){var n;if(!(__indexOf.call(V,e)<0))return n=w[e].type,n===d?(u("ns_map"in t,"ns_map required param is missing"),u(!("nid"in t),"nid is disallowed from SFJ handlers"),W(A,t.ns_map)):(u(n===p,"unknown handler type: "+n),u("nid"in t,"nid required param is missing"),u(!("ns_map"in t),"ns_map is disallowed from user handlers"),(null==I||t.nid<I)&&(I=t.nid)),b(e)},handler_failure:function(e){return x("handler failed. handler_id="+e),__indexOf.call(V,e)<0?void 0:(M=!0,b(e))},handle_visibility_change:function(){return window.document.hidden?h():D()},init:function(e,t){return u(!C,"error: init() has been called twice."),N=e,W(L,t),C=!0,null==window.document.visibilityState?g():(document.addEventListener("visibilitychange",this.handle_visibility_change),window.document.hidden?void 0:g())},reset:F,abort:h,reconnect:D},r[n]=O,O},n}(),a=new a,p=o.get_viewer().get_users();for(_=0,d=p.length;d>_;_++)c=p[_],a.add_notclient(c.id,c.nid,c.ns_map);return{NotServer:a,NotClients:r}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/open_with",["modules/clean/browse_interface","modules/clean/filepath","modules/core/uri"],function(e,t,n){var i;return i=function(){function i(){}var o;return i.MAX_SUPPORTED_FILE_SIZE_B=157286400,o=[{id:"excel",ext:["ods","xlsb","xlsm","xlsx"],icon:"excel",name:"Microsoft Excel Online"},{id:"powerpoint",ext:["odp","ppsx","pptx"],icon:"powerpoint",name:"Microsoft PowerPoint Online"},{id:"word",ext:["odt","docm","docx"],icon:"word",name:"Microsoft Word Online"}],i.SUPPORTED_APPS={word:!1,excel:!1,powerpoint:!1},i.PRELOAD_URLS={},i.get_open_handler_for=function(r,s){var a,l,u;return a=t.file_extension(r.filename).toLowerCase(),u=o.filter(function(e){return __indexOf.call(e.ext,a)>=0}),u.length&&i.SUPPORTED_APPS&&i.SUPPORTED_APPS[u[0].id]?(l=n.encode_parts(r.fq_path),{icon:u[0].icon,name:u[0].name,uri:"/ow/msft/edit"+e.get_browse_root(s)+l}):null},i.file_supported=function(e){var n,i;return n=t.file_extension(e.filename).toLowerCase(),i=o.filter(function(e){return __indexOf.call(e.ext,n)>=0}),i.length>0},i}(),__CONDITIONAL_JS__.OpenWith=i,i});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/openwith/logger",["jquery","modules/clean/ajax"],function(e,t){var n,i;return n=function(){function e(){}return e.log=function(e,n,i){return i=i||{},i.vendor=e,t.AuthenticatedRequest({url:"/ow/js_log",data:{evt:n,extra:JSON.stringify(i)}})},e}(),i=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.log=function(e,t){return n.__super__.constructor.log.call(this,"msft",e,t)},n.log_postmessage_received=function(e,t,i){var o,r,s,a,l;for(o={user_id:e,wopi_id:t},l=["origin","timeStamp","data"],s=0,a=l.length;a>s;s++)r=l[s],r in i&&(o[r]=i[r]);return n.log("postmessage_received",o)},n.log_postmessage_sent=function(e,t,i,o){var r,s,a,l,u;for(r={user_id:e,wopi_id:t,postmsg_url:i},u=["MessageId","SendTime","Values"],a=0,l=u.length;l>a;a++)s=u[a],s in o&&(r[s]=o[s]);return n.log("postmessage_sent",r)},n.log_conflict_modal_shown=function(e,t,i){var o;return o={user_id:e,wopi_id:t},n.log(i,o)},n.log_open_button_pressed=function(e,n,i,o){return t.AuthenticatedRequest({url:"/ow/log_open_button_pressed",data:{user_id:e,server_path:""+i+":"+o,file_extension:n}})},n}(n),__CONDITIONAL_JS__.OpenWithMicrosoftLogger=i,{OpenWithLogger:n,OpenWithMicrosoftLogger:i}}),define("modules/clean/page_role_observer",["modules/core/exception"],function(e){var t,n;return n=e.assert,new(t=function(){function e(){this._listeners=[]}return e.prototype.addListener=function(e){return n("function"==typeof e,"PageRoleState.addListener expects a function, got: "+typeof e),this._listeners.push(e)},e.prototype.removeListener=function(e){var t;return n("function"==typeof e,"PageRoleState.removeListener expects a function, got: "+typeof e),this._listeners=function(){var n,i,o,r;for(o=this._listeners,r=[],n=0,i=o.length;i>n;n++)t=o[n],t!==e&&r.push(t);return r}.call(this)},e.prototype.removeAllListeners=function(){return this._listeners=[]},e.prototype.emit=function(e){var t,n,i,o,r;for(o=this._listeners.slice(),r=[],n=0,i=o.length;i>n;n++)t=o[n],r.push(t(e));return r},e}())}),define("modules/clean/pagination_manager",["modules/clean/ajax","modules/core/notify","modules/core/i18n"],function(e,t,n){var i,o;return o=n._,i=function(){function n(){}var i,r;return i=function(){function e(e,t){this.userRole=e,this.hasMoreItems=t}return e.prototype.areAllItemsReady=function(e){return null==e&&(e=this.userRole),e===Constants.ROLE_BOTH?!(this.hasMoreItems[Constants.ROLE_PERSONAL]||this.hasMoreItems[Constants.ROLE_WORK]):!this.hasMoreItems[e]},e.prototype.invalidateHasMore=function(){var e,t;t=[];for(e in this.hasMoreItems)t.push(this.hasMoreItems[e]=!0);return t},e.prototype.addDataToAjax=function(e){
return e.role=this.areAllItemsReady()?Constants.ROLE_BOTH:this.userRole},e}(),r=function(){function e(e){this.hasMoreItems=e}return e.prototype.areAllItemsReady=function(){return!this.hasMoreItems},e.prototype.invalidateHasMore=function(){return this.hasMoreItems=!0},e.prototype.addDataToAjax=function(){},e}(),n.prototype.initialize=function(e,t,n,i,o){return this.ajaxURL=n,this.newDataCallback=o,this.autoFetching=!1,this.mode=new r(e.has_more_items),this.keyName=t,this.items={},this.pages=[],this.nextRequestVoucher=e.next_request_voucher,this.userID=i,this._addPage(e.items)},n.prototype.areAllItemsReady=function(e){return this.mode.areAllItemsReady(e)},n.prototype._addPage=function(e){var n,i,r,s,a,l;for(s=[],r=[],a=0,l=e.length;l>a;a++){if(n=e[a],i=n[this.keyName],null==i)return void t.warning(o("Invalid server response"));null==this.items[i]&&(this.items[i]=n,r.push(n),s.push(i))}return this.pages.push(s),this.newDataCallback(this,r)},n.prototype.startAutoFetching=function(){return this.autoFetching=!0,this.fetchNext()},n.prototype.stopAutoFetching=function(){return this.autoFetching=!1},n.prototype.setUserRole=function(e){return this.mode=new i(e,this.mode.hasMoreItems)},n.prototype.reSync=function(e){var t;return null==e&&(e=!1),e&&(this.nextRequestVoucher=null,this.items={},this.pages=[]),t=this.autoFetching&&this.mode.areAllItemsReady(Constants.ROLE_BOTH),this.mode.invalidateHasMore(),t?this.startAutoFetching():void 0},n.prototype.fetchNext=function(){var n;if(!this.mode.areAllItemsReady(Constants.ROLE_BOTH))return n={},this.nextRequestVoucher&&(n.voucher=this.nextRequestVoucher),this.mode.addDataToAjax(n),e.WebRequest({url:this.ajaxURL,data:n,subject_user:this.userID,success:function(e){return function(t){return t=JSON.parse(t),e.nextRequestVoucher=t.next_request_voucher,e.mode.hasMoreItems=t.has_more_items,e.autoFetching&&e.fetchNext(),e._addPage(t.items)}}(this),error:function(){return function(){return t.error()}}(this)})},n.prototype.loadedPageCount=function(){return this.pages.length},n.prototype.getLoadedPage=function(e){var t,n,i,o,r;if(n=[],i=this.pages[e],null==i)return null;for(o=0,r=i.length;r>o;o++)t=i[o],n.push(this.items[t]);return n},n.prototype.getLastLoadedPage=function(){return this.getLoadedPage(this.loadedPageCount()-1)},n}()}),define("modules/clean/payments/cash",[],function(){var e,t,n,i;return i=function(){function e(){}return e._groupSymbol=",",e._decimalSymbol=".",e._minusSignSymbol="-",e._currencyFormatMap={USD:"$%v"},e.set_locale_number_format=function(t,n,i){e._groupSymbol=null!=t?t:",",e._decimalSymbol=null!=n?n:".",e._minusSignSymbol=null!=i?i:"-"},e.set_currency_format_map=function(t){e._currencyFormatMap=t},e._formatAmountThousandsHelper=function(t){var n;return n=Math.abs(parseInt(t)).toFixed(0)+"",n.length<=3?n:e._formatAmountThousandsHelper(n.substr(0,n.length-3))+e._groupSymbol+n.substr(n.length-3)},e.roundCurrency=function(e,t,n){return null==t&&(t="USD"),null==n&&(n=2),e%1===0&&(n=0),this.formatCurrency(e,t,n)},e.formatCurrency=function(t,n,i,o){var r,s,a,l;return null==n&&(n="USD"),null==i&&(i=2),null==o&&(o=!1),"JPY"===n&&(i=0),s=e.formatNumber(t,i),a=(null!=(l=e._currencyFormatMap[n])?l.replace("%v",s):void 0)||s+" "+n,o?(r=a.indexOf(e._decimalSymbol),-1===r?[a,""]:[a.slice(0,r+1),a.slice(r+1)]):a},e.formatNumber=function(t,n){return null==n&&(n=2),(0>t?e._minusSignSymbol:"")+e._formatAmountThousandsHelper(t)+(n>0?e._decimalSymbol+t.toFixed(n).split(".")[1]:"")},e}(),t=function(){function e(e,t){this.cash1=e,this.cash2=t}return e}(),n=function(){function e(){}return e}(),e=function(){function e(e,t){if(this.currency=t,!e&&0!==e||!this.currency)throw new n;this.amount=parseFloat(e)}return e.prototype.add=function(n){if(this.currency!==n.currency)throw new t(self,n);return new e(this.amount+n.amount,this.currency)},e.prototype.subtract=function(t){return this.add(new e(-t.amount,t.currency))},e.prototype.multiply=function(t){return new e(this.amount*t,this.currency)},e.prototype.divide=function(t){return new e(this.amount/t,this.currency)},e.prototype.round=function(t){var n;return null==t&&(t=2),n=Math.pow(10,t),new e(Math.round(this.amount*n)/n,this.currency)},e.prototype.toString=function(e){return null==e&&(e=2),"JPY"===this.currency&&(e=0),i.roundCurrency(this.amount,this.currency,e)},e.fromObject=function(t){return new e(t.amount,t.currency)},e}(),{CashUtil:i,CashCurrenciesDoNotMatch:t,CashNeedsAmountAndCurrency:n,Cash:e}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/payments/credit_card_util",[],function(){var e;return e={_credit_card_info_map:null,setCreditCardInfoMap:function(e){this._credit_card_info_map=e},getAllTypes:function(){var e,t;return function(){var n,i;n=this._credit_card_info_map,i=[];for(t in n)e=n[t],i.push(t);return i}.call(this)},getValidCardTypesForCountryCode:function(e){var t,n,i,o;i=[],o=this._credit_card_info_map;for(n in o)t=o[n],(__indexOf.call(t.accepted_countries,"all")>=0||__indexOf.call(t.accepted_countries,e)>=0)&&i.push(n);return i},isValidCardTypeForCountryCode:function(e,t){return __indexOf.call(this.getValidCardTypesForCountryCode(t),e)>=0},getNameForType:function(e){return this._credit_card_info_map[e].name}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/payments/dfb_util",["jquery","external/underscore","modules/clean/payments/cash","modules/clean/payments/validation","modules/core/exception"],function(e,t,n,i,o){var r,s,a,l,u;return r=n.Cash,u=o.assert,l=function(){function e(e,t,n,i,o,r,s){this.plan_ids=e,this.schedule_ids=t,this.license_ids_and_counts=n,this.currencies=i,this.country_code=o,this.zip_code=r,this.vat_id=s,this.renew=!1,this.discount_ratio=0}return e.prototype.set_only_license_count=function(e){var t;return t=Object.keys(this.license_ids_and_counts)[0],this.license_ids_and_counts[t]=e},e.prototype.get_only_license_count=function(){var e;return e=Object.keys(this.license_ids_and_counts)[0],this.license_ids_and_counts[e]},e.prototype.set_country_code=function(e){this.country_code=e},e.prototype.set_zip_code=function(e){this.zip_code=e},e.prototype.set_currencies=function(e){this.currencies=e},e.prototype.set_renew=function(e){this.renew=e},e.prototype.set_discount_ratio=function(e){this.discount_ratio=e},e.prototype.set_vat_id=function(e){return this.vat_id=""!==e&&i.validate_vat(this.country_code,e)?e:""},e.prototype.cache_key=function(){return[this.plan_ids.join(","),this.schedule_ids.join(","),this.get_only_license_count(),this.currencies.join(","),this.country_code,this.zip_code,this.vat_id,this.renew,this.discount_ratio].join(":")},e.prototype.to_json=function(){var e;return e=this.renew?{renew:1}:{},e=t.extend(e,{plan_ids:JSON.stringify(this.plan_ids),schedule_ids:JSON.stringify(this.schedule_ids),license_ids_and_counts:JSON.stringify(this.license_ids_and_counts),currencies:JSON.stringify(this.currencies),country_code:this.country_code,zip_code:this.zip_code,vat_id:this.vat_id,discount_percentage:JSON.stringify(100*this.discount_ratio)})},e.from_transition_view_models=function(n){var i,o,r,s,a,l,c,_,d,p,h,f,m,g,v,y,b,w,C,S,E,T,k,x;for(a=[],l=[],r=[],s=!1,o=!1,_=!1,d=!1,p=0,m=n.length;m>p;p++)if(c=n[p],a.push(c.state.plan.id),l.push(c.state.schedule.id),r.push(c.state.currency),s===!1){for(s={},y=c.state.allocated_licenses,h=0,g=y.length;g>h;h++)i=y[h],s[i.license_id]=i.license_count;o=null!=(b=c.read_only_invoice)?b.tax_country_code:void 0,d=null!=(w=c.read_only_invoice)?w.tax_zip_code:void 0,_=null!=(C=c.read_only_invoice)?C.tax_exclusion_id:void 0,d=null!=(S=c.read_only_invoice)?S.tax_zip_code:void 0}else{for(u(c.state.allocated_licenses.length===Object.keys(s).length,"License sets differ"),E=c.state.allocated_licenses,f=0,v=E.length;v>f;f++)i=E[f],u(i.license_id in s,"License sets differ"),u(s[i.license_id]===i.license_count,"License count must match");u(o===(null!=(T=c.read_only_invoice)?T.tax_country_code:void 0),"country codes must match"),u(d===(null!=(k=c.read_only_invoice)?k.tax_zip_code:void 0),"zip codes must match"),u(_===(null!=(x=c.read_only_invoice)?x.tax_exclusion_id:void 0),"VAT IDs must match")}return new e(t.uniq(a),t.uniq(l),s,t.uniq(r),o,d,_)},e}(),s=function(){function e(e){this.transition_view_model=e,this.current_total=this.transition_view_model.read_only_invoice?r.fromObject(this.transition_view_model.read_only_invoice.total):new r(0,this.transition_view_model.state.currency),this.per_license_price=this.transition_view_model.state.per_license_prices.length?r.fromObject(this.transition_view_model.state.per_license_prices[0].price):new r(0,this.transition_view_model.state.currency),this.recurring_total=r.fromObject(this.transition_view_model.state.total_recurring_price)}return e}(),a=function(){function t(e){this.default_transition_view_models=e,this._get_transition_info_for=__bind(this._get_transition_info_for,this),this._add_to_cache=__bind(this._add_to_cache,this),this.has_inflight_request=__bind(this.has_inflight_request,this),this.transition_view_model_requests={},this.transition_info_cache={},this._add_to_cache(this.default_transition_view_models)}return t.prototype.get=function(t,n){var i,o,r;return r=l.from_transition_view_models(this.default_transition_view_models),n.total_users&&r.set_only_license_count(n.total_users),n.country_code&&r.set_country_code(n.country_code),n.currency&&r.set_currencies([n.currency]),n.zip_code&&r.set_zip_code(n.zip_code),n.renew&&r.set_renew(n.renew),(n.vat_id||""===n.vat_id)&&r.set_vat_id(n.vat_id),n.discount_ratio&&r.set_discount_ratio(n.discount_ratio),i=r.cache_key(),(o=this._get_transition_info_for(i))?void t(o):this.transition_view_model_requests[i]?void 0:(this.transition_view_model_requests[i]=!0,e.ajax({url:"/business/transition-model",type:"GET",dataType:"json",data:r.to_json(),success:function(e){return function(n){var o;return delete e.transition_view_model_requests[i],o=e._add_to_cache(n),t(o)}}(this),error:function(e){return function(){return delete e.transition_view_model_requests[i]}}(this)}))},t.prototype.has_inflight_request=function(){return Object.keys(this.transition_view_model_requests).length},t.prototype._add_to_cache=function(e){var t,n,i;return t=l.from_transition_view_models(e).cache_key(),n=function(){var t,n,o;for(o=[],t=0,n=e.length;n>t;t++)i=e[t],o.push(new s(i));return o}(),this.transition_info_cache[t]=n,n},t.prototype._get_transition_info_for=function(e){return e in this.transition_info_cache?this.transition_info_cache[e]:null},t}(),{DfBTransitionInfo:s,DfBTransitionInfoFetcher:a}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/payments/pro_trial_onboarding_tour",["jquery","modules/clean/ajax","modules/clean/dbmodal","modules/clean/dbmodal_loading"],function(e,t,n){var i,o,r,s;return i=n.DBModal,o=n.DBModalStack,r=function(n){function i(e){this.options=e,this._log=__bind(this._log,this),this._redraw=__bind(this._redraw,this),this._log_and_show_current_step=__bind(this._log_and_show_current_step,this),this._finish_tour=__bind(this._finish_tour,this),this._advance_tour=__bind(this._advance_tour,this),this._go_back_tour=__bind(this._go_back_tour,this),this._hide=__bind(this._hide,this),this._show=__bind(this._show,this),i.__super__.constructor.call(this,this.options),this.vertical_offset=200}return __extends(i,n),i.show=function(e){var t;return t=new this({element_id:"pro-trial-onboarding-tour",click_out_to_close:!1,vars:{trigger:e}}),t.show()},i.prototype._show=function(){return i.__super__._show.apply(this,arguments),this._listen(),this._current_step=0,this._log_and_show_current_step(this.vars.trigger)},i.prototype._hide=function(){return i.__super__._hide.apply(this,arguments),this._unlisten(),e("#pro-trial-tour-header-bubble").removeClass("force-hidden")},i.prototype._listen=function(){return e(document).on("click",".prev-step",this._go_back_tour),e(document).on("click","button.next-step",this._advance_tour),e(document).on("click","button.finish-tour",this._finish_tour)},i.prototype._unlisten=function(){return e(document).off("click",".prev-step",this._go_back_tour),e(document).off("click","button.next-step",this._advance_tour),e(document).on("click","button.finish-tour",this._finish_tour)},i.prototype._go_back_tour=function(e){return e.preventDefault(),this._current_step-=1,this._log_and_show_current_step()},i.prototype._advance_tour=function(e){return e.preventDefault(),this._current_step+=1,this._log_and_show_current_step()},i.prototype._finish_tour=function(){return this._log("finish_trial_onboarding"),this.hide()},i.prototype._log_and_show_current_step=function(e){var t;return t=e?{trigger:e}:{},this._log("view_trial_onboarding_"+this._current_step,t),this._redraw()},i.prototype._redraw=function(){var e,t;return this.$modal_window.find(".welcome, .tour-feature").hide(),t=this.$modal_window.find(".db-modal-x"),0===this._current_step?(this.$modal_window.find(".welcome").show(),t.hide()):(e=this._current_step,this.$modal_window.find('.tour-feature[data-step-num="'+e+'"]').show(),t.show())},i.prototype._log=function(e,n){return t.WebRequest({url:"/pro/trial_onboarding_tour_log",data:{evt:e,extra_data:JSON.stringify(n)}})},i}(i),s=function(){function e(e){this.$container=e,this._listen()}return e.prototype._listen=function(){return this.$container.find(".start-tour").on("click",function(){return function(e){return e.preventDefault(),r.show("restart_tour")}}(this))},e}(),{ProTrialOnboardingTour:r,ProTrialOnboardingTourHeaderLink:s}}),define("modules/clean/payments/validation",[],function(){var e,t;return e={AT:/^ATU[0-9]{8}$/,BE:/^BE(0?|1)[0-9]{9}$/,BG:/^BG[0-9]{9,10}$/,CH:/^CHE[0-9]{9}(TVA|MWST|IVA)$/,CY:/^CY[0-9]{8}[A-Z]$/,CZ:/^CZ[0-9]{8,10}$/,DE:/^DE[0-9]{9}$/,DK:/^DK[0-9]{8}$/,EE:/^EE[0-9]{9}$/,GR:/^EL[0-9]{9}$/,ES:/^ES([A-Z][0-9]{7}[0-9A-Z]|[0-9A-Z][0-9]{7}[A-Z])$/,FI:/^FI[0-9]{8}$/,FR:/^FR[0-9A-Z]{2}[0-9]{9}$/,GB:/^GB([0-9]{9}|[0-9]{12}|GD[0-9]{3}|HA[0-9]{3})$/,HR:/^HR[0-9]{11}$/,HU:/^HU[0-9]{8}$/,IE:/^IE([0-9][0-9A-Z+*][0-9]{5}[A-Z]|[0-9]{7}WI)$/,IT:/^IT[0-9]{11}$/,LT:/^LT([0-9]{9}|[0-9]{12})$/,LU:/^LU[0-9]{8}$/,LV:/^LV[0-9]{11}$/,MT:/^MT[0-9]{8}$/,NL:/^NL[0-9]{9}B[0-9]{2}$/,NO:/^NO[0-9]{9}(MVA)?$/,PL:/^PL[0-9]{10}$/,PT:/^PT[0-9]{9}$/,RO:/^RO[0-9]{2,10}$/,SE:/^SE[0-9]{12}$/,SI:/^SI[0-9]{8}$/,SK:/^SK[0-9]{10}$/},t=function(t,n){var i;return i=e[t],i&&i.test(n)},{validate_vat:t}}),define("modules/clean/people/experiments/link_profile_service_modal",["external/react","jquery","modules/core/exception","modules/core/i18n","modules/clean/analytics","modules/clean/css","modules/clean/gandalf_util","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/viewer"],function(e,t,n,i,o,r,s,a,l,u,c,_){var d,p,h,f,m,g,v,y,b,w,C,S;return b=n.assert,S=i._,v=o.PeopleExperimentsLogger,f=l.LinkedProfileServices,y=l.ProfileServicesLinkingHandler,g=u.Modal,w=e.DOM,C=null,m={"SHOW-MODAL-V1":S("Add your contacts to share faster"),"SHOW-MODAL-V2":S("Itâs easier to share when you add your contacts")},d={description_text:function(e,t){switch(t){case"SHOW-MODAL-V1":return S("With your %(service)s contacts in Dropbox, itâs easier to share with people you know and invite them to folders.".format({service:a.to_name(e)}));case"SHOW-MODAL-V2":return S("Add your contacts from %(service)s for a faster way to share with people you know.".format({service:a.to_name(e)}))}}},p={image:function(e){switch(e){case"SHOW-MODAL-V1":return"/static/images/people_experiments/illu_import-contacts-vflbgurKv.png";case"SHOW-MODAL-V2":return"/static/images/people_experiments/illu_import-contacts-vflbgurKv.png"}}},h=e.createClass({statics:{show_modal:function(e,t,n){var i;return b(t,"User_id not provided"),i=function(e){var i,o,r;return r=_.get_viewer().get_user_by_id(t),o=a.GOOGLE,(r.email.indexOf("yahoo")>=0||r.email.indexOf("ymail")>=0)&&(o=a.YAHOO),null!=C||e.has_connected_services()||null==s.getGandalfRule("people-link-profile-on-share-experiment")||s.isGandalfInVariant("people-link-profile-on-share-experiment","CONTROL")?n():(v.log(v.LINK_PROFILE_MODAL_SHOW,t=t,i={service:o}),C=new h({service:o,sharing_handler:n,user_id:t}),g.showInstance(C))},f.get_linked_profile_services_for_user(t,i)}},propTypes:{service:e.PropTypes.string.isRequired,sharing_handler:e.PropTypes.func.isRequired,user_id:e.PropTypes.number.isRequired},getInitialState:function(){return{link_text:"Add "+a.to_name(this.props.service)+" contacts"}},componentWillMount:function(){return r.require_css("/static/css/people_experiments/link_profile_service_modal-vflG9Q0Lc.css")},linking_callback:function(e){var t,n,i;t=v.LINK_PROFILE_MODAL_LINK_ERROR,e.success&&(t=v.LINK_PROFILE_MODAL_LINK_SUCCESS),v.log(t,i=this.props.user_id,n={service:this.props.service,link_success:e.success}),y.show_import_notifications(e),this.props.sharing_handler(),this.refs.link_account_modal.close()},load_sharing_modal:function(e){var n,i;return n={service:this.props.service,"event-type":e.type,"event-target-class":t(e.target).attr("class")},"click"===e.type&&t(e.target).hasClass("dbmodal-button")&&(v.log(v.LINK_PROFILE_MODAL_NOT_NOW,i=this.props.user_id,n=n),this.props.sharing_handler()),v.log(v.LINK_PROFILE_MODAL_DISMISS,i=this.props.user_id,n=n)},link_service:function(e){var t,n,i;e.preventDefault(),v.log(v.LINK_PROFILE_MODAL_LINK_PROFILE,i=this.props.user_id,t={service:this.props.service}),n=new y,n.auth_service_with_user(this.props.service,this.props.user_id,this.linking_callback,"link-profile-modal-experiment")},render:function(){var e,t;return e={acceptButtonText:this.state.link_text,dismissButtonText:"Not now",onAccept:this.link_service,onDismiss:this.load_sharing_modal,ref:"link_account_modal",style:"clean"},t=s.getGandalfRule("people-link-profile-on-share-experiment"),g(e,w.div({className:"modal-body-wrapper"},w.h1({className:"modal-title"},m[t]),w.p({className:"modal-description-1"},d.description_text(this.props.service,t)),w.img({className:"modal-image",src:p.image(t)}),"SHOW-MODAL-V2"===t?w.div({className:"modal-privacy-message"},c({className:"privacy-lock",group:"web",name:"lock"}),w.p({className:"privacy-text"},S("We wonât email your contacts without your permission."))):void 0))}}),{LinkProfileServiceModal:h}}),define("modules/clean/photos/batch_thumb_loader",["jquery","modules/clean/ajax","modules/core/uri"],function(e,t,n){var i;return i=function(){function i(e){var t,n;t=e.batch_size,n=e.max_parallel_requests,this.on_batch=e.on_batch,this.batch_logger=e.batch_logger,this.on_batch_success=e.on_batch_success,this.batch_size=t||this.DEFAULT_BATCH_SIZE,this.max_parallel_requests=n||this.DEFAULT_MAX_PARALLEL_REQUESTS,this.thumb_url_queue=[],this.batch_queue=[],this.callback_by_id={},this.request_ids_by_url={},this.num_requests_in_flight=0,this.flushing=!1,this.next_thumb_request_id=0,this.next_batch_id=0,this.cancelled_urls={},this.outstanding_batches={}}return i.prototype.DEFAULT_BATCH_SIZE=16,i.prototype.DEFAULT_MAX_PARALLEL_REQUESTS=6,i.prototype.MAX_URL_LENGTH=6e3,i.prototype.queue_thumb=function(t,n,i){var o,r,s;return null==i&&(i={}),null==i.start_flushing&&(i.start_flushing=!0),null==i.prioritize_batch&&(i.prioritize_batch=!1),t?e.support.cors&&Constants.BATCH_THUMB_ENDPOINTS.length?(r=this.next_thumb_request_id,this.next_thumb_request_id++,(null!=(s=this.request_ids_by_url[t])?s.length:void 0)>0||(this.thumb_url_queue.push(t),this.request_ids_by_url[t]=[]),this.request_ids_by_url[t].push(r),this.callback_by_id[r]={url:t,callback:n},this.thumb_url_queue.length>=this.batch_size&&(i.prioritize_batch?this.batch_queue.unshift(this.thumb_url_queue.splice(0,this.batch_size)):this.batch_queue.push(this.thumb_url_queue.splice(0,this.batch_size)),i.start_flushing&&this._send_batch_requests()),r):(o=!0,"function"==typeof n&&n(t,o),null):null},i.prototype.cancel_thumb=function(e){var t,n,i,o,r,s,a,l,u,c,_,d,p,h,f,m,g,v,y,b,w,C,S,E,T;if(null!=this.callback_by_id[e]){for(u=this.callback_by_id[e].url,delete this.callback_by_id[e],w=this.request_ids_by_url[u],o=_=0,f=w.length;f>_;o=++_)if(r=w[o],r===e){this.request_ids_by_url[u].splice(o,1);break}if(0===this.request_ids_by_url[u].length){for(delete this.request_ids_by_url[u],C=this.thumb_url_queue,o=d=0,m=C.length;m>d;o=++d)if(l=C[o],l===u)return void this.thumb_url_queue.splice(o,1);for(S=this.batch_queue,o=p=0,g=S.length;g>p;o=++p)for(n=S[o],s=h=0,v=n.length;v>h;s=++h)if(l=n[s],l===u)return n.splice(s,1),void(0===n.length&&this.batch_queue.splice(o,1));this.cancelled_urls[u]=1,T=[];for(i in this.outstanding_batches){for(E=this.outstanding_batches[i],c=E.urls,a=E.request,t=!0,b=0,y=c.length;y>b;b++)u=c[b],t=null!=this.cancelled_urls[u]&&t;if(t){a.abort();break}T.push(void 0)}return T}}},i.prototype.prioritize_thumb=function(){},i.prototype.flush=function(){for(;this.thumb_url_queue.length;)this.batch_queue.push(this.thumb_url_queue.splice(0,this.batch_size));return this._send_batch_requests()},i.prototype.reset=function(e){var t;return t=e.batch_size,this.batch_logger=e.batch_logger,this.batch_size=t||this.DEFAULT_BATCH_SIZE},i.prototype.clear=function(){return this.thumb_url_queue=[]},i.prototype.pause=function(){return this.flushing=!1},i.prototype._send_batch_requests=function(){var e,n,i,o,r,s,a;if(!(0===this.batch_queue.length||this.num_requests_in_flight>=this.max_parallel_requests))return this.flushing=!0,s=this.batch_queue.shift(),a=this._generate_request_params(s),i=a[0],o=a[1],n=a[2],"function"==typeof this.on_batch&&this.on_batch(s),e=this.next_batch_id,this.next_batch_id++,this.num_requests_in_flight++,r=t.AuthenticatedRequest({xhrFields:{withCredentials:!0},url:i,type:o,data:n,success:this._success.bind(this,s),error:this._error.bind(this,s),complete:this._complete.bind(this,e)}),this.outstanding_batches[e]={urls:s,request:r},this._send_batch_requests()},i.prototype._success=function(e,t){var n,i,o,r,s,a,l,u,c,_,d,p,h,f,m,g,v;for(s=t.split("\n"),a={},_=0,h=e.length;h>_;_++)c=e[_],a[c]=!1;for(r=d=0,f=s.length;f>d;r=++d)o=s[r],l=o.indexOf(":"),-1!==l&&(u=o.substring(0,l).split("-"),i=parseInt(u[0],10),n=o.substring(l+1),c=e[i],a[c]=!0,this._call_callback(c,n),"function"==typeof this.batch_logger&&this.batch_logger(r,e.length));for("function"==typeof this.on_batch_success&&this.on_batch_success(e),g=e.filter(function(e){return!a[e]}),v=[],p=0,m=g.length;m>p;p++)c=g[p],v.push(null==this.cancelled_urls[c]?this._call_callback(c,c):void 0);return v},i.prototype._error=function(e){var t,n,i,o;for(o=[],n=0,i=e.length;i>n;n++)t=e[n],o.push(this._call_callback(t,t));return o},i.prototype._complete=function(e){var t,n,i,o,r,s;for(this.num_requests_in_flight--,s=this.outstanding_batches[e],i=s.urls,t=s.request,o=0,r=i.length;r>o;o++)n=i[o],delete this.cancelled_urls[n];return delete this.outstanding_batches[e],this.flushing?this._send_batch_requests():void 0},i.prototype._call_callback=function(e,t){var n,i,o,r,s;if(n=0===t.indexOf("data:image")?t:e,null!=this.request_ids_by_url[e])for(s=this.request_ids_by_url[e],o=0,r=s.length;r>o;o++)i=s[o],this.callback_by_id[i].callback(n,!1),delete this.callback_by_id[i];return delete this.request_ids_by_url[e]},i.prototype._generate_request_params=function(t){var i,o,r,s,a,l,u,c;return u=e.map(t,function(e){return n.parse(e).setScheme().setAuthority().toString()}),c=JSON.stringify(u),s=Math.abs(this._hash_string_to_int(c)),o=s%Constants.BATCH_THUMB_ENDPOINTS.length,i=Constants.BATCH_THUMB_ENDPOINTS[o],l={image_urls:c,parallel:!0},r=n.parse(i).setQuery(l).toString(),a=r.length>this.MAX_URL_LENGTH?"POST":"GET",[i,a,l]},i.prototype._hash_string_to_int=function(e){var t,n,i,o,r;if(n=0,0===e.length)return n;for(i=o=0,r=e.length;r>=0?r>o:o>r;i=r>=0?++o:--o)t=e.charCodeAt(i),n=(n<<5)-n+t;return n},i}()}),define("modules/clean/photos/legacy_thumb_loader",["jquery","modules/clean/photos/batch_thumb_loader","modules/clean/sprite"],function(e,t,n){var i;return i={MAX_THUMB_BATCH_REQUESTS:24,batch_load_thumbs:function(i,o,r,s){var a,l,u,c,_,d,p,h,f,m,g;for(d=e.grep(i,function(t){return e(t).data("src")}),this.img_map={},h=0,m=d.length;m>h;h++)l=d[h],c=String(e(l).data("src")),null==(p=this.img_map)[c]&&(p[c]=[]),this.img_map[c].push(l);for(this.instance?this.instance.reset({batch_size:o,batch_logger:s}):this.instance=new t({batch_size:o,max_parallel_requests:this.MAX_THUMB_BATCH_REQUESTS,on_batch:function(t){return function(n){var i,o,r,s,a;for(a=[],r=0,s=n.length;s>r;r++)o=n[r],i=e(t.img_map[o]),i.data("src",null),a.push(i.data("loading-src",o));return a}}(this),batch_logger:s}),u=[],f=0,g=d.length;g>f;f++)l=d[f],a=e(l),_=a.data("src"),this.instance.queue_thumb(_,function(e,t,i,o){return o||t.data("loading-src")?(t.data("loading-src",null),0===i.indexOf("data:image")?(t.attr("src",i),"function"==typeof r?r(t[0]):void 0):(t.error(function(){return t.attr("src",t.data("fail-src")||n.SPACER)}),t.load(function(){return"function"==typeof r?r(t[0]):void 0}),t.attr("src",i))):void 0}.bind(this,_,a));return this.instance.flush()},clear_all_pending_batches:function(){var e;return null!=(e=this.instance)?e.clear():void 0}}}),define("modules/clean/photos/photos_engagement_logger",["jquery","modules/clean/ajax"],function(e,t){var n;return n=function(){function n(){}return n.Platform={WEB:"web",WEB_CAROUSEL:"web_carousel"},n.PROMO_BANNER_CLICKED="promo_banner_clicked",n.PROMO_BANNER_BUTTON_CLICKED="promo_banner_button_clicked",n.PROMO_BANNER_SURVEY_RESPONSE="promo_banner_survey_response",n.CAROUSEL_WEB_PROMO_OPT_IN_MODAL_CONFIRM="carousel_web_promo_opt_in_modal_confirm",n.CAROUSEL_NAV_LINK_CLICK="carousel_nav_link_click",n.PHOTOS_NAV_LINK_CLICK="photos_nav_link_click",n.WEBAPP_LOGO_CLICKED="webapp_logo_clicked",n.WEBAPP_BACK_TO_DROPBOX_CLICKED="webapp_back_to_dropbox_clicked",n.WEBAPP_VIEW_TIMELINE="webapp_view_gallery",n.WEBAPP_VIEW_SHARED_ALBUM="webapp_view_conversations",n.WEBAPP_VIEW_SHARED_ALBUMS_GRID="webapp_view_shared_albums_grid",n.WEBAPP_VIEW_ALBUMS_GRID="webapp_view_albums_grid",n.WEBAPP_VIEW_ALBUM="webapp_view_albums",n.WEBAPP_VIEW_FLASHBACK="webapp_view_flashback",n.WEBAPP_VIEW_DUPLICATES="webapp_view_duplicates",n.WEBAPP_ACTION_ADD_TO_ALBUM="webapp_action_add_to_album",n.WEBAPP_ACTION_REMOVE_FROM_ALBUM="webapp_action_remove_from_album",n.WEBAPP_ACTION_DOWNLOAD="webapp_action_download",n.WEBAPP_ACTION_SHOW_IN_FOLDER="webapp_action_show_in_folder",n.WEBAPP_ACTION_DELETE="webapp_action_delete",n.WEBAPP_SHOW_EXCLUDE_MODAL="webapp_show_exclude_modal",n.ATTEMPT_EXCLUDE_CAROUSEL_SUBFOLDER="attempt_exclude_carousel_subfolder",n.ATTEMPT_EXCLUDE_CU_FOLDER="attempt_exclude_cu_folder",n.ATTEMPT_EXCLUDE_CAROUSEL_FOLDER="attempt_exclude_carousel_folder",n.ATTEMPT_EXCLUDE_DROPBOX_ROOT="attempt_exclude_dropbox_root",n.WEBAPP_GALLERY_SELECT_EVENT="webapp_gallery_select_event",n.WEBAPP_GALLERY_DESELECT_EVENT="webapp_gallery_deselect_event",n.WEBAPP_GALLERY_SELECT_ITEM="webapp_gallery_select_item",n.WEBAPP_GALLERY_DESELECT_ITEM="webapp_gallery_deselect_item",n.WEBAPP_GALLERY_TIME_FIRST_ITEM="webapp_gallery_time_first_item",n.WEBAPP_GALLERY_TIME_EVENTS_OUTLINE="webapp_gallery_time_events_outline",n.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_EVENTS="webapp_gallery_time_first_visible_events",n.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_THUMBS_BATCH="webapp_gallery_time_first_visible_thumbs_batch",n.WEBAPP_GALLERY_EMPTY="webapp_gallery_empty",n.WEBAPP_GALLERY_CONTEXT_MENU_SHOWN="webapp_gallery_context_menu_shown",n.WEBAPP_LIGHTBOX_OPEN="webapp_lightbox_open",n.WEBAPP_LIGHTBOX_DOWNLOAD="webapp_lightbox_download",n.WEBAPP_LIGHTBOX_SELECT_ITEM="webapp_lightbox_select_item",n.WEBAPP_LIGHTBOX_DESELECT_ITEM="webapp_lightbox_deselect_item",n.WEBAPP_LIGHTBOX_FORWARD="webapp_lightbox_forward",n.WEBAPP_LIGHTBOX_BACK="webapp_lightbox_back",n.WEBAPP_LIGHTBOX_SHARE="webapp_lightbox_share",n.WEBAPP_LIGHTBOX_CLOSE_ICON="webapp_lightbox_close_icon",n.WEBAPP_LIGHTBOX_CLOSE_KEY="webapp_lightbox_close_key",n.WEBAPP_TIMELINE_NAVIGATION_SHOWN="webapp_timeline_navigation_shown",n.WEBAPP_TIMELINE_NAVIGATION_TRACK_CLICKED="webapp_timeline_navigation_track_clicked",n.WEBAPP_TIMELINE_NAVIGATION_SCRUBBER_DRAGGED="webapp_timeline_navigation_scrubber_dragged",n.WEBAPP_SHARE_CART_CANCEL="webapp_share_cart_cancel",n.WEBAPP_SHARE_CART_SHARE="webapp_share_cart_share",n.WEBAPP_SHARE_CART_SHARE_FACEBOOK="webapp_share_cart_share_facebook",n.WEBAPP_SHARE_CART_SHARE_TWITTER="webapp_share_cart_share_twitter",n.WEBAPP_SHARE_CART_ITEM_CLICKED="webapp_share_cart_item_clicked",n.WEBAPP_SHARE_DROPDOWN_SEND_LINK="webapp_share_dropdown_send_link",n.WEBAPP_SHARE_DROPDOWN_SHARED_ALBUM="webapp_share_dropdown_shared_album",n.WEBAPP_GALLERY_DELETE_MODAL_CONFIRMED="webapp_gallery_delete_modal_confirmed",n.WEBAPP_GALLERY_DELETE_MODAL_CANCELED="webapp_gallery_delete_modal_canceled",n.WEBAPP_GALLERY_REMOVE_FROM_ALBUM_MODAL_CONFIRMED="webapp_gallery_remove_from_album_modal_confirmed",n.WEBAPP_GALLERY_REMOVE_FROM_ALBUM_MODAL_CANCELED="webapp_gallery_remove_from_album_modal_canceled",n.WEBAPP_SHARE_COMPOSER_RECIPIENT="webapp_share_composer_recipient",n.WEBAPP_SHARE_COMPOSER_MESSAGE="webapp_share_composer_message",n.WEBAPP_SHARE_COMPOSER_SHARE="webapp_share_composer_share",n.WEBAPP_SHARE_COMPOSER_TWITTER="webapp_share_composer_twitter",n.WEBAPP_SHARE_COMPOSER_FACEBOOK="webapp_share_composer_facebook",n.WEBAPP_SHARE_COMPOSER_LINK="webapp_share_composer_link",n.WEBAPP_SHARE_WITH_SELF_ATTEMPT="webapp_share_with_self_attempt",n.WEBAPP_CONVERSATIONS_ROOM_CLICKED="webapp_conversations_room_clicked",n.WEBAPP_CONVERSATIONS_VIEW_SETTINGS="webapp_conversations_view_settings",n.WEBAPP_CONVERSATIONS_CLOSE_SETTINGS="webapp_conversations_close_settings",n.WEBAPP_CONVERSATIONS_TIME_FIRST_POST="webapp_conversations_time_first_post",n.WEBAPP_CONVERSATIONS_EMPTY="webapp_conversations_empty",n.WEBAPP_CONVERSATIONS_CHAT_VIEW_CLICKED="webapp_conversations_chat_view_clicked",n.WEBAPP_CONVERSATIONS_GALLERY_VIEW_CLICKED="webapp_conversations_gallery_view_clicked",n.WEBAPP_CONVERSATIONS_CHAT_VIEW_LOAD_MORE="webapp_conversations_chat_view_load_more",n.WEBAPP_CONVERSATIONS_GALLERY_VIEW_LOAD_MORE="webapp_conversations_gallery_view_load_more",n.WEBAPP_SHARING_COMMENT_SUBMIT="webapp_sharing_comment_submit",n.WEBAPP_SHARING_GALLERY_ADD_PHOTOS="webapp_sharing_gallery_add_photos",n.WEBAPP_SHARING_COPY_LINK="webapp_sharing_copy_link",n.WEBAPP_SHARING_LIKE_ITEM="webapp_sharing_like_item",n.WEBAPP_SHARING_UNLIKE_ITEM="webapp_sharing_unlike_item",n.WEBAPP_FLASHBACK_SELECT_EVENT="webapp_flashback_select_event",n.WEBAPP_FLASHBACK_SELECT_ITEM="webapp_flashback_select_item",n.WEBAPP_FLASHBACK_CLICK_ITEM="webapp_flashback_click_item",n.WEBAPP_FLASHBACK_CLICK_SHARE="webapp_flashback_click_share",n.WEBAPP_FLASHBACK_SURVEY_RESPONSE="webapp_flashback_survey_response",n.WEBAPP_FLASHBACK_SURVEY_FREE_RESPONSE="webapp_flashback_survey_free_response",n.WEBAPP_FLASHBACK_SHARE_ALL="webapp_flashback_share_all",n.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_FACEBOOK="webapp_flashback_share_single_item_facebook",n.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_TWITTER="webapp_flashback_share_single_item_twitter",n.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_LINK="webapp_flashback_share_single_item_link",n.WEBAPP_REPLY_COMPOSER_CLICKED="webapp_reply_composer_clicked",n.WEBAPP_REPLY_COMPOSER_ADD_PHOTOS="webapp_reply_composer_add_photos",n.WEBAPP_REPLY_COMPOSER_SEND="webapp_reply_composer_send",n.WEBAPP_OPT_IN_BANNER_SHOWN="webapp_opt_in_banner_shown",n.WEBAPP_OPT_IN_BANNER_CONFIRM="webapp_opt_in_banner_confirm",n.WEBAPP_OPT_OUT_BANNER_SHOWN="webapp_opt_out_banner_shown",n.WEBAPP_OPT_OUT_BANNER_CONFIRM="webapp_opt_out_banner_confirm",n.WEBAPP_OPT_OUT_MODAL_CONFIRM="webapp_opt_out_modal_confirm",n.PUBLIC_LASS_INPUT_CLICK="public_lass_input_click",n.PUBLIC_LASS_INPUT_MESSAGE="public_lass_input_message",
n.PUBLIC_LASS_INPUT_SUBMIT="public_lass_input_submit",n.PUBLIC_LASS_ADD_PHOTOS="public_lass_add_photos",n.PUBLIC_LASS_LIKE_CLICK="public_lass_like_click",n.PUBLIC_LASS_START_LOGIN="public_lass_start_login",n.PUBLIC_LASS_FINISH_LOGIN="public_lass_finish_login",n.PHOTO_SPACE_START_LOGIN="photo_space_start_login",n.PHOTO_SPACE_FINISH_LOGIN="photo_space_finish_login",n.PHOTO_SPACE_SUBSCRIBE="photo_space_subscribe",n.MOBILE_DROPBOX_FLASHBACK_SHARE_CART_SHARE="share_cart_share",n.MOBILE_DROPBOX_FLASHBACK_SHARE_CART_CANCEL="share_cart_cancel",n.MOBILE_DROPBOX_FLASHBACK_LINK_GENERATED="link_generated",n.MOBILE_DROPBOX_FLASHBACK_SHARE_DONE="share_done",n.first_log_sent=!1,n.logs_queued=[],n.HACK_prefix_to_replace=null,n.HACK_prefix_replace_with=null,n.HACK_new_platform=null,n.HACK_extra={},n.hack_all_log_prefixes_and_platform=function(e){var t,i,o,r;return r=e.prefix_to_replace,o=e.prefix_replace_with,i=e.new_platform,t=e.extra,n.HACK_prefix_to_replace=r,n.HACK_prefix_replace_with=o,n.HACK_new_platform=i,n.HACK_extra=t},n.apply_hacky_log_overrides=function(t,i,o){var r,s;return n.HACK_prefix_to_replace?(s=0===t.indexOf(n.HACK_prefix_to_replace)?t.replace(n.HACK_prefix_to_replace,n.HACK_prefix_replace_with):0!==t.indexOf(n.HACK_prefix_replace_with)?n.HACK_prefix_replace_with+t:t,r=e.extend({},o,this.HACK_extra),[s,n.HACK_new_platform,r]):[t,i,o]},n.log_and_send=function(e,i,o){var r;return null==i&&(i={}),null==o&&(o=n.Platform.WEB),r=n.apply_hacky_log_overrides(e,o,i),e=r[0],o=r[1],i=r[2],t.AuthenticatedRequest({url:"/photos/photos_engagement_log",data:{event:e,extra:JSON.stringify(i),platform:o}})},n.log=function(e,t,i){var o,r;return n.first_log_sent?(null==t&&(t={}),null==i&&(i=n.Platform.WEB),r=n.apply_hacky_log_overrides(e,i,t),e=r[0],i=r[1],t=r[2],o={event:e,extra:t,platform:i},n.logs_queued.push(o)):(n.log_and_send(e,t,i),void(n.first_log_sent=!0))},n.log_carousel=function(e,t){return n.log(e,t,n.Platform.WEB_CAROUSEL)},n._send_log_batch=function(){return n.logs_queued.length?(t.AuthenticatedRequest({url:"/photos/photos_engagement_batch_log",data:{events:JSON.stringify(n.logs_queued)}}),n.logs_queued=[]):void 0},n}(),setInterval(n._send_log_batch,1e4),e(window).unload(n._send_log_batch),n}),define("modules/clean/previews/file_viewer_utils",["jquery"],function(e){var t;return t=function(){return e("#file-viewer")},{getFileViewerElement:t}}),define("modules/clean/previews/pdf_loader",["external/underscore","modules/clean/ajax","modules/clean/frame_messenger","modules/clean/gandalf_util","modules/core/uri"],function(e,t,n,i,o){var r,s,a;return a=["viewer-initialized"],r="iframe.pdfjs",s=function(){function s(){}return s.prototype._frameMessenger=new n,s.prototype._fileUrl=null,s.prototype._options={},s.prototype.startListening=function(){return this._frameMessenger.configureChildMessaging(r,this.handleTrustedMesssageFromChild.bind(this),a),this._frameMessenger.startListening()},s.prototype.stopListening=function(){return this._frameMessenger.stopListening()},s.prototype.handleTrustedMesssageFromChild=function(e){switch(e.action){case"viewer-initialized":return this._sendOpenFileAction()}},s.prototype.openFile=function(n,r){var s,a,l,u;return null==r&&(r={}),null!=n?(e.defaults(r,{disableRange:!i.getGandalfRule("docpreview-pdf-range-request-enabled"),presentationMode:!1}),s=null,i.getGandalfRule("docpreview-debug-force-test-pdf")?s="test.pdf":i.getGandalfRule("docpreview-debug-force-test-deck-pdf")&&(s="test-deck.pdf"),null!=s&&(l=o.parse(n),u=l.getQuery(),u.canned_file_name=s,l.setQuery(u),n=l.toString()),l=o.parse(n.toString()),0===l.getPath().toString().indexOf("/pri")?(a=l.getPath().toString().slice(8),l.setPath("/pri/get_content_url"),t.WebRequest({url:l.toString(),data:{path:a},success:function(e){return function(t){var n;return n=JSON.parse(t),e._finishOpenFile(n.url,r)}}(this)})):this._finishOpenFile(n,r)):void 0},s.prototype._finishOpenFile=function(e,t){return null==t&&(t={}),this._fileUrl=e.toString(),this._options=t,this._sendOpenFileAction()},s.prototype._sendOpenFileAction=function(){return this._frameMessenger.postMessageToChildren("open-file",{fileUrl:this._fileUrl,options:this._options})},s}()}),define("modules/clean/profile_services/profile_services_constants",["modules/core/exception","modules/core/i18n"],function(e,t){var n,i,o;return i=e.assert,o=t._,n={GOOGLE:"1",YAHOO:"2",FACEBOOK:"3",TWITTER:"4",YAHOO_LEGACY:"5",MOBILE:"6",NEVER_CONNECTED:0,WAS_CONNECTED:1,IS_CONNECTED:2,VARIOUS:"-1",NONE:"-2",services:function(){return[this.GOOGLE,this.YAHOO,this.FACEBOOK,this.TWITTER,this.YAHOO_LEGACY]},contact_services:function(){return[this.GOOGLE,this.YAHOO,this.FACEBOOK]},to_img:function(e){switch(e){case this.GOOGLE:return"/static/images/icons/gmail_logo28-vflpyJYQh.png";case this.YAHOO:case this.YAHOO_LEGACY:return"/static/images/icons/yahoo_mail_logo28-vflNeyC7Q.png";case this.FACEBOOK:return"/static/images/icons/facebook_logo28-vflIeRTN-.png";default:return i(!1,"Should never get ProfileServicesConstants.to_img with service: "+e)}},to_name:function(e){switch(e){case this.GOOGLE:return o("Gmail");case this.YAHOO:return o("Yahoo! Mail");case this.FACEBOOK:return o("Facebook");case this.VARIOUS:return o("Email");case this.YAHOO_LEGACY:return o("Yahoo! Mail");default:return i(!1,"Should never get ProfileServicesConstants.to_name with service: "+e)}},logging_identifiers:function(e){switch(e){case this.GOOGLE:return"google";case this.YAHOO:return"yahoo";case this.FACEBOOK:return"facebook";case this.VARIOUS:return"email";case this.YAHOO_LEGACY:return"yahoo_legacy";default:return i(!1,"Should never get ProfileServicesConstants.logging_identifiers with service: "+e)}}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/profile_services/profile_services_link",["jquery","modules/core/exception","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/ajax","modules/clean/profile_services/profile_services_constants","modules/clean/user","modules/clean/viewer"],function(e,t,n,i,o,r,s,a,l){var u,c,_,d;return _=t.assert,d=n._,u=function(){function t(t,n){return this.user_id=t,null==n&&(n=null),this.service_was_connected=__bind(this.service_was_connected,this),this.service_is_connected=__bind(this.service_is_connected,this),this.has_unconnected_services=__bind(this.has_unconnected_services,this),this.has_connected_services=__bind(this.has_connected_services,this),this.connected_accounts_for_service=__bind(this.connected_accounts_for_service,this),this.get_or_update_connected_state=__bind(this.get_or_update_connected_state,this),this._update_on_auth_event=__bind(this._update_on_auth_event,this),_(this.user_id,"No user id provided"),this._connected_services={},this.is_updated=!1,this.get_or_update_connected_state(!0,n),e(document).on("db:profile_service:auth_complete",this._update_on_auth_event),e(document).on("db:profile_service:deauth_complete",this._update_on_auth_event),this}return t._LINKED_PROFILE_SERVICES={},t.get_linked_profile_services_for_user=function(e,n){var i;return null==n&&(n=null),_(e,"No user_id: LinkedProfileServices.get_linked_profile_services_for_user()"),i=this._LINKED_PROFILE_SERVICES[e],null!=i?i.get_or_update_connected_state(!1,n):(i=new t(e,n),this._LINKED_PROFILE_SERVICES[e]=i),i},t.prototype._update_on_auth_event=function(e){return e.user_id===this.user_id?(this.is_updated=!1,this.get_or_update_connected_state(!0)):void 0},t.prototype.get_or_update_connected_state=function(e,t){return null==e&&(e=!1),null==t&&(t=null),this.is_updated&&!e?"function"==typeof t?t(this):void 0:r.WebRequest({url:"/profile_services/connected_services",subject_user:this.user_id,dataType:"json",success:function(e){return function(n){return e._connected_services=n,e.is_updated=!0,"function"==typeof t?t(e):void 0}}(this)})},t.prototype.connected_accounts_for_service=function(t){return this._connected_services[t]?e.map(this._connected_services[t],function(e){return e.source_id}):[]},t.prototype.has_connected_services=function(){var e,t,n,i;for(i=s.services(),t=0,n=i.length;n>t;t++)if(e=i[t],this.service_is_connected(e))return!0;return!1},t.prototype.has_unconnected_services=function(e){var t,n,i,o;for(null==e&&(e=!1),n=s.services(),e&&(n=s.contact_services()),i=0,o=n.length;o>i;i++)if(t=n[i],t!==s.YAHOO_LEGACY&&!this.service_is_connected(t))return!0;return!1},t.prototype.service_is_connected=function(e){var t,n,i,o;if(_(__indexOf.call(s.services(),e)>=0,"Not a valid profile service"),null==this._connected_services[e])return!1;for(o=this._connected_services[e],n=0,i=o.length;i>n;n++)if(t=o[n],t.connection_state===s.IS_CONNECTED)return!0;return!1},t.prototype.service_was_connected=function(e){var t,n,i,o;if(_(__indexOf.call(s.services(),e)>=0,"Not a valid profile service"),null==this._connected_services[e])return!1;for(o=this._connected_services[e],n=0,i=o.length;i>n;n++)if(t=o[n],t.connection_state===s.WAS_CONNECTED)return!0;return!1},t}(),c=function(){function t(){return this.deauth_service=__bind(this.deauth_service,this),this._auth_service=__bind(this._auth_service,this),this._popup_window=null,this}return t.show_import_notifications=function(e){if(!e.success)return i.error(null!=e.err_msg?e.err_msg:d("There was a problem completing this request."));switch(e.provider){case s.GOOGLE:return i.success(d("Imported Gmail Contacts."));case s.YAHOO:return i.success(d("Imported Yahoo! Mail contacts."));case s.FACEBOOK:return i.success(d("Successfully connected to Facebook."))}},t.prototype._auth_service=function(t,n,i,r,a){var l,u;return null==i&&(i=null),null==r&&(r=null),null==a&&(a=null),l=function(t){return function(n){var i;return t._popup_window===n.popup_window?(e(document).off("db:profile_service:auth_complete",l),null!=(i=t._popup_window)&&i.close(),t._popup_window=null,"function"==typeof r?r(n):void 0):void 0}}(this),e(document).on("db:profile_service:auth_complete",l),u={service:t},a&&(u.referrer=a),u[Constants.UID_PARAM_NAME]=null!=i?i.id:void 0,this._popup_window=window.open(String(o({path:n,query:u})),s.to_name(t),"width=600,height=600,resizable=1,scrollbars=1")},t.prototype.auth_service_with_user=function(e,t,n,i){var o,r;return null==n&&(n=null),null==i&&(i=null),_(e,"No service provided"),_(t,"No user_id provided"),r=l.get_viewer().get_user_by_id(t),_(r,"No user for user_id "+t),o="/profile_services/auth_link_redirect",this._auth_service(e,o,r,n,i)},t.prototype.auth_service_create_user_if_needed=function(e,t,n){var i;return null==t&&(t=null),null==n&&(n=null),_(e,"No service provided"),i="/profile_services/auth_create_redirect",this._auth_service(e,i,null,t,n)},t.prototype.deauth_service=function(t,n,i,o){var a,l;return null==i&&(i=null),null==o&&(o=null),l=function(){return function(s){return s.service_is_connected(t)?(null!=i&&_(__indexOf.call(s.connected_accounts_for_service(t),i)>=0,"Service is not currently connected"),r.WebRequest({url:"/profile_services/unlink",subject_user:n,data:{service:t,source_id:i},success:function(){return e(document).trigger(e.Event("db:profile_service:deauth_complete",{user_id:n})),"function"==typeof o?o(!0):void 0},error:function(){return"function"==typeof o?o(!1):void 0}})):void("function"==typeof o&&o(!0))}}(this),_(__indexOf.call(s.services(),t)>=0,"Not a valid profile service"),_(n,"No user_id provided"),n=parseInt(n),a=u.get_linked_profile_services_for_user(n,l)},t}(),{LinkedProfileServices:u,ProfileServicesLinkingHandler:c}}),define("modules/clean/profile_services/third_party_signup",["jquery","modules/clean/ajax","modules/clean/base64","modules/core/browser","modules/core/cookies","modules/core/uri"],function(e,t,n,i,o,r){var s;return s=function(){function t(){}return t.init=function(e,t,n){return this.handle_picture_url(e,t,n,!0)},t.handle_picture_url=function(t,n,o,s){var a,l;if(a=null,t)try{l=new XMLHttpRequest,l.open("GET",t,!0),l.responseType="blob",l.onload=function(){var t;return 200===l.status?(t=l.getResponseHeader("content-type")||"",a=new Blob([l.response],{type:t}),e("#profile-picture img").attr("src",URL.createObjectURL(a)),e("#profile-picture").show()):void 0},l.send()}catch(u){}return e(document).on("db:register:success",function(e){return function(t,l){var u;return u=function(){var e,t;return s?(t=r.parse(l.redirect_url||"/"),n&&(t=r.parse(n)),e={success:!0},o&&(e.extra_data=o),t.setQuery(e),i.unsafeRedirect(t)):void 0},null!=a?e.upload_account_photo(l.id,a,u):u()}}(this))},t.upload_account_photo=function(e,t,n){var i,s,a;return s=r({authority:Constants.BLOCK_CLUSTER,path:"/upload_account_photo",query:{t:o.read(Constants.JS_CSRF_COOKIE),_subject_uid:e}}),i=new FormData,i.append("file",t),a=new XMLHttpRequest,a.open("POST",s,!0),a.withCredentials=!0,a.onload=function(){return n()},a.onerror=function(){return n()},a.send(i)},t}()}),define("modules/clean/react/activity/annotation_button",["external/react","external/underscore","modules/clean/datetime","modules/clean/annotations/annotation"],function(e,t,n,i){var o,r,s,a,l,u,c,_,d,p,h,f,m,g,v,y;return o=i.Annotation,a=i.AnnotationTypes,s=i.AnnotationSubtypes,y=e.DOM,u=610,l=790,m=6,v=20,g=28,p=14,d=22,_=20,c=25,f=20,h=28,r=e.createClass({displayName:"AnnotationButton",propTypes:{annotation:e.PropTypes.object,revision:e.PropTypes.object,isOldRevision:e.PropTypes.bool,onAnnotationButtonMouseUp:e.PropTypes.func},getDefaultProps:function(){return{}},getInitialState:function(){return{}},_getAnnotationThumbnail:function(){var e,n,i,o,r,s,l,u,c,_,d,p,h,f,g,v,b,w,C,S,E;switch(e=this.props.annotation,e.type){case a.MARKER:return i=this._calculateThumbnailUIWidth(null!=(w=e.getFirstPdfCoordinates())?w.x:void 0),o=this._calculateThumbnailUIHeight(null!=(C=e.getFirstPdfCoordinates())?C.y:void 0),y.div({className:"annotation-thumbnail-page__marker",style:{left:i+m/2,top:o+m/2}});case a.HIGHLIGHT:for(d=[],c=e.getFirstPdfPage(),S=e.pdf_coordinates,f=0,v=S.length;v>f;f++)n=S[f],n.page===c&&d.push(y.div({className:"annotation-thumbnail-page__highlight",style:{left:this._calculateThumbnailUIWidth(n.coordinates[0].x),top:this._calculateThumbnailUIHeight(n.coordinates[0].y),width:this._calculateThumbnailUIWidth(n.coordinates[1].x-n.coordinates[0].x)}}));return d;case a.REGION:for(d=[],c=e.getFirstPdfPage(),E=e.pdf_coordinates,g=0,b=E.length;b>g;g++)_=E[g],_.page===c&&(p=t.pluck(_.coordinates,"x"),h=t.pluck(_.coordinates,"y"),l=t.min(p),r=t.max(p),u=t.min(h),s=t.max(h),d.push(y.div({className:"annotation-thumbnail-page__region",style:{left:this._calculateThumbnailUIWidth(l),top:this._calculateThumbnailUIHeight(s),width:this._calculateThumbnailUIWidth(r-l),height:Math.abs(this._calculateThumbnailUIHeight(s)-this._calculateThumbnailUIHeight(u))}})));return d}},_calculateThumbnailUIWidth:function(e){var t,n;switch(n=this.props.annotation,n.type){case a.MARKER:t=p;break;case a.HIGHLIGHT:t=_;break;case a.REGION:t=f}return e/u*t},_calculateThumbnailUIHeight:function(e){var t,n;switch(n=this.props.annotation,n.type){case a.MARKER:t=d;break;case a.HIGHLIGHT:t=c;break;case a.REGION:t=h}return(l-e)/l*t},_getAnnotationText:function(){var e,t;return e=120,t=this.props.annotation.text_highlight.text,t.length>e&&(t=t.substring(0,e-3)+"..."),'"'+t+'"'},render:function(){var e,t,i;return e=this.props.annotation,i=this.props.revision,t=this.props.isOldRevision,y.a({className:"comment-annotation-button",onMouseUp:this.props.onAnnotationButtonMouseUp},y.div({className:"annotation-page-label"},null!=e.pdf_coordinates?y.div({className:"annotation-thumbnail-page"},this._getAnnotationThumbnail()):void 0,y.div({className:"annotation-thumbnail-label"},y.div({className:"annotation-thumbnail-label__page"},"Page "+e.getFirstPdfPage()),y.div({className:"annotation-thumbnail-label__info"},null!=i.when&&!isNaN(new Date(null!=i.when))&&t?"on revision updated "+n.ago(new Date(1e3*i.when)):"on latest revision"))),e.type===a.HIGHLIGHT?y.div({className:"annotation-thumbnail-text"},this._getAnnotationText()):void 0)}})});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/comment_activity_ui",["external/react","external/underscore","modules/clean/activity/file_viewer_state","modules/clean/annotations/annotation","modules/clean/react/activity/like_bar","modules/clean/react/activity/resolve_button","modules/clean/react/activity/time_counter","modules/clean/react/modal","modules/core/i18n","modules/clean/viewer","modules/clean/avatar/components","modules/clean/referrer_cleansing_redirect","modules/clean/sticker_util","modules/clean/react/activity/annotation_button"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p){var h,f,m,g,v,y,b,w,C,S,E,T,k;return h=i.Annotation,g=i.AnnotationTypes,m=i.AnnotationSubtypes,S=a.SimpleModal,v=c.AvatarWithDefault,b=c.InitialsAvatar,T=c.ViewerAvatar,k=e.DOM,w=e.createFactory(o),C=e.createFactory(r),E=e.createFactory(s),f=e.createFactory(p),y=e.createClass({displayName:"CommentActivityUI",propTypes:{context_activity_store:e.PropTypes.object.isRequired,comment_activity:e.PropTypes.object.isRequired,update_resolved:e.PropTypes.func.isRequired,delete_comment:e.PropTypes.func.isRequired,user:e.PropTypes.object.isRequired,onLikeComment:e.PropTypes.func,onAnnotationButtonMouseUp:e.PropTypes.func,fileViewerState:e.PropTypes.object,shouldAutoLinkify:e.PropTypes.bool,shouldUseSimpleModals:e.PropTypes.bool,shouldHidePhotoAvatars:e.PropTypes.bool,isReply:e.PropTypes.bool,shouldShowReplyButton:e.PropTypes.bool,onReplyButtonMouseUp:e.PropTypes.func,isTinyAnnotationUIEnabled:e.PropTypes.bool},getDefaultProps:function(){return{shouldAutoLinkify:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldShowReplyButton:!1,isTinyAnnotationUIEnabled:!1}},getInitialState:function(){return{hover:!1}},onAnnotationButtonMouseUp:function(){var e,t;return e=this.props.comment_activity.comment,"function"==typeof(t=this.props).onAnnotationButtonMouseUp?t.onAnnotationButtonMouseUp(this.props.comment_activity,e.comment_metadata):void 0},updateResolved:function(e){return this.props.update_resolved(this.props.comment_activity,e)},deleteComment:function(e){var t;return t=this.props.shouldUseSimpleModals?"simple":"default",e.preventDefault(),S.show({title_text:l._("Delete comment?"),body_html:l._("Are you sure you want to delete this comment?"),cancel_text:l._("Cancel"),confirm_text:l._("Delete"),style:t,confirm_callback:function(e){return function(){return e.props.delete_comment(e.props.comment_activity)}}(this)})},onLikeComment:function(){var e;return"function"==typeof(e=this.props).onLikeComment?e.onLikeComment(this.props.comment_activity):void 0},_isCommentForOldRevision:function(){var e;return null!=this.props.fileViewerState&&this.props.comment_activity.comment.has_metadata()?(e=this.props.comment_activity.comment.comment_metadata.revision,null!=e&&this.props.fileViewerState.isOldRevision(e)):!1},onReplyButtonMouseUp:function(){var e;return"function"==typeof(e=this.props).onReplyButtonMouseUp?e.onReplyButtonMouseUp():void 0},_renderTinyAnnotationUI:function(e){var t,n;return t=h.createAnnotationFromDict(e.annotation),n=e.revision,k.div({className:"annotation-link"},k.span({}," > "),k.a({onMouseUp:this.onAnnotationButtonMouseUp},"Page "+t.getFirstPdfPage()))},_renderAnnotationMarkerLocation:function(e){var t,n;return t=h.createAnnotationFromDict(e.annotation),n=e.revision,k.div({className:"comment-annotation"},f({revision:n,annotation:t,isOldRevision:this._isCommentForOldRevision(),onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp}))},renderPhoto:function(){var e,t,n;return t={dimension:32,defaultAvatar:new b({dimension:32,shape:"CIRCLE",initials:this.props.comment_activity.comment.commenter.initials}),key:this.props.comment_activity.comment.commenter.id},this.props.shouldHidePhotoAvatars||(t.photoUrl=this.props.comment_activity.comment.commenter.photo_circle_url),n=this.props.comment_activity.comment.commenter.id,e=__indexOf.call(u.get_viewer().get_user_ids(!0),n)>=0?new T(t):new v(t),k.div({className:"commenter-photo"},this.props.isReply?void 0:e)},renderCommentBody:function(){var e,t,n,i,o,r,s,a,l,u,c,d,p,h,f,m,g;for(i=/@\[(?:\s*(?:dbid:)?[^:\[\]]+):(?:[^\[]+)\]/i,n=/@\[(\s*(?:dbid:)?[^:\[\]]+):([^\[]+)\]/i,h="(?:[-a-zA-Z0-9@:%_+~#=]+[.])+[a-z]{2,6}(?:[:./?#][-a-zA-Z0-9@%_+~&=]+)*(?=[^a-zA-Z0-9_]|$)",d="http://"+h+"|https://"+h+"|www."+h+"|"+h,p=new RegExp(d,"i"),t=/\n/,a=[i,t],this.props.shouldAutoLinkify&&a.push(p),l=RegExp("("+function(){var e,t,n;for(n=[],e=0,t=a.length;t>e;e++)s=a[e],n.push(s.source);return n}().join("|")+")","gi"),r=[],g=this.props.comment_activity.comment.raw_comment_text.split(l),f=0,m=g.length;m>f;f++)e=g[f],e&&(e.match(i)?(u=e.match(n),o=u[2].trim(),r.push(k.span({className:"comment-mention"},o))):__indexOf.call(a,p)>=0&&e.match(p)?(c=e,c.indexOf("http://")<0&&c.indexOf("https://")<0&&(c="http://"+c),c=_.get_redirect_uri(c),r.push(k.a({href:c,target:"_blank"},e))):r.push(e.match(t)?k.br({}):e));return r},renderBody:function(){var e,n,i,o,r,s,a,c;return r=k.div({className:"second-bottom-dot",dangerouslySetInnerHTML:{__html:"&middot;"}}),o=k.div({className:"delete-icon",onMouseDown:function(e){return function(t){return e.deleteComment(t)}}(this)},l._("Delete")),i=[],i.push(r),i.push(o),e=this.state.hover,c=u.get_viewer(),a=t.intersection(c.get_user_ids(!0),this.props.comment_activity.permissions.user_ids_who_can_delete).length,a||c.can_moderate_comments||(e=!1),n=this.props.comment_activity.comment,n.has_metadata()&&n.comment_metadata.has_annotation_data()&&(s=this.props.isTinyAnnotationUIEnabled?this._renderTinyAnnotationUI(n.comment_metadata):this._renderAnnotationMarkerLocation(n.comment_metadata)),k.div({className:"comment-body"},k.div({className:"comment-top-bar"},k.div({className:"commenter-name"},n.commenter.display_name),this.props.isTinyAnnotationUIEnabled?s:void 0,this.props.user.is_signed_in&&!this.props.isReply?C({resolved:n.resolved,update_resolved:this.updateResolved}):void 0),n.has_metadata()&&n.comment_metadata.has_sticker_data()?k.div({className:"comment-sticker-body"},k.img({src:d.getStickerImageUrl(n.comment_metadata.get_sticker_id())})):k.div({className:"comment-text"},this.renderCommentBody()),this.props.isTinyAnnotationUIEnabled?void 0:s,k.div({className:"comment-bottom-bar"},w({activity:this.props.comment_activity,context_activity_store:this.props.context_activity_store,user:this.props.user,onLikeComment:this.onLikeComment}),this.props.shouldShowReplyButton?k.a({className:"reply-button",onMouseUp:this.onReplyButtonMouseUp},"Reply"):void 0,k.div({className:"bottom-dot",dangerouslySetInnerHTML:{__html:"&middot;"}}),E({when_mses:n.when_mses}),e?i:void 0))},render:function(){var t;return t=e.addons.classSet({comment:!0,resolved:this.props.comment_activity.comment.resolved,"comment--old-revision":this._isCommentForOldRevision(),"comment--reply":this.props.isReply}),k.div({className:"comment-activity","data-comment-activity-key":this.props.comment_activity.activity_key,onMouseMove:function(e){return function(){return e.setState({hover:!0})}}(this),onMouseLeave:function(e){return function(){return e.setState({hover:!1})}}(this)},k.div({className:t},this.renderPhoto(),this.renderBody()))}})}),define("modules/clean/react/activity/comment_count_bubble",["external/react","modules/core/i18n"],function(e,t){var n,i,o,r,s;return s=t._,r=e.DOM,o=e.addons.classSet,n=e.createClass({displayName:"CommentCountBubble",propTypes:{unresolvedCommentCount:e.PropTypes.number.isRequired,unseenCommentCount:e.PropTypes.number.isRequired},_unresolvedCommentCountDisplay:function(){return s(this.props.unresolvedCommentCount>9?"9+":String(this.props.unresolvedCommentCount))},render:function(){var e;return e=o({"comment-count-bubble":!0,"comment-count-bubble--unseen":this.props.unseenCommentCount>0}),this.props.unresolvedCommentCount>0?r.span({className:e},this._unresolvedCommentCountDisplay()):null}}),i=e.createFactory(n),{CommentCountBubble:n,CommentCountBubbleFactory:i}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/comment_input",["jquery","external/react","external/underscore","modules/core/browser","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/contacts/util","modules/clean/gandalf_util","modules/clean/keycode","modules/clean/storage","modules/clean/react/activity/mentions_controller","modules/clean/react/activity/users_to_notify","modules/clean/react/button","modules/clean/react/tooltip","modules/clean/avatar/components","modules/clean/viewer","modules/clean/react/file_comments/logger","modules/clean/react/react_i18n"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h,f,m,g,v,y,b){var w,C,S,E,T,k,x,I,A,P,N,O,R;return R=r._,O=r.ungettext,E=d.LocalStorage,w=g.AvatarWithDefault,S=g.InitialsAvatar,P=g.ViewerAvatar,x=b.R_,T=4e3,N=t.DOM,I=t.addons.CSSTransitionGroup,k=t.createFactory(p),A=t.createFactory(h),C=t.createClass({propTypes:{activity:t.PropTypes.object.isRequired,onAddComment:t.PropTypes.func,onCancelComment:t.PropTypes.func,resizeCallback:t.PropTypes.func,positionDropdownCallback:t.PropTypes.func,onFocus:t.PropTypes.func,onBlur:t.PropTypes.func,user:t.PropTypes.object.isRequired,onShowNewComment:t.PropTypes.func,inBlankState:t.PropTypes.bool,enableNotifyText:t.PropTypes.bool,enableNoNotifyHint:t.PropTypes.bool,showNewComment:t.PropTypes.bool,shouldPopupsDropdown:t.PropTypes.bool,verifyAfterSignUpCallback:t.PropTypes.func,initialText:t.PropTypes.string,shouldInitiallyFocusInput:t.PropTypes.bool,shouldAlwaysInEditMode:t.PropTypes.bool,isCommentInputDisabled:t.PropTypes.bool,shouldEnableStickers:t.PropTypes.bool,onAddSticker:t.PropTypes.func,contactSearchLogger:t.PropTypes.object,enableImport:t.PropTypes.bool,shouldHidePhotoAvatars:t.PropTypes.bool,isReplyInput:t.PropTypes.bool,shouldUseSimpleModals:t.PropTypes.bool},getInitialState:function(){var e,t,n,i,o;return e=!0,n=!1,t=null!=this.props.initialText?this.props.initialText:this._getCommentLocalStorage(null!=(i=this.props.activity)?i.activity_key:void 0),t.length>0&&(e=!1,n=!0),{button_disabled:e,showPostButton:n,initialText:t,users_to_notify:null!=(o=this.props.activity)?o.users_to_notify:void 0,commentMetadata:null}},getDefaultProps:function(){return{onShowNewComment:e.noop,shouldAlwaysInEditMode:!1,isCommentInputDisabled:!1,enableImport:!0,shouldHidePhotoAvatars:!1,isReplyInput:!1}},componentDidMount:function(){var t;return t=function(t,n){var i;return i=(null!=n?n.getDOMNode():void 0)||null,i?t.target===i||e.contains(i,t.target):!1},e(this.getDOMNode()).on("click.comment-input",function(e){return function(n){return t(n,e.refs.postButton)&&e.verifySubscribersBeforePost(),t(n,e.refs.showNewCommentButton)?e.props.onShowNewComment():void 0}}(this)),this._wasUsedLoggedOutPreviously()&&this.props.user.is_signed_in?this.props.user.is_email_verified?null!=i.mozilla?setTimeout(function(e){return function(){return e.postComment()}}(this),0):this.postComment():this.props.verifyAfterSignUpCallback():void 0},componentWillUnmount:function(){return e(this.getDOMNode()).off(".comment-input")},componentWillReceiveProps:function(e){return this.updateNotificationCount(e.activity)},_contactsSelectorPopupShown:function(){return y.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id)},_onAtSignKeyPress:function(){return this.props.user.is_signed_in?y.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,this.props.user.id):void 0},_onNoAtSignKeyPress:function(){return y.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS,this.props.user.id)},_contactPopupSelectedCallback:function(){return o.assert(this.props.user.is_signed_in,"Contact selected from popup when user is logged out"),y.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id)},_contactSelectedCallback:function(e){var t;return o.assert(this.props.user.is_signed_in,"Contact selected when user is logged out"),t=e?Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS:Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,y.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,t,this.props.user.id)},_onStickerPopupShown:function(){return y.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_STICKERS_SHOWN,this.props.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.STICKER_BUTTON,this.props.user.id)},onMentionsFocus:function(e){var t;return this.togglePostButton(!0),"function"==typeof(t=this.props).onFocus?t.onFocus(e):void 0},onMentionsBlur:function(){var e;if("function"==typeof(e=this.props).onBlur&&e.onBlur(),this.refs.mentions.getEncodedMessage()){if(this.shouldSaveText())return this._storeCommentLocalStorage(this.refs.mentions.getRawMessage(),this.props.activity.activity_key)}else if(!this.props.shouldAlwaysInEditMode)return this.togglePostButton(!1)},onMentionsCancel:function(){var e;return"function"==typeof(e=this.props).onCancelComment?e.onCancelComment():void 0},onKeyDown:function(e){return e.keyCode===_.ENTER&&(e.ctrlKey||e.metaKey)?(this.verifySubscribersBeforePost(),e.preventDefault()):void 0},onKeyUp:function(){return this._setPostButtonState(),this.updateNotificationCount(this.props.activity)},onPaste:function(e){return e.clipboardData.getData("text/plain").length>T?(s.error(R("The text you're trying to paste is too long.")),e.preventDefault()):setTimeout(function(e){return function(){return e._setPostButtonState(),e.updateNotificationCount(e.props.activity)}}(this),10)},refreshDropdownDirection:function(){var e;return"function"==typeof(e=this.props).positionDropdownCallback?e.positionDropdownCallback():void 0},togglePostButton:function(e){return this.setState({showPostButton:e},function(e){return function(){var t;return"function"==typeof(t=e.props).resizeCallback?t.resizeCallback():void 0}}(this))},shouldSaveText:function(){return!this.props.user.is_signed_in||!this.props.user.is_email_verified},_wasUsedLoggedOutPreviously:function(){return this.state.initialText.length>0&&null==this.props.initialText},updateNotificationCount:function(e){var t,i,o,r,s,l,u,c,_,d,p,h,f;if(null!=(null!=e?e.users_to_notify:void 0)){if(d=function(){var t,n,i,o;for(i=e.users_to_notify,o=[],t=0,n=i.length;n>t;t++)p=i[t],o.push(p.unique_id);return o}(),u=this.refs.mentions.extractMentions(),l=function(){var e,t,n;for(n=[],e=0,t=u.length;t>e;e++)s=u[e],n.push(s.dbx_account_id||s.identifier);return n}(),t=n.union(d,l).sort(),i=n.pluck(this.state.users_to_notify,"id").sort(),n.isEqual(i,t))return;for(c=n.object(l,u),r=n.difference(t,d),_=n.clone(e.users_to_notify),h=0,f=r.length;f>h;h++)o=r[h],_.push(new a({id:o,display_name:c[o].name}));return this.setState({users_to_notify:_})}},setCursorToEndOfInput:function(){return this.refs.mentions.setCursorToEndOfInput()},_onSkipAddMention:function(){return this.postComment()},_setPostButtonState:function(){var e;return e=""===this.refs.mentions.getEncodedMessage(),this.state.button_disabled!==e?this.setState({button_disabled:e}):void 0},verifySubscribersBeforePost:function(){var e,t,n,i;return this.props.user.is_signed_in&&(e=function(){var e,n,i,o;for(i=this.state.users_to_notify,o=[],e=0,n=i.length;n>e;e++)t=i[e],t.id!==this.props.user.id&&o.push(t);return o}.call(this),0===e.length&&0===(null!=(n=this.props.activity.comment_activities)?n.length:void 0)&&this.props.enableNoNotifyHint)?void(null!=(i=this.refs.mentions)&&i.showNoNotifyHint()):this.postComment();

},postComment:function(){var e,t;return(e=this.refs.mentions.getEncodedMessage())?(this.shouldSaveText()||(this.refs.mentions.disableMentions(),this.refs.mentions.clearTextField(),this._setPostButtonState(),this.togglePostButton(!1)),"function"==typeof(t=this.props).onAddComment?t.onAddComment(e):void 0):void 0},focusInput:function(){var e;return null!=(e=this.refs.mentions)?e.focusInput():void 0},getRawCommentInput:function(){var e;return null!=(e=this.refs.mentions)?e.getRawMessage():void 0},getPlaceholderText:function(){return this.placeholderText},_usersToNotifyToContacts:function(e){var t,n,i,o;for(t=[],i=0,o=e.length;o>i;i++)n=e[i],n.id!==this.props.user.id&&t.push(u.activityUserToContact(n,Number.MAX_VALUE));return t},_clearCommentLocalStorage:function(){return E.set("tmp-file-comment",null)},_getCommentLocalStorage:function(t){var n,i;return i=E.get("tmp-file-comment"),n="",i&&i.activity_key===t&&((new Date).getTime()-i.time<3e5&&(n=i.text),this._clearCommentLocalStorage()),e("<div/>").html(n).text()},_storeCommentLocalStorage:function(t,n){var i;return i=e("<div/>").text(t).html(),E.set("tmp-file-comment",{activity_key:n,text:i,time:(new Date).getTime()})},_renderShowNewComment:function(){var e,t;return t=[],this.props.showNewComment&&(e=N.a({className:"show-new-comment-button",ref:"showNewCommentButton"},[N.span({className:"show-new-comment-icon"}),N.span({className:"show-new-comment-text"},R("New Comment"))]),t=N.div({className:"comment-show-new-comment"},e)),I({transitionName:"comment-show-new-comment",component:N.div},t)},_renderCommentBox:function(){var e,t;return this.placeholderText=R(this.props.isReplyInput?"Reply...":this.props.inBlankState?"Write a comment":"Comment or @mention"),e=null!=this.props.activity?this.props.activity.users_to_notify:[],t=k({ref:"mentions",placeholder_text:this.placeholderText,initialText:this.state.initialText,contactSearchLogger:this.props.contactSearchLogger,shouldPopupsDropdown:this.props.shouldPopupsDropdown,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldAlwaysInEditMode:this.props.shouldAlwaysInEditMode,onFocus:this.onMentionsFocus,onBlur:this.onMentionsBlur,onCancel:this.onMentionsCancel,position_contacts_callback:this.props.positionDropdownCallback,resizeCallback:this.props.resizeCallback,onKeyUp:this.onKeyUp,onKeyDown:this.onKeyDown,onPaste:this.onPaste,onMention:function(e){return function(){return e.updateNotificationCount(e.props.activity)}}(this),user:this.props.user,showMentionsHelper:c.getGandalfRule("dw-comments-add-mention-dropdown")&&this.props.user.is_signed_in,enableNoAtMentions:c.getGandalfRule("dw-comments-no-at-mentions")&&this.props.user.is_signed_in,contactsSelectorPopupShown:this._contactsSelectorPopupShown,onAtSignKeyPress:this._onAtSignKeyPress,onNoAtSignKeyPress:this._onNoAtSignKeyPress,contactPopupSelectedCallback:this._contactPopupSelectedCallback,contactSelectedCallback:this._contactSelectedCallback,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(e),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldEnableStickers:this.props.shouldEnableStickers,onStickerPopupShown:this._onStickerPopupShown,onAddSticker:this.props.onAddSticker}),N.div({className:"comment-box"},[t,N.div({className:"post-area",ref:"postArea"},[this.props.enableNotifyText&&!this.props.isReplyInput?this._renderTooltipContainer():void 0,this._renderButtonContainer()])])},_renderCommenterPhoto:function(){var e,t,n,i;return t={dimension:32,defaultAvatar:new S({dimension:32,shape:"CIRCLE",initials:this.props.user.initials||"?"})},this.props.shouldHidePhotoAvatars||(t.photoUrl=this.props.user.photo_circle_url),n=null!=(i=this.props.user)?i.id:void 0,e=__indexOf.call(v.get_viewer().get_user_ids(!0),n)>=0?new P(t):new w(t),N.div({className:"commenter-photo"},this.props.isReplyInput?void 0:e)},_renderTooltipContainer:function(){return N.div({className:"tooltip-container"},A({usersToNotify:this.state.users_to_notify,user:this.props.user,show_extra_text:!this.state.showPostButton}))},_renderButtonContainer:function(){var e,t,n,i;return n=!this.state.showPostButton,t=this.state.button_disabled,e={className:"post-button",disabled:t,ref:"postButton"},i=f.button(e,R("Post")),N.div({className:"button-container",hidden:n},i)},render:function(){var e;return e=t.addons.classSet({"comment-field":!0,"comment-expanded":c.getGandalfRule("dw-comments-expanded-input")&&(this.state.showPostButton||this.props.inBlankState),"comment-field--disabled":this.props.isCommentInputDisabled}),N.div({className:e},[this._renderShowNewComment(),this._renderCommenterPhoto(),this._renderCommentBox(),this.props.isCommentInputDisabled?N.div({className:"comment-field__diabled"},""):void 0])}})});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/contacts_selector",["external/react","external/typeahead.bundle","jquery","modules/clean/keycode","modules/clean/ajax","modules/clean/viewer","modules/clean/activity/activity_user","modules/clean/contacts/bloodhound_contacts","modules/clean/contacts/list","modules/clean/contacts/types","modules/clean/avatar/components","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/sprite","modules/core/i18n","modules/core/exception"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h){var f,m,g,v,y,b,w,C,S,E,T;return f=c.AvatarWithDefault,y=c.InitialsAvatar,b=d.LinkedProfileServices,C=d.ProfileServicesLinkingHandler,S=e.addons.classSet,E=e.DOM,T=r.get_viewer(),w=5,g=99,v=3,m=e.createClass({propTypes:{showNullHint:e.PropTypes.bool,contactSelectedCallback:e.PropTypes.func,contactHighlightedCallback:e.PropTypes.func,contactSearchLogger:e.PropTypes.object,noAtMentionTriggerCallback:e.PropTypes.func,resultsLimit:e.PropTypes.number,matchFullQUery:e.PropTypes.bool,noMatchesText:e.PropTypes.string,user:e.PropTypes.object,showContactsInNullState:e.PropTypes.bool,x_offset:e.PropTypes.number,y_offset:e.PropTypes.number,enableImport:e.PropTypes.bool,show_contacts:e.PropTypes.bool,should_dropdown:e.PropTypes.bool,last_keydown:e.PropTypes.number,extraContacts:e.PropTypes.arrayOf(e.PropTypes.object),shouldHidePhotoAvatars:e.PropTypes.bool},getInitialState:function(){return this.contactSelectedCallback=this.props.contactSelectedCallback,null!=this.props.user&&this.props.user.is_signed_in&&this.props.enableImport&&(this.profile_services=b.get_linked_profile_services_for_user(this.props.user.id)),{suggestions:[],matches_count:0,focused_row:null,query:"",show_no_results:!1,hover_import_contact:!1,show_import_list:!1}},getDefaultProps:function(){return{contactSelectedCallback:void 0,should_dropdown:!0,show_contacts:!1,enableImport:!0,x_offset:0,y_offset:0,last_keydown:-1,showNullHint:!0,showContactsInNullState:!1,noMatchesText:h._("No matches. Keep typing an email address."),matchFullQUery:!1,extraContacts:[],shouldHidePhotoAvatars:!1}},componentWillMount:function(){return this.contacts=new a,this.contacts.setExtraContacts(this.props.extraContacts),0===this.state.query.length&&this.props.showContactsInNullState?this.get_suggestions(""):void 0},componentDidMount:function(){var e,t;return this.$typeahead_container=n(null!=(e=this.refs.suggestionsContainer)?e.getDOMNode():void 0),this.$typeahead_suggestions=n(null!=(t=this.refs.suggestionsList)?t.getDOMNode():void 0),this._position_contacts_list(),this._toggle_contacts_list(),this.state.show_contacts?void 0:this._reset_import_state()},componentDidUpdate:function(){var e,t,i;return this.$typeahead_container=n(null!=(t=this.refs.suggestionsContainer)?t.getDOMNode():void 0),this.$typeahead_suggestions=n(null!=(i=this.refs.suggestionsList)?i.getDOMNode():void 0),this._position_contacts_list(),this._toggle_contacts_list(),"function"==typeof(e=this.props).contactHighlightedCallback?e.contactHighlightedCallback(this._get_suggestion_row(this.state.focused_row)):void 0},_reset_import_state:function(){return this.setState({hover_import_contact:!1,show_import_list:!1})},_append_import_to_suggestions:function(e){var t,n,i,o;for(o=_.contact_services(),n=0,i=o.length;i>n;n++)t=o[n],e.push(this._append_provider(t));return e},_append_provider:function(e){var t;return t=_.to_name(e),this.profile_services.service_is_connected(e)&&(t+=h._(" (Connected)")),{type:g,provider:e,name:t,photo_url:_.to_img(e)}},_import_contacts_mouseover:function(){return this.setState({hover_import_contact:!0})},_import_contacts_mouseleave:function(){return this.setState({hover_import_contact:!1})},_mouse_down_import_contacts:function(e){return e.preventDefault(),this.setState({hover_import_contact:!this.state.hover_import_contact,show_import_list:!this.state.show_import_list})},_focus_suggestion_row:function(e){return null!=e&&this.state.focused_row!==e||null===e?this.setState({focused_row:e}):void 0},_focus_suggestion_row_mouseover:function(e){var t,i;return t=n(e.currentTarget),i=t.index(),i>-1?this._focus_suggestion_row(i):void 0},_get_suggestion_row:function(){return this.$typeahead_suggestions.find(".suggestion-row.focused")},_get_suggestions_callback:function(e,t,n){var o,r,s,a,c;return this.isMounted()?(t=function(){var e,n,i,r;for(r=[],e=0,n=t.length;n>e;e++)o=t[e],(i=o.type)!==u.USER_GROUP&&i!==u.NEW_STYLE_GROUP&&r.push(o);return r}(),t=l.sortContactsByTeamFirst(t),n||(t=e.length>=w?this._getApproximateNameMatches(e,t):this._getExactFirstOrLastNameMatches(e,t)),this.matchesCountFromBloodhoundContacts=t.length,t=t.slice(0,this.props.resultsLimit),r=t.length,s=0===r&&this.props.last_keydown!==i.SPACE&&e.indexOf(" ")<0||0===r&&this.props.matchFullQUery,n||"function"==typeof(a=this.props).noAtMentionTriggerCallback&&a.noAtMentionTriggerCallback(r),this.props.enableImport&&0===r?t=this._append_import_to_suggestions(t):r>0&&this._reset_import_state(),this.props.should_dropdown?c=0:(c=t.length-1,t.reverse()),this.setState({suggestions:t,focused_row:c,show_no_results:s,matches_count:r})):void 0},_has_suggestion_row_at_index:function(e){return null!=e&&e>=0&&e<this.get_suggestions_count()},_mouse_down_select_suggestion:function(e){return e.preventDefault(),this.select_suggestion(e.currentTarget)},_position_contacts_list:function(){var e,t;return t=this.$typeahead_container.parent(),e=this.$typeahead_container.width(),e+this.props.x_offset>t.width()?this.$typeahead_container.css("left",t.width()-e):this.$typeahead_container.css("left",this.props.x_offset),this.props.should_dropdown?this.$typeahead_container.css("top",this.props.y_offset):this.$typeahead_container.css("top",this.props.y_offset-this.$typeahead_container.height()-12)},_toggle_contacts_list:function(){return this.props.show_contacts&&(this._matches_count()>0||0===this.state.query.length||this.state.show_no_results&&this.state.query.length)?this.$typeahead_container.show():this.$typeahead_container.hide()},_matches_count:function(){return this.state.matches_count},_getExactFirstOrLastNameMatches:function(e,t){var n;return function(){var i,o,r;for(r=[],i=0,o=t.length;o>i;i++)n=t[i],__indexOf.call(n.name_tokens,e)>=0&&r.push(n);return r}()},_getApproximateNameMatches:function(e,t){var n,i,o,r,s,a,l,u;for(i=[],r=0,a=t.length;a>r;r++)for(n=t[r],u=n.name_tokens,s=0,l=u.length;l>s;s++)if(o=u[s],0===o.indexOf(e)){i.push(n);break}return i},get_suggestions:function(e,t){return null==t&&(t=!0),null!=this.props.user&&this.props.user.is_signed_in?(this.contacts.get(e,function(n){return function(i){return n._get_suggestions_callback(e,i,t)}}(this)),this.setState({query:e})):void 0},get_suggestions_count:function(){return this.props.show_contacts?this.$typeahead_suggestions.children().size():0},navigate_suggestions:function(e){var t,n,o,r,s;if(t=e.keyCode||e.which||e.charCode,e.keyCode===i.ENTER||e.keyCode===i.TAB){if(e.preventDefault(),this._has_suggestion_row_at_index(this.state.focused_row))return r=this._get_suggestion_row(this.state.focused_row),this.select_suggestion(r)}else if(((s=e.keyCode)===i.UP||s===i.DOWN)&&(n=this.get_suggestions_count(),n>0))if(e.keyCode===i.UP){if(o=null!=this.state.focused_row?this.state.focused_row:n,0!==this.state.focused_row)return this._focus_suggestion_row((o-1)%n)}else if(e.keyCode===i.DOWN&&(o=null!=this.state.focused_row?this.state.focused_row:-1,this.state.focused_row!==n-1))return this._focus_suggestion_row((o+1)%n)},select_suggestion:function(e){var t,i,o;return t=n(e),t.data("type")===g?void(null!=this.props.user&&this.props.user.is_signed_in&&(i=new C,i.auth_service_with_user(String(t.data("provider")),this.props.user.id,function(e){return C.show_import_notifications(e)},"contact-importer-modal"))):(null!=this.props.contactSearchLogger&&(o={sort_variant:this.contacts.getSortVariant(),context:"mentions",search_expr:this.state.query,selected_pos:this.state.focused_row,num_query_results:this.matchesCountFromBloodhoundContacts,contact_type:t.data("type"),contact_id:t.data("identifier"),contact_name:t.data("name"),did_select_suggestion:!0},this.props.contactSearchLogger.add_record(o)),null!=this.contactSelectedCallback&&this.contactSelectedCallback(t),this.isMounted()?this.setState({focused_row:null,suggestions:[]}):void 0)},render:function(){var t,n,i,o;return t=e.addons.classSet({"contacts-list-suggestions":!0,"animating-down":this.props.show_contacts&&!this.props.should_dropdown,"animating-up":this.props.show_contacts&&this.props.should_dropdown}),E.div({className:t,ref:"suggestionsContainer"},this.props.show_contacts&&this.props.user?this.props.user.is_signed_in?0===this.state.query.length&&this.props.showNullHint&&!this.props.showContactsInNullState?E.div({className:"suggestion-row empty-state-row"},h._("Mention someone by name or email")):this.state.query.length||0===this.state.query.length&&this.props.showContactsInNullState?(o=E.div({ref:"suggestionsList"},function(){var e,n,o,r;for(o=this.state.suggestions,r=[],e=0,n=o.length;n>e;e++)i=o[e],r.push(function(e){return function(n){var i,o,r,a,l,c,_,d,p,m;return t={"import-row":n.type===g,"suggestion-row":!0,focused:null!=e.state.focused_row&&e.state.suggestions.indexOf(n)===e.state.focused_row},a=S(t),n.type===u.EMAIL?(d=n.email,l=n.email):n.type===u.FB?(d="fb_"+n.fb_id,l="Facebook Contact"):(m=n.type)===u.USER_GROUP||m===u.NEW_STYLE_GROUP?(d=n.group_id,l="Group"):n.type===g?(d="Import-"+n.name,r=E.img({src:n.photo_url})):n.type===u.DBX_ID&&(d=n.dbx_account_id,l=h._("Dropbox User")),c=!1,null!=n.name&&n.name.length>0?p=n.name:null!=n.email&&(c=!0,p=n.email,l=null),n.type===g||null==n.photo_url&&null==p||(c?_="@":(i=new s({display_name:p}),_=i.initials),o={dimension:32,defaultAvatar:new y({dimension:32,shape:"CIRCLE",initials:_})},e.props.shouldHidePhotoAvatars||(o.photoUrl=n.photo_url),r=new f(o)),E.div({key:d,className:a,"data-identifier":d,"data-name":p,"data-type":n.type,"data-photo-url":n.photo_url,"data-dbx-account-id":n.dbx_account_id||null,"data-provider":n.provider||null,onMouseDown:function(t){return e._mouse_down_select_suggestion(t)},onMouseEnter:function(t){return e._focus_suggestion_row_mouseover(t)}},E.div({className:"suggestion-wrapper"},r?E.div({className:"suggestion-avatar"},r):void 0,E.div({className:"suggestion-info"},null!=p?E.div({className:"suggestion-name"},p):void 0,null!=l?E.div({className:"suggestion-identifier"},l):void 0)))}}(this)(i));return r}.call(this)),this.state.show_no_results?E.div({},E.div({className:"suggestion-row empty-state-row"},E.div({className:"empty-state-row-text"},this.state.hover_import_contact||this.state.show_import_list?h._("Import Contacts"):this.props.noMatchesText),this.props.enableImport?(n={"import-contacts":!0,active:null!=this.state.show_import_list},E.a({className:S(n),onMouseDown:function(e){return function(t){return e._mouse_down_import_contacts(t)}}(this),onMouseEnter:function(e){return function(t){return e._import_contacts_mouseover(t)}}(this),onMouseLeave:function(e){return function(t){return e._import_contacts_mouseleave(t)}}(this)},p({group:"web",name:"user_add"}))):void 0),this.state.show_import_list?E.div({className:S({"suggestion-row-top-divider":!0,"animating-down":this.props.should_dropdown,"animating-up":!this.props.should_dropdown})},o):void 0):this._matches_count()>0?o:void 0):void 0:E.div({className:"suggestion-row empty-state-row"},h._("Login to @mention your contacts")):void 0)}})});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/contacts_selector_popup",["jquery","external/react","modules/core/browser","modules/core/exception","modules/core/i18n","modules/clean/activity/activity","modules/clean/contacts/types","modules/clean/keycode","modules/clean/react/activity/contacts_selector","modules/clean/react/react_i18n","modules/clean/validators/validators"],function(e,t,n,i,o,r,s,a,l,u,c){var _,d,p,h,f;return p=t.DOM,d=u.R_,f=[a.UP,a.DOWN,a.ESC,a.ENTER,a.TAB],h=c.check(c.create(["EmailValidator"])),_=t.createClass({displayName:"ContactsSelectorPopup",propTypes:{showContactsInNullState:t.PropTypes.bool,shouldShowNoNotifyHint:t.PropTypes.bool,should_dropdown:t.PropTypes.bool,user:t.PropTypes.object,contactHighlightedCallback:t.PropTypes.func,contactSelectedCallback:t.PropTypes.func,contactSearchLogger:t.PropTypes.object,emailEnteredCallback:t.PropTypes.func,clearContactHighlightedCallback:t.PropTypes.func,onAddPeopleMouseUp:t.PropTypes.func,onSkipAddMention:t.PropTypes.func,enableImport:t.PropTypes.bool,extraContacts:t.PropTypes.arrayOf(t.PropTypes.object),shouldHidePhotoAvatars:t.PropTypes.bool},getInitialState:function(){return{query:"",show_contacts:!0,last_keydown:-1,shouldShowNoNotifyHint:!1}},getDefaultProps:function(){return{showContactsInNullState:!0,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1}},showNoNotifyHint:function(){var e;return this.setState({shouldShowNoNotifyHint:!0}),"function"==typeof(e=this.props).clearContactHighlightedCallback?e.clearContactHighlightedCallback():void 0},contactHighlightedCallback:function(e){var t;return i.assert(!this.state.shouldShowNoNotifyHint,"Should not have highlight callback in no notify state"),"function"==typeof(t=this.props).contactHighlightedCallback?t.contactHighlightedCallback(e):void 0},contactSelectedCallback:function(e){var t;return this._resetInput(),"function"==typeof(t=this.props).contactSelectedCallback?t.contactSelectedCallback(e):void 0},_resetInput:function(){return this.setState({query:""}),e(this.refs.contactSelectorPopupInput.getDOMNode()).val(""),this.refs.contactSelectorPopup.get_suggestions("")},_logEmailEntered:function(e){var t;if(null!=this.props.contactSearchLogger)return t={sort_variant:null,context:"mentions",contact_type:s.EMAIL,contact_id:e,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(t)},_onInputKeyDown:function(e){var t,i,o;if(t=e.keyCode||e.which||e.charCode,null!=n.msie&&t===a.ENTER){if(i=e.target.value,this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(e);if(h(i))return"function"==typeof(o=this.props).emailEnteredCallback&&o.emailEnteredCallback(i),this._logEmailEntered(i)}},_onInputKeyUp:function(e){var t,n,i;if(t=e.keyCode||e.which||e.charCode,n=e.target.value,null!=this.refs.contactSelectorPopup){if(!(__indexOf.call(f,t)>=0))return this.setState({query:n}),this.refs.contactSelectorPopup.get_suggestions(n);if(this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(e);if(t===a.ENTER&&h(n))return"function"==typeof(i=this.props).emailEnteredCallback&&i.emailEnteredCallback(n),this._logEmailEntered(n)}},_onAddPeopleMouseUp:function(t){var n;return this.setState({shouldShowNoNotifyHint:!1},function(t){return function(){var n;return e(null!=(n=t.refs.contactSelectorPopupInput)?n.getDOMNode():void 0).focus()}}(this)),"function"==typeof(n=this.props).onAddPeopleMouseUp?n.onAddPeopleMouseUp(t):void 0},_onSkipAddMention:function(e){var t;return"function"==typeof(t=this.props).onSkipAddMention?t.onSkipAddMention(e):void 0},render:function(){var e,t,n;return p.div({className:"contacts-selector-popup"},this.state.shouldShowNoNotifyHint?p.div({className:"contacts-selector-hint"},"Your comment won't notify anyone.",p.div({}),p.a({className:"",onMouseUp:this._onAddPeopleMouseUp},"Add people"),p.span({className:"bottom-dot"}," Â· "),p.a({className:"",onMouseUp:this._onSkipAddMention},"Just for me")):(t=p.div({className:"contacts-selector-popup-input-wrapper"},p.input({ref:"contactSelectorPopupInput",onKeyDown:this._onInputKeyDown,onKeyUp:this._onInputKeyUp,placeholder:"Type an email or name"})),e=this.state.query.trim().length>0||this.props.showContactsInNullState?p.hr({className:"separator"}):p.span({}),n=l({ref:"contactSelectorPopup",contactSelectedCallback:this.contactSelectedCallback,contactHighlightedCallback:this.contactHighlightedCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.should_dropdown,y_offset:0,x_offset:0,user:this.props.user,last_keydown:this.state.last_keydown,showNullHint:!1,showContactsInNullState:this.props.showContactsInNullState,matchFullQUery:!0,resultsLimit:5,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),this.props.should_dropdown?[t,e,n]:[n,e,t]))}})});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/like_bar",["external/react","modules/core/i18n","modules/core/notify","modules/clean/activity/activity","modules/clean/react/sprite","modules/clean/react/tooltip","modules/clean/viewer"],function(e,t,n,i,o,r,s){var a,l,u,c,_,d;return d=t._,c=e.DOM,_=s.get_viewer(),a=i.ActivityType,u=15,l=e.createClass({propTypes:{context_activity_store:e.PropTypes.object.isRequired,activity:e.PropTypes.object.isRequired,user:e.PropTypes.object.isRequired,onLikeComment:e.PropTypes.func},is_liked_by_viewing_user:function(){var e,t;return this.props.user.is_signed_in?(t=this.props.user.id,__indexOf.call(function(){var t,n,i,o;for(i=this.props.activity.likes,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(e.liker.id);return o}.call(this),t)>=0):void 0},addLike:function(){var e,t,i;return e=this.props.activity,this.props.user.is_signed_in&&(t=function(e){return function(){return n.error(d("We weren't able to submit your like.")),e.forceUpdate()}}(this),e.activity_type===a.COMMENT?this.props.context_activity_store.add_comment_like(e,this.props.user,null,null,t):this.props.context_activity_store.add_like(e,this.props.user,null,null,t),this.setState({like_added:!0})),"function"==typeof(i=this.props).onLikeComment?i.onLikeComment():void 0},removeLike:function(){var e,t;return e=this.props.activity,t=function(e){return function(){return n.error(d("We weren't able to remove your like.")),e.forceUpdate()}}(this),e.activity_type===a.COMMENT?this.props.context_activity_store.remove_comment_like(e,this.props.user,null,null,t):this.props.context_activity_store.remove_like(e,this.props.user,null,null,t),this.forceUpdate()},getInitialState:function(){return{like_added:!1}},render:function(){var t,n,i,s,a,l,_,p,h;return l=this.props.activity.likes,h=this.is_liked_by_viewing_user()?"bluestar":"star",_=l.length,p=this.is_liked_by_viewing_user()?function(e){return function(){return e.removeLike()}}(this):function(e){return function(){return e.addLike()}}(this),t=e.addons.classSet({"like-sprite":!0,animating:this.is_liked_by_viewing_user()&&this.state.like_added}),a=function(){var e,t,i;for(i=[],e=0,t=l.length;t>e;e++)n=l[e],i.push(n.liker);return i}(),a=a.slice(0,u),l.length>u&&a.push({id:"extra",display_name:d("%(num_extra)d more...").format({num_extra:l.length-u})}),i=_>0?c.div({className:"liker-names"},function(){var e,t,n;for(n=[],e=0,t=a.length;t>e;e++)s=a[e],n.push(function(){return function(e){return c.div({key:e.id},e.display_name)}}(this)(s));return n}.call(this)):this.props.user.is_signed_in?c.span({},d("Like")):c.span({},d("Login to like comment")),c.div({className:"like-bar"},r.Tooltip({position:r.TooltipPosition.TOP,tooltip_contents:i,tooltip_classname:"like-tooltip"},c.div({},c.a({className:t,onMouseDown:p},o({group:"web",name:h})),_>0?c.div({className:"like-text"},_):void 0)))}})});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/mentions_controller",["jquery","external/react","external/purify","modules/core/browser","modules/core/exception","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/keycode","modules/clean/validators/validators","modules/clean/react/bubble_dropdown","modules/clean/react/input","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/tooltip","modules/clean/react/activity/contacts_selector","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/file_comments/stickers"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h,f,m){var g,v,y,b,w,C,S,E,T,k,x,I,A,P,N,O,R;return k=m.Stickers,A=t.DOM,I=t.addons.classSet,C=_.R_,g=t.createFactory(u),v=t.createFactory(h),y=t.createFactory(f),T=t.createFactory(d),x=t.createFactory(p.Tooltip),P="\ufeff",N=new RegExp(P,"g"),S="Â ",E="Â",b="Â",O=[a.UP,a.DOWN,a.ESC,a.ENTER,a.TAB],R=l.check(l.create(["EmailValidator"])),w=t.createClass({displayName:"MentionsController",propTypes:{shouldPopupsDropdown:t.PropTypes.bool,enableNoAtMentions:t.PropTypes.bool,showContactsInNullState:t.PropTypes.bool,initialText:t.PropTypes.string,user:t.PropTypes.object,position_contacts_callback:t.PropTypes.func,showMentionsHelper:t.PropTypes.bool,contactSearchLogger:t.PropTypes.object,contactsSelectorPopupShown:t.PropTypes.func,contactPopupSelectedCallback:t.PropTypes.func,contactSelectedCallback:t.PropTypes.func,onKeyDown:t.PropTypes.func,onKeyUp:t.PropTypes.func,onAtSignKeyPress:t.PropTypes.func,onNoAtSignKeyPress:t.PropTypes.func,onBlur:t.PropTypes.func,onFocus:t.PropTypes.func,onPaste:t.PropTypes.func,onCancel:t.PropTypes.func,onMention:t.PropTypes.func,placeholder_text:t.PropTypes.string,resultsLimit:t.PropTypes.number,resizeCallback:t.PropTypes.func,onSkipAddMention:t.PropTypes.func,onAddPeopleMouseUp:t.PropTypes.func,shouldInitiallyFocusInput:t.PropTypes.bool,shouldShowNoNotifyHint:t.PropTypes.bool,shouldAlwaysInEditMode:t.PropTypes.bool,enableImport:t.PropTypes.bool,extraContacts:t.PropTypes.arrayOf(t.PropTypes.object),shouldHidePhotoAvatars:t.PropTypes.bool,shouldEnableStickers:t.PropTypes.bool,onStickerPopupShown:t.PropTypes.func,onAddSticker:t.PropTypes.func},getInitialState:function(){var e;return e=!1,this.isInNoAtMentionMode=!1,this.currentCursorWordStartPosition=0,this.currentCursorWordEndPosition=0,this.props.initialText&&this.props.initialText.length>0&&(e=!0),{default_state:!0,x_offset:0,y_offset:0,in_edit_mode:e,mention_triggered:!1,search_end_position:-1,search_start_position:-1,show_contacts:!1,last_keydown:-1}},getDefaultProps:function(){return{shouldPopupsDropdown:!0,initialText:"",user:new r,resultsLimit:5,shouldShowNoNotifyHint:!1,enableNoAtMentions:!1,shouldAlwaysInEditMode:!1,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1,shouldEnableStickers:!1}},componentDidMount:function(){return this._componentSetup(),this.state.default_state&&this.props.initialText.length>0&&(null!=i.mozilla?setTimeout(function(e){return function(){return e._replaceInputWithText(e.props.initialText)}}(this),0):this._replaceInputWithText(this.props.initialText)),this.props.shouldInitiallyFocusInput?setTimeout(function(e){return function(){return e.focusInput()}}(this),0):void 0},componentDidUpdate:function(e,t){var n,i;return this._componentSetup(),i=this._getCaretPosition(),t.show_contacts===this.state.show_contacts||(null!=i?i.left:void 0)===this.state.x_offset&&(null!=i?i.top:void 0)===this.state.y_offset?void 0:(n={x_offset:i.left,y_offset:i.top},this.setState(n))},showNoNotifyHint:function(){var e,t;return this.refreshDropdownDirection(),null!=(e=this.refs.mentionsHintDropdown)&&e.show(),null!=(t=this.refs.mentionsContactSelectorPopup)?t.showNoNotifyHint():void 0},_resetInputToPlaceholderState:function(){return this._dangerouslySetInputHtml(""),this.setState({in_edit_mode:!1,search_end_position:-1,search_start_position:-1})},_replaceInputWithText:function(e){var t,i,o,r,s,a;return e=n.sanitize(e,{FORBID_ATTR:["src","href"]}),this._clearInputWithoutBlurring(),this.$text_input.focus(),a=this._extractCursorInfo(),i=a[0],o=a[1],s=a[2],r=document.createRange(),i&&(r.setStart(i,0),t=/@\[(\s*(?:dbid:)?[^:\[\]]+):([^\[]+)\]/g,e=e.replace(t,function(e){return function(t,n,i){return n=n.trim(),i=i.trim(),e._mentionWrapper(n,i)}}(this)),this.unsafeInsertHtmlAtRange(e,r,!0),!this.state.in_edit_mode)?this.setState({in_edit_mode:!0}):void 0},_componentSetup:function(){return this.contacts_selector=this.refs.contactSelector,this.$mentions_input=e(this.refs.input.getDOMNode()),this.$text_input=e(this.refs.textInput.getDOMNode())},_logEmailEntered:function(e){var t;if(null!=this.props.contactSearchLogger)return t={sort_variant:null,context:"mentions",contact_type:s.EMAIL,contact_id:e,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(t)},_parseInputTextAndReplace:function(){var e,t;return e=0,t=new RegExp(/@[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/gi),this._parseInputTextWithRegex(t,function(t){return function(n,o){var r,s,a,l,u;return s=n[0],r=n.index,l=s.substring(1),R(l)&&null==i.msie?(u=document.createRange(),u.setStart(o,r),u.setEnd(o,r+s.length),a=t._createMentionObject(l,l),t._addMentionIntoInput(a,u),e++,t._logEmailEntered(l)):void 0}}(this)),e>0?this.setCursorToEndOfInput():void 0},_parseInputTextWithRegex:function(t,n){var o,r,s,a,l,u,c,_;if(r=this.$text_input.html().replace(N,""),null!=r&&""!==r){for(c=this.$text_input[0].childNodes,_=[],l=0,u=c.length;u>l;l++)o=c[l],null!=i.msie&&e(o).is("p")||o.nodeType===Node.TEXT_NODE&&""!==o.nodeValue.trim()?(a=null!=i.msie?e(o).text():o.nodeValue,_.push(function(){var e;for(e=[];null!==(s=t.exec(a));)e.push(n(s,o));return e}())):_.push(void 0);return _}},refreshDropdownDirection:function(){var e;return"function"==typeof(e=this.props).position_contacts_callback?e.position_contacts_callback():void 0},_getEndRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(b)},_getStartRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(E)},_endRangeUnicodeExists:function(){return this._getEndRangeUnicodeIndex()>=0},_startRangeUnicodeExists:function(){return this._getStartRangeUnicodeIndex()>=0},_startAndEndRangeUnicodeExistsAndValid:function(){var e,t;return t=this._getStartRangeUnicodeIndex(),e=this._getEndRangeUnicodeIndex(),t>=0&&e>0&&e>t},_clearStartToEndRangeUnicode:function(){return this._dangerouslyReplaceStartToEndRangeUnicode(""),this._clearRangeUnicode()},_dangerouslyInsertValueBeforeStartUnicode:function(e){var t,i,o,r,s;return this._getStartRangeUnicodeIndex()>=0?(s=this._getStartRangeUnicodeIndex(),i=this.$text_input.html(),t=i.substr(0,s),o=i.substr(s),e=n.sanitize(e),r=""+t+e+o,this._dangerouslySetInputHtml(r)):void 0},_dangerouslyReplaceStartToEndRangeUnicode:function(e){var t,i,o,r,s;return this._startAndEndRangeUnicodeExistsAndValid()?(s=this._getStartRangeUnicodeIndex(),i=this._getEndRangeUnicodeIndex(),r=this.$text_input.html(),o=r.substr(0,s),t=r.substr(i),e=n.sanitize(e),this._dangerouslySetInputHtml(""+o+E+e+b+t)):void 0},_clearRangeUnicode:function(){var e;return e=this.$text_input.html(),e=e.replace(/\u0091/g,""),e=e.replace(/\u0092/g,""),this.$text_input.html(e)},_dangerouslyInsertLiveTextWithRangeUnicode:function(e){var t;return null==i.msie&&this._cleanUpDelimiters(),(this._getStartRangeUnicodeIndex()<0||this._getEndRangeUnicodeIndex()<0)&&(this._clearRangeUnicode(),
this._dangerouslySetInputHtml(""+this.$text_input.html()+E+b)),t=this._isSpaceBeforeStartUnicode()?"":" ",e=n.sanitize(e),this._dangerouslyReplaceStartToEndRangeUnicode(""+t+e)},_getRangeBetweenStartEndRangeUnicode:function(){var t,n,o,r,s,a,l,u,c;if(n=this.$text_input.html().replace(N,""),null!=n&&""!==n)for(c=this.$text_input[0].childNodes,l=0,u=c.length;u>l;l++)if(t=c[l],a=null!=i.msie?e(t).text():t.nodeValue,null!=a&&a.length>0&&(s=a.indexOf(E),o=a.indexOf(b),s>=0&&o>0&&o>s))return r=document.createRange(),r.setStart(t,s),r.setEnd(t,o),r},_isSpaceBeforeStartUnicode:function(){var e;return e=this._getStartRangeUnicodeIndex(),e>=0?this._isSpaceBeforeIndex(e):!1},_isSpaceBeforeIndex:function(e){var t;return t=this.$text_input.html(),e>0&&" "===t.substr(e-1,1)||e>=6&&"&nbsp;"===t.substr(e-6,6)},_dangerouslySetInputHtml:function(e){return this.$text_input.html(e)},_onAddPeopleMouseUp:function(e){var t;return"function"==typeof(t=this.props).onAddPeopleMouseUp?t.onAddPeopleMouseUp(e):void 0},_onSkipAddMention:function(e){var t,n;return null!=(n=this.refs.mentionsHintDropdown)&&n.hide(),"function"==typeof(t=this.props).onSkipAddMention?t.onSkipAddMention(e):void 0},_contactsSelectorPopupHidden:function(){var e;return this.props.showMentionsHelper&&(this._clearStartToEndRangeUnicode(),0===this.$text_input.html().trim().length&&this.state.in_edit_mode&&this._getCaretPosition().top<=0&&this._resetInputToPlaceholderState()),null!=(null!=(e=this.refs.textInput)?e.getDOMNode():void 0)?this.setCursorToEndOfInput():void 0},_contactsSelectorPopupShown:function(){var t;return this.props.showMentionsHelper?(this.state.in_edit_mode||this._clearDefaultState(),setTimeout(function(){return function(){return e(".contacts-selector-popup input").trigger("focus")}}(this),100),"function"==typeof(t=this.props).contactsSelectorPopupShown?t.contactsSelectorPopupShown():void 0):void 0},_emailEnteredCallback:function(e){return this._addMentionIntoRangeUnicode(this._createMentionObject(e)),this.setCursorToEndOfInput(),this.refs.mentionsHintDropdown.hide()},_clearContactHighlightedCallback:function(){return this._clearStartToEndRangeUnicode()},_contactHighlightedCallback:function(e){var t,n;return n=(null!=e?e.data("name"):void 0)||"",t=(null!=e?e.data("identifier"):void 0)||"",this._dangerouslyInsertLiveTextWithRangeUnicode("@"+n)},_contactPopupSelectedCallback:function(e){var t;return this._addMentionIntoRangeUnicode(this._createMentionObjectFromSuggestion(e)),this.setCursorToEndOfInput(),this.refs.mentionsHintDropdown.hide(),"function"==typeof(t=this.props).contactPopupSelectedCallback?t.contactPopupSelectedCallback(e):void 0},_contactSelectedCallback:function(e){var t;return this._addMentionIntoInput(this._createMentionObjectFromSuggestion(e)),"function"==typeof(t=this.props).contactSelectedCallback?t.contactSelectedCallback(this.isInNoAtMentionMode):void 0},_addMentionIntoRangeUnicode:function(e){var t;return this._isSpaceBeforeStartUnicode()||this._dangerouslyInsertValueBeforeStartUnicode(" "),t=this._getRangeBetweenStartEndRangeUnicode(),t?(this._addMentionIntoInput(e,t),this._clearRangeUnicode()):void 0},_noAtMentionTriggerCallback:function(e){var t;if(this.props.enableNoAtMentions){if(!this.state.show_contacts&&e>0)return this.refreshDropdownDirection(),this.setState({show_contacts:!0}),this.isInNoAtMentionMode=!0,"function"==typeof(t=this.props).onNoAtSignKeyPress?t.onNoAtSignKeyPress():void 0;if(this.isInNoAtMentionMode&&0===e)return this.setState({show_contacts:!1}),this.isInNoAtMentionMode=!1}},setCursorToEndOfInput:function(){return setTimeout(function(e){return function(){var t,n;return e.focusInput(),t=e.$text_input[0].lastChild,null!=t?(n=document.createRange(),n.selectNode(t),n=n.cloneRange(),n.setStartAfter(t),n.collapse(!1),e._selection().removeAllRanges(),e._selection().addRange(n)):void 0}}(this),10)},_getCaretPosition:function(){var e,t,n,i;return t=null!=(i=this.refs.container)?i.getDOMNode().getClientRects()[0]:void 0,e={left:this.state.x_offset,top:this.state.y_offset},this._selection().rangeCount>0&&(n=this._selection().getRangeAt(0).getClientRects()[0],null!=n&&null!=t&&(e.left=n.left-t.left,e.top=this.props.shouldPopupsDropdown?n.bottom-t.top:n.top-t.top)),e},unsafeInsertHtmlAtRange:function(t,n,i){var o,r,s,a;for(n.deleteContents(),a=e("<span />").html(t)[0],o=document.createDocumentFragment();s=a.firstChild;)r=o.appendChild(s);return n.insertNode(o),r&&i&&(n=n.cloneRange(),n.setStartAfter(r),n.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(n)),r},_checkEndOfLine:function(){var t,n,r,s,a;return o.assert(null!=i.mozilla,"_checkEndOfLine called from non mozilla browser"),a=this._extractCursorInfo(),n=a[0],r=a[1],s=a[2],e(n).hasClass("text-input")&&e(this.$text_input.contents()[r]).is("br")&&r>0&&(t=this.$text_input.contents()[r-1],t.nodeType===Node.TEXT_NODE&&t.nodeValue===P)?this._setCursorLocation(t,0):void 0},_selection:function(){return window.getSelection()},_setCursorLocation:function(t,n){var i;if(null!=t){if(i=document.createRange(),t.nodeType===Node.TEXT_NODE)i.setStart(t,n);else{if(!e(t).hasClass("new-mention"))return;0===n?i.setStartBefore(t):i.setStartAfter(t)}return i.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(i)}},_updateCurrentWordBoundary:function(){var e,t,n,i,o,r,s;return s=this._extractCursorInfo(),t=s[0],n=s[1],i=s[2],r=i.slice(0,n).lastIndexOf(" ")+1,e=i.slice(0,n).lastIndexOf(S)+1,e>r&&(r=e),o=i.slice(n).indexOf(" "),o=-1===o?i.length:n+o,this.currentCursorWordStartPosition=r,this.currentCursorWordEndPosition=o},_cleanMentionHighlighting:function(t){var n,i,o,r,s;for(null==t&&(t=null),i=this.$text_input.children(),null!=t&&(i=[t]),s=[],o=0,r=i.length;r>o;o++)n=i[o],s.push(e(n).removeClass("selected"));return s},_cleanUpNbsp:function(){var e;return e=this.$text_input.html(),e=e.replace(/\u00a0/g," "),e=e.replace(/\s{2,}/g," "),this.$text_input.html(e)},_cleanUpDelimiters:function(){var t,r,s,a,l,u,c,_,d,p;for(o.assert(null==i.msie,"_cleanUpDelimiters() called from MSIE"),d=this._extractCursorInfo(),r=d[0],s=d[1],u=d[2],p=this.$text_input.contents(),c=0,_=p.length;_>c;c++)t=p[c],t.nodeType===Node.TEXT_NODE?(t.nodeValue=t.nodeValue.replace(N,""),""===t.nodeValue&&(t!==r?t.parentNode.removeChild(t):s=0)):e(t).hasClass("new-mention")&&(l=document.createTextNode(n.sanitize(P)),t.parentNode.insertBefore(l,t),a=document.createTextNode(n.sanitize(P)),t.parentNode.insertBefore(a,t.nextSibling));return null!=r&&r.nodeType===Node.TEXT_NODE&&r.nodeValue.length<s&&(s=r.nodeValue.length),this._setCursorLocation(r,s),null==i.mozilla&&null!=r&&""===r.nodeValue?r.parentNode.removeChild(r):void 0},_checkAndMergeAdjacentNodes:function(){var t,n,r,s,l,u,c,_,d,p;return o.assert(null!=i.msie,"_checkAndMergeAdjacentNodes called from non IE browser"),d=this._extractCursorInfo(),l=d[0],u=d[1],_=d[2],!e(l).hasClass("text-input")&&!e(l).is("p")||(p=event.keyCode)!==a.BACKSPACE&&p!==a.DELETE||(t=e(l).contents()[u],(null!=t?t.nodeType:void 0)!==Node.TEXT_NODE)?void 0:(r=t.nodeValue,n=0,c=t.previousSibling,s=t.nextSibling,null!=c&&c.nodeType===Node.TEXT_NODE&&(n=c.nodeValue.length,r=c.nodeValue+r,c.parentNode.removeChild(c)),null!=s&&s.nodeType===Node.TEXT_NODE&&(r+=s.nodeValue,s.parentNode.removeChild(s)),t.nodeValue=r,this._setCursorLocation(t,n))},_isCursorAfterSpaceOrBeginningOfLine:function(e,t){var n;if(t-1>=0){if(n=e.slice(t-1,t)," "===n||""===n||"Â "===n)return!0}else if(0===t)return!0;return!1},_extractCursorInfo:function(){var e,t,n;return e=this._selection().focusNode,t=this._selection().focusOffset,n="",null!=e&&e.nodeType===Node.TEXT_NODE&&(n=e.nodeValue.length?e.nodeValue:""),[e,t,n]},_clearDefaultState:function(){return this.state.default_state&&this._clearInputWithoutBlurring(),this.state.in_edit_mode?void 0:this.setState({in_edit_mode:!0})},_clearInputWithoutBlurring:function(){return null!=i.msie?this.$text_input[0].innerText="":this.$text_input[0].textContent=""},clearTextField:function(){return this._clearInputWithoutBlurring(),this.setState({in_edit_mode:!1}),this.$text_input.blur()},_onInputKeydownMozilla:function(e){var t,n,r,s,l,u,c,_;if(o.assert(null!=i.mozilla,"_onInputKeydownMozilla called from non mozilla browser"),this._cleanUpDelimiters(),this._checkEndOfLine(),u=this._extractCursorInfo(),n=u[0],r=u[1],l=u[2],null!=n&&n.nodeType===Node.TEXT_NODE)if(s=n.previousSibling,t=n.nextSibling,(c=e.keyCode)===a.DELETE||c===a.RIGHT){if(l===P&&null!=t&&this._toggleMentionSelectState(t,e))return this._setCursorLocation(n,1);if(l.length!==r||null==t||t.nodeType!==Node.TEXT_NODE||t.nodeValue!==P)return this._cleanMentionHighlighting();if(null!=t.nextSibling&&this._toggleMentionSelectState(t.nextSibling,e))return this._setCursorLocation(t,1)}else if(((_=e.keyCode)===a.BACKSPACE||_===a.LEFT)&&0===r&&null!=s){if(l===P&&this._toggleMentionSelectState(s,e))return this._setCursorLocation(n,0);if(s.nodeType===Node.TEXT_NODE&&s.nodeValue===P&&null!=s.previousSibling&&this._toggleMentionSelectState(s.previousSibling,e))return this._setCursorLocation(s,0)}},_onInputKeydownMsie:function(t){var n,r,s,l,u,c,_,d,p,h,f;if(o.assert(null!=i.msie,"_onInputKeydownMsie called from non MSIE browser"),_=this._extractCursorInfo(),s=_[0],l=_[1],c=_[2],null!=s){if(e(s).hasClass("text-input")||e(s).is("p"))return n=e(s).contents(),((d=t.keyCode)===a.BACKSPACE||d===a.LEFT)&&l>0&&e(n[l-1]).hasClass("new-mention")?this._toggleMentionSelectState(n[l-1],t):(p=t.keyCode)!==a.DELETE&&p!==a.RIGHT||!e(n[l]).hasClass("new-mention")?this._cleanMentionHighlighting():this._toggleMentionSelectState(n[l],t);if(u=s.previousSibling,r=s.nextSibling,(h=t.keyCode)===a.BACKSPACE||h===a.LEFT){if(0===l&&null!=u&&e(u).hasClass("new-mention"))return this._toggleMentionSelectState(u,t)}else{if((f=t.keyCode)!==a.DELETE&&f!==a.RIGHT)return this._cleanMentionHighlighting();if(l===c.length&&null!=r&&e(r).hasClass("new-mention"))return this._toggleMentionSelectState(r,t)}}},_onInputKeydownWebkit:function(e){var t,n,r,s,l,u,c,_;if(o.assert(null!=i.webkit,"_onInputKeydownWebkit called from non webkit browser"),this._cleanUpDelimiters(),u=this._extractCursorInfo(),n=u[0],r=u[1],l=u[2],null!=n&&n.nodeType===Node.TEXT_NODE)if(s=n.previousSibling,t=n.nextSibling,(c=e.keyCode)===a.BACKSPACE||c===a.LEFT){if(null!=s&&l===P&&this._toggleMentionSelectState(s,e)){if(e.keyCode===a.BACKSPACE)return this._setCursorLocation(n,r-1);if(e.keyCode===a.LEFT)return this._setCursorLocation(s.previousSibling,1)}}else{if((_=e.keyCode)!==a.DELETE&&_!==a.RIGHT)return this._cleanMentionHighlighting();if(r!==l.length||null==t||t.nodeType!==Node.TEXT_NODE||t.nodeValue!==P&&0!==t.nodeValue.length){if(l===P&&0===r&&null!=t&&this._toggleMentionSelectState(t,e)){if(e.keyCode===a.DELETE)return this._setCursorLocation(n,1);if(e.keyCode===a.RIGHT)return this._setCursorLocation(t,1)}}else if(null!=t.nextSibling&&this._toggleMentionSelectState(t.nextSibling,e)){if(e.keyCode===a.DELETE)return this._setCursorLocation(t,1);if(e.keyCode===a.RIGHT)return this._setCursorLocation(t.nextSibling,1)}}},_onInputKeydown:function(e){var t,n,o,r,s,l,u,c;if(n=this._normalizeKeycode(e),this.setState({default_state:!1,last_keydown:n}),n!==a.PROCESSING)if(!(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)||n!==a.BACKSPACE&&n!==a.DELETE&&n!==a.LEFT&&n!==a.RIGHT?this._cleanMentionHighlighting():null!=i.webkit?this._onInputKeydownWebkit(e):null!=i.mozilla?this._onInputKeydownMozilla(e):null!=i.msie&&this._onInputKeydownMsie(e),"function"==typeof(l=this.props).onKeyDown&&l.onKeyDown(e),c=this._extractCursorInfo(),o=c[0],r=c[1],s=c[2],this.state.show_contacts){if(__indexOf.call(O,n)>=0){if(e.preventDefault(),n===a.ESC||0===this.contacts_selector.get_suggestions_count()&&n===a.ENTER)return this.setState({show_contacts:!1})}else if(n===a.BACKSPACE&&(null!=o?o.nodeType:void 0)===Node.TEXT_NODE&&r>0&&(t=s.substr(r-1,1),"@"===t&&this._isCursorAfterSpaceOrBeginningOfLine(s,r-1)))return this.setState({show_contacts:!1})}else if(n===a.ESC)return"function"==typeof(u=this.props).onCancel?u.onCancel():void 0},_onInputKeypress:function(t){var n,o,r,s,l,u,c,_,d;return d=this._extractCursorInfo(),s=d[0],l=d[1],u=d[2],this._normalizeKeycode(t)===a.AT_SIGN&&!this.state.mention_triggered&&("function"==typeof(c=this.props).position_contacts_callback&&c.position_contacts_callback(),o=!1,s.nodeType===Node.TEXT_NODE?this._isCursorAfterSpaceOrBeginningOfLine(u,l)&&(o=!0,n=l):(e(s).hasClass("text-input")||null!=i.msie&&e(s).is("p"))&&(o=!0,n=0),o)?(r={search_start_position:n,search_end_position:n,mention_triggered:!0},this.setState(r),"function"==typeof(_=this.props).onAtSignKeyPress?_.onAtSignKeyPress():void 0):void 0},_onInputKeyup:function(e){var t,n,r,s,l,u,c,_,d,p,h,f;if(this.state.last_keydown===a.PROCESSING)return void o.assert(null!=i.webkit,"PROCESSING keycode detected in non-webkit browser");if(null!=i.msie&&this._checkAndMergeAdjacentNodes(),d=this._extractCursorInfo(),s=d[0],l=d[1],c=d[2],this.props.enableNoAtMentions&&this._updateCurrentWordBoundary(),r={},this.state.mention_triggered&&(r.mention_triggered=!1,r.show_contacts=!0,l-this.state.search_start_position>1&&(t=c.slice(this.state.search_start_position+1,l).indexOf("@"),r.show_contacts=-1===t?!0:!1)),!this.state.show_contacts&&!r.show_contacts||this.isInNoAtMentionMode)this.props.enableNoAtMentions&&(h=e.keyCode,__indexOf.call(O,h)>=0&&this.state.show_contacts&&this.contacts_selector.get_suggestions_count()>0?this.contacts_selector.navigate_suggestions(e):e.keyCode!==a.ESC&&this.contacts_selector.get_suggestions(c.slice(this.currentCursorWordStartPosition,this.currentCursorWordEndPosition).trim(),!1));else if(p=e.keyCode,__indexOf.call(O,p)>=0&&this.contacts_selector.get_suggestions_count()>0)this.contacts_selector.navigate_suggestions(e);else if(l<=this.state.search_start_position||s.nodeType!==Node.TEXT_NODE)r.show_contacts=!1;else if(e.keyCode===a.SPACE)if(u=this._parseMentionQuery(c,this.state.search_end_position).trim(),0!==u.length){if(R(u))return n=this._createMentionObject(u),this._addMentionIntoInput(n),void this._logEmailEntered(u);this.contacts_selector.get_suggestions(u,!0)}else this.setState({show_contacts:!1});else this.contacts_selector.get_suggestions(this._parseMentionQuery(c,l).trim(),!0);return(e.keyCode===a.ENTER||e.keyCode===a.TAB||e.keyCode===a.SPACE&&!this.state.show_contacts&&!r.show_contacts)&&this._parseInputTextAndReplace(),null==i.msie&&(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)&&this._cleanUpDelimiters(),"function"==typeof(_=this.props).onKeyUp&&_.onKeyUp(e),f=this._normalizeKeycode(e),__indexOf.call(O,f)>=0&&this.state.show_contacts?void 0:this.setState(r,function(e){return function(){var t;return"function"==typeof(t=e.props).resizeCallback?t.resizeCallback():void 0}}(this))},_normalizeKeycode:function(e){return e.keyCode||e.which||e.charCode},_onInputBlur:function(){var e,t;return this._parseInputTextAndReplace(),"function"==typeof(t=this.props).onBlur&&t.onBlur(),e={show_contacts:!1,default_state:!1},!this.state.in_edit_mode||this.getEncodedMessage().length||this.props.shouldAlwaysInEditMode||(e.in_edit_mode=!1,e.search_end_position=-1,e.search_start_position=-1),this.setState(e)},_onInputFocus:function(e){var t,n;return e.target===this.$text_input.get(0)?("function"==typeof(n=this.props).onFocus&&n.onFocus(),t={show_contacts:!1},this.state.in_edit_mode||(t.in_edit_mode=!0,t.search_end_position=-1,t.search_start_position=-1),setTimeout(function(e){return function(){return e.isMounted()?e.setState(t):void 0}}(this),0)):void 0},_onInputMouseDown:function(){return this.setState({default_state:!1}),this._cleanMentionHighlighting()},_onInputPaste:function(e){var t;return this.setState({default_state:!1}),"function"==typeof(t=this.props).onPaste?t.onPaste(e):void 0},_createMentionObjectFromSuggestion:function(e){var t,n,i;return i=e.data("name"),n=e.data("identifier"),t=e.data("dbx-account-id"),this._createMentionObject(n,i,t)},_createMentionObject:function(e,t,n){return null==t&&(t=null),null==n&&(n=null),t||(t=e),n&&(e=n),{name:t,identifier:e,dbx_account_id:n}},_toggleMentionSelectState:function(t,n){if(e(t).hasClass("new-mention")){if(e(t).hasClass("selected"))return this._cleanMentionHighlighting(t),!0;n.stopPropagation(),n.preventDefault(),e(t).addClass("selected")}return!1},_onMentionMouseDown:function(e){var t;return e.preventDefault(),e.stopPropagation(),0===e.button?(this._cleanMentionHighlighting(),this._toggleMentionSelectState(e.target,e),t=document.createRange(),t.selectNode(e.target),this._selection().removeAllRanges(),this._selection().addRange(t)):null!=i.mozilla&&2===e.button?this._setCursorLocation(e.target,1):void 0},_mentionWrapper:function(e,t,n){return null!=i.webkit?"<span class='new-mention' data-id=\""+e+'" data-name="'+t+'" data-dbx-account-id="'+n+'">'+t+"</span>":'<input type="button" class=\'new-mention\' data-id="'+e+'" data-name="'+t+'" data-dbx-account-id="'+n+'" value="'+t+'"></input>'},_parseMentionQuery:function(e,t){var n;return t>this.state.search_end_position?this.setState({search_end_position:t}):t=this.state.search_end_position,n="",t<=e.length?n=e.slice(this.state.search_start_position,t):this.state.search_start_position<=e.length&&(this.setState({search_end_position:e.length}),n=e.slice(this.state.search_start_position)),n.replace("@","")},_addMentionIntoInput:function(t,o){var r,s,a,l,u,c,_,d,p,h,f,m;return u=this.refs.textInput.getDOMNode(),h=this._mentionWrapper(t.identifier,t.name,t.dbx_account_id),c=e(n.sanitize(h))[0],null!=i.webkit?c.setAttribute("contenteditable","false"):null!=i.mozilla&&c.setAttribute("style","margin-left:-3px; margin-right:-3px"),e(c).mousedown(function(e){return function(t){return e._onMentionMouseDown(t)}}(this)),null==o&&(m=this._extractCursorInfo(),a=m[0],l=m[1],p=m[2],o=document.createRange(),d=this.state.search_start_position,r=this.state.search_end_position,this.state.show_contacts||(this.setState({search_start_position:a.length}),this.setState({search_end_position:a.length}),d=a.length,r=a.length),this.isInNoAtMentionMode&&(d=this.currentCursorWordStartPosition,r=this.currentCursorWordEndPosition),o.setStart(a,d),o.setEnd(a,r)),c=this.unsafeInsertHtmlAtRange(c,o,!0),s=c.nextSibling,null!=s&&s.nodeType===Node.TEXT_NODE?(s.nodeValue=S+s.nodeValue,this._setCursorLocation(s,1)):(_=document.createTextNode(n.sanitize(S)),e(_).insertAfter(c),this._setCursorLocation(_,1)),"function"==typeof(f=this.props).onMention&&f.onMention(t),this.setState({show_contacts:!1})},focusInput:function(){var e;return this.setState({in_edit_mode:!0}),e=this.refs.textInput.getDOMNode(),e.focus()},disableMentions:function(){return this.state.show_contacts?this.setState({show_contacts:!1}):void 0},mentionsEnabled:function(){return this.state.show_contacts},_encodedMention:function(e){return"@[%(identifier)s:%(name)s]".format({identifier:e.identifier,name:e.name})},extractMentions:function(){var t,n,i,o,r,s,a,l;for(o=this.$text_input.find(".new-mention"),r=[],a=0,l=o.length;l>a;a++)i=o[a],n=e(i).data("id"),s=e(i).data("name"),t=e(i).data("dbx-account-id"),r.push(this._createMentionObject(n,s,t));return r},_encodeHtml:function(t){var n,i,o,r,s,a,l,u,c;if(o="",r=!1,t=t.replace(N,""),null!=t&&""!==t)for(c=e.parseHTML(t),l=0,u=c.length;u>l;l++)n=c[l],n.nodeType===Node.TEXT_NODE&&""!==n.nodeValue?(r=!0,o+=n.nodeValue):n instanceof HTMLParagraphElement?(r=!0,o=o+this._encodeHtml(e(n).html())+"\n"):e(n).hasClass("new-mention")?(r=!0,i=e(n).data(),s=this._createMentionObject(i.id,i.name),o+=this._encodedMention(s)):e(n).is("br")?o+="\n":e(n).is("div")?(a=e(n).text(),r=r||a.length>0,o=o+"\n"+a):(a=e(n).text(),r=r||a.length>0,o+=a);return o!==this.props.placeholder_text&&r?o:""},getRawMessage:function(){return this.$text_input.html()},getEncodedMessage:function(){var e;return e=this.$text_input.html(),this._encodeHtml(e)},_postSticker:function(e){var t,n;return"function"==typeof(t=this.props).onAddSticker&&t.onAddSticker(e),null!=(n=this.refs.stickerDropdown)?n.hide():void 0},_renderStickerButton:function(){var e,t,n;return n=A.a({className:"comment-sticker-add",onMouseUp:this.props.onStickerPopupShown},A.div({className:"comment-sticker-icon"})),e=this.props.shouldPopupsDropdown?"top":"bottom",t=this.props.shouldPopupsDropdown?4:-11,A.div({className:"comment-sticker-button",onMouseDown:this.refreshDropdownDirection},g({target:n,ref:"stickerDropdown",arrow_position:""+e+"-right",vertical_displacement:t,extra_css_class:"stickers-bubble-dropdown",extra_target_css_class:"stickers-bubble-target",horizontal_displacement:1,anchor_bottom:!this.props.shouldPopupsDropdown},k({isPopupAbove:this.props.shouldPopupsDropdown,onStickerSelected:this._postSticker})))},render:function(){var e,n,o,r,s,a,l,u,_,d;return s={"text-input":!0,"edit-mode":this.state.in_edit_mode},l=I(s),a=!0,null!=i.webkit&&(a="plaintext-only"),e={ref:"textInput",className:l,contentEditable:a,defaultValue:this.props.initialText,onKeyPress:this._onInputKeypress,onKeyDown:this._onInputKeydown,onKeyUp:this._onInputKeyup,onFocus:this._onInputFocus,onBlur:this._onInputBlur,onPaste:this._onInputPaste,onMouseDown:this._onInputMouseDown},c=A.div({className:"mention-text-input-wrapper"},A.div(e,this.state.in_edit_mode?void 0:this.props.placeholder_text)),d=v({ref:"contactSelector",contactSelectedCallback:this._contactSelectedCallback,noAtMentionTriggerCallback:this._noAtMentionTriggerCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.shouldPopupsDropdown,y_offset:this.state.y_offset,x_offset:this.state.x_offset,user:this.props.user,last_keydown:this.state.last_keydown,resultsLimit:this.props.resultsLimit,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),u=t.addons.classSet({"mentions-container":!0,"mentions-container-w-hint":this.props.showMentionsHelper}),_=t.addons.classSet({"mentions-input":!0,"animating-highlight":this.props.shouldInitiallyFocusInput}),A.div({className:u,ref:"container"},A.div({className:_,ref:"input"},c,this.props.showMentionsHelper?(o=A.a({className:"comment-mention-hint-add",onMouseUp:this._contactsSelectorPopupShown},T({group:"web",name:"s_mention_add"})),n=this.props.shouldPopupsDropdown?"top":"bottom",r=this.props.shouldPopupsDropdown?0:-16,A.div({className:"comment-mention-hint"},x({position:p.TooltipPosition.LEFT,tooltip_contents:C({},"@mention someone"),tooltip_classname:"notification-names-tooltip"},A.div({className:"comment-mention-hint-button",onMouseDown:this.refreshDropdownDirection},g({target:o,ref:"mentionsHintDropdown",arrow_position:""+n+"-right",vertical_displacement:r,horizontal_displacement:3,anchor_bottom:!this.props.shouldPopupsDropdown,extra_css_class:"mentions-helper-bubble-dropdown",bubbleDropdownHidden:this._contactsSelectorPopupHidden},y({key:"mentionsContactSelectorPopup",ref:"mentionsContactSelectorPopup",shouldShowNoNotifyHint:this.props.shouldShowNoNotifyHint,user:this.props.user,contactSearchLogger:this.props.contactSearchLogger,emailEnteredCallback:this._emailEnteredCallback,contactSelectedCallback:this._contactPopupSelectedCallback,contactHighlightedCallback:this._contactHighlightedCallback,clearContactHighlightedCallback:this._clearContactHighlightedCallback,should_dropdown:this.props.shouldPopupsDropdown,onAddPeopleMouseUp:this._onAddPeopleMouseUp,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars})))))):void 0,this.props.shouldEnableStickers?this._renderStickerButton():void 0),d)}})}),define("modules/clean/react/activity/resolve_button",["external/react","modules/core/i18n","modules/clean/react/sprite","modules/clean/react/tooltip"],function(e,t,n){var i,o;return o=e.DOM,i=e.createClass({displayName:"ResolveButton",propTypes:{resolved:e.PropTypes.bool.isRequired,update_resolved:e.PropTypes.func.isRequired},render:function(){var e;return e={className:"resolved-icon",onClick:function(e){return function(){return e.props.update_resolved(!e.props.resolved)}}(this),onMouseEnter:function(e){return function(){return e.setState({hover:!0})}}(this),onMouseLeave:function(e){return function(){return e.setState({hover:!1})}}(this)},this.props.resolved?o.div({className:"resolve-wrapper"},o.div(e,n({group:"web",name:"s_greencheck"})),this.state.hover?o.div({className:"unresolve-text"},t._("Unresolve")):void 0):this.props.resolved?void 0:o.div({className:"resolve-wrapper"},o.div(e,n({group:"web",name:"s_greycheck"})),this.state.hover?o.div({className:"resolve-text"},t._("Resolve")):void 0)},getInitialState:function(){return{hover:!1}}})}),define("modules/clean/react/activity/time_counter",["external/react","modules/clean/datetime"],function(e,t){var n,i;return i=e.DOM,n=e.createClass({render:function(){var e;return e=t.ago(new Date(this.props.when_mses)),i.div({className:"activity-time-ago"},e)},updateLoop:function(){},componentDidMount:function(){return this.updateLoop()},getUpdateInterval:function(){return 5e3}})}),define("modules/clean/react/activity/users_to_notify",["external/react","modules/core/i18n","modules/clean/react/tooltip"],function(e,t,n){var i,o,r,s;return s=t._,r=t.ungettext,o=e.DOM,i=e.createClass({propTypes:{usersToNotify:e.PropTypes.array.isRequired,user:e.PropTypes.object.isRequired,show_extra_text:e.PropTypes.bool.isRequired},render:function(){var e,t,i,a,l,u;return e=null==this.props.usersToNotify?[]:function(){var e,t,n,i;for(n=this.props.usersToNotify,i=[],e=0,t=n.length;t>e;e++)u=n[e],u.id!==this.props.user.id&&i.push(u);return i}.call(this.props.user.is_signed_in?this:this),e.length>0?(l=o.div({className:"notification-names-container"},function(){var t,n,i;for(i=[],t=0,n=e.length;n>t;t++)u=e[t],i.push(function(){return function(e){return o.div({key:e.id},e.get_display_identity())}}(this)(u));return i}.call(this)),i=this.props.show_extra_text?r('Comments will notify <span class="blue">%(num)s person</span>. Anyone who can view this file can comment.','Comments will notify <span class="blue">%(num)s people</span>. Anyone who can view this file can comment.',e.length).format({num:e.length}):r('Comments will notify <span class="blue">%(num)s person</span>','Comments will notify <span class="blue">%(num)s people</span>',e.length).format({num:e.length}),t=o.div({dangerouslySetInnerHTML:{__html:i},className:"notification-names-target"}),n.Tooltip({position:n.TooltipPosition.TOP,tooltip_contents:l,tooltip_classname:"notification-names-tooltip"},t)):(a=s(this.props.show_extra_text?"Comments won't notify anyone yet. Anyone who can view this file can comment.":"Comments won't notify anyone yet"),o.div({dangerouslySetInnerHTML:{__html:a},className:"notification-names-target"}))}})}),define("modules/clean/react/activity/users_to_notify_facepile",["external/react","modules/core/i18n","modules/clean/react/tooltip","modules/clean/avatar/components"],function(e,t,n,i){var o,r,s,a,l,u,c,_;return _=t._,c=t.ungettext,o=i.AvatarWithDefault,r=i.InitialsAvatar,l=i.ViewerAvatar,u=e.DOM,s=6,a=e.createClass({propTypes:{usersToNotify:e.PropTypes.array.isRequired,user:e.PropTypes.object.isRequired},render:function(){var e,t,i,o,a,c,_,d,p,h,f;for(i=function(){var e,t,n,i;for(n=this.props.usersToNotify,i=[],e=0,t=n.length;t>e;e++)d=n[e],i.push(d);return i}.call(this),e=[],c=[],p=function(){return function(t){return s>o?e.push(t):c.push(t)}}(this),o=h=0,f=i.length;f>h;o=++h)d=i[o],p(d);return u.div({className:"notify-facepile-container"},function(){var i,o,s;for(s=[],i=0,o=e.length;o>i;i++)d=e[i],t=u.div({},d.display_name),s.push(u.div({className:"notify-facepile-photo",key:d.id},n.Tooltip({position:n.TooltipPosition.BOTTOM,tooltip_contents:t,tooltip_classname:"notification-names-tooltip"},l({dimension:32,photoUrl:d.photo_circle_url,defaultAvatar:new r({dimension:32,shape:"CIRCLE",initials:d.initials}),key:d.id}))));return s}(),i.length>s?(_=u.div({},function(){var e,t,n;for(n=[],e=0,t=c.length;t>e;e++)a=c[e],n.push(u.div({},a.get_display_identity()));return n}()),n.Tooltip({position:n.TooltipPosition.BOTTOM,tooltip_contents:_,tooltip_classname:"notification-names-tooltip"},u.div({className:"notify-facepile-more"},"+"+(i.length-s)))):void 0)}})}),define("modules/clean/react/bubble_dropdown",["jquery","external/jquery_ui","external/keymaster","external/react","external/underscore"],function(e,t,n,i,o){var r,s,a,l,u;return l=i.DOM,a="react-bubble-dropdown-root",u=function(){var t;return t=e("#"+a),t.length||(t=e("<div />").attr({id:a}).prependTo("body")),t[0]},s=i.createClass({displayName:"BubbleDropdownContents",propTypes:{target_node:i.PropTypes.instanceOf(HTMLElement).isRequired,arrow_position:i.PropTypes.oneOf(["top","top-left","top-right","bottom","bottom-left","bottom-right","right","right-top","right-bottom","left","left-top","left-bottom"]).isRequired,vertical_displacement:i.PropTypes.number,horizontal_displacement:i.PropTypes.number,anchor_bottom:i.PropTypes.bool,show_arrow:i.PropTypes.bool,extra_css_class:i.PropTypes.string},componentDidMount:function(){var t,n,i,o,r,s,l,u,c,_,d,p,h,f,m,g;switch(o=this._arrow_direction(),this.target_position={top:"bottom",left:"right",bottom:"top",right:"left"}[o],i=e(this.props.target_node),n=e(this.refs.dropdown.getDOMNode()),t=e(this.refs.arrow.getDOMNode()),d=e("#"+a).position().top,g=t.outerWidth(),l=t.outerHeight(),p=t.position().top,u=this.props.horizontal_displacement||0,c=t.position().left+u,m=this.props.vertical_displacement||0,h=l+d,this._arrow_direction()){case"left":r=0>h?"left+"+g+"px top+"+-h+"px":"left+"+g+"px top-"+h+"px";break;case"right":r=0>h?"right-"+g+"px top+"+-h+"px":"right-"+g+"px top-"+h+"px";break;case"top":h=l-d-m,r=0>h?"left-"+c+"px top-"+-h+"px":"left-"+c+"px top+"+h+"px";break;case"bottom":s=l+d-m,r=0>s?"left-"+c+"px bottom+"+-s+"px":"left-"+c+"px bottom-"+s+"px"}return f=function(e){return function(t){var n,o,r;return r=t.top,o=t.left,e.props.anchor_bottom?(n=document.documentElement.clientHeight-i.offset().top-m,e.setState({dropdown_style:{bottom:n,left:o}})):e.setState({dropdown_style:{top:r,left:o}})}}(this),_={my:r,at:this.target_position,of:i,collision:"none",using:f},n.position(_),n.position(_),this.props.show_arrow?void 0:(t.css("visibility","hidden"),e(".bubble-arrow-border").css("visibility","hidden"))},render:function(){return this.state.dropdown_style.display="right"===this._arrow_direction()?"block":"inline-block",l.div({className:"bubble-dropdown "+this.props.extra_css_class+" "+this.props.arrow_position,style:this.state.dropdown_style,ref:"dropdown"},this.props.children,l.div({className:"bubble-arrow-border"}),l.div({className:"bubble-arrow",ref:"arrow"}))},_arrow_direction:function(){var e;return"top"===this.props.arrow_position.substring(0,3)?e="top":"bottom"===this.props.arrow_position.substring(0,6)?e="bottom":"left"===this.props.arrow_position.substring(0,4)?e="left":"right"===this.props.arrow_position.substring(0,5)&&(e="right"),e},getInitialState:function(){return{dropdown_style:{}}}}),r=i.createClass({displayName:"BubbleDropdown",propTypes:{target:i.PropTypes.element.isRequired,arrow_position:i.PropTypes.oneOf(["top","top-left","top-right","bottom","bottom-left","bottom-right","right","right-top","right-bottom","left","left-top","left-bottom"]).isRequired,vertical_displacement:i.PropTypes.number,horizontal_displacement:i.PropTypes.number,show_arrow:i.PropTypes.bool,anchor_bottom:i.PropTypes.bool,extra_css_class:i.PropTypes.string,extra_target_css_class:i.PropTypes.string,bubbleDropdownShown:i.PropTypes.func,bubbleDropdownHidden:i.PropTypes.func,position:i.PropTypes.oneOf(["static","relative","fixed","absolute"])},getInitialState:function(){return this.eventId=o.uniqueId(),{}},getDefaultProps:function(){return{vertical_displacement:0,horizontal_displacement:0,
anchor_bottom:!1,show_arrow:!0,extra_css_class:"",extra_target_css_class:"",position:"fixed"}},render:function(){return l.span({className:"bubble-dropdown-container"},l.div({className:"bubble-dropdown-target "+this.props.extra_target_css_class,ref:"target",onMouseDown:this.preventSelection,onMouseUp:this.toggle},this.props.target))},render_tooltip:function(){var t,n;return n=u(),i.unmountComponentAtNode(n),this.shown?(e("#"+a).css("position",this.props.position),this.props.anchor_bottom?(e("#"+a).css("bottom","0"),e("#"+a).css("top","auto")):(e("#"+a).css("top","0"),e("#"+a).css("bottom","auto")),t=i.createElement(s,{target_node:this.refs.target.getDOMNode(),arrow_position:this.props.arrow_position,vertical_displacement:this.props.vertical_displacement,horizontal_displacement:this.props.horizontal_displacement,anchor_bottom:this.props.anchor_bottom,show_arrow:this.props.show_arrow,extra_css_class:this.props.extra_css_class},this.props.children),i.render(t,n)):void 0},preventSelection:function(e){return e.preventDefault()},componentDidMount:function(){return this.shown=!1,this.$target=e(this.refs.target.getDOMNode()),this.bodyClickHandler=function(t){return function(n){var i,o;if(t.shown)return i=e(n.target),i.is("select")?!0:(o=i.closest(t.$target).length||i.closest(e("#"+a)).length,o||t.hide(),!0)}}(this),e("body").on("mouseup."+this.eventId,this.bodyClickHandler)},bindDocHandlers:function(){return this.hasBindedDocHandlers?void 0:(key("esc",this.hideIfShown),e("*").on("scroll."+this.eventId,this.hideIfShown),e(window).on("scroll."+this.eventId,this.hideIfShown),e(window).on("resize."+this.eventId,this.hideIfShown),this.hasBindedDocHandlers=!0)},unbindDocHandlers:function(){return this.hasBindedDocHandlers?(e("body").off("mouseup."+this.eventId),e("*").off("scroll."+this.eventId),e(window).off("scroll."+this.eventId),e(window).off("resize."+this.eventId),this.hideIfShown()):void 0},hideIfShown:function(){return this.shown?this.hide():void 0},componentWillUnmount:function(){return this.unbindDocHandlers(),e("body").off("mouseup."+this.eventId,this.bodyClickHandler)},toggle:function(){this.shown?this.hide():this.show()},show:function(){var t;return this.shown=!0,e(this.refs.target.getDOMNode()).addClass("bubble-dropdown-target--active"),this.render_tooltip(),"function"==typeof(t=this.props).bubbleDropdownShown&&t.bubbleDropdownShown(),this.bindDocHandlers()},hide:function(){var t;return this.shown=!1,e(this.refs.target.getDOMNode()).removeClass("bubble-dropdown-target--active"),this.render_tooltip(),"function"==typeof(t=this.props).bubbleDropdownHidden?t.bubbleDropdownHidden():void 0}})}),define("modules/clean/react/button",["external/react"],function(e){var t,n,i;return i=e.DOM,n=e.addons.classSet,t=function(t,o){return e.createClass({displayName:o,propTypes:{importance:e.PropTypes.string,variant:e.PropTypes.string,disabled:e.PropTypes.bool,children:e.PropTypes.node,className:e.PropTypes.string},render:function(){var e,o;return o=this.props.importance||"primary",e={},e["button-"+o]=!0,e["button-"+this.props.variant]=null!=this.props.variant&&"standard"!==this.props.variant,this.transferPropsTo(i[t]({className:n(e),disabled:this.props.disabled?!0:void 0},this.props.children))}})},{button:t("button","button"),link_button:t("a","link_button")}}),define("modules/clean/react/file_comments/annotation_bubble",["jquery","external/react","modules/core/i18n","modules/clean/activity/activity_user","modules/clean/keycode","modules/clean/storage","modules/clean/react/activity/comment_input","modules/core/browser"],function(e,t,n,i,o,r,s,a){var l,u,c,_,d,p;return p=n._,c=r.LocalStorage,d=t.DOM,_=t.addons.classSet,u=t.createFactory(s),l=t.createClass({displayName:"AnnotationBubble",propTypes:{user:t.PropTypes.object,activity:t.PropTypes.object,contextActivityStore:t.PropTypes.object,x:t.PropTypes.number,y:t.PropTypes.number,showBubble:t.PropTypes.bool,in_blank_state:t.PropTypes.bool,onAddComment:t.PropTypes.func,onCancelComment:t.PropTypes.func,annotation:t.PropTypes.object,position:t.PropTypes.string},getInitialState:function(){return this.tempEnteredText="",{}},getDefaultProps:function(){return{position:"top"}},componentDidMount:function(){return{}},componentWillUpdate:function(e){var t;return this.props.showBubble===!0&&e.showBubble===!1&&this._getRawCommentInput().length>0&&this._getRawCommentInput()!==(null!=(t=this.refs.commentInput)?t.getPlaceholderText():void 0)?this.tempEnteredText=this._getRawCommentInput():void 0},componentDidUpdate:function(e){return e.showBubble===!1&&this.props.showBubble===!0&&(null!=a.mozilla&&document.activeElement.blur(),this._focusOnCommentInput(),null!=a.mozilla)?this.refs.commentInput.setCursorToEndOfInput():void 0},onInputFocus:function(){return{}},onInputBlur:function(){return{}},onAddComment:function(e){var t;return"function"==typeof(t=this.props).onAddComment&&t.onAddComment(e,this.props.annotation),this.tempEnteredText=""},onCancelComment:function(){var e;return"function"==typeof(e=this.props).onCancelComment?e.onCancelComment():void 0},_focusOnCommentInput:function(){var e;return null!=(e=this.refs.commentInput)?e.focusInput():void 0},_getRawCommentInput:function(){var e;return null!=(e=this.refs.commentInput)?e.getRawCommentInput():void 0},_renderCommentBox:function(){return d.div({className:"annotation-bubble__field"},u({ref:"commentInput",activity:this.props.activity,user:this.props.user,initialText:this.tempEnteredText,inBlankState:!1,enableNotifyText:!1,enableNoNotifyHint:!1,commentMetadataAllowed:!0,shouldPopupsDropdown:!1,shouldAlwaysInEditMode:!0,onAddComment:this.onAddComment,onCancelComment:this.onCancelComment,onFocus:this.onInputFocus,onBlur:this.onInputBlur}))},render:function(){var e,t;return t={"fade-in":this.props.showBubble,"fade-out":!this.props.showBubble,"annotation-bubble-container":!0},e=[],this.props.showBubble&&(e=[d.div({className:"annotation-bubble bubble-dropdown "+this.props.position,style:{left:this.props.x||0,top:this.props.y||0}},this._renderCommentBox(),d.div({className:"bubble-arrow-border"}),d.div({className:"bubble-arrow"}))]),d.div({className:_(t)},this.props.showBubble?e:void 0)}})}),define("modules/clean/react/file_comments/annotation_comments_list_ui_bubble",["external/react","modules/core/i18n","modules/clean/activity/activity_user","modules/clean/activity/file_viewer_state","modules/clean/datetime","modules/clean/keycode","modules/clean/react/file_comments/threaded_comment_activity_ui","modules/clean/storage","modules/clean/react/activity/comment_activity_ui"],function(e,t,n,i,o,r,s,a,l){var u,c,_,d,p,h,f;return f=t._,_=a.LocalStorage,h=e.DOM,p=e.addons.classSet,c=e.createFactory(l),d=e.createFactory(s),u=e.createClass({displayName:"AnnotationCommentsListUIBubble",propTypes:{user:e.PropTypes.object,activity:e.PropTypes.object,contextActivityStore:e.PropTypes.object,fileViewerState:e.PropTypes.object,x:e.PropTypes.number,y:e.PropTypes.number,showBubble:e.PropTypes.bool,annotation:e.PropTypes.object,commentActivity:e.PropTypes.object,onDeleteComment:e.PropTypes.func,onLikeComment:e.PropTypes.func,onMouseLeave:e.PropTypes.func,onMouseOver:e.PropTypes.func,onUpdateResolve:e.PropTypes.func,onAddCommentFromList:e.PropTypes.func,onAddSticker:e.PropTypes.func,position:e.PropTypes.string,isThreadingEnabled:e.PropTypes.bool},getInitialState:function(){return{button_disabled:!0,show_post_button:!1,initial_text:""}},getDefaultProps:function(){return{isThreadingEnabled:!1}},onMouseOver:function(){var e;return"function"==typeof(e=this.props).onMouseOver?e.onMouseOver(this.props.annotation):void 0},onMouseLeave:function(){var e;return"function"==typeof(e=this.props).onMouseLeave?e.onMouseLeave(this.props.annotation):void 0},onUpdateResolve:function(e,t){var n;return"function"==typeof(n=this.props).onUpdateResolve?n.onUpdateResolve(e,t):void 0},onDeleteComment:function(e){var t;return"function"==typeof(t=this.props).onDeleteComment?t.onDeleteComment(e):void 0},onLikeComment:function(e){var t;return"function"==typeof(t=this.props).onLikeComment?t.onLikeComment(e):void 0},_getRevisionDateTime:function(){var e;return e=this._getRevision(),null==e.when||isNaN(new Date(null!=e.when))?void 0:""+o.ago(new Date(1e3*e.when))},_getRevision:function(){return this.props.commentActivity.comment.comment_metadata.revision},_isOnOldRevision:function(){return!this.props.fileViewerState.isCurrentlyAtRevision(this._getRevision())},onAddCommentFromList:function(e,t,n){var i;return null==t&&(t={}),null==n&&(n=null),this.setState({isNewReplyLoading:!0}),"function"==typeof(i=this.props).onAddCommentFromList?i.onAddCommentFromList(e,t,n):void 0},onAddSticker:function(e){var t;return this.setState({isNewReplyLoading:!0}),"function"==typeof(t=this.props).onAddSticker?t.onAddSticker(e):void 0},_renderThreadedListUI:function(){return d({key:"annotation_bubble_threaded_"+this.props.commentActivity.activity_key,activity:this.props.activity,commentActivity:this.props.commentActivity,contextActivityStore:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldAutoLinkify:!1,onAddCommentFromList:this.onAddCommentFromList,onLikeComment:this.onLikeComment,delete_comment:this.onDeleteComment,update_resolved:this.onUpdateResolve})},_renderSingleCommentUI:function(){return c({key:"annotation_bubble_list_"+this.props.commentActivity.activity_key,comment_activity:this.props.commentActivity,context_activity_store:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,onLikeComment:this.onLikeComment,delete_comment:this.onDeleteComment,update_resolved:this.onUpdateResolve})},_renderComments:function(){return h.div({className:"annotation-bubble__field",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},this._isOnOldRevision()?h.div({className:"annotation-bubble__field__old-revision"},"On revision updated "+this._getRevisionDateTime()):void 0,h.div({className:"comments-holder"},h.div({className:"comment-list"},this.props.isThreadingEnabled?this._renderThreadedListUI():this._renderSingleCommentUI())))},render:function(){var e,t;return t={"fade-in":this.props.showBubble,"fade-out":!this.props.showBubble,"annotation-bubble-container":!0},e=[],this.props.showBubble&&(e=[h.div({className:"annotation-bubble bubble-dropdown "+this.props.position,style:{left:this.props.x||0,top:this.props.y||0}},this._renderComments(),h.div({className:"bubble-arrow-border"}),h.div({className:"bubble-arrow"}))]),h.div({className:p(t)},this.props.showBubble?e:void 0)}})}),define("modules/clean/react/file_comments/comment_list_header",["jquery","external/react","modules/clean/activity/activity","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/activity/users_to_notify_facepile","modules/clean/react/bubble_dropdown","modules/clean/react/file_comments/logger","modules/clean/react/react_i18n","modules/clean/react/sprite_div","modules/clean/react/tooltip"],function(e,t,n,i,o,r,s,a,l,u){var c,_,d,p;return p=t.DOM,d=a.R_,c=n.ActivityContext,_=t.createClass({propTypes:{activity:t.PropTypes.object,show_resolved:t.PropTypes.bool.isRequired,toggle_show_resolved_callback:t.PropTypes.func.isRequired,num_resolved:t.PropTypes.number.isRequired,hide_callback:t.PropTypes.func.isRequired,is_subscribed:t.PropTypes.bool.isRequired,onSubscribeButtonClicked:t.PropTypes.func.isRequired,feedback_off:t.PropTypes.bool.isRequired,turn_off_feedback_callback:t.PropTypes.func.isRequired,activity_context:t.PropTypes.number.isRequired,onFacepileContactAdded:t.PropTypes.func,shouldShowDisableButton:t.PropTypes.bool.isRequired,shouldShowHideButton:t.PropTypes.bool.isRequired,user:t.PropTypes.object},_is_browse_view:function(){return this.props.activity_context===c.BROWSE_FILE_VIEWER||this.props.activity_context===c.BROWSE_LIGHTBOX},_hide_comments:function(e){return this.refs.dropdown.hide(),this.props.hide_callback(e)},_toggle_show_resolved:function(){return 0===this.props.num_resolved||this.props.feedback_off?void 0:(this.refs.dropdown.hide(),this.props.toggle_show_resolved_callback())},_toggle_subscribe:function(){return this.props.feedback_off?void 0:(this.refs.dropdown.hide(),this.props.onSubscribeButtonClicked())},_turn_off_feedback:function(){return this.refs.dropdown.hide(),this.props.turn_off_feedback_callback()},contactSelectedCallback:function(e){var t;return this.refs.facepileContactSelectorDropdown.hide(),"function"==typeof(t=this.props).onFacepileContactAdded&&t.onFacepileContactAdded(e),s.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.FACEPILE_ADD_BUTTON,this.props.user.id)},_contactsSelectorPopupShown:function(){return setTimeout(function(){return function(){return e(".contacts-selector-popup input").trigger("focus")}}(this),300)},_facepileContactsSelectorPopupShown:function(){return null!=this.props.activity&&this.props.enableFacepile?s.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.FACEPILE_ADD_BUTTON,this.props.user.id):void 0},render:function(){var e,n,s,a,c,_,h,f,m,g,v;return a=[],this.props.shouldShowHideButton&&(s=p.a({key:"hide",className:"comments-header-menu-option hide",onMouseUp:this._hide_comments},l({group:"web",name:"s_hide",text:d({},"Hide comments")})),a.push(s)),h=this.props.show_resolved?d({},"Hide resolved comments"):d({},"Show resolved comments"),c=t.addons.classSet({"comments-header-menu-option":!0,"toggle-resolved":!0,disabled:0===this.props.num_resolved||this.props.feedback_off}),_=p.a({key:"resolved",className:c,onMouseUp:this._toggle_show_resolved},l({group:"web",name:"s_resolve",text:h})),a.push(_),this.props.is_subscribed?(v=d({},"Unsubscribe from notifications"),m="s_notifications_off"):(v=d({},"Subscribe to notifications"),m="s_notifications_on"),f=t.addons.classSet({"comments-header-menu-option":!0,"toggle-subscribe":!0,disabled:this.props.feedback_off}),g=p.a({key:"subscribe",className:f,onMouseUp:this._toggle_subscribe},l({group:"web",name:m,text:v})),a.push(g),this.props.shouldShowDisableButton&&(n=p.a({key:"toggle-feedback-setting",className:"comments-header-menu-option toggle-feedback-setting",onMouseUp:this._turn_off_feedback},l({group:"web",name:"s_disable",text:d({},"Disable comments")})),a.push(n)),p.div({className:"comment-list-header-container"},null!=this.props.activity&&this.props.enableFacepile?(this.props.user.is_signed_in?e=p.a({className:"comment-list-facepile-add-button",onMouseUp:this._contactsSelectorPopupShown},"+"):void 0,p.div({className:"comment-list-facepile"},u.Tooltip({position:u.TooltipPosition.BOTTOM,tooltip_contents:d({},"Subscribers will be notified of new comments"),tooltip_classname:"notification-names-tooltip"},p.div({className:"title"},d({},"Subscribers"))),p.div({},o({usersToNotify:this.props.activity.users_to_notify,user:this.props.user}),this.props.user.is_signed_in?p.div({className:"comment-list-facepile-add"},u.Tooltip({position:u.TooltipPosition.BOTTOM,tooltip_contents:d({},"Add subscribers"),tooltip_classname:"notification-names-tooltip"},r({ref:"facepileContactSelectorDropdown",target:e,arrow_position:"top-right",vertical_displacement:-24,horizontal_displacement:-14,bubbleDropdownShown:this._facepileContactsSelectorPopupShown,extra_css_class:"notify-facepile-bubble-dropdown"},p.div({},i({ref:"facepileContactSelectorPopup",contactSelectedCallback:this.contactSelectedCallback,should_dropdown:!0,user:this.props.user,key:"facepileContactsPopup"}))))):void 0))):void 0,p.div({className:"comment-list-header"},p.div({className:"comment-list-header-inner"},p.span({className:"title"},d({},"Comments")),p.span({className:"options"},r({ref:"dropdown",target:d({},"Options"),arrow_position:"top-right",vertical_displacement:8,extra_css_class:"comments-header-bubble-dropdown",extra_target_css_class:"comments-header-options-target"},a))),p.hr({className:"separator"})))}})});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/file_comments/comment_list_ui",["jquery","external/react","external/underscore","modules/core/i18n","modules/clean/activity/activity","modules/clean/activity/activity_local_storage","modules/clean/activity/activity_user","modules/clean/datetime","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/react/file_comments/comment_list_header","modules/clean/react/file_comments/logger","modules/clean/react/file_comments/threaded_comment_activity_ui","modules/clean/react/image","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/activity/comment_activity_ui","modules/clean/react/activity/comment_input","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/static_urls"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h,f,m,g,v,y){var b,w,C,S,E,T,k,x,I,A,P,N,O;return O=i._,N=y.static_url,P=t.DOM,k=h.R_,x=t.addons.CSSTransitionGroup,b=t.createFactory(u.button),w=t.createFactory(m),A=t.createFactory(d),C=t.createFactory(g),S=t.createFactory(c),T=t.createFactory(p),x=t.createFactory(x),I=t.createFactory(f),E=t.createClass({displayName:"CommentListUI",propTypes:{contextActivityStore:t.PropTypes.object.isRequired,activity:t.PropTypes.object,contactSearchLogger:t.PropTypes.object,onInputFocus:t.PropTypes.func,onInputBlur:t.PropTypes.func,height:t.PropTypes.number,user:t.PropTypes.object,onHideCommentsPane:t.PropTypes.func.isRequired,turnOffFeedbackCallback:t.PropTypes.func.isRequired,turnOnFeedbackCallback:t.PropTypes.func.isRequired,enableFacepile:t.PropTypes.bool,enableNoNotifyHint:t.PropTypes.bool,forceNullStateLoadingState:t.PropTypes.bool,shouldInitiallyFocusInput:t.PropTypes.bool,showBottomBar:t.PropTypes.bool,isNewCommentLoading:t.PropTypes.bool,showNewComment:t.PropTypes.bool,isSender:t.PropTypes.bool,showResolvedComments:t.PropTypes.bool,isUserSubscribed:t.PropTypes.bool,isCommentInputDisabled:t.PropTypes.bool,fileViewerState:t.PropTypes.object,checkScroll:t.PropTypes.func,onAddCommentFromList:t.PropTypes.func,onAddSticker:t.PropTypes.func,onShowNewComment:t.PropTypes.func,onDeleteCommentFromList:t.PropTypes.func,onResolveCommentFromList:t.PropTypes.func,onLikeComment:t.PropTypes.func,onToggleShowResolvedComments:t.PropTypes.func,toggleFeedbackForViewer:t.PropTypes.func,onFacepileContactAdded:t.PropTypes.func,onAnnotationButtonMouseUp:t.PropTypes.func,verifyAfterSignUpCallback:t.PropTypes.func,shouldShowHideButton:t.PropTypes.bool,shouldAutoLinkify:t.PropTypes.bool,enableImport:t.PropTypes.bool,shouldUseSimpleModals:t.PropTypes.bool,shouldHidePhotoAvatars:t.PropTypes.bool,isThreadingEnabled:t.PropTypes.bool,isTinyAnnotationUIEnabled:t.PropTypes.bool},getInitialState:function(){return this.props.user.is_signed_in||(this.modals=new v),{shouldPopupsDropdown:!0}},getDefaultProps:function(){return{forceNullStateLoadingState:!1,isCommentInputDisabled:!1,fileViewerState:null,checkScroll:e.noop,onShowNewComment:e.noop,showBottomBar:!1,shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,isThreadingEnabled:!1}},componentWillUnmount:function(){return e(window).unbind("resize.bottom_bar")},componentDidMount:function(){var t;return e(window).bind("resize.bottom_bar",function(e){return function(){var t;return"function"==typeof(t=e.props).checkScroll?t.checkScroll():void 0}}(this)),this.checkSize(),"function"==typeof(t=this.props).checkScroll?t.checkScroll():void 0},componentDidUpdate:function(e,t){var n,i,o,s,a,l,u,c,_,d,p,h;if(this._isActivityFetchDone()){if(i=(this.props.activity&&this.props.activity.activity_key)!==(e.activity&&e.activity.activity_key)){if(this.props.user.is_signed_in&&(s=r.get_store("like",this.props.activity.activity_key),s&&s.comment_activity_key))for(_=this.props.activity.comment_activities,u=0,c=_.length;c>u;u++)n=_[u],n.activity_key===s.comment_activity_key&&(r.clear_store("like"),d=this.props.user.id,__indexOf.call(function(){var e,t,i,r;for(i=n.likes,r=[],e=0,t=i.length;t>e;e++)o=i[e],r.push(o.liker.id);return r}(),d)<0&&this.props.contextActivityStore.add_comment_like(n,this.props.user,null,null));this.props.user.is_signed_in&&!this.props.isUserSubscribed&&(a=r.get_store("subscribe",this.props.activity.activity_key),r.clear_store("subscribe"),a&&this.toggleFeedbackForViewer())}return(null==e.activity&&(null!=(p=this.props.activity)&&null!=(h=p.comment_activities)?h.length:void 0)>0||null==t.commentBoxHeight&&this.getCommentBoxHeight())&&this.animateScrollToBottom(500),this.checkSize(),"function"==typeof(l=this.props).checkScroll?l.checkScroll():void 0}},onAddCommentFromList:function(e,t,n){var i;return null==t&&(t={}),null==n&&(n=null),"function"==typeof(i=this.props).onAddCommentFromList?i.onAddCommentFromList(e,t,n):void 0},onLikeComment:function(e){var t;return"function"==typeof(t=this.props).onLikeComment?t.onLikeComment(e):void 0},onResolveCommentFromList:function(e,t){var n;return"function"==typeof(n=this.props).onResolveCommentFromList?n.onResolveCommentFromList(e,t):void 0},onDeleteCommentFromList:function(e){var t;return"function"==typeof(t=this.props).onDeleteCommentFromList?t.onDeleteCommentFromList(e):void 0},onToggleShowResolvedComments:function(){var e;return"function"==typeof(e=this.props).onToggleShowResolvedComments?e.onToggleShowResolvedComments():void 0},onFacepileContactAdded:function(e){var t;return"function"==typeof(t=this.props).onFacepileContactAdded?t.onFacepileContactAdded(e):void 0},toggleFeedbackForViewer:function(){var e;return"function"==typeof(e=this.props).toggleFeedbackForViewer?e.toggleFeedbackForViewer():void 0},isScrolledToBottom:function(){var t;return t=e(this.refs.commentList.getDOMNode()),t[0].scrollHeight-t.scrollTop()-4<=t.outerHeight()},checkSize:function(){var e;return e=this.getCommentBoxHeight(),this.state.commentBoxHeight!==e?this.setState({commentBoxHeight:e}):void 0},_verifyAfterSignUpCallback:function(){var e;return"function"==typeof(e=this.props).verifyAfterSignUpCallback?e.verifyAfterSignUpCallback():void 0},onAnnotationButtonMouseUp:function(e,t){var n;return"function"==typeof(n=this.props).onAnnotationButtonMouseUp?n.onAnnotationButtonMouseUp(e,t):void 0},onAddSticker:function(e){var t;return"function"==typeof(t=this.props).onAddSticker?t.onAddSticker(e):void 0},onScroll:function(){var e;return"function"==typeof(e=this.props).checkScroll?e.checkScroll():void 0},turnOnFeedback:function(){return this.props.turnOnFeedbackCallback()},turnOffFeedback:function(){return this.props.turnOffFeedbackCallback()},_isActivityFetchDone:function(){return this.props.activity?!0:!1},onFocus:function(){var e;return l.getGandalfRule("dw-comments-expanded-input")&&setTimeout(function(e){return function(){return e.forceUpdate()}}(this),10),"function"==typeof(e=this.props).onInputFocus?e.onInputFocus():void 0},forceBlur:function(){return e(document.activeElement).blur()},resizeCallback:function(){return this.forceUpdate()},animateScrollToBottom:function(t){var n;return null==t&&(t=600),n=this.refs.commentList.getDOMNode(),e(n).animate({scrollTop:n.scrollHeight},{duration:t})},scrollToBottom:function(){var e;return e=this.refs.commentList.getDOMNode(),e.scrollTop=e.scrollHeight},getCommentBoxHeight:function(){return null!=this.refs.commentInput?e(this.refs.commentInput.getDOMNode()).outerHeight():0},positionDropdownCallback:function(){var t;return t=e(this.refs.commentList.getDOMNode()).height(),this.setState({shouldPopupsDropdown:Boolean(t<this.props.height/2)})},render:function(){var e,n,i,o,r,s,a,u,c,_,d,p,h,f;if(c=T({src:N("/static/images/icons/ajax-loading-small-blue-vfl6t1QvH.gif"),srcHiRes:N("/static/images/icons/ajax-loading-small-blue@2x-vfl9Zlaal.gif")}),o=[],d=0,this._isActivityFetchDone())for(f=this.props.activity.comment_activities,p=0,h=f.length;h>p;p++)e=f[p],e.comment.resolved&&(d+=1),(!e.comment.resolved||this.props.showResolvedComments)&&o.push(this.props.isThreadingEnabled?A({key:"comment_list_ui_threaded_"+e.activity_key,activity:this.props.activity,commentActivity:e,contextActivityStore:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isTinyAnnotationUIEnabled:this.props.isTinyAnnotationUIEnabled,onAddCommentFromList:this.onAddCommentFromList,onLikeComment:this.onLikeComment,delete_comment:this.onDeleteCommentFromList,onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,onResolveCommentFromList:this.onResolveCommentFromList,shouldAutoLinkify:this.props.shouldAutoLinkify}):w({key:"comment_list_ui_"+e.activity_key,comment_activity:e,context_activity_store:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isTinyAnnotationUIEnabled:this.props.isTinyAnnotationUIEnabled,onLikeComment:this.onLikeComment,delete_comment:this.onDeleteCommentFromList,onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,update_resolved:this.onResolveCommentFromList,shouldAutoLinkify:this.props.shouldAutoLinkify}));return i=t.addons.classSet({"comment-list":!0,scrolled:this.props.showBottomBar}),r=t.addons.classSet({"comments-holder":!0,"comments-activity-loaded":this._isActivityFetchDone(),"comments-holder-responsive":l.getGandalfRule("dw-comments-responsive-width")}),this.props.height&&(a={height:this.props.height},null!=this.state.commentBoxHeight&&(u={maxHeight:this.props.height-this.state.commentBoxHeight})),s=this._isActivityFetchDone()&&this.props.activity.feedback_off,n=this._isActivityFetchDone()&&this.props.activity.can_edit_feedback,P.div({className:r,ref:"commentsHolder",style:a},P.div({className:i,ref:"commentList",onScroll:this.onScroll,style:u},S({show_resolved:this.props.showResolvedComments,toggle_show_resolved_callback:this.onToggleShowResolvedComments,hide_callback:this.props.onHideCommentsPane,is_subscribed:this.props.isUserSubscribed,onSubscribeButtonClicked:this.toggleFeedbackForViewer,num_resolved:d,shouldShowHideButton:this.props.shouldShowHideButton,shouldShowDisableButton:!s&&n,feedback_off:s,turn_off_feedback_callback:this.turnOffFeedback,activity_context:this.props.contextActivityStore.activity_context,activity:this.props.activity,user:this.props.user,onFacepileContactAdded:this.onFacepileContactAdded,enableFacepile:this.props.enableFacepile}),this._isActivityFetchDone()||this.props.forceNullStateLoadingState?void 0:P.div({className:"comments-loading"},c),this._isActivityFetchDone()&&this.props.activity.feedback_off?P.div({className:"blank-state"},P.div({className:"blank-state-icon"},I({group:"web",name:"s_comments_locked"})),P.div({className:"blank-state-text"},k({},"Comments are off for this file.")),P.div({className:"blank-state-button"},b({importance:"secondary",onMouseUp:this.turnOnFeedback},k({},"Enable comments")))):o.length>0?x({transitionName:"comment"},o):this._isActivityFetchDone()&&!this.props.isNewCommentLoading||!this._isActivityFetchDone()&&this.props.forceNullStateLoadingState?P.div({className:"blank-state"},P.div({className:"blank-state-illustration"},T({src:N("/static/images/commenting/comments_null_state-vflRF2RXk.png"),srcHiRes:N("/static/images/commenting/comments_null_state@2x-vflUmaRRX.png")})),P.div({className:"blank-state-text"},k({},'Post a comment to start a discussion. <span class="blue">@Mention</span> someone to notify them.'))):void 0,this.props.isNewCommentLoading?(_=t.addons.classSet({"loading-comment":!0,"blank-state":0===o.length}),P.div({className:_},c)):void 0),(this._isActivityFetchDone()&&!this.props.activity.feedback_off||!this._isActivityFetchDone()&&this.props.forceNullStateLoadingState)&&!this.props.isCommentInputDisabled?C({activity:this.props.activity,onAddComment:this.onAddCommentFromList,onCancelComment:this.forceBlur,contactSearchLogger:this.props.contactSearchLogger,onAddSticker:this.onAddSticker,verifyAfterSignUpCallback:this._verifyAfterSignUpCallback,ref:"commentInput",resizeCallback:this.resizeCallback,positionDropdownCallback:this.positionDropdownCallback,shouldPopupsDropdown:this.state.shouldPopupsDropdown,onFocus:this.onFocus,onBlur:this.props.onInputBlur,user:this.props.user,onShowNewComment:this.props.onShowNewComment,showNewComment:this.props.showNewComment,inBlankState:0===o.length,enableNotifyText:!this.props.enableFacepile,enableNoNotifyHint:this.props.enableNoNotifyHint,commentMetadataAllowed:l.getGandalfRule("pptx-commenting")||l.getGandalfRule("dw-comments-stickers"),shouldEnableStickers:l.getGandalfRule("dw-comments-stickers"),fileViewerState:this.props.fileViewerState,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,isCommentInputDisabled:this.props.isCommentInputDisabled,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldUseSimpleModals:this.props.shouldUseSimpleModals}):void 0)}})});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/file_comments/file_feedback_likes_section",["external/react","modules/core/exception","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/activity/activity","modules/clean/activity/activity_local_storage","modules/clean/analytics","modules/clean/filepath","modules/clean/react/sprite","modules/clean/react/tooltip","modules/clean/react/file_comments/shared_link_signup_modals"],function(e,t,n,i,o,r,s,a,l,u,c,_){var d,p,h,f,m,g,v,y;return m=t.assert,y=n._,v=n.ungettext,f=a.WebLightboxLogger,g=e.DOM,d=r.ActivityContext,h=15,p=e.createClass({propTypes:{contextActivityStore:e.PropTypes.object.isRequired,activity:e.PropTypes.object,height:e.PropTypes.number,user:e.PropTypes.object},componentDidMount:function(){return this._logEvent(f.LIKES_EXPERIMENT_VIEW),null!=this.props.activity&&this._logEvent(f.LIKES_EXPERIMENT_LOADED),this.props.user.is_signed_in?void 0:this.modals=new _},componentDidUpdate:function(e){var t,n;return t=(this.props.activity&&this.props.activity.activity_key)!==(e.activity&&e.activity.activity_key),t&&(null!=this.props.activity&&this._logEvent(f.LIKES_EXPERIMENT_LOADED),this.props.activity.feedback_off||this.modals&&this.modals.set_activity_key(this.props.activity.activity_key),this.props.user.is_signed_in&&(n=s.get_store("like",this.props.activity.activity_key),n&&!n.comment_activity_key))?(s.clear_store("like"),this.props.contextActivityStore.add_like(this.props.activity,this.props.user,this._onActivityUpdate),this._logEvent(f.LIKES_EXPERIMENT_COMPLETED_LIKE)):void 0},render:function(){var e,t,n,i,o,r,s,a;if(null==this.props.activity)return this._renderEmptyView();for(i=this._isLikedByViewingUser()?"like_icon_selected":"like_icon",t=this._isLikedByViewingUser()?"like_icon_selected_hover":"like_icon_hover",n=this._isLikedByViewingUser()?this._removeLike:this._addLike,o=[],a=this.props.activity.likes,r=0,s=a.length;s>r;r++)e=a[r],this.props.user.is_signed_in&&e.liker.id===this.props.user.id||o.push(e.liker);return g.div({className:"file-feedback-likes-section file-feedback-section",style:{height:this.props.height}},g.a({className:"like-button",onClick:n,onMouseEnter:this._onLikeButtonMouseEnter},g.div({className:"like-button-icon-container"},u({group:"web",name:i,className:"like-button-icon"}),u({group:"web",name:t,className:"like-button-icon-hover"})),g.div({className:"like-button-text"},y("Like"))),o.length>0?this._renderOtherLikersView(o):void 0)},_renderOtherLikersView:function(e){var t,n,i,o,r;return m(e.length>0),t=e[0].fname.escapeHTML(),i=1===e.length?y('<span class="blue">%(name)s</span> likes this').format({name:t}):v('<span class="blue">%(name)s and %(num)s other</span> like this','<span class="blue">%(name)s and %(num)s others</span> like this',e.length-1).format({
name:t,num:e.length-1}),o=e.slice(0,h),e.length>h&&o.push({id:"extra",display_name:y("%(num_extra)d more...").format({num_extra:e.length-h})}),r=g.div({className:"other-liker-names"},function(){var e,t,i;for(i=[],e=0,t=o.length;t>e;e++)n=o[e],i.push(function(){return function(e){return g.div({key:e.id},e.display_name)}}(this)(n));return i}.call(this)),[g.div({className:"separator-dot"},"Â·"),c.Tooltip({position:c.TooltipPosition.BOTTOM,tooltip_contents:r,tooltip_classname:"other-likers-tooltip"},g.div({className:"other-likers",dangerouslySetInnerHTML:{__html:i},onMouseEnter:this._onOtherLikersMouseEnter}))]},_renderEmptyView:function(){return g.div({className:"file-feedback-likes-section file-feedback-section",style:{height:this.props.height}},g.a({className:"like-button loading"},g.div({className:"like-button-icon-container"},u({group:"web",name:"like_icon_empty"}),g.img({src:"/static/images/icons/ajax-loading-small-blue-vfl6t1QvH.gif",className:"like-button-icon-loading"})),g.div({className:"like-button-text"},y("Like"))))},_isLikedByViewingUser:function(){var e,t;return this.props.user.is_signed_in?(t=this.props.user.id,__indexOf.call(function(){var t,n,i,o;for(i=this.props.activity.likes,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(e.liker.id);return o}.call(this),t)>=0):!1},_addLike:function(){var e;return this._logEvent(f.LIKES_EXPERIMENT_CLICKED_LIKE),this.props.user.is_signed_in?(e=function(){return function(){return i.error(y("We werenât able to submit your like."))}}(this),this.props.contextActivityStore.add_like(this.props.activity,this.props.user,this._onActivityUpdate,null,e),this._logEvent(f.LIKES_EXPERIMENT_COMPLETED_LIKE)):(s.set_store("like",this.props.activity.activity_key),this.modals.show_sign_up_modal())},_removeLike:function(){var e;return this._logEvent(f.LIKES_EXPERIMENT_CLICKED_UNLIKE),e=function(){return function(){return i.error(y("We werenât able to remove your like."))}}(this),this.props.contextActivityStore.remove_like(this.props.activity,this.props.user,this._onActivityUpdate,null,e)},_onActivityUpdate:function(e){return this.setState({activity:e})},_onLikeButtonMouseEnter:function(){return this._logEvent(f.LIKES_EXPERIMENT_MOUSED_OVER_LIKE)},_onOtherLikersMouseEnter:function(){return this._logEvent(f.LIKES_EXPERIMENT_MOUSED_OVER_OTHERS)},_logEvent:function(e){return f.log(e,{context:this._getContextForLogging(),file_ext:this._getFileExtForLogging(),num_likes:null!=this.props.activity?this.props.activity.likes.length:-1,liked_by_viewer:null!=this.props.activity?this._isLikedByViewingUser():!1,file_key:null!=this.props.activity?this.props.activity.activity_key:"none"})},_getContextForLogging:function(){switch(this.props.contextActivityStore.activity_context){case d.BROWSE_LIGHTBOX:return"browse_lightbox";case d.SHARED_LINK_VIEW:return"shmodel_view";case d.SHARED_LINK_LIGHTBOX:return"shmodel_lightbox";default:return m(!1)}},_getFileExtForLogging:function(){var e;switch(this.props.contextActivityStore.activity_context){case d.BROWSE_LIGHTBOX:return l.file_extension_for_logging(this.props.contextActivityStore.activity_context_data);case d.SHARED_LINK_VIEW:case d.SHARED_LINK_LIGHTBOX:return e=o.parse(this.props.contextActivityStore.activity_context_data),l.file_extension_for_logging(e.getPath());default:return m(!1)}}})}),define("modules/clean/react/file_comments/logger",["modules/clean/ajax","modules/clean/activity/activity","modules/clean/activity/like","modules/clean/annotations/annotation","modules/clean/viewer","modules/core/exception"],function(e,t,n,i,o,r){var s,a,l;return s=i.Annotation,a=function(){function t(){}return t.prototype.log_event=function(t,n,i,o,s,a,l,u,c){return null==l&&(l=null),null==u&&(u=null),null==c&&(c=null),r.assert(t,"event_type not provided"),r.assert(n,"file_activity_key not provided"),e.WebRequest({url:"/file_activity/client_log",type:"POST",data:{event_type:t,file_activity_key:n,comment_activity_key:i,client_origin_type:o,activity_context:a,annotation_type:l,annotation_subtype:u,annotation_page:c},subject_user:s})},t.prototype.log_annotation_event=function(e,t,n,i,o,r){var a,l,u,c;return null==r&&(r=null),null!=r&&(a=s.createAnnotationFromDict(r),c=a.type,u=a.subtype,l=a.getFirstPdfPage()),this.log_event(e,t,n,null,i,o,c,u,l)},t}(),l=new a});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/react/file_comments/shared_link_signup_modals",["jquery","modules/clean/ajax","modules/core/browser","modules/core/i18n","modules/core/notify","modules/clean/register_form","modules/clean/components/login_form","modules/clean/dbmodal","modules/clean/react/file_comments/logger"],function(e,t,n,i,o,r,s,a,l){var u,c,_;return _=i._,c=a.DBModal,u=function(){function e(){this._toggle_form=__bind(this._toggle_form,this),this._prepare_form=__bind(this._prepare_form,this),this._reload=__bind(this._reload,this),this.before_modal=__bind(this.before_modal,this),this.show_sign_in_modal=__bind(this.show_sign_in_modal,this),this.show_sign_up_modal=__bind(this.show_sign_up_modal,this),this.hide_modal=__bind(this.hide_modal,this),this.init_modals=__bind(this.init_modals,this),this.show_register=!1,this.init_modals()}return e.POST_COMMENT_VARIANT="post_comment_variant",e.LIKE_COMMENT_VARIANT="like_comment_variant",e.SUBSCRIBE_VARIANT="subscribe_variant",e.prototype.init_modals=function(){return this.default_signup_modal=new c({element_id:"shared-link-default-comments-signup-modal"}),this.default_signup_modal.before_show=this.before_modal},e.prototype.hide_modal=function(){return this.default_signup_modal.hide()},e.prototype.show_sign_up_modal=function(e){return this.show_register=!0,this.variant=e,this.default_signup_modal.show()},e.prototype.show_sign_in_modal=function(e){return this.show_register=!1,this.variant=e,this.default_signup_modal.show()},e.prototype.set_activity_key=function(e){return this.activity_key=e},e.prototype.before_modal=function(e){var t,n;return this._prepare_form(e),e.find(".toggle-form-link").click(function(t){return function(){return t._toggle_form(e)}}(this)),n=e.find(".register-form"),n.length&&n.on(r.REGISTER_SUCCESS,function(e){return function(t,n){return e.user=n,o.success(_("Successfully signed up for Dropbox")),l.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_SUCCESS,e.activity_key,null,null,e.user.id),e._reload()}}(this)),t=e.find(".login-form"),t.length?(n.length&&n.on(r.USER_EXISTS,function(n){return function(i){var o,r,s,a,l;for(n._toggle_form(e),l=i.prefill,r=s=0,a=l.length;a>s;r=++s)o=l[r],t.find(o).val(r);return t.find(i.focus).focus()}}(this)),t.on(s.LOGIN_SUCCESS,function(e){return function(t,n){return e.user=n,o.success(_("Successfully signed in to Dropbox")),l.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_IN_SUCCESS,e.activity_key,null,null,e.user.id),e._reload()}}(this))):void 0},e.prototype._reload=function(){return n.reload()},e.prototype._prepare_form=function(t){switch(t.find(".form-component").hide(),t.find(".text-variant").hide(),this.show_register?t.find(".register-form-component").show():t.find(".login-form-component").show(),this.variant){case e.POST_COMMENT_VARIANT:return t.find(".text-variant.post-comment-variant").show();case e.LIKE_COMMENT_VARIANT:return t.find(".text-variant.like-comment-variant").show();case e.SUBSCRIBE_VARIANT:return t.find(".text-variant.subscribe-variant").show();default:return t.find(".text-variant.default-variant").show()}},e.prototype._toggle_form=function(e){var t,n,i,o,r,s;return r=e.find(".register-form-component"),o=e.find(".login-form-component"),r.is(":visible")?(n=Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_IN_MODAL,r.fadeOut({complete:function(){return o.show()}})):(n=Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,o.fadeOut({complete:function(){return r.show()}})),l.log_event(n=n,i=this.activity_key,t=null,s=Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.MODAL_TOGGLE_BUTTON)},e}()}),define("modules/clean/react/file_comments/stickers",["jquery","external/react","external/immutable","external/underscore","modules/clean/sticker_util"],function(e,t,n,i,o){var r,s,a,l;return l=t.DOM,r=t.createFactory(t.createClass({displayName:"StickerSet",propTypes:{onStickerClick:t.PropTypes.func,isSelected:t.PropTypes.bool,data:t.PropTypes.object},_onStickerClick:function(e){var t;return e.preventDefault(),t=parseInt(e.currentTarget.getAttribute("data-sticker-id")),this.props.onStickerClick(t)},render:function(){var e,n,i,r;return n=t.addons.classSet,e=n({"sticker-set":!0,"is-selected":this.props.isSelected}),l.div({className:e},function(){var e,t,n,s;for(n=this.props.data.stickers,s=[],e=0,t=n.length;t>e;e++)i=n[e],r=o.getStickerImageUrl(i.id),s.push(l.a({onClick:this._onStickerClick,"data-sticker-id":i.id},l.img({src:r})));return s}.call(this))}})),s=t.createFactory(t.createClass({displayName:"StickerTab",propTypes:{data:t.PropTypes.object,onChangeSelection:t.PropTypes.func,isSelected:t.PropTypes.bool},_onStickerTabClick:function(e){return e.preventDefault(),this.props.onChangeSelection(this.props.data.name)},render:function(){var e,n;return n=t.addons.classSet,e=n({"sticker-nav-item":!0,"is-selected":this.props.isSelected}),l.a({className:e,onClick:this._onStickerTabClick},l.img({src:o.getStickerSetImageUrl(this.props.data.id)}))}})),a=t.createFactory(t.createClass({displayName:"Stickers",SCROLL_DISTANCE:200,propTypes:{onStickerSelected:t.PropTypes.func,isPopupAbove:t.PropTypes.bool},getInitialState:function(){return{selected:"CatBlobs",scrollOffset:0}},_onChangeSelection:function(e){return this.setState({selected:e})},_onStickerSelected:function(e){return this.props.onStickerSelected(e)},_getMaxScroll:function(){var t,n,i,o,r,s;for(i=0,s=this.getDOMNode().getElementsByClassName("sticker-nav-item"),o=0,r=s.length;r>o;o++)t=s[o],i+=e(t).outerWidth(!0);return n=60,this.refs.tabs.getDOMNode().offsetWidth-i-n},_onLeftArrowPress:function(e){return e.preventDefault(),this.setState({scrollOffset:Math.min(0,this.state.scrollOffset+this.SCROLL_DISTANCE)})},_onRightArrowPress:function(e){return e.preventDefault(),this.setState({scrollOffset:Math.max(this._getMaxScroll(),this.state.scrollOffset-this.SCROLL_DISTANCE)})},_renderTabs:function(e){var n,i;return i=t.addons.classSet,n=i({"sticker-nav":!0,"show-left":this.state.scrollOffset<0,"show-right":!this.isMounted()||this.state.scrollOffset!==this._getMaxScroll(),"on-top":this.props.isPopupAbove,"on-bottom":!this.props.isPopupAbove}),l.div({className:n,ref:"tabs"},l.a({href:"#left",onClick:this._onLeftArrowPress,className:"arrow left"}),l.div({className:"sticker-nav-inner",ref:"tabScroller",style:{marginLeft:this.state.scrollOffset}},e),l.a({href:"#right",onClick:this._onRightArrowPress,className:"arrow right"}))},render:function(){var e,t,n,i,a,u;for(n=[],t=[],u=o.getStickers(),i=0,a=u.length;a>i;i++)e=u[i],n.push(new s({data:e,isSelected:e.name===this.state.selected,onChangeSelection:this._onChangeSelection})),t.push(new r({data:e,count:e.stickers.length,isSelected:e.name===this.state.selected,onStickerClick:this._onStickerSelected}));return l.div({className:"sticker-container",refs:"stickerContainer"},l.div({className:"sticker-menu-wrapper"},l.div({className:"sticker-menu"},this.props.isPopupAbove?this._renderTabs(n):void 0,l.div({className:"sticker-sets-wrapper"},t),this.props.isPopupAbove?void 0:this._renderTabs(n))))}})),{Stickers:a}}),define("modules/clean/react/form_error_mixin",["external/react"],function(e){var t,n;return n=e.DOM,t={propTypes:{errorWrapperClassName:e.PropTypes.string,"disable-errors":e.PropTypes.bool,"error-after":e.PropTypes.bool,error:e.PropTypes.shape({message_text:e.PropTypes.string,message_html:e.PropTypes.string})},renderErrorIfEnabled:function(){return this.props["disable-errors"]?void 0:this.renderError()},renderError:function(){var e,t;return null!=(null!=(e=this.props.error)?e.message_html:void 0)?n.div({className:this.props.errorWrapperClassName,dangerouslySetInnerHTML:{__html:this.props.error.message_html}}):n.div({className:this.props.errorWrapperClassName},null!=(t=this.props.error)?t.message_text:void 0)}}}),define("modules/clean/react/hierarchical_nav_bar",["external/react","modules/core/i18n","modules/clean/react/sprite"],function(e,t,n){var i,o,r,s,a,l,u;return a=e.DOM,u=t._,l=function(e){var t;return null==e&&(e=[]),"string"==typeof e&&(e=[e]),e=function(){var n,i,o;for(o=[],n=0,i=e.length;i>n;n++)t=e[n],null!=t&&o.push(t);return o}()},i=function(e,t,n){var i,o,r;return e=l(e),t=l(t),n=l(n),i=e.join("__"),r=t.join("__"),o=i,""!==r&&(o+="__"+r),n=n.map(function(e){return o+"--"+e}).join(" "),o+" "+n},s=i.bind(null,"hierarchical-nav-bar"),o=e.createClass({propTypes:{"nav-items":e.PropTypes.array,id:e.PropTypes.string,shouldRenderHeader:e.PropTypes.bool},getDefaultProps:function(){return{"nav-items":[],shouldRenderHeader:!0}},hasIcons:function(e){var t,n,i;for(n=0,i=e.length;i>n;n++){if(t=e[n],null!=t.icon)return!0;if(null!=t.children&&this.hasIcons(t.children))return!0}return!1},renderHeader:function(){var e;return e=a.img({src:"/static/images/icons/blue_dropbox_glyph-vflJ8-C5d.png",alt:u("Dropbox home")}),a.a({href:"/",id:"home-icon",className:s("home-icon")},e)},renderNavItems:function(){var t,n;return n=this.props["nav-items"],a.ul({className:s("nav",["root",this.hasIcons(n)?void 0:"no-icon"])},function(){var i,o,s;for(s=[],i=0,o=n.length;o>i;i++)t=n[i],s.push(e.createElement(r,{item:t}));return s}())},render:function(){return a.div({className:s()},[this.props.shouldRenderHeader?this.renderHeader():void 0,this.renderNavItems()])}}),r=e.createClass({propTypes:{item:e.PropTypes.object,depth:e.PropTypes.number},getDefaultProps:function(){return{item:{href:"#",label:"",selected:!1,children:[]},depth:1}},getItemIcon:function(){var t;return t=this.props.item.icon,null!=t?e.createElement(n,t):null},getIconLabel:function(){return a.span({className:s("nav-item-label")},this.props.item.label)},renderItemLink:function(){var e,t,n;return t=this.props.item.href,n=""+this.props.item.key+"_link",e=s("nav-item-link"),a.a({href:t,id:n,className:e},[this.getItemIcon(),this.getIconLabel()])},renderChildItems:function(t){var n,i,o,l,u,c;for(l=[],i=this.props.depth+1,u=0,c=t.length;c>u;u++)n=t[u],o=e.createElement(r,{item:n,depth:i}),l.push(o);return a.ul({className:s("nav")},l)},render:function(){var e,t,n;return t=this.props.item.children,(null!=t?t.length:void 0)&&(e=this.renderChildItems(t)),n=["level-"+this.props.depth,null==this.props.item.icon?"no-icon":void 0,this.props.item.selected?"selected":void 0],a.li({className:s("nav-item",n)},[this.renderItemLink(),e])}}),{HierarchicalNavBar:o}}),define("modules/clean/react/image",["external/react","external/underscore","modules/core/exception"],function(e,t,n){var i,o,r,s;return o=n.assert,r=e.DOM,s=function(e){return-1!==e.indexOf("-vfl")},i=e.createClass({displayName:"Image",propTypes:{alt:e.PropTypes.string,src:e.PropTypes.string.isRequired,srcHiRes:e.PropTypes.string.isRequired,onLoad:e.PropTypes.func,className:e.PropTypes.string,id:e.PropTypes.string},getDefaultProps:function(){return{alt:""}},render:function(){var e;return o(s(this.props.src),"Non-VFL path: "+this.props.src),o(s(this.props.srcHiRes),"Non-VFL path: "+this.props.srcHiRes),e={src:this.props.src,srcSet:this.props.srcHiRes+" 2x",alt:this.props.alt,id:this.props.id,className:this.props.className,onLoad:this.props.onLoad},t.extend(e,t.pick(this.props,function(e,t){return t.match(/^(aria|data)-/)})),r.img(e)}})}),define("modules/clean/react/input",["external/react","external/underscore","jquery","modules/clean/keycode","modules/clean/react/form_error_mixin","modules/clean/react/sprite","modules/core/browser"],function(e,t,n,i,o,r,s){var a,l,u;return a=e.addons.classSet,l=e.DOM,u=function(u,c){return e.createClass({displayName:u+"."+c,propTypes:{expandable:e.PropTypes.bool,expandedWidthOffset:e.PropTypes.number,animationCurve:e.PropTypes.string,animationDuration:e.PropTypes.number,onCloseClick:e.PropTypes.func,defaultValue:e.PropTypes.string,value:e.PropTypes.string,autofocus:e.PropTypes.bool,autoresize:e.PropTypes.bool,inline:e.PropTypes.bool,className:e.PropTypes.string,valueLink:e.PropTypes.object,variant:e.PropTypes.string,id:e.PropTypes.string,label:e.PropTypes.string,afterRender:e.PropTypes.func,onClick:e.PropTypes.func,onFocus:e.PropTypes.func,onKeyDown:e.PropTypes.func,onChange:e.PropTypes.func,compatiblePlaceholder:e.PropTypes.bool,placeholder:e.PropTypes.string},mixins:[o],getDefaultProps:function(){return{errorWrapperClassName:"text-input-error-wrapper",expandedWidthOffset:90,expandable:!1,animationCurve:"easeOutSine",animationDuration:300,compatiblePlaceholder:!1}},getInitialState:function(){return{inputWidth:0,expanded:!1,value:this.props.defaultValue,compatiblePlaceholderVisible:this.supportsCompatiblePlaceholder()}},supportsCompatiblePlaceholder:function(){return this.props.compatiblePlaceholder&&this.props.placeholder&&s.msie_version_at_most(9)},render:function(){var e,n,i,o,s,_,d,p,h,f,m;if(i={"text-input-input":!0,autofocus:this.props.autofocus,"password-input":"password"===c},o={"text-input":!0,"text-input-expandable":this.props.expandable,"text-input-inline":this.props.inline,"textarea-input":"textarea"===u},o[this.props.variant||"standard"]=!0,null!=this.props.className)for(h=this.props.className.split(/\s/),d=0,p=h.length;p>d;d++)n=h[d],o[n]=!0;return e=t.omit(this.props,"className","onChange","onFocus","onKeyDown","value","valueLink","ref","defaultValue"),_=l[u](t.extend({className:a(i),type:c,value:this.props.value||(null!=(f=this.props.valueLink)?f.value:void 0)||this.state.value,onChange:this.onChangeInternal,onFocus:this.onFocusInternal,onKeyDown:this.onKeyDownInternal,ref:"inputComponent",placeholder:this.props.placeholder||""},e)),s=this.renderErrorIfEnabled(),l.div({className:a(o)},this.props["error-after"]?void 0:s,l.div({className:"text-input-wrapper"},_,this.supportsCompatiblePlaceholder()?l.span({ref:"textInputPlaceholder",className:"text-input-placeholder",style:{display:this.state.compatiblePlaceholderVisible?"block":"none"}},this.props.placeholder):void 0,this.props.expandable?l.a({href:"#",onClick:this.onCloseClick,ref:"closeButton",className:"close-button"},r({group:"web",name:"xclose"})):void 0,this.props.value||(null!=(m=this.props.valueLink)?m.value:void 0)||this.state.value?void 0:l.label({htmlFor:this.props.id},this.props.label)),this.props["error-after"]?s:void 0)},getValue:function(){return this.refs.inputComponent.getDOMNode().value},setValue:function(e){return this.refs.inputComponent.getDOMNode().value=e,this.setState({value:e})},resizeComponent:function(){var e,t;return t=this.refs.inputComponent.getDOMNode(),e=n(t),e.css("height","1px"),e.css("height",t.scrollHeight+"px")},_renderFinished:function(){var e,t,i;return this.props.autoresize&&this.resizeComponent(),"function"==typeof(i=this.props).afterRender&&i.afterRender(),this.state.compatiblePlaceholderVisible?(t=n(this.refs.textInputPlaceholder.getDOMNode()),e=n(this.refs.inputComponent.getDOMNode()),t.css({position:"absolute","font-size":e.css("font-size"),color:"#aaa",left:e.css("padding-left"),top:parseInt(e.css("margin-top"))+e.outerHeight()/2-t.outerHeight()/2}),t.click(function(){return e.focus()})):void 0},componentDidMount:function(){var e;return this._renderFinished(),e=this.refs.inputComponent.getDOMNode().offsetWidth,this.setState({inputWidth:e})},componentDidUpdate:function(){return this._renderFinished()},onCloseClick:function(e){var t,i,o;return null!=e&&e.preventDefault(),t=n(this.refs.closeButton.getDOMNode()),i=n(this.refs.inputComponent.getDOMNode()),t.stop().animate({opacity:0},this.props.animationDuration),i.stop().animate({width:this.state.inputWidth},this.props.animationDuration,this.props.animationCurve),"function"==typeof(o=this.props).onCloseClick&&o.onCloseClick(e),this.setState({expanded:!1}),this.supportsCompatiblePlaceholder()?this.setState({compatiblePlaceholderVisible:!0}):void 0},onChangeInternal:function(e){var t;return"function"==typeof(t=this.props).onChange&&t.onChange(e),this.props.value||(this.props.valueLink?this.props.valueLink.requestChange(e.target.value):this.setState({value:e.target.value})),this.supportsCompatiblePlaceholder()?this.setState({compatiblePlaceholderVisible:0===e.target.value.length}):void 0},onFocusInternal:function(e){var t,i,o,r,s,a;return"function"==typeof(a=this.props).onFocus&&a.onFocus(e),this.props.expandable!==!1?(r=n(e.target),t=n(this.refs.closeButton.getDOMNode()),o=this.state.inputWidth+this.props.expandedWidthOffset,s=parseInt(r.css("padding-right")),i=o-s+t.width()/2,t.css({left:i}),r.stop().animate({width:o},this.props.animationDuration,this.props.animationCurve,function(e){return function(){return t.stop().animate({opacity:1},e.props.animationDuration)}}(this)),this.setState({expanded:!0})):void 0},onKeyDownInternal:function(e){if(null!=this.state.expanded!=!1)switch(e.keyCode){case i.ESC:return e.target.blur(),this.onCloseClick()}}})},{password:u("input","password"),text:u("input","text"),textarea:u("textarea","text")}}),define("modules/clean/react/invite/invite_form_react",["external/react","modules/core/browser","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/ajax","modules/clean/analytics","modules/clean/contacts/tokenizer","modules/clean/react/button","modules/clean/react/image","modules/clean/react/input","modules/clean/react/invite/licenses_info","modules/clean/static_urls","modules/clean/viewer"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h){var f,m,g,v,y,b,w,C,S,E,T;return T=i._,E=i.ungettext,g=a.TeamsWebActionsLogger,f=l.ContactsTokenizer,v=u.button,S=_.textarea,C=p.static_url,b=e.addons.classSet,y=e.createElement,w=e.DOM,m=e.createClass({propTypes:{"user-id":e.PropTypes.number,"team-id":e.PropTypes.number,"allow-add-licenses":e.PropTypes.bool,"is-trial":e.PropTypes.bool,"inline-buy-disabled":e.PropTypes.bool,"available-licenses":e.PropTypes.number,"exp-skip-button-is-link":e.PropTypes.bool},getDefaultProps:function(){return{"exp-skip-button-is-link":!1}},getInitialState:function(){return{invites:[],customMessage:"",isLoading:!1,errors:{}}},_getUser:function(){var e,t;return t=h.get_viewer(),e=this.props["user-id"],null!=e?t.get_user_by_id(e):t.get_user_by_role(Constants.ROLE_WORK)},_onCustomMessageChange:function(e){this.setState({customMessage:e.target.value})},_onSubmitButtonClick:function(e){e.preventDefault(),this._submit()},_onSkipButtonClick:function(e){e.preventDefault(),this._skip()},_skip:function(){var e;g.log("setup_skip_add_members",{team_id:this.props["team-id"]}),e=r({path:"/team/admin/members"}).updateQuery({skipped_invite:1}),t.redirect(e.toString())},_submit:function(){var e,i;this.setState({isLoading:!0}),e=function(e){return function(t){var i;if(e.setState({isLoading:!1}),null!=(null!=t?t.responseText:void 0))if(t=t.responseText,0===t.indexOf("err:")){if(i=t.substr(4),0===i.indexOf("{"))return void e.setState({errors:JSON.parse(i)});o.error(new n(i))}else o.error();else o.error()}}(this),i=function(n){return function(i){var s,a;if(n.setState({errors:{}}),null!=i)try{return i=JSON.parse(i),o.success(T("Invites successfully sent.")),g.log("setup_add_members",{new_user_count:i.num_invited,team_id:n.props["team-id"]}),a=r({path:"/team/admin",query:{invited_team:1}}),t.redirect(a.toString())}catch(l){return s=l,e()}}}(this),s.WebRequest({url:"/account/team/add_users",data:{emails:this.refs.tokenizer.getContacts().map(function(e){return e.email}),custom_message:this.state.customMessage,team_id:this.props["team-id"]},subject_user:this._getUser(),success:i,error:e})},_renderLicensesInfo:function(){var e,t;return e=this.props["available-licenses"]-this.state.invites.length,t=this.props["allow-add-licenses"]&&!this.props["inline-buy-disabled"],t=!1,y(d,{className:"team-invite-form__licenses-info",availableLicenses:e,showAddLicenses:t,isTrial:this.props["is-trial"]})},_renderContactsTokenizer:function(e){var t;return[null!=(null!=(t=this.state.errors)?t.emails:void 0)?w.span({className:"error-message"},this.state.errors.emails):void 0,y(f,{ref:"tokenizer",customClass:"team-invite-form__tokenizer",user:e,showContactImport:!0,tabIndex:1,placeholder:T("Enter email address"),onContentsChange:function(e){return function(t){return e.setState({invites:t})}}(this)})]},_renderCustomMessageField:function(){return y(S,{name:"custom_message",className:"team-invite-form__custom-message",value:this.state.customMessage,placeholder:T("Add an optional message"),"error-after":!0,tabIndex:2,onChange:this._onCustomMessageChange})},_renderFormButtons:function(e){var t,n,i,o,r,s;return s=T(e?"Inviting members...":"Invite and continue"),t=y(v,{className:"team-invite-form__submit-button",disabled:e,tabIndex:3,onClick:this._onSubmitButtonClick},s),o=T("Skip for now"),r={"team-invite-form__skip-button":!0},i=this.props["exp-skip-button-is-link"]?(r["team-invite-form__skip-button--is-link"]=!0,r["team-invite-form__skip-button--disabled"]=e,w.a({className:b(r),tabIndex:4,onClick:this._onSkipButtonClick},o)):y(v,{className:b(r),disabled:e,tabIndex:4,onClick:this._onSkipButtonClick,importance:"tertiary"},o),e&&(n=c({className:"team-invite-form__loading-icon",src:C("/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"),srcHiRes:C("/static/images/icons/ajax-loading-small@2x-vflAxdZTP.gif")})),w.div({className:"team-invite-form__buttons-wrapper"},[n,t,i])},render:function(){return w.form({className:"team-invite-form"},[this._renderLicensesInfo(),this._renderContactsTokenizer(this._getUser()),this._renderCustomMessageField(),this._renderFormButtons(this.state.isLoading)])}}),{InviteFormReact:m}}),define("modules/clean/react/invite/licenses_info",["external/react","modules/core/i18n","modules/clean/dbmodal"],function(e,t,n){var i,o,r,s,a,l;return l=t._,a=t.ungettext,s=e.DOM,r=e.addons.classSet,i=n.DBModalStack,o=e.createClass({propTypes:{availableLicenses:e.PropTypes.number,showAddLicenses:e.PropTypes.bool,isTrial:e.PropTypes.bool,onLicensesAdded:e.PropTypes.func,className:e.PropTypes.string},getDefaultProps:function(){return{showAddLicenses:!1,isTrial:!1}},getInitialState:function(){return{licensesAdded:0}},_getMessage:function(e){return 0>e?l("You need more licenses for this invitation."):0===e?l("You have no remaining licenses."):e>0?a("You have %(n)s remaining license.","You have %(n)s remaining licenses.",e).format({n:e}):""},render:function(){var e,t;return t=this.props.availableLicenses+this.state.licensesAdded,e=s.span(r({over:0>t}),this._getMessage(t)),s.div({className:""+this.props.className+" licenses-info"},e)}})}),define("modules/clean/react/modal",["external/react","jquery","modules/core/i18n","modules/core/dom","modules/clean/react/button","modules/clean/keycode"],function(e,t,n,i,o,r){var s,a,l,u,c,_,d;return _=n._,c=e.DOM,u=e.addons.classSet,s="react-modal-root",d=function(e){var n,i;return null==e&&(e=!0),n=s,i=t("#"+n),!i.length&&e&&(i=t("<div />").attr({id:n}).prependTo("body")),i[0]},a=e.createClass({displayName:"Modal",statics:{showInstance:function(t){var n;return n=d(),e.unmountComponentAtNode(n),e.render(t,n)},close:function(){var t;return t=d(),t?e.unmountComponentAtNode(t):void 0},unhide:function(){var e;return e=d(),e?t(e).show():void 0},hide:function(){var e;return e=d(),e?t(e).hide():void 0}},propTypes:{width:e.PropTypes.number,submitting:e.PropTypes.bool,title:e.PropTypes.string,acceptButtonText:e.PropTypes.string,dismissButtonText:e.PropTypes.string,additionalButtonsText:e.PropTypes.array,additionalButtonsHandler:e.PropTypes.func,altAction:e.PropTypes.node,onAccept:e.PropTypes.func,onDismiss:e.PropTypes.func,onDismissCompleted:e.PropTypes.func,onShow:e.PropTypes.func,buttonComponent:e.PropTypes.element,autoClose:e.PropTypes.bool,showX:e.PropTypes.bool,acceptButtonDisabled:e.PropTypes.bool,style:e.PropTypes.oneOf(["default","clean","simple","lightbox"]),setMaxHeight:e.PropTypes.bool,className:e.PropTypes.string},close:function(){return a.close()},_invokeCallbackAndClose:function(e,t,n){return null!=e&&"function"==typeof e.call&&e.call(this,t),t.isDefaultPrevented()?void 0:this.props.autoClose||n?this.close():void 0},_dismiss:function(e){var t;return this._invokeCallbackAndClose(this.props.onDismiss,e,!0),null!=(t=this.props.onDismissCompleted)&&"function"==typeof t.call?t.call(this,e):void 0},_accept:function(e){return this._invokeCallbackAndClose(this.props.onAccept,e,!1)},_additionalButtonPressed:function(e,t){var n;return"function"==typeof(n=this.props).additionalButtonsHandler&&n.additionalButtonsHandler(t,e),this.close()},getDefaultProps:function(){return{acceptButtonText:_("OK"),dismissButtonText:null,buttonComponent:null,onAccept:function(){},onDismiss:function(){},onShow:function(){},autoClose:!0,style:"default",showX:!0,acceptButtonDisabled:!1}},_fitInViewport:function(){var e,n,i,o,r,s,a,l,u;if("simple"!==this.props.style)return e=90,u=t(window).height(),n=t(this.getDOMNode()),r=n.find(".db-modal"),i=n.find(".db-modal-content"),s=r.height(),r.css(this.props.width?{width:this.props.width,marginLeft:-this.props.width/2}:{marginLeft:-r.width()/2}),s>u?(a=s-u,i.css({maxHeight:Math.max(50,i.height()-a),overflowY:"auto"}),r.css({marginTop:0,top:0})):r.css(2*e>u-s?{top:"50%",marginTop:-(.5*s)}:{top:e,marginTop:0}),r.css({position:"fixed"}),this.props.setMaxHeight?(l=parseInt(i.css("padding-top"))+parseInt(i.css("padding-bottom")),o=u-i.offset().top-5-l,i.css({overflow:"auto",maxHeight:Math.max(100,o)})):void 0},_focus:function(){var e,n;return e=t(this.refs.modal.getDOMNode()),n=e.find("input").first(),n.length?e=n:this.refs.primaryButton?e=t(this.refs.primaryButton.getDOMNode()):this.refs.tertiaryButton&&(e=t(this.refs.tertiaryButton.getDOMNode())),e.focus()},_keyDown:function(e){return e.stopPropagation(),e.which===r.ESC&&this._dismiss(e),e.which!==r.BACKSPACE||i.focus_in_input()?void 0:(e.preventDefault(),this._dismiss(e))},_renderButtons:function(){var e,t,n,i,r,s;if(this.props.buttonComponent)return this.props.buttonComponent;if(n=[],this.props.submitting&&n.push(c.span({className:"dbmodal-loading"},c.img({src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))),this.props.acceptButtonText&&n.push(o.button({ref:"primaryButton",className:"dbmodal-button",importance:"primary",disabled:this.props.acceptButtonDisabled,onClick:this._accept},this.props.acceptButtonText)),this.props.dismissButtonText&&n.push(o.button({ref:"tertiaryButton",className:"dbmodal-button",importance:"tertiary",onClick:this._dismiss},this.props.dismissButtonText)),this.props.additionalButtonsText)for(s=this.props.additionalButtonsText,e=i=0,r=s.length;r>i;e=++i)t=s[e],n.push(o.button({ref:"tertiaryButton",className:"dbmodal-button",importance:"tertiary",onClick:this._additionalButtonPressed.bind(this,e)},t));return n.length?c.div({className:"db-modal-buttons"},n):void 0},_renderAltAction:function(){return this.props.altAction?c.div({className:"db-modal__alt-action"},this.props.altAction):void 0},componentDidMount:function(){var e;return t(document).trigger("modalOpened",this),i.scroll_lock_document(),t(this.getDOMNode()).find("img").on("load",this._fitInViewport),this._fitInViewport(),t(this.refs.modal.getDOMNode()).on("keydown",this._keyDown),this._focus(),"function"==typeof(e=this.props).onShow?e.onShow():void 0},componentWillUnmount:function(){return t(document).trigger("modalClosed",this),i.scroll_unlock_document(),t(this.refs.modal.getDOMNode()).off("keydown",this._keyDown)},render:function(){var e,t;return t={"db-modal--clean-style":"clean"===this.props.style,"db-modal--simple-style":"simple"===this.props.style,"db-modal--lightbox-style":"lightbox"===this.props.style},t[this.props.className]=!0,e=u(t),c.div({className:e},c.div({className:"db-modal-overlay",onClick:this._dismiss}),c.div({ref:"modal",className:"db-modal",tabIndex:0},c.div({className:"db-modal-box"},"lightbox"===this.props.style?c.div({className:"db-modal-lightbox"},this.props.children):c.div({},this.props.showX?c.span({className:"db-modal-x",onClick:this._dismiss}):void 0,c.h2({
className:"db-modal-title"},c.div({className:"db-modal-title-text"},this.props.title)),c.div({className:"db-modal-content clearfix"},this.props.children,this._renderButtons(),this._renderAltAction())))))}}),l={show:function(t){var n;return n={acceptButtonText:t.confirm_text,onAccept:t.confirm_callback,dismissButtonText:t.cancel_text,onDismiss:t.cancel_callback,onDismissCompleted:t.cancel_completed_callback,title:t.title_text,width:t.width,className:"simple-modal",autoClose:t.autoclose,style:t.style,onShow:t.on_show},a.showInstance(new a(n,e.DOM.div({className:"simple-modal-content",dangerouslySetInnerHTML:{__html:t.body_html}})))}},{Modal:a,SimpleModal:l}}),define("modules/clean/react/previews/preview_blank",["external/react","jquery","modules/core/i18n","modules/core/uri","modules/clean/datetime","modules/clean/react/sprite"],function(e,t,n,i,o,r){var s,a,l;return a=e.DOM,l=n._,s=e.createClass({displayName:"PreviewBlank",propTypes:{icon:e.PropTypes.string,filename:e.PropTypes.string.isRequired,created:e.PropTypes.object,size:e.PropTypes.string},getDefaultProps:function(){return{icon:"page_white_picture_32"}},render:function(){var e;return a.div({className:"preview-blank-container"},a.div({className:"preview-blank-wrapper"},a.div({className:"preview-blank-icon"},r({group:"web",name:""+this.props.icon})),a.div({className:"preview-blank-title"},""+this.props.filename),a.div({className:"preview-blank-info"},null==this.props.created||isNaN(null!=(e=this.props.created)?e.getTime():void 0)?void 0:[a.span({},""+o.format_date(this.props.created,"MMMM dd, yyyy hh:mm a")),a.span({className:"bottom-dot"}," Â· ")],null!=this.props.size&&""!==this.props.size?a.span({},""+this.props.size):void 0)))}})}),define("modules/clean/react/previews/preview_flippable",["external/react","modules/clean/react/previews/preview_blank","modules/clean/react/previews/preview_image","modules/clean/react/previews/preview_video","modules/clean/react/sprite","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,r){var s,a,l,u,c,_;return a=n.PreviewImage,l=i.PreviewVideo,c=e.DOM,u=e.addons.classSet,_=r._,s=e.createClass({statics:{isFlippable:function(e){return"photo"===e||"video"===e}},displayName:"PreviewFlippable",propTypes:{"preview-type":e.PropTypes.oneOf(["photo","video"]),"file-extension":e.PropTypes.string.isRequired,"thumbnail-url-tmpl":e.PropTypes.string.isRequired,onLoad:e.PropTypes.func,onError:e.PropTypes.func,index:e.PropTypes.number,count:e.PropTypes.number,onPrevious:e.PropTypes.func,onNext:e.PropTypes.func,imagesToPreload:e.PropTypes.array,"preview-url":e.PropTypes.string,"video-metadata-url":e.PropTypes.string,"file-meta":e.PropTypes.shape({filename:e.PropTypes.string,mtime:e.PropTypes.number,formattedSize:e.PropTypes.string}).isRequired},_canFlipPrevious:function(){return this.props.index>0},_canFlipNext:function(){return this.props.index+1<this.props.count},_onPrevious:function(){var e;return"function"==typeof(e=this.props).onPrevious?e.onPrevious():void 0},_onNext:function(){var e;return"function"==typeof(e=this.props).onNext?e.onNext():void 0},_reactElementForPreviewType:function(n){var i;switch(n){case"photo":return e.createElement(a,{"thumbnail-url-tmpl":this.props["thumbnail-url-tmpl"],"file-extension":this.props["file-extension"],"file-meta":this.props["file-meta"],imagesToPreload:this.props.imagesToPreload,index:this.props.index,count:this.props.count,onPrevious:this._onPrevious,onNext:this._onNext,onLoad:this.props.onLoad,onError:this.props.onError});case"video":return e.createElement(l,{"preview-url":this.props["preview-url"],"thumbnail-url-tmpl":this.props["thumbnail-url-tmpl"],onLoad:this.props.onLoad});default:return i=this.props["file-meta"],e.createElement(t,{filename:i.filename,created:new Date(1e3*i.mtime),size:i.formattedSize})}},render:function(){var e;return c.div({className:"preview-flip-container"},[this._reactElementForPreviewType(this.props["preview-type"]),this.props.count>1?(e={"flip-controls":!0,"flip-controls--prev":this._canFlipPrevious(),"flip-controls--next":this._canFlipNext()},c.div({className:u(e)},c.div({className:"flip-button-prev",onClick:this._onPrevious},o({group:"web",name:"s_flip_left"})),c.div({className:"flip-label"},""+(this.props.index+1)+" of "+this.props.count),c.div({className:"flip-button-next",onClick:this._onNext},o({group:"web",name:"s_flip_right"})))):void 0])}}),{PreviewFlippable:s}}),define("modules/clean/react/previews/preview_image",["external/react","jquery","modules/clean/analytics","modules/clean/image_cache","modules/clean/image_size","modules/clean/react/previews/preview_blank","modules/clean/react/previews/preview_image_zoom","modules/core/browser","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u){var c,_,d,p,h,f,m,g;return c=n.PreviewActivityLogger,m=o.image_best_fit_size,p=s.PreviewImageZoom,h=e.addons.classSet,f=e.DOM,g=l._,_=e.createFactory(r),d=e.createClass({displayName:"PreviewImage",propTypes:{"thumbnail-url-tmpl":e.PropTypes.string.isRequired,"file-extension":e.PropTypes.string.isRequired,"file-meta":e.PropTypes.shape({filename:e.PropTypes.string,mtime:e.PropTypes.number,formattedSize:e.PropTypes.string}).isRequired,imagesToPreload:e.PropTypes.array,onLoad:e.PropTypes.func,onError:e.PropTypes.func},getInitialState:function(){return{imageVisibility:"hidden",imageLoadError:!1}},_logOpen:function(){return c.log("open",{file_ext:this.props["file-extension"]})},_getSizedImageUrl:function(e){return u.parse(e).updateQuery({size:m(t(window).width(),t(window).height()),size_mode:2}).toString()},_preloadImages:function(e){var t,n,o,r,s;if(null!=e){for(t=new i,s=[],o=0,r=e.length;r>o;o++)n=e[o],s.push(t.preload_image(this._getSizedImageUrl(n)));return s}},_onImageLoad:function(){var e,n,i;return n=t(".preview-image-container"),e=n.find(".preview-image"),this.setState({imageVisibility:"visible"}),this._shouldDisableZoom()||e.off("click").on("click",function(e){return function(){return p.open(e.props["thumbnail-url-tmpl"],e._getSizedImageUrl(e.props["thumbnail-url-tmpl"]))}}(this)),"function"==typeof(i=this.props).onLoad?i.onLoad():void 0},_onImageError:function(){var e;return"function"==typeof(e=this.props).onError&&e.onError(),this.setState({imageLoadError:!0})},_shouldDisableZoom:function(){return a.msie_version_at_most(9)},componentWillMount:function(){return this._preloadImages(this.props.imagesToPreload)},componentDidMount:function(){return this._logOpen()},componentWillReceiveProps:function(e){return this._preloadImages(e.imagesToPreload),this._logOpen()},_renderPreviewImage:function(){var e;return e={"preview-image-container":!0,"zoom-disabled":this._shouldDisableZoom()},f.div({className:h(e)},f.div({className:"preview-image-wrapper"},f.img({className:"preview-image",src:this._getSizedImageUrl(this.props["thumbnail-url-tmpl"]),style:{visibility:this.state.imageVisibility},onLoad:this._onImageLoad,onError:this._onImageError})))},_renderPreviewBlank:function(){var e;return e=this.props["file-meta"],_({filename:e.filename,created:new Date(1e3*e.mtime),size:e.formattedSize})},render:function(){return this.state.imageLoadError?this._renderPreviewBlank():this._renderPreviewImage()}}),{PreviewImage:d}}),define("modules/clean/react/previews/preview_image_zoom",["external/jquery.mousewheel","external/jquery.fs.zoomer","external/react","external/keymaster","external/underscore","jquery","modules/clean/react/image","modules/clean/react/sprite","modules/clean/static_urls","modules/core/dom","modules/core/exception","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u,c,_,d){var p,h,f,m,g;return m=l.static_url,h=n.addons.classSet,f=n.DOM,g=_._,p=n.createClass({statics:{open:function(e,t){var i,o;return o=r("<div />"),r(document.body).append(o),i=p({thumbnailUrlTmpl:e,lastImageUrl:t}),n.render(i,o.get(0))}},displayName:"PreviewImageZoom",propTypes:{thumbnailUrlTmpl:n.PropTypes.string,lastImageUrl:n.PropTypes.string,enableMouseZoom:n.PropTypes.bool},getDefaultProps:function(){return{enableMouseZoom:!1}},getInitialState:function(){return{imgLoaded:!1,zoomOutDisabled:!0,zoomInDisabled:!1,dragDisabled:!0}},componentWillMount:function(){return this.originalImg=new window.Image,this.originalImg.onload=this._onOriginalImageLoaded,this.originalImg.onerror=this._onOriginalImageError,this.originalImg.src=this._originalImageUrl()},componentDidMount:function(){var e,t,n;return this._startControlsTimer(),this._hideCursor(),t=r(this.refs.previewZoomerClose.getDOMNode()),t.on("click",this._onClose),e=r(this.getDOMNode),e.on("close",this._onClose),n="previewimagezoom",p.didAssignEscape!==!0&&(key("esc",n,function(){return e.trigger("close")}),p.didAssignEscape=!0),this.prevKeyScope=key.getScope(),key.setScope(n),r(this.refs.previewZoomerContainer.getDOMNode()).on("click.close",function(e){return function(t){return r(t.target).hasClass("zoomer")?(t.preventDefault(),e._onClose()):void 0}}(this))},componentWillUnmount:function(){return clearTimeout(this.controlsHideTimer),this._showCursor(),this._destroyZoomer(),key.setScope(this.prevKeyScope),r(this.getDOMNode).off("close"),r(window).off("resize.zommer")},shouldComponentUpdate:function(e,t){return!o.isEqual(e,this.props)||!o.isEqual(t,this.state)},_originalImageUrl:function(){return d.parse(this.props.thumbnailUrlTmpl).updateQuery({size_mode:5}).toString()},_onOriginalImageLoaded:function(){return this.setState({imgLoaded:!0},function(e){return function(){return e._bindZoomer()}}(this))},_onOriginalImageError:function(){return c.assert("Error loading original full resoltuion image in zoom view"),this.originalImg.src=this.props.lastImageUrl,this.setState({imgLoaded:!0},function(e){return function(){return e._bindZoomer()}}(this))},_bindZoomer:function(){return window.zoomer(r(this.refs.previewZoomer.getDOMNode()),{controls:{zoomIn:r(this.refs.zoomControlZoomIn.getDOMNode()),zoomOut:r(this.refs.zoomControlZoomOut.getDOMNode()),zoomLabel:r(this.refs.zoomControlLabel.getDOMNode())},customClass:"preview-zoomer-style",retina:window.devicePixelRatio>1,onZoomCallback:this._onZoomCallback}),null==this.fitToZoom&&(this.fitToZoom=this._getZoomPercent()),r(window).off("resize.zoomer").on("resize.zoomer",function(e){return function(){var t;return zoomer(r(null!=(t=e.refs.previewZoomer)?t.getDOMNode():void 0),"resize"),e.fitToZoom=e._getZoomPercent()}}(this)),this.props.enableMouseZoom?r(this.refs.previewZoomerContainer.getDOMNode()).off("mousewheel.zoom").on("mousewheel.zoom",function(e){return function(t,n){return t.preventDefault(),n>0?e._zoomIn():e._zoomOut()}}(this)):void 0},_destroyZoomer:function(){var e;return window.zoomer(r(null!=(e=this.refs.previewZoomer)?e.getDOMNode():void 0),"destroy")},_startControlsTimer:function(){return this._showControls(),clearTimeout(this.controlsHideTimer),this.controlsHideTimer=setTimeout(function(e){return function(){return e._hideControls()}}(this),3e3)},_showControls:function(){var e;return this._showCursor(),r(null!=(e=this.refs.previewZoomerToolbarContainer)?e.getDOMNode():void 0).css("opacity",1),r(this.refs.previewZoomerClose.getDOMNode()).css("opacity",1)},_hideControls:function(){var e;return this._hideCursor(),r(null!=(e=this.refs.previewZoomerToolbarContainer)?e.getDOMNode():void 0).css("opacity",0),r(this.refs.previewZoomerClose.getDOMNode()).css("opacity",0)},_showCursor:function(){return r("html").removeClass("no-cursor")},_hideCursor:function(){return r("html").addClass("no-cursor")},_onZoomCallback:function(e){return this.setState({zoomOutDisabled:e.atMinZoom,zoomInDisabled:e.atMaxZoom,dragDisabled:e.atMinZoom})},_getZoomPercent:function(){return parseFloat(r(this.refs.zoomControlLabel.getDOMNode()).text())},_zoomToFit:function(){var e;return r(null!=(e=this.refs.zoomControlZoomOut)?e.getDOMNode():void 0).trigger("mousedown.zoomer")},_zoom100:function(){var e;return zoomer(r(null!=(e=this.refs.previewZoomer)?e.getDOMNode():void 0),"zoom100")},_zoomOut:function(){var e;return r(null!=(e=this.refs.zoomControlZoomOut)?e.getDOMNode():void 0).trigger("mousedown.zoomer")},_zoomIn:function(){var e;return r(null!=(e=this.refs.zoomControlZoomIn)?e.getDOMNode():void 0).trigger("mousedown.zoomer")},_onClose:function(){var e;return e=this.getDOMNode().parentNode,n.unmountComponentAtNode(e),r(e).remove()},_onImageDoubleClick:function(e){return r(e.target).hasClass("zoomer")?void 0:this._getZoomPercent()<100?this._zoom100():this._zoomToFit()},_onMouseMove:function(e){return 0===r(e.target).parents(".preview-toolbar-overlay").length?this._startControlsTimer():clearTimeout(this.controlsHideTimer)},_renderClose:function(){return f.div({ref:"previewZoomerClose",className:"preview-zoomer-close"},a({group:"web",name:"lightbox_close"}))},_renderZoomControls:function(){var e,t;return e={"toolbar-button-entry":!0,"zoom-in":!0,disabled:this.state.zoomInDisabled},t={"toolbar-button-entry":!0,"zoom-out":!0,disabled:this.state.zoomOutDisabled},f.div({ref:"previewZoomerToolbarContainer",className:"preview-toolbar-overlay-container"},f.div({className:"preview-toolbar-overlay"},f.div({className:"preview-toolbar-content"},f.div({ref:"zoomControlZoomOut",className:h(t)},a({group:"web",name:"zoomout"})),f.div({ref:"zoomControlLabel",className:"zoom-label"}),f.div({ref:"zoomControlZoomIn",className:h(e)},a({group:"web",name:"zoom"})))))},_renderOriginalImage:function(){return[f.div({ref:"previewZoomer",className:"preview-zoomer",style:{textAlign:"center"},onDoubleClick:this._onImageDoubleClick},f.img({className:"preview-zoom",src:this.originalImg.src})),this._renderClose(),this._renderZoomControls()]},_renderLoading:function(){return[f.div({className:"preview-zoomer-loading"},s({src:m("/static/images/icons/white-on-dark-spinner-vflInam4o.gif"),srcHiRes:m("/static/images/icons/white-on-dark-spinner@2x-vfltkzAUn.gif")})),this._renderClose()]},render:function(){var e;return e={"preview-zoomer-container":!0,"zoomer-drag-disabled":this.state.dragDisabled},f.div({ref:"previewZoomerContainer",className:h(e),onMouseMove:this._onMouseMove},this.state.imgLoaded?this._renderOriginalImage():this._renderLoading())}}),{PreviewImageZoom:p}}),define("modules/clean/react/previews/preview_linkfile",["external/react","jquery","modules/clean/analytics","modules/clean/ajax","modules/clean/em_string","modules/clean/filepath","modules/clean/previews/file_viewer_utils","modules/clean/react/sprite","modules/clean/referrer_cleansing_redirect","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u,c){var _,d,p,h,f,m,g;return _=n.LinkfileActivityLogger,m=r.filename_without_extension,f=r.file_extension,p=e.addons.classSet,h=e.DOM,g=u._,d=e.createClass({displayName:"PreviewLinkfile",propTypes:{filename:e.PropTypes.string.isRequired,"linkfile-data-link":e.PropTypes.string,"authenticated-data-link":e.PropTypes.bool.isRequired,source:e.PropTypes.string.isRequired},FILE_VIEWER_OPEN_PREVIEW_EVENT:"db:filepreview:open",FILE_VIEWER_CLOSE_PREVIEW_EVENT:"db:filepreview:close",SPINNER_FADE_DELAY_MSEC:150,MAX_DISPLAYED_FILENAME_CHARS:21,getInitialState:function(){return{description:null,hadError:!1,link:null}},_logEvent:function(e,t,n,i){var o;return null==i&&(i={}),o=null!=t?c.parse(t).getAuthority():null,_.log(e,f(this.props.filename),o,n,this.props.source,i)},_isFileDataFetched:function(){return null==this.state.description},componentDidMount:function(){var e;return e=s.getFileViewerElement(),e.on(this.FILE_VIEWER_OPEN_PREVIEW_EVENT,this.handlePreviewOpen),e.on(this.FILE_VIEWER_CLOSE_PREVIEW_EVENT,this.handlePreviewClose),null!=this.props["linkfile-data-link"]?this.requestLinkfileData(this.props["linkfile-data-link"]):void 0},componentWillUnmount:function(){var e,t,n;return e=s.getFileViewerElement(),e.off("db:filepreview:open",this.handlePreviewOpen),e.off("db:filepreview:close",this.handlePreviewClose),this._logEvent("destroy",t=this.state.link,n=!0)},requestLinkfileData:function(e){var t,n,o;return this._logEvent("requestlinkdata",t=null,o=!0),n={url:e,dataType:"json",success:this.handleLinkDataSuccess,error:this.handleLinkDataError},this.props["authenticated-data-link"]?(n.xhrFields={withCredentials:!0},i.AuthenticatedRequest(n)):i.Request(n)},handlePreviewOpen:function(e,t){return null!=t.linkfile_link?this.requestLinkfileData(t.linkfile_link):this.handleLinkDataError()},handlePreviewClose:function(){var e,t;return this._logEvent("close",e=this.state.link,t=!0)},handleLinkDataSuccess:function(e){var t,n;return null==e.uri?void this.handleLinkDataError():(this._logEvent("displaylinkdata",t=e.uri,n=!0),this.setState({description:e.uri,hadError:!1,link:e.uri}))},handleLinkDataError:function(){var e,t;return this._logEvent("displaylinkerror",e=null,t=!1),this.setState({description:g("Canât show link. Somethingâs wrong with this file."),hadError:!0,link:null})},handleClickOpenLinkButton:function(){var e,t,n;if(null!=this.state.link)return this._logEvent("navlink",e=this.state.link,n=!0),t=l.get_redirect_uri(this.state.link),window.open(t,"_blank")},render:function(){var e,t,n,i,r,s,a,l;return e={"preview-linkfile-content":!0,"loading-content":this._isFileDataFetched()},l={"preview-linkfile-button-openlink":!0,"button-primary":!0,"has-link":null!=this.state.link},i="-",s="",null!=this.props.filename&&(i=m(this.props.filename),s=f(this.props.filename),""!==s&&(s="."+s)),a=this.MAX_DISPLAYED_FILENAME_CHARS-s.length,r=o.em_snippet(i,a),n=null!=this.state.description?this.state.description:"-",t={"preview-linkfile-description":!0,"force-show-all-text":this.state.hadError},h.div({className:"preview-linkfile-container"},h.div({className:"preview-linkfile-wrapper"},h.div({className:"preview-linkfile-box"},h.div({className:p(e),ref:"content"},h.div({className:"preview-linkfile-icon"},h.img({src:"/static/images/icons128/page_white_linkfile-vfloEntlU.png"})),h.div({className:"preview-linkfile-title"},h.span({className:"preview-linkfile-filebase",ref:"fileBase"},r),h.span({className:"preview-linkfile-fileext",ref:"fileExt"},s)),h.div({className:"preview-linkfile-info"},h.div({className:p(t),ref:"description"},n),h.button({className:p(l),onMouseUp:this.handleClickOpenLinkButton,ref:"openLinkButton"},g("Open in new tab")))))))}}),{PreviewLinkfile:d}}),define("modules/clean/react/previews/preview_video",["external/react","jquery","modules/clean/image_size","modules/clean/react/react_i18n","modules/clean/static_urls","modules/clean/video_util","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,r,s,a){var l,u,c,_,d;return _=n.image_best_fit_size,d=o.static_url,c=e.DOM,u=i.R_,l=e.createClass({displayName:"PreviewVideo",propTypes:{"preview-url":e.PropTypes.string,"thumbnail-url-tmpl":e.PropTypes.string,"video-metadata-url":e.PropTypes.string,onLoad:e.PropTypes.func},getInitialState:function(){return{error:null}},_getSizedImageUrl:function(){return a.parse(this.props["thumbnail-url-tmpl"]).updateQuery({size:_(t(window).width(),t(window).height()),size_mode:2}).toString()},_shutdown:function(){var e,n;if(t(".vjs-big-play-button").blur(),null!=this._player){try{this._player.trigger("shutdown"),"Hls"===this._player.techName&&null!=(n=this._player.tech.sourceBuffer)&&n.abort(),this._player.dispose()}catch(i){e=i}return this._player=null}},_onReady:function(){var e;return e=function(){return t(".vjs-poster").show(),t(".vjs-big-play-button").show(),t(".vjs-big-play-button").focus()},e.defer()},_onPlay:function(){return t(".vjs-poster").hide(),t(".vjs-big-play-button").hide()},_onEnded:function(){return t(".vjs-poster").show(),t(".vjs-big-play-button").show(),t(".vjs-loading-spinner").hide()},_onError:function(e){return this._shutdown(),this.setState({error:e})},_embedVideoUtil:function(){var e,n;return e=t(this.refs.previewVideoContainer.getDOMNode()),n=t(this.refs.previewVideoPlayer.getDOMNode()),this._player=r.embed(n,{src:this.props["preview-url"],type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:e.width(),height:e.height(),controls:!0,preload:"auto",poster:this._getSizedImageUrl(),metadata_link:this.props["video-metadata-url"],metadata:null,onError:this._onError,onReady:this._onReady}),this._player.on("play",this._onPlay),this._player.on("ended",this._onEnded),t(".vjs-poster").hide(),t(".vjs-big-play-button").hide()},componentDidMount:function(){var e;return this._embedVideoUtil(),"function"==typeof(e=this.props).onLoad?e.onLoad():void 0},componentWillUpdate:function(){return this._shutdown()},componentDidUpdate:function(){var e;return this._embedVideoUtil(),"function"==typeof(e=this.props).onLoad?e.onLoad():void 0},componentWillUnmount:function(){return this._shutdown()},_renderPlayer:function(){return c.div({ref:"previewVideoPlayer",className:"video-player"})},_renderError:function(){return c.div({ref:"previewVideoError",className:"preview-video-error"},[c.img({src:d("/static/images/preview_fail-vflc3IDxf.png")}),"needflash"===this.state.error?c.div({},u({},'Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to preview this video.')):c.div({},u({},"Unable to preview this item."))])},render:function(){return c.div({ref:"previewVideoContainer",className:"preview-image-container"},c.div({className:"preview-image-wrapper"},null!=this.state.error?this._renderError():this._renderPlayer()))}}),{PreviewVideo:l}});var __hasProp={}.hasOwnProperty,__slice=[].slice;define("modules/clean/react/react_i18n",["external/react","external/underscore","modules/core/i18n","modules/clean/react/util"],function(e,t,n,i){var o,r,s,a,l,u;return s=e.DOM,l=this,u=function(e){return l.project=e},a=function(e,n){var i,o,r;if(!t.isEmpty(n)){i={};for(o in n)__hasProp.call(n,o)&&(r=n[o],i[o]=t.escape(r));e=e.format(i)}return e},r=e.createClass({displayName:"R_",propTypes:function(){return{project:e.PropTypes.string,comment:e.PropTypes.string}},render:function(){var e,i,o,r,u;if(o=this.props.children,"string"!=typeof o)throw new Error("R_ can only take a single string child");return i=this.props.project||l.project,u=n._(o,{project:i,comment:this.props.comment}),r=t.omit(this.props,"children","project","comment"),e=a(u,r),s.span({dangerouslySetInnerHTML:{__html:e}})}}),o=e.createClass({displayName:"RP_",propTypes:function(){return{n:e.PropTypes.number,project:e.PropTypes.string,comment:e.PropTypes.string}},render:function(){var o,r,u,c,_;if(u=[],"number"!=typeof this.props.n)throw new Error("RP_ requires a number prop for @props.n, got "+this.props.n);return e.Children.forEach(this.props.children,function(e){return u.push(i.getText(e))}),r=this.props.project||l.project,_=n.ungettext.apply(n,__slice.call(u).concat([this.props.n],[{project:r,comment:this.props.comment}])),c=t.omit(this.props,"children","n","project","comment"),o=a(_,c),s.span({dangerouslySetInnerHTML:{__html:o}})}}),{R_:e.createFactory(r),RP_:e.createFactory(o),setReactI18nDefaultProject:u}}),define("modules/clean/react/recaptcha_challenge",["jquery","external/react","modules/clean/react/form_error_mixin","modules/clean/react/input","modules/clean/react/react_i18n","modules/clean/static_urls"],function(e,t,n,i,o,r){var s,a,l,u;return u=r.static_url,l=t.DOM,s=o.R_,a=t.createClass({mixins:[n],getDefaultProps:function(){return{public_key:"",errorWrapperClassName:"text-input-error-wrapper",variant:"standard"}},componentDidMount:function(){var t;return t=this.props.public_key,e.getScript("https://www.google.com/recaptcha/api/js/recaptcha_ajax.js",function(){return Recaptcha.create(t,"recaptcha_widget",{theme:"custom"})})},handleReloadLinkClick:function(){return Recaptcha.reload()},handleSwitchTypeToAudioLinkClick:function(){return Recaptcha.switch_type("audio")},handleSwitchTypeToImageLinkClick:function(){return Recaptcha.switch_type("image")},handleHelpLinkClick:function(){return Recaptcha.showhelp()},_renderButtons:function(){return l.div({className:""+this.props.variant+" recaptcha-buttons"},l.a({className:"recaptcha-button recaptcha-reload",onClick:this.handleReloadLinkClick},l.img({src:u("/static/images/icons/captcha-reload-vflqH90Ce.png")})),l.a({className:"recaptcha-button recaptcha_only_if_image",onClick:this.handleSwitchTypeToAudioLinkClick},l.img({src:u("/static/images/icons/captcha-audio-vfl_VBPgQ.png")})),l.a({className:"recaptcha-button recaptcha_only_if_audio",onClick:this.handleSwitchTypeToImageLinkClick},l.img({src:u("/static/images/icons/captcha-words-vfl-bt9Xw.png")})),l.a({className:"recaptcha-button recaptcha-show-help",onClick:this.handleHelpLinkClick},l.img({src:u("/static/images/icons/captcha-help-vfleUYtSD.png")})))},_renderRecaptchaResponseInput:function(){return i.text({id:"recaptcha_response",name:"recaptcha_response",className:"login-text-input","disable-errors":!0,label:s({},"Type the text")})},_renderDummyInput:function(){return l.input({type:"hidden",id:"recaptcha_response_field"})},_renderStandard:function(){var e;return e=this.renderErrorIfEnabled(),l.div({id:"recaptcha_widget",className:"standard recaptcha-container"},e,l.div({id:"recaptcha_image",className:"standard login-recaptcha-challenge-container"}),this._renderRecaptchaResponseInput(),this._renderButtons(),this._renderDummyInput())},_renderSmall:function(){var e;return e=this.renderErrorIfEnabled(),l.div({id:"recaptcha_widget",className:"small recaptcha-container"},e,l.div({id:"recaptcha_image",className:"small login-recaptcha-challenge-container"}),this._renderButtons(),this._renderRecaptchaResponseInput(),this._renderDummyInput())},render:function(){return"standard"===this.props.variant?this._renderStandard():"small"===this.props.variant?this._renderSmall():void 0},reload:function(e){return this.setProps({error:e}),Recaptcha.reload()}})}),define("modules/clean/react/select",["external/react","external/underscore","jquery","modules/clean/keycode","modules/clean/react/form_error_mixin","modules/clean/react/sprite","modules/clean/react/util"],function(e,t,n,i,o,r,s){var a,l,u,c,_,d;return l=e.addons.classSet,a=e.addons.cloneWithProps,u=e.DOM,c=function(e,t){var n,i,o,r;return r=e.scrollTop(),o=r+e.height(),i=t.position().top+r,n=i+t.height(),r>i?e.scrollTop(i):n>o?e.scrollTop(n-e.height()):void 0},d=e.createClass({propTypes:function(){return{disabled:e.PropTypes.bool,title:e.PropTypes.string,value:e.PropTypes.string}},render:function(){var e;return e={"list-item":!0,"select-option":!0,"select-option-disabled":this.props.disabled},this.transferPropsTo(u.div({className:l(e),"data-value":this.props.value,title:this.props.title},this.props.children))}}),_=e.createClass({mixins:[o],mouseInput:!0,propTypes:{name:e.PropTypes.string,onChange:e.PropTypes.func,defaultValue:e.PropTypes.string,style:e.PropTypes.object,value:e.PropTypes.string,variant:e.PropTypes.string,className:e.PropTypes.string,valueLink:e.PropTypes.object},getDefaultProps:function(){return{errorWrapperClassName:"select-input-error-wrapper",style:null}},getInitialState:function(){return{open:!1,focused:null,keyboarsSelectPrefix:"",value:this.props.defaultValue}},_getFilteredChildren:function(){return t.isArray(this.props.children)?t.filter(this.props.children,function(e){return e}):this.props.children},render:function(){var t,n;return t={"select-input":!0,"select-input-dropdown-shown":this.state.open},this.props.variant&&(t[this.props.variant]=!0),this.props.className&&(t[this.props.className]=!0),n={"list-menu":!0,"select-input-dropdown":!0,"select-input-disable-error":this.props["disable-errors"]},u.div({className:l(t),style:this.props.style},u.div({className:"hidden-select-wrapper"},u.select({tabIndex:-1,name:this.props.name,defaultValue:this.props.defaultValue,value:this.getValue()},e.Children.map(this._getFilteredChildren(),function(){return function(e){return u.option({value:e.props.value,disabled:e.props.disabled})}}(this)))),this.renderErrorIfEnabled(),u.div({className:"select-input-input",tabIndex:0,"aria-hidden":!0,onClick:this.toggle,onKeyDown:this.handleKeydown,onMouseMove:this.handleMouseMove,ref:"label"},this.selectedOption(),u.div({className:"select-input-dropdown-arrow"},r({group:"web",name:"arrow-down-gray"}))),u.div({style:{position:"relative"}},u.div({className:l(n),"aria-hidden":!0,ref:"dropdown"},this.menuChildren())))},handleMouseMove:function(e){var t,n;return(e.pageX!==t||e.pageY!==n)&&(this.mouseInput=!0),t=e.pageX,n=e.pageY},_commonPrefixLen:function(e,t){var i;for(e=n.trim(e).toLowerCase(),t=n.trim(t).toLowerCase(),i=0;i<e.length&&i<t.length&&e.charAt(i)===t.charAt(i);)i++;return i},_keyboardSelect:function(e){var n,i,o,r,s;return s=t.sortedIndex(this.sortedOptions,{text:e.toLowerCase()},"text"),o=this.sortedOptions[Math.max(s-1,0)],n=this.sortedOptions[Math.min(s,this.sortedOptions.length-1)],r=this._commonPrefixLen(e,o.text),i=this._commonPrefixLen(e,n.text),this.setState(r>=i?{keyboarsSelectPrefix:e,focused:o.value}:{keyboarsSelectPrefix:e,focused:n.value})},handleKeydown:function(e){var n,o;switch(this.mouseInput=!1,e.keyCode){case i.TAB:return this.setState({open:!1,focused:null}),!0;case i.ENTER:this.state.open&&this.state.focused?(this.setValue(this.state.focused),this.setState({open:!1})):this.toggle();break;case i.UP:this.setState(this.state.open?{focused:this.prev(this.state.focused)}:{open:!0});break;case i.DOWN:this.setState(this.state.open?{focused:this.next(this.state.focused)}:{open:!0});break;default:if(!this.state.open)return!0;t.contains(t.values(i),e.keyCode)||(n=String.fromCharCode(e.which),o=this.state.keyboarsSelectPrefix+n,this._keyboardSelect(o),this._keyboardSelect_timeout&&clearTimeout(this._keyboardSelect_timeout),this._keyboardSelect_timeout=setTimeout(function(e){return function(){return e.setState({keyboarsSelectPrefix:""}),e._keyboardSelect_timeout=null}}(this),500))}return!1},prev:function(t){var n,i;return n=null,i=null,e.Children.forEach(this._getFilteredChildren(),function(){return function(e){return i||(i=e),e.props.value===t&&(n=i),i=e}}(this)),null!=n?n.props.value:void 0},next:function(t){var n,i,o;return n=null,i=null,e.Children.forEach(this._getFilteredChildren(),function(){return function(e){return(null!=i?i.props.value:void 0)===t&&(n=e),i=e}}(this)),null!=(o=n||i)?o.props.value:void 0},menuChildren:function(){var t,n;return n=this.getValue(),t=e.Children.map(this._getFilteredChildren(),function(e){return function(t){var i;return i=a(t,{onMouseEnter:function(){return e.mouseInput?e.setState({focused:t.props.value}):void 0},onClick:function(){return t.props.disabled?void 0:(e.setState({open:!1}),e.setValue(t.props.value))},className:l({"focused-option":e.state.focused===t.props.value,"selected-option":n===t.props.value})})}}(this))},componentWillMount:function(){var i;return i=e.Children.map(this._getFilteredChildren(),function(e){return{value:e.props.value,text:n.trim(s.getText(e).toLowerCase())}}),this.sortedOptions=t.sortBy(i,"text")},componentDidMount:function(){return this.globalMenuCloser=function(e){return function(t){var i;return e.state.open&&(i=n(t.target).closest(".select-input-input"),!i.length||i[0]!==e.refs.label.getDOMNode())?e.setState({open:!1,focused:null}):void 0}}(this),n(document).on("click",this.globalMenuCloser)},componentWillUnmount:function(){return n(document).off("click",this.globalMenuCloser)},componentDidUpdate:function(){var e,t;return this.state.open&&this.state.focused?(t=n(this.refs.dropdown.getDOMNode()),e=t.find("[data-value='"+this.state.focused+"']"),c(t,e)):void 0},selectedOption:function(){var t;return t=null,e.Children.forEach(this._getFilteredChildren(),function(e){return function(n){return t||(t=n),(null!=n?n.props.value:void 0)===e.getValue()?t=n:void 0}}(this)),t?a(t):null},toggle:function(){return this.setState({open:!this.state.open,focused:null})},getValue:function(){var e,t,n;return null!=(e=null!=(t=this.props.value)?t:null!=(n=this.props.valueLink)?n.value:void 0)?e:this.state.value},setValue:function(e){var t,n;return t=this.getValue(),this.props.valueLink?this.props.valueLink.requestChange(e):this.setState({value:e}),t!==e&&"function"==typeof(n=this.props).onChange?n.onChange(t,e):void 0}}),{input:_,option:d,example:e.createClass({render:function(){return _({name:"field-name"},d({value:"0one"},"one"),d({value:"0two"},"twotwo"),d({
value:"0three"},"threethreethree"),d({value:"1one"},"one"),d({value:"1two"},"twotwo"),d({value:"1three"},"threethreethree"),d({value:"2one"},"one"),d({value:"2two"},"twotwo"),d({value:"2three"},"threethreethree"),d({value:"3one"},"one"),d({value:"3two"},"twotwo"),d({value:"3three"},"threethreethree"))}})}}),define("modules/clean/react/sprite",["external/react","modules/clean/analytics","modules/clean/static_urls"],function(e,t,n){var i,o,r,s,a;return r=t.SpriteLogger,a=n.static_url,s=e.DOM,i=e.PropTypes,o=e.createClass({displayName:"Sprite",propTypes:{group:i.string.isRequired,name:i.string.isRequired,className:i.string,onClick:i.func,"data-src":i.string},render:function(){var e,t,n;return t=this.props.group,n=this.props.name,e=["sprite","sprite_"+t,"s_"+t+"_"+n],null!=this.props.className&&e.push(this.props.className),r.log(t,n),s.img({className:e.join(" "),src:a("/static/images/icons/icon_spacer-vflN3BYt2.gif"),"data-src":this.props["data-src"],onClick:this.props.onClick})}})}),define("modules/clean/react/sprite_div",["external/react","modules/clean/static_urls"],function(e,t){var n,i;return i=t.static_url,n=e.DOM,e.createClass({render:function(){var e,t,o;return e=this.props.group,t=this.props.name,o=this.props.text,n.div({className:"sprite-div"},n.div({className:"sprite-frame small icon-left"},n.img({className:"sprite sprite_"+e+" s_"+e+"_"+t,src:i("/static/images/icons/icon_spacer-vflN3BYt2.gif")})),n.div({className:"sprite-text"},o))}})}),define("modules/clean/react/tooltip",["external/react","external/underscore","jquery"],function(e,t,n){var i,o,r,s,a,l,u,c,_,d;return u={TOP:0,BOTTOM:1,LEFT:2,RIGHT:3},c=e.DOM,r="tooltip-holder",i=7,s=1e4,o="data-event-id",d=function(){var e,t;return e=r,t=n("#"+e),t.length||(t=n("<div />").attr({id:e,style:"z-index: "+s}).prependTo("body")),t[0]},l=e.createClass({displayName:"TooltipBubble",propTypes:{position:e.PropTypes.oneOf(function(){var e;e=[];for(_ in u)e.push(u[_]);return e}()),tooltip_target_ref:e.PropTypes.object,contents:e.PropTypes.oneOfType([e.PropTypes.element,e.PropTypes.string]),className:e.PropTypes.string,mouse_move_cb:e.PropTypes.func,mouse_out_cb:e.PropTypes.func},_getDimensionsOfElement:function(e){var t,n,i;return n=e.offset(),i=e.outerWidth(),t=e.outerHeight(),{left_x:n.left,right_x:n.left+i,top_y:n.top,bottom_y:n.top+t,width:i,height:t}},render:function(){var e,t,o,r,s;return t=this._getDimensionsOfElement(n(this.props.tooltip_target_ref.getDOMNode())),o=n(window),s=n(window).scrollTop(),r=n(window).scrollLeft(),e=function(){switch(this.props.position){case u.TOP:return{bottom:o.height()-t.top_y+i+s};case u.BOTTOM:return{top:t.bottom_y+i-s};case u.LEFT:return{right:o.width()-t.left_x+i+r};case u.RIGHT:return{left:t.right_x+i-r}}}.call(this),c.div({className:"tooltip-bubble "+(this.props.className||""),ref:"tooltip",style:e,onMouseMove:this.props.mouse_move_cb?this.props.mouse_move_cb:void 0,onMouseLeave:this.props.mouse_out_cb?this.props.mouse_out_cb:void 0},c.div({className:"tooltip-inner"},this.props.contents))},componentDidMount:function(){return this._centerAndShow()},componentDidUpdate:function(){return this._centerAndShow()},_centerAndShow:function(){var e,t,i,o,r,s,a,l,c;return e=n(this.refs.tooltip.getDOMNode()),r=this._getDimensionsOfElement(n(this.props.tooltip_target_ref.getDOMNode())),s=this._getDimensionsOfElement(e),o=n(window).scrollTop(),i=n(window).scrollLeft(),(l=this.props.position)===u.TOP||l===u.BOTTOM?(t=r.left_x+r.width/2-s.width/2-i,e.css("left",""+t+"px")):((c=this.props.position)===u.LEFT||c===u.RIGHT)&&(a=r.top_y+r.height/2-s.height/2-o,e.css("top",""+a+"px")),e.show()}}),a=e.createClass({displayName:"Tooltip",propTypes:{position:e.PropTypes.oneOf(function(){var e;e=[];for(_ in u)e.push(u[_]);return e}()),tooltip_contents:e.PropTypes.element,tooltip_classname:e.PropTypes.string,hide_delay:e.PropTypes.number,interaction_enabled:e.PropTypes.bool},render:function(){return c.div({className:"tooltip-target",onMouseMove:function(e){return function(t){return e._show(t)}}(this),onMouseLeave:this._on_mouse_leave(),id:this.state.tooltip_id,ref:"tooltipTarget"},this.props.children)},componentDidMount:function(){return n(document).bind("scroll."+this.state.event_id,function(e){return function(t){return e._hide(t)}}(this))},componentDidUpdate:function(){return this.state.visible?this._render_tooltip():void 0},componentWillUnmount:function(){var t;return n(document).unbind("scroll."+this.state.event_id),t=d(),e.unmountComponentAtNode(t)},_on_mouse_leave:function(){return function(e){return function(t){return e.props.hide_delay>0?e._scheduleHide(e.props.hide_delay):e._hide(t)}}(this)},_render_tooltip:function(){var t,i;return i=d(),n("#"+r).css("position","fixed"),n("#"+r).css("left","0"),n("#"+r).css("right","0"),this.props.hide_delay>0&&n("#"+r).attr(o,this.state.event_id),this.props.position===u.TOP?(n("#"+r).css("top","auto"),n("#"+r).css("bottom","0")):(n("#"+r).css("top","0"),n("#"+r).css("bottom","auto")),t=l({position:this.props.position,contents:this.props.tooltip_contents,tooltip_target_ref:this.refs.tooltipTarget,className:this.props.tooltip_classname,mouse_move_cb:this.props.interaction_enabled?this._clear_timeout:void 0,mouse_out_cb:this.props.interaction_enabled?this._on_mouse_leave():void 0}),e.unmountComponentAtNode(i),e.render(t,i)},_show:function(){return!this.state.visible||this._last_timeout?(this._render_tooltip(),this.setState({visible:!0}),this._clear_timeout()):void 0},_hide:function(){var t,i;if(this.state.visible)return i=d(),this._last_timeout?(t=n(i).attr(o),t===this.state.event_id&&(e.unmountComponentAtNode(i),null!=this._clear_timeout())):e.unmountComponentAtNode(i),this.setState({visible:!1})},_scheduleHide:function(e){return this.state.visible?this._last_timeout=setTimeout(this._hide,e):void 0},_clear_timeout:function(){return this._last_timeout?(clearTimeout(this._last_timeout),this._last_timeout=null):void 0},getInitialState:function(){return{visible:!1,event_id:t.uniqueId()}},getDefaultProps:function(){return{interaction_enabled:!1,hide_delay:0}}}),{Tooltip:a,TooltipPosition:u}}),define("modules/clean/react/util",["external/react","external/underscore"],function(e){var t,n;return t=function(n){var i;return"string"==typeof n?n:"string"==typeof n.props?n.props:n.props.text?n.props.text:(i=[],e.Children.forEach(n.props.children,function(e){return i.push(t(e))}),i.join(""))},n=function(t,i,o){var r,s;return i(t)?o(t):(r=!1,s=[],e.Children.forEach(t.props.children,function(){return function(e){var t;return t=n(e,i,o),s.push(t),t!==e?r=!0:void 0}}(this)),r?e.addons.cloneWithProps(t,{children:s}):t)},{getText:t,replaceSubtree:n}}),define("modules/clean/referrer_cleansing_redirect",["external/sjcl","modules/core/browser","modules/core/cookies","modules/core/uri"],function(e,t,n,i){var o,r,s,a;return a=function(t){var i,o,r,s;return i=e.codec.utf8String.toBits(n.read(Constants.JS_CSRF_COOKIE)),s=e.codec.utf8String.toBits(t),o=new e.misc.hmac(i),r=o.encrypt(t),e.codec.base64.fromBits(r)},r=function(e){var t,n;return t=i.parse(e).scheme,t&&"http"!==t&&"https"!==t?"#":(n=new i({path:"/referrer_cleansing_redirect"}),n.setQuery({url:e,hmac:a(e)}),n)},s=function(e){return t.redirect(r(e))},o={get_redirect_uri:r,redirect:s}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/register_form",["jquery","external/underscore","modules/clean/ajax","modules/clean/captcha","modules/clean/components/ajax_form","modules/clean/cyberfend","modules/clean/em_string","modules/clean/mailcheck","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/core/browser","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p){var h,f,m;return h=u.ProfileServicesLinkingHandler,m=_._,f=function(){function n(t,r,u,_,f){var g,v,y,b,w;this.$register_form_container=t,this.can_redirect=u,this.show_form=_,this.client_side_validation=f,this._animate_form=__bind(this._animate_form,this),this._on_register_success=__bind(this._on_register_success,this),this.$register_form=this.$register_form_container.find(".register-form"),this.register_controller=new o(this.$register_form,this._cyberfend_submit,{client_side_validation:this.client_side_validation}),this.cont=this.$register_form.find("input[name='cont']").val(),this.$register_form.find(".login-button, .auth-google").prop("disabled",!1),this.$captcha_component=new i(this.$register_form,"#react-signup-recaptcha-challenge-div","#react-login-recaptcha-challenge-div","/ajax_needs_signup_captcha","email",r),g=this.$register_form.find("label[for='tos_agree']"),y=parseInt(g.css("font-size")),w=200,new s(g.text()).length*y>w&&this.$register_form.find(".checkbox").removeClass("checkbox-inline"),this.$register_form.on(o.SUCCESS_EVENT,this._on_register_success),this.$register_form.on(o.ERROR_EVENT,this.$captcha_component.captcha_display_handler),this.show_form?(v=this.$register_form.find("input[type='hidden'][name='is_third_party_auth']").val(),v&&(b=function(t,n){return!e(n).val()},this.$register_form_container.find("input").filter(":visible").filter(b).first().focus()),this.$register_form.is(":visible")&&this.$captcha_component.captcha_display_handler()):this.$register_form.find(".login-button").on("click",function(e){return function(t){return e.$register_form_container.hasClass("form_shown")?void 0:(t.preventDefault(),e._animate_form())}}(this)),this.$register_form.find(".auth-google").click(function(t){return function(){var i,o;return i=function(i){var o;return i.success?(o={fname:i.profile.given_name,lname:i.profile.family_name,email:i.profile.email,picture_url:i.profile.picture_url,email_sig:i.email_sig,refresh_token:i.refresh_token,extra_data:i.extra_data,signup_tag:t.$register_form.find("input[type='hidden'][name='signup_tag']").val(),cont:t.$register_form.find("input[type='hidden'][name='cont']").val(),k:t.$register_form.find("input[type='hidden'][name='k']").val(),eh:t.$register_form.find("input[type='hidden'][name='eh']").val()},t.$register_form.trigger(n.NEW_ACCOUNT_FROM_3RD_PARTY,o),t.can_redirect?c.redirect(p({path:"/third_party_signup",query:o})):void 0):"user_exists"===i.err_msg?(d.error(m("This email address is already taken. Please sign in.")),i=e.Event(n.USER_EXISTS,{focus:"input[name=login_password]",prefill:{".login-email":i.profile.email,"input[type='hidden'][name=refresh_token]":i.refresh_token,"input[type='hidden'][name=email_sig]":i.email_sig}}),e(t.$register_form).trigger(i)):d.error(m("Sorry, we couldnât link to Google. Please refresh the page to try again."))},o=new h,o.auth_service_create_user_if_needed(l.GOOGLE,i,"register_form")}}(this)),"small"===r?(this.$register_form.find(".bubble-dropdown-container .bubble-dropdown").css({visibility:"hidden"}),this.$register_form.find(".password-input-meter").css({cursor:"default"})):new a(this.$register_form.find(".input-email"),this.$register_form.find(".email-suggestion"),{livecheck:!1})}return n.REGISTER_SUCCESS="db:register:success",n.NEW_ACCOUNT_FROM_3RD_PARTY="db:register:new_account_from_3rd_party",n.USER_EXISTS="db:register:user_exists",n.prototype._cyberfend_submit=function(){return r.submit(".register-form","signup_sd")},n.prototype._on_register_success=function(e,t){if(this.$register_form.trigger(n.REGISTER_SUCCESS,t),this.can_redirect){if(this.cont)return c.redirect(this.cont);if(t.redirect_url)return c.redirect(t.redirect_url)}},n.prototype._animate_form=function(){return this.$register_form_container.hasClass("form_shown")?void 0:e.when(this.$register_form_container.animate({height:this.$register_form.height()},{easing:"easeInOutCubic",duration:500})).done(function(e){return function(){return e.$register_form_container.addClass("form_shown"),e.$register_form_container.filter(":input").filter(":visible").first().focus(),e.$captcha_component.captcha_display_handler()}}(this))},n.prototype.fill=function(e){return t.each(e,function(e){return function(t,n){return e.$register_form.find("[name="+n+"]").val(t)}}(this))},n}()}),define("modules/clean/search/search_helpers",["jquery"],function(e){return{highlightMatch:function(t,n){var i,o,r,s,a,l,u,c;for(r=0,a=0,o=e("<span />");r<t.length;)u=n[a],a>=n.length?(l=!1,s=r+t.length):u.pos>r?(l=!1,s=u.pos):(l=!0,s=u.pos+u.len),c=t.substring(r,s),i=e("<span/>").text(c),i.addClass(""),l&&i.addClass("highlighted"),o.append(i),r=s,l&&a++;return o}}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/sharing/member_avatars",["modules/clean/avatar/components","modules/clean/avatar/list","modules/clean/components/title_bubble","modules/clean/viewer","modules/core/i18n"],function(e,t,n,i,o){var r,s,a,l,u,c,_;return s=e.InitialsAvatar,a=e.InitialsAvatarWithColorDerivedFromName,r=e.AvatarWithDefault,u=e.ViewerAvatar,_=o._,c=o.ungettext,l={getInitialState:function(){return{paired_users_in_sf:!1}},componentWillMount:function(){var e;return e=this.arePairedUsersInSf(this.props.joinedMembers),this.setState({paired_users_in_sf:e,paired_users_in_sf:e})},componentWillReceiveProps:function(e){var t;return t=this.arePairedUsersInSf(e.joinedMembers),this.setState({paired_users_in_sf:t,paired_users_in_sf:t})},_wrap_with_avatar_type_and_data:function(e,t,n){return function(){return e(t,n)}},arePairedUsersInSf:function(e){var t,n,o,r,s,a,l;return e?(s=i.get_viewer(),s.is_paired&&(r=s.get_user_ids(t=!0),n=function(){var t,n,i;for(i=[],t=0,n=e.length;n>t;t++)o=e[t],i.push(o.user_id);return i}(),a=r[0],__indexOf.call(n,a)>=0&&(l=r[1],__indexOf.call(n,l)>=0))?!0:!1):!1},findOwnerAndMeInJoinedMembers:function(e){var t,n,i,o,r,s;for(o=null,n=null,t=r=0,s=e.length;s>r&&(i=e[t],"owner"===i.access_type&&(o=i),i.user_id===this.props.user.id&&(n=i),null==o||null==n);t=++r);return[o,n]},addGroupsMembersInvitations:function(e,t,n,i,o){var r,s,a,l,u,c,_,d,p,h,f;for(null==o&&(o=[]),l=0,_=t.length;_>l;l++)r=t[l],e.push(this.renderGroup(r));for(u=0,d=n.length;d>u;u++)a=n[u],h=a.user_id,__indexOf.call(o,h)<0&&e.push(this.renderJoinedMember(a));for(f=[],c=0,p=i.length;p>c;c++)s=i[c],f.push(e.push(this.renderInvitedPerson(s)));return f},renderAvatarList:function(e){return new t({avatars:e,avatarDimension:this.props.avatarDimension,maxVisible:this.props.maxVisibleAvatars,undisplayableCount:this.props.numUndisplayableUsersAndInvites||0,onOverflowCountClick:this.props.onOverflowCountClick,animation:this.props.animation})},renderJoinedMember:function(e){var t,o,s,l,c,_,d,p,h,f,m,g,v;return m=i.get_viewer(),v=e.user_id,d=__indexOf.call(m.get_user_ids(o=!0),v)>=0,c=null,d&&this.state.paired_users_in_sf?(_=e.user_id,f=m.get_user_by_role(Constants.ROLE_PERSONAL,!0),g=m.get_user_by_role(Constants.ROLE_WORK,!0),_===f.id?c="Personal":_===g.id&&null!=m.team_name&&(c=m.team_name)):c=e.display_name,t=this.individualAccessTypeString(c,e.access_type,d,this.state.paired_users_in_sf),p=this._wrap_with_avatar_type_and_data(this.props.onAvatarClick,"member",e),h=null!=e.relationship_view_url?"avatar-component--pointer":void 0,l={dimension:this.props.avatarDimension,onPhotoClick:p,photoUrl:e.photo_url,optionalClass:h,defaultAvatar:new a({dimension:this.props.avatarDimension,name:e.display_name,initials:e.initials,shape:"CIRCLE",optionalClass:h,onClick:p})},s=d?new u(l):new r(l),new n({key:"user:"+e.user_id+":"+e.photo_url,text:t,direction:this.props.titleButtonDirection},s)},renderGroup:function(e){var t;return t=this._wrap_with_avatar_type_and_data(this.props.onAvatarClick,"group",e),new n({key:"group:"+e.gid+":"+e.name,text:this.groupAccessTypeString(e.name,e.access_type,e.num_users),direction:this.props.titleButtonDirection},new a({dimension:this.props.avatarDimension,name:e.name,shape:"SQUARE",initials:this.getInitials(e.name),onClick:t}))},renderInvitedPerson:function(e){var t,i;return i=this._wrap_with_avatar_type_and_data(this.props.onAvatarClick,"invited",e),t=this.individualAccessTypeString(e.email_or_fbname,"pending",!1),new n({key:"invitation:"+e.invitation_id,text:t,direction:this.props.titleButtonDirection},new s({dimension:this.props.avatarDimension,color:"#aaa",initials:this.getInitials(e.email_or_fbname),shape:"CIRCLE",onClick:i}))},getInitials:function(e){var t,n,i;return null!=e&&e.length>0?(i=e.split(" "),t=function(){var e,t,o;for(o=[],e=0,t=i.length;t>e;e++)n=i[e],o.push(n.charAt(0).toUpperCase());return o}(),t.length>2&&(t=t.splice(0,2)),t.join("")):""},groupAccessTypeString:function(e,t,n){var i;return i="editor"===t?c("%(num_users)s person in %(group_name)s can edit","%(num_users)s people in %(group_name)s can edit",n):c("%(num_users)s person in %(group_name)s can view","%(num_users)s people in %(group_name)s can view",n),i.format({group_name:e,num_users:n})},individualAccessTypeString:function(e,t,n,i){var o,r,s,a;return null==i&&(i=!1),o={viewer:_("You can view"),editor:_("You can edit"),owner:_("Youâre the owner"),team:_("Youâre a member of this team folder"),"default":_("You")},a={viewer:_("%(name)s can view"),editor:_("%(name)s can edit"),owner:_("%(name)s is the owner"),pending:_("%(name)s hasnât joined"),team:_("%(name)s is a member of this team folder"),"default":_("%(name)s")},r={viewer:_("You (%(name)s) can view"),editor:_("You (%(name)s) can edit"),owner:_("You (%(name)s) are the owner")},s=n?i&&null!=e?r:o:a,s[t].format({name:e})}}}),define("modules/clean/sharing/members_list/members_list_modal",["jquery","external/react","modules/clean/ajax","modules/clean/avatar/components","modules/clean/avatar/size","modules/clean/em_string","modules/clean/filepath","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/sharing/members_list/members_list_row","modules/clean/sharing/inband_link_settings_modal","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h){var f,m,g,v,y,b,w,C,S;return y=i.SharedLinkAvatar,f=o.AVATAR_DIMENSION_BY_SIZE,v=l.Modal,S=d._,b=t.createElement,w=t.addons.classSet,C=t.DOM,m=t.createFactory(y),g=t.createClass({propTypes:{user:t.PropTypes.object.isRequired,fqPath:t.PropTypes.string.isRequired,isSharedFolder:t.PropTypes.bool.isRequired,nsId:t.PropTypes.number,showUnshareFolderModal:t.PropTypes.func,showKickUserModal:t.PropTypes.func,showKickGroupModal:t.PropTypes.func,showUninviteModal:t.PropTypes.func,showLeaveFolderModal:t.PropTypes.func,doneCallback:t.PropTypes.func.isRequired,addPeopleCallback:t.PropTypes.func.isRequired},getInitialState:function(){return{hasLoaded:!1}},componentDidMount:function(){var e;return e=this.props.isSharedFolder?"/members_list":"/sm/members_list",n.WebRequest({subject_user:this.props.user,url:e,data:{fq_path:this.props.fqPath},success:function(e){return function(t){var n;if(e.isMounted())return n=JSON.parse(t),e.setState({hasLoaded:!0,amOwner:n.am_owner,hasOutOfBandLinks:n.has_out_of_band_links,isOutOfBandLinkEditable:n.is_out_of_band_link_editable,members:n.members,groups:n.groups,sharedContentMembers:n.shared_content_members,invitations:n.invitations,teamName:n.team_name,canOnlyInviteTeam:n.can_only_invite_team})}}(this)})},render:function(){return b(v,{className:"share_show_modal",autoClose:!1,title:this._renderTitle(),ref:"modal",showX:!1,buttonComponent:this._renderButtons()},this.state.hasLoaded?this._renderMemberSections():C.div({},this._renderLoadingHeader(),this._renderLoadingSpinner()))},_renderTitle:function(){var e;return e=S("Folder management for â%(folder_name)sâ"),e=e.format({folder_name:r.em_snippet(s.filename(this.props.fqPath),13)})},_renderTeamFolderSettings:function(){return C.div({className:"folder-settings"},this.state.canOnlyInviteTeam?C.span({className:"share-team-only"},S("This folder can only be shared with members of %(team_name)s.").format({team_name:this.state.teamName})):C.span({className:"share-anyone"},S("This folder can be shared with anyone.")))},_renderMemberCount:function(){var e,t;return t=this.state.sharedContentMembers.length+(this.state.members?this.state.members.length:0),e=this.state.groups?this.state.groups.length:0,C.h5({},C.span({},e?1===t&&1===e?S("%(num_members)s member and %(num_groups)s group").format({num_members:t,num_groups:e}):1===t&&e>1?S("%(num_members)s member and %(num_groups)s groups").format({num_members:t,num_groups:e}):t>1&&1===e?S("%(num_members)s members and %(num_groups)s group").format({num_members:t,num_groups:e}):t>1&&e>1?S("%(num_members)s members and %(num_groups)s groups").format({num_members:t,num_groups:e}):void 0:1===t?S("%(num)s member").format({num:t}):S("%(num)s members").format({num:t})))},_renderHeader:function(){return C.table({className:"member-info"},C.tr({},C.td({},this.state.amOwner&&this.props.user.is_team?this._renderTeamFolderSettings():this._renderMemberCount())))},_renderLoadingHeader:function(){return C.div({className:"member-info header-loading"})},_renderButtons:function(){var e,t,n;return C.div({className:"action-panel"},C.div({className:"clearfix folder-management-buttons"},this.state.hasLoaded?(n=this.props.isSharedFolder&&this.state.amOwner,e=this.state.sharedContentMembers.length>0||this.state.hasOutOfBandLinks,t=!this.props.isSharedFolder&&e,C.div({},n||t?b(a.button,{importance:"tertiary",onClick:this._unshareButtonClicked},S("Remove all access")):void 0,b(a.button,{importance:"tertiary",onClick:this._addPeopleButtonClicked},S("Add people")))):void 0,b(a.button,{importance:"primary",onClick:this._onDone},S("Done"))))},_addPeopleButtonClicked:function(){return this.refs.modal.close(),this.props.addPeopleCallback()},_onDone:function(){return this.refs.modal.close(),this.props.doneCallback()},_showLeaveFolderModal:function(){return this.refs.modal.close(),this.props.showLeaveFolderModal(this.props.user,this.props.fqPath,this.props.nsId)},_showKickUserModal:function(e,t){return this.refs.modal.close(),this.props.showKickUserModal(this.props.user,this.props.fqPath,this.props.nsId,e,t)},_showUninviteModal:function(e,t){return this.refs.modal.close(),this.props.showUninviteModal(this.props.user,this.props.fqPath,this.props.nsId,e,t)},_showKickGroupModal:function(e,t){return this.refs.modal.close(),this.props.showKickGroupModal(this.props.user,this.props.fqPath,this.props.nsId,e,t)},_unshareButtonClicked:function(){return this.props.isSharedFolder?(v.close(),this.props.showUnshareFolderModal(this.props.user,this.props.fqPath,this.props.nsId)):n.WebRequest({url:h({path:"/sm/unshare_content"+s.normalize(this.props.fqPath)}),subject_user:this.props.user.id,type:"POST",success:function(t){return function(){return e(document).trigger("db:browse:update"),p.success(S("Content unshared")),t._onDone()}}(this),error:function(){return p.error(S("An error occurred when unsharing content"))}})},_removeOOBLinkButtonClicked:function(){return n.WebRequest({url:h({path:"/sm/disable_token_at_path"+s.normalize(this.props.fqPath)}),subject_user:this.props.user.id,type:"POST",success:function(t){return function(){return e(document).trigger("db:browse:update"),t.isMounted()?t.setState({hasOutOfBandLinks:!1}):void 0}}(this),error:function(){return p.error(S("An error occurred when removing links."))}})},_renderMembersListRow:function(e,t){return c({key:t,user:this.props.user,memberUid:e.member_uid,inviteId:e.invite_id,groupId:e.group_id,amOwner:this.state.amOwner,sharedContentMemberId:e.shared_content_member_id,icon:e.icon,emailOrFbname:e.email_or_fbname,name:e.name,hasJoined:e.has_joined,isMemberActive:e.is_member_active,accessType:e.access_type,showRemoveButton:e.show_remove_button,hideAccessTypeDropdown:e.hide_access_type_dropdown,canMakeEditor:e.can_make_editor,canMakeViewer:e.can_make_viewer,canMakeOwner:e.can_make_owner,showUpsell:e.show_upsell,upsellUrl:e.upsell_url,avatarPhotoUrl:e.avatar_photo_url,avatarInitials:e.avatar_initials,showKickUserModal:this._showKickUserModal,showKickGroupModal:this._showKickGroupModal,showUninviteModal:this._showUninviteModal,showLeaveFolderModal:this._showLeaveFolderModal})},_renderMembers:function(){var e,t,n,i,o;if(this.state.members){for(i=this.state.members,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(this._renderMembersListRow(e,e.member_uid));return o}},_renderInvitations:function(){var e,t,n,i,o;if(this.state.invitations){for(i=this.state.invitations,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(this._renderMembersListRow(e,e.invite_id));return o}},_renderGroups:function(){var e,t,n,i,o;if(this.state.groups){for(i=this.state.groups,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(this._renderMembersListRow(e,e.group_id));return o}},_renderSharedContentMembers:function(){var e,t,n,i,o;if(this.state.sharedContentMembers){for(i=this.state.sharedContentMembers,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(this._renderMembersListRow(e,e.shared_content_member_id));return o}},_renderCollabLink:function(){return this.state.hasOutOfBandLinks?C.div({className:"bs-row clearfix clear no-hover"},m({dimension:f.SMALL}),S(this.state.isOutOfBandLinkEditable?"Anyone with the link can edit":"Anyone with the link can view"),C.div({className:"bs-actions remove-button"},C.a({},u({onClick:this._removeOOBLinkButtonClicked,group:"web",name:"xclose"})))):void 0},_getMemberHeaderClassName:function(e){return(w=t.addons.classSet)({"member-info":!0,"follow-on":"oob-link"===e||"shared-link"===e&&this.props.isSharedFolder})},_getMemberListClassName:function(){var e;return(w=t.addons.classSet)({"member-container":!0,"react-rendered":!0,"dual-pane":this.props.isSharedFolder&&(null!=(e=this.state.sharedContentMembers)?e.length:void 0)>0})},_renderMemberSections:function(){var e;return C.div({},this.props.isSharedFolder?C.div({className:this._getMemberHeaderClassName("shared-folder")},S("People who can view and edit"),C.div({className:this._getMemberListClassName()},C.div({className:"clearfix"},this._renderGroups(),this._renderMembers(),this._renderInvitations()))):void 0,!this.props.isSharedFolder||(null!=(e=this.state.sharedContentMembers)?e.length:void 0)>0?C.div({className:this._getMemberHeaderClassName("shared-link")},C.span,S("People who can view")," â¢ ",this._renderSettingsLink(),C.div({className:this._getMemberListClassName()},C.div({className:"clearfix"},this._renderSharedContentMembers()))):void 0,this.state.hasOutOfBandLinks?C.div({className:this._getMemberHeaderClassName("oob-link")},S("Link to folder"),C.div({className:"clearfix"},this._renderCollabLink())):void 0)},_renderLoadingSpinner:function(){return C.div({className:"member-container spinner-div"},C.img({className:"member-loading-spinner",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))},_renderSettingsLink:function(){return b(a.link_button,{className:"settings-link",importance:"standard",onClick:function(e){return function(){return _.showInstance(b(_,{user:e.props.user,fqPath:e.props.fqPath,teamName:e.state.teamName}))}}(this)},S("Change settings"))}})}),define("modules/clean/sharing/members_list/members_list_row",["external/react","modules/clean/avatar/components","modules/clean/avatar/size","modules/clean/em_string","modules/clean/react/select","modules/clean/react/sprite","modules/core/i18n","modules/core/notify"],function(e,t,n,i,o,r,s,a){var l,u,c,_,d,p,h,f,m;return u=t.AvatarWithDefault,c=t.InitialsAvatarWithColorDerivedFromName,l=n.AVATAR_DIMENSION_BY_SIZE,m=s._,f=e.DOM,h=e.addons.classSet,d=o.input,p=o.option,_=e.createClass({propTypes:{key:e.PropTypes.any.isRequired,memberUid:e.PropTypes.number,inviteId:e.PropTypes.number,groupId:e.PropTypes.string,sharedContentMemberId:e.PropTypes.string,user:e.PropTypes.object.isRequired,amOwner:e.PropTypes.bool,avatarPhotoUrl:e.PropTypes.string,avatarInitials:e.PropTypes.string,icon:e.PropTypes.string.isRequired,emailOrFbname:e.PropTypes.string.isRequired,name:e.PropTypes.string.isRequired,hasJoined:e.PropTypes.bool.isRequired,isMemberActive:e.PropTypes.bool,accessType:e.PropTypes.string.isRequired,hideAccessTypeDropdown:e.PropTypes.bool.isRequired,canMakeEditor:e.PropTypes.bool.isRequired,canMakeViewer:e.PropTypes.bool.isRequired,canMakeOwner:e.PropTypes.bool.isRequired,showUpsell:e.PropTypes.bool.isRequired,upsellUrl:e.PropTypes.string,showRemoveButton:e.PropTypes.bool.isRequired,showKickUserModal:e.PropTypes.func,showKickGroupModal:e.PropTypes.func,showUninviteModal:e.PropTypes.func,showLeaveFolderModal:e.PropTypes.func},_renderAvatar:function(){return u({dimension:l.SMALL,photoUrl:this.props.avatarPhotoUrl,defaultAvatar:c({dimension:l.SMALL,shape:this.props.groupId?"SQUARE":"CIRCLE",initials:this.props.avatarInitials,name:this.props.name})})},_renderDisplayName:function(){var e,t,n,i;return n=!this.props.inviteId&&this.props.name?this.props.name:this.props.emailOrFbname,this.props.memberUid===this.props.user.id?t=" "+m("(me)",i="web",e="this row represents the viewer herself."):this.props.sharedContentMemberId?t=" "+m("(link member)",i="web",e="inband view-only link member"):this.props.hasJoined||(t=" "+m("(pending)",i="web",e="this row represents one pending invitation.")),f.div({},f.a({className:"sf-display-name"},n),t?f.em({},t):void 0)},_renderAccessTypeSettings:function(){return this.props.hideAccessTypeDropdown?f.div({className:"sf-can-edit-text"},this.props.accessType):f.div({className:"sf-can-edit sf-can-edit-text"},d({name:"access_type","disable-errors":!0,defaultValue:this.props.accessType},this.props.canMakeEditor?p({value:"can edit"},m("can edit")):void 0,p({value:"can view",disabled:!this.props.canMakeViewer},m("can view")),this.props.canMakeOwner?p({value:"make owner"},m("make owner")):void 0,this.props.showUpsell?p({value:"upsell"},m("Upgrade to enable viewer permission")):void 0))},_removeButtonClicked:function(){return this.props.inviteId?this.props.showUninviteModal(this.props.inviteId,this.props.emailOrFbname):this.props.memberUid?this.props.memberUid===this.props.user.id?this.props.amOwner?a.error(m("You canât leave this folder because youâre the owner. You must transfer ownership to another member before you can leave.")):this.props.showLeaveFolderModal():this.props.showKickUserModal(this.props.memberUid,this.props.name):this.props.groupId?this.props.showKickGroupModal(this.props.groupId,this.props.name):void 0},_renderRemoveButton:function(){return f.div({className:"bs-actions remove-button"},this.props.showRemoveButton?f.a({},r({group:"web",name:"xclose",onClick:this._removeButtonClicked})):void 0)},render:function(){return f.div({className:h({"bs-row clearfix clear no-hover":!0,"avatars-enabled":!0,unmounted:this.props.memberUid&&!this.props.isMemberActive,unjoined:!this.props.hasJoined})},f.div({className:"sf-name"},this._renderAvatar(),this._renderDisplayName()),this._renderAccessTypeSettings(),this._renderRemoveButton())}})}),define("modules/clean/sharing/namespace_conversion_alert_modal",["external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/dbmodal","modules/clean/react/modal","modules/core/i18n"],function(e,t,n,i,o,r){var s,a,l,u,c;return s=i.DBModalStack,a=o.Modal,c=r._,u=e.DOM,l=e.createClass({statics:{showInstance:function(e){return a.showInstance(e)}},propTypes:{user:e.PropTypes.object.isRequired,req_url:e.PropTypes.string.isRequired,req_data:e.PropTypes.object.isRequired,success_callback:e.PropTypes.func.isRequired},getInitialState:function(){return{converting_to_shared_folder:!1}},render:function(){return a({title:c("Convert to shared folder?"),acceptButtonText:c("Continue"),acceptButtonDisabled:this.state.converting_to_shared_folder,dismissButtonText:c("Cancel"),autoClose:!1,onAccept:this._onAccept,onDismiss:this.close,submitting:this.state.converting_to_shared_folder,ref:"modal"},u.div({},c("For other people to edit files in this folder, you have to convert it into a shared folder. Do you want to continue?")))},_onAccept:function(){return this.state.converting_to_shared_folder?void 0:(n.SimpleSharingLogger.log(this.props.user.id,24),t.FormWebRequest({subject_user:this.props.user.id,url:this.props.req_url,data:this.props.req_data,success:function(e){return function(t){return e.isMounted()?(e.setState({
converting_to_shared_folder:!1}),e.props.success_callback(t)):void 0}}(this),error:function(e){return function(){return e.isMounted()?e.setState({converting_to_shared_folder:!1}):void 0}}(this)}),this.setState({converting_to_shared_folder:!0}))},close:function(){return this.refs.modal.close()},componentDidMount:function(){return n.SimpleSharingLogger.log(this.props.user.id,23)}})}),define("modules/clean/sharing/non_namespace_manage_access_modal",["jquery","external/react","modules/clean/analytics","modules/clean/ajax","modules/clean/dbmodal","modules/clean/em_string","modules/clean/filepath","modules/clean/react/button","modules/clean/react/modal","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u,c,_){var d,p,h,f,m;return d=o.DBModalStack,p=l.Modal,m=u._,f=t.DOM,h=t.createClass({statics:{showInstance:function(e){return p.showInstance(e)}},propTypes:{user:t.PropTypes.object.isRequired,fq_path:t.PropTypes.string.isRequired,done_callback:t.PropTypes.func.isRequired},render:function(){var e;return e=r.em_snippet(s.filename(this.props.fq_path),16),p({title:m("Remove access to â%(filename)sâ?").format({filename:e}),autoClose:!1,showX:!1,buttonComponent:this._renderButtons(),ref:"modal"},f.div({},m("You previously shared this folder and gave people permission to view it. If you remove their access, only you will be able to see it.")))},_renderButtons:function(){return f.div({className:"db-modal-buttons"},f.button({className:"dbmodal-button button-primary",onClick:this._remove_link_button_clicked},m("Remove access")),f.button({className:"dbmodal-button button-tertiary",onClick:function(e){return function(){return e._onDone(!1)}}(this)},m("Cancel")))},_onDone:function(e){return this.refs.modal.close(),this.props.done_callback.bind(null,!e)()},_remove_link_button_clicked:function(){return i.WebRequest({url:_({path:"/sm/disable_token_at_path"+s.normalize(this.props.fq_path)}),subject_user:this.props.user.id,type:"POST",success:function(t){return function(){return e(document).trigger("db:browse:update"),c.success(m("Link removed")),n.SimpleSharingLogger.log(t.props.user.id,25),t._onDone(!0)}}(this),error:function(){return function(){return c.error(m("An error occurred when removing link"))}}(this)})}})}),define("modules/clean/sharing/share_inband",["jquery","external/underscore","modules/clean/ajax","modules/clean/analytics","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/contacts/tokenizer","modules/clean/contacts/types","modules/clean/em_string","modules/clean/filepath","modules/clean/form","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/select","modules/clean/sharing/members_list/members_list_modal","modules/clean/sharing/namespace_conversion_alert_modal","modules/clean/sharing/non_namespace_manage_access_modal","modules/clean/sharing/shared_folder_settings_modal","modules/clean/sharing/shared_link_for_sf","modules/clean/viewer","modules/core/exception","modules/core/i18n","modules/core/notify","external/react"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h,f,m,g,v,y,b,w,C,S){var E,T,k,x,I,A,P,N,O,R,L,M,D;return x=o.EmailVerification,k=s.ContactsTokenizer,T=s.ContactTokenValidator,E=s.ContactTokenState,I=d.Modal,O=b.assert,D=w._,M=w.ungettext,A={ACCESS_NO_ACCESS:0,ACCESS_READER:1,ACCESS_WRITER:2,ACCESS_OWNER:3},R=S.DOM,P=function(){function t(){}return t.createAndShowModal=function(t,o,s,_,d,p,g,v,y,b,w,S,E,T){var k,P,R,L,U;if(x.get_for_user(t).verified_or_show(r.SHARE_FOLDER))return L=l.em_snippet(u.filename(o),16),U=D("Share â%(filename)sâ with others").format({filename:L}),P=D(y?"Who do you want to share this folder with?":"Who do you want to share this file with?"),k=function(e){var n,r,a,l,u;return l=e._getSerializedData(),n=e.state.access_type,a=e.restore_inband_modal_with_can_manage_access,r=e.get_message(),u=e.state.show_message_field,T||e.close(),i.SimpleSharingLogger.log(t.id,19,"viewed"),T?I.showInstance(h({user:t,fqPath:o,isSharedFolder:w,nsId:b,showUnshareFolderModal:_,showKickUserModal:d,showKickGroupModal:p,showUninviteModal:g,showLeaveFolderModal:v,doneCallback:a.bind(null,l,n,r,u,!0),addPeopleCallback:a.bind(null,l,n,r,u,!0)})):w?s(t,o,a.bind(null,l,n,r,u,!0)):m.showInstance(m({user:t,fq_path:o,done_callback:a.bind(null,l,n,r,u)}))},R=function(i,r,s,l){var u,_,d,p,h,m,g;if(d=function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)u=i[e],u.type===a.EMAIL&&n.push(u.email);return n}(),p=function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)u=i[e],u.type===a.FB&&n.push(u.fb_id);return n}(),h=function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)u=i[e],u.type===a.NEW_STYLE_GROUP&&n.push(u.group_id);return n}(),m=d.length+p.length+h.length,g=function(t,n,i){var o,r,s,a,l,u;return l=c.parse_response(t),s=l[0],r=l[1],s?(n&&e(document).trigger("db:sf_new"),i?C.success(r):(a=M("Shared â%(filename)sâ!","Shared â%(filename)sâ with %(num_recipients)s people!",m),C.success(a.format({filename:L,num_recipients:m}))),e(document).trigger("db:sharing_api:request_succeeded",{request_url:"",ns_id:b}),I.close()):(u=c.parse_error(r),s=u[0],o=u[1],s?C.error(o):C.error())},"edit"===r)if(w)n.FormWebRequest({subject_user:t.id,url:"/share_ajax/invite_more",data:{ns_id:b,emails:d,fb_ids:p,new_style_group_ids:h,custom_message:s,access_type:A.ACCESS_WRITER,is_simple_sharing:!0},success:function(e){return g(e,!1,!0)}});else{if(!S)return y?O(!1,"Tried to share unshareable folder with edit access"):C.error(D("Not implemented yet!"));_={path:o,emails:d,fb_ids:p,new_style_group_ids:h,custom_message:s,access_type:A.ACCESS_WRITER,is_simple_sharing:!0,folder_settings:1,shared_link_policy:void 0,audience:void 0,inviter:l?void 0:"me"},(_.audience||_.inviter)&&(_.custom_folder_settings=1),f.showInstance(f({user:t,req_url:"/share_ajax/existing",req_data:_,success_callback:function(e){var t;return t=JSON.parse(e),null!=t.invite_message?g(t.invite_message,!0,!0):g(e,!0,!1)}}))}else n.FormWebRequest({subject_user:t.id,url:"/sm/share_inband",data:{fq_path:o,emails:d,fb_ids:p,new_style_group_ids:h,is_simple_sharing:!0,custom_message:s},success:function(e){return g(e,!1,!0)}})},I.showInstance(N({user:t,fq_path:o,is_dir:y,title:U,recipient_prompt:P,send_handler:R,manage_access_handler:k,initial_can_manage_access:T||w,initial_access_type:"view",allows_edit:w||S,target_ns_id:b,is_shared_folder:w,sf_perm_role:E,could_be_shared_folder:S,initial_allows_editor_manage_membership:!w,initial_message:"",initial_show_message_field:!1}))},t}(),L=function(e){var t;return(t=e.type)!==a.FB&&t!==a.USER_GROUP},N=S.createClass({displayName:"ShareInbandModal",propTypes:{title:S.PropTypes.string.isRequired,user:S.PropTypes.object.isRequired,fq_path:S.PropTypes.string.isRequired,is_dir:S.PropTypes.bool.isRequired,recipient_prompt:S.PropTypes.string.isRequired,initial_access_type:S.PropTypes.string.isRequired,allows_edit:S.PropTypes.bool.isRequired,send_handler:S.PropTypes.func.isRequired,manage_access_handler:S.PropTypes.func,initial_can_manage_access:S.PropTypes.bool.isRequired,target_ns_id:S.PropTypes.number,is_shared_folder:S.PropTypes.bool.isRequired,sf_perm_role:S.PropTypes.number.isRequired,could_be_shared_folder:S.PropTypes.bool.isRequired,tokenizer_input:S.PropTypes.shape,initial_allows_editor_manage_membership:S.PropTypes.bool,initial_message:S.PropTypes.string,initial_show_message_field:S.PropTypes.bool},getInitialState:function(){return{access_type:this.props.initial_access_type,tokens:[],can_manage_access:this.props.initial_can_manage_access,show_message_field:this.props.initial_show_message_field,allows_editor_manage_membership:this.props.initial_allows_editor_manage_membership}},componentDidMount:function(){return i.SimpleSharingLogger.log(this.props.user.id,14),this.props.is_shared_folder&&this._updateAllowingEditorManageMembership(),this.state.can_manage_access||this._updateManageAccess(),this.state.show_message_field?this.refs.message_field.getDOMNode().value=this.props.initial_message:void 0},shouldComponentUpdate:function(e,n){return!t.isEqual(e,this.props)||!t.isEqual(n,this.state)},render:function(){var e;return e=this._getCustomContactValidator(),I({autoClose:!1,title:this.props.title,ref:"modal",buttonComponent:this._renderButtons()},R.div({className:"share-inband-container"},R.div({className:"prompt-line"},this.props.recipient_prompt,this._renderSettingsLink()),R.div({className:"recipients-container o-flag o-flag--rev o-flag--top"},k({ref:"tokenizer",customClass:"recipients-tokenizer o-flag__flex",user:this.props.user,onContentsChange:this._setTokens,populatedInputData:this.props.tokenizer_input,customContactValidator:e,customContactFilter:L,showContactImport:!0}),p.input({ref:"access",className:"invite-access o-flag__fix",value:this.state.access_type,onChange:function(e){return function(t,n){return e.props.allows_edit||"edit"!==n||(C.error(D("Canât invite others to edit this folder.")),n="view"),e.setState({access_type:n})}}(this)},p.option({value:"view"},D("can view")),p.option({value:"edit",disabled:!this._can_edit()},D("can edit")))),this.state.show_message_field?R.div({className:"custom-message-container sick-input small"},R.textarea({ref:"message_field",className:"textinput act_as_block",placeholder:D("Message (optional)")})):void 0,this._renderManageAccessLink(),this._renderExternalTokenWarning(e)))},close:function(){return this.refs.modal.close()},get_message:function(){var e;return e=this.refs.message_field,e?e.getDOMNode().value:""},_getCustomContactValidator:function(){return T.basic},_renderButtons:function(){return R.div({className:"db-modal-buttons share-inband-buttons"},v({fq_path:this.props.fq_path,user:this.props.user,is_dir:this.props.is_dir,is_shared_folder:this.props.is_shared_folder,could_be_shared_folder:this.props.could_be_shared_folder,can_edit:this._can_edit()}),R.button({className:"dbmodal-button button-primary send-button",onClick:function(e){return function(){var t;return t=e._getRecipients(),0===t.length?void C.error(D("No one to share with! Please enter a valid recipient.")):e.props.send_handler(t,e.state.access_type,e.get_message(),e.state.allows_editor_manage_membership)}}(this)},D("Send")))},_setTokens:function(e){return this.setState({tokens:e}),this._validate_input(e)?this.setState({show_message_field:!0}):void 0},_validate_input:function(e){var t,n,i;for(n=0,i=e.length;i>n;n++)if(t=e[n],!t.invalid)return!0},_renderExternalTokenWarning:function(e){var t,n,i,o,r,s,a;if(!this.props.user.is_team)return!1;for(n=0,a=this.state.tokens,r=0,s=a.length;s>r;r++)t=a[r],t.invalid||e(t).state!==E.warn||(n+=1);return n>0?(i=y.get_viewer().team_name,o=D("Sharing with %(warned_tokens)s people outside of %(team_name)s").format({warned_tokens:n,team_name:i}),1===n&&(o=D("Sharing with 1 person outside of %(team_name)s").format({team_name:i})),R.span({className:"external-token-warning"},R.img({src:"/static/images/teams/sharefolder_warning-vflzbBoRL.png"}),o)):!1},_renderSettingsLink:function(){return this.props.could_be_shared_folder&&"edit"===this.state.access_type||this._can_see_settings_for_shared_folder()?_.link_button({className:"settings-link",importance:"standard",onClick:function(e){return function(){var t,n,i,o,r;return o=e._getSerializedData(),t=e.state.access_type,i=e.restore_inband_modal_with_allows_editor_manage_membership,n=e.get_message(),r=e.state.show_message_field,I.close(),g.showInstance(g({user:e.props.user,fq_path:e.props.fq_path,is_shared_folder:e.props.is_shared_folder,ns_id:e.props.target_ns_id,initial_allows_editor_manage_membership:e.state.allows_editor_manage_membership,done_callback:i.bind(null,o,t,n,r)}))}}(this)},D("Settings")):void 0},_updateManageAccess:function(){return n.WebRequest({url:"/sm/get_token",data:{path:this.props.fq_path},dataType:"json",subject_user:this.props.user.id,type:"POST",success:function(e){return function(t){return e.isMounted()?e.setState({can_manage_access:e.props.is_shared_folder||null!=t.tkey}):void 0}}(this)})},_updateAllowingEditorManageMembership:function(){return this.props.is_shared_folder?n.WebRequest({url:"/share_ajax/members_can_invite",data:{ns_id:this.props.target_ns_id},subject_user:this.props.user.id,dataType:"json",success:function(e){return function(t){return e.isMounted()?e.setState({allows_editor_manage_membership:t.allows_editor_manage_membership}):void 0}}(this)}):void 0},_can_see_settings_for_shared_folder:function(){return this.props.is_shared_folder&&this.props.sf_perm_role===A.ACCESS_OWNER},_can_edit:function(){return!this.props.is_shared_folder||this.props.sf_perm_role===A.ACCESS_OWNER||this.props.sf_perm_role===A.ACCESS_WRITER&&this.state.allows_editor_manage_membership},_renderManageAccessLink:function(){var e;return this.state.can_manage_access?(e=D("Manage Access"),R.span({className:"folder-members-link"},_.link_button({importance:"standard",onClick:function(e){return function(){return e.props.manage_access_handler(e)}}(this)},e))):void 0},_getSerializedData:function(){return this.refs.tokenizer.serializeInputData()},_getRecipients:function(){return this.refs.tokenizer.getContacts()},restore_inband_modal:function(e,t,n,i){return this.restore_inband_modal_with_settings(e,t,n,i,this.state.allows_editor_manage_membership,this.state.can_manage_access)},restore_inband_modal_with_allows_editor_manage_membership:function(e,t,n,i,o){return this.restore_inband_modal_with_settings(e,t,n,i,o,this.state.can_manage_access)},restore_inband_modal_with_can_manage_access:function(e,t,n,i,o){return this.restore_inband_modal_with_settings(e,t,n,i,this.state.allows_editor_manage_membership,o)},restore_inband_modal_with_settings:function(e,t,n,i,o,r){var s;return s=N({user:this.props.user,fq_path:this.props.fq_path,is_dir:this.props.is_dir,title:this.props.title,recipient_prompt:this.props.recipient_prompt,send_handler:this.props.send_handler,manage_access_handler:this.props.manage_access_handler,initial_can_manage_access:r,initial_access_type:t,allows_edit:this.props.is_shared_folder||this.props.could_be_shared_folder,target_ns_id:this.props.target_ns_id,is_shared_folder:this.props.is_shared_folder,sf_perm_role:this.props.sf_perm_role,could_be_shared_folder:this.props.could_be_shared_folder,tokenizer_input:e,initial_allows_editor_manage_membership:o,initial_message:n,initial_show_message_field:i}),I.showInstance(s)}}),P}),define("modules/clean/sharing/shared_folder_settings_modal",["external/react","modules/clean/ajax","modules/clean/em_string","modules/clean/filepath","modules/clean/form","modules/clean/react/modal","modules/core/i18n","modules/core/notify"],function(e,t,n,i,o,r,s,a){var l,u,c,_;return l=r.Modal,_=s._,c=e.DOM,u=e.createClass({statics:{showInstance:function(e){return l.showInstance(e)}},propTypes:{user:e.PropTypes.object.isRequired,fq_path:e.PropTypes.string.isRequired,is_shared_folder:e.PropTypes.bool.isRequired,ns_id:e.PropTypes.number,initial_allows_editor_manage_membership:e.PropTypes.bool.isRequired,done_callback:e.PropTypes.func.isRequired},getInitialState:function(){return{allows_manage_membership:this.props.initial_allows_editor_manage_membership}},render:function(){var e;return e=n.em_snippet(i.filename(this.props.fq_path),16),l({title:_("â%(filename)sâ settings").format({filename:e}),acceptButtonText:_("Done"),autoClose:!1,showX:!1,onAccept:this._onDone,ref:"modal"},c.div({},c.input({type:"checkbox",onChange:this._checkboxUpdated,checked:this.state.allows_manage_membership,id:"allows-manage-membership-setting"}),c.label({className:"simple-sharing-allows-manage-membership-label",htmlFor:"allows-manage-membership-setting"},_("Allow anyone who can edit to manage membership of this folder"))))},_onDone:function(){return this.refs.modal.close(),this.props.done_callback.bind(null,this.state.allows_manage_membership)()},_checkboxUpdated:function(e){var n;return this.props.is_shared_folder?(n=e.target.checked?1:0,t.WebRequest({subject_user:this.props.user.id,url:"/share_ajax/change_sf_perm",data:{ns_id:this.props.ns_id,new_permissions:n},success:function(e){return function(t){var i,r,s;if(s=o.parse_response(t),r=s[0],i=s[1],r){if(a.success(_(1===n?"Editors can now manage membership of this folder.":"Editors can no longer manage membership of this folder")),!e.isMounted())return;return e.setState({allows_manage_membership:1===n})}return a.error(i)}}(this)})):this.setState({allows_manage_membership:e.target.checked})}})}),define("modules/clean/sharing/shared_link_for_sf",["external/react","modules/clean/react/button","modules/clean/react/sprite_div","modules/clean/sharing/shared_link_modal","modules/core/i18n"],function(e,t,n,i,o){var r,s,a;return a=o._,s=e.DOM,r=e.createClass({statics:{showInstance:function(t,n){return e.render(t,n)}},propTypes:{fq_path:e.PropTypes.string.isRequired,user:e.PropTypes.object.isRequired,is_dir:e.PropTypes.bool.isRequired,is_shared_folder:e.PropTypes.bool.isRequired,could_be_shared_folder:e.PropTypes.bool.isRequired,can_edit:e.PropTypes.bool.isRequired},render:function(){return s.div({className:"get-link-button-spinner"},s.button({className:"get-link-button dbmodal-button button-tertiary",onClick:function(e){return function(){return i.showInstance(i({needsFetchingTokenInfo:!0,user:e.props.user,fqPath:e.props.fq_path,isDir:e.props.is_dir,canReaderSync:!1,isSharedFolder:e.props.is_shared_folder,couldBeSharedFolder:e.props.could_be_shared_folder,canEdit:e.props.can_edit,editableLinksM2Enabled:!1}))}}(this)},n({group:"web",name:"s_link",text:a("Get link")})))}})}),define("modules/clean/sharing/shared_link_modal",["jquery","external/flash_detect","external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/clipboard","modules/clean/dbmodal","modules/clean/em_string","modules/clean/filepath","modules/clean/form","modules/clean/react/modal","modules/clean/sharing/namespace_conversion_alert_modal","modules/clean/react/select","modules/clean/react/sprite_div","modules/clean/viewer","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h,f,m,g){var v,y,b,w,C,S,E,T,k;return v=s.DBModalStack,y=c.Modal,C=c.SimpleModal,k=f._,b={PUBLIC:1,TEAM_ONLY:2,PASSWORD:3},T=n.DOM,E=n.addons.classSet,S=FlashDetect.installed,w=n.createClass({statics:{showInstance:function(e){return v.pop(),y.showInstance(e)}},propTypes:{needsFetchingTokenInfo:n.PropTypes.bool.isRequired,user:n.PropTypes.object.isRequired,fqPath:n.PropTypes.string.isRequired,isDir:n.PropTypes.bool.isRequired,canReaderSync:n.PropTypes.bool.isRequired,isSharedFolder:n.PropTypes.bool.isRequired,couldBeSharedFolder:n.PropTypes.bool.isRequired,canEdit:n.PropTypes.bool.isRequired,initialLink:n.PropTypes.string,initialTkey:n.PropTypes.string,initialEditable:n.PropTypes.bool,initialVisibility:n.PropTypes.number,initialExpiryPosix:n.PropTypes.string,initialExpiryDays:n.PropTypes.string,initialExpiryText:n.PropTypes.string,editableLinksM2Enabled:n.PropTypes.bool,showSharedLinkSettingsModal:n.PropTypes.func,onGoBackButtonClicked:n.PropTypes.func},getInitialState:function(){return{hasFetchedTokenInfo:!this.props.needsFetchingTokenInfo,link:this.props.initialLink,tkey:this.props.initialTkey,editable:this.props.initialEditable,visibility:this.props.initialVisibility,expiryPosix:this.props.initialExpiryPosix,expiryDays:this.props.initialExpiryDays,expiryText:this.props.initialExpiryText}},componentDidMount:function(){return this.props.needsFetchingTokenInfo?i.WebRequest({url:g({path:"/sm/token_for_sf"+l.normalize(this.props.fqPath)}),subject_user:this.props.user.id,data:{ask_for_editable:this.props.editableLinksM2Enabled},type:"POST",dataType:"json",success:function(t){return function(n){return e(document).trigger("db:browse:update"),t.isMounted()?"ok"===n.status?(t.setState({hasFetchedTokenInfo:!0,link:n.link,tkey:n.tkey,editable:n.editable,visibility:n.visibility,expiryPosix:n.expiry_posix,expiryDays:n.expiry_days,expiryText:n.expiry_text}),t._setupCopyToClipboard(),t.refs.input.getDOMNode().select()):"error"===n.status?(m.error(n.msg),t.refs.modal.close()):void 0:void 0}}(this),error:function(e){return function(){return e.isMounted()?e.refs.modal.close():void 0}}(this)}):void this._setupCopyToClipboard()},render:function(){var e,t;return t=a.em_snippet(l.filename(this.props.fqPath),16),e=k(S?"Copy Link":"Done"),y({title:k("Share â%(filename)sâ with others").format({filename:t}),buttonComponent:this._renderButtons(e),ref:"modal"},this.state.hasFetchedTokenInfo?T.div({className:"simple-sharing-share-link-modal-content"},this.props.editableLinksM2Enabled?T.div({},this._renderTopLabelForM2()):T.div({className:"simple-sharing-access-label"},this._renderAccessLabel()),T.div({className:"simple-sharing-link-field o-flag o-flag--rev o-flag--top"},T.div({className:"text-input small o-flag__flex"},T.div({className:"text-input-wrapper"},T.input({readOnly:!0,type:"text",value:this.state.link,ref:"input",className:E({"text-input-input":!0,"editable-link-m2-input":this.props.editableLinksM2Enabled}),onClick:this._selectAllText}),this.props.editableLinksM2Enabled?T.a({href:"#",onClick:this._onRemoveLinkButtonClicked,className:"close-button"},p({group:"web",name:"xclose"})):void 0)),this.props.editableLinksM2Enabled?void 0:this._renderEditDropdown()),this.props.editableLinksM2Enabled?this._renderBottomLabelForM2():void 0):this._renderLoadingSpinner())},_renderButtons:function(e){return T.div({className:"db-modal-buttons simple-sharing-link-modal-buttons"},this.props.editableLinksM2Enabled&&this.props.onGoBackButtonClicked?T.button({className:"button-tertiary go-back-button",onClick:function(e){return function(){return e.refs.modal.close(),e.props.onGoBackButtonClicked(e.props.fqPath)}}(this)},k("Go back")):void 0,T.button({className:"dbmodal-button button-primary",onClick:function(e){return function(){return S?void 0:e.refs.modal.close()}}(this)},e))},_renderTopLabelForM2:function(){return T.h2({className:"simple-sharing-top-label"},k("Link to folder"))},_renderAccessLabel:function(){return T.label({className:"access-label"},this.state.editable?this._renderWhoCanAccessEditLabel(this.state.visibility):this._renderWhoCanAccessViewLabel(this.state.visibility))},_renderBottomLabelForM2:function(){return T.div({className:"simple-sharing-bottom-label"},this._renderAccessLabel(),this._renderExpiryInfo(),T.span({className:"change-settings",onClick:this._onClickChangeSettings},k("Change password / add expiration")),T.span({className:"access-label"},k(".")))},_renderExpiryInfo:function(){return this.state.expiryPosix?T.label({className:"expiry-info"},k("The link will expire in %(expiry_days)s days (%(expiry_text)s).").format({expiry_days:this.state.expiryDays,expiry_text:this.state.expiryText})):void 0},_setupCopyToClipboard:function(){var t,n;return t=e(".simple-sharing-link-field").parent().parent(),S?(n=function(e){return function(){return m.success(k("Link copied.")),o.SimpleSharingLogger.log(e.props.user.id,17),e.refs.modal.close()}}(this),r.clipboard_overlay(t.find(".simple-sharing-link-field .text-input-wrapper input").val(),t.find(".button-primary"),n,t.find(".simple-sharing-link-field"))):void 0},_renderLoadingSpinner:function(){return T.div({className:"member-container spinner-div"},T.img({className:"member-loading-spinner",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))},_renderEditDropdown:function(){return d.input({className:"oob-invite-access o-flag__fix","disable-errors":!0,value:this.state.editable?"edit":"view",onChange:function(e){return function(t,n){return e._permissionChanged(n)}}(this)},d.option({value:"view"},k("can view")),d.option({value:"edit",disabled:!this.props.canEdit},k("can edit")))},_renderWhoCanAccessViewLabel:function(e){return e===b.PUBLIC?k("Anyone with the link can view the folder."):e===b.TEAM_ONLY?k("%(team_name)s members with the link can view the folder.").format({team_name:h.get_viewer().team_name}):e===b.PASSWORD?k("Anyone with the password and the link can view the folder."):void 0},_renderWhoCanAccessEditLabel:function(e){return e===b.PUBLIC?k("Anyone with the link can join the folder and edit files."):e===b.TEAM_ONLY?k("%(team_name)s members with the link can join the folder and edit files.").format({team_name:h.get_viewer().team_name}):e===b.PASSWORD?k("Anyone with the password and the link can join the folder and edit files."):void 0},_onRemoveLinkButtonClicked:function(){var e,t,n;return o.SimpleSharingLogger.log(this.props.user.id,33),n=a.em_snippet(l.filename(this.props.fqPath),16),e=function(e){return function(){var t;return t=g({path:"/sm/disable/"+e.state.tkey}),i.WebRequest({url:t,subject_user:e.props.user.id,success:function(){return m.success(k("Removed link for â%(filename)sâ").format({filename:n})),o.SimpleSharingLogger.log(e.props.user.id,25),e.props.onGoBackButtonClicked(e.props.fqPath)},error:function(){return m.Error(k("Failed removing link"))}})}}(this),t=function(e){return function(){return e._restoreSharedLinkModal(e.props.isSharedFolder,e.state.editable)}}(this),C.show({title_text:k("Remove link to â%(filename)sâ").format({filename:n}),body_html:k("Are you sure you want to remove this link? People with this link will no longer be able to join the shared folder."),cancel_text:k("Cancel"),confirm_text:k("Remove link"),confirm_callback:e,cancel_completed_callback:t})},_selectAllText:function(t){return e(t.currentTarget)[0].select(),o.SimpleSharingLogger.log(this.props.user.id,18)},_changeSfAccess:function(e,t,n){return i.WebRequest({url:"/sm/change_sf_access",data:{link_url:this.state.link,editable:e,can_sync:this.props.canReaderSync},subject_user:this.props.user.id,type:"POST",success:t,error:n})},_updateSfAccess:function(e){return this._changeSfAccess(e,function(t){return function(){var n;return n=k(e?"Anyone with the link can edit":"Anyone with the link can view"),m.success(n),t.setState({editable:e})}}(this))},_onClickChangeSettings:function(){return this.refs.modal.close(),this.props.showSharedLinkSettingsModal(this.props.user.id,this.state.tkey,this._restoreSharedLinkModal.bind(this,this.props.isSharedFolder,this.state.editable,!0))},_restoreSharedLinkModal:function(e,t,n){var i,o,r,s;return r=e?!0:!1,i=!r,o=e&&t?!0:!1,s=w({needsFetchingTokenInfo:!!n,user:this.props.user,fqPath:this.props.fqPath,isDir:this.props.isDir,canReaderSync:!1,isSharedFolder:r,couldBeSharedFolder:i,canEdit:e||this.props.canEdit,initialLink:this.state.link,initialTkey:this.state.tkey,initialEditable:o,initialVisibility:this.state.visibility,initialExpiryPosix:this.state.expiryPosix,initialExpiryDays:this.state.expiryDays,initialExpiryText:this.state.expiryText,editableLinksM2Enabled:this.props.editableLinksM2Enabled,showSharedLinkSettingsModal:this.props.showSharedLinkSettingsModal,onGoBackButtonClicked:this.props.onGoBackButtonClicked}),y.close(),w.showInstance(s)},_permissionChanged:function(e){var t,n,i;if(t="edit"===e,this.state.editable||t!==!0){if(this.state.editable&&t===!1)return this._updateSfAccess(t)}else{if(this.props.couldBeSharedFolder)return i=function(e){return function(n){var i,o,r,s,a,l,c;return l=u.parse_response(String(n)),s=l[0],r=l[1],s?(a=function(){var t;return document.fire("db:sf_new"),e._restoreSharedLinkModal(!0,!0),t=JSON.parse(r),m.success(t.success_msg)},o=function(){return e._restoreSharedLinkModal(!0,!1)},e._changeSfAccess(t,a,o)):(e._restoreSharedLinkModal(!1,!1),c=u.parse_error(r),s=c[0],i=c[1],s?m.error(i):m.error())}}(this),n={path:this.props.fqPath,emails:[],fb_ids:[],new_style_group_ids:[],custom_message:"",access_type:2,is_simple_sharing:!0,folder_settings:1,shared_link_policy:void 0,audience:void 0,inviter:void 0},_.showInstance(_({user:this.props.user,req_url:"/share_ajax/existing_no_recipient",req_data:n,success_callback:i}));if(this.props.isSharedFolder)return this._updateSfAccess(t);if(!this.props.isDir)return this._updateSfAccess(t)}}})}),define("modules/clean/sprite",["jquery","modules/clean/analytics","modules/core/html"],function(e,t,n){var i,o;return o=t.SpriteLogger,i={SPACER:"/static/images/icons/icon_spacer-vflN3BYt2.gif",CLASS_PREFIX:"s_",_make_class:function(e,t){return o.log(e,t),this.CLASS_PREFIX+e+"_"+t},src:function(t,n,i){return this.clear(t),e(t).addClass(this._make_class(n,i))},replace:function(t,n,i,o){return e(t).removeClass(this._make_class(n,i)).addClass(this._make_class(n,o))},clear:function(t){var n;return n=t.className.split(" "),n=e.grep(n,function(e){return function(t){return t&&0!==t.indexOf(e.CLASS_PREFIX)}}(this)),t.className=n.join(" ")},make:function(t,n,i){var o;return i=this._prep_attrs(t,n,i),o=e("<img />",i),o[0]},html:function(e,t,i){var o,r;i=this._prep_attrs(e,t,i),o=["<img "];for(r in i)o.push(r,'="',n._raw_escape(i[r]),'" ');return o.push("/>"),new n(o.join(""))},_prep_attrs:function(e,t,n){var i;return null==n&&(n={}),n.src=n.src||this.SPACER,i=["sprite","sprite_"+e,this._make_class(e,t)],n["class"]&&i.push(n["class"]),n["class"]=i.join(" "),n},_get:function(e){return e.className},_set:function(e,t){return e.className=t,e.src=this.SPACER}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/sso_login_checks",["modules/clean/ajax"],function(e){var t;return t=function(){function t(e,t,n){this.$email_input=e,this.show_sso_fn=t,this.hide_sso_fn=n,this._check_sso_state=__bind(this._check_sso_state,this),this._check_sso_state(),this.$email_input.on("input keyup change",this._check_sso_state)}return t._sso_check_in_flight={},t._sso_check_cache={},t.prototype._check_sso_state=function(){var n,i,o;return o=this.$email_input.val(),i=o.trim(),i.match(/^[^@\s]+@[^@\s]+\.[A-Za-z]{2,}$/)?(n=i.toLowerCase(),n in t._sso_check_cache?this._handle_sso_state(t._sso_check_cache[n]):t._sso_check_in_flight[n]?void 0:(t._sso_check_in_flight[n]=!0,e.WebRequest({url:"/sso_state",data:{email:i},success:function(e){return function(i){return i=JSON.parse(i),delete t._sso_check_in_flight[n],t._sso_check_cache[n]=i.user_sso_state,e.$email_input.val()!==o?e._check_sso_state():e._handle_sso_state(i.user_sso_state)}}(this),error:function(e){return function(){return delete t._sso_check_in_flight[n],e.hide_sso_fn()}}(this)}))):this.hide_sso_fn()},t.prototype._handle_sso_state=function(e){return"required"===e?this.show_sso_fn(!1):"optional"===e?this.show_sso_fn(!0):this.hide_sso_fn()},t}()}),define("modules/clean/static_resource_loader",["jquery","modules/core/exception","modules/core/uri","modules/constants/env"],function($j,_arg,URI,EnvConstants){var assert,async_load_css,async_load_js,async_multiload,async_multiload_generic,bind;return assert=_arg.assert,bind=function(){var e,t,n;return e=Array.prototype.slice.call(arguments),t=e.shift(),n=e.shift(),function(){return t.apply(n,e.concat(Array.prototype.slice.call(arguments)))}},async_load_css=function(e,t){return $j.ajax({url:e,type:"get",success:function(e){return $j("head").append("<style>"+e+"</style>"),"function"==typeof t?t():void 0}})},async_load_js=function(url,callback_fn){var uri,_ref;return uri=URI.parse(url),assert(""===(_ref=uri.authority)||_ref===EnvConstants.WEBSERVER||_ref===EnvConstants.CAROUSEL_WEBSERVER||_ref===EnvConstants.WEB_STATIC_CDN_HOST||_ref===EnvConstants.WEB_STATIC_DROPBOX_HOST),$j.ajax({dataType:"script",cache:!0,url:url,success:function(response){return eval(response),"function"==typeof callback_fn?callback_fn():void 0}})},async_multiload_generic=function(e,t,n){var i,o,r,s,a,l,u,c;if(o={},!e)return void("function"==typeof n&&n());for(s=0,l=e.length;l>s;s++)r=e[s],o[r]=!1;for(i=function(e){var t,i,r;o[e]=!0,i=!0;for(t in o)if(r=o[t],!r){i=!1;break}return i&&"function"==typeof n?n():void 0},c=[],a=0,u=e.length;u>a;a++)r=e[a],c.push(t(r,bind(i,this,r)));return c},async_multiload=function(e,t,n){var i,o;return o={css:!e,js:!t},i=function(e){var t,i,r;o[e]=!0,i=!0;for(t in o)if(r=o[t],!r){i=!1;break}return i&&"function"==typeof n?n():void 0},async_multiload_generic(e,async_load_css,function(){return i("css")}),async_multiload_generic(t,async_load_js,function(){return i("js")})},{async_multiload:async_multiload}}),define("modules/clean/static_urls",["modules/clean/filepath","modules/constants/env","modules/core/exception","modules/core/uri"],function(e,t,n,i){
var o,r,s,a;return s=e.filename_without_extension,r=e.file_extension,o=n.assert,a=function(e){var n,a;return o(0===e.indexOf("/static/"),""+e+" is not a /static url"),t.IS_PROD||(n=s(e),a=r(e,!0),e=a?""+n+"-vflDEVHASH."+a:""+n+"-vflDEVHASH"),i({scheme:"https",authority:t.WEB_STATIC_CDN_HOST,path:e}).toString()},{static_url:a,UrlConstants:{MOXIE_SWF_URL:a("/static/swf/Moxie-vflz978zN.swf")}}}),define("modules/clean/sticker_util",[],function(){var e;return new(e=function(){function e(){}return e.prototype.getStickerImageUrl=function(e){return""+Constants.sticker_img_url+"/"+e},e.prototype.getStickerSetImageUrl=function(e){return""+Constants.sticker_set_img_url+"/"+e},e.prototype.getStickers=function(){var e,t,n,i,o,r,s,a,l,u,c;if(!this.stickers){for(this.stickers=Constants.sets,l=this.stickers,n=0,r=l.length;r>n;n++)e=l[n],e.stickers=[];for(u=Constants.stickers,i=0,s=u.length;s>i;i++)for(t=u[i],c=this.stickers,o=0,a=c.length;a>o;o++)if(e=c[o],t.set_id===e.id){e.stickers.push(t);break}}return this.stickers},e}())});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/storage",[],function(){var e,t,n;return e=function(){function e(){}return e.storage=void 0,e.get=function(e){return this.storage&&window.JSON?JSON.parse(this.storage.getItem(e)):void 0},e.set=function(e,t){var n;if(this.storage&&window.JSON)try{return this.storage.setItem(e,JSON.stringify(t))}catch(i){if(n=i,!(n instanceof DOMException&&22===n.code))throw n}},e}(),n=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.storage=function(){try{return window.sessionStorage}catch(e){}}(),t}(e),t=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.storage=function(){try{return window.localStorage}catch(e){}}(),t}(e),{SessionStorage:n,LocalStorage:t}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/clean/teams/team_folder_modal",["modules/core/browser","modules/clean/components/ajax_form","modules/clean/dbmodal"],function(e,t,n){var i,o;return i=n.DBModal,o=function(n){function i(){return this.on_confirm_button_click=__bind(this.on_confirm_button_click,this),this._$form=__bind(this._$form,this),i.__super__.constructor.apply(this,arguments)}return __extends(i,n),i.prototype._$form=function(){return this.$modal_window.find(".new_team_folder_form")},i.prototype.on_confirm_button_click=function(e){return e.preventDefault(),this._$form().submit()},i.prototype.on_show=function(){var n;return n=this._$form(),new t(n),n.on(t.SUCCESS_EVENT,function(t){return function(n,i){return t.options.open_created_folder?e.redirect(i.sf_info.href):e.reload()}}(this)),this.options.back_fn?this.$modal_window.find("a.back").on("click",function(e){return function(t){return e.options.back_fn(t,e)}}(this)):void 0},i}(i)}),define("modules/clean/teams/trial_buy_now",["jquery","modules/clean/ajax","modules/clean/react/modal","modules/core/browser","modules/core/i18n"],function(e,t,n,i,o){var r,s,a;return a=o._,s=o.ungettext,r={showModal:function(e){var t,i;return i=a("Buy Dropbox for Business now"),t=s("You have <strong>%(days)s</strong> day remaining in your Dropbox for Business trial. Buy now to ensure that your team continues to work efficiently!","You have <strong>%(days)s</strong> days remaining in your Dropbox for Business trial. Buy now to ensure that your team continues to work efficiently!",e).format({days:e}),n.SimpleModal.show({title_text:i,body_html:t,confirm_text:a("Buy now"),confirm_callback:r._confirm,cancel_callback:r._cancel})},_confirm:function(){return e.ajax({type:"POST",url:"/team/setup/trial_buy_now/dismiss",success:function(){return function(){return i.redirect("/team/renew")}}(this)})},_cancel:function(){return e.post("/team/setup/trial_buy_now/dismiss")}}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/tokenizer",["external/react","jquery","external/underscore","modules/clean/keycode","modules/clean/typeahead"],function(e,t,n,i,o){var r,s,a,l;return a=o.TypeaheadSelector,l=e.DOM,r=e.createClass({propTypes:{data:e.PropTypes.any,onRemove:e.PropTypes.func},render:function(){return this.transferPropsTo(l.a({className:"tokenizer-token",tabIndex:-1},String(this.props.data),this._makeCloseButton()))},_makeCloseButton:function(){return this.props.onRemove?l.span({className:"tokenizer-token-close",onClick:function(e){return function(){return e.props.onRemove(),!1}}(this),dangerouslySetInnerHTML:{__html:"&nbsp;"}}):""}}),s=e.createClass({displayName:"Tokenizer",propTypes:{customClass:e.PropTypes.string,dataSource:e.PropTypes.object.isRequired,initialInputText:e.PropTypes.string,logTokenChangeEvent:e.PropTypes.func,onContentsChange:e.PropTypes.func,onTokenAdd:e.PropTypes.func,onTokenRemove:e.PropTypes.func,placeholderText:e.PropTypes.string,populatedTokenData:e.PropTypes.array,renderToken:e.PropTypes.func.isRequired,renderInput:e.PropTypes.func.isRequired,renderSelector:e.PropTypes.func.isRequired,stringTokenizer:e.PropTypes.func.isRequired,tokenSpacing:e.PropTypes.number,tabIndex:e.PropTypes.number},getDefaultProps:function(){return{initialInputText:"",renderInput:function(){return l.input()},renderSelector:function(){return a()},renderToken:function(e){return r({data:e})},stringTokenizer:function(e,t){var n,i;return n=e.split(","),i=t?"":n.pop(),{tokens:n,value:i}},tokenSpacing:3}},getInitialState:function(){return this.tokenData=this.props.populatedTokenData||[],{queryResults:null,tokenData:this.tokenData,selectedTokenIndex:null,inputWidth:150}},componentDidMount:function(){return this._resizeTokenizerInput(),this.refs.input.getDOMNode().value=this.props.initialInputText,t(this.refs.tokenizer_input.getDOMNode()).on("keydown",this._proxyKeys),document.addEventListener("click",this._handleDocumentClick,!1)},componentWillUnmount:function(){return t(this.refs.tokenizer_input.getDOMNode()).off("keydown",this._proxyKeys),document.removeEventListener("click",this._handleDocumentClick,!1)},componentDidUpdate:function(){return this._resizeTokenizerInput()},render:function(){var t;return t={"react-tokenizer":!0},null!=this.props.customClass&&(t[this.props.customClass]=null!=this.props.customClass),l.div({onClick:this._handleMyClick,className:e.addons.classSet(t)},l.div({className:"tokenizer-input",ref:"tokenizer_input",style:{padding:this.props.tokenSpacing,paddingRight:0,maxHeight:this.props.tokenSpacing+3*(this.props.tokenSpacing+29)+14+2}},l.div({className:"token-container",style:{marginLeft:-this.props.tokenSpacing,marginBottom:-this.props.tokenSpacing}},l.div({className:"tokenizer-accessory",ref:"tokenizer_accessory"},this.props.children),this._renderTokens(),this._renderInput())),this._renderSelector())},serializeInputData:function(){return{tokens:this.tokenData,value:this.refs.input.getDOMNode().value}},tokenizeAll:function(){var e,t;return e=this.refs.input.getDOMNode(),t=this.props.stringTokenizer(e.value,!0).tokens,t.length>0&&this._addTokens(t,!1),e.value="",this.refs.selector.close()},addExternalTokens:function(e){this._addTokens(e,!1,null),this.refs.selector.close()},_addTokens:function(e,t,i){var o,r,s,a,l,u,c,_,d,p,h,f,m,g;for(null==t&&(t=!1),null==i&&(i=null),r=function(e){return("function"==typeof e.getKey?e.getKey():void 0)||String(e)},l=n.map(this.tokenData,r),s=e.filter(function(e){var t;return t=r(e),__indexOf.call(l,t)<0}),this.tokenData=this.tokenData.concat(s),this.setState({tokenData:this.tokenData}),d=0,h=s.length;h>d;d++)o=s[d],"function"==typeof(u=this.props).onTokenAdd&&u.onTokenAdd(o);for("function"==typeof(c=this.props).onContentsChange&&c.onContentsChange(this.tokenData,this.refs.input.getDOMNode().value),o=t?{search_expr:i,selected_pos:this.refs.selector.state.selectionIndex,num_query_results:null!=(m=this.state.queryResults)?m.length:void 0,did_select_suggestion:!0}:{did_select_suggestion:!1},g=[],p=0,f=s.length;f>p;p++)a=s[p],g.push("function"==typeof(_=this.props).logTokenChangeEvent?_.logTokenChangeEvent(a,!1,o):void 0);return g},_addToken:function(e,t,n){return null==t&&(t=!1),null==n&&(n=null),this._addTokens([e],t,n)},removeTokens:function(e){var t,n,i,o,r,s,a,l,u,c,_,d,p,h;for(r=this.state.selectedTokenIndex,o=[],u=0,d=e.length;d>u;u++)t=e[u],i=this.tokenData.indexOf(t),-1!==i&&(r===i?r=null:r>i&&(r-=1),this.tokenData.splice(i,1),o.push(t));for(n=this.refs.input.getDOMNode(),n.focus(),this._setSelectedToken(r),this.setState({tokenData:this.tokenData,queryResults:null}),c=0,p=o.length;p>c;c++)t=o[c],"function"==typeof(s=this.props).onTokenRemove&&s.onTokenRemove(t);for(_=0,h=o.length;h>_;_++)t=o[_],"function"==typeof(a=this.props).logTokenChangeEvent&&a.logTokenChangeEvent(t,!0);return"function"==typeof(l=this.props).onContentsChange?l.onContentsChange(this.tokenData,n.value):void 0},removeToken:function(e){return this.removeTokens([e])},_renderTokens:function(){var t,n,i,o,r,s,a,l,u;for(o=[],i=function(e){return("function"==typeof e.getKey?e.getKey():void 0)||String(e)},u=this.state.tokenData,n=a=0,l=u.length;l>a;n=++a)t=u[n],s=this.props.renderToken(t),r=this.state.selectedTokenIndex===n,o.push(e.addons.cloneWithProps(s,{ref:"token"+n,key:"token"+i(t),style:{margin:"0 0 "+this.props.tokenSpacing+"px "+this.props.tokenSpacing+"px"},className:e.addons.classSet({selected:r}),onClick:this._setSelectedToken.bind(this,n),onRemove:this.removeToken.bind(this,t),tokenSpacing:this.props.tokenSpacing}));return o},_renderSelector:function(){return e.addons.cloneWithProps(this.props.renderSelector(),{ref:"selector",queryOptions:this.state.queryResults,onSelect:this._onSelect,onClose:this._clearResults})},_renderInput:function(){var t;return t=this.state.tokenData.length?"":this.props.placeholderText,e.addons.cloneWithProps(this.props.renderInput(),{ref:"input",style:{width:this.state.inputWidth,margin:"0 0 "+this.props.tokenSpacing+"px "+this.props.tokenSpacing+"px"},onChange:this._textUpdated,placeholder:t,tabIndex:this.props.tabIndex,onClick:this._setSelectedToken.bind(this,null)})},_getTokenizerInput:function(){return this.refs.tokenizer_input},_getTokenizerAccessory:function(){return this.refs.tokenizer_accessory},_getTokenComponents:function(){var e;return function(){var t,n,i;for(i=[],e=t=0,n=this.state.tokenData.length;n>=0?n>t:t>n;e=n>=0?++t:--t)i.push(this.refs["token"+e]);return i}.call(this).filter(function(e){return e})},_setSelectedToken:function(e){return null!=e?(this.refs["token"+e].getDOMNode().focus(),this.refs.selector.close()):this.refs.input.getDOMNode().focus(),this.setState({selectedTokenIndex:e})},_resizeTokenizerInput:function(){var e,t,n,i,o,r,s,a,l,u,c,_,d;for(o=function(e){return e.getDOMNode().clientWidth},t=80,u=o(this._getTokenizerInput()),i=o(this._getTokenizerAccessory()),n=this.props.tokenSpacing+2,e=this.props.tokenSpacing,s=0,c=this._getTokenComponents(),_=0,d=c.length;d>_;_++)a=c[_],l=o(a)+n,s+l+e+i>u&&(s=0,i=0),s+=l;return r=u-s-e-i-2,t>r&&(r=u-e),r!==this.state.inputWidth?this.setState({inputWidth:r}):void 0},_onSelect:function(e){var t;return t=this.refs.input.getDOMNode(),t.focus(),this._addToken(e,!0,t.value),t.value="",this.setState({queryResults:null})},_handleMyClick:function(e){var t;return"function"==typeof(t=e.nativeEvent).stopImmediatePropagation?t.stopImmediatePropagation():void 0},_handleDocumentClick:function(){return this.refs.selector.close()},_proxyKeys:function(e){return this._shouldListenForTokenNavigation()&&!this._onTokenNavigate(e)?!1:this.refs.selector.onKeyDown(e)?!0:!1},_shouldListenForTokenNavigation:function(){var e;return this.state.tokenData.length?(e=this.refs.input.getDOMNode(),0===e.selectionStart&&0===e.selectionEnd):!1},_textUpdated:function(){var e,t,i,o,r,s;return e=this.refs.input.getDOMNode(),t=e.value,s=this.props.stringTokenizer(t),i=s.tokens,o=s.value,o!==t&&(e.value=o,o||this.refs.selector.close()),i.length>0?this._addTokens(i,!1):"function"==typeof(r=this.props).onContentsChange&&r.onContentsChange(this.tokenData,o),this.props.dataSource.query(o,function(e){return function(t){var i,r;return o||(t=null),i=function(e){return("function"==typeof e.getKey?e.getKey():void 0)||String(e)},r=n.map(e.tokenData,i),t=null!=t?t.filter(function(e){var t;return t=i(e),__indexOf.call(r,t)<0}):null,e.setState({queryResults:t})}}(this))},_clearResults:function(){return this.setState({queryResults:null})},_onTokenNavigate:function(e){var t;if(0===this.state.tokenData.length)return!0;switch(t=this.state.selectedTokenIndex,e.keyCode){case i.BACKSPACE:return null===t?this._setSelectedToken(this.state.tokenData.length-1):this.removeToken(this.state.tokenData[t]),!1;case i.LEFT:return null===t?this._setSelectedToken(this.state.tokenData.length-1):t>0&&this._setSelectedToken(t-1),!1;case i.RIGHT:return null===t?!0:(this._setSelectedToken(t>=this.state.tokenData.length-1?null:t+1),!1);case i.DELETE:if(null!==t)return this.removeToken(this.state.tokenData[t]),!1;break;default:return!0}}}),{Token:r,Tokenizer:s}}),define("modules/clean/top_notif",["jquery"],function(e){var t,n,i,o,r,s,a;return a={HIDE_EVENT:"db:topnotificationbar:hide",hide:function(){return e("#top-notification-bar-container").hide(),e("body").removeClass("top-notification-bar"),e(document).trigger(this.HIDE_EVENT)}},i={init:function(){return e(".eu-bar-dismiss").on("click",function(t){return t.preventDefault(),a.hide(),e.ajax({url:"/dismiss_eu_cookie_notification",type:"POST"})})}},o={init:function(){return e(".expired-ios-bar-dismiss").on("click",function(t){return t.preventDefault(),a.hide(),e.ajax({url:"/dismiss_expired_ios_notification",type:"POST"})})}},n={init:function(){return e("#early-admin-access-fts-and-link-controls-banner-dismiss").on("click",function(t){return t.preventDefault(),a.hide(),e.ajax({url:"/team/dismiss_sharing_controls_banner",type:"POST"})})}},t={init:function(){return e("#early-admin-access-fts-banner-dismiss").on("click",function(t){return t.preventDefault(),a.hide(),e.ajax({url:"/team/dismiss_fts_banner",type:"POST"})})}},r={init:function(){return e("#locale-switch-banner-dismiss").on("click",function(t){return t.preventDefault(),a.hide(),e.ajax({url:"/dismiss_locale_switch_banner",type:"POST"})})}},s={init:function(){return e("#super-inactive-recover-bar-dismiss").on("click",function(t){return t.preventDefault(),a.hide(),e.ajax({url:"/dismiss_super_inactive_recover_bar",type:"POST"})})}},{TopNotificationBar:a,EUCookieNotificationBar:i,ExpiredIOSNotificationBar:o,DfBAdminEarlyAccessSharingControlsBar:n,DfBAdminEarlyAccessFtsBar:t,LocaleSwitchBar:r,SuperInactiveRecoverBar:s}}),define("modules/clean/typeahead",["external/react","external/underscore","modules/clean/fuzzy","modules/clean/keycode"],function(e,t,n,i){var o,r,s,a,l;return l=e.DOM,r=function(){function e(e){this.local=(null!=e?e:{}).local}return e.prototype.query=function(e,i){var o;return o=t.map(n.filter(e,this.local),function(e){return e.original}),i(o)},e}(),a={getInitialState:function(){return{selectionIndex:0}},getOptions:function(){var e;return this.props.queryOptions?(e=this.props.maxVisible||this.props.queryOptions.length,this.props.queryOptions.slice(0,e)):[]},renderOptions:function(){var t,n,i,o,r,s,a,l,u;for(a=[],s=this.getOptions(),o=function(e){return("function"==typeof e.getKey?e.getKey():void 0)||String(e)},i=l=0,u=s.length;u>l;i=++l)n=s[i],t={selected:this.state.selectionIndex===i,"typeahead-option":!0},r=this.renderOption(n),a.push(e.addons.cloneWithProps(r,{className:e.addons.classSet(t),key:"option"+o(n),onMouseEnter:this._hover.bind(this,i),onClick:this.onSelect.bind(this,n)}));return a},onSelect:function(e){return this.props.onSelect(e),this.reset()},renderOption:function(e){return this.props.renderQueryOption(e)},onKeyDown:function(e){var t;switch(e.keyCode){case i.UP:return this._navigate(-1),!1;case i.DOWN:return this._navigate(1),!1;case i.ENTER:return t=this.getOptions(),t.length?(this.onSelect(t[this.state.selectionIndex]),!1):!0;case i.ESC:return this.close(),!1;case i.TAB:return t=this.getOptions(),t.length?(this.onSelect(t[this.state.selectionIndex]),!1):!0;default:return this.reset(),!0}},reset:function(){return this.setState({selectionIndex:0})},close:function(){var e;return"function"==typeof(e=this.props).onClose&&e.onClose(),this.reset()},_hover:function(e){return this.setState({selectionIndex:e})},_navigate:function(e){var t,n;return(n=this.getOptions().length)?(t=this.state.selectionIndex+e,0>t?t+=n:t>=n&&(t-=n),this.setState({selectionIndex:t})):void 0}},o=e.createClass({propTypes:{customClass:e.PropTypes.string,dataSource:e.PropTypes.object.isRequired,renderCompletionText:e.PropTypes.func.isRequired,renderInput:e.PropTypes.func.isRequired,renderSelector:e.PropTypes.func.isRequired},getDefaultProps:function(){return{renderCompletionText:function(e){return String(e)},renderInput:function(){return l.input()},renderSelector:function(){return s()}}},getInitialState:function(){return{queryResults:null}},render:function(){var t;return t={},t[this.props.customClass]=null!=this.props.customClass,l.div({className:e.addons.classSet(t)},this._renderInput(),this._renderSelector())},_renderInput:function(){return e.addons.cloneWithProps(this.props.renderInput(),{ref:"input",onChange:this._inputChanged,onKeyDown:this._proxyKeys})},_renderSelector:function(){return e.addons.cloneWithProps(this.props.renderSelector(),{ref:"selector",queryOptions:this.state.queryResults,onSelect:this._autocomplete,onClose:this._clearResults})},_inputChanged:function(){var e;return e=this.refs.input.getDOMNode().value,this.props.dataSource.query(e,function(t){return function(n){return e||(n=[]),t.setState({queryResults:n})}}(this)),this.refs.selector.reset()},_proxyKeys:function(e){return this.refs.selector.onKeyDown(e)},_autocomplete:function(e){var t;return t=this.refs.input.getDOMNode(),t.focus(),t.value=this.props.renderCompletionText(e),this._clearResults()},_clearResults:function(){return this.setState({queryResults:null})}}),s=e.createClass({mixins:[a],propTypes:{customClass:e.PropTypes.string,maxVisible:e.PropTypes.number,onClose:e.PropTypes.func.isRequired,onSelect:e.PropTypes.func.isRequired,queryOptions:e.PropTypes.array,renderQueryOption:e.PropTypes.func.isRequired},getDefaultProps:function(){return{maxVisible:7,onClose:function(){},onSelect:function(){},renderQueryOption:function(e){return l.li({},String(e))}}},render:function(){var t;return this.getOptions().length?(t={"typeahead-selector":!0},t[this.props.customClass]=null!=this.props.customClass,l.ul({className:e.addons.classSet(t)},this.renderOptions())):l.div({})}}),{Autocomplete:o,DataSource:r,TypeaheadSelector:s,TypeaheadSelectorMixin:a}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/uirequest",["jquery","modules/core/html","modules/core/notify","modules/clean/ajax","modules/clean/components/ajax_form","modules/clean/dbmodal","modules/clean/static_resource_loader"],function(e,t,n,i,o,r,s){var a,l;return a=r.DBModal,l=function(){function r(e,t,n){return this.$node=e,this.url=t,this.options=null!=n?n:{},this.complete=__bind(this.complete,this),this.handle_errors=__bind(this.handle_errors,this),this.error=__bind(this.error,this),this.perform_actions=__bind(this.perform_actions,this),this.success=__bind(this.success,this),this.shouldDelayComplete=!1,this.$node.hasClass("ajax-loading")?!1:(this.$node.addClass("ajax-loading"),void new i.FormWebRequest({url:this.url,type:null!=this.options.type?this.options.type:void 0,data:this.options.data||{},success:this.success,error:this.error,complete:this.complete,subject_user:this.options.subject_user}))}return r.prototype.success=function(e,t,n){var i,r,a;return(i=o.extract_errors(n.responseText))?(this.handle_errors(i),void("function"==typeof(r=this.options).error&&r.error(n,t))):(e=JSON.parse(n.responseText),e.redirect?void(window.location.href=e.redirect):e.reload?void window.location.reload():(this.shouldDelayComplete=e.js||e.css,this.shouldDelayComplete?s.async_multiload(e.css,e.js,function(i){return function(){var o,r;return i.perform_actions(e.actions||[]),"function"==typeof(o=i.options).success&&o.success(e,t,n),i.$node.removeClass("ajax-loading"),"function"==typeof(r=i.options).complete?r.complete(n,t):void 0}}(this)):(this.perform_actions(e.actions||[]),void("function"==typeof(a=this.options).success&&a.success(e,t,n)))))},r.prototype.perform_actions=function(i){var o,r,s,l,u,c,_,d,p,h,f,m;for(m=[],h=0,f=i.length;f>h;h++)switch(r=i[h],l=r[0],s=r[1],p=r[2],o=this.$node,p&&"modal"!==l&&("^"===p.charAt(0)&&(c=p.split(" "),o=o.closest(c[0].substr(1)),p=c.slice(1).join(" ")),p&&(o=o.find(p).filter(":first"))),l){case"modal":_="db-modal-response-modal-placeholder",e("#"+_).remove(),d=e(s),d.attr("id",_),e("body").append(d),u=new a({element_id:"response-modal-placeholder"}),m.push(u.show());break;case"html":m.push(o.html(s));break;case"replaceWith":m.push(o.replaceWith(s));break;case"after":m.push(o.after(s));break;case"before":m.push(o.before(s));break;case"toggleClass":m.push(o.toggleClass(s));break;case"addClass":m.push(o.addClass(s));break;case"removeClass":m.push(o.removeClass(s));break;case"notify":m.push(n.success(s));break;case"notifyError":m.push(n.error(new t(s)));break;default:m.push(void 0)}return m},r.prototype.error=function(e,t){var n,i;return n=o.extract_errors(e.responseText),this.handle_errors(n),"function"==typeof(i=this.options).error?i.error(e,t):void 0},r.prototype.handle_errors=function(e){var i;return e===!1?n.error():"string"==typeof e?(i=this.options.html_in_error_msg?new t(e):e,n.error(i)):o.fill_errors(this.$node,e)},r.prototype.complete=function(e,t){var n;if(!this.shouldDelayComplete)return this.$node.removeClass("ajax-loading"),"function"==typeof(n=this.options).complete?n.complete(e,t):void 0},r}()}),define("modules/clean/undo",["jquery","modules/core/html","modules/core/i18n","modules/core/notify"],function(e,t,n,i){var o,r;return r=n._,o=function(){function t(){}return t.perform_undo=function(){return null!=this.undo_handler?(this.undo_handler(this.undo_info),this.undo_handler=this.undo_info=null):void 0},t.notifyWithUndo=function(n,o,s,a){var l,u;return a=a||30,o?(this.undo_info=o,this.undo_handler=s,l=e("<span />"),null!=n.toHTML?l.html(n.toHTML()):l.text(n),u=e("<a/>",{href:"#"}).text(r("Undo")),u.on("click",function(){return t.perform_undo(),!1}),l.append("&nbsp;").append(u),this.undo_notification=i.success(l,a)):i.success(n)},t}()}),define("modules/clean/unity/check_file_cache",["modules/clean/unity/features"],function(e){var t;if(null!=e)return t=function(){function t(){}return t._cache={},t.is_cached_and_locally_available=function(t,n){var i;return i=this._cache[e.server_path(t,n)],null!=i&&i.is_locally_available},t.get=function(t,n){return this._cache[e.server_path(t,n)]},t.set=function(e,t){return this._cache[e]=t},t.set_batch=function(e){var t,n,i;i=[];for(n in e)t=e[n],i.push(this._cache[n]=t);return i},t.clear=function(){return this._cache={}},t}(),__CONDITIONAL_JS__.UnityCheckFileCache=t,t});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/unity/connection",["jquery","modules/core/exception","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/connection_error","modules/clean/unity/logger","modules/clean/unity/versions","modules/clean/unity/web_socket","modules/clean/viewer"],function(e,t,n,i,o,r,s,a,l,u){var c;if(l.web_sockets_supported())return c=function(){function c(){this._on_response_timeout=__bind(this._on_response_timeout,this),this._on_message=__bind(this._on_message,this),this._set_connection_state=__bind(this._set_connection_state,this),this._on_error=__bind(this._on_error,this),this._on_close=__bind(this._on_close,this),o.getGandalfRule("unity-web-debug")&&(window.uc=this),this.client_version=null,this._on_open_callbacks=[],this._on_open_failed_callbacks=[],this._on_close_callbacks=[],this._pending_callbacks=[],this._response_callbacks={},this._ws=null,this._port=null,this._active_ports={},this._connection_state=c._CONNECTION_PENDING,this._current_message_id=1,this._permission_level=null,this.logger=new s,this._routes={check_unity_version:this._check_unity_version.bind(this),fetch_unity_nonce:this._fetch_unity_nonce.bind(this),complete_handshake:this._complete_handshake.bind(this)}}return c._CONNECTION_OPENED_STATE=0,c._VERSION_CHECK_STATE=1,c._FETCHING_NONCE_STATE=2,c._NONCE_RETURNED_TO_CLIENT_STATE=3,c._HANDSHAKE_COMPLETED_STATE=4,c._CONNECTION_PENDING=0,c._CONNECTION_ESTABLISHED=1,c._CONNECTION_CLOSED=2,c._RESPONSE_TIMEOUT=5e3,c._MIN_PORT=17600,c._MAX_PORT=17602,c.SECURE_PERMISSION="secure",c.INSECURE_WEB_PERMISSION="insecure_web",c.INSECURE_CLIENT_PERMISSION="insecure_client",c.INSECURE_PERMISSION="insecure",c.prototype.start=function(){var e,i,o,r,s,a,u;if(!l.load_flash_policy_if_needed())return void this._set_connection_state(c._CONNECTION_CLOSED);try{for(i=s=a=c._MIN_PORT,u=c._MAX_PORT;u>=a?u>=s:s>=u;i=u>=a?++s:--s)this._active_ports[i]=!0,o={scheme:"ws",authority:"127.0.0.1:"+i.toString(),path:"/ws"},r=l.create(n(o).toString()),r.onmessage=this._on_message({ws:r,port:i,state:c._CONNECTION_OPENED_STATE,client_version:null,client_has_auth:null}),r.onclose=this._on_close(i),r.onerror=this._on_error(i)}catch(_){e=_,this.logger.report_event("unity_failure",{message:"WebSocket creation failed. Message: "+e.message,error_name:e.name,port:i,stack:t.stackTrace()}),this._set_connection_state(c._CONNECTION_CLOSED)}return this.logger.report_event("handshake_started")},c.prototype._on_close=function(e){return function(t){return function(n){var i;return 1e3===(i=n.code)||1001===i||1005===i||1006===i||t.logger.report_event("unity_failure",{message:"WebSocket closed. Code: "+n.code+". Reason: "+n.reason,port:e}),t._close_port(e)}}(this)},c.prototype._on_error=function(e){return function(t){return function(n){return t.logger.report_event("unity_failure",{message:"WebSocket error. Message: "+n.data,port:e}),t._close_port(e)}}(this)},c.prototype._close_port=function(t){return delete this._active_ports[t],e.isEmptyObject(this._active_ports)?this._set_connection_state(c._CONNECTION_CLOSED):void 0},c.prototype._set_connection_state=function(e){var n,i,o,s,a,l,u,_,d,p,h,f,m,g,v,y,b,w,C,S;if(e!==this._connection_state){if(o=this._connection_state,t.assert(o!==c._CONNECTION_CLOSED,"Shouldn't unclose a closed connection."),this._connection_state=e,e===c._CONNECTION_ESTABLISHED){for(t.assert(o===c._CONNECTION_PENDING,"Can only establish from pending."),this.logger.report_event("handshake_complete"),g=this._on_open_callbacks,_=0,h=g.length;h>_;_++)(a=g[_])();for(C=[];this._pending_callbacks.length;)v=this._pending_callbacks.pop(),n=v[0],i=v[1],C.push(this.is_ready()?n():"function"==typeof i?i(r.UNEXPECTED_ERROR):void 0);return C}if(e===c._CONNECTION_CLOSED){if(o===c._CONNECTION_PENDING)for(this.logger.report_event("connection_not_established"),y=this._on_open_failed_callbacks,d=0,f=y.length;f>d;d++)(l=y[d])();else if(o===c._CONNECTION_ESTABLISHED)for(this.logger.report_event("connection_terminated"),b=this._on_close_callbacks,p=0,m=b.length;m>p;p++)(s=b[p])();for(S=[];this._pending_callbacks.length;)w=this._pending_callbacks.pop(),u=w[0],i=w[1],S.push("function"==typeof i?i(r.CONNECTION_CLOSED):void 0);return S}return t.assert(!1,"Changing connection_state to CONNECTION_PENDING not yet supported.")}},c.prototype._on_message=function(e){return function(t){return function(n){var i,o,r,s,a,l;return o=JSON.parse(n.data),null==o.func||null==(null!=(s=o.header)?s.message_id:void 0)||null==(null!=(a=o.header)?a.should_respond:void 0)?void t._terminate_handshake(e.ws,"Malformed message from client.",{message:n.data}):(null!=(null!=(l=o.header)?l.log_data:void 0)&&t.logger.update(o.header.log_data),t.logger.update({port:e.port}),"response"===o.func?t._on_response(o.header.message_id,o.data):(i=t._routes[o.func],null==i?void t._terminate_handshake(e.ws,"Unknown function.",{"function":o.func}):(r=t.is_ready()?i(o.data):i(e,o.data),o.header.should_respond?t.send("response",r,null,null,o.header.message_id):void 0)))}}(this)},c.prototype.send=function(e,t,n,i,o){return null==t&&(t=null),null==n&&(n=null),null==i&&(i=null),null==o&&(o=null),this._send_with_ws(this._ws,e,t,n,i,o)},c.prototype._send_with_ws=function(e,n,i,o,s,a){var l,u,_;null==i&&(i=null),null==o&&(o=null),null==s&&(s=null),null==a&&(a=null),null==a&&(a=this._current_message_id,t.assert(this._current_message_id%2===1,"Web-initiated message_ids should remain odd"),this._current_message_id+=2),null!==o&&(_=window.setTimeout(this._on_response_timeout(a),c._RESPONSE_TIMEOUT),this._response_callbacks[a]=[o,s,_]),u={func:n,header:{message_id:a,should_respond:null!==o,log_data:this.logger.get_log_data_for_client()}},null!=i&&(u.data=i);try{return e.send(JSON.stringify(u))}catch(d){return l=d,this.logger.report_event("unity_failure",{message:"WebSocket send failed. Message: "+l.message,error_name:l.name}),"function"==typeof s?s(r.COULD_NOT_SEND):void 0}},c.prototype._on_response=function(e,t){var n,i,o,r;return e in this._response_callbacks?(r=this._response_callbacks[e],n=r[0],o=r[1],i=r[2],delete this._response_callbacks[e],window.clearTimeout(i),n(t)):void 0},c.prototype._on_response_timeout=function(e){return function(t){return function(){var n,i,o;return o=t._response_callbacks[e],i=o[0],n=o[1],i=o[2],delete t._response_callbacks[e],"function"==typeof n?n(r.CONNECTION_TIMEOUT):void 0}}(this)},c.prototype._check_unity_version=function(e,t){var n;return e.state!==c._CONNECTION_OPENED_STATE?void this._terminate_handshake(e.ws,"Handshake version check at wrong time of protocol."):(e.state=c._VERSION_CHECK_STATE,e.client_version=t.client_version,t.client_version<a.UNITY_HANDSHAKE?void this._terminate_handshake(e.ws,"Client version is too old."):(n=u.get_viewer().is_signed_in,t.client_version<a.PERMISSION_LEVELS&&!n?void this._terminate_handshake(e.ws,"Client version is too old to support insecure web connections."):(this.logger.report_event("handshake_version_check"),t.client_version>=a.PERMISSION_LEVELS?this._send_with_ws(e.ws,"initiate_handshake",{secure_web:n}):this._send_with_ws(e.ws,"initiate_handshake"))))},c.prototype._fetch_unity_nonce=function(e,t){return e.state===c._VERSION_CHECK_STATE?(e.state=c._FETCHING_NONCE_STATE,this.logger.report_event("handshake_fetch_nonce"),this._retrieve_unity_nonce(e,t.nonce_key)):this._terminate_handshake(e.ws,"Fetch Unity nonce at wrong time of protocol.")},c.prototype._retrieve_unity_nonce=function(e,o){return i.WebRequest({url:n({path:"/retrieve_unity_nonce"}),dataType:"json",data:{nonce_key:o},success:function(n){return function(i){var o;switch(i.status){case"OK":return e.state=c._NONCE_RETURNED_TO_CLIENT_STATE,e.client_has_auth=i.message.client_has_auth,o=u.get_viewer().is_signed_in,e.client_has_auth&&o?n._permission_level=c.SECURE_PERMISSION:(t.assert(e.client_version>=a.PERMISSION_LEVELS,"Insecure connections only supported by client_version >= "+a.PERMISSION_LEVELS+"."),n._permission_level=e.client_has_auth?c.INSECURE_WEB_PERMISSION:o?c.INSECURE_CLIENT_PERMISSION:c.INSECURE_PERMISSION),n.logger.update({unity_permission_level:n._permission_level}),n.logger.report_event("handshake_nonce_sent_to_unity_server"),n._send_with_ws(e.ws,"verify_unity_nonce",{nonce:i.message.nonce});case"MISMATCHED_USER_IDS":return n._terminate_handshake(e.ws,"Mismatched user_ids.",{client_user_ids:i.message.client_user_ids,web_user_ids:i.message.web_user_ids
});case"INVALID":return n._terminate_handshake(e.ws,"Could not find nonce with given nonce_key.");case"AUTH_REQUIRED":return n._terminate_handshake(e.ws,"Did not have the necessary authentication to retrieve nonce.")}}}(this),error:function(t){return function(n,i,o){return t._terminate_handshake(e.ws,"Unable to retrieve nonce from server",{status:i,error_string:o})}}(this)})},c.prototype._complete_handshake=function(e,t){var n;return e.state===c._NONCE_RETURNED_TO_CLIENT_STATE&&t.is_success?(e.state=c._HANDSHAKE_COMPLETED_STATE,this._connection_state===c._CONNECTION_CLOSED?this._terminate_handshake(e.ws,"No more handshakes are allowed to complete."):null!=this._ws?(n="Only one Unity handshake can succeed! There's likely a MITM attack, so close all connections.",this._terminate_handshake(e.ws,n),this._terminate_handshake(this._ws,n),this.client_version=null,this._ws=null,this._port=null,this._set_connection_state(c._CONNECTION_CLOSED)):(this.client_version=e.client_version,this._ws=e.ws,this._port=e.port,this._set_connection_state(c._CONNECTION_ESTABLISHED))):this._terminate_handshake(e.ws,"Unable to complete handshake.")},c.prototype._terminate_handshake=function(t,n,i){var r;return null==i&&(i=null),r={message:n},null!=i&&e.extend(r,i),o.getGandalfRule("unity-web-debug")&&console.error(r),this.logger.report_event("unity_failure",r),t.close()},c.prototype.add_on_open_callback=function(e){return this._on_open_callbacks.push(e)},c.prototype.add_on_open_failed_callback=function(e){return this._on_open_failed_callbacks.push(e)},c.prototype.add_on_close_callback=function(e){return this._on_close_callbacks.push(e)},c.prototype.call_when_ready=function(e,t){return null==t&&(t=null),this.is_ready()?e():this._connection_state===c._CONNECTION_PENDING?this._pending_callbacks.push([e,t]):"function"==typeof t?t(r.CONNECTION_CLOSED):void 0},c.prototype.is_ready=function(){var e;return(null!=(e=this._ws)?e.readyState:void 0)===WebSocket.OPEN&&this._connection_state===c._CONNECTION_ESTABLISHED},c.prototype.feature_supported=function(e,n){var i;return t.assert(null!==this._permission_level,"Connection is not ready."),this.client_version<e?!1:(i=this._permission_level,__indexOf.call(n,i)>=0)},c}()}),define("modules/clean/unity/connection_error",[],function(){var e;return e=function(){function e(){}return e.CONNECTION_TIMEOUT="connection_timeout",e.CONNECTION_CLOSED="connection_closed",e.COULD_NOT_SEND="could_not_send",e.UNEXPECTED_ERROR="unexpected_error",e}()}),define("modules/clean/unity/features",["external/modernizr","jquery","modules/clean/ajax","modules/clean/filepath","modules/clean/gandalf_util","modules/clean/unity/connection","modules/clean/unity/versions","modules/core/exception","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,r,s,a,l,u,c){var _;if(null!=r)return _=function(){function e(){}return e._uc=new r,e._has_handshake_started=!1,e._start_handshake_if_needed=function(){return this._has_handshake_started?void 0:(this._uc.start(),this._has_handshake_started=!0)},e._cached_file_browser_display_name=null,e.continue_as_user=function(e,t,n,i){return null==i&&(i=null),this._start_handshake_if_needed(),this._uc.call_when_ready(function(o){return function(){return o._uc.feature_supported(s.WEB_DESTINY,[r.INSECURE_WEB_PERMISSION])?(o._uc.logger.report_event("continue_as_user",{browser:e,refresh_token:t}),o._uc.send("continue_as_user",{browser:e,refresh_token:t},n,i)):void 0}}(this),i)},e.continue_as_user_direct=function(e,t){return null==t&&(t=null),this._start_handshake_if_needed(),this._uc.call_when_ready(function(n){return function(){return n._uc.feature_supported(s.WEB_DESTINY_V2,[r.INSECURE_WEB_PERMISSION])?(n._uc.logger.report_event("continue_as_user_direct"),n._uc.send("continue_as_user_direct",null,e,t)):void 0}}(this),t)},e.web_destiny_info=function(e,t){return null==t&&(t=null),this._start_handshake_if_needed(),this._uc.call_when_ready(function(n){return function(){return n._uc.feature_supported(s.WEB_DESTINY_V2,[r.INSECURE_WEB_PERMISSION])?(n._uc.logger.report_event("web_destiny_info"),n._uc.send("web_destiny_info",null,e,t)):void 0}}(this),t)},e.client_supports_open_in_file_browser=function(){return o.getGandalfRule("unity-file-browser")&&this._uc.feature_supported(s.OPEN_IN_FILE_BROWSER,[r.SECURE_PERMISSION])},e.open_file=function(e,t,o,l,u,_){var d;return null==u&&(u=null),null==_&&(_=!1),this._start_handshake_if_needed(),d=this.server_path(e,t),this._uc.call_when_ready(function(e){return function(){var t;return e._uc.feature_supported(s.UNITY_HANDSHAKE,[r.SECURE_PERMISSION])?(e._uc.logger.report_event("open_file",{user_id:o,path_id:d,file_extension:i.file_extension_for_logging(d),in_file_browser:_}),n.AuthenticatedRequest({url:c({path:"/unity_open_log"}),data:{user_id:o,server_path:d,file_extension:i.file_extension_for_logging(d),in_file_browser:_,unity_session_id:e._uc.logger.unity_session_id(),buildno:e._uc.logger._data.buildno,host_id:e._uc.logger._data.host_id}}),t={server_path:d,user_id:o},e._uc.client_version>=s.OPEN_IN_FILE_BROWSER?t.in_file_browser=_:a.assert(!_,"The connected client doesn't support opening in file browser."),e._uc.send("open_file",t,l,u)):void 0}}(this),u)},e.standard_open_file_handler=function(e){return e?void 0:u.error(l._("Error opening file"))},e.check_file=function(e,t,n,o,a){var l,u;return null==a&&(a=null),this._start_handshake_if_needed(),u=this.server_path(e,t),l=function(e){return function(t){return e._check_file_deprecated_on_client()&&(t={is_locally_available:t}),o(t)}}(this),this._uc.call_when_ready(function(e){return function(){return e._uc.feature_supported(s.UNITY_HANDSHAKE,[r.SECURE_PERMISSION])?(e._uc.logger.report_event("check_file",{user_id:n,path_id:u,file_extension:i.file_extension_for_logging(u)}),e._uc.send("check_file",{server_path:u,user_id:n},l,a)):void 0}}(this),a)},e.add_on_ready_callback=function(e){return this._uc.call_when_ready(e)},e.check_file_batch=function(e,n,o,a){var l,u,c,_,d;return null==a&&(a=null),l=t.Deferred(),this._start_handshake_if_needed(),d=function(){var t,n,i;for(i=[],t=0,n=e.length;n>t;t++)c=e[t],i.push(this.server_path(c.ns_id,c.ns_path));return i}.call(this),_=function(e){return function(t){var n,i;if(e._check_file_deprecated_on_client())for(n in t)i=t[n],t[n]={is_locally_available:i};return o(t),l.resolve(t)}}(this),u=function(e){return"function"==typeof a&&a(e),l.reject(e)},this._uc.call_when_ready(function(e){return function(){var t;return e._uc.feature_supported(s.UNITY_HANDSHAKE,[r.SECURE_PERMISSION])?(e._uc.logger.report_event("check_file_batch",{user_id:n,path_ids:d,file_extensions:function(){var e,n,o;for(o=[],e=0,n=d.length;n>e;e++)t=d[e],o.push(i.file_extension_for_logging(t));return o}()}),e._uc.send("check_file_batch",{server_paths:d,user_id:n},_,u)):void 0}}(this),u),l.promise()},e.file_browser_display_name=function(e,t){var n,i;return null==t&&(t=null),null!=this._cached_file_browser_display_name?void e(this._cached_file_browser_display_name):(n=function(t){return function(n){return t._cached_file_browser_display_name=n,e(n)}}(this),this._start_handshake_if_needed(),i=function(i){return function(){return i._uc.feature_supported(s.CHECK_FILE_RETURNS_OBJ,[r.SECURE_PERMISSION])?(i._uc.logger.report_event("file_browser_display_name"),i._uc.send("file_browser_display_name",null,n,t)):e(null)}}(this),this._uc.call_when_ready(i,t))},e._check_file_deprecated_on_client=function(){return s.UNITY_HANDSHAKE<=this._uc.client_version&&this._uc.client_version<s.CHECK_FILE_RETURNS_OBJ},e.server_path=function(e,t){return""+e+":"+t},e}(),__CONDITIONAL_JS__.UnityFeatures=INLINE_JS.UnityFeatures=_,_}),define("modules/clean/unity/features/destiny_logger",["jquery","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/versions"],function(e,t,n,i,o){var r;return r={report_event:function(e,r){var s;return null==r&&(r=null),s={event_name:e,extra:JSON.stringify(r||{}),local_ts:(new Date).getTime(),server_path:window.location.pathname,session_id:Constants.sess_id,web_unity_version:o.LATEST},n.WebRequest({url:t({path:"/destiny_log"}),data:s}),i.getGandalfRule("destiny-web-debug")?console.log(s):void 0}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/unity/features/web_destiny",["external/modernizr","jquery","modules/clean/ajax","modules/clean/unity/features","modules/clean/unity/features/destiny_logger","modules/core/browser","modules/core/exception","modules/core/uri"],function(e,t,n,i,o,r,s,a){var l;if(null!=i)return l=function(){function l(){this._assert_is_initialized=__bind(this._assert_is_initialized,this),this._direct_web_destiny=__bind(this._direct_web_destiny,this),this.is_direct_allowed=__bind(this.is_direct_allowed,this),this.user_display_name=__bind(this.user_display_name,this),this.continue_as_user=__bind(this.continue_as_user,this),this._cached_web_destiny_info=null}return l.Error={UNITY_CONNECTION_ERROR:"unity_connection_error",REFRESH_TIMEOUT:"refresh_timeout",LOGIN_REQUEST_ERROR:"login_request_error"},l._DESTINY_REFRESH_TOKEN_KEY="web-destiny-refresh-token",l._DESTINY_MANUAL_REFRESH_TIMEOUT=5e3,l._DESTINY_REFRESH_TIMEOUT=1e4,l.finish_indirect_web_destiny=function(n){var i;return o.report_event("web_destiny_opened_new_tab"),t(window).on("beforeunload",function(){return o.report_event("web_destiny_new_tab_redirecting")}),e.localstorage?(localStorage.setItem(this._DESTINY_REFRESH_TOKEN_KEY,n),i=localStorage.getItem("web-destiny-redirect-uri"),localStorage.removeItem("web-destiny-redirect-uri"),r.redirect(i?i:"/")):r.redirect("/")},l.prototype.start_connection=function(e,t){return null==t&&(t=null),null==this._cached_web_destiny_info?i.web_destiny_info(function(t){return function(n){return null!=n?(t._cached_web_destiny_info=n,e(n.user_display_name)):void 0}}(this),t):void 0},l.prototype.continue_as_user=function(e,t){var n,i;return null==e&&(e=null),null==t&&(t=null),this._assert_is_initialized(),n=function(){return null!=e?r.redirect(e):window.location.reload()},i=function(e){return null!=t?t(e):void 0},this._cached_web_destiny_info.is_direct_allowed?this._direct_web_destiny(n,i):this._indirect_web_destiny(n,i)},l.prototype.user_display_name=function(){return this._assert_is_initialized(),this._cached_web_destiny_info.user_display_name},l.prototype.is_direct_allowed=function(){return this._assert_is_initialized(),this._cached_web_destiny_info.is_direct_allowed},l.prototype._indirect_web_destiny=function(t,n){var o,s,a,u;return u=null,a=null,e.localstorage&&(u=(new Date).getTime().toString(),s=function(e){return e.key===l._DESTINY_REFRESH_TOKEN_KEY&&e.newValue===u?(window.clearTimeout(a),t()):void 0},null!=window.addEventListener?window.addEventListener("storage",s,!1):window.attachEvent("onstorage",s)),o=function(){return a=e.localstorage?window.setTimeout(function(){return n(l.Error.REFRESH_TIMEOUT)},l._DESTINY_REFRESH_TIMEOUT):window.setTimeout(t,l._DESTINY_MANUAL_REFRESH_TIMEOUT)},i.continue_as_user(r.browser_name,u,o,function(){return n(l.Error.UNITY_CONNECTION_ERROR)})},l.prototype._direct_web_destiny=function(e,t){var o;return s.assert(this._cached_web_destiny_info.is_direct_allowed,"Direct Web Destiny is not allowed."),o=function(i){var o,r,s;return o={i:function(){var e;e=[];for(r in i)s=i[r],e.push(r);return e}(),n:function(){var e;e=[];for(r in i)s=i[r],e.push(s);return e}(),return_json:!0},n.WebRequest({url:a({path:"/desktop_login"}),data:o,success:e,error:function(){return t(l.Error.LOGIN_REQUEST_ERROR)}})},i.continue_as_user_direct(o,function(){return t(l.Error.UNITY_CONNECTION_ERROR)})},l.prototype._assert_is_initialized=function(){return s.assert(null!=this._cached_web_destiny_info,"Method not allowed. WebDestiny was not initialized.")},l}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/unity/features/web_destiny_ui",["external/modernizr","jquery","modules/clean/ajax","modules/core/browser","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/components/ajax_form","modules/clean/em_string","modules/clean/gandalf_util","modules/clean/unity/features","modules/clean/unity/features/destiny_logger","modules/clean/unity/features/web_destiny"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p){var h,f;return f=r._,h=function(){function t(e){this._fill_login_error=__bind(this._fill_login_error,this),this._show_unity_server_error=__bind(this._show_unity_server_error,this),this._show_unity_client_error=__bind(this._show_unity_client_error,this),this._web_destiny_login=__bind(this._web_destiny_login,this),this._show_web_destiny=__bind(this._show_web_destiny,this),this._web_destiny_connect_callback=__bind(this._web_destiny_connect_callback,this),this._check_if_previous_login_failed=__bind(this._check_if_previous_login_failed,this),this.maybe_show_web_destiny=__bind(this.maybe_show_web_destiny,this),this.$login_form=e.find(".login-form"),this.cont=this.$login_form.find("input[name='cont']").val(),this.$web_destiny_container=e.find("#web-destiny-container"),this.button=this.$web_destiny_container.find("#continue-as-button")}return t.prototype.maybe_show_web_destiny=function(){return this._is_destiny_enabled()?this._check_if_previous_login_failed()?void this._show_unity_server_error():(this._web_destiny=new p,d.report_event("web_destiny_start_connection_to_unity"),_.add_on_ready_callback(this._unity_ready_callback),this._web_destiny.start_connection(this._web_destiny_connect_callback)):void 0},t.prototype._unity_ready_callback=function(){return d.report_event("web_destiny_unity_ready")},t.prototype._check_if_previous_login_failed=function(){return this.cont.indexOf("/login_complete?refresh_token=")>=0},t.prototype._is_destiny_enabled=function(){var e,t;return 0===this.$web_destiny_container.length?!1:(e=["/dropins/login_popup"],c.getGandalfRule("unity-web-destiny")&&null!=p&&("/login"===window.location.pathname||c.getGandalfRule("unity-web-destiny-all-pages"))&&!this._is_safari_private_mode()&&!this._is_growth_logout_experiment_enabled()&&(t=window.location.pathname,__indexOf.call(e,t)<0))},t.prototype._is_growth_logout_experiment_enabled=function(){var e;return e=a.parse(window.location.pathname+window.location.search).getQuery(),c.getGandalfRule("growth_web_logout_client")&&"src"in e&&"logout"===e.src},t.prototype._is_safari_private_mode=function(){return i.safari&&!e.localstorage},t.prototype._web_destiny_connect_callback=function(e){var t,n;return d.report_event("web_destiny_unity_triggered"),t=this._make_display_name_text(e),n=this.$web_destiny_container.find(".continue-as-user-name"),n.text(t),this.button.click(this._web_destiny_login),this._show_web_destiny()},t.prototype._make_display_name_text=function(e){return f("Continue as %(real_name)s",{comment:"Log in automatically as NAME"}).format({real_name:e})},t.prototype._show_web_destiny=function(){return d.report_event("web_destiny_display_continue_as_animation_start"),this.button.attr("disabled",!1),this.$web_destiny_container.hide().css({visibility:"visible",display:""}).fadeIn("fast",function(){return d.report_event("web_destiny_display_continue_as_animation_end")})},t.prototype._web_destiny_login=function(){var t,n,o,r;return d.report_event("web_destiny_continue_as_clicked"),"/login"!==window.location.pathname&&""===this.cont&&(this.cont=window.location.pathname+window.location.search),i.msie||!e.localstorage||this._web_destiny.is_direct_allowed()?(n=this.cont,o="/"):(n="/",o=this.cont),e.localstorage&&localStorage.setItem("web-destiny-redirect-uri",o),t=this._get_check_signed_in_ajax_callback(this._show_unity_client_error),r=this._get_unity_client_error_callback(t,this._show_unity_client_error),this._web_destiny.continue_as_user(n,r),s.warning(f("Weâre trying to log you in automatically")),this.button.attr("disabled",!0)},t.prototype._get_unity_client_error_callback=function(e,t){return function(){return new n.AuthenticatedRequest({url:"/is_signed_in",success:e,error:t})}},t.prototype._get_check_signed_in_ajax_callback=function(e){return function(t){return"ok"===t?i.reload():e()}},t.prototype._show_unity_client_error=function(){return this._fill_login_error(f("Sorry, we werenât able to sign you in. Please enter your email and password to sign in.")),this.button.attr("disabled",!0),d.report_event("web_destiny_client_error")},t.prototype._show_unity_server_error=function(){return this._fill_login_error(f("Please enter your email and password to sign in.")),d.report_event("web_destiny_server_error")},t.prototype._fill_login_error=function(e){return l.fill_errors(this.$login_form,{login_email:{message_text:e}})},t}()}),define("modules/clean/unity/logger",["jquery","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/versions"],function(e,t,n,i,o){var r;return r=function(){function r(){this._data={logging_source:"web",web_unity_version:o.LATEST}}return r.prototype.update=function(t){return e.extend(this._data,t)},r.prototype.report_event=function(e,o){return null==o&&(o=null),this._data.event_name=e,this._data.local_ts=(new Date).getTime()/1e3,this._data.extra=JSON.stringify(o||{}),n.WebRequest({url:t({path:"/unity_connection_log"}),data:this._data}),i.getGandalfRule("unity-web-debug")?console.log(this._data):void 0},r.prototype.get_log_data_for_client=function(){return{web_unity_version:this._data.web_unity_version,user_agent:window.navigator.userAgent}},r.prototype.unity_session_id=function(){return this._data.unity_session_id},r}()}),define("modules/clean/unity/versions",function(){var e;return e=function(){function e(){}return e.LATEST=7,e.INITIAL_UNITY=1,e.UNITY_HANDSHAKE=2,e.REUNITY=3,e.OPEN_IN_FILE_BROWSER=4,e.CHECK_FILE_RETURNS_OBJ=5,e.PERMISSION_LEVELS=6,e.WEB_DESTINY=7,e.WEB_DESTINY_V2=8,e}()}),define("modules/clean/unity/web_socket",["modules/core/browser","modules/clean/unity/logger","external/web_socket"],function(e,t,n){var i,o;return i=("undefined"!=typeof Constants&&null!==Constants?Constants.IS_PROD:void 0)?17603:17604,o=function(){function o(){}return o.create=function(e){return"function"==typeof n.__initialize&&n.__initialize(),new n(e)},o.load_flash_policy_if_needed=function(){var o;if(o=new t,null!=(null!=n?n.loadFlashPolicyFile:void 0))o.report_event("load_flash_policy_file"),n.loadFlashPolicyFile("xmlsocket://127.0.0.1:"+i);else{if(!e.safari_version_at_most(8))return o.report_event("unity_failure",{message:"Could not use WebSockets."}),!1;o.report_event("using_default_web_socket")}return!0},o.web_sockets_supported=function(){return null!=n},o}()}),define("modules/clean/upsell/ha_loader",["jquery","modules/clean/ajax"],function(e,t){var n;return n={init:function(n,i,o){return i?t.WebRequest({url:"/promo",data:{campaign_id:o,ha_location:n},subject_user:i,success:function(){return function(t){return t&&"no_ad"!==t?e("#ha-container").html(t):void 0}}(this)}):void 0}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/upsell/upsell_controller",["jquery","modules/clean/ajax","modules/clean/dbmodal","modules/core/dom","modules/core/uri"],function(e,t,n,i,o){var r,s,a,l;return r=t.AuthenticatedRequest,s=n.DBModal,a=n.DBModalStack,l=function(){function t(t,n,i){this.options=i,this.post_confirm=__bind(this.post_confirm,this),this.post_dismiss=__bind(this.post_dismiss,this),this.confirm=__bind(this.confirm,this),this.dismiss=__bind(this.dismiss,this),this._dismissUrl=__bind(this._dismissUrl,this),this._confirmUrl=__bind(this._confirmUrl,this),this._keydown=__bind(this._keydown,this),t.length>0&&t.one("click",this.confirm),n.length>0&&n.one("click",this.dismiss),this.options.dismissWithKeys&&e(document).on("keydown",this._keydown)}return t.ON_SHOW_EVENT_NAME="db:prompt:show",t.ON_CONFIRM_EVENT_NAME="db:prompt:confirm",t.ON_DISMISS_EVENT_NAME="db:prompt:dismiss",t.PRE_CONFIRM_EVENT_NAME="db:prompt:pre-confirm",t.PRE_DISMISS_EVENT_NAME="db:prompt:pre-dismiss",t.prototype._keydown=function(t){return 27===t.keyCode||8===t.keyCode&&!i.focus_in_input()?(t.preventDefault(),e(document).off("keydown",this._keydown),this.dismiss(t)):void 0},t.prototype._campaignUrl=function(e){var t;return this.options&&this.options.campaignId?(t=o({path:e}).updateQuery({campaign_id:this.options.campaignId}),t.toString()):void 0},t.prototype._confirmUrl=function(){return this._campaignUrl("/upsell/confirm")},t.prototype._dismissUrl=function(){return this._campaignUrl("/upsell/dismiss")},t.prototype._confirmOrDismiss=function(t,n,i,o){return"keydown"===t.type||i||(t.stopImmediatePropagation(),t.preventDefault()),r({type:"POST",url:n,success:function(n){return function(){return"keydown"===t.type||i||t.target.click(),e(document).trigger(o,{campaignName:n.options.campaignName})}}(this)})},t.prototype.dismiss=function(n){var i;return i=this._dismissUrl(),i&&this._confirmOrDismiss(n,i,!1,t.ON_DISMISS_EVENT_NAME),e(document).trigger(t.PRE_DISMISS_EVENT_NAME,{campaignName:this.options.campaignName})},t.prototype.confirm=function(n){var i;return i=this._confirmUrl(),i&&this._confirmOrDismiss(n,i,this.options.confirmInNewTab,t.ON_CONFIRM_EVENT_NAME),e(document).trigger(t.PRE_CONFIRM_EVENT_NAME,{campaignName:this.options.campaignName})},t.prototype.log_impression=function(){var e;return e=this._campaignUrl("/upsell/log_impression"),e?r({type:"POST",url:e}):void 0},t.prototype.log_event=function(e){var t;return this.options&&this.options.campaignId?(t=o({path:"/upsell/log_event"}).updateQuery({event_name:e,campaign_id:this.options.campaignId}),r({type:"POST",url:t.toString()})):void 0},t.prototype.post_dismiss=function(){var e;return e=this._dismissUrl(),e?r({type:"POST",url:e}):void 0},t.prototype.post_confirm=function(){var e;return e=this._confirmUrl(),e?r({type:"POST",url:e}):void 0},t.register_custom_controller=function(n,i,o,r,s){return e(document).on(t.ON_SHOW_EVENT_NAME,n),e(document).on(t.ON_CONFIRM_EVENT_NAME,i),e(document).on(t.ON_DISMISS_EVENT_NAME,o),e(document).on(t.PRE_CONFIRM_EVENT_NAME,r),e(document).on(t.PRE_DISMISS_EVENT_NAME,s)},t}()});var __hasProp={}.hasOwnProperty;define("modules/clean/user",[],function(){var e;return e=function(){function e(e){var t;for(t in e)__hasProp.call(e,t)&&"string"==typeof t&&"_"!==t[0]&&(this[t]=e[t])}return e.prototype.toString=function(){return String(this.id)},e}()});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},__slice=[].slice;define("modules/clean/validators/validators",["jquery","external/underscore","modules/core/i18n","modules/core/instantiate"],function(e,t,n,i){var o,r,s,a,l,u,c,_,d,p,h,f,m;return f=n._,m={},p=function(e,t){return m[e]=t},d=function(e){var t,n;if(n=e[0],t=e.slice(1),!m[n])throw new Error("Cannot find validator of type "+n);return i.construct(m[n],t)},c=function(){function e(e){this.messages=t.extend({},this.constructor.messages,null!=e?e.messages:void 0)}return e}(),r=function(e){function n(){var e,i,o;o=1<=arguments.length?__slice.call(arguments,0):[],i=null,t.isArray(t.last(o))||(i=t.last(o),o=t.initial(o)),this.validators=function(){var t,n,i;for(i=[],t=0,n=o.length;n>t;t++)e=o[t],null!==e&&i.push(d(e));return i}(),n.__super__.constructor.call(this,i)}return __extends(n,e),n.prototype.validate=function(e,t){var n,i,o,r,s;for(r=this.validators,s=[],i=0,o=r.length;o>i;i++)n=r[i],s.push(n.validate(e,t));return s},n}(c),p("AllValidator",r),o=/^[\x00-\x7f]*$/,s=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.messages={asciiOnly:f("Only basic ASCII characters allowed")},t.prototype.validate=function(e){if(!o.test(e))throw new Error(this.messages.asciiOnly)},t}(c),p("AsciiOnlyValidator",s),u=function(t){function n(e){n.__super__.constructor.call(this,e),this.not_empty=e.not_empty,this.strip=e.strip}return __extends(n,t),n.messages={empty:f("Please enter a value for %(field)s")},n.prototype.validate=function(t,n){if(this.strip&&(t=e.trim(t)),this.not_empty&&!t)throw new Error(this.messages.empty.format({field:null!=n?n.field:void 0}))},n}(c),p("StringValidator",u),l=function(e){function t(e){t.__super__.constructor.call(this,e),this.lastname_goes_first=null!=e?e.lastname_goes_first:void 0}return __extends(t,e),t.messages={empty:f("Please enter your name")},t.prototype.validate=function(e,t){var n;if(!t.data.lname&&!t.data.fname)if(this.lastname_goes_first){if("lname"===t.field)throw new Error(this.messages.empty)}else if("fname"===t.field)throw new Error(this.messages.empty);return"fname"===t.field?(n=d(["StringValidator",{not_empty:!0,strip:!0,messages:{empty:f("Please enter your first name")}}]),n.validate(e,t)):void 0},t}(c),p("NameValidator",l),a=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.messages={empty:f("Please enter an email address"),noAt:f("An email address must contain a single @"),badUsername:f("The username portion of the email address is invalid (the portion before the @: %(username)s)"),badDomain:f("The domain portion of the email address is invalid (the portion after the @: %(domain)s)")},n.username_re=/^[\w!#$%&'*+\-\/=?^`{|}~.]+$/,n.domain_re=new RegExp("^([a-z0-9][a-z0-9\\-]*\\.)+([a-z]+|xn--[a-z0-9\\-]+)$","i"),n.prototype.validate=function(t){var i,r,s;if(t=e.trim(t),!t)throw new Error(this.messages.empty);if(r=t.split("@"),2!==r.length)throw new Error(this.messages.noAt);if(s=r[0],i=r[1],!n.username_re.test(s))throw new Error(this.messages.badUsername.format({username:s}));if(o.test(i)&&!n.domain_re.test(i))throw new Error(this.messages.badDomain.format({domain:i}))},n}(c),p("EmailValidator",a),_=function(e){return function(t,n){var i;i=!0;try{e.validate(t,n)}catch(o){i=!1}return i}},h={create:d,register:p,check:_}}),define("modules/clean/video_util",["jquery","modules/constants/env","modules/constants/viewer","modules/core/browser","modules/core/exception","modules/core/i18n","modules/core/uri","external/flash_detect","external/videojs/video","external/videojs/videojs_hls","modules/clean/ajax"],function(e,t,n,i,o,r,s,a,l,u,c){var _,d,p,h,f,m;return _=t.LIVE_TRANSCODE_SERVER,d=n.UID_PARAM_NAME,h=n.transcoder_hls4web,f=r._,p={_video_counter:0,embed:function(t,n){var o,r,s,a,l,u,_,d,p,h,g,v;if(null==n&&(n={}),!this.can_embed_type(n.type))return null!=n.onError&&setTimeout(function(){return n.onError("needflash")},0),document.createElement("div");for(n.preload="undefined"!=typeof n.preload?n.preload:!0,n.preload&&(n.preload="auto"),r="video-"+this._video_counter,this._video_counter+=1,d=e("<video/>",{"class":"video-js vjs-default-skin vjs-big-play-centered",id:r,controls:n.controls}),d=d[0],g=-1,v=["width","height","preload","poster","autoplay"],p=0,h=v.length;h>p;p++)a=v[p],n[a]&&d.setAttribute(a,n[a]);return l=e("<source/>",{src:n.src,type:n.type}),l=l[0],d.appendChild(l),t=e(t),t.empty(),t=t[0],t.appendChild(d),s=function(){var t,o,r,s;return r=this,n.onError&&r.on("error",n.onError),"function"==typeof n.onReady&&n.onReady(),s=function(){return null!=r.hls?r.hls.fillBuffer():void 0},i&&(i.ipad&&(t=0,e(document).on("dropdownOpened modalOpened",function(n,i){return t+=i,e(r.el_).children("video").removeAttr("controls")}),e(document).on("dropdownClosed modalClosed",function(n,i){return t-=i,0===t?e(r.el_).children("video").attr("controls","controls"):void 0})),i.msie&&"9.0"===i.version&&r.on("playing",function(){return r.removeClass("vjs-seeking")})),"Hls"===r.techName&&r.on("seeked",function(){return r.controlBar.currentTimeDisplay.updateContent()}),r.on("pause",function(){return g=setInterval(s,500),r.ended()?r.removeClass("vjs-has-started"):void 0}),r.on("play",function(){return clearInterval(g),g=-1}),r.on("dispose",function(){return clearInterval(g)}),r.on("ended",function(){return r.src({type:n.type,src:n.src})}),"application/vnd.apple.mpegurl"===n.type&&m(r),o=function(){return r.addClass("show-truncated-bar")},!n.metadata&&n.metadata_link?c.AuthenticatedRequest({url:n.metadata_link,type:"GET",data:{},xhrFields:{withCredentials:!0},success:function(e){return"function"==typeof n.metadata_cb&&n.metadata_cb(e),e=JSON.parse(e),e.is_truncated?o.defer():void 0}}):n.metadata&&n.metadata.is_truncated?o.defer():void 0},_=f("The clip displayed here is a preview. To view the entire video, download or add it to your Dropbox."),Constants.transcoder_hls4web&&(videojs.Hls.GOAL_BUFFER_LENGTH=120),videojs.TruncatedBar=videojs.Component.extend(),videojs.TruncatedBar.prototype.options_={loadEvent:"play",components:{}},videojs.TruncatedBar.prototype.createEl=function(){var e;return e=videojs.createEl("div",{className:"truncated-bar",id:"truncated-video-message-bar"}),e.textContent=_,e},videojs.options.children.TruncatedBar={},o={swf:Constants.static_url_video_js_swf,flashVars:{contentType:n.type,hlsDebugLevel:Constants.hls_debug_level}},u=Constants.transcoder_hls4web?["html5","hls","flash"]:["flash"],videojs(d,{flash:o,techOrder:u},s)},can_embed_type:function(e){var t;return""!==("function"==typeof(t=document.createElement("video")).canPlayType?t.canPlayType(e):void 0)?!0:FlashDetect.installed&&FlashDetect.majorAtLeast(10)?"application/vnd.apple.mpegurl"===e||"video/flv"===e||"video/mp4"===e:!1},video_transcode_url:function(e,t,n){var i;return o.assert(e,"video_transcode_url: expected a non-root fq_path"),i=s(h?{path:"/playlist"+e}:{scheme:"https",authority:_,path:"/transcode_video/w/"+(t+e)}),i.updateQuery(d,n.id).toString()}},m=function(e){var t,n,i,o,r,s,a,l,u,_,d,p,h,f,m,g,v,y,b,w,C,S,E,T,k,x,I,A,P,N,O,R,L;for(u=[250,500,1500],o=null,l=null,a=null,g=0,r=-1,i=!1,s=null,n=-1,p=[],v=!0,b=0,t={},C=0,S=u.length;S>C;C++)h=u[C],t[h.toString()]=0;return y=null,w=[],d=100,f=function(){var n,i,o,a,l;for(n={},a=0,l=u.length;l>a;a++)h=u[a],o=t[h.toString()],n[h.toString()]=Math.round(o/b*100)||0;return i={duration:Math.round(1e3*e.duration()),initial_bitrate:u[r]||0,initial_play_wait:s||0,bitrate_percentages:JSON.stringify(n),stalls:g,quality_events:JSON.stringify(p),xhr_errors:JSON.stringify(w),percentage_watched:d},m(),c.AuthenticatedRequest({url:"/video_web_play_log",type:"POST",data:i})},m=function(){var e,c;for(o=null,l=null,a=null,g=0,r=-1,i=!1,s=null,n=-1,p=[],v=!0,b=0,t={},e=0,c=u.length;c>e;e++)h=u[e],t[h.toString()]=0;return y=null,w=[],d=100},T=function(){return R(),f()},N=function(){return R(),d=Math.round(e.currentTime()/e.duration()*100),isFinite(d)||(d=0),f()},L=function(){return v?(y=Date.now(),v=!1):void 0},R=function(){var e;if(!v)return e=Date.now()-y,b+=e,t[u[n].toString()]+=e,v=!0},x=function(){return null===o&&(a=o=Date.now()),l=Date.now()},E=function(){var t;return t=e.hls.selectPlaylist().attributes.BANDWIDTH/1e3,n=u.indexOf(t),r=n,L(),i?void 0:(s=Date.now()-o,i=!0)},k=function(){return R()},P=function(){return l=Date.now()},O=function(){return R(),Date.now()-l>5e3?g+=1:void 0},A=function(t){var i;if(!e.paused())return R(),i=n,n=t.data.level,Date.now()-o<1e3?r=n:p.push([u[i],u[n],Date.now()-a]),a=Date.now(),L()},I=function(){var t,i;if(!(e.ended()||e.error()||e.paused()))return R(),t=e.hls.selectPlaylist().attributes.BANDWIDTH/1e3,n=u.indexOf(t),i=n,Date.now()-o<1e3?r=n:p.push([u[i],u[n],Date.now()-a]),a=Date.now(),L()},e.on("play",x),e.on("pause",k),e.on("canplay",E),e.on("waiting",O),e.on("seeking",P),e.on("ended",T),e.on("shutdown",N),e.on("mediachange",I),"Hls"===e.techName?(_=videojs.Hls.xhr,videojs.Hls.xhr=function(e,t){var n;return n=function(e,n){var i;return e&&(i="",(""===this.responseType||"text"===this.responseType)&&(i=this.responseText),w.push([this.status.toString(),i,n])),t.call(this,e,n)},_.call(this,e,n)}):void 0},p});var __hasProp={}.hasOwnProperty;define("modules/clean/viewer",["modules/core/exception","modules/core/i18n","modules/clean/user"],function(e,t,n){var i,o,r;return o=e.assert,r=t._,
i=function(){function e(e){var t,i,o,r,s,a;for(null==e&&(e={}),this._authed_users={},this._all_users={},o=e._user_data||[],s=0,a=o.length;a>s;s++)r=o[s],i=new n(r),this._all_users[i.id]=i,r._authed&&(this._authed_users[i.id]=i);for(t in e)__hasProp.call(e,t)&&"string"==typeof t&&"_"!==t[0]&&(this[t]=e[t]);this.is_signed_in=o.length>0,this.is_paired=o.length>1,this.deprecated_first_user_in_the_cookie_id&&(this.deprecated_first_user_in_the_cookie=this.get_user_by_id(this.deprecated_first_user_in_the_cookie_id),delete this.deprecated_first_user_in_the_cookie_id),this._load_cached_users()}return e._cached_viewer=null,e.get_viewer=function(){var t;return this._cached_viewer||(t=null,"undefined"!=typeof Constants&&null!==Constants&&(t=Constants._viewer_properties),this._cached_viewer=new e(t)),this._cached_viewer},e.get_role_title=function(e){var t;return t=this.get_viewer(),t.get_title_by_role(e.role)},e.get_root_name=function(e){var t;return t=this.get_viewer(),t.get_root_name_by_role(e.role)},e.prototype.get_user_by_role=function(e,t){var n;return n=this.get_uid_by_role(e),void 0===n?void 0:this.get_user_by_id(n,t)},e.prototype.role_exists=function(e){return void 0!==this.get_uid_by_role(e)},e.prototype.get_user_by_id=function(e,t){var n,i;return o(this.is_uid_associated(e),"User "+e+" is not associated with this viewer"),i=t?this._all_users:this._authed_users,n=i[e],o(n,"User "+e+" is not signed in"),n},e.prototype.is_role_signed_in=function(e){return this.get_uid_by_role(e)in this._authed_users},e.prototype.is_uid_signed_in=function(e){return e in this._authed_users},e.prototype.is_user_signed_in=function(e){return!(!e||!this.is_uid_signed_in(e.id))},e.prototype.is_uid_associated=function(e){return e in this._all_users},e.prototype.get_users=function(e){var t,n,i,o;return i=e?this._all_users:this._authed_users,o=function(){var e;e=[];for(t in i)n=i[t],e.push(n);return e}(),o.sort(function(e){return e.role===Constants.ROLE_PERSONAL?-1:1}),o},e.prototype.get_user_ids=function(e){var t;return function(){var n,i,o,r;for(o=this.get_users(e),r=[],n=0,i=o.length;i>n;n++)t=o[n],r.push(t.id);return r}.call(this)},e.prototype.get_email_by_role=function(e){var t;return t=this.get_user_by_role(e,!0),t&&t.email},e.prototype.get_uid_by_role=function(e){var t,n,i;e===Constants.ROLE_PHOTOS&&(e=this._get_photos_role()),i=this._all_users;for(t in i)if(n=i[t],n.role===e)return t;return void 0},e.prototype.get_title_by_role=function(e){return this.is_paired?e===("undefined"!=typeof Constants&&null!==Constants?Constants.ROLE_PERSONAL:void 0)?r("Personal"):this.team_name:""},e.prototype.get_root_name_by_role=function(e){return this.get_title_by_role(e)||r("Dropbox")},e.prototype._get_photos_role=function(){return this.is_paired||!this.is_signed_in?Constants.ROLE_PERSONAL:this._values(this._all_users)[0].role},e.prototype._sign_in_all_users=function(){return this._authed_users=this._shallow_clone(this._all_users),this._load_cached_users()},e.prototype._sign_out_user_by_id=function(e){return delete this._authed_users[e],this._load_cached_users()},e.prototype.sign_in_user_by_id=function(e){return o(this.is_uid_associated(e),"User "+e+" is not associated with this viewer"),this._authed_users[e]=this._all_users[e],this._load_cached_users()},e.prototype._values=function(e){var t,n;n=[];for(t in e)n.push(e[t]);return n},e.prototype._shallow_clone=function(e){var t,n;n={};for(t in e)n[t]=e[t];return n},e.prototype._load_cached_users=function(){return this.personal_user=this._authed_users[this.get_uid_by_role(Constants.ROLE_PERSONAL)],this.photos_user=this._authed_users[this.get_uid_by_role(Constants.ROLE_PHOTOS)],this.work_user=this._authed_users[this.get_uid_by_role(Constants.ROLE_WORK)],this.personal_email=this.get_email_by_role(Constants.ROLE_PERSONAL),this.work_email=this.get_email_by_role(Constants.ROLE_WORK),this.is_personal_user_signed_in=this.is_role_signed_in(Constants.ROLE_PERSONAL),this.is_photos_user_signed_in=this.is_role_signed_in(Constants.ROLE_PHOTOS),this.is_work_user_signed_in=this.is_role_signed_in(Constants.ROLE_WORK)},e}()}),define("modules/clean/web_timing_logger",["modules/clean/ajax","modules/clean/event_load","modules/core/browser","modules/core/exception"],function(e,t,n){var i;return i={init:function(e,n){return this.log_time_to_interactive=null!=e?e:!1,this.source_type=null!=n?n:"web",window.performance?(this.initialized=!0,this.have_logged_web_timing=!1,this.time_to_interactive=null,t.window_load(function(){return setTimeout(i._log_navigation,0)})):void 0},reset:function(){return this.log_time_to_interactive=!1,this.source_type="web",this.initialized=!1,this.have_logged_web_timing=!1,this.time_to_interactive=null},_log_navigation:function(){var e,t,n,o,r,s;if(i.initialized&&!i.have_logged_web_timing&&(!i.log_time_to_interactive||i.time_to_interactive)&&(r=window.performance&&window.performance.timing,r&&(o=r.navigationStart||r.fetchStart,e=r.loadEventEnd,o&&e)))return i.have_logged_web_timing=!0,t={},Constants.GSLB_ENABLED&&(t.gslb_enabled=!0),Constants.IS_SPDY&&(t.is_spdy=!0),s=i.log_time_to_interactive?i.time_to_interactive-o:null,n={navigation_type:i._get_navigation_type(),server_request_start_time:Constants.REQUEST_START_TIME,redirect_time:r.fetchStart-o,dns_time:r.domainLookupEnd-o,tcp_connect_time:(r.secureConnectionStart||r.requestStart)-o,ssl_connect_time:r.requestStart-o,time_to_first_byte:r.responseStart-o,dom_load_time:r.domContentLoadedEventEnd-o,page_load_time:e-o,extra_columns:JSON.stringify(t)},i.log_time_to_interactive&&(n.time_to_interactive=s),i._log(n)},mark_time_to_interactive:function(){return this.time_to_interactive=(new Date).getTime(),this._log_navigation()},log_ajax_transition:function(e,t,n,o,r,s){var a;return a={navigation_type:"ajax",page_load_time:e,url:s},null!=r&&(a.server_response_time=r),Constants.GSLB_ENABLED&&(n=n||{},n.gslb_enabled=!0),null!=n&&(a.extra_columns=JSON.stringify(n)),null!=o&&(a.stopwatch_suffix=o),i._log(a,t)},_log:function(t,i,o){return null==o&&(o="/web_timing_log"),t.url=t.url||n.get_href(),t.request_id=Constants.REQUEST_ID,t.source_type=this.source_type,t.request_tracing_enabled=Constants.REQUEST_TRACING_ENABLED,i&&(t.url_info=i),e.AuthenticatedRequest({url:o,type:"POST",data:t})},_get_navigation_type:function(){switch(window.performance.navigation.type){case 0:return"navigate";case 1:return"reload";case 2:return"back_forward"}}}}),define("modules/constants/env",[],function(){return EnvConstants||{}}),define("modules/constants/python",[],function(){return PythonConstants||{}}),define("modules/constants/request",[],function(){return RequestConstants||{}}),define("modules/constants/viewer",[],function(){return ViewerConstants||{}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/core/browser",["modules/constants/env","modules/core/exception","modules/core/uri"],function(e,t,n){var i,o,r,s,a;return o=t.assert,a=function(e){var t,n,i;return e=e.toLowerCase(),t=/(ipad)/.exec(e)||/(edge)[ \/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident).*? rv:([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[],n=null!=(i=e.match(/version\/([\d.]+)/i))?i[1]:void 0,{browser:t[1]||"",version:n||t[2]||"0"}},r=a(navigator.userAgent),"trident"===r.browser&&(r.browser="msie"),s=e.REDIRECT_SAFE_ORIGINS,i={version:r.version,msie_version_at_most:function(e){return i.msie&&parseInt(i.version,10)<=e},safari_version_at_most:function(e){return i.safari&&parseInt(i.version,10)<=e},get_uri:function(e){return null==e&&(e=window),n.parse(this.get_href(e))},get_href:function(e){return null==e&&(e=window),e.location.href},_parse_target:function(e,t){var i,r,a,l,u,c;return null==t&&(t=window),a=t.document.createElement("a"),a.href=e,u=":"===a.protocol?t.location.protocol:a.protocol||t.location.protocol,i=a.hostname||t.location.hostname,l=0===a.pathname.indexOf("/")?a.pathname:"/"+a.pathname,e=u+"//"+i+l+a.search+a.hash,r=n.parse(String(e)),o((c=r.authority,__indexOf.call(s,c)>=0&&"https"===r.scheme),"Target URI must be secure and in domain whitelist"),r},open_tab:function(e){var t;return t=this._parse_target(e),window.open(t.toString(),"_blank")},redirect:function(e,t){var n;return null==t&&(t=window),n=this._parse_target(e,t),t.location.href=n.toString()},replace_location:function(e){var t;return t=this._parse_target(e),window.location.replace(t.toString())},reload:function(){return window.location.reload()},unsafeRedirect:function(e){var t,i,r;return t=n.parse(String(e)),o("data"!==(null!=(i=t.scheme)?i.toLowerCase():void 0)&&"javascript"!==(null!=(r=t.scheme)?r.toLowerCase():void 0),"Target URI can't be a Javascript/data URI"),window.location.href=t.toString()},is_high_density_display:function(){var e;return window.matchMedia?(e="(-webkit-min-device-pixel-ratio: 1.1), (min-resolution: 192dpx), (min-resolution: 1.1dppx)",!!window.matchMedia(e).matches):window.devicePixelRatio?window.devicePixelRatio>1.1:!1}},i[r.browser]=!0,i.browser_name=r.browser,i.iphone=!!/(iphone)/.exec(window.navigator.userAgent.toLowerCase()),i.ipod=!!/(ipod)/.exec(window.navigator.userAgent.toLowerCase()),i.iOS=i.ipad||i.ipod||i.iphone,i.ipad?(i.webkit=!0,i.safari=!0):i.chrome?i.webkit=!0:i.webkit&&(i.safari=!0),i}),define("modules/core/controller_registry",["jquery","modules/core/exception","modules/core/instantiate"],function(e,t,n){var i,o,r,s;return o=t.assert,s=n.construct,r=function(t,n,i){var o,r,a,l;for(o=[t].concat(i),a=0,l=t.length;l>a;a++)r=t[a],e(r).data("jscontroller",s(n,o));return t},i=function(){function t(){}return t.controllers={},t.register_controller=function(e,t,n){return this.controllers[e]={constructor:t,args:n},this.find_and_bind_controller(e)},t.bind_controller=function(e){var t,n;return t=e.data("js-component-id"),o(this.controllers[t],"No controller for "+t),n=this.controllers[t],r(e,n.constructor,n.args)},t.find_and_bind_controller=function(t){var n,i;return o(this.controllers[t],"No controller for "+t),i=this.controllers[t],n=e("[data-js-component-id='"+t+"']"),r(n,i.constructor,i.args)},t}()});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/core/cookies",["modules/core/exception"],function(e){var t,n,i,o,r,s,a,l,u,c,_,d,p;return i=/^([0-9]{1,3}\.){3}[0-9]{1,3}$/,o=function(e){var t,n,o,r,s;if(e.match(i))return[e];for(t=e.split("."),o=[],n=r=0,s=t.length;s>=0?s>r:r>s;n=s>=0?++r:--r)o.push(t.slice(n).join("."));return o},r=function(e){var t,n,i,o,r,s;for(t=e.split("/"),o=[],n=r=0,s=t.length;s>=0?s>r:r>s;n=s>=0?++r:--r)i=t.slice(0,t.length-n).join("/"),""!==i&&o.push(i),o.push(i+"/");return o},s=function(e){var t,n,i,o;if(null==e)return!1;for(o=["=",";"],n=0,i=o.length;i>n;n++)if(t=o[n],__indexOf.call(e,t)>=0)return!0;return!1},p=function(t,n,i){null==i&&(i=!1),e.assert("string"==typeof t,""+n+" must be a string, but was "+typeof t),e.assert(i||(null!=t?t.length:void 0)>0,""+n+" must not be empty"),e.assert(!s(t),""+n+" contains illegal characters")},c=function(e){return p(e,"Cookie name",!1)},d=function(e){return p(e,"Cookie value",!0)},u=function(e){return p(e,"Cookie expiration date",!1)},l=function(e){return p(e,"Cookie domain",!1)},_=function(e){return p(e,"Cookie path",!1)},a=function(e,t,n){null==n&&(n={}),c(e),d(t),null!=n.expires&&u(n.expires),null!=n.domain&&l(n.domain),null!=n.path&&_(n.path),document.cookie=[""+e+"="+t,null!=n.expires?"expires="+n.expires:void 0,null!=n.domain?"domain="+n.domain:void 0,null!=n.path?"path="+n.path:void 0].join("; ")},n=new Date(1).toUTCString(),t={create:function(t,n,i){var o,r;null!=i&&(e.assert("number"==typeof i,"Cookie expiration must be a number"),o=new Date,o.setTime(o.getTime()+24*i*60*60*1e3),r=o.toUTCString()),a(t,n,{expires:r,path:"/"})},read:function(e){var t,n,i,o,r,s,a,l,u,_,d;for(c(e),r=[],_=document.cookie.split(";"),s=0,l=_.length;l>s;s++)t=_[s],i=t.split("=",1)[0],i.trim()===e&&r.push(t.substring(i.length+1,t.length).trim());for(d=r.sort(),n=a=0,u=d.length;u>a;n=++a)if(o=d[n],""!==o||n===r.length-1)return o;return null},"delete":function(e){var t,i,s,l,u,c,_,d;for(i=[null].concat(o(window.location.hostname)),l=[null].concat(r(window.location.pathname)),u=0,_=i.length;_>u;u++)for(t=i[u],c=0,d=l.length;d>c;c++)s=l[c],a(e,"",{expires:n,domain:t,path:s})},are_enabled:function(){return null!=navigator.cookieEnabled?navigator.cookieEnabled:(document.cookie="this_is_a_test_cookie",-1!==document.cookie.indexOf("this_is_a_test_cookie"))}}}),define("modules/core/dom",["jquery","modules/core/controller_registry","modules/core/exception"],function(e,t,n){var i,o,r,s,a,l,u,c,_,d,p,h,f,m,g,v,y,b,w,C,S,E,T,k,x;return i=n.assert,o=function(n){var i,r,s,l;for(l=n.children(),r=0,s=l.length;s>r;r++)i=l[r],o(e(i));return!a(n)&&n.data("js-component-id")?t.bind_controller(n):void 0},r=function(e){var t;return i(e,"Trying to clone nonexistent element"),t=e.clone(),o(t),t},a=function(e){return e.data("jscontroller")},w=function(e,t){return e.data("jscontroller",t)},d=function(e){return e?1===e.nodeType?!0:e.length>=1&&1===e[0].nodeType?!0:!1:!1},c=function(){return p(document.activeElement)},p=function(e){var t,n;return("INPUT"===(t=null!=e?e.tagName:void 0)||"TEXTAREA"===t||"SELECT"===t)&&"submit"!==(n=null!=e?e.type:void 0)&&"button"!==n||_(e)},_=function(e){return(null!=e?e.hasAttribute:void 0)&&(null!=e?e.hasAttribute("contenteditable"):void 0)&&"false"!==(null!=e?e.getAttribute("contenteditable").toLowerCase():void 0)},S=function(t){var n,i,o;return n=e(t),o=n.offset(),i=e(window),{left:o.left-i.scrollLeft(),top:o.top-i.scrollTop()}},T=null,k=null,C=function(){return T||(T={height:e(window).height(),width:e(window).width()}),k||(k=e(window).on("resize",function(){return T=null})),T},l=function(){return Math.max(e(document).height(),e(window).height(),document.documentElement.clientHeight)},x=null,E=null,v=function(){var t,n,i;return x||(x=e(window).scroll(function(){return E=null})),h()?E||(i=e(window).scrollTop(),n=e(window).scrollLeft(),E={0:n,1:i,left:n,top:i}):(t=e("body"),i=-1*parseInt(t.css("top"),10),n=-1*parseInt(t.css("left"),10),E={0:n,1:i,left:n,top:i}),E},f=function(){return E=null},h=function(){return!e("body").hasClass("no-scroll")},g=0,m=function(){var t,n,i,o;return g++,t=e("body"),t.hasClass("no-scroll")?void 0:(o=v(),i=-1*o.top+"px",n=-1*o.left+"px",t.css({top:i,left:n}),t.addClass("no-scroll"))},b=function(){var t,n,i;return g>0&&g--,t=e("body"),0===g&&t.hasClass("no-scroll")?(i=-1*parseInt(t.css("top"),10),n=-1*parseInt(t.css("left"),10),t.css({top:"",left:""}),t.removeClass("no-scroll"),y(n,i+1),y(n,i-1),y(n,i)):void 0},y=function(t,n){var i,o,r;return t=Math.max(t,0),n=Math.max(n,0),n>v().top&&(n=Math.min(n,l()-u.viewport_dimensions().height)),h()?(window.scrollTo(t,n),E={0:t,1:n,left:t,top:n}):(r=-1*n+"px",o=-1*t+"px",i=e("body"),i.css({top:r,left:o}))},s=function(t,n,i){var o,r,s,a,l,u,c,_;return r=e(n),s=e(t),u={setLeft:!0,setTop:!0,setWidth:!0,setHeight:!0,offsetTop:0,offsetLeft:0},i=e.extend({},u,i),_=S(r),c={top:0,left:0},o=null,"absolute"===s.css("position")&&(o=s.offsetParent(),c=S(o)),o&&o[0]===document.body&&(c.left-=document.body.offsetLeft,c.top-=document.body.offsetTop),i.setLeft&&(a=_.left-c.left+i.offsetLeft+"px",s.css("left",a)),i.setTop&&(l=_.top-c.top+i.offsetTop+"px",s.css("top",l)),i.setWidth&&s.width(r[0].offsetWidth),i.setHeight&&s.height(r[0].offsetHeight),s},S=function(t){var n,i,o;return n=e(t),o=n.offset(),i=e(window),{left:o.left-i.scrollLeft(),top:o.top-i.scrollTop()}},u={bind_controllers:o,clone:r,clone_position:s,controller:a,document_height:l,focus_in_input:c,is_input:p,is_content_editable:_,is_page_scrollable:h,scroll_clear_cache:f,scroll_lock_document:m,scroll_offsets:v,scroll_to:y,scroll_unlock_document:b,set_controller:w,is_element:d,viewport_offset:S,viewport_dimensions:C}}),define("modules/core/exception",["modules/core/exception_tag_registry"],function(e){var t,n;return n=e.get_registered_tags,t=function(){function e(){}return e.SEVERITY={CRITICAL:"critical",NONCRITICAL:"non-critical"},e.strip_comments=function(e){return e.replace(/\/\/.*/g,"").replace(/\/\*[\s\S]*?\*\//g,"")},e.fn_body=function(t){var n;return n=e.strip_comments(t.toString()),n=n.replace(/[\s]+/g," "),"("===n[0]&&(n=n.substr(1)),")"===n[n.length-1]&&(n=n.substr(0,n.length-1)),n=n.replace("function (","function(")},e.stackTrace=function(){var t,n,i,o,r;for(o=[],r={},t=arguments.callee.caller;t;){if(t.__tb_ajax_info__){o.unshift("Ajax.DBRequest: "+t.__tb_ajax_info__);break}if(t.__tb__){o=t.__tb__.concat(o);break}if(i=e.fn_body(t),i in r)break;r[i]=!0,o.unshift(i);try{t=t.caller}catch(s){n=s,t=null;break}}return o},e.__callbacks=[],e.registerOnFailedAssert=function(e){return this.__callbacks.push(e)},e.reportException=function(t){var i,o,r,s,a,l,u,c,_,d,p;if(s=t.msg,d=t.url,r=t.line,_=t.tb,o=t.force,c=t.tags,a=t.severity,__CIRCULAR_DEPENDENCY__.active_user_loaded?__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading=!0:__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading=!0,!this.reported_exception||o){if(u="",!_)try{l=e.stackTrace(),l.pop(),l.pop(),_=l.join("\\n")}catch(h){}if(c||(c=[]),c=c.concat(n()),i={e:s,f:d||window.location.href,l:r||"",loc:window.location.href,ref:"undefined"!=typeof Constants&&null!==Constants?Constants.referrer:void 0,tb:_,trace:null!=(p=__CONDITIONAL_JS__.Trace)?p.get():void 0,tags:JSON.stringify(c),sev:a||""},"undefined"!=typeof jQuery&&null!==jQuery&&"function"==typeof jQuery.ajax&&jQuery.ajax({url:"/jse",type:"POST",data:i}),this.reported_exception=s,!("undefined"!=typeof Constants&&null!==Constants?Constants.IS_PROD:void 0)&&window.sessionStorage)return i.source="exception.coffee",window.sessionStorage.setItem("reported_exception",JSON.stringify(i))}},e.alert=function(t){return"undefined"!=typeof jQuery&&null!==jQuery&&"function"==typeof jQuery.ajax&&jQuery.ajax({url:"/tormod",type:"POST",data:{tor:""+t,mod:window.location.href,ssk:e.stackTrace().join("\n\n"),oog:document.documentElement.innerHTML}}),window.alertd(t)},e.alertd=function(e){return window.alertd(e)},e.assert=function(t,n,i,o,r,s){var a,l,u,c,_;if(null==n&&(n=""),null==i&&(i=!0),null==o&&(o=[]),null==r&&(r=!0),null==s&&(s=!("undefined"!=typeof Constants&&null!==Constants?Constants.IS_PROD:void 0)),!t){for(n="Assertion Error: "+n,s&&"undefined"!=typeof console&&null!==console&&"function"==typeof console.trace&&console.trace(),("undefined"!=typeof Constants&&null!==Constants?Constants.IS_PROD:void 0)||window.alertd(n),l=e.stackTrace(),l.pop(),e.reportException({msg:n,url:window.location.href,tb:l.join("\n"),force:i,tags:o}),_=e.__callbacks,u=0,c=_.length;c>u;u++)(a=_[u])(n,l);if(r)throw new Error(n)}},e}(),window.alertd=window.alert,window.alert=t.alert,__CONDITIONAL_JS__.JSException=t,t});var __hasProp={}.hasOwnProperty;define("modules/core/exception_tag_registry",[],function(){var e,t;return t={},e={},e.get_registered_tags=function(){var e,n;return function(){var i;i=[];for(e in t)__hasProp.call(t,e)&&(n=t[e],i.push(e));return i}()},e.register_tag=function(e){return t[e]=!0},e.unregister_tag=function(e){return delete t[e]},e}),define("modules/core/html",["jquery","external/underscore"],function(e,t){var n;return n=function(){function e(e){this._str_DONT_TOUCH=e}return e.prototype.toHTML=function(){return this._str_DONT_TOUCH},e.prototype.toString=function(){return"[object HTML]"},e}(),function(){var i,o,r,s;return n.tmpl=function(i,o){var r,s,a,l,u;return/[^\w:.-]/.test(i)||(r=document.getElementById(i),i=r.innerHTML,null!=(null!=(u=window.Constants)?u.CSP_SCRIPT_NONCE:void 0)&&window.Constants.CSP_SCRIPT_NONCE!==r.getAttribute("nonce")&&(i="")),a=i.replace(/[\r\t\n]/g," ").replace(/'(?=[^%]*%>)/g,"	").split("'").join("\\'").split("	").join("'").replace(/<%=(.*?)%>/g,"',__no_conflict_HTML__._raw_escape($1),'").split("<%").join("');").split("%>").join("p.push('"),l=new Function("__no_conflict_HTML__","__no_conflict_jQuery__","TEMPLATE_DATA","var p=[],print=function(){p.push.apply(p,arguments);}; window.MONKEY_CHECK_OFF = true; p.push('"+a+"'); window.MONKEY_CHECK_OFF = false; return new __no_conflict_HTML__(__no_conflict_jQuery__.trim(p.join('')));"),s=t.partial(l,n,e),o?s(o):s},i=/[^\w@\.\ \-\(\)\,\$~%#\[\]\{\}\!\^]/g,r=function(e){return"&#"+e.charCodeAt(0)+";"},o=function(e){return(""+e).replace(i,r)},n.escape=function(e){return e instanceof n?e:new n(o(e))},n._raw_escape=s=function(e){return e instanceof n?e.toHTML():"number"==typeof e?e:o(e)}}(),n});var __slice=[].slice;define("modules/core/i18n",["modules/core/kwargs","modules/core/exception","external/sha1"],function(e,t){var n,i,o,r,s,a,l,u,c,_,d,p,h;for(d=t.assert,r="abcdefghijklmnopqrstuvwxyz",s="Ã¢á¸Äá¸Ã¨á¸Äá¸«Ã­ÄµÇ©Äºá¹ÅÅá¹ÉÅÅá¹­Å¯á¹¿áºáºáºáº",c="ABCDEFGHIJKLMNOPQRSTUVWXYZ",_="á¸á¸á¸á¸á¸á¸á¸ á¸¢á¸¬Ä´á¸´Ä»á¸¾ÅÃá¹ÉÅá¹ á¹®Å¨á¹¼áºáºÅ¸Æµ",n={},p=h=0;26>h;p=++h)n[r.charAt(p)]=s.charAt(p),n[c.charAt(p)]=_.charAt(p);return i=function(){function t(){}return t.messages={},t.emessages={},t.RAND=0,t.NUM_MISSED=0,t.add_i18n_message=function(e,t,n,i){return t=t.strip_tags().friendly_format(),n=n.strip_tags(),this.messages[t]=e,this.emessages[t]=n,i?(delete this.messages[i],delete this.emessages[i]):void 0},t.PLURAL_RULES={SINGULAR_1:function(e){return 1===e?0:1},SINGULAR_01:function(e){return 1>=e?0:1},SINGULAR_ALL:function(){return 0},RUSSIA_UKRAINE:function(e){return e%10===1&&e%100!==11?0:e%10>=2&&4>=e%10&&(10>e%100||e%100>=20)?1:2},POLAND:function(e){return 1===e?0:e%10>=2&&4>=e%10&&(10>e%100||e%100>=20)?1:2}},t.PLURAL_RULES_BY_LOCALE={en:t.PLURAL_RULES.SINGULAR_1,en_GB:t.PLURAL_RULES.SINGULAR_1,da_DK:t.PLURAL_RULES.SINGULAR_1,de:t.PLURAL_RULES.SINGULAR_1,es_ES:t.PLURAL_RULES.SINGULAR_1,es:t.PLURAL_RULES.SINGULAR_1,fr:t.PLURAL_RULES.SINGULAR_01,id:t.PLURAL_RULES.SINGULAR_ALL,it:t.PLURAL_RULES.SINGULAR_1,ja:t.PLURAL_RULES.SINGULAR_ALL,ko:t.PLURAL_RULES.SINGULAR_ALL,ms:t.PLURAL_RULES.SINGULAR_ALL,nb_NO:t.PLURAL_RULES.SINGULAR_1,nl_NL:t.PLURAL_RULES.SINGULAR_1,pl:t.PLURAL_RULES.POLAND,pt_BR:t.PLURAL_RULES.SINGULAR_01,ru:t.PLURAL_RULES.RUSSIA_UKRAINE,sv_SE:t.PLURAL_RULES.SINGULAR_1,th_TH:t.PLURAL_RULES.SINGULAR_ALL,tr:t.PLURAL_RULES.SINGULAR_ALL,uk_UA:t.PLURAL_RULES.RUSSIA_UKRAINE,xx_AC:t.PLURAL_RULES.SINGULAR_1,xx_LS:t.PLURAL_RULES.SINGULAR_1,xx_HA:t.PLURAL_RULES.SINGULAR_1,xx_RL:t.PLURAL_RULES.SINGULAR_1,xx_AE:t.PLURAL_RULES.SINGULAR_1,xx_SL:t.PLURAL_RULES.SINGULAR_1,zh_CN:t.PLURAL_RULES.SINGULAR_ALL,zh_TW:t.PLURAL_RULES.SINGULAR_ALL},t.PERCENT_FORMAT={SUFFIX:function(e){return"%(percent)s%".format({percent:e})},PREFIX:function(e){return"%"+"%(percent)s".format({percent:e})},SUFFIX_SPACE:function(e){return"%(percent)sÂ %".format({percent:e})}},t.PERCENT_FORMAT_BY_LOCALE={en:t.PERCENT_FORMAT.SUFFIX,en_GB:t.PERCENT_FORMAT.SUFFIX,da_DK:t.PERCENT_FORMAT.SUFFIX_SPACE,de:t.PERCENT_FORMAT.SUFFIX_SPACE,es_ES:t.PERCENT_FORMAT.SUFFIX,es:t.PERCENT_FORMAT.SUFFIX,fr:t.PERCENT_FORMAT.SUFFIX_SPACE,id:t.PERCENT_FORMAT.SUFFIX,it:t.PERCENT_FORMAT.SUFFIX,ja:t.PERCENT_FORMAT.SUFFIX,ko:t.PERCENT_FORMAT.SUFFIX,ms:t.PERCENT_FORMAT.SUFFIX,nb_NO:t.PERCENT_FORMAT.SUFFIX_SPACE,nl_NL:t.PERCENT_FORMAT.SUFFIX,pl:t.PERCENT_FORMAT.SUFFIX,pt_BR:t.PERCENT_FORMAT.SUFFIX,ru:t.PERCENT_FORMAT.SUFFIX_SPACE,sv_SE:t.PERCENT_FORMAT.SUFFIX_SPACE,th_TH:t.PERCENT_FORMAT.SUFFIX,tr:t.PERCENT_FORMAT.PREFIX,uk_UA:t.PERCENT_FORMAT.SUFFIX,xx_AC:t.PERCENT_FORMAT.SUFFIX,xx_LS:t.PERCENT_FORMAT.SUFFIX,xx_HA:t.PERCENT_FORMAT.SUFFIX,xx_RL:t.PERCENT_FORMAT.SUFFIX,xx_AE:t.PERCENT_FORMAT.SUFFIX,zh_CN:t.PERCENT_FORMAT.SUFFIX,zh_TW:t.PERCENT_FORMAT.SUFFIX},t.get_langpack=function(){return window.LANGPACK||(window.LANGPACK={}),window.LANGPACK},t._convert_project_comment=function(e,t){var n,i,o,r;for(r=[e,t],i=0,o=r.length;o>i;i++)n=r[i],"object"==typeof n&&(null!=n&&"project"in n&&(e=n.project),null!=n&&"comment"in n&&(t=n.comment));return"string"!=typeof e&&(e="web"),"string"!=typeof t&&(t=null),[e,t]},t._=function(){var n,i,r,s,a,l,u,c,_,d;return u=arguments[0],n=2<=arguments.length?__slice.call(arguments,1):[],_=e.apply(null,[[["project","web"],"comment"]].concat(__slice.call(n))),a=_.project,i=_.comment,d=t._convert_project_comment(a,i),a=d[0],i=d[1],("undefined"!=typeof Constants&&null!==Constants?Constants.USER_LOCALE:void 0)&&t.locale_is_fake(Constants.USER_LOCALE)?l=t.fake_translate(u,"undefined"!=typeof Constants&&null!==Constants?Constants.USER_LOCALE:void 0):(c=o.get_string_key(u,a,i),r=t.get_langpack(),s=r[c]||r[u],s?l=s instanceof String||"string"==typeof s?s:s[0]||u:(0===t.RAND&&"undefined"!=typeof Constants&&null!==Constants&&"en"!==Constants.USER_LOCALE&&(t.RAND=Math.floor(20*Math.random()+1)),1===t.RAND&&t.NUM_MISSED<4&&(t.NUM_MISSED+=1,"undefined"!=typeof jQuery&&null!==jQuery&&jQuery.ajax({url:"/missed_translation_log",type:"POST",data:{message:u,comment:i,project:a}})),l=u)),t.add_i18n_message(u,l,u),l},t.fake_translate=function(e,t){var i,o,r,s,a,l,u;if("xx_LS"===t&&(e+="SSSSSSSSSSSSSSSSSSSSSSSSS"),"xx_AC"!==t||/</.test(e)||(e=e.toUpperCase()),"xx_HA"===t&&(e="[javascript]"+e),"xx_RL"===t&&!/</.test(e)&&!/%/.test(e)){for(s=97,r=1488,a="",e=e.toLowerCase(),p=l=0,u=e.length;u>=0?u>l:l>u;p=u>=0?++l:--l)i=e.charCodeAt(p)-s,a+=i>=0&&26>i?String.fromCharCode(r+i):e[p];e=a}return"xx_AE"!==t||/</.test(e)||/%/.test(e)||(e=function(){var t,i,r,s;for(s=[],p=t=0,i=e.length;i>=0?i>t:t>i;p=i>=0?++t:--t)o=e.charAt(p),s.push(null!=(r=n[o])?r:o);return s}().join("")),e},t.locale_is_fake=function(e){return-1!==e.indexOf("xx_")},t.ungettext=function(){var n,i,r,s,a,l,u,c,_,p,h,f,m,g,v;if(f=arguments[0],c=arguments[1],u=arguments[2],n=4<=arguments.length?__slice.call(arguments,3):[],g=e.apply(null,[[["project","web"],"comment"]].concat(__slice.call(n))),p=g.project,i=g.comment,v=t._convert_project_comment(p,i),p=v[0],i=v[1],d(null!=u,"missing number parameter for ungettext"),a="undefined"!=typeof Constants&&null!==Constants?Constants.USER_LOCALE:void 0)if(t.locale_is_fake(a))f=t.fake_translate(f,a),c=t.fake_translate(c,a);else if(m=o.get_string_key(f,p,i),s=t.get_langpack(),l=s[m]||s[f]){if(l instanceof String||"string"==typeof l)return l;_=t.PLURAL_RULES_BY_LOCALE[a](u),_ in l&&(h=l[_])}return r=1===u?f:c,null==h&&(h=r),t.add_i18n_message(f,h,r),h},t.N_=function(){var n,i,o,r,s,l;return r=arguments[0],n=2<=arguments.length?__slice.call(arguments,1):[],s=e.apply(null,[[["project","web"],"comment"]].concat(__slice.call(n))),o=s.project,i=s.comment,l=t._convert_project_comment(o,i),o=l[0],i=l[1],new a(r,o,i)},t.E_=function(e){return t._(e.msg,e.project,e.comment)},t.render_sentences=function(e){var n,i,o,r,s,a;if(n=e.length,1===n)return e[0];if(2===n)return t._("%s %s",{comment:"Two sentences"}).format(e);if(3===n)return t._("%s %s %s",{comment:"Three sentences"}).format(e);if(4===n)return t._("%s %s %s %s",{comment:"Four sentences"}).format(e);for(i="",r=0,s=0,a=e.length;a>s;s++)o=e[s],i+=o,r!==n-1&&(i+=t._(" ",{comment:"Sentence separator character"})),r+=1;return i},t.format_percent=function(e){var n;return n="undefined"!=typeof Constants&&null!==Constants?Constants.USER_LOCALE:void 0,n?t.PERCENT_FORMAT_BY_LOCALE[n](e):t.PERCENT_FORMAT.SUFFIX(e)},t.i18n_default_project=function(n){return{_:function(){var i,o,r,s;return r=arguments[0],i=2<=arguments.length?__slice.call(arguments,1):[],s=e.apply(null,[[["project",n],"comment"]].concat(__slice.call(i))),n=s.project,o=s.comment,t._(r,n,o)},ungettext:function(){var i,o,r,s,a,l;return a=arguments[0],s=arguments[1],r=arguments[2],i=4<=arguments.length?__slice.call(arguments,3):[],l=e.apply(null,[[["project",n],"comment"]].concat(__slice.call(i))),n=l.project,o=l.comment,t.ungettext(a,s,r,n,o)},N_:function(){var i,o,r,s;return r=arguments[0],i=2<=arguments.length?__slice.call(arguments,1):[],s=e.apply(null,[[["project",n],"comment"]].concat(__slice.call(i))),n=s.project,o=s.comment,t.N_(r,n,o)},E_:t.E_}},t}(),a=function(){function e(e,t,n){this.msg=e,this.project=t,this.comment=n}return e}(),o=function(){function e(){}return e.get_message_context=function(e,t){var n,i,o;return i=void 0,"web"!==e&&(i="project:"+e),null!=t&&(o=new jsSHA(t,"TEXT"),n=o.getHash("SHA-1","HEX"),null!=i?i+=" "+n:i=n),i},e.CONTEXT_DELIMITER="",e.get_string_key=function(t,n,i){var o;return o=e.get_message_context(n,i),null!=o?o+e.CONTEXT_DELIMITER+t:t},e}(),u=function(e){return"undefined"==typeof Array.isArray?"[object Array]"===Object.prototype.toString.call(e):Array.isArray(e)},l=function(){var e,t,n;return e=Array.prototype.slice.call(arguments),t=e.shift(),n=e.shift(),function(){return t.apply(n,e.concat(Array.prototype.slice.call(arguments)))}},String.prototype.format_sub=function(e){return this.replace(/%(\([a-zA-Z0-9_\-]+\))?(.\d+)?(.)/g,l(e,this))},String.prototype.format=function(){var e,t,n,o,r,s;return 0===arguments.length?this.toString():(t=void 0,e=0,t=1===arguments.length&&arguments[0]instanceof Object?arguments[0]:Array.prototype.slice.call(arguments,0),r=function(n,i,o,r){var s,a,l,c;if(i?(i=i.slice(1,-1),d(0>=e,"Cannot mix named and positional indices in string formatting for string '"+this+"'."),e=-1,s="xx_AC"===("undefined"!=typeof Constants&&null!==Constants?Constants.USER_LOCALE:void 0),d(i in t||s&&i.toLowerCase()in t,"Key '"+i+"' not present during string substitution for string '"+this+"'"),c=t[i],s&&(c=t[i.toLowerCase()])):(u(t)||(t=[t]),d(e>-1,"Cannot mix named and positional indices in string formatting for string '"+this+"'."),d(e<t.length,"Insufficient number of items in format for string '"+this+"'"),c=t[e],e++),d("undefined"!=typeof c,"value for key '"+(i||"")+"' is undefined"),l=void 0,"s"===r||"S"===r)l=c.toString();else if("d"===r||"D"===r)l=parseInt(c,10).toString();else if("f"===r||"F"===r)l=Number(c).toString();else{if("%"===r)return"%";d(!1,"Unexpected format character '"+r+"' for string '"+this+"'.")}return o?(o=parseInt(o.slice(1),10),"f"===r||"F"===r?(l.indexOf(!1)&&(l+=".0"),a=l.split("."),a[0]+"."+a[1].slice(0,o)):l.slice(0,o)):l},s=this.format_sub(r),i.messages&&this in i.messages&&(e=0,o=i.emessages[this],n=String.prototype.format_sub.call(o,r),i.add_i18n_message(o,s,n,this)),s)},String.prototype.friendly_format=function(){var e,t,n;return t=function(t,i,o,r){return i?"["+i.slice(1,1).replace("-","_")+"]":"s"===r||"S"===r?"[word"+n++ +"]":"[number"+e++ +"]"},e=1,n=1,this.format_sub(t)},String.prototype.blank_format=function(){var e;return e=function(){return""},this.format_sub(e)},String.prototype.strip_tags=function(){return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")},i}),define("modules/core/instantiate",["modules/core/exception"],function(e){var t,n,i;return t=e.assert,n=function(e,n){var i;return t(e),i=function(){return e.apply(this,n)},i.prototype=e.prototype,new i},i={construct:n}});var __slice=[].slice;define("modules/core/kwargs",[],function(){var e;return e=function(){var e,t,n,i,o,r,s,a,l,u,c;if(r=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],o={},r=function(){var e,t,n;for(n=[],e=0,t=r.length;t>e;e++)s=r[e],n.push("string"==typeof s?{name:s,"default":void 0}:{name:s[0],"default":s[1]});return n}(),(t=function(){var t,n,i,o,s,a,l,u;if(null==e||"object"!=typeof e[e.length-1])return!1;for(i={},t=s=a=e.length-1,l=r.length-1;l>=s;t=s+=1)i[r[t].name]=!0;u=e[e.length-1];for(n in u)if(o=u[n],!(n in i))return!1;return!0})()){u=e[e.length-1];for(i in u)a=u[i],o[i]=a;e.pop()}for(n=l=0,c=r.length-1;c>=l;n=l+=1)n<e.length?o[r[n].name]=e[n]:r[n].name in o||(o[r[n].name]=r[n]["default"]);return o}}),define("modules/core/notify",["jquery","modules/core/i18n"],function(e,t){var n,i;return i=t._,n=function(){function t(){}return t.DEFAULT_ERROR=i("There was a problem completing this request."),t.DEFAULT_SUCCESS=i("Your request completed successfully."),t.success=function(e,t){return null==t&&(t=10),e=e||this.DEFAULT_SUCCESS,this._show(e,t,"server-success"),this.current()},t.error=function(e,t){return null==t&&(t=10),e=e||this.DEFAULT_ERROR,this._show(e,t,"server-error"),
this.current()},t.warning=function(e,t){return null==t&&(t=10),this._show(e,t,"server-warning"),this.current()},t.info=function(e,t){return null==t&&(t=10),this._show(e,t,"server-info"),this.current()},t.clear=function(){return this._last_timeout&&clearTimeout(this._last_timeout),this._last_animation&&this._last_animation.stop(),this._last_timeout=null,this._last_animation=null,e("#notify").removeClass("server-error server-info server-success server-warning").hide()},t.isShown=function(){return e("#notify").is(":visible")},t.current=function(){return this._last_timeout},t._show=function(e,t,n){return this._buildElement(),this.clear(),this._setMessage(e),this._showElement(n),this._scheduleHide(t),this.current()},t._buildElement=function(){var t;if(!e("#notify").length)return t='<div id="notify-wrapper"> <span id="notify"> <span id="notify-msg" /> </span> </div>',e("body").append(t)},t._setMessage=function(t){var n;return n=e("#notify-msg"),null!=t.toHTML?n.html(t.toHTML()):t instanceof e?n.html(t):n.text(t)},t._showElement=function(t){var n;return n=e("#notify"),n.addClass(t),this._last_animation=n.fadeIn(500)},t._scheduleHide=function(e){return this._last_timeout=setTimeout(this._hide,1e3*e)},t._hide=function(){var n;return n=e("#notify"),t._last_animation=n.fadeOut(1e3),t._last_timeout=null},t}(),INLINE_JS.Notify=n,n}),define("modules/core/ordered_dictionary",[],function(){var e;return e=function(){function e(e,t){this.list=e,this.dict=t}return e.list=[],e.dict={},e.prototype.push=function(e,t){this.list.push(e),this.dict[e]=t},e.prototype.remove=function(e){this.list.removeItem(e),delete this.dict[e]},e.prototype.indexOfKey=function(e){return this.list.indexOf(e)},e.prototype.keyAtIndex=function(e){return this.list[e]},e.prototype.valueFromKey=function(e){return this.dict[e]},e.prototype.valueAtIndex=function(e){return this.dict[this.list[e]]},e.prototype.getValues=function(){var e;return function(){var t,n,i,o;for(i=this.list,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(this.dict[e]);return o}.call(this)},e.prototype.length=function(){return this.list.length},e.prototype.insertAtIndex=function(e,t,n){return this.list.splice(e,0,t),this.dict[t]=n},e}()}),define("modules/core/uri",["modules/core/exception"],function(e){var t,n,i;return i=e.assert,n=function(){function e(n,i){var o,r,s,a;if(!(this instanceof e))return new e(n,i);if(this._query=new t,s={},"string"==typeof n||n instanceof e){if(!("undefined"!=typeof Constants&&null!==Constants?Constants.IS_PROD:void 0))throw new Error("URI/uri string passed into URI constructor.  Use URI.parse instead.");s=e.parse(n).toObject()}else"object"==typeof n&&(s=n);if(i&&!("undefined"!=typeof Constants&&null!==Constants?Constants.IS_PROD:void 0))throw new Error("Multiple arguments passed into URI constructor.");r=i||{};for(o in r)a=r[o],s[o]=a;this.initFromObject(s)}return e.prototype.initFromObject=function(e){var t,n,i;return i=null!=e?e:{},n=i.scheme,this.authority=i.authority,this.path=i.path,t=i.query,this.fragment=i.fragment,this.setScheme(n),this.setQuery(t)},e.parse=function(n){var o,r,s,a,l,u,c,_;return i(null!=n,"must pass in a valid url-encoded string"),o=String(n).match(e.REGEXP)||[],_=o[0],c=o[1],s=o[2],l=o[3],u=o[4],a=o[5],r=new e,r.setScheme(c),r.setAuthority(e.decode(s)),r.setPath(e.decode(l)),r.setQuery(t.parse_string(u)),r.setFragment(e.decode(a)),r},e.prototype.getScheme=function(){return this.scheme||""},e.prototype.setScheme=function(t){return i(!t||t.match(e.SCHEME_REGEXP,"Invalid scheme")),this.scheme=t,this},e.prototype.getAuthority=function(){return this.authority||""},e.prototype.setAuthority=function(e){return this.authority=e,this},e.prototype.getPath=function(){return this.path||""},e.prototype.setPath=function(e){return this.path=e,this},e.prototype.getFragment=function(){return this.fragment||""},e.prototype.setFragment=function(e){return this.fragment=e,this},e.prototype.getQuery=function(){return this._query.dict},e.prototype.setQuery=function(e){return null==e&&(e={}),this._query=new t(e),this},e.prototype.updateQuery=function(e,t){return null==t&&(t=null),this._query.add(e,t),this},e.prototype.removeQuery=function(e){return this._query.remove(e),this},e.prototype.clone=function(){return e(this.toObject())},e.prototype.toObject=function(){return{scheme:this.getScheme(),authority:this.getAuthority(),path:this.getPath(),query:this.getQuery(),fragment:this.getFragment()}},e.prototype.toString=function(){var t,n;return n="",this.scheme&&(n+=this.scheme+":"),this.authority&&(n+="//"+e.encode(this.authority,":@[]")),this.path&&(i(!this.authority||!this.path.length||"/"===this.path[0],'Path must start with a "/" if URI is not relative'),n+=e.encode(this.path,"/")),t=this._query.toString(),t&&(n+="?"+t),this.fragment&&(n+="#"+e.encode(this.fragment,":@[]/&=+?#!")),n},e.REGEXP=/^(?:([^:/\\?#]+):)?(?:[/\\]{2}([^/\\?#]*))?([^?#]*)(?:\?([^#]*))?(?:[#](.*))?$/,e.SCHEME_REGEXP=/^[a-zA-Z][a-zA-Z0-9+.\-]*$/,e.decode=function(e){return e?decodeURIComponent(e):""},e.encode=function(e,t){var n,i,o,r;if(null==t&&(t=""),!e)return"";for(e=encodeURIComponent(e),t+="~",o=0,r=t.length;r>o;o++)i=t[o],n=encodeURIComponent(i),e=e.replace(new RegExp(n,"g"),i);return e},e.encode_parts=function(t,n){var i;return null==n&&(n="/"),function(){var o,r,s,a;for(s=t.split(n),a=[],o=0,r=s.length;r>o;o++)i=s[o],a.push(e.encode(i));return a}().join(n)},e}(),t=function(){function e(e){this.dict={},this.add(e)}return e.parse_string=function(t){var n,i,o,r,s,a,l,u;if(!t)return null;for(o={},r=t.split("&"),l=0,u=r.length;u>l;l++)i=r[l],""!==i&&(s=i.split("="),n=e.decode(s[0]),a=e.decode(s.slice(1).join("=")),n in o?(Array.isArray(o[n])||(o[n]=[o[n]]),o[n].push(a)):o[n]=a);return o},e.prototype.add=function(e,t){var n,i,o,r;if(null==t&&(t=null),"string"==typeof e)null!=t&&(this.dict[e]=Array.isArray(t)?function(){var e,i,o;for(o=[],e=0,i=t.length;i>e;e++)n=t[e],o.push(String(n));return o}():String(t));else{o=e||{};for(i in o)r=o[i],null!=r&&(this.dict[i]=Array.isArray(r)?function(){var e,t,i;for(i=[],e=0,t=r.length;t>e;e++)n=r[e],i.push(String(n));return i}():String(r))}return this},e.prototype.remove=function(e){return delete this.dict[e]},e.prototype.replace=function(e){return this.dict=e||{},this},e.prototype.toString=function(){var t,n,i,o;n=[],o=this.dict;for(t in o)i=o[t],Array.isArray(i)?i.forEach(function(i){return n.push(e.encode(t)+"="+e.encode(i))}):n.push(e.encode(t)+"="+e.encode(i));return n.length?n.join("&"):""},e.decode=function(e){return null===e?"":n.decode(e.replace(/\+/g,"%20"))},e.encode=function(e){return null===e?"":n.encode(e).replace(/%20/g,"+")},e}(),INLINE_JS.URI=n,n}),define("modules/core/user_i18n",[],function(){var e;return e=function(){function e(){}return e.getInitials=function(t){var n;return t?(n=t.split(" "),n.length>=2?e._is_cjk_locale()?n[n.length-1][0]+n[0][0]:n[0][0]+n[n.length-1][0]:e._is_cjk_locale()&&!e._is_ascii_name(t)&&t.length>1?t.substring(0,2):t.substring(0,1)):""},e._is_ascii_name=function(e){var t,n,i,o;for(n=i=0,o=e.length;o>i;n=++i)if(t=e[n],e.charCodeAt(n)>=128)return!1;return!0},e._is_cjk_locale=function(){var e;return"zh"===(e=Constants.USER_LOCALE)||"ja"===e||"ko"===e},e}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/browse/preview_sf_members",["dropbox","external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/avatar/components","modules/clean/avatar/size","modules/clean/components/loading_indicator","modules/clean/components/title_bubble","modules/clean/dbmodal","modules/clean/em_string","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/viewer","modules/core/browser","modules/core/i18n","modules/clean/sharing/member_avatars"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h,f){var m,g,v,y,b,w,C,S,E,T,k,x,I,A,P,N,O,R,L,M,D,U;return b=e.Browse,C=e.ExistingSharedFolderOptionsContent,S=e.FileEvents,N=e.SharingApi,O=e.SharingModals,P=i.SharedFolderActivityLogger,E=o.InitialsAvatar,T=o.InitialsAvatarWithColorDerivedFromName,y=o.AvatarWithDefault,L=o.ViewerAvatar,v=r.AVATAR_DIMENSION_BY_SIZE,w=l.DBModalStack,U=h._,D=h.ungettext,M=t.DOM,x=15,g=v.MEDIUM,R="south",m=!0,I=function(){function e(e){this._sharing_api_request_handler=__bind(this._sharing_api_request_handler,this),this._log_event=__bind(this._log_event,this),this._browse_update_handler=__bind(this._browse_update_handler,this),this.focus_sharing_options_modal_invite_form=__bind(this.focus_sharing_options_modal_invite_form,this),this.overflow_click_handler=__bind(this.overflow_click_handler,this),this.avatar_click_handler=__bind(this.avatar_click_handler,this),this.invite_button_click_handler=__bind(this.invite_button_click_handler,this),this.settings_button_click_handler=__bind(this.settings_button_click_handler,this),this.container_element=e[0],this.last_visited_ns_id=null,this.$body=$j("body"),this.$browse_files=$j("#browse-files"),$j(document).on(b.UPDATE_EVT,this._browse_update_handler),$j(document).on(N.REQUEST_SUCCEEDED_EVENT,this._sharing_api_request_handler)}return e.prototype.settings_button_click_handler=function(){return this._show_shared_folder_members_modal(),this._log_event("preview_sf_members_settings_button_clicked")},e.prototype.invite_button_click_handler=function(){return this._show_add_people_modal(),this._log_event("preview_sf_members_invite_button_clicked")},e.prototype.avatar_click_handler=function(e,t){return this._log_event("preview_sf_members_avatar_clicked"),c.getGandalfRule("people-relationship-view-web")&&"member"===e&&null!=(null!=t?t.relationship_view_url:void 0)?p.redirect(t.relationship_view_url):void 0},e.prototype.overflow_click_handler=function(){return this._show_shared_folder_members_modal(),this._log_event("preview_sf_members_overflow_number_clicked")},e.prototype.focus_sharing_options_modal_invite_form=function(){return w.unregister(C.CONTENT_LOADED_EVENT,this.focus_sharing_options_modal_invite_form),$j("#sharing-options-new-collab-input").focus()},e.prototype._browse_update_handler=function(){var e;return b.inside_dir&&b.inside_shared_folder?(e={folderName:b.containing_mount_point().split("/").pop(),user:b.active_user,onSettingsButtonClick:this.settings_button_click_handler,onOverflowCountClick:this.overflow_click_handler,onAvatarClick:this.avatar_click_handler},b.inside_team_folder?e.folderType="TEAM":(e.folderType="SHARED",n.WebRequest({url:"/share_ajax/preview_members/"+b.containing_ns_id(),subject_user:b.active_user,data:{max_results:x},success:function(n){return function(i){return i=JSON.parse(i),i.ns_id===b.containing_ns_id()?(e=$j.extend({},e,{numUndisplayableUsersAndInvites:i.num_avatars_not_shown,numUsersAndInvites:i.num_users_and_invites,numUsersAndInvitesOutsideTeam:i.num_users_and_invites_outside_team,groups:i.groups,invitations:i.invitations,joinedMembers:i.joined_members}),i.user_can_invite&&(e.inviteButton=new k({onClick:n.invite_button_click_handler})),t.render(new A(e),n.container_element),b.update_header_height()):void 0}}(this)})),b.containing_ns_id()!==this.last_visited_ns_id&&(t.render(new A(e),this.container_element),b.update_header_height()),this._log_event("preview_sf_members_shown")):t.unmountComponentAtNode(this.container_element)&&b.update_header_height(),this.last_visited_ns_id=b.inside_dir?b.containing_ns_id():null},e.prototype._show_shared_folder_members_modal=function(){return O.show_shared_folder_options_modal(b.containing_mount_point(),b.active_user,!b.simple_sharing_enabled)},e.prototype._show_add_people_modal=function(){return b.simple_sharing_enabled?O.show_share_inband_modal(b.containing_mount_point(),b.active_user,b.containing_ns_id(),b.containing_sf_perm_role()):(w.register(C.CONTENT_LOADED_EVENT,this.focus_sharing_options_modal_invite_form),O.show_shared_folder_options_modal(b.containing_mount_point(),b.active_user))},e.prototype._log_event=function(e,t){return null==t&&(t={}),t.ns_id=b.containing_ns_id(),P.log("web",e,b.active_user,t)},e.prototype._sharing_api_request_handler=function(e,t){var n;return n=t.request_url,n.indexOf("/share_ajax/leave")>-1||n.indexOf("/share_ajax/unshare")>-1||!b.inside_dir||t.ns_id!==b.containing_ns_id()?void 0:this._browse_update_handler()},e}(),A=t.createClass({mixins:[f],propTypes:{folderName:t.PropTypes.string.isRequired,folderType:t.PropTypes.oneOf(["SHARED","TEAM"]).isRequired,user:t.PropTypes.object.isRequired,onSettingsButtonClick:t.PropTypes.func.isRequired,onOverflowCountClick:t.PropTypes.func,onAvatarClick:t.PropTypes.func,inviteButton:t.PropTypes.element,numUndisplayableUsersAndInvites:t.PropTypes.number,numUsersAndInvites:t.PropTypes.number,numUsersAndInvitesOutsideTeam:t.PropTypes.number,groups:t.PropTypes.array,invitations:t.PropTypes.array,joinedMembers:t.PropTypes.array,avatarDimension:t.PropTypes.number,titleButtonDirection:t.PropTypes.string},getDefaultProps:function(){return{titleButtonDirection:R,avatarDimension:g,maxVisibleAvatars:x,animation:m}},render:function(){return M.div({className:this.getClassName()},this.renderButtons(),this.renderFolderInfo(),"SHARED"===this.props.folderType?this.props.numUsersAndInvites?this.renderAvatars():M.div({className:"loading-indicator-container"},new s):this.renderTeamFolder())},getClassName:function(){return t.addons.classSet({"preview-sf-members-box":!0,clearfix:!0,"team-folder":"TEAM"===this.props.folderType})},renderTeamFolder:function(){var e;return e=U("Shared with all members of %(team_name)s"),M.div({className:"team-folder-string"},e.format({team_name:d.get_viewer().team_name}))},renderButtons:function(){return M.div({className:"buttons"},_.button({className:"settings-button",importance:"tertiary",onClick:this.props.onSettingsButtonClick,title:U("Settings")},U("Settings")),this.props.inviteButton)},renderFolderInfo:function(){return M.div({className:"shared-folder-info"},M.span({className:"shared-folder-name"},u.em_snippet(this.props.folderName,18)),this.props.numUsersAndInvites?M.span({className:"bullet"},"â¢"):void 0,this.props.numUsersAndInvites?this.renderNumberOfMembers():void 0)},renderNumberOfMembers:function(){var e,t;return t=D("%(num_total)s member","%(num_total)s members",this.props.numUsersAndInvites,{comment:'Another pluralized string MAY be concatenated to this to make a string like: "15 members (4 outside of TechCorp Inc.)"'}),this.props.numUsersAndInvitesOutsideTeam?(t+=D(" (%(num_outside)s outside of %(team_name)s)"," (%(num_outside)s outside of %(team_name)s)",this.props.numUsersAndInvitesOutsideTeam,{comment:'This will be concatenated to another string to make a string like: "15 members (4 outside of TechCorp Inc.)"'}),e=t.format({num_total:this.props.numUsersAndInvites,num_outside:this.props.numUsersAndInvitesOutsideTeam,team_name:u.em_snippet(d.get_viewer().team_name,16)})):e=t.format({num_total:this.props.numUsersAndInvites}),M.span({className:"members-string"},e)},renderAvatars:function(){var e,t,n,i,o;return o=this.findOwnerAndMeInJoinedMembers(this.props.joinedMembers),n=o[0],t=o[1],e=[],i=[],null!=n&&(e.push(this.renderJoinedMember(n)),i.push(n.user_id)),null!=t&&t!==n&&(e.push(this.renderJoinedMember(t)),i.push(t.user_id)),this.addGroupsMembersInvitations(e,this.props.groups,this.props.joinedMembers,this.props.invitations,i),this.renderAvatarList(e)}}),k=t.createClass({propTypes:{onClick:t.PropTypes.func.isRequired},render:function(){return _.button({className:"invite-button",importance:"tertiary",onClick:this.props.onClick,title:U("Add members")})}}),I});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/browse/shared_with",["dropbox","external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/avatar/components","modules/clean/avatar/size","modules/clean/components/title_bubble","modules/clean/dbmodal","modules/clean/em_string","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/sharing/shared_link_modal","modules/clean/viewer","modules/core/browser","modules/core/i18n","modules/clean/sharing/member_avatars","modules/clean/account/email","modules/clean/datetime"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h,f,m,g){var v,y,b,w,C,S,E,T,k,x,I,A,P,N,O,R,L,M,D,U,F,B,q,H,j,V,W,$;return b=e.Browse,L=e.SharingApi,M=e.SharingModals,D=e.SharingShmodel,q=e.UpdateEvents,U=e.SimpleSharing,S=e.ExistingSharedFolderOptionsModal,E=e.FileEvents,N=e.SharedLinkSettingsModal,A=i.SharedFolderActivityLogger,P=o.SharedLinkAvatar,y=r.AVATAR_DIMENSION_BY_SIZE,w=a.DBModalStack,$=h._,W=h.ungettext,C=m.EmailVerification,V=g.nice_date_with_month_name,j=t.DOM,H=t.createElement,x=5,v=y.SMALL,F="south",I="--",k="file_row_sharing_menu",T=100,B={PUBLIC:1,TEAM_ONLY:2,PASSWORD:3},O=function(){function e(e,t){this.shared_link_image_static_url_map=t,this._render_all=__bind(this._render_all,this),this._load_next_shared_link_info=__bind(this._load_next_shared_link_info,this),this._load_missing_shared_link_info=__bind(this._load_missing_shared_link_info,this),this._load_all_shared_link_info=__bind(this._load_all_shared_link_info,this),this._load_all_sf_info=__bind(this._load_all_sf_info,this),this._exists_unloaded_sf=__bind(this._exists_unloaded_sf,this),this._load_sf_info_if_missing=__bind(this._load_sf_info_if_missing,this),this._sharing_api_request_handler=__bind(this._sharing_api_request_handler,this),this._browse_update_handler=__bind(this._browse_update_handler,this),this._browse_add_handler=__bind(this._browse_add_handler,this),this._browse_rename_handler=__bind(this._browse_rename_handler,this),this._browse_render_handler=__bind(this._browse_render_handler,this),this._open_shared_folder_options_modal=__bind(this._open_shared_folder_options_modal,this),this._wrap_avatar_click_handler_with_fq_path=__bind(this._wrap_avatar_click_handler_with_fq_path,this),this._wrap_handler_with_fq_path=__bind(this._wrap_handler_with_fq_path,this),this.overflow_click_handler=__bind(this.overflow_click_handler,this),this.avatar_click_handler=__bind(this.avatar_click_handler,this),this.shared_link_avatar_click_handler=__bind(this.shared_link_avatar_click_handler,this),this._preload_on_root=__bind(this._preload_on_root,this),this.ns_to_props={},this.first_render=!0,this.loading_sf_info=!1,this.loading_link_info=!1,this.loaded_sf_info=!1,this.shared_link_maps_by_folder={},this.looked_up_files_in_curr_dir={},this.rendered_element_by_file_key={},$j(document).on(b.RENDER_EVT,this._browse_render_handler),$j(document).on(q.ADD,this._browse_add_handler),$j(document).on(b.UPDATE_EVT,this._browse_update_handler),$j(document).on(L.REQUEST_SUCCEEDED_EVENT,this._sharing_api_request_handler),$j(document).on(E.RENAME,this._browse_rename_handler),$j(document).on(b.NEW_PAGE_EVT,this._browse_add_handler),setTimeout(this._preload_on_root,50)}return e.prototype._preload_on_root=function(){return null!=b.inside_root_folder&&b.inside_root_folder||""===window.encodedpath?this._load_all_sf_info():void 0},e.prototype.shared_link_avatar_click_handler=function(e){var t,n,i,o,r;return n=e.path,r=b.active_user,C.get_for_user(r).verified_or_show()?(t=b.find_file(n),i=t.dir&&(t.is_shared_folder()||t.could_be_shared_folder()),e.is_oob_link&&b.simple_sharing_m2_enabled_only?(o=function(e,t,n){return w.push(new N(e,t,n))},_.showInstance(H(_,{canEdit:e.is_editable,canReaderSync:!1,couldBeSharedFolder:!1,editableLinksM2Enabled:!0,fqPath:n,isDir:!0,isSharedFolder:!0,needsFetchingTokenInfo:!0,showSharedLinkSettingsModal:o,user:r}))):i&&b.simple_sharing_enabled||b.simple_sharing_react_member_list_enabled?U.createAndShowInbandModalFromBrowseFile(r,t):D.shmodel(n,k)):void 0},e.prototype.avatar_click_handler=function(e,t,n){return u.getGandalfRule("people-relationship-view-web")&&"member"===t&&null!=(null!=n?n.relationship_view_url:void 0)?void p.redirect(n.relationship_view_url):this._open_shared_folder_options_modal(e)},e.prototype.overflow_click_handler=function(e){return this._open_shared_folder_options_modal(e)},e.prototype._wrap_handler_with_fq_path=function(e,t){var n;return n=t.fq_path,function(){return function(){return e(n)}}(this)},e.prototype._wrap_avatar_click_handler_with_fq_path=function(e){var t;return t=e.fq_path,function(e){return function(n,i){return e.avatar_click_handler(t,n,i)}}(this)},e.prototype._open_shared_folder_options_modal=function(e){var t,n;return n=b.active_user,C.get_for_user(n).verified_or_show()?b.simple_sharing_enabled?M.show_shared_folder_options_modal(e,n,!b.simple_sharing_enabled):(t=new S(n,e),t.show()):void 0},e.prototype._browse_render_handler=function(){return this.rendered_element_by_file_key={},setTimeout(this._render_all,20)},e.prototype._browse_rename_handler=function(){return setTimeout(this._render_all,1e3)},e.prototype._browse_add_handler=function(){return this._load_sf_info_if_missing(),this._load_missing_shared_link_info()},e.prototype._browse_update_handler=function(){if(b.in_search_mode())return void $j("#browse-box").removeClass("show-shared-with");if(b.show_shared_with||b.load_shared_with)return this.rendered_element_by_file_key={},b.show_shared_with&&$j("#browse-box").addClass("show-shared-with"),this._load_sf_info_if_missing(),this._load_all_shared_link_info()},e.prototype._sharing_api_request_handler=function(e,t){var n;return n=t.request_url,n.indexOf("/share_ajax/leave")>-1||n.indexOf("/share_ajax/unshare")>-1?void 0:(this._load_all_sf_info(),this._load_all_shared_link_info())},e.prototype._load_sf_info_if_missing=function(){return this._in_directory_with_shared_folders()&&this._exists_unloaded_sf()?this._load_all_sf_info():void 0},e.prototype._in_directory_with_shared_folders=function(){var e,t,n,i;if(!b.inside_dir||b.active_user.root_ns!==b.containing_ns_id())return!1;for(i=b.files,t=0,n=i.length;n>t;t++)if(e=i[t],parseInt(e.target_ns))return!0;return!1},e.prototype._exists_unloaded_sf=function(){var e,t,n,i;for(i=b.files,t=0,n=i.length;n>t;t++)if(e=i[t],parseInt(e.target_ns)&&null==this.ns_to_props[e.target_ns])return!0;return!1},e.prototype._load_all_sf_info=function(){return null==b.active_user||this.loading_sf_info||!b.show_shared_with&&!b.load_shared_with?void 0:(this.loading_sf_info=!0,n.WebRequest({url:"/share_ajax/shared_with",dataType:"json",subject_user:b.active_user,data:{max_results:x,fq_path_prefix:b.containing_fq_path()},success:function(e){return function(t){var n,i,o,r,s;for(o={},r=0,s=t.length;s>r;r++)i=t[r],n={user:b.active_user,numUndisplayableUsersAndInvites:i.num_avatars_not_shown,groups:i.groups,invitations:i.invitations,joinedMembers:i.joined_members},o[i.ns_id]=n;return e.ns_to_props=o,e.loading_sf_info=!1,e.loaded_sf_info=!0,e._render_all()}}(this)}))},e.prototype._shared_link_key=function(e){return e.fq_path+"_"+e.to_key()},e.prototype._load_all_shared_link_info=function(){return this._load_next_shared_link_info()},e.prototype._load_missing_shared_link_info=function(){return this.loading_link_info?void 0:this._load_next_shared_link_info(b.containing_fq_path())},e.prototype._load_next_shared_link_info=function(e){var t,i,o,r,s;if(null==e&&(e=null),this.loading_link_info=!1,!(b.in_search_mode()||!b.show_shared_with&&!b.load_shared_with||e&&e!==b.containing_fq_path())){for(null===e&&(e=b.containing_fq_path(),this.looked_up_files_in_curr_dir={}),i=[],s=b.files,o=0,r=s.length;r>o&&(t=s[o],t.fq_path in this.looked_up_files_in_curr_dir||(i.push(t.fq_path),this.looked_up_files_in_curr_dir[t.fq_path]=!0,i.length!==T));o++);if(0!==i.length)return this.loading_link_info=!0,n.SilentBackgroundRequest({url:"/sm/get_token_info",dataType:"json",data:{paths:JSON.stringify(i)},subject_user:b.active_user.id,success:function(t){return function(n){var i,o,r,s,a,l;for(o=t.shared_link_maps_by_folder[e]||{},l=n.shmodels,s=0,a=l.length;a>s;s++)r=l[s],r.disabled||(i=b.find_file(r.path),null!=i&&(o[t._shared_link_key(i)]=r));return t.shared_link_maps_by_folder[e]=o,t._render_all(),t._load_next_shared_link_info(e)}}(this)})}},e.prototype._are_props_equal=function(e,t){var n,i,o,r;for(i=["sharedLinkInfo","user","numUndisplayableUsersAndInvites","groups","invitations","joinedMembers"],o=0,r=i.length;r>o;o++)if(n=i[o],e[n]!==t[n])return!1;return!0},e.prototype._render_all=function(){var e,n,i,o,r,s,a,l,u,c,_,d,p,h;if(b.show_shared_with&&(!this._in_directory_with_shared_folders()||this.loaded_sf_info)&&(o=b.containing_fq_path(),o in this.shared_link_maps_by_folder)){for(u=this.shared_link_maps_by_folder[o],e=this.first_render,this.first_render=!1,p=b.files,h=[],_=0,d=p.length;d>_;_++){if(i=p[_],r=null,null!=i.target_ns&&(r=this.ns_to_props[i.target_ns]),l=u[this._shared_link_key(i)],l&&(r=r||{user:b.active_user},r.sharedLinkInfo=l,r.onSharedLinkClick=this.shared_link_avatar_click_handler),c=i.is_deleted?$("deleted"):r?null:I,a=this.rendered_element_by_file_key[i.to_key()],null!=a){if(null!=c&&a.text_display===c)continue;if(null!=a.react_comp&&null!=r&&(s=a.react_comp,s.isMounted()&&this._are_props_equal(s.props,r)))continue}n=$j(i.get_div()).find(".sharing .sharers"),n.length?null!=c?(n.text(c),h.push(this.rendered_element_by_file_key[i.to_key()]={text_display:c})):(r.animation=e,r.onOverflowCountClick=this._wrap_handler_with_fq_path(this.overflow_click_handler,i),r.onAvatarClick=this._wrap_avatar_click_handler_with_fq_path(i),s=t.render(new R(r),n[0]),h.push(this.rendered_element_by_file_key[i.to_key()]={react_comp:s})):h.push(void 0)}return h}},e}(),R=t.createClass({mixins:[f],propTypes:{user:t.PropTypes.object.isRequired,onOverflowCountClick:t.PropTypes.func,onAvatarClick:t.PropTypes.func,numUndisplayableUsersAndInvites:t.PropTypes.number,groups:t.PropTypes.array,invitations:t.PropTypes.array,joinedMembers:t.PropTypes.array,animation:t.PropTypes.bool,titleButtonDirection:t.PropTypes.string,avatarDimension:t.PropTypes.number,maxVisibleAvatars:t.PropTypes.number,sharedLinkInfo:t.PropTypes.object,onSharedLinkClick:t.PropTypes.func},getDefaultProps:function(){return{titleButtonDirection:F,avatarDimension:v,maxVisibleAvatars:x}},render:function(){return j.div({className:this.getClassName()},this.renderAvatars())},getClassName:function(){return t.addons.classSet({"shared-with-members":!0,clearfix:!0})},renderAvatars:function(){var e,t,n,i,o,r,s,a;return i=this.props.joinedMembers?this.props.joinedMembers:[],t=this.props.groups?this.props.groups.slice():[],n=this.props.invitations?this.props.invitations.slice():[],e=[],this.props.sharedLinkInfo&&e.push(this.renderSharedLink(this.props.sharedLinkInfo)),a=this.findOwnerAndMeInJoinedMembers(i),r=a[0],o=a[1],s=[],null!=r&&r===o&&(r=null),null!=r&&(s.push(r.user_id),e.push(this.renderJoinedMember(r))),null!=o&&s.push(o.user_id),this.addGroupsMembersInvitations(e,t,i,n,s),0===e.length?I:this.renderAvatarList(e)},renderSharedLink:function(e){var t,n;return t=this.sharedLinkAccessTypeString(e),n=new P({dimension:this.props.avatarDimension,onClick:function(t){return function(){return t.props.onSharedLinkClick(e)}}(this)}),new s({key:"shared_link",text:t,direction:F},n)},sharedLinkAccessTypeString:function(e){var t,n,i,o,r,s,a,l,u,c,_;if(_=e.visibility_type,i=e.expires_posix,u=e.shared_folder_link_policy,i){if(a=(new Date).getTime()/1e3,l=i-a,n=Math.floor(l/86400),0>l)return $("Link Disabled");t=new Date(1e3*i),c=!1,r=!0,o=n>180,t=V(t,o,c,r)}if(s="MEMBERS_ONLY"===u,t){if(_===B.PUBLIC)return e.is_editable?s?$("Folder members with the link can edit until %(date)s").format({date:t}):$("People with the link can edit until %(date)s").format({date:t}):s?$("Folder members with the link can view until %(date)s").format({date:t}):$("People with the link can view until %(date)s").format({date:t});if(_===B.PASSWORD)return e.is_editable?s?$("Folder members with the password can edit until %(date)s").format({date:t}):$("People with the password can edit until %(date)s").format({date:t}):s?$("Folder members with the password can view until %(date)s").format({date:t}):$("People with the password can view until %(date)s").format({date:t});if(_===B.TEAM_ONLY)return e.is_editable?s?$("Folder members at %(team_name)s can edit until %(date)s").format({team_name:d.get_viewer().team_name,date:t}):$("People at %(team_name)s can edit until %(date)s").format({team_name:d.get_viewer().team_name,date:t}):s?$("Folder members at %(team_name)s can view until %(date)s").format({team_name:d.get_viewer().team_name,date:t}):$("People at %(team_name)s can view until %(date)s").format({team_name:d.get_viewer().team_name,date:t})}else{if(_===B.PUBLIC)return $(e.is_editable?s?"Folder members with the link can edit":"People with the link can edit":s?"Folder members with the link can view":"People with the link can view");if(_===B.PASSWORD)return $(e.is_editable?s?"Folder members with the password can edit":"People with the password can edit":s?"Folder members with the password can view":"People with the password can view");if(_===B.TEAM_ONLY)return e.is_editable?s?$("Folder members at %(team_name)s with the link can edit").format({team_name:d.get_viewer().team_name}):$("People at %(team_name)s with the link can edit").format({team_name:d.get_viewer().team_name}):s?$("Folder members at %(team_name)s with the link can view").format({team_name:d.get_viewer().team_name}):$("People at %(team_name)s with the link can view").format({team_name:d.get_viewer().team_name})}}}),O}),define("modules/dirty/groups/api",["jquery","dropbox","modules/clean/ajax","modules/clean/contacts/cache","modules/clean/viewer"],function(e,t,n,i,o){var r,s,a;return r=i.DefaultContactsCache,a={},s="/groups_ajax",a.ready=function(){},a.get_groups_for_user=function(e,t){return null==e&&(e={}),null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"get_groups_for_user",data:e,success:t})},a.get_group_info=function(e,t){return null==e&&(e={}),null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"get_group_info",data:e,success:t})},a.get_groups_for_team=function(e,t){return null==e&&(e={}),null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"get_groups_for_team",data:{},success:t})},a.get_users_for_group=function(e,t){return null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"get_users_in_group",data:e,success:t})},a.create_group=function(e,t){return null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"make_new_group",data:e,success:t,reload_contacts:!0})},a.create_group_with_users=function(e,t){return null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"make_new_group_with_users",data:e,success:t,reload_contacts:!0})},a.remove_group=function(e,t){return null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"remove_group",data:e,success:t,reload_contacts:!0})},a.rename_group=function(e,t,n){return null==n&&(n=function(){return{}}),a.metaserver_ajax({method:"rename_group",data:e,success:t,error:n,reload_contacts:!0})},a.add_users_to_group=function(e,t){return null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"add_users_to_group",data:e,success:t,reload_contacts:!0})},a.remove_user_from_group=function(e,t){return null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"remove_user_from_group",data:e,success:t,reload_contacts:!0})},a.change_group_member_type=function(e,t){return null==t&&(t=function(){return{}}),a.metaserver_ajax({method:"change_group_member_type",data:e,success:t})},a.remove_namespace_from_group=function(e,t){return a.metaserver_ajax({method:"remove_namespace_from_group",data:e,success:t})},a.change_group_access_type=function(e,t){var i;return i=function(e,n,i){return t(i)},n.WebRequest({url:s+"/change_group_access_type",type:"post",data:e,subject_user:o.get_viewer().work_user,success:i})},a.refresh_account_photos=function(){var e,t;e=JSON.stringify(r.cached_contacts.contacts.map(function(e){return e.email})),t=function(e){var t,n,i,o;for(o=r.cached_contacts.contacts,n=0,i=o.length;i>n;n++)t=o[n],t.photo_url=e[t.email]},a.metaserver_ajax({method:"get_account_photo_urls_for_emails",data:{emails:e},success:t})},a.metaserver_ajax=function(t){var i,a,l,u;return u=s+"/"+t.method,a=t.reload_contacts||!1,l=function(n){var i,o;i=JSON.parse(n),i.ok&&(t.success(i.data),e(".error_msg").hide()),
a&&r.load_contacts(o=!0)},i=function(n){var i;i=n.responseText,t.error&&(t.error(i.slice(4)),e(".error_msg").hide())},n.WebRequest({url:u,type:"post",data:t.data,subject_user:o.get_viewer().work_user,success:l,error:i})},__CIRCULAR_DEPENDENCY__.GroupsApi=a,a});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/growth/shared_link_signup_modals",["dropbox","jquery","modules/clean/ajax","modules/core/browser","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/components/login_form","modules/clean/dbmodal","modules/clean/growth/experiments/logger","modules/clean/profile_services/third_party_signup","modules/clean/register_form"],function(e,t,n,i,o,r,s,a,l,u,c,_){var d,p,h,f;return h=e.SharingModel,f=o._,d=l.DBModal,p=function(){function e(e){this.show_default_modal=e,this.log_slo_event=__bind(this.log_slo_event,this),this.save_to_dropbox=__bind(this.save_to_dropbox,this),this.show_create_password_modal=__bind(this.show_create_password_modal,this),this.show_welcome_modal=__bind(this.show_welcome_modal,this),this.show_downloading_modal=__bind(this.show_downloading_modal,this),this.before_create_password_modal=__bind(this.before_create_password_modal,this),this.before_download_signup_modal=__bind(this.before_download_signup_modal,this),this.before_default_signup_modal=__bind(this.before_default_signup_modal,this),this.before_signup_modal=__bind(this.before_signup_modal,this),this.init_modals=__bind(this.init_modals,this),this.init_modals(),this.show_default_modal&&(this.default_signup_modal.show(),this.has_seen_modal=!0),t("#download_button_link, #default_content_download_button").click(function(e){return function(){return e.has_seen_modal?e.direct_download():(e.download_type="direct_download",e.download_signup_modal.show(),e.has_seen_modal=!0)}}(this)),t(".add_to_my_dropbox_link, #default_content_a2md").click(function(e){return function(){return e.download_type="add_to_dropbox",e.download_signup_modal.show()}}(this))}return e.prototype.init_modals=function(){return this.default_signup_modal=new d({element_id:"shared-link-default-signup-modal"}),this.default_signup_modal.before_show=this.before_default_signup_modal,this.download_signup_modal=new d({element_id:"shared-link-download-signup-modal"}),this.download_signup_modal.before_show=this.before_download_signup_modal,this.welcome_modal=new d({element_id:"shared-link-welcome-modal"}),this.welcome_modal.before_show=this.before_welcome_modal,this.create_password_modal=new d({element_id:"shared-link-create-password-modal"}),this.create_password_modal.before_show=this.before_create_password_modal},e.prototype.before_signup_modal=function(e){var t,n;return e.find(".toggle-form-link").click(function(t){return function(){return t.toggle_form(e)}}(this)),n=e.find(".register-form"),n.length&&(n.on(_.NEW_ACCOUNT_FROM_3RD_PARTY,function(t){return function(n,i){return t.profile_info=i,t.show_create_password_modal(e,t.profile_info)}}(this)),n.on(_.USER_EXISTS,function(t){return function(n){return t.show_login_form(e,n)}}(this)),n.on(_.REGISTER_SUCCESS,function(e){return function(t,n){return e.user_info=n,e.register_success(e.user_info)}}(this))),t=e.find(".login-form"),t.length?t.on(a.LOGIN_SUCCESS,function(e){return function(t,n){return e.user_info=n,r.success(f("Successfully signed in to Dropbox")),e.download_type?"direct_download"===e.download_type?e.reload_and_direct_download():"add_to_dropbox"===e.download_type?e.save_to_dropbox(!1):void 0:e.reload()}}(this)):void 0},e.prototype.before_default_signup_modal=function(e){return this.before_signup_modal(e)},e.prototype.before_download_signup_modal=function(e){return this.before_signup_modal(e),"direct_download"===this.download_type?(e.find(".add-to-dropbox-component").hide(),e.find(".direct-download-component").show()):"add_to_dropbox"===this.download_type&&(e.find(".direct-download-component").hide(),e.find(".add-to-dropbox-component").show(),e.find(".login-form-component").is(":visible")||this.toggle_form(e)),e.find(".close-link").click(function(e){return function(){return e.download_signup_modal.hide()}}(this))},e.prototype.before_create_password_modal=function(e){var t,n,i,o;return e.find(".close-link").click(function(e){return function(){return e.create_password_modal.hide()}}(this)),t=e.find(".create-password-form-component"),i=t.find(".register-form"),i.on(_.REGISTER_SUCCESS,function(e){return function(t,n){return e.user_info=n,e.register_success(e.user_info)}}(this)),this.picture_handler=c.handle_picture_url(n=this.profile_info.picture_url,o=!1)},e.prototype.before_welcome_modal=function(e){return u.log("sharing","shared_link_welcome_modal_view"),e.find(".go-to-dropbox-button").click(function(){return u.log("sharing","shared_link_welcome_modal_button_click")}),e.find(".welcome-modal-no-thanks a").click(function(){return i.reload()})},e.prototype.show_downloading_modal=function(e){return this.default_signup_modal.hide(),this.download_signup_modal.hide(),this.save_to_dropbox(!0),this.onboarding_download_modal=new d({click_out_to_close:e,element_id:"shared-link-onboarding-download-modal"}),this.onboarding_download_modal.before_show=function(n){return function(i){return n.log_slo_event("slo_downloading_modal_view"),u.start_counter("slo_downloading_modal_stay_on_modal",n.log_slo_event),i.find(".onboarding-download-modal__subheader a").click(function(){return n.log_slo_event("slo_downloading_modal_restart")}),i.find(".db-modal-x").click(function(){return n.log_slo_event("slo_downloading_modal_click_x")}),i.find(".db-modal-overlay").click(function(){return n.log_slo_event("slo_downloading_modal_click_bg")}),i.find("#onboarding-download-modal__download_container").attr("src","/download"),t(document).on("keydown.download_modal",function(e){return 27===e.keyCode?n.log_slo_event("slo_downloading_modal_press_esc"):void 0}),e?void 0:i.find(".db-modal-x").css("visibility","hidden")}}(this),this.onboarding_download_modal.on_hide=function(e){return function(){return e.log_slo_event("slo_downloading_modal_close"),u.stop_counter("slo_downloading_modal_stay_on_modal"),t(document).off(".download_modal")}}(this),this.onboarding_download_modal.show()},e.prototype.show_welcome_modal=function(){return this.default_signup_modal.hide(),this.download_signup_modal.hide(),this.welcome_modal.show()},e.prototype.show_create_password_modal=function(){var e,t,n;return this.default_signup_modal.hide(),this.download_signup_modal.hide(),n={".input-fname":this.profile_info.fname,".input-lname":this.profile_info.lname,".input-email":this.profile_info.email,"input[name=email_sig]":this.profile_info.email_sig,"input[name=refresh_token]":this.profile_info.refresh_token},this.create_password_modal.show(e="input[name=password]",t=n)},e.prototype.direct_download=function(){var e;return e=i.get_uri().updateQuery({dl:1}),i.redirect(e)},e.prototype.reload=function(){return i.reload()},e.prototype.reload_and_direct_download=function(){var e;return e=i.get_uri().updateQuery({force_dl:1}),i.redirect(e)},e.prototype.save_to_dropbox=function(e){var t;return e||r.success(f("Saving to your Dropbox ...")),t=h.c2d_vars,t.job=h.is_folder,n.WebRequest({url:h.c2d_url,data:t,subject_user:this.user_info.id,success:function(t){return e?void 0:(r.success(f("Successfully saved to your Dropbox.")),i.redirect(t))}})},e.prototype.log_slo_event=function(e,t){var n,i;if(null==t&&(t={}),i={gandalf_rule:"growth-onboarding-shared-link-onboarding-one-ring",variant_name:this.user_info.one_ring_experiment.active_variant.toUpperCase()},t)for(n in t)i[n]=t[n];return u.log("onboarding",e,i)},e.prototype.show_login_form=function(e,t){var n,i,o,r,s;i=e.find(".login-form-component"),o=i.find(".login-form"),s=t.prefill;for(n in s)r=s[n],o.find(n).val(r);return o.find(t.focus).focus(),i.is(":visible")?void 0:this.toggle_form(e,!0)},e.prototype.toggle_form=function(e,n){var i,o;return o=e.find(".register-form-component"),i=e.find(".login-form-component"),o.is(":visible")?o.fadeOut({complete:function(){return i.show(),null!=n?setTimeout(function(){return t(i.find(".login-form .login-password input[name='login_password']")[0]).focus()},0):void 0}}):i.fadeOut({complete:function(){return o.show()}})},e.prototype.register_success=function(){var e,t,n;if(r.success(f("Successfully signed up for Dropbox.")),"shared-link-onboarding"===(null!=(n=this.user_info.one_ring_experiment)?n.active_experiment:void 0)){if(t=this.user_info.one_ring_experiment.active_variant,"redirect_to_downloading_page"===t)return e=s.parse("/downloading").updateQuery({shared_link:!0,tkey:h.c2d_vars.tkey}),i.redirect(e);if("non_blocking_download_modal"===t)return this.show_downloading_modal(!0);if("blocking_download_modal"===t)return this.show_downloading_modal(!1)}else{if(!this.download_type)return this.show_welcome_modal();if("direct_download"===this.download_type)return this.show_welcome_modal(),this.direct_download();if("add_to_dropbox"===this.download_type)return this.save_to_dropbox(!1)}},e}()}),define("modules/dirty/home",["jquery","dropbox","modules/clean/account/email","modules/clean/analytics","modules/clean/payments/pro_trial_onboarding_tour","modules/clean/teams/trial_buy_now","modules/clean/upsell/ha_loader","modules/clean/viewer","modules/dirty/sharing/sharing_growth_email_experiments"],function(e,t,n,i,o,r,s,a,l){var u,c,_,d,p,h,f;return u=t.Browse,c=t.ClientDownload,d=t.FileOps,f=t.SharingModals,_=n.EmailVerification,h=i.SharedFolderActivityLogger,p={init:function(t){var n,i,m,g;return s.init("home",u.active_user,t.force_campaign_id),t.show_email_just_verified?_.getForRole(t.role).show_verified_modal():t.show_email_just_verified_and_changed?_.getForRole(t.role).show_verified_and_changed_modal():t.show_sent_verification_email?_.getForRole(t.role).show_sent_modal():t.show_upload?(m=function(){var e;return t.email_src&&(e={ns_id:u.containing_ns_id(),email_src:t.email_src},h.log("web","show_upload_modal_for_sf_from_email",u.active_user,e),l.listen_for_first_upload(u.active_user,e)),d.show_upload.bind(d)()},p._call_when_browse_ready(m)):t.show_share_existing_modal?(t.email_src&&(i={email_src:t.email_src},h.log("web","show_share_existing_folder_modal_from_email",u.active_user,i)),f.show_share_existing_modal(t.fq_path,u.active_user)):t.show_share_options&&!t.share_subfolder?(g=a.get_viewer().get_user_by_role(t.role),g||(g=a.get_viewer().get_users()[0]),f.show_shared_folder_options_modal(t.fq_path,g)):t.show_share_options&&t.share_subfolder?(g=a.get_viewer().get_user_by_role(t.role),g||(g=a.get_viewer().get_users()[0]),f.show_shared_subfolder_modal(t.fq_path,g)):t.show_download_modal?(n=new c,n.show_download_modal()):t.show_pro_trial_modal?o.ProTrialOnboardingTour.show("trial_start"):t.remaining_trial_days?r.showModal(t.remaining_trial_days):t.show_upsell_modal?e("#db-modal-upsell-home-modal").addClass("show-upsell-modal").trigger("show-upsell-modal"):void 0},_call_when_browse_ready:function(e){var t;return u.first_load?(t=function(){return document.stopObserving(u.UPDATE_EVT,t),e()},document.observe(u.UPDATE_EVT,t)):e()}}}),define("modules/dirty/print",["modules/clean/notserver"],function(e){var t;return t=e.NotClients,{print:function(){var e,n,i;for(n in t)e=t[n],e.abort();window.print(),i=[];for(n in t)e=t[n],i.push(e.reconnect());return i}}}),define("modules/dirty/react/file_comments/file_feedback_sharing_section",["jquery","dropbox","external/react","modules/core/exception","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/ajax","modules/clean/activity/activity","modules/clean/analytics","modules/clean/clipboard","modules/clean/filepath","modules/clean/react/sprite_div"],function(e,t,n,i,o,r,s,a,l,u,c,_,d){var p,h,f,m,g,v,y,b;return f=t.SharingShmodel,g=i.assert,b=o._,m=u.WebLightboxLogger,v=n.DOM,p=l.ActivityContext,y=function(e){switch(e){case p.BROWSE_LIGHTBOX:return 100;case p.SHARED_LINK_VIEW:case p.SHARED_LINK_LIGHTBOX:return 160;default:return g(!1)}},h=n.createClass({propTypes:{activity_context:n.PropTypes.number,activity_context_data:n.PropTypes.string,height:n.PropTypes.number,user:n.PropTypes.object},render:function(){var e,t;return t=this.props.activity_context!==p.BROWSE_LIGHTBOX,e=b(t?"Copy link":"Get link"),v.div({className:"file-feedback-sharing-section file-feedback-section",style:{height:this.props.height}},v.div({className:"file-feedback-section-header"},v.div({className:"file-feedback-section-header-inner"},v.span({className:"title"},b("Sharing options"))),v.hr({className:"separator"})),v.div({ref:"contentContainer",className:"file-feedback-sharing-section-content"},t?this._renderInlineLink(this.props.activity_context_data):void 0,v.div({className:"share-button share-facebook",onClick:this._shareFacebook},d({group:"web",name:"share_facebook_icon",text:b("Post")})),v.div({className:"share-button share-twitter",onClick:this._shareTwitter},d({group:"web",name:"share_twitter_icon",text:b("Tweet")})),this._canCopyToClipboard()||!t?v.div({ref:"getLinkButton",className:"share-button share-link",onClick:this._shareGetLink},d({group:"web",name:"share_get_link_icon",text:e})):void 0))},_renderInlineLink:function(e){return v.div({className:"inline-link-container"},v.div({className:"inline-link-desc"},b("Link to share")),v.div({className:"inline-link-text text-input text-input-inline small"},v.div({className:"text-input-wrapper"},v.input({readOnly:!0,type:"text",value:e,className:"text-input-input",onClick:this._onInlineLinkTextInputClicked}))))},componentDidMount:function(){return this._logEvent(m.SOCIAL_SHARE_VIEW)},componentDidUpdate:function(){var t;return this.props.activity_context!==p.BROWSE_LIGHTBOX&&this._canCopyToClipboard()&&!this.state.generated_clipboard_overlay&&(t=this.refs.getLinkButton.getDOMNode(),t.offsetWidth>0)?(c.clipboard_overlay(this.props.activity_context_data,e(t),function(e){return function(){return r.success(b("Link copied to clipboard")),e._logEvent(m.SOCIAL_SHARE_GET_LINK)}}(this),e(this.refs.contentContainer.getDOMNode())),this.setState({generated_clipboard_overlay:!0})):void 0},getInitialState:function(){return{generated_clipboard_overlay:!1}},_onInlineLinkTextInputClicked:function(e){return e.target.select(),this._logEvent(m.SOCIAL_SHARE_SELECT_INLINE_LINK)},_popupShare:function(e){var t,n;return n=window.open("","sharing","width=550,height=420"),n.document.write(b("Loading...")),t=function(){return function(t){return n.location=e(t)}}(this),this._generateSharedLink(t)},_shareFacebook:function(){var e;return e=function(){return function(e){return s({scheme:"https",authority:"facebook.com",path:"/sharer.php",query:{u:e}}).toString()}}(this),this._popupShare(e),this._logEvent(m.SOCIAL_SHARE_FACEBOOK),!1},_shareTwitter:function(){var e;return e=function(e){return s({scheme:"https",authority:"twitter.com",path:"/intent/tweet",query:{url:e,text:"Shared from Dropbox"}}).toString()},this._popupShare(e),this._logEvent(m.SOCIAL_SHARE_TWITTER),!1},_shareGetLink:function(){switch(this.props.activity_context){case p.BROWSE_LIGHTBOX:f.shmodel(this.props.activity_context_data,"browse_lightbox");break;case p.SHARED_LINK_VIEW:case p.SHARED_LINK_LIGHTBOX:break;default:g(!1)}return this._logEvent(m.SOCIAL_SHARE_GET_LINK),!1},_generateSharedLink:function(e){switch(this.props.activity_context){case p.BROWSE_LIGHTBOX:return a.WebRequest({url:s({path:"/sm/get_link"+this.props.activity_context_data}).toString(),data:{origin:"browse_lightbox"},success:function(){return function(t){var n,i;return i=JSON.parse(t),n=i.link,"function"==typeof e?e(n):void 0}}(this),error:function(){return function(){return r.error(b("An error occurred, please try again."))}}(this),subject_user:this.props.user.id});case p.SHARED_LINK_VIEW:case p.SHARED_LINK_LIGHTBOX:return"function"==typeof e?e(this.props.activity_context_data):void 0;default:return g(!1)}},_logEvent:function(e){return m.log(e,{context:this._getContextForLogging(),file_ext:this._getFileExtForLogging()})},_getContextForLogging:function(){switch(this.props.activity_context){case p.BROWSE_LIGHTBOX:return"browse_lightbox";case p.SHARED_LINK_VIEW:return"shmodel_view";case p.SHARED_LINK_LIGHTBOX:return"shmodel_lightbox";default:return g(!1)}},_getFileExtForLogging:function(){var e;switch(this.props.activity_context){case p.BROWSE_LIGHTBOX:return _.file_extension_for_logging(this.props.activity_context_data);case p.SHARED_LINK_VIEW:case p.SHARED_LINK_LIGHTBOX:return e=s.parse(this.props.activity_context_data),_.file_extension_for_logging(e.getPath());default:return g(!1)}},_canCopyToClipboard:function(){return FlashDetect.installed}}),{get_height_by_activity_context:y,FileFeedbackSharingSection:h}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/dirty/react/file_comments/file_feedback_ui",["jquery","external/underscore","external/react","dropbox","modules/constants/python","modules/core/i18n","modules/core/notify","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/activity/activity","modules/clean/activity/activity_store","modules/clean/activity/activity_local_storage","modules/clean/activity/activity_user","modules/clean/activity/file_activity_cache","modules/clean/activity/file_viewer_state","modules/clean/analytics","modules/clean/annotations/annotation","modules/clean/base64","modules/clean/bolt","modules/clean/file_viewer_interface_controller","modules/clean/gandalf_util","modules/clean/react/modal","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/storage","modules/clean/viewer","modules/clean/react/file_comments/annotation_bubble","modules/clean/react/file_comments/annotation_comments_list_ui_bubble","modules/clean/react/file_comments/comment_list_ui","modules/clean/react/file_comments/file_feedback_likes_section","modules/dirty/react/file_comments/file_feedback_sharing_section","modules/clean/react/file_comments/logger","modules/clean/react/file_comments/shared_link_signup_modals","modules/dirty/react/file_comments/switch_revision_ui"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h,f,m,g,v,y,b,w,C,S,E,T,k,x,I,A,P,N,O,R){var L,M,D,U,F,B,q,H,j,V,W,$,G,K,z,Y,X,J,Q,Z,ee,te,ne,ie,oe,re,se,ae,le,ue,ce,_e,de,pe,he,fe,me,ge;return Z=i.FileEvents,oe=i.FileViewer,ae=i.Lightbox,ge=r._,Y=a.EmailVerification,z=f.ContactSearchLogger,H=m.Annotation,$=m.AnnotationTypes,W=m.AnnotationSubtypes,_e=w.SimpleModal,fe=n.DOM,le=C.R_,j=n.createFactory(k),V=n.createFactory(x),K=n.createFactory(I),ee=n.createFactory(A),te=n.createFactory(P),de=n.createFactory(S),G="comment",me=T.get_viewer(),q=u.ActivityContext,J=u.FileActivity,Q=c.FileActivityStore,se=50,X=50,M=120,U=320,L=10,D=11,ue="switch-revision-container",B="annotation-overlay",F="annotation-comments-list-ui-overlay",ie=n.createClass({displayName:"FileFeedbackUI",propTypes:{visible:n.PropTypes.bool.isRequired,showButtonColor:n.PropTypes.string.isRequired,activityCache:n.PropTypes.instanceOf(p),activityContext:n.PropTypes.number,activityContextData:n.PropTypes.string,onActivityLoaded:n.PropTypes.func,hideToggledCallback:n.PropTypes.func,photoLikesVariant:n.PropTypes.string,photoSocialShareVariant:n.PropTypes.string,previewWidthCallback:n.PropTypes.func,feedbackId:n.PropTypes.string.isRequired,onInputFocus:n.PropTypes.func,onInputBlur:n.PropTypes.func,userId:n.PropTypes.number,showDisabledCommentBar:n.PropTypes.bool,previewSelector:n.PropTypes.string,forceNullStateLoadingState:n.PropTypes.bool,shouldInitiallyFocusInput:n.PropTypes.bool,canCollapse:n.PropTypes.bool,shouldAutoLinkify:n.PropTypes.bool,enableImport:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,file:n.PropTypes.object,oref:n.PropTypes.string},getInitialState:function(){return this._previewLoadedCallback=e.noop,this.previewIsReady=!1,{visible:this.props.visible,enabled:!0,height:0,comments_on:!0,icon:"s_comments_locked",contextActivityStore:new Q(this.props.activityContext,this.props.activityContextData),started_fetching_activity:!1,isNewCommentLoading:!1,showResolvedComments:!1,isCommentInputDisabled:!1}},getDefaultProps:function(){return{photoLikesVariant:"CONTROL",photoSocialShareVariant:"CONTROL",forceNullStateLoadingState:!1,canCollapse:!0,shouldAutoLinkify:!0,enableImport:!0,onActivityLoaded:e.noop,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,file:null}},componentWillMount:function(){return this.isAnnotationCreationEnabled=b.getGandalfRule("dw-comments-annotation-marker")||b.getGandalfRule("dw-comments-annotation-highlight")||b.getGandalfRule("dw-comments-annotation-region"),this.isAnnotationGhostEnabled=b.getGandalfRule("dw-comments-annotation-ghost"),this.isThreadingEnabled=b.getGandalfRule("dw-comments-threading"),this.isTinyAnnotationUIEnabled=b.getGandalfRule("dw-comments-tiny-annotation-ui"),this._prepareFileViewerInterfaceController(),this.fileViewerState=new h(this.props.file),this.getActivityUser().is_signed_in||(this.modals=new O),this.props.activityContext&&this.props.activityContextData&&this.fileViewerState.isAnnotationReadyFile()&&b.getGandalfRule("dw-comments-annotation-marker")&&b.getGandalfRule("dw-comments-annotation-onboarding-modal")?this.showAnnotationOnboardingModal():void 0},componentWillUpdate:function(){return{}},componentDidMount:function(){var e;return this._refreshWidth(),this._shouldFetchActivity()&&null!=this.props.activityCache&&(e=this.props.activityCache.getActivity(this.props.activityContext,this.props.activityContextData),null!=e&&this._onActivitySuccessfullyFetched(e)),this._shouldFetchActivity()&&this._fetchActivity(),this.contactSearchLogger=new z},componentDidUpdate:function(e,t){var n,i,o,r,s;return(this.props.activityContextData!==e.activityContextData||this.props.activityContext!==e.activityContext)&&this._prepareFileViewerInterfaceController(),n=this.state.activity!==t.activity,n&&(this.props.onActivityLoaded(this.state.activity),this.removeAllAnnotations(),this.redrawAllAnnotations(),null!=this.props.activityCache&&this.props.activityCache.setActivity(this.props.activityContext,this.props.activityContextData,this.state.activity)),o=this.state.showResolvedComments!==t.showResolvedComments,o&&(this.state.showResolvedComments||this.removeAllAnnotations(),this.redrawAllAnnotations()),i=this.state.comments_on!==t.comments_on||this.state.visible!==t.visible||this.state.enabled!==t.enabled||(null!=(r=this.state.activity)?r.feedback_off:void 0)!==(null!=(s=t.activity)?s.feedback_off:void 0),i?(this._refreshWidth(),this._isCommentsOnAndVisible()?(this.enableAnnotationCreation(),this.redrawAllAnnotations()):(this.removeAllAnnotations(),this.disableAnnotationCreation(),this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble())):void 0},componentWillUnmount:function(){return this._reset()},close:function(){var e;return this._reset(),this.onSwitchToLatestRevision(),null!=(e=this.fileViewerInterfaceController)?e.destroy():void 0},onPreviewAndCommentsReady:function(){return this._prepareAnnotationAndCommentsBubble(),this._isCommentsOnAndVisible()?(this.enableAnnotationCreation(),this.redrawAllAnnotations()):void 0},_reset:function(){return this.previewIsReady=!1,this.annotationBubble=null,this.annotationCommentsListUIBubble=null,this.removeAllAnnotations(),this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble(),this._stopLiveUpdate()},_prepareFileViewerInterfaceController:function(){var e;return null!=(e=this.fileViewerInterfaceController)&&e.destroy(),this.fileViewerInterfaceController=new y(this.props.activityContext),this.fileViewerInterfaceController.registerEventsCallbacks(this.onAnnotationEventsCallback)},_previewLoaded:function(){return this._previewLoadedCallback?(this._previewLoadedCallback(),this._previewLoadedCallback=e.noop):void 0},_isCommentsOnAndVisible:function(){return this.state.comments_on&&this.state.visible&&this.state.enabled&&null!=this.state.activity&&!this.state.activity.feedback_off},_isAnnotationCreationEnabled:function(){return this.isAnnotationCreationEnabled&&this._isCommentsOnAndVisible()},_isPreviewAndCommentsReady:function(){return this.state.enabled&&null!=this.state.activity&&this.previewIsReady&&!this.state.is_fetching_activity},_fileHasReplies:function(){var e,t,n,i;if(null!=this.state.activity)for(i=this.state.activity.comment_activities,t=0,n=i.length;n>t;t++)if(e=i[t],e.comment_activities.length>0)return!0;return!1},_isThreadingEnabled:function(){return this.isThreadingEnabled||this._fileHasReplies()},_prepareSwitchRevisionUI:function(){var t;return null!=this.props.previewSelector?(e("#"+ue).length||(t=e("<div />",{id:""+ue}),e("body").append(t)),this.$switchRevisionUIContainer=e("#"+ue).get(0),this.switchRevisionUI=n.render(n.createElement(R,{showSwitchRevisionUI:!1,onSwitchToLatestRevision:this.onSwitchToLatestRevision}),this.$switchRevisionUIContainer)):void 0},_prepareAnnotationContainers:function(){var t,i;return null!=this.props.previewSelector&&(this.$previewContainer=e(this.props.previewSelector),this.$previewContainer.length&&(this.isAnnotationCreationEnabled&&!this.annotationBubble&&this.fileViewerState.isCurrentlyAtLatestRevision()&&(e("#"+B).length||(i=e("<div />",{id:""+B}),this.$previewContainer.append(i)),this.$annotationOverlayContainer=e("#"+B).get(0),this.annotationBubble=n.render(j({showBubble:!1,onAddComment:this.onAddCommentFromAnnotationBubble,onCancelComment:this.onCancelCommentFromAnnotationBubble}),this.$annotationOverlayContainer)),!this.annotationCommentsListUIBubble))?(e("#"+F).length||(t=e("<div />",{id:""+F}),this.$previewContainer.append(t)),this.$annotationCommentsListUIOverlayContainer=e("#"+F).get(0),this.annotationCommentsListUIBubble=n.render(V({fileViewerInterfaceController:this.fileViewerInterfaceController,fileViewerState:this.fileViewerState,showBubble:!1,isThreadingEnabled:this._isThreadingEnabled(),onDeleteComment:this.onDeleteCommentFromAnnotationBubble,onLikeComment:this.onLikeCommentFromAnnotationBubble,onMouseLeave:this.onAnnotationCommentsListUIBubbleMouseLeave,onMouseOver:this.onAnnotationCommentsListUIBubbleMouseOver,onUpdateResolve:this.onResolveCommentFromAnnotationBubble,onAddCommentFromList:this.onAddCommentFromList,onAddSticker:this.onAddCommentFromSticker}),this.$annotationCommentsListUIOverlayContainer)):void 0},highlightComment:function(t){var n,i,o,r;return null!=t.commentActivity&&(r=t.commentActivity,o=r.activity_key,n=e(".comments-and-feedback .comment-activity[data-comment-activity-key='"+o+"']").get(0),null!=n)?(n.classList.remove("start-highlight-animation"),n.offsetWidth=n.offsetWidth,n.classList.add("start-highlight-animation"),i=e(".comment-list"),i.animate({scrollTop:n.offsetTop},{duration:500})):void 0},hideAnnotationCommentsBubble:function(){var e;return null!=(e=this.annotationCommentsListUIBubble)?e.setProps({showBubble:!1}):void 0},showAnnotationCommentsBubble:function(e){var t,n,i,o,r,s,a,l,u,c;if(clearTimeout(this.annotationCommentsListUIBubbleTimer),null!=e.annotation&&(t=H.createAnnotationFromDict(e.annotation),r=e.commentActivity,this.annotationCommentsListUIBubble)){for(l=this.state.activity.comment_activities,c=[],s=0,a=l.length;a>s;s++)o=l[s],o.activity_key===r.activity_key?this._isBoundingBoxOffscreen(t)?c.push(void 0):(u=this._getBubbleLocation(t),n=u[0],i=u[1],c.push(null!=n?this.annotationCommentsListUIBubble.setProps({annotation:t,commentActivity:o,contextActivityStore:this.state.contextActivityStore,showBubble:!0,x:i.x,y:i.y,position:n}):void 0)):c.push(void 0);return c}},onAnnotationCommentsListUIBubbleMouseOver:function(){return clearTimeout(this.annotationCommentsListUIBubbleTimer)},onAnnotationCommentsListUIBubbleMouseLeave:function(){return this.hideAnnotationCommentsBubble()},hideAnnotation:function(){return this.fileViewerInterfaceController?this.fileViewerInterfaceController.dispatchEvent("hide-annotation"):void 0},hideAnnotationBubble:function(){var e;return null!=(e=this.annotationBubble)?e.setProps({showBubble:!1}):void 0},placeAnnotationBubble:function(e){var t,n,i,o;if(this._isAnnotationCreationEnabled()&&null!=e.annotation&&this.annotationBubble){if(t=H.createAnnotationFromDict(e.annotation),this._isBoundingBoxOffscreen(t))return this.hideAnnotationBubble();if(o=this._getBubbleLocation(t),n=o[0],i=o[1],null!=n)return this.annotationBubble.setProps({annotation:t,showBubble:!0,x:i.x,y:i.y,position:n})}},_prepareAnnotationAndCommentsBubble:function(){var e,t;return this._prepareAnnotationContainers(),null!=this.state.contextActivityStore?(null!=(e=this.annotationBubble)&&e.setProps({user:this.getActivityUser(),contextActivityStore:this.state.contextActivityStore,activity:this.state.activity}),null!=(t=this.annotationCommentsListUIBubble)?t.setProps({user:this.getActivityUser(),contextActivityStore:this.state.contextActivityStore,activity:this.state.activity}):void 0):void 0},_getBubbleLocation:function(e){var t,n,i,o,r,s,a;return r=function(e,t,n,i){return e>=0&&n-U>e&&t>=0&&i-M>t},a=this.$previewContainer.width(),s=this.$previewContainer.height(),o=e.getClampedBoundingBox(a,s),i=H.getCenterPosition(o),t=i.x-U/2,n=o.bottom+L,r(t,n,a,s)?["top",{x:t,y:n}]:(t=o.left-U-L,n=o.top-D,r(t,n,a,s)?["right-top",{x:t,y:n}]:(t=o.right+L,n=o.top-D,r(t,n,a,s)?["left-top",{x:t,y:n}]:(t=i.x-U/2,n=o.top-M-L,r(t,n,a,s)?["bottom",{x:t,y:n}]:(t=i.x-U/2,n=i.y+L,r(t,n,a,s)?["top",{x:t,y:n}]:[null,null]))))},_isBoundingBoxOffscreen:function(e){var t,n,i;return i=this.$previewContainer.width(),n=this.$previewContainer.height(),t=e.getBoundingBox(),t.top>=n||t.left>=i||t.right<0||t.bottom<0},disableAnnotationCreation:function(){return this.fileViewerInterfaceController?this.fileViewerInterfaceController.dispatchEvent("disable-annotation-creation"):void 0},enableAnnotationCreation:function(){return this.fileViewerInterfaceController?this.fileViewerInterfaceController.dispatchEvent("enable-annotation-creation"):void 0},removeAllAnnotations:function(){return this.fileViewerInterfaceController?this.fileViewerInterfaceController.dispatchEvent("remove-all-annotations"):void 0},redrawAnnotation:function(e){return this.fileViewerInterfaceController&&this._isCommentsOnAndVisible()?this.fileViewerInterfaceController.dispatchEvent("draw-annotation",e):void 0},redrawAllAnnotations:function(e){var t,n,i,o,r,s,a,l;if(null==e&&(e=null),this.state.activity&&this.previewIsReady&&this._isCommentsOnAndVisible()){for(a=this.state.activity.comment_activities,l=[],r=0,s=a.length;s>r;r++)n=a[r],i={},(this.state.showResolvedComments||!n.comment.resolved)&&n.comment.has_metadata()&&n.comment.comment_metadata.has_annotation_data()?(o=n.comment.comment_metadata.revision,this.isAnnotationGhostEnabled||null!=o&&this.fileViewerState.isCurrentlyAtRevision(o)?(this.isAnnotationGhostEnabled&&null!=o&&!this.fileViewerState.isCurrentlyAtRevision(o)&&(i.isGhostAnnotation=!0),t=H.createAnnotationFromDict(n.comment.comment_metadata.annotation),l.push(null!=e&&t.getFirstPdfPage()===e||null==e?this.redrawAnnotation({annotation:n.comment.comment_metadata.annotation,commentActivity:n,options:i}):void 0)):l.push(void 0)):l.push(void 0);return l}},onAnnotationEventsCallback:function(e,t){var n,i,o,r,s,a,l,u,c,_;switch(e){case"annotation-hidden":return this.hideAnnotationBubble(),N.log_annotation_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_HIDDEN,this.state.activity.activity_key,null,this.getActivityUser().id,this.props.activityContext);case"annotation-placed":return this.hideAnnotationCommentsBubble(),this.placeAnnotationBubble(t),N.log_annotation_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activity.activity_key,null,this.getActivityUser().id,this.props.activityContext,null!=t.annotation?t.annotation:void 0);case"annotation-start-drag":return this.hideAnnotationBubble();case"annotation-end-drag":return this.placeAnnotationBubble(t),N.log_annotation_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activity.activity_key,null,this.getActivityUser().id,this.props.activityContext,null!=t.annotation?t.annotation:void 0);

case"page-rendered":return this.previewIsReady||(this.previewIsReady=!0,this._isPreviewAndCommentsReady()&&this.onPreviewAndCommentsReady(),this._previewLoaded()),this.redrawAllAnnotations(t.page);case"annotation-ui-click":return n=t.commentActivity,i=null!=(r=t.commentActivity)&&null!=(s=r.comment)?s.comment_metadata:void 0,o=null!=(a=t.commentActivity)&&null!=(l=a.comment)&&null!=(u=l.comment_metadata)?u.revision:void 0,null==o||this.fileViewerState.isCurrentlyAtRevision(o)?(this.showAnnotationCommentsBubble(t),this.highlightComment(t)):this.showAnnotationWithPreview(n,i),N.log_annotation_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activity.activity_key,null!=(c=t.commentActivity)?c.activity_key:void 0,this.getActivityUser().id,this.props.activityContext);case"annotation-ui-enter":return this.showAnnotationCommentsBubble(t),N.log_annotation_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activity.activity_key,null!=(_=t.commentActivity)?_.activity_key:void 0,this.getActivityUser().id,this.props.activityContext);case"annotation-ui-leave":return clearTimeout(this.annotationCommentsListUIBubbleTimer),this.annotationCommentsListUIBubbleTimer=setTimeout(function(e){return function(){return e.hideAnnotationCommentsBubble()}}(this),200);case"scale-change":return this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble();case"scroll":if(this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble(),clearTimeout(this.annotationBubbleTimer),t)return this.annotationBubbleTimer=setTimeout(function(e){return function(){return e.placeAnnotationBubble(t)}}(this),300)}},onSwitchToLatestRevision:function(){return this.switchRevision(this.fileViewerState.getLatestRevision()),this.removeSwitchToLatestRevisionUI()},setSwitchToLatestRevisionUI:function(e){var t;return this.setState({isCommentInputDisabled:!0}),null!=(t=this.switchRevisionUI)?t.setProps({showSwitchRevisionUI:!0,revision:e}):void 0},removeSwitchToLatestRevisionUI:function(){var e;return this.setState({isCommentInputDisabled:!1}),null!=(e=this.switchRevisionUI)?e.setProps({showSwitchRevisionUI:!1}):void 0},switchRevision:function(e,t){var n;return null==e||this.fileViewerState.isCurrentlyAtRevision(e)?t?t():void 0:(this.previewIsReady=!1,this.annotationBubble=null,this.annotationCommentsListUIBubble=null,this.fileViewerState.setCurrentRevision(e),n=this.fileViewerState.isCurrentlyAtLatestRevision()&&this._isAnnotationCreationEnabled(),this.props.activityContext===q.BROWSE_FILE_VIEWER?INLINE_JS.FileViewer.switch_preview(e.preview_link,n,t):this.props.activityContext===q.SHARED_LINK_VIEW&&INLINE_JS.FilePreview.switch_preview(e.revision_id,n,t),this.fileViewerState.isOldRevision(e)?this.setSwitchToLatestRevisionUI(e):this.removeSwitchToLatestRevisionUI())},showAnnotationWithPreview:function(e,t){var n,i;return this.fileViewerInterfaceController&&(n=H.createAnnotationFromDict(t.annotation),i=n.getFirstPdfPage(),this.fileViewerState.isCurrentlyAtRevision(t.revision)?this._scrollToAnnotationInPreview(i,e):this.switchRevision(t.revision,function(t){return function(){return t._prepareFileViewerInterfaceController(),t._previewLoadedCallback=function(){return t._scrollToAnnotationInPreview(i,e)}}}(this))),N.log_annotation_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_BUTTON_CLICKED,this.state.activity.activity_key,t.activity_key,this.getActivityUser().id,this.props.activityContext,t.annotation)},_addRevisionToCommentMetadata:function(e){var t;return null==e&&(e={}),t=this.fileViewerState.getCurrentRevision(),t&&(e.revision=t),e},_prepareCommentMetadataWithAnnotation:function(e){var t;return t={annotation:e.toMetadataDict()},this._addRevisionToCommentMetadata(t)},onDeleteCommentFromAnnotationBubble:function(e){return this.onDeleteComment(e),this.hideAnnotationCommentsBubble(),this.fileViewerInterfaceController.dispatchEvent("remove-annotation",{commentActivity:e})},onResolveCommentFromAnnotationBubble:function(e,t){return this.onResolveComment(e,t)},onAddCommentFromAnnotationBubble:function(e,t){return this.hideAnnotationBubble(),this.onAddComment(e,this._prepareCommentMetadataWithAnnotation(t))},onCancelCommentFromAnnotationBubble:function(){return this.hideAnnotationBubble(),this.hideAnnotation()},onLikeCommentFromAnnotationBubble:function(e){return this.onLikeComment(e)},onAddCommentFromSticker:function(e){var t;return t={stickers:{id:e}},this.onAddComment("",this._addRevisionToCommentMetadata(t))},onAddCommentFromList:function(e,t,n){return null==t&&(t={}),null==n&&(n=null),this.onAddComment(e,t,n)},onDeleteCommentFromList:function(e){return this.onDeleteComment(e)},onResolveCommentFromList:function(e,t){return this.onResolveComment(e,t)},onLikeCommentFromList:function(e){return this.onLikeComment(e)},onAddComment:function(n,i,o){var r,a,u;return null==o&&(o=null),this.getActivityUser().is_signed_in?this.getActivityUser().is_email_verified?(n=e.trim(n),u=function(e){return function(n){return e.setState({isNewCommentLoading:!1,activity:t.clone(n)},function(){var t,n;return null!=o?(e.hideAnnotationCommentsBubble(),null!=(t=e.annotationCommentsListUIBubble)?t.setProps({commentActivity:o}):void 0):(null!=(n=e.refs.commentListUI)&&n.animateScrollToBottom(),e.redrawAllAnnotations())}),e.hideAnnotation()}}(this),a=function(e){return function(t){var n;return n=t.error_text||ge("An error occurred while commenting."),s.error(n),e.setState({isNewCommentLoading:!1})}}(this),this.state.contextActivityStore.add_comment(this.state.activity,this.getActivityUser(),n,i,o,u,a),null==o&&this.setState({isNewCommentLoading:!0},function(e){return function(){var t;return null!=(t=e.refs.commentListUI)?t.scrollToBottom():void 0}}(this)),this.setState({isSender:!0}),this.contactSearchLogger.log_records(this.getActivityUser().id,!1)):(r=Y.get_for_user(this.getActivityUser()),Y.set_should_use_simple_ui(this.props.shouldUseSimpleModals),r.show_verify_modal(null,l.ADD_COMMENT)):(this.modals.show_sign_in_modal(O.POST_COMMENT_VARIANT),N.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,this.state.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.POST_BUTTON))},onDeleteComment:function(e){var t,n;return t=function(e){return function(){return s.error(ge("An error occurred while deleting the comment.")),e.forceUpdate()}}(this),n=function(t){return function(){s.success(ge("Comment deleted"),2),t.fileViewerInterfaceController.dispatchEvent("remove-annotation",{commentActivity:e}),t.forceUpdate()}}(this),this.state.contextActivityStore.delete_comment(this.state.activity,this.getActivityUser(),e.activity_key,n,t)},onResolveComment:function(e,t){var n,i;return i=function(){return function(){}}(this),n=function(n){return function(){return s.error(ge(t?"An error occurred while setting the comment to resolved.":"An error occurred while setting the comment to not resolved.")),n._onResolveUpdateUI(e,!t)}}(this),this.state.contextActivityStore.update_resolved(e,this.getActivityUser(),t,i,n),this._onResolveUpdateUI(e,t)},_onResolveUpdateUI:function(e,n){var i,o,r,s,a,l,u,c;for((null!=(a=this.annotationCommentsListUIBubble)&&null!=(l=a.props.commentActivity)?l.activity_key:void 0)===e.activity_key&&(n&&!this.state.showResolvedComments?this.hideAnnotationCommentsBubble():(e=t.clone(e),e.comment.resolved=n,null!=(u=this.annotationCommentsListUIBubble)&&u.setProps({commentActivity:e}))),i=t.clone(this.state.activity),c=i.comment_activities,r=0,s=c.length;s>r;r++)o=c[r],o.activity_key===e.activity_key&&(o.comment.resolved=n);return this.setState({activity:i})},onLikeComment:function(e){return this.getActivityUser().is_signed_in?void 0:(_.set_store("like",this.state.activity.activity_key,e.activity_key),this.modals.show_sign_in_modal(O.LIKE_COMMENT_VARIANT),N.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,this.state.activity.activity_key,e.activity_key,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LIKE_BUTTON))},onToggleShowResolvedComments:function(){return this.setState({showResolvedComments:!this.state.showResolvedComments})},_isUserSubscribed:function(){var e,t,n,i;if(this.state.activity&&this.state.activity.users_to_notify)for(i=this.state.activity.users_to_notify,t=0,n=i.length;n>t;t++)if(e=i[t],e.id===this.getActivityUser().id)return!0;return!1},toggleFeedbackForViewer:function(){var e,t,n;return this.getActivityUser().is_signed_in?(n=!this._isUserSubscribed(),t=ge(n?"You have been subscribed.":"You have been unsubscribed."),e=ge(n?"We failed to subscribe you.":"We failed to unsubscribe you."),this._toggleSubscribe(null,n,t,e)):(_.set_store("subscribe",this.state.activity.activity_key),this.modals.show_sign_in_modal(O.SUBSCRIBE_VARIANT),N.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,this.state.activity.activity_key,null,Constants.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.SUBSCRIBE_BUTTON))},onFacepileContactAdded:function(e){var t,n,i,o,r,a,l,u,c;return null!=e?(i=e.data("name"),n=e.data("identifier"),a=e.data("photo-url"),t=e.data("dbx-account-id"),u=new d({id:t,display_name:i,email:n,photo_url:a,photo_circle_url:a}),c=u.id,__indexOf.call(function(){var e,t,n,i;for(n=this.state.activity.users_to_notify,i=[],e=0,t=n.length;t>e;e++)l=n[e],i.push(l.id);return i}.call(this),c)>=0?void s.error(ge("User has already been subscribed!")):(r=ge("User subscribed to comments."),o=ge("An error occurred while subscribing user."),this._toggleSubscribe(u,!0,r,o))):void 0},_toggleSubscribe:function(e,t,n,i){var o,r,a,u,c;return!this.getActivityUser().is_email_verified&&t?(_.set_store("subscribe",null!=(c=this.state.activity)?c.activity_key:void 0),o=Y.get_for_user(this.getActivityUser()),Y.set_should_use_simple_ui(this.props.shouldUseSimpleModals),o.show_verify_modal(null,l.SUBSCRIBE_TO_COMMENTS)):(r=function(e){return function(t){return s.success(n),e.onSubscribeUpdated(t)}}(this),u=function(e){return function(t){return e.onSubscribeUpdated(t)}}(this),a=function(e){return function(t){return s.error(i),e.onSubscribeUpdated(t)}}(this),this.state.contextActivityStore.update_subscribe(this.state.activity,this.getActivityUser(),t,e,r,u,a))},_verifyAfterSignUpCallback:function(){var e;return e=Y.get_for_user(this.getActivityUser()),Y.set_should_use_simple_ui(this.props.shouldUseSimpleModals),e.send_email(l.ADD_COMMENT,function(){}),e.show_resend_verify_modal(l.ADD_COMMENT)},onAnnotationButtonMouseUp:function(e,t){return this.showAnnotationWithPreview(e,t)},_scrollToAnnotationInPreview:function(e,t){return this.fileViewerInterfaceController.dispatchEvent("scroll-to-annotation",{page:e,commentActivity:t})},resetToBlankState:function(){return 0===e(".blank-state").length?(e(".comments-holder .comment-list-facepile:visible").hide(),e(".comments-holder .comment-activity:visible").hide(),e(".comments-holder .comment-field:visible").hide(),!0):!1},showAnnotationOnboardingModal:function(){var e,t;return e="/static/images/commenting/annotation-onboarding-vfl_16dfj.gif",t='<div class="annotation-onboarding-modal"> Click anywhere to add your thoughts in just the right spot <div class="annotation-onboarding-modal__screenshot"><img src="'+e+'"></img></div> </div>',_e.show({title_text:ge("Give focused feedback"),body_html:t,confirm_text:ge("Ok")})},showFeedbackModal:function(t){var n;return t.preventDefault(),n='<div class="text-input comment-feedback-input"> <div class="text-input-wrapper"> <textarea id="comments-feedback-input" placeholder="Describe your experience, concerns, ideas, etc." ></textarea> </div> </div>',_e.show({title_text:ge("Send feedback about Comments"),body_html:n,cancel_text:ge("Cancel"),confirm_text:ge("Submit Feedback"),confirm_callback:function(t){return function(){var n;return n=e("#comments-feedback-input").val(),t.state.contextActivityStore.submit_product_feedback(t.getActivityUser(),n,function(){return s.success(ge("Thank you! Your feedback will help improve Dropbox."))},function(){return s.error(ge("There was an error submitting your feedback."))})}}(this)})},getActivityUser:function(){return this.props.userId?new d(me.get_user_by_id(this.props.userId)):me.work_user||me.personal_user?new d(me.work_user||me.personal_user):me.is_signed_in?void 0:new d},setLockedIcon:function(){return this.setState({icon:"s_comments_locked"})},setUnlockedIcon:function(){return this.setState({icon:"s_comments_unlocked"})},disable:function(){return this.setState({enabled:!1})},enable:function(){return this.setState({enabled:!0}),this.forceUpdate()},turnOffComments:function(){return this.setState({comments_on:!1,icon:"s_comments_locked"})},turnOnComments:function(e){return null!=e&&e.preventDefault(),this.setState({comments_on:!0})},turnOnFeedback:function(){return this.state.contextActivityStore.update_feedback_setting(t.clone(this.state.activity),this.getActivityUser(),!1,function(e){return function(t){return e.setState({activity:t})}}(this))},turnOffFeedback:function(){return this.state.contextActivityStore.update_feedback_setting(t.clone(this.state.activity),this.getActivityUser(),!0,function(e){return function(t){return e.setState({activity:t})}}(this)),this.turnOffComments()},onSubscribeUpdated:function(e){return this.setState({activity:e})},hide:function(e){var t;return e.preventDefault(),this.setState({visible:!1}),this.state.activity&&N.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_COMMENTS_HIDDEN,this.state.activity.activity_key,null,null,this.getActivityUser().id,this.props.activityContext),"function"==typeof(t=this.props).hideToggledCallback?t.hideToggledCallback(!1):void 0},show:function(e){var t;return e.preventDefault(),this.setState({visible:!0}),this.state.activity&&N.log_event(Constants.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_COMMENTS_SHOWN,this.state.activity.activity_key,null,null,this.getActivityUser().id,this.props.activityContext),"function"==typeof(t=this.props).hideToggledCallback?t.hideToggledCallback(!0):void 0},fitToHeight:function(e){return this.state.height!==e?this.setState({height:e}):void 0},_refreshWidth:function(){var t,n;return e(".video-js").length&&e(".video-js").css("width","100%"),t=this.state.enabled?e(this.getDOMNode()).width():0,"function"==typeof(n=this.props).previewWidthCallback?n.previewWidthCallback(t):void 0},_shouldFetchActivity:function(){return this.props.activityContext&&this.props.activityContextData&&!this.state.is_fetching_activity},_onActivitySuccessfullyFetched:function(e){return this.isMounted()?(e.feedback_off?this.turnOffComments():this.turnOnComments(),this.fileViewerState.setFile(e),this.enable(),this.setState({activity:e,is_fetching_activity:!1},function(t){return function(){return!e.feedback_off&&t.modals&&t.modals.set_activity_key(e.activity_key),t._isPreviewAndCommentsReady()&&t.onPreviewAndCommentsReady(),t._prepareSwitchRevisionUI(),t._markAllCommentsSeen()}}(this))):void 0},_fetchActivity:function(){var e,t,n;return t=function(e){return function(t){return e._onActivitySuccessfullyFetched(t),e.isMounted()&&e.getActivityUser().is_signed_in?e._startLiveUpdate():void 0}}(this),e=function(e){return function(){return e.disable(),e.setState({is_fetching_activity:!1})}}(this),E.SessionStorage.set("reload-timestamp",(new Date).getTime()),n=function(e){return function(n,i){return e.isMounted()&&(e._bolt_data=i),t(n)}}(this),this.state.contextActivityStore.fetch_activity_and_bolt_data(this.getActivityUser(),n,e,this.props.oref),this.setState({is_fetching_activity:!0})},_hasLoaded:function(){return null!=this.state.activity},_startLiveUpdate:function(){var e,t;return t=function(e){return function(t,n){return null==n&&(n=null),e.isMounted()?t.feedback_off?void e.turnOffComments():(e.turnOnComments(),e.setState({activity:t}),e._markAllCommentsSeen(),e.onNewActivity(n)):void 0}}(this),this._bolt_get_channel_states=function(){var e,t,n,i,o;return n=this.state.activity.activity_key,e=null!=(i=this._bolt_data)?i.revision:void 0,t=null!=(o=this._bolt_data)?o.token:void 0,[new v.SignedChannelState("file_activity",n,e,t)]},this._bolt_cb=function(e){return function(n){var i;if(1===(null!=n?n.length:void 0)&&n[0].unique_id===e.state.activity.activity_key)return i=function(i,o){var r;if(e.isMounted())return e._bolt_data=o,n=e._bolt_get_channel_states(),null!=(r=e._bolt_client)&&r.update_states(n),t(i,o.action_type)},E.SessionStorage.set("reload-timestamp",(new Date).getTime()),e.state.contextActivityStore.fetch_activity_and_bolt_data(e.getActivityUser(),i,null)}}(this),e=this._bolt_get_channel_states(),this._bolt_client=new v.BoltClient(e,this._bolt_cb,this._fetchActivity),this._bolt_client.start()},_stopLiveUpdate:function(){var e;return null!=(e=this._bolt_client)&&e.unsubscribe(),this._bolt_client=null},onNewActivity:function(e){var t;return this.setState({isNewCommentLoading:!1}),(null!=(t=this.refs.commentListUI)?t.isScrolledToBottom():void 0)||this.state.isSender||e!==Constants.FILE_ACTIVITY_ACTION_TYPE.NEW_COMMENT||this.setState({showNewComment:!0}),this.setState({isSender:!1})},checkCommentListScroll:function(){var e,t;return e=this.refs.commentListUI.isScrolledToBottom(),t=!e,t!==this.state.showBottomBar&&this.setState({showBottomBar:t}),e&&this.state.showNewComment?this.setState({showNewComment:!1}):void 0},onShowNewComment:function(){return this.refs.commentListUI.animateScrollToBottom(),this.setState({showNewComment:!1})},_markAllCommentsSeen:function(){var e,t,n;if(this.getActivityUser().is_signed_in)return t=function(e){return function(){return e.props.onActivityLoaded(e.state.activity)}}(this),n=this.state.activity.comment_activities,e=n[n.length-1],e?this.state.contextActivityStore.mark_comments_seen(this.state.activity,this.getActivityUser(),e.activity_key,t):void 0},render:function(){var e,t,i,o,r,s,a,l;return t=n.addons.classSet({"file-feedback":!0,hidden:!this.state.enabled}),this.state.enabled||"function"==typeof(l=this.props).previewWidthCallback&&l.previewWidthCallback(0),a=this.getActivityUser(),o=a.is_signed_in&&b.getGandalfRule("comments-web-feedback"),r=this.props.activityContext&&this.props.activityContextData&&"CONTROL"!==this.props.photoLikesVariant,s=this.props.activityContext&&this.props.activityContextData&&"CONTROL"!==this.props.photoSocialShareVariant,e=this.state.height,r&&(e-=se),s&&(i=te.get_height_by_activity_context(this.props.activityContext),e-=i),o&&(e-=X),this.state.visible&&this.state.comments_on||!this.props.canCollapse?fe.div({id:this.props.feedbackId,className:t,tabIndex:"-1",style:{height:this.state.height}},r?ee({contextActivityStore:this.state.contextActivityStore,activity:this.state.activity,height:se,user:a}):void 0,s?te.FileFeedbackSharingSection({activity_context:this.props.activityContext,activity_context_data:this.props.activityContextData,height:i,user:a}):void 0,this.props.activityContext&&this.props.activityContextData?fe.div({className:"comments-and-feedback"},K({key:"comment_list_"+this.props.activityContext+"_"+this.props.activityContextData,ref:"commentListUI",activity:this.state.activity,contextActivityStore:this.state.contextActivityStore,fileViewerInterfaceController:this.fileViewerInterfaceController,height:e,user:a,fileViewerState:this.fileViewerState,contactSearchLogger:this.contactSearchLogger,enableFacepile:b.isGandalfInVariant("dw-comments-notify-facepile","FACEPILE"),enableNoNotifyHint:b.isGandalfInVariant("dw-comments-no-notify-hint","CONTROL"),forceNullStateLoadingState:this.props.forceNullStateLoadingState,isNewCommentLoading:this.state.isNewCommentLoading,isSender:this.state.isSender,isUserSubscribed:this._isUserSubscribed(),shouldAutoLinkify:this.props.shouldAutoLinkify,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,showNewComment:this.state.showNewComment,showResolvedComments:this.state.showResolvedComments,isCommentInputDisabled:this.state.isCommentInputDisabled,enableImport:this.props.enableImport,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isThreadingEnabled:this._isThreadingEnabled(),isTinyAnnotationUIEnabled:this.isTinyAnnotationUIEnabled,onAddCommentFromList:this.onAddCommentFromList,onAddSticker:this.onAddCommentFromSticker,onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,onDeleteCommentFromList:this.onDeleteCommentFromList,onFacepileContactAdded:this.onFacepileContactAdded,onHideCommentsPane:this.hide,onInputBlur:this.props.onInputBlur,onInputFocus:this.props.onInputFocus,onLikeComment:this.onLikeCommentFromList,onResolveCommentFromList:this.onResolveCommentFromList,checkScroll:this.checkCommentListScroll,onShowNewComment:this.onShowNewComment,onSubscribeUpdated:this.onSubscribeUpdated,onToggleShowResolvedComments:this.onToggleShowResolvedComments,shouldShowHideButton:this.props.canCollapse,toggleFeedbackForViewer:this.toggleFeedbackForViewer,turnOffFeedbackCallback:this.turnOffFeedback,turnOnFeedbackCallback:this.turnOnFeedback,verifyAfterSignUpCallback:this._verifyAfterSignUpCallback}),o?fe.div({className:"comments-feedback-link",style:{height:X}},fe.div({className:"comments-feedback-link-inner"},fe.a({onMouseUp:this.showFeedbackModal},le({},"Send feedback about Comments")))):void 0):void 0):this.state.comments_on&&!this.state.visible?fe.div({id:this.props.feedbackId,className:"hidden-comments",style:{height:this.state.height}},fe.div({className:"show-button "+this.props.showButtonColor,onMouseDown:this.show},fe.div({className:"show-button-sprite"},de({group:"web",name:"s_show_comments_grey"})))):this._hasLoaded()&&this.state.activity.can_edit_feedback?fe.div({id:this.props.feedbackId,className:"hidden-comments",style:{height:this.state.height},onMouseOver:this.setUnlockedIcon,onMouseOut:this.setLockedIcon},fe.div({className:"show-button "+this.props.showButtonColor,onMouseDown:this.turnOnComments},fe.div({className:"show-button-sprite"},de({group:"web",name:this.state.icon})))):fe.div({id:this.props.feedbackId,className:"hidden"})}}),ne=n.createFactory(ie),re=n.createClass({displayName:"FileViewerFeedbackUI",getInitialState:function(){return this.setCommentsVisibility(!0),this._enabledPreload=b.getGandalfRule("dw-comments-preload"),this._enabledPreload&&(this._activityCache=new p),{}},componentDidMount:function(){var t;return e("#file-viewer").on("db:filepreview:open",function(t){return function(n,i,o,r,s,a,l,u){return e("#file-viewer").addClass("comments"),clearTimeout(t.feedbackLoadTimer),t.feedbackLoadTimer=setTimeout(function(){return t._setFile(i,o,r,!1,u,s,l)},10)}}(this)),e("#file-viewer").on("db:filepreview:prev db:filepreview:next",function(e){return function(t,n,i,o,r){var s,a;return s=null!=(a=e.refs.fileFeedback)?a.resetToBlankState():void 0,clearTimeout(e.feedbackLoadTimer),e.feedbackLoadTimer=setTimeout(function(){return e._setFile(n,i,o,!s,r)},250)}}(this)),e("#file-viewer").on("db:filepreview:close",function(e){return function(){var t;return null!=(t=e.refs.fileFeedback)&&t.close(),e.setState({activityContext:null,activityContextData:null})}}(this)),t=function(t){return function(){return e("#file-viewer").addClass("comments"),t.autoResize()}}(this),e("#file-viewer").on("preview_failed",t),e(window).resize(function(e){return function(){return e.autoResize()}}(this))},onActivityLoaded:function(t){return e(document).trigger(Z.FILE_ACTIVITY_UPDATE,[this.state.file,t])},_getContextAndContextDataFromFile:function(e,t){var n,i;return __indexOf.call(o.FileViewModeCategories.SHARED_LINK_FILE_VIEW_MODE_TYPES,t)>=0?(n=q.SHARED_LINK_VIEW,i=e.href):__indexOf.call(o.FileViewModeCategories.MEMBER_LINK_FILE_VIEW_MODE_TYPES,t)>=0?(n=q.MEMBER_LINK_VIEW,i=e.href):(n=q.BROWSE_FILE_VIEWER,i=e.fq_path),[n,i]},_preloadActivities:function(e,t,n,i){var o,r,s,a,l,u,c,_;if(this._enabledPreload){for(r=[],a=[],c=t.map(function(e){return function(t){return e._getContextAndContextDataFromFile(t,n)}}(this)),l=0,u=c.length;u>l;l++)_=c[l],o=_[0],s=_[1],r.push(o),a.push(s);return this._activityCache.fetchActivities(e,r[0],a,i)}},_setFile:function(e,t,n,i,o,r,s){var a,l,u,c;return null==i&&(i=!1),null==o&&(o=[]),null==r&&(r=!1),null==s&&(s=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN),c=this._getContextAndContextDataFromFile(e,t),a=c[0],l=c[1],a===q.SHARED_LINK_VIEW&&(n=me.work_user||me.personal_user?(me.work_user||me.personal_user).id:void 0),u={activityContext:a,activityContextData:l,file:e,key:""+e.ns_id+"_"+e.sjid,viewingUserId:n,forceNullStateLoadingState:i,shouldInitiallyFocusInput:r,oref:s},this._preloadActivities(n,o,t,s),this.setState(u,function(e){return function(){return e.autoResize()}}(this))},render:function(){return fe.div({},ne({ref:"fileFeedback",activityContext:this.state.activityContext,activityContextData:this.state.activityContextData,onActivityLoaded:this.onActivityLoaded,feedbackId:"file-comments",previewWidthCallback:this.setPreviewWidth,showButtonColor:"white",userId:this.state.viewingUserId,key:this.state.key,visible:this._commentsVisible,hideToggledCallback:this.setCommentsVisibility,previewSelector:"#file-viewer-container .preview .preview-content-container",forceNullStateLoadingState:this.state.forceNullStateLoadingState,shouldInitiallyFocusInput:this.state.shouldInitiallyFocusInput,oref:this.state.oref,file:this.state.file,activityCache:this._activityCache}))},setCommentsVisibility:function(e){return this._commentsVisible=e},autoResize:function(){var t,n,i;return t=e("#file-viewer").hasClass("no-preview")?e(window).height():e("#file-viewer-container").height()-e("#file-viewer-container .title-bar").height(),this.setPreviewWidth(e(null!=(n=this.refs.fileFeedback)?n.getDOMNode():void 0).width()),null!=(i=this.refs.fileFeedback)?i.fitToHeight(t):void 0},setPreviewWidth:function(t){var n,i,o,r,s,a;return n=e("#file-viewer"),i=n.find("#file-viewer-container"),r=i.find(".preview"),0!==r.length?(n.hasClass("no-preview")?(a=i.width()-t,s=t?(e(window).width()-t)/2+"px":""+e(window).width()/2+"px"):"True"===n.attr("data-docpreview-ui-rams-enabled")&&(n.hasClass("doc-preview")||n.hasClass("html-preview")||n.hasClass("htmlified-preview")||n.hasClass("adobecs-preview")||n.hasClass("linkfile-preview")||n.hasClass("photo-preview")||n.hasClass("video-preview"))?(a=oe.is_rams_fullscreen_active()?window.innerWidth:i.width()-t,s="0"):(a=i.width()-t,s="50%"),r.width()!==a&&(r.width(a),o=i.find(".loading"),null!=o&&o.width(a)),r.css("left")!==s?i.css("left",s):void 0):void 0}}),ce=n.createClass({displayName:"SharedLinkFeedbackUI",getInitialState:function(){return{}},componentDidMount:function(){return"photo"===this.props["preview-type"]&&(e("#preview-img").on("photo-zoom",this.autoResize),e("#full-img").on("photo-unzoom",this.autoResize)),e(window).resize(this.autoResize),this.autoResize()},render:function(){return fe.div({className:"shmodel-comments"},ne({showButtonColor:"white",previewWidthCallback:this.setPreviewWidth,activityContext:this.props["activity-context"],activityContextData:this.props["shared-link-url"],photoLikesVariant:this.props["photo-likes-variant"],photoSocialShareVariant:this.props["photo-social-share-variant"],ref:"fileFeedback",feedbackId:"file-comments",key:this.props["shared-link-url"],visible:!0,previewSelector:this.previewSelector()}))},autoResize:function(){var t,n,i,o,r,s,a;return o=parseInt(e("#file-comments").css("top")),r=e(window).height(),i=r-o,null!=(s=this.refs.fileFeedback)&&s.fitToHeight(i),t=e(null!=(a=this.refs.fileFeedback)?a.getDOMNode():void 0),n=t.visible()?t.outerWidth():0,this.setPreviewWidth(n)},setPreviewWidth:function(t){var n,i,o;if(null!=this.previewSelector()&&(n=e(this.previewSelector()),0!==n.length))return n.data("rams-fullscreen")?i=e(window).width():(o=n.outerWidth()-n.width(),i=e(window).width()-t-o),n.width()!==i?n.width(i):void 0},previewSelector:function(){return null==this.props["preview-type"]?"#shmodel-content-area #default-content":{doc:"#shmodel-content-area .preview-box #pdf-embed-container",photo:"#shmodel-content-area .preview-box",video:"#shmodel-content-area .preview-box",text:"#shmodel-content-area #htmlified-wrapper",html:"#shmodel-content-area",download:"#shmodel-content-area",excel:"#shmodel-content-area #html-container",adobecs:"#shmodel-content-area .preview-box #pdf-embed-container",linkfile:"#shmodel-content-area .preview-box"}[this.props["preview-type"]]}}),he=n.createClass({displayName:"StandaloneFeedbackUI",render:function(){return fe.div({},ne({activityContext:q.BROWSE_FILE_VIEWER,activityContextData:this.props["fq-path"],canCollapse:!1,enableImport:!1,feedbackId:"file-comments",key:this.props["fq-path"],ref:"fileFeedback",shouldAutoLinkify:!1,showButtonColor:"white",shouldHidePhotoAvatars:!0,shouldUseSimpleModals:!0,visible:!0}))},componentDidMount:function(){return this.refs.fileFeedback.fitToHeight(window.innerHeight)}}),pe=n.createFactory(he),{FileViewerFeedbackUI:re,SharedLinkFeedbackUI:ce,StandaloneFeedbackUI:pe,FileFeedbackUIClass:ie}}),define("modules/dirty/react/file_comments/switch_revision_ui",["jquery","external/react","modules/clean/datetime"],function(e,t,n){var i,o,r;return r=t.DOM,i=t.addons.CSSTransitionGroup,o=t.createClass({displayName:"SwitchRevisionUI",propTypes:{showSwitchRevisionUI:t.PropTypes.bool,onSwitchToLatestRevision:t.PropTypes.func,revision:t.PropTypes.object},getInitialState:function(){return{}},getDefaultProps:function(){return{showSwitchRevisionUI:!1}},onSwitchToLatestRevision:function(){var e;return"function"==typeof(e=this.props).onSwitchToLatestRevision?e.onSwitchToLatestRevision():void 0},render:function(){var e;return e=[],this.props.showSwitchRevisionUI&&(e=[r.div({className:"switch-revision-bar"},r.div({className:"switch-revision-bar__title"},r.span({},"Viewing old revision"),null==this.props.revision||null==this.props.revision.when||isNaN(new Date(null!=this.props.revision.when))?void 0:r.span({className:"switch-revision-bar__title__date"},""+n.ago(new Date(1e3*this.props.revision.when)))),r.div({className:"switch-revision-bar__actions"},r.a({className:"button-elm button-tertiary",onMouseUp:this.onSwitchToLatestRevision},"Switch back to latest revision")))]),r.div({className:"switch-revision-ui"},i({transitionName:"switch-revision-ui"},this.props.showSwitchRevisionUI?e:void 0))}})});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/dirty/react/openwith/open_with_tooltip",["dropbox","external/react","modules/core/i18n","modules/clean/ajax","modules/clean/open_with","modules/clean/react/button","modules/clean/react/sprite_div","modules/clean/react/sprite","jquery"],function(e,t,n,i,o,r,s,a,l){var u,c,_,d,p,h,f;return u=e.FileViewer,c=e.FreshDropdown,h=n._,d=r.button,f={HIDDEN:0,VISIBLE:1},p=t.DOM,_=t.createClass({displayName:"OpenWithTooltip",propTypes:{availabletooltips:t.PropTypes.object,buttonindex:t.PropTypes.number.isRequired},getInitialState:function(){return{visibility_state:f.HIDDEN,extension:null,tooltip_vendor:null,tooltip_application:null,target_button:null}},_setStateHidden:function(){return this.setState(this.getInitialState())},componentDidMount:function(){return u.globalOpenWithWebButtonStateModel.on("change",function(e){return function(){return e._handleStateChange(u.globalOpenWithWebButtonStateModel.get("user_id"),u.globalOpenWithWebButtonStateModel.get("state"),u.globalOpenWithWebButtonStateModel.get("file_extension"),u.globalOpenWithWebButtonStateModel.get("target_button"))}}(this))},componentDidUpdate:function(){var e;return this.state.visibility_state===f.VISIBLE&&(e=this.state.target_button[this.props.buttonindex],l(e).is(":visible"))?(c.show(l(this.refs.tooltip.getDOMNode()),e,null,!0),l(e).removeClass("pressed")):void 0},render:function(){var e,t;return this.state.visibility_state===f.HIDDEN?p.div({id:"open-with-onboarding-tooltip",className:"hidden"}):(t=this.props.availabletooltips[this.state.tooltip_vendor][this.state.tooltip_application].icon,e=this.props.availabletooltips[this.state.tooltip_vendor][this.state.tooltip_application].blurb,p.div({id:"open-with-onboarding-tooltip",className:"chat-bubble freshdropdown-menu black open-with-onboarding-tooltip",
ref:"tooltip"},p.ul({},p.li({},p.div({className:"content-wrapper"},a({group:"web",name:t}),p.div({className:"text-wrapper"},p.span({className:"tooltip-new"},h("New!"))," ",e),d({className:"dismiss-button",importance:"tertiary"},h("OK")))),p.div({className:"chat-bubble-arrow black"}))))},_handleStateChange:function(e,t,n,i){var o,r,s,a,l,u,c,_,d,p;if("hidden"===t)return this._setStateHidden();if(this.state.visibility_state===f.VISIBLE&&n===this.state.extension)return void this.setState({visibility_state:f.VISIBLE,extension:this.state.extension,target_button:i});l=!1,c=null,u=null,p=this.props.availabletooltips;for(_ in p){d=p[_];for(s in d)if(o=d[s],r=o.extensions,__indexOf.call(r,n)>=0){l=!0,c=_,u=s;break}}return l?(this.setState({visibility_state:f.VISIBLE,extension:n,tooltip_vendor:c,tooltip_application:u,target_button:i}),a=this.props.availabletooltips,a[c][u].extensions=[],this.setProps({availabletooltips:a}),this._logImpression(n,e)):void this._setStateHidden()},_logImpression:function(e,t){return i.AuthenticatedRequest({url:"/ow/msft/log_tooltip_impression",data:{extension:e},subject_user:t})}}),{OpenWithTooltip:_}});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/dirty/react/previews/preview_toolbar",["dropbox","external/react","jquery","modules/clean/analytics","modules/clean/filepath","modules/clean/frame_messenger","modules/clean/keycode","modules/clean/react/sprite","modules/core/dom","modules/core/exception","modules/core/i18n"],function(e,t,n,i,o,r,s,a,l,u,c){var _,d,p,h,f,m,g,v,y,b,w;return _=e.FilePreview,p=e.FileViewer,d=e.FileViewRamsCommon,v=e.SharingModel,f=i.PreviewActivityLogger,y=u.assert,b=t.DOM,w=c._,g={DEFAULT:"default",SPP:"spp",SPREADSHEET:"spreadsheet",HTML:"html"},h={},h[s.ESC]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.SPACE]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.PAGE_UP]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.PAGE_DOWN]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.LEFT]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.UP]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.RIGHT]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.DOWN]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.EQUALS]={altKey:!0,ctrlKey:!0,metaKey:!0},h[70]={altKey:!1,ctrlKey:!1,metaKey:!1},h[80]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.PLUS_EQUALS_FF]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.MINUS_FF]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.PLUS_EQUALS_FF_GERMAN]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.MINUS_FF_MAC]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.PLUS_CHROME]={altKey:!0,ctrlKey:!0,metaKey:!0},h[s.MINUS_CHROME]={altKey:!0,ctrlKey:!0,metaKey:!0},m=t.createClass({displayName:"PreviewToolbar",propTypes:{"viewer-type":t.PropTypes.string.isRequired},printNativeForViewerType:{FILE_VIEWER:n.proxy(p.nativePdfPrint,p),FILE_PREVIEW:n.proxy(_.nativePdfPrint,_)},_TOOLBAR_ENTRY_CLASSES:{PAGE_INDICATOR:"page-indicator",ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",PAGE_UP:"page-up",PAGE_DOWN:"page-down",FULLSCREEN:"fullscreen",PRINT:"print"},_ELEMENT_CONFIGURATIONS:{"default":["page-indicator","zoom-in","zoom-out","page-up","page-down","fullscreen","print"],spp:["page-indicator","page-up","page-down","fullscreen","print"],spreadsheet:["zoom-in","zoom-out","fullscreen","print"],html:["fullscreen","print"]},_PARENT_TO_IFRAME_ACTIONS:{ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",PAGE_UP:"page-up",PAGE_DOWN:"page-down",ENTER_FULLSCREEN:"enter-fullscreen",EXIT_VIEWER_FULLSCREEN:"exit-viewer-fullscreen",PRINT:"print",CLEAR_MOUSE_TRACKING:"clear-mouse-tracking",SCROLL_DOWN:"scroll-down",SCROLL_UP:"scroll-up",SCROLL_LEFT:"scroll-left",SCROLL_RIGHT:"scroll-right",SCREEN_DOWN:"screen-down",SCREEN_UP:"screen-up"},_VIEWER_TYPES:["FILE_PREVIEW","FILE_VIEWER"],_FADE_TIME_MSEC:400,_IDLE_TIME_MSEC:1500,_trustedIframeDomain:null,_fadeTimeout:null,_fullscreeningTimeout:null,_idleTimeout:null,_frameMessenger:null,_previewOpen:!1,getInitialState:function(){var e,t;return t=this.props["viewer-type"].toUpperCase(),y(__indexOf.call(this._VIEWER_TYPES,t)>=0,"Preview Toolbar received an unknown viewer-type parameter"),e={pagesCount:0,currentPage:0,visible:!1,fadingOut:!1,fullscreening:!1,disabledClasses:[],viewerType:t,docType:g.DEFAULT}},_reset:function(){return null!=this._fadeTimeout&&(clearTimeout(this._fadeTimeout),this._fadeTimeout=null),null!=this._fullscreeningTimeout&&(clearTimeout(this._fullscreeningTimeout),this._fullscreeningTimeout=null),this.setState({pagesCount:0,currentPage:0,visible:!1,fadingOut:!1,fullscreening:!1,disabledClasses:[],docType:g.DEFAULT})},_setFullscreen:function(e,t){var i,o;switch(null==t&&(t=!0),this.state.viewerType){case"FILE_VIEWER":e?p.enter_rams_fullscreen():p.exit_rams_fullscreen();break;case"FILE_PREVIEW":e?_.enter_rams_fullscreen():_.exit_rams_fullscreen()}return null!=this._fullscreeningTimeout&&clearTimeout(this._fullscreeningTimeout),e?this.fadeOut():(this.fadeIn(),this._startIdleTimeout()),this.setState({fullscreening:!0}),o=function(e){return function(){return e._fullscreeningTimeout=null,e.setState({fullscreening:!1})}}(this),this._fullscreeningTimeout=setTimeout(n.proxy(o,this),d.RAMS_FULLSCREEN_TRANSITION_TIME_MSEC),this._setBrowserFullscreen(e),t?(i=e?this._PARENT_TO_IFRAME_ACTIONS.ENTER_FULLSCREEN:this._PARENT_TO_IFRAME_ACTIONS.EXIT_VIEWER_FULLSCREEN,this._frameMessenger.postMessageToChildren(i)):void 0},_isViewerFullscreen:function(){switch(this.state.viewerType){case"FILE_VIEWER":return p.is_rams_fullscreen_active();case"FILE_PREVIEW":return _.is_rams_fullscreen_active();default:return console.warn("Unexpected viewerType ("+this.state.viewerType+")"),!1}},_isBrowserFullscreen:function(){return null!=document.fullScreen?document.fullScreen:null!=document.webkitIsFullScreen?document.webkitIsFullScreen:null!=document.mozFullScreen?document.mozFullScreen:null!=document.msFullscreenElement||null!=document.fullscreenElement},_handleClick:function(e){var t,n,i,o,r,s;for(i={input_method:"click",file_ext:this._getOriginalFileExtension()},t=e.currentTarget,s=this.state.disabledClasses,o=0,r=s.length;r>o;o++)if(n=s[o],t.hasClassName(n))return;return t.hasClassName(this._TOOLBAR_ENTRY_CLASSES.ZOOM_IN)?this._zoomIn(i):t.hasClassName(this._TOOLBAR_ENTRY_CLASSES.ZOOM_OUT)?this._zoomOut(i):t.hasClassName(this._TOOLBAR_ENTRY_CLASSES.PAGE_UP)?this._pageUp(i):t.hasClassName(this._TOOLBAR_ENTRY_CLASSES.PAGE_DOWN)?this._pageDown(i):t.hasClassName(this._TOOLBAR_ENTRY_CLASSES.FULLSCREEN)?this._toggleFullscreen(i):t.hasClassName(this._TOOLBAR_ENTRY_CLASSES.PRINT)&&this._printDocument(i),this._frameMessenger.postMessageToChildren(this._PARENT_TO_IFRAME_ACTIONS.CLEAR_MOUSE_TRACKING)},_getIframeQuery:function(){switch(this.state.viewerType){case"FILE_VIEWER":return".preview-content-container > iframe";case"FILE_PREVIEW":return".preview-box iframe";default:return null}},_handleMessageFromChild:function(e){var t,n,i,o,r;switch(i={input_method:"child-message",file_ext:this._getOriginalFileExtension()},e.action){case"page-change":if(r=this._isToolbarReadyToShow(),t=this._sanitizePageNumber(e.parameters.current_page),o=this._sanitizePageNumber(e.parameters.pages_count),0>=t||0>=o)return;if(null!=e.parameters.doc_type&&this.setState({docType:e.parameters.doc_type}),n=[],1>=t&&n.push(this._TOOLBAR_ENTRY_CLASSES.PAGE_UP),t>=o&&n.push(this._TOOLBAR_ENTRY_CLASSES.PAGE_DOWN),this.setState({currentPage:t,pagesCount:o,disabledClasses:n}),!r&&this._isToolbarReadyToShow())return this.fadeIn(),this._startIdleTimeout();break;case"idle-mouse":return this.fadeOut(),f.log("idle-mouse",i);case"active-mouse":return this.fadeIn(),f.log("active-mouse",i);case"exit-parent-fullscreen":return this._setFullscreen(!1),f.log("exit-fullscreen",i);case"keydown":if(null!=e.parameters)return this.onKeydown(e.parameters);break;case"get-keydown-keys-handled-by-parent":return this._frameMessenger.postMessageToChildren("keydown-keys-handled-by-parent",{keycodes:h})}},onPreviewOpen:function(){return this._previewOpen?!0:(n(document).on("keydown",this.onKeydown),n(document).on("fullscreenchange",this.onBrowserFullscreenChange),n(document).on("webkitfullscreenchange",this.onBrowserFullscreenChange),n(document).on("msfullscreenchange",this.onBrowserFullscreenChange),n(document).on("mozfullscreenchange",this.onBrowserFullscreenChange),this._previewOpen=!0,!0)},onPreviewClose:function(){return this._previewOpen?(n(document).off("keydown",this.onKeydown),n(document).off("fullscreenchange",this.onBrowserFullscreenChange),n(document).off("webkitfullscreenchange",this.onBrowserFullscreenChange),n(document).off("msfullscreenchange",this.onBrowserFullscreenChange),n(document).off("mozfullscreenchange",this.onBrowserFullscreenChange),this._reset(),this._frameMessenger.resetOriginsForPosting(),this._previewOpen=!1,!0):!0},componentDidMount:function(){var e;return window.addEventListener("message",this.handleViewerMessage),"FILE_VIEWER"===this.state.viewerType?(e=n("#file-viewer"),1===e.length&&(e.on("db:filepreview:open",this.onPreviewOpen),e.on("db:filepreview:close",this.onPreviewClose))):"FILE_PREVIEW"===this.state.viewerType&&this.onPreviewOpen(),this._frameMessenger=new r,this._frameMessenger.configureChildMessaging(this._getIframeQuery(),n.proxy(this._handleMessageFromChild,this),["page-change","idle-mouse","active-mouse","exit-parent-fullscreen","keydown","child-focus","get-keydown-keys-handled-by-parent"]),this._frameMessenger.startListening()},componentWillUnmount:function(){var e;if(window.removeEventListener("message",this.handleViewerMessage),"FILE_VIEWER"===this.state.viewerType){if(e=n("#file-viewer"),1===e.length)return e.off("db:filepreview:open",this.onPreviewOpen),e.off("db:filepreview:close",this.onPreviewClose)}else if("FILE_PREVIEW"===this.state.viewerType)return this.onPreviewClose()},renderPageIndicatorText:function(){var e;return this.state.currentPage<1||this.state.pagesCount<1?"":(e=w(this.state.docType===g.SPP?"Slide %(current_page)s of %(pages_count)s":"Page %(current_page)s of %(pages_count)s"),e.format({current_page:this.state.currentPage,pages_count:this.state.pagesCount}))},_renderToolbarButton:function(e,t,n,i){var o,r;return __indexOf.call(this._ELEMENT_CONFIGURATIONS[this.state.docType],e)<0?b.span({style:{display:"none"}}):(o=e+" toolbar-button-entry",r=__indexOf.call(this.state.disabledClasses,e)>=0,b.div({className:o,onMouseUp:this._handleClick},b.div({className:"toolbar-tooltip"},b.div({className:"toolbar-tooltip-container"},b.div({className:"toolbar-tooltip-pointer-border"})),b.div({className:"toolbar-tooltip-container"},b.div({className:"toolbar-tooltip-body"},i)),b.div({className:"toolbar-tooltip-container"},b.div({className:"toolbar-tooltip-pointer"}))),a({group:t,name:n,className:r?"disabled":""})))},_renderPageIndicator:function(){var e;return e=this._TOOLBAR_ENTRY_CLASSES.PAGE_INDICATOR,__indexOf.call(this._ELEMENT_CONFIGURATIONS[this.state.docType],e)>=0?b.div({className:this._TOOLBAR_ENTRY_CLASSES.PAGE_INDICATOR},this.renderPageIndicatorText()):void 0},render:function(){var e,t,n,i,o,r;return e="preview-toolbar-overlay-container ",this.state.visible||(e+="hide "),this.state.fadingOut&&(e+="fadeout "),t={className:e},r=w(this.state.docType===g.SPP?"Previous slide":"Page up"),i=w(this.state.docType===g.SPP?"Next slide":"Page down"),o=this.state.docType===g.SPP?"left":"up",n=this.state.docType===g.SPP?"right":"down",b.div(t,b.div({className:"preview-toolbar-overlay",onMouseEnter:this.onMouseEnterToolbar},b.div({className:"preview-toolbar-content"},this._renderPageIndicator(),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.ZOOM_OUT,"web","zoomout",w("Zoom out")),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.ZOOM_IN,"web","zoom",w("Zoom in")),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.PAGE_UP,"web",o,r),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.PAGE_DOWN,"web",n,i),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.FULLSCREEN,"web","fullscreen",w("Fullscreen")),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.PRINT,"web","print",w("Print")))))},_sanitizePageNumber:function(e){var t;return null==e?0:(t=parseInt(e),isNaN(t)?0:t)},_getOriginFromUrl:function(e){var t;return t=document.createElement("a"),t.href=e,"https://"+t.hostname},fadeOut:function(){return null==this._fadeTimeout||this.state.fadingOut||(clearTimeout(this._fadeTimeout),this._fadeTimeout=null),this.setState({fadingOut:!0,tooltipClass:null}),this._fadeTimeout=setTimeout(function(e){return function(){return e._fadeTimeout=null,e.setState({visible:!1,fadingOut:!1})}}(this),this._FADE_TIME_MSEC)},fadeIn:function(){return this._clearIdleTimeout(),this._isViewerFullscreen()||n("html").hasClass("no-flexbox")?void 0:this._isToolbarReadyToShow()?(null!=this._fadeTimeout&&(clearTimeout(this._fadeTimeout),this._fadeTimeout=null),this.setState({visible:!0,fadingOut:!1})):void 0},onMouseEnterToolbar:function(){return this._frameMessenger.postMessageToChildren(this._PARENT_TO_IFRAME_ACTIONS.CLEAR_MOUSE_TRACKING),this._clearIdleTimeout()},onKeydown:function(e){var t,i,o,r;return i=!1,!this._frameMessenger.childIsValidated()||"dbmodal"===key.getScope()||l.focus_in_input()||l.is_input(e.target)||null!=e.target&&(t=n("#file-comments"),1!==t.length&&(t=n("#photo-comments")),1===t.length&&(e.target===t[0]||n.contains(t[0],e.target)))?void 0:(r={input_method:"keydown",file_ext:this._getOriginalFileExtension(),extra:JSON.stringify({keycode:e.keyCode})},o=e.keyCode,this.state.docType!==!g.SPP||o!==s.EQUALS&&o!==s.PLUS_EQUALS_FF&&o!==s.PLUS_CHROME&&o!==s.PLUS_EQUALS_FF_GERMAN?this.state.docType!==!g.SPP||o!==s.MINUS_FF_MAC&&o!==s.MINUS_FF&&o!==s.MINUS_CHROME?o===s.LEFT?(this.state.docType===g.SPP?this._pageUp(r):this._scrollLeft(r),i=!0):o===s.RIGHT?(this.state.docType===g.SPP?this._pageDown(r):this._scrollRight(r),i=!0):o===s.PAGE_UP?(this.state.docType===g.SPP?this._pageUp(r):this._screenUp(r),i=!0):o===s.SPACE||o===s.PAGE_DOWN?(this.state.docType===g.SPP?this._pageDown(r):this._screenDown(r),i=!0):o===s.UP?(this.state.docType===g.SPP?this._pageUp(r):this._scrollUp(r),i=!0):o===s.DOWN?(this.state.docType===g.SPP?this._pageDown(r):this._scrollDown(r),i=!0):70!==o||e.ctrlKey||e.metaKey?80===o?(this._printDocument(r),i=!0):o===s.ESC&&(this._isViewerFullscreen()?this._exitFullscreen(r):"FILE_VIEWER"===this.state.viewerType&&this._exitPreview(r),i=!0):(this._isViewerFullscreen()?this._exitFullscreen(r):this._enterFullscreen(r),i=!0):(this._zoomOut(r),i=!0):(this._zoomIn(r),i=!0),i&&null!=e.preventDefault&&e.preventDefault(),!i)},onIdleTimeout:function(){return this._clearIdleTimeout(),this.fadeOut()},_startIdleTimeout:function(){return this._clearIdleTimeout(),this._idleTimeout=setTimeout(n.proxy(this.onIdleTimeout,this),this._IDLE_TIME_MSEC)},_clearIdleTimeout:function(){return null!=this._idleTimeout?(clearTimeout(this._idleTimeout),this._idleTimeout=null):void 0},_isToolbarReadyToShow:function(){return this.state.currentPage>0&&this.state.pagesCount>0},_getOriginalFileExtension:function(){switch(this.state.viewerType){case"FILE_PREVIEW":return o.file_extension_for_logging(v.filename);case"FILE_VIEWER":return o.file_extension_for_logging(p.file.filename);default:return console.warn("Unexpected viewer type in preview toolbar")}},_setBrowserFullscreen:function(e){var t;if(t=n("body")[0],e){if(null!=t.requestFullscreen)return t.requestFullscreen();if(null!=t.msRequestFullscreen)return t.msRequestFullscreen();if(null!=t.mozRequestFullScreen)return t.mozRequestFullScreen();if(null!=t.webkitRequestFullscreen)return t.webkitRequestFullscreen()}else{if(document.exitFullscreen)return document.exitFullscreen();if(document.msExitFullscreen)return document.msExitFullscreen();if(document.mozCancelFullScreen)return document.mozCancelFullScreen();if(document.webkitExitFullscreen)return document.webkitExitFullscreen()}},onBrowserFullscreenChange:function(){return this._isViewerFullscreen&&!this._isBrowserFullscreen()?this._setFullscreen(!1):void 0},_logData:function(e,t){return"string"==typeof t.input_method?f.log(e,t):y(!1,"logData not correctly formed"),"string"==typeof t.input_method},_logAndPostMessage:function(e,t,n){return this._logData(t,n)?this._frameMessenger.postMessageToChildren(e):void 0},_zoomIn:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.ZOOM_IN,"zoom-in",e)},_zoomOut:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.ZOOM_OUT,"zoom-out",e)},_pageUp:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.PAGE_UP,"page-up",e)},_pageDown:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.PAGE_DOWN,"page-down",e)},_screenUp:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCREEN_UP,"screen-up",e)},_screenDown:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCREEN_DOWN,"screen-down",e)},_scrollUp:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCROLL_UP,"scroll-up",e)},_scrollDown:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCROLL_DOWN,"scroll-down",e)},_scrollRight:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCROLL_RIGHT,"scroll-right",e)},_scrollLeft:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCROLL_LEFT,"scroll-left",e)},_toggleFullscreen:function(e){return this._isViewerFullscreen()?this._exitFullscreen(e):this._enterFullscreen(e)},_enterFullscreen:function(e){return this._logData("enter-fullscreen",e)?this._setFullscreen(!0):void 0},_exitFullscreen:function(e){return this._logData("exit-fullscreen",e)?this._setFullscreen(!1):void 0},_exitPreview:function(e){return this._logData("exit-preview",e)?p.hide():void 0},_printDocument:function(e){var t;return this._logData("print",e)&&(t=this.printNativeForViewerType[this.state.viewerType](),!t)?this._frameMessenger.postMessageToChildren(this._PARENT_TO_IFRAME_ACTIONS.PRINT):void 0}}),{PreviewToolbar:m,PreviewToolbarDocType:g}}),define("modules/dirty/search/search",["dropbox"],function(e){var t;return t=e.FileSearch,{run:function(){return t.search(!0)}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/search/search_bar",["jquery","external/underscore","dropbox","modules/core/exception","modules/core/i18n","modules/core/browser","modules/clean/ajax","modules/clean/analytics","modules/clean/filepath","modules/clean/keycode","modules/clean/page_role_observer","modules/clean/viewer","modules/constants/viewer","modules/dirty/search/search","modules/clean/search/search_helpers"],function(e,t,n,i,o,r,s,a,l,u,c,_,d,p,h){var f,m,g,v,y,b,w,C,S,E,T,k;return f=n.Browse,m=n.BrowseUtil,v=n.FileViewer,g=n.FileSearch,S=n.SearchType,E=n.Util,T=i.assert,k=o._,C=a.SearchClientActivityLogger,y=d.ROLE_PERSONAL,b=d.ROLE_WORK,w=function(){function n(t,i,o){var r;this.user_id=i,null==o&&(o={}),this._focusDropdownRow=__bind(this._focusDropdownRow,this),this._unfocusDropdownRow=__bind(this._unfocusDropdownRow,this),this._getDropdownRow=__bind(this._getDropdownRow,this),this._hasDropdownRowAtIndex=__bind(this._hasDropdownRowAtIndex,this),this._getDropdownRowCount=__bind(this._getDropdownRowCount,this),this._isSearchBarVisible=__bind(this._isSearchBarVisible,this),this._keyForElement=__bind(this._keyForElement,this),this._fileForKey=__bind(this._fileForKey,this),this._keyForDropdownIndex=__bind(this._keyForDropdownIndex,this),this._runSearch=__bind(this._runSearch,this),this._openSuggestionByFileKey=__bind(this._openSuggestionByFileKey,this),this._suggestionClicked=__bind(this._suggestionClicked,this),this._buildSuggestion=__bind(this._buildSuggestion,this),this._getDropdownRowFocuser=__bind(this._getDropdownRowFocuser,this),this._displaySuggestions=__bind(this._displaySuggestions,this),this._hideSuggestions=__bind(this._hideSuggestions,this),this._showSuggestions=__bind(this._showSuggestions,this),this._gatherSuggestions=__bind(this._gatherSuggestions,this),this._searchInputUpdate=__bind(this._searchInputUpdate,this),this._trackKeyDownInSearchBar=__bind(this._trackKeyDownInSearchBar,this),this._searchBarUnFocused=__bind(this._searchBarUnFocused,this),this._searchBarFocused=__bind(this._searchBarFocused,this),this.blur=__bind(this.blur,this),this.focus=__bind(this.focus,this),this._on_search_bar_transition_end=__bind(this._on_search_bar_transition_end,this),this._on_role_change=__bind(this._on_role_change,this),this._on_window_blur=__bind(this._on_window_blur,this),this._on_window_focus=__bind(this._on_window_focus,this),this._debug_log=__bind(this._debug_log,this),this.$search_bar_holder=e(t),this.$search_bar=this.$search_bar_holder.find("#browse-search-input input"),this.$search_button=this.$search_bar_holder.find("#search-button"),this.$suggestion_list_holder=this.$search_bar_holder.find("#browse-search-suggested-list"),this.$suggestion_list=this.$suggestion_list_holder.find(".search-results"),this.$search_text=this.$suggestion_list_holder.find(".search-text"),this.$search_loading=this.$suggestion_list_holder.find("#search-loading"),this._prev_search_val="",this._prev_search_scope="",this._focused_dropdown_row=-1,this._window_blurred=!1,this._debug=!1,e(window).on("blur",this._on_window_blur),e(window).on("focus",this._on_window_focus),c.addListener(this._on_role_change),this.$search_bar.on("focus",function(e){return function(){return e._debug_log("input-focus"),setTimeout(function(){return e._searchBarFocused()},0)}}(this)),this.$search_bar.on("blur",function(e){return function(){return e._debug_log("input-blur"),setTimeout(function(){return e._searchBarUnFocused()},0)}}(this)),r="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",this.$search_bar.on(r,this._on_search_bar_transition_end),this.$search_bar.on("keydown",this._trackKeyDownInSearchBar),this.$search_button.on("click",this._runSearch),this.$search_text.on("mousedown",this._runSearch),this.$search_text.on("mousemove",this._getDropdownRowFocuser(0)),this._hideSuggestions(),this.$search_loading.hide(),o.listen_for_search_events===!0&&e(document).on(n.FOCUS_SEARCH_EVENT,this.focus)}return n.SEARCH_BAR_TRANSITION_DELAY=.1,n.FOCUS_SEARCH_EVENT="db:searchbar:focus",n.prototype._files={},n.prototype.teardown=function(){return e(document).off(n.FOCUS_SEARCH_EVENT,this.focus),e(window).off("blur",this._on_window_blur),e(window).off("focus",this._on_window_focus),c.removeListener(this._on_role_change)},n.prototype._debug_log=function(e){return this._debug?console.log("SearchBar: "+e):void 0},n.prototype._on_window_focus=function(){return this._window_blurred=!1},n.prototype._on_window_blur=function(){return this._window_blurred=!0},n.prototype._on_role_change=function(e){var t;return this.$search_bar.val(""),this._searchInputUpdate(),t=_.get_viewer(),this.user_id=t.get_user_by_role(e).id},n.prototype._on_search_bar_transition_end=function(e){return null==e&&(e=null),this.$search_bar.width()<=203?this.$suggestion_list_holder.hide():void 0},n.prototype.focus=function(){return this.$search_bar.trigger("focus"),this._searchBarFocused(!0)},n.prototype.blur=function(){return this.$search_bar.trigger("blur"),this._searchBarUnFocused(!0)},n.prototype.previewFile=function(e,t){var n;return null==t&&(t=!1),f.is_initialized?f.open_file(e,t,!0,Constants.OREF_CONSTANTS.BROWSE_SEARCHBOX):t===!0?void r.open_tab(e.href):e.dir?r.redirect(e.href):(n=_.get_viewer().get_user_by_id(this.user_id),v.show(e,n,{},Constants.OREF_CONSTANTS.BROWSE_SEARCHBOX))},n.prototype._scopedSearch=function(){return g.scoped_search&&null!=f.inside_dir&&f.inside_dir&&""!==f.containing_fq_path()?!0:!1},n.prototype._searchBarFocused=function(e){return null==e&&(e=!1),this._debug_log("unfocus, winblur="+this._window_blurred.toString()),!e&&this._window_blurred||this.$search_bar.hasClass("focused")?void 0:(this.$search_bar_holder.addClass("focused"),this.$search_bar.addClass("focused"),this._searchInputUpdate())},n.prototype._searchBarUnFocused=function(e){return null==e&&(e=!1),this._debug_log("unfocus, winblur="+this._window_blurred.toString()),!e&&this._window_blurred||!this.$search_bar.hasClass("focused")?void 0:(this.$search_bar.removeClass("focused"),this.$search_bar_holder.removeClass("focused"),this._hideSuggestions())},n.prototype._trackKeyDownInSearchBar=function(e){switch(e.keyCode){case u.ESC:return this._onEscKey(e);case u.ENTER:return this._onEnterKey(e);case u.UP:return this._onUpKey(e);case u.DOWN:return this._onDownKey(e);case u.TAB:return this._onTabKey(e);case u.LEFT:case u.RIGHT:break;default:return clearTimeout(this.search_key_up_timer),this.search_key_up_timer=setTimeout(function(e){return function(){return e._searchInputUpdate(!0)}}(this),100)}},n.prototype._onEscKey=function(){return this.blur()},n.prototype._onEnterKey=function(){return 0===this._focused_dropdown_row||-1===this._focused_dropdown_row?this._runSearch():this._openSuggestionByFileKey(this._keyForDropdownIndex(this._focused_dropdown_row),!1)},n.prototype._onUpKey=function(e){return this._isSearchBarVisible()?(this._focusDropdownRow(Math.max(0,this._focused_dropdown_row-1)),e.preventDefault()):void 0},n.prototype._onDownKey=function(e){return this._isSearchBarVisible()?(this._focusDropdownRow(Math.min(this._getDropdownRowCount()-1,this._focused_dropdown_row+1)),e.preventDefault()):this._searchInputUpdate()},n.prototype._onTabKey=function(e){return e.preventDefault()},n.prototype._searchInputUpdate=function(e){var n,i,o,r,s,a;return null==e&&(e=!1),s=this.$search_bar.val(),""===s?(this.$search_text.html(""),this.$search_bar_holder.removeClass("active"),this._hideSuggestions(e),this.$search_text.html(""),this.$suggestion_list.html(""),this._prev_search_val="",this._prev_search_scope=""):(this.$search_bar_holder.addClass("active"),this._showSuggestions(e),a=_.get_viewer().get_user_by_id(this.user_id),o=_.get_root_name(a),n=k("Search for â%(res)sâ in %(root)s").format({res:'<span class="search-val-text">'+t.escape(s)+"</span>",root:o}),this._scopedSearch()&&(i=l.filename(f.containing_fq_path()),n=k("Search for â%(res)sâ in %(path)s").format({res:'<span class="search-val-text">'+t.escape(s)+"</span>",path:"<span>"+t.escape(i)+"</span>"})),r='<span class="dropdown-top-text">'+n+"</span>",this.$search_text.html(r),this._gatherSuggestions())},n.prototype._gatherSuggestions=function(){var e,t,n,i;if(n=this.$search_bar.val(),this._prev_search_val===n){if(this._scopedSearch()&&this._prev_search_scope===f.containing_fq_path())return;if(""===this._prev_search_scope)return}return this.$suggestion_list.html(""),e={query:n,filename_only:!0,max_results:8},this._scopedSearch()?(e.fq_path=f.containing_fq_path(),this._prev_search_scope=f.containing_fq_path()):this._prev_search_scope="",this._prev_search_val=n,e[Constants.UID_PARAM_NAME]=this.user_id,this.$search_loading.show(),t={firefly:!0,path_scoped:!1,search_type:S.COMPLETION,query_string:n},C.log("query_started",this.user_id,t),i=(new Date).getTime(),s.WebRequest({url:"/ajax_fulltext_search",data:e,success:function(e){return function(o,r,s){var a,l;return e.$search_loading.hide(),l=s.getResponseHeader("x-dropbox-request-id"),o=JSON.parse(o),a=o.file_info.length>0?o.file_info[0]:null,t=new g.create_completion_log_dict(t,l,i,null,o.file_info.length,null,a),t.displayed=n===e.$search_bar.val()?!0:!1,t.query_string=n,C.log("query_completed",e.user_id,t),n===e.$search_bar.val()?e._displaySuggestions(o,l):void 0}}(this),error:function(e){return function(n,o){var r;return e.$search_loading.hide(),r=n.getResponseHeader("x-dropbox-request-id"),t=new g.create_completion_log_dict(t,r,i,null,null,o),t.latency=(new Date).getTime()-i,C.log("query_failed",e.user_id,t)}}(this)})},n.prototype._showSuggestions=function(e){return e=e||f.in_search_mode(),e&&this.$suggestion_list_holder.addClass("notransition"),this.$suggestion_list_holder.css({width:"498px",opacity:1}),this.$suggestion_list_holder.show(),this._focusDropdownRow(0),e?this.$suggestion_list_holder.removeClass("notransition"):void 0},n.prototype._hideSuggestions=function(e){return e=e||f.in_search_mode(),e&&this.$suggestion_list_holder.hide(),this.$suggestion_list_holder.css({width:"201px",opacity:0}),e?void 0:setTimeout(this._on_search_bar_transition_end,this.SEARCH_BAR_TRANSITION_DELAY)},n.prototype._displaySuggestions=function(e,t){var n,i,o,r,s,a,l,u;for(null==t&&(t=null),i=e.file_info,this._files={},r=[],u=i.slice(0,8),o=a=0,l=u.length;l>a;o=++a)n=u[o],s=this._buildSuggestion(n),s.on("mousemove",this._getDropdownRowFocuser(o+1)),r.push(s),this._files[this._keyForFile(n)]=m.make_browsefile(n,t);return this.$suggestion_list.html(r),this.$suggestion_list_holder.addClass("ie8hax").removeClass("ie8hax")},n.prototype._getDropdownRowFocuser=function(e){return function(t){return function(){return t._focusDropdownRow(e)}}(this)},n.prototype._buildSuggestion=function(t){var n,i,o,r,s,a,l;return l=t.fq_path.split("/"),s=l.slice(-1)[0],i=h.highlightMatch(s,t.filename_highlights).addClass("file-name"),a=2===l.length?"/":l.slice(0,-1).join("/"),o=e("<span class='file-path'><span class='file-path-in' /><span class='file-location' /></span>"),o.find(".file-path-in").text(k("in ")),o.find(".file-location").text(a),n=e("<img class='sprite sprite_web icon s_web_"+t.icon+"' src='/static/images/icons/icon_spacer-vflN3BYt2.gif'/>"),r=e('<div class="search-item clearfix"/>').append(o.prepend(n,i)),r.attr("data-identity",this._keyForFile(t)),r.data("suggestion-href",t.href),r.on("mousedown",this._suggestionClicked),r},n.prototype._suggestionClicked=function(e){var t;return t=2===e.which||E.is_mac()&&e.metaKey,this._openSuggestionByFileKey(this._keyForElement(e.target),t),this._searchBarUnFocused(!0)},n.prototype._openSuggestionByFileKey=function(e,t){var n;return n=this._fileForKey(e),this.previewFile(n,t),this._hideSuggestions()},n.prototype._runSearch=function(){var t,n;if(clearTimeout(this.search_key_up_timer),f.is_initialized)this.blur(),p.run();else{if(!e.trim(this.$search_bar.val()))return;n=_.get_viewer().get_user_by_id(this.user_id),t=g.build_search_url(n,g.get_state()),r.redirect(t)}return this._hideSuggestions()},n.prototype._keyForFile=function(e){return e.ns_id+"_"+e.sjid},n.prototype._keyForDropdownIndex=function(e){return this._getDropdownRow(e).data("identity")},n.prototype._fileForKey=function(e){return this._files[e]},n.prototype._keyForElement=function(e){var t;if(e)return t=e.readAttribute("data-identity"),t?t:this._keyForElement(e.up("[data-identity]"))},n.prototype._isSearchBarVisible=function(){return this.$suggestion_list_holder.is(":visible")},n.prototype._getDropdownRowCount=function(){return this._isSearchBarVisible()?this.$suggestion_list.children().size()+1:0},n.prototype._hasDropdownRowAtIndex=function(e){return e>=-1&&e<this._getDropdownRowCount()},n.prototype._getDropdownRow=function(e){return T(this._hasDropdownRowAtIndex(e),"Focus on nonexistent search bar suggestion"),0===e?this.$search_text:this.$suggestion_list.children().eq(e-1)},n.prototype._unfocusDropdownRow=function(){return this._hasDropdownRowAtIndex(this._focused_dropdown_row)&&(this._getDropdownRow(this._focused_dropdown_row).removeClass("focused"),this.$search_bar_holder.addClass("ie8hax").removeClass("ie8hax")),this._focused_dropdown_row=-1},n.prototype._focusDropdownRow=function(e){return this._focused_dropdown_row!==e?(this._unfocusDropdownRow(),this._getDropdownRow(e).addClass("focused"),this.$search_bar_holder.addClass("ie8hax").removeClass("ie8hax"),this._focused_dropdown_row=e):void 0},n}()}),define("modules/dirty/sharing/sf_access_type",["dropbox","jquery","modules/core/dom","modules/core/i18n","modules/core/notify","modules/clean/analytics","modules/clean/components/bubble_picker","modules/clean/dbmodal","modules/clean/dbmodal_loading","modules/clean/viewer","modules/dirty/groups/api"],function(e,t,n,i,o,r,s,a,l,u,c){var _,d,p,h,f,m,g;return p=e.MakeOwnerModal,m=e.SharingApi,g=i._,f=r.SharedFolderActivityLogger,_=a.DBModal,d=a.DBModalStack,h=function(){function e(e,t){this.$access_type_el=e,this.ajax_data=t,this.bubble_picker=n.controller(this.$access_type_el),
this.$access_type_el.on(s.CHANGED,function(e){return function(t,n){var i,o,r,s,a,l;return r=n.old_val,o=n.clicked_val,Number(r)===Number(o)?!1:(e.ajax_data&&(l=u.get_viewer().get_user_by_id(e.ajax_data.user_id),s=e.ajax_data.params,i=e.ajax_data.access_types,a=e.$access_type_el.closest(".bs-row").find(".sf-display-name").text(),"owner"===i[o]?(e.show_make_owner_modal(l,s.member_uid,s.ns_id,a,o),e.bubble_picker.set_value(r)):e.update_access_type(l,s,a,o)),!1)}}(this))}return e.prototype.show_make_owner_modal=function(e,t,n,i,o){return d.push(new p(e,{element_id:"make-owner-confirm-modal",member_uid:t,member_name:i,ns_id:n,access_type:o}))},e.prototype.update_access_type=function(e,t,n,i){var r,s,a;return r={ns_id:t.ns_id,access_type:i},a=function(i){return function(s){var a,u,c;if(c=JSON.parse(s.responseText),r.member_id=t.member_uid,"OK"===c.status){switch(r.succes=!0,c.access_type){case"viewer":u=g("%(name)s can only view now.").format({name:n});break;case"editor":u=g("%(name)s can edit now.").format({name:n});break;case"owner":u=g("%(name)s is the owner now.").format({name:n})}u&&o.success(u)}else"ERROR"===c.status&&(r.succes=!1,c.msg&&(r.message=c.msg,o.error(c.msg)),c.reload&&(a=_.get_containing_modal(i.$access_type_el),a&&a instanceof l&&a.fetch()));return f.log("web","invite_modal_change_callback",e,r)}}(this),s=new m(e),t.member_uid?(s.update_member_access_type(t.ns_id,t.member_uid,i,a),r.member_uid=t.member_uid,f.log("web","invite_modal_change_collaborator",e,r)):t.invite_id?(s.update_invite_access_type(t.invite_id,i,a),r.invite_id=t.invite_id,f.log("web","invite_modal_change_invite",e,r)):t?(c.change_group_access_type({ns_id:t.ns_id,group_id:t.group_gid,access_type:i},a),r.group_id=t.group_gid,f.log("web","invite_modal_change_group",e,r)):void 0},e}()}),define("modules/dirty/sharing/sharing_growth_email_experiments",["dropbox","modules/clean/analytics"],function(e,t){var n,i,o;return o=e.Upload,n=t.SharedFolderActivityLogger,i=function(){function e(){}return e.listen_for_first_upload=function(e,t){var i;return i=function(){return function(){return n.log("web","file_upload",e,t),document.stopObserving(o.QUEUE_EVT,i),document.stopObserving(o.CHOOSE_FILE_BASIC,i)}}(this),document.observe(o.QUEUE_EVT,i),document.observe(o.CHOOSE_FILE_BASIC,i)},e}()});var __hasProp={}.hasOwnProperty;define("modules/dirty/streams/lib/check",["external/raven","external/underscore","modules/core/exception"],function(e,t,n){var i,o,r,s;return r=n.assert,o=Constants.IS_PROD,i=!Constants.IS_PROD,s={assert:function(e,t,n,i,s,a){return o&&(a=!0),r(e,t,n,i,s,a)},check:function(t,n){if(Constants.IS_PROD&&r(t,n,void 0,void 0,!1,o),!t){if(i)throw new Error(n);e.captureException(new Error(n))}return t},check_params:function(e){var t,n,i;return n=function(){var n;n=[];for(t in e)__hasProp.call(e,t)&&(i=e[t],null==i&&n.push(t));return n}(),s.check(0===n.length,"Missing parameters "+n.join(" and "))}}});var __slice=[].slice;define("modules/dirty/streams/lib/event_emitter",[],function(){var e;return e=function(){function e(){this.events={}}return e.prototype.emit=function(){var e,t,n,i,o,r;if(t=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],!this.events[t])return!1;for(r=this.events[t],i=0,o=r.length;o>i;i++)n=r[i],n.apply(null,e);return!0},e.prototype.add_listener=function(e,t){var n;return this.emit("new_listener",e,t),(null!=(n=this.events)[e]?n[e]:n[e]=[]).push(t),this},e.prototype.on=e.prototype.add_listener,e.prototype.once=function(e,t){var n;return n=function(i){return function(){return i.remove_listener(e,n),t.apply(null,arguments)}}(this),this.on(e,n),this},e.prototype.remove_listener=function(e,t){var n;return this.events[e]?(this.events[e]=function(){var i,o,r,s;for(r=this.events[e],s=[],i=0,o=r.length;o>i;i++)n=r[i],n!==t&&s.push(n);return s}.call(this),this):this},e.prototype.remove_all_listeners=function(e){return e?delete this.events[e]:this.events={},this},e}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/dirty/streams/lib/reconnecting_queue",["jquery","external/underscore","modules/core/uri","modules/dirty/streams/lib/check","modules/dirty/streams/lib/event_emitter"],function(e,t,n,i,o){var r,s,a,l;return l=i.check,r=function(){function e(e,t){this.get_delay=__bind(this.get_delay,this),this.fail=__bind(this.fail,this),this.reset=__bind(this.reset,this),this.number_of_retries=0,this.slot_time=e,this.max_exponent=Math.floor(Math.log(t/this.slot_time)/Math.log(2))}return e.prototype.reset=function(){return this.number_of_retries=0},e.prototype.fail=function(){return this.number_of_retries+=1},e.prototype.get_delay=function(){var e,t;return t=Math.min(Math.floor(this.number_of_retries*Math.sqrt(this.number_of_retries)),this.max_exponent),e=Math.floor(Math.random()*Math.pow(2,t))*this.slot_time},e}(),s=function(i){function o(e){this._handle_poll_error=__bind(this._handle_poll_error,this),this._handle_poll_success=__bind(this._handle_poll_success,this),this._long_poll=__bind(this._long_poll,this),o.__super__.constructor.call(this),this.queue_info=e,this.host=e.eventbus_endpoint,this.host||(this.host="eventbus.dropbox.com"),this.backoff=new r(100,3e5),this.last_event_id=-1}return __extends(o,i),o.prototype.start=function(){return this._started?void 0:(this._started=!0,this._long_poll())},o.prototype.end=function(){return this._started=!1,null!=this._long_poll_xhr?this._long_poll_xhr.abort():t.defer(function(e){return function(){return e.emit("close")}}(this))},o.prototype._long_poll=function(){var t,i,o,r;if(this._started)return o=this.queue_info.queue_id,r=this.queue_info.queue_token,i=window.btoa(o+":"+r),t=n({scheme:"https",authority:this.host,path:"/api/v1/events"}),this._long_poll_xhr=e.ajax({contentType:"application/json",url:t.toString(),type:"POST",processData:!1,noDropboxDefaults:!0,data:JSON.stringify({last_event_id:this.last_event_id}),timeout:6e4,beforeSend:function(e){return e.setRequestHeader("HTTP-X-EVENTQUEUE-AUTHORIZATION","Basic "+i)},success:this._handle_poll_success,error:this._handle_poll_error})},o.prototype._handle_poll_success=function(e){return this._long_poll_xhr=null,"success"===e.result&&null!=e.events&&e.events.length>0?(this.emit("poll"),this.backoff.reset(),t.defer(this._long_poll),this.last_event_id=e.events[e.events.length-1].id,"heartbeat"!==e.events[0].type?this.emit("events",e.events):void 0):(console.warn("EventBusQueue: longpoll error:",e),this.backoff.fail(),window.setTimeout(this._long_poll,this.backoff.get_delay()))},o.prototype._handle_poll_error=function(e,t){return this._long_poll_xhr=null,this._started?e.status>=400&&e.status<500?(this.emit("error",e.status),this.emit("close",!0)):(console.warn("EventBusQueue: longpoll error:",t,e.status),this.backoff.fail(),window.setTimeout(this._long_poll,this.backoff.get_delay())):this.emit("close",!1)},o}(o),a=function(e){function n(){this._handle_queue_error=__bind(this._handle_queue_error,this),this._handle_queue_longpoll_success=__bind(this._handle_queue_longpoll_success,this),this._emit_events=__bind(this._emit_events,this),this._queue_request_failed=__bind(this._queue_request_failed,this),this._set_up_queue_with_info=__bind(this._set_up_queue_with_info,this),this._get_queue=__bind(this._get_queue,this),this.end=__bind(this.end,this),this.start=__bind(this.start,this),n.__super__.constructor.call(this),this.backoff=new r(100,3e5),this.backoff_longpoll_400=new r(100,6e5),this.ended=!1,this._reset_queue()}return __extends(n,e),n.prototype._reset_queue=function(){return null!=this.queue&&(this.queue.remove_all_listeners(),this.queue.end(),this.queue=null),this.in_init=!1,this.started=!1},n.prototype.start=function(){return l(!this.ended,"Queue already ended")?this.started?void(this.in_init||t.defer(function(e){return function(){return e.emit("ready")}}(this))):(this.started=this.in_init=!0,this._get_queue(this._set_up_queue_with_info,this._queue_request_failed)):void 0},n.prototype.end=function(){return this._reset_queue(),this.ended=!0},n.prototype._get_queue=function(){throw new Error("Not Implemented")},n.prototype._set_up_queue_with_info=function(e){return this.ended?void 0:(this.queue=new s(e),this.queue.on("events",this._emit_events),this.queue.on("error",this._handle_queue_error),this.queue.on("poll",this._handle_queue_longpoll_success),this.in_init=!1,this.backoff.reset(),this.emit("ready"),this.queue.start())},n.prototype._queue_request_failed=function(e,t){var n,i,o;if(!this.ended&&(this.emit("error","Failed to start queue",t),403!==e.status&&400!==e.status)){this.started=this.in_init=!1,this.backoff.fail();try{if(i=JSON.parse(e.responseText).payload.chillout_seconds,i=Number(i),0>i||isNaN(i))throw Error("Backoff offset is invalid.")}catch(r){o=r,i=0}return n=1e3*i,window.setTimeout(this.start,this.backoff.get_delay()+n)}},n.prototype._emit_events=function(e){return this.emit("events",e)},n.prototype._handle_queue_longpoll_success=function(){return this.backoff_longpoll_400.reset()},n.prototype._handle_queue_error=function(e){return 401===e||403===e?(this._reset_queue(),this.start()):(this.backoff_longpoll_400.fail(),this._reset_queue(),window.setTimeout(this.start,this.backoff_longpoll_400.get_delay()))},n}(o)});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define("modules/dirty/streams/lib/user_queue",["modules/clean/ajax","modules/dirty/streams/lib/reconnecting_queue"],function(e,t){var n,i,o,r;return n=function(t){function n(e,t,i){this.user_id=e,this.alloc_endpoint=t,this.params=i,this._get_queue=__bind(this._get_queue,this),n.__super__.constructor.call(this)}return __extends(n,t),n.prototype._get_queue=function(t,n){return e.WebRequest({dataType:"json",type:"POST",url:this.alloc_endpoint,data:this.params,success:function(){return function(e){return t(e.payload.queue)}}(this),error:function(){return function(e,t){return n(e,t)}}(this),subject_user:this.user_id})},n}(t),r={},i=function(e,t,i){var o,s;return o=e+"||"+t+"||"+JSON.stringify(i),s=r[o],s||(s=new n(e,t,i),r[o]=s),s.start(),s},o={get_user_queue:i}}),define("modules/dirty/unity_browse_interface",["dropbox","jquery","modules/clean/unity/check_file_cache","modules/clean/unity/features"],function(e,t,n,i){var o,r;return o=e.Browse,null!=n&&null!=i?r=function(){function e(){}return e.BATCH_SIZE_LIMIT=100,e.CHECK_FILES_PADDING=50,e.listen=function(){return o.add_visible_change_callback(e.browse_visible_change_callback)},e.check_file_callback=function(e){return n.set_batch(e)},e.browse_visible_change_callback=function(t,n,o,r){var s,a,l,u,c,_;if(t.length&&(u=Math.max(0,o-e.CHECK_FILES_PADDING),c=Math.min(t.length-1,r+e.CHECK_FILES_PADDING),a=t.slice(u,+c+1||9e9),l=e._get_files_to_check(a),l.length)){for(e._remove_unneeded_items_from_cache(a),_=[];l.length;)s=l.splice(0,e.BATCH_SIZE_LIMIT),_.push(i.check_file_batch(s,n,e.check_file_callback));return _}},e._get_files_to_check=function(e){var t;return function(){var i,o,r;for(r=[],i=0,o=e.length;o>i;i++)t=e[i],t.bytes>=0&&n.is_cached_and_locally_available(t.ns_id,t.ns_path)!==!0&&r.push(t);return r}()},e._remove_unneeded_items_from_cache=function(e){var t,o,r,s,a;for(o={},s=0,a=e.length;a>s;s++)r=e[s],n.is_cached_and_locally_available(r.ns_id,r.ns_path)===!0&&(t=n.get(r.ns_id,r.ns_path),o[i.server_path(r.ns_id,r.ns_path)]=t);return n.clear(),n.set_batch(o)},e}():void 0}),define("modules/dirty/upsell/ha",["dropbox","modules/clean/upsell/upsell_controller"],function(e,t){var n;return n=function(){function e(e,n){var i;this.$ha=e,this.options=n,this.$ha.find(".dismiss-button").on("click",function(e){return function(){return e.$ha.hide()}}(this)),i=new t(this.$ha.find(".confirm-button"),this.$ha.find(".dismiss-button"),this.options),i.log_impression()}return e}()});