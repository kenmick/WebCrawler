(function(){define("modules/clean/unity/features/destiny_logger",["jquery","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/versions","modules/constants/legacy"],function(e,t,n,i,r,_){var o;return o={report_event:function(e,o){var s;return null==o&&(o=null),s={event_name:e,extra:JSON.stringify(o||{}),local_ts:(new Date).getTime(),server_path:window.location.pathname,session_id:_.sess_id,web_unity_version:r.LATEST},n.WebRequest({url:t({path:"/destiny_log"}),data:s}),i.getGandalfRule("destiny-web-debug")?console.log(s):void 0}}})}).call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/unity/features/web_destiny",["external/modernizr","jquery","modules/clean/ajax","modules/clean/unity/features","modules/clean/unity/features/destiny_logger","modules/core/browser","modules/core/exception","modules/core/uri"],function(t,n,i,r,_,o,s,u){var a;return null!=r?a=function(){function a(){this._assert_is_initialized=e(this._assert_is_initialized,this),this._direct_web_destiny=e(this._direct_web_destiny,this),this.is_direct_allowed=e(this.is_direct_allowed,this),this.user_display_name=e(this.user_display_name,this),this.continue_as_user=e(this.continue_as_user,this),this._cached_web_destiny_info=null}return a.Error={UNITY_CONNECTION_ERROR:"unity_connection_error",REFRESH_TIMEOUT:"refresh_timeout",LOGIN_REQUEST_ERROR:"login_request_error"},a._DESTINY_REFRESH_TOKEN_KEY="web-destiny-refresh-token",a._DESTINY_MANUAL_REFRESH_TIMEOUT=5e3,a._DESTINY_REFRESH_TIMEOUT=1e4,a.finish_indirect_web_destiny=function(e){var i;return _.report_event("web_destiny_opened_new_tab"),n(window).on("beforeunload",function(){return _.report_event("web_destiny_new_tab_redirecting")}),t.localstorage?(localStorage.setItem(this._DESTINY_REFRESH_TOKEN_KEY,e),i=localStorage.getItem("web-destiny-redirect-uri"),localStorage.removeItem("web-destiny-redirect-uri"),i?o.redirect(i):o.redirect("/")):o.redirect("/")},a.prototype.start_connection=function(e,t){return null==t&&(t=null),null==this._cached_web_destiny_info?r.web_destiny_info(function(t){return function(n){return null!=n?(t._cached_web_destiny_info=n,e(n.user_display_name)):void 0}}(this),t):void 0},a.prototype.continue_as_user=function(e,t){var n,i;return null==e&&(e=null),null==t&&(t=null),this._assert_is_initialized(),n=function(){return null!=e?o.redirect(e):window.location.reload()},i=function(e){return null!=t?t(e):void 0},this._cached_web_destiny_info.is_direct_allowed?this._direct_web_destiny(n,i):this._indirect_web_destiny(n,i)},a.prototype.user_display_name=function(){return this._assert_is_initialized(),this._cached_web_destiny_info.user_display_name},a.prototype.is_direct_allowed=function(){return this._assert_is_initialized(),this._cached_web_destiny_info.is_direct_allowed},a.prototype._indirect_web_destiny=function(e,n){var i,_,s,u;return u=null,s=null,t.localstorage&&(u=(new Date).getTime().toString(),_=function(t){return t.key===a._DESTINY_REFRESH_TOKEN_KEY&&t.newValue===u?(window.clearTimeout(s),e()):void 0},null!=window.addEventListener?window.addEventListener("storage",_,!1):window.attachEvent("onstorage",_)),i=function(){return s=t.localstorage?window.setTimeout(function(){return n(a.Error.REFRESH_TIMEOUT)},a._DESTINY_REFRESH_TIMEOUT):window.setTimeout(e,a._DESTINY_MANUAL_REFRESH_TIMEOUT)},r.continue_as_user(o.browser_name,u,i,function(){return n(a.Error.UNITY_CONNECTION_ERROR)})},a.prototype._direct_web_destiny=function(e,t){var n;return s.assert(this._cached_web_destiny_info.is_direct_allowed,"Direct Web Destiny is not allowed."),n=function(n){var r,_,o;return r={i:function(){var e;e=[];for(_ in n)o=n[_],e.push(_);return e}(),n:function(){var e;e=[];for(_ in n)o=n[_],e.push(o);return e}(),return_json:!0},i.WebRequest({url:u({path:"/desktop_login"}),data:r,success:e,error:function(){return t(a.Error.LOGIN_REQUEST_ERROR)}})},r.continue_as_user_direct(n,function(){return t(a.Error.UNITY_CONNECTION_ERROR)})},a.prototype._assert_is_initialized=function(){return s.assert(null!=this._cached_web_destiny_info,"Method not allowed. WebDestiny was not initialized.")},a}():void 0})}.call(this);
//# sourceMappingURL=pkg-bd.min.js.map