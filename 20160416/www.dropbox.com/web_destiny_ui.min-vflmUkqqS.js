(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define(["external/modernizr","jquery","modules/clean/ajax","modules/core/browser","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/components/ajax_form","modules/clean/em_string","modules/clean/gandalf_util","modules/clean/unity/features","modules/clean/unity/features/destiny_logger","modules/clean/unity/features/web_destiny"],function(t,n,i,_,o,r,s,a,l,c,u,d,h,y){var w,f;return f=r._,w=function(){function n(t){this._fill_login_error=e(this._fill_login_error,this),this._show_unity_server_error=e(this._show_unity_server_error,this),this._show_unity_client_error=e(this._show_unity_client_error,this),this._web_destiny_login=e(this._web_destiny_login,this),this._show_web_destiny=e(this._show_web_destiny,this),this._web_destiny_connect_callback=e(this._web_destiny_connect_callback,this),this._check_if_previous_login_failed=e(this._check_if_previous_login_failed,this),this.maybe_show_web_destiny=e(this.maybe_show_web_destiny,this),this.$login_form=t.find(".login-form"),this.cont=this.$login_form.find("input[name='cont']").val(),this.$web_destiny_container=t.find("#web-destiny-container"),this.button=this.$web_destiny_container.find("#continue-as-button")}return n.prototype.maybe_show_web_destiny=function(){return this._is_destiny_enabled()?this._check_if_previous_login_failed()?void this._show_unity_server_error():(this._web_destiny=new y,h.report_event("web_destiny_start_connection_to_unity"),d.add_on_ready_callback(this._unity_ready_callback),this._web_destiny.start_connection(this._web_destiny_connect_callback)):void 0},n.prototype._unity_ready_callback=function(){return h.report_event("web_destiny_unity_ready")},n.prototype._check_if_previous_login_failed=function(){return this.cont.indexOf("/login_complete?refresh_token=")>=0},n.prototype._is_destiny_enabled=function(){return 0===this.$web_destiny_container.length?!1:u.getGandalfRule("unity-web-destiny")&&null!=y&&("/login"===window.location.pathname||u.getGandalfRule("unity-web-destiny-all-pages"))&&!this._is_safari_private_mode()&&this._is_path_allowed(window.location.pathname)},n.prototype._is_path_allowed=function(e){var t,n,i,_;for(t=["/dropins","/chooser","/saver","/fb"],i=0,_=t.length;_>i;i++)if(n=t[i],0===e.indexOf(n))return!1;return!0},n.prototype._is_safari_private_mode=function(){return _.safari&&!t.localstorage},n.prototype._web_destiny_connect_callback=function(e){var t,n;return h.report_event("web_destiny_unity_triggered"),t=this._make_display_name_text(e),n=this.$web_destiny_container.find(".continue-as-user-name"),n.text(t),this.button.click(this._web_destiny_login),this._show_web_destiny()},n.prototype._make_display_name_text=function(e){return f("Continue as %(real_name)s",{comment:"Log in automatically as NAME"}).format({real_name:e})},n.prototype._show_web_destiny=function(){return h.report_event("web_destiny_display_continue_as_animation_start"),this.button.attr("disabled",!1),this.$web_destiny_container.hide().css({visibility:"visible",display:""}).fadeIn("fast",function(){return h.report_event("web_destiny_display_continue_as_animation_end")})},n.prototype._web_destiny_login=function(){var e,n,i,o;return h.report_event("web_destiny_continue_as_clicked"),"/login"!==window.location.pathname&&""===this.cont&&(this.cont=window.location.pathname+window.location.search),_.msie||!t.localstorage||this._web_destiny.is_direct_allowed()?(n=this.cont,i="/"):(n="/",i=this.cont),t.localstorage&&localStorage.setItem("web-destiny-redirect-uri",i),e=this._get_check_signed_in_ajax_callback(this._show_unity_client_error),o=this._get_unity_client_error_callback(e,this._show_unity_client_error),this._web_destiny.continue_as_user(n,o),s.warning(f("Weâre trying to log you in automatically")),this.button.attr("disabled",!0)},n.prototype._get_unity_client_error_callback=function(e,t){return function(){return new i.AuthenticatedRequest({url:"/is_signed_in",success:e,error:t})}},n.prototype._get_check_signed_in_ajax_callback=function(e){return function(t){return"ok"===t?_.reload():e()}},n.prototype._show_unity_client_error=function(){return this._fill_login_error(f("Sorry, we werenât able to sign you in. Please enter your email and password to sign in.")),this.button.attr("disabled",!0),h.report_event("web_destiny_client_error")},n.prototype._show_unity_server_error=function(){return this._fill_login_error(f("Please enter your email and password to sign in.")),h.report_event("web_destiny_server_error")},n.prototype._fill_login_error=function(e){return l.fill_errors(this.$login_form,{login_email:{message_text:e}})},n}()})}).call(this);
//# sourceMappingURL=web_destiny_ui.min.js.map